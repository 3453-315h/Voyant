/* This file created by JSCacher. Last modified: Sat Jun 06 12:34:04 EDT 2020 */
function Bubblelines(config){this.container=config.container;this.externalClickHandler=config.clickHandler;this.INTERVAL=50;this.DISMISS_DELAY=2500;this.UNIFORM_LINE_LENGTH=true;this.SEPARATE_LINES_FOR_TERMS=false;this.MAX_LABEL_WIDTH=0;this.MAX_LINE_WIDTH=0;this.DRAW_TITLES=true;this.DRAW_SHORT_TITLES=false;this.MIN_GRAPH_SEPARATION=50;this.graphSeparation=50;this.yIndex=0;this.mouseOver=false;this.intervalId=null;this.clearToolTipId=null;this.overBubbles=[];this.lastClickedBubbles={};this.dragInfo=
null;this.canvas=null;this.ctx=null;this.maxDocLength=2;this.maxFreq={term:null,value:0};this.maxRadius=0;this.cache=new Ext.util.MixedCollection;this.currentTerms={};this.termsFilter=[];this.bubbleSpacing=50;this.initialized=false}
Bubblelines.prototype={constructor:Bubblelines,initializeCanvas:function(){var container=this.container;var height=container.getHeight();var width=container.getWidth();this.DRAW_SHORT_TITLES=width<500;var id=Ext.id("bubblelines");container.add({xtype:"container",width:width,height:height,html:'\x3ccanvas id\x3d"'+id+'" width\x3d"'+width+'" height\x3d"'+height+'"\x3e\x3c/canvas\x3e',border:false,listeners:{afterrender:{fn:function(cnt){this.canvas=document.getElementById(id);this.ctx=this.canvas.getContext("2d");
this.canvas.addEventListener("click",this.clickHandler.bind(this),false);this.canvas.addEventListener("mousedown",this.mouseDownHandler.bind(this),false);this.canvas.addEventListener("mouseup",this.mouseUpHandler.bind(this),false);this.canvas.addEventListener("mousemove",this.moveHandler.bind(this),false);this.canvas.addEventListener("mouseenter",this.mouseEnterHandler.bind(this),false);this.canvas.addEventListener("mouseleave",this.mouseLeaveHandler.bind(this),false)},single:true,scope:this}}});
container.updateLayout();this.initialized=true},doBubblelinesLayout:function(){if(this.initialized){var width=this.container.getWidth();this.DRAW_SHORT_TITLES=width<500;this.setTitleWidthsAndMaxTitleWidth();var children=Ext.DomQuery.jsSelect("div:not(div[class*\x3dterm])",this.container.el.dom);for(var i=0;i<children.length;i++){var child=Ext.fly(children[i]);child.setWidth(width)}this.canvas.width=width;var padding=75;if(this.DRAW_SHORT_TITLES)padding=50;this.setMaxLineWidth(width-this.MAX_LABEL_WIDTH-
padding);this.setLineLengths();this.recache();this.setCanvasHeight();this.drawGraph()}},addDocToCache:function(doc){this.cacheBubbles(doc);this.calculateBubbleRadii(doc);doc.lineLength=600;doc.freqCounts={};if(this.cache.containsKey(doc.id)===false)this.cache.add(doc);else this.cache.replace(doc.id,doc);this.cache.sort("index","ASC")},addTermsToDoc:function(termsObj,docId){var term;for(var key in termsObj)term=key;this.currentTerms[term]=true;var doc=this.cache.get(docId);Ext.apply(doc.terms,termsObj);
var maxFreqChanged=this.cacheBubbles(doc);if(maxFreqChanged)this.recache();else this.calculateBubbleRadii(doc)},cacheBubbles:function(doc){var maxFreqChanged=false;for(var term in doc.terms){var termInfo=doc.terms[term];var bins=termInfo.distributions.length;var spacing=doc.lineLength/bins;var cachedPositions=[];var tokenPos=0;var maxDistribution=0;var xIndex=0;for(var i=0;i<bins;i++){var d=termInfo.distributions[i];if(d>maxDistribution)maxDistribution=d;cachedPositions.push({id:Ext.id(null,"bub"),
x:xIndex,freq:d,radius:0,bin:i,tokenPositions:termInfo.positions.slice(tokenPos,tokenPos+=d)});xIndex+=spacing}doc.terms[term].maxDistribution=maxDistribution;doc.terms[term].pos=cachedPositions;if(maxDistribution>this.maxFreq.value){maxFreqChanged=true;this.setMaxFreq({term:term,value:maxDistribution})}}return maxFreqChanged},calculateBubbleRadii:function(doc,newTerm){var maxFreqLog=Math.log(this.maxFreq.value);var minFreq=Math.log(2)/2;for(var t in doc.terms){var term=doc.terms[t];if(term)if(newTerm==
null||t==newTerm)for(var i=0;i<term.pos.length;i++){var bubble=term.pos[i];if(bubble.freq>0){var freqLog=Math.max(Math.log(bubble.freq),minFreq);var radius=freqLog/maxFreqLog*this.maxRadius;bubble.radius=radius}else bubble.radius=0}}},recache:function(){function doCache(doc){this.cacheBubbles(doc);this.calculateBubbleRadii(doc)}this.cache.each(doCache,this)},getTotalHeight:function(){var totalHeight=this.maxRadius;this.cache.each(function(doc,index,length){totalHeight+=doc.height},this);return totalHeight},
setCanvasHeight:function(){this.calculateGraphHeights();var height=this.getTotalHeight();var container=this.container.dom;if(container!==undefined){var children=Ext.DomQuery.jsSelect("div",container);for(var i=0;i<children.length;i++){var child=Ext.fly(children[i]);child.setHeight(height)}}if(this.canvas)this.canvas.height=height},setMaxLineWidth:function(width){this.maxRadius=width/30;this.MAX_LINE_WIDTH=width-this.maxRadius/2},calculateGraphHeights:function(){var graphSeparation=this.maxRadius*
.5;if(this.SEPARATE_LINES_FOR_TERMS){var terms=this.termsFilter;this.cache.each(function(doc,index,length){var height=this.maxRadius*terms.length;for(var i=0;i<terms.length;i++)if(!doc.terms[terms[i]])height-=this.maxRadius;if(height==0)height=this.maxRadius;doc.height=height+graphSeparation},this)}else{var height=Math.max(this.maxRadius,this.MIN_GRAPH_SEPARATION);this.cache.each(function(doc,index,length){doc.height=height+graphSeparation},this)}},findLongestDocument:function(doc){var twt=doc.getTotalWordTokens();
if(twt>this.maxDocLength)this.maxDocLength=twt},getTitleWidth:function(doc){var title=doc.title;if(this.DRAW_SHORT_TITLES){var index=this.cache.indexOf(doc);title=index+1+")"}this.ctx.textBaseline="top";this.ctx.font="bold 12px Verdana";var width=this.ctx.measureText(title).width;return width},setTitleWidthsAndMaxTitleWidth:function(){function doTitle(doc,index){var width=this.getTitleWidth(doc);doc.titleWidth=width;if(width>this.MAX_LABEL_WIDTH)this.MAX_LABEL_WIDTH=width}this.cache.each(doTitle,
this)},setLineLengths:function(){function doLength(doc,index){var lineLength;if(this.UNIFORM_LINE_LENGTH)lineLength=this.MAX_LINE_WIDTH;else{var percentage=Math.log(doc.getTotalWordTokens())/Math.log(this.maxDocLength);lineLength=percentage*this.MAX_LINE_WIDTH}doc.lineLength=lineLength}this.cache.each(doLength,this)},drawGraph:function(includeLegend){if(this.intervalId!=null)clearInterval(this.intervalId);if(this.mouseOver)this.intervalId=setInterval(this.doDraw.bind(this,[includeLegend]),this.INTERVAL);
else setTimeout(this.doDraw.bind(this,[includeLegend]),5)},doDraw:function(includeLegend){this.clearCanvas();this.yIndex=this.maxRadius;if(includeLegend===true)this.yIndex+=30;this.cache.each(this.drawDocument,this);if(includeLegend===true)this.drawLegend();else this.drawToolTip();this.doDrag()},drawDocument:function(doc,index,totalDocs){if(!doc.hidden){var lineLength=doc.lineLength;var titleIndent=this.MAX_LABEL_WIDTH-doc.titleWidth;var xIndex=5;this.ctx.textBaseline="top";this.ctx.font="bold 12px Verdana";
if(this.dragInfo!=null&&this.dragInfo.oldIndex==index){this.ctx.fillStyle="rgba(128, 128, 128, 0.5)";xIndex+=titleIndent;this.ctx.fillText(doc.title,xIndex,this.yIndex);if(this.SEPARATE_LINES_FOR_TERMS)this.yIndex+=doc.height}else{if(this.DRAW_TITLES){xIndex+=titleIndent;this.ctx.fillStyle="rgba(128, 128, 128, 1.0)";var title=doc.title;if(this.DRAW_SHORT_TITLES)title=index+1+")";this.ctx.fillText(title,xIndex,this.yIndex)}this.yIndex+=4;var that=this;function drawLine(){xIndex=that.MAX_LABEL_WIDTH+
that.maxRadius;that.ctx.strokeStyle="rgba(128, 128, 128, 1.0)";that.ctx.fillStyle="rgba(128, 128, 128, 1.0)";that.ctx.lineWidth=.25;that.ctx.beginPath();that.ctx.moveTo(xIndex,that.yIndex-6);that.ctx.lineTo(xIndex,that.yIndex+6);that.ctx.stroke();that.ctx.beginPath();that.ctx.moveTo(xIndex,that.yIndex);that.ctx.lineTo(xIndex+lineLength,that.yIndex);that.ctx.stroke();that.ctx.beginPath();that.ctx.moveTo(xIndex+lineLength,that.yIndex-6);that.ctx.lineTo(xIndex+lineLength,that.yIndex+6);that.ctx.stroke()}
if(!this.SEPARATE_LINES_FOR_TERMS)drawLine();else if(this.termsFilter==null||this.termsFilter.length===0)drawLine();var pi2=Math.PI*2;var freqTotal=0;doc.freqCounts={};var terms=doc.terms;var checkClickedBubbles=this.lastClickedBubbles[index]!=null;var termsDrawn=0;for(var t in terms)if(this.termsFilter.indexOf(t)!==-1){var info=terms[t];if(info){termsDrawn++;if(this.SEPARATE_LINES_FOR_TERMS)drawLine();var freqForType=0;var c=info.color.join(",");this.ctx.strokeStyle="rgba("+c+", 1)";this.ctx.fillStyle=
"rgba("+c+", 0.35)";this.ctx.lineWidth=.25;freqTotal+=info.rawFreq;freqForType+=info.rawFreq;var checkCurrentType=checkClickedBubbles&&this.lastClickedBubbles[index][t];for(var i=0;i<info.pos.length;i++){var b=info.pos[i];if(b.radius>0){var doClickedBubble=false;if(checkCurrentType&&this.lastClickedBubbles[index][t]==b.id){this.ctx.strokeStyle="rgba(0, 0, 0, 0.75)";this.ctx.fillStyle="rgba("+c+", 0.5)";this.ctx.lineWidth=1;doClickedBubble=true}this.ctx.beginPath();this.ctx.arc(b.x+xIndex,this.yIndex,
b.radius,0,pi2,true);this.ctx.closePath();this.ctx.fill();this.ctx.stroke();if(doClickedBubble){this.ctx.strokeStyle="rgba("+c+", 1)";this.ctx.fillStyle="rgba("+c+", 0.35)";this.ctx.lineWidth=.25}}}doc.freqCounts[t]=freqForType;if(this.SEPARATE_LINES_FOR_TERMS){this.ctx.fillStyle="rgba(0, 0, 0, 1.0)";this.ctx.font="10px Verdana";this.ctx.fillText(freqForType,xIndex+lineLength+5,this.yIndex-4);this.yIndex+=this.maxRadius}}}if(this.SEPARATE_LINES_FOR_TERMS&&termsDrawn==0){drawLine();this.ctx.fillStyle=
"rgba(0, 0, 0, 1.0)";this.ctx.font="10px Verdana";this.ctx.fillText(0,xIndex+lineLength+5,this.yIndex-4);this.yIndex+=this.maxRadius}xIndex+=lineLength;if(!this.SEPARATE_LINES_FOR_TERMS){this.ctx.fillStyle="rgba(0, 0, 0, 1.0)";this.ctx.font="10px Verdana";this.ctx.fillText(freqTotal,xIndex+5,this.yIndex-4)}}if(!this.SEPARATE_LINES_FOR_TERMS)this.yIndex+=doc.height;else this.yIndex+=this.maxRadius*.5;this.yIndex-=4}},drawLegend:function(){var x=this.MAX_LABEL_WIDTH+this.maxRadius;var y=5;this.ctx.textBaseline=
"top";this.ctx.font="16px serif";if(this.typeStore)this.typeStore.each(function(record){var color=record.get("color").join(",");this.ctx.fillStyle="rgb("+color+")";var type=record.get("type");this.ctx.fillText(type,x,y);var width=this.ctx.measureText(type).width;x+=width+8},this)},drawToolTip:function(){if(this.overBubbles.length>0){this.ctx.lineWidth=.5;this.ctx.fillStyle="rgba(224, 224, 224, 0.8)";this.ctx.strokeStyle="rgba(0, 0, 0, 0.8)";var x=this.overBubbles[0].x;var y=this.overBubbles[0].y;
var width=110;if(x+width>this.canvas.width)x-=width;var height;var summary=this.overBubbles[0].label==null;if(summary){var doc=this.cache.get(this.overBubbles[0].docIndex);var count=1;for(var t in doc.freqCounts)count++;height=count*16;if(y+height>this.canvas.height)y-=height;this.ctx.fillRect(x,y,width,height);this.ctx.strokeRect(x,y,width,height);x+=10;y+=10;this.ctx.fillStyle="rgba(0, 0, 0, 0.8)";this.ctx.font="10px Verdana";for(var t in doc.freqCounts){var freq=doc.freqCounts[t];this.ctx.fillText(t+
": "+freq,x,y,90);y+=16}}else{height=this.overBubbles.length*16+10;if(y+height>this.canvas.height)y-=height;this.ctx.fillRect(x,y,width,height);this.ctx.strokeRect(x,y,width,height);x+=10;y+=10;this.ctx.fillStyle="rgba(0, 0, 0, 0.8)";this.ctx.font="10px Verdana";for(var i=0;i<this.overBubbles.length;i++){var b=this.overBubbles[i];this.ctx.fillText(b.label+": "+b.freq,x,y,90);y+=16}}if(this.clearToolTipId==null)this.clearToolTipId=setTimeout(this.clearToolTip.bind(this),this.DISMISS_DELAY)}},clearToolTip:function(){this.overBubbles=
[];clearTimeout(this.clearToolTipId);this.clearToolTipId=null},mouseEnterHandler:function(event){this.mouseOver=true;this.drawGraph()},mouseLeaveHandler:function(event){this.mouseOver=false;if(this.intervalId!=null)clearInterval(this.intervalId);this.overBubbles=[];this.drawGraph()},moveHandler:function(event){this.clearToolTip();this.overBubbles=[];var x=event.layerX-this.MAX_LABEL_WIDTH;var y=event.layerY;var docHeight=this.maxRadius*.25;var docIndex=-1;this.cache.each(function(doc,index,length){if(y<
docHeight)return false;else{docHeight+=doc.height;if(y<docHeight){docIndex=index;return false}}},this);if(this.dragInfo!=null){this.dragInfo.x=event.layerX;this.dragInfo.y=y;if(docIndex>=this.cache.getCount())docIndex=this.cache.getCount()-1;else if(docIndex<0)if(y+this.maxRadius>this.canvas.height)docIndex=this.cache.getCount()-1;else docIndex=0;this.dragInfo.newIndex=docIndex;document.body.style.cursor="move"}else if(docIndex>=0&&docIndex<this.cache.getCount())if(x>=0){var showPointer=false;x-=
this.maxRadius;var hits=[];var doc=this.cache.get(docIndex);if(x>=doc.lineLength)this.overBubbles=[{docIndex:docIndex,x:event.layerX+10,y:event.layerY+10}];else{var spacing=doc.lineLength/this.bubbleSpacing;var xIndex=Math.round(x/spacing);var prevDocHeight=this.maxRadius;if(docIndex>0)prevDocHeight=docHeight-(this.cache.get(docIndex).height-this.maxRadius*.75);var yIndex=Math.round((y-prevDocHeight)/this.maxRadius);var count=0;for(var t in doc.terms)if(this.termsFilter.indexOf(t)!==-1){var type=
doc.terms[t];if(type){if(this.SEPARATE_LINES_FOR_TERMS&&count==yIndex||!this.SEPARATE_LINES_FOR_TERMS)if(type.pos[xIndex]&&type.pos[xIndex].radius>0){showPointer=true;this.overBubbles.push({label:t,type:type,docId:doc.id,docIndex:docIndex,xIndex:xIndex,yIndex:yIndex,freq:type.pos[xIndex].freq,id:type.pos[xIndex].id,tokenPositions:type.pos[xIndex].tokenPositions,x:event.layerX+10,y:event.layerY+10})}}else if(this.SEPARATE_LINES_FOR_TERMS)count--;count++}}if(showPointer)document.body.style.cursor="pointer";
else document.body.style.cursor="auto"}else document.body.style.cursor="move";else document.body.style.cursor="auto"},mouseDownHandler:function(event){var x=event.layerX;var y=event.layerY;if(x<this.MAX_LABEL_WIDTH){var docHeight=this.maxRadius*.25;var docIndex=-1;this.cache.each(function(doc,index,length){if(y<docHeight)return false;else{docHeight+=doc.height;if(y<docHeight){docIndex=index;return false}}},this);if(docIndex>=0&&docIndex<this.cache.getCount()){var xOffset=x-5;var yOffset=5;this.dragInfo=
{oldIndex:docIndex,newIndex:docIndex,xOffset:xOffset,yOffset:yOffset,x:x,y:y}}}},mouseUpHandler:function(event){this.dragInfo=null},doDrag:function(){if(this.dragInfo!=null){var ordering={};for(var i=0;i<this.cache.getCount();i++)if(i<this.dragInfo.oldIndex&&i<this.dragInfo.newIndex)ordering[i]=i;else if(i<this.dragInfo.oldIndex&&i>=this.dragInfo.newIndex)ordering[i]=i+1;else if(i==this.dragInfo.oldIndex)ordering[i]=this.dragInfo.newIndex;else if(i>this.dragInfo.oldIndex&&i>this.dragInfo.newIndex)ordering[i]=
i;else if(i>this.dragInfo.oldIndex&&i<=this.dragInfo.newIndex)ordering[i]=i-1;this.dragInfo.oldIndex=this.dragInfo.newIndex;this.cache.reorder(ordering);var doc=this.cache.get(this.dragInfo.oldIndex);this.ctx.fillStyle="rgba(128, 128, 128, 1)";this.ctx.textBaseline="top";this.ctx.font="bold 12px Verdana";this.ctx.fillText(doc.title,this.dragInfo.x-this.dragInfo.xOffset,this.dragInfo.y-this.dragInfo.yOffset)}},clickHandler:function(event){this.lastClickedBubbles={};if(this.overBubbles.length>0&&this.overBubbles[0].label){var hits=
[];var tokenPositions=[];var termData=[];for(var i=0;i<this.overBubbles.length;i++){var b=this.overBubbles[i];termData.push({term:b.label,docIndex:b.docIndex,docId:b.docId,tokenPositions:b.tokenPositions});if(this.lastClickedBubbles[b.docIndex]==null)this.lastClickedBubbles[b.docIndex]={};this.lastClickedBubbles[b.docIndex][b.label]=b.id;hits.push(b.docId+":"+b.label);tokenPositions.push(b.tokenPositions)}tokenPositions=Ext.flatten(tokenPositions);tokenPositions.sort();if(this.externalClickHandler!==
undefined)this.externalClickHandler(termData)}this.overBubbles=[]},setMaxFreq:function(maxObj){if(maxObj==null)maxObj=this.findMaxFreq();this.maxFreq=maxObj},findMaxFreq:function(){var max={term:"",value:0};this.cache.each(function(doc){for(var t in doc.terms){var maxDistribution=doc.terms[t].maxDistribution;if(maxDistribution>max.value)max={term:t,value:maxDistribution}}},this);return max},getNewColor:function(){var color=null;for(var i=0;i<this.colors.length;i++){color=this.colors[i];var match=
this.typeStore.findExact("color",color);if(match==-1)break;else color=null}if(color==null)color=[128,128,128];return color},removeAllTerms:function(){this.cache.each(function(doc){doc.terms={}},this);this.currentTerms={};this.termsFilter=[]},removeTerm:function(term){delete this.currentTerms[term];var getNewMax=false;this.cache.each(function(doc){for(var t in doc.terms)if(t==term){if(this.maxFreq.term==term){this.maxFreq={term:null,value:0};getNewMax=true}delete doc.terms[t]}},this);for(var i in this.lastClickedBubbles){var lcTypes=
this.lastClickedBubbles[i];for(var lcType in lcTypes)if(lcType==term)delete this.lastClickedBubbles[i][lcType]}if(getNewMax){this.setMaxFreq();this.calculateBubbleRadii();this.drawGraph()}},clearCanvas:function(){this.canvas.width=this.canvas.width}};function Knots(config){this.container=config.container;this.externalClickHandler=config.clickHandler;this.MAX_LINE_LENGTH=0;this.LINE_SIZE=2.5;this.progressiveDraw=true;this.progDrawDone=false;this.drawStep=0;this.mouseOver=false;this.refreshInterval=100;this.forceRedraw=false;this.lastDrawTime=(new Date).getTime();this.intervalId=null;this.startAngle=315;this.angleIncrement=15;this.canvas=null;this.ctx=null;this.currentDoc={terms:{},lineLength:undefined};this.maxDocLength=0;this.offset={x:0,y:0};
this.termsFilter=[];this.initialized=false;this.audio=config.audio;this.audioCtx=null}
Knots.prototype={constructor:Knots,initializeCanvas:function(){var container=this.container;var height=container.getHeight()-5;var width=container.getWidth();this.MAX_LINE_LENGTH=Math.sqrt(width*width+height*height);var id=Ext.id("knots");container.add({xtype:"container",width:width,height:height,html:'\x3ccanvas id\x3d"'+id+'" width\x3d"'+width+'" height\x3d"'+height+'"\x3e\x3c/canvas\x3e',border:false,listeners:{afterrender:{fn:function(cnt){this.canvas=document.getElementById(id);this.ctx=this.canvas.getContext("2d");
this.canvas.addEventListener("click",this.clickHandler.bind(this),false);this.canvas.addEventListener("mousedown",this.mouseDownHandler.bind(this),false);this.canvas.addEventListener("mouseup",this.mouseUpHandler.bind(this),false);this.canvas.addEventListener("mousemove",this.moveHandler.bind(this),false)},single:true,scope:this}}});container.updateLayout();this.initialized=true},doLayout:function(){if(this.initialized){var width=this.container.getWidth();var height=this.container.getHeight()-5;this.canvas.width=
width;this.canvas.height=height;this.recache();this.buildGraph()}},buildGraph:function(drawStep){if(this.intervalId!=null){this.progDrawDone=false;clearInterval(this.intervalId)}this.forceRedraw=true;this.drawStep=drawStep||0;for(var t in this.currentDoc.terms){var term=this.currentDoc.terms[t];term.done=false}if(!this.progressiveDraw)this.doDraw(false);else this.intervalId=setInterval(this.doDraw.createDelegate(this,[false]),50)},drawGraph:function(includeLegend){if(this.intervalId!=null){this.progDrawDone=
false;clearInterval(this.intervalId)}this.forceRedraw=true;if(!this.progressiveDraw)this.doDraw(false,includeLegend);else this.intervalId=setInterval(this.doDraw.createDelegate(this,[includeLegend]),50)},doDraw:function(includeLegend){var time=(new Date).getTime();if(this.forceRedraw||time-this.lastDrawTime>=this.refreshInterval){this.forceRedraw=false;this.clearCanvas();this.ctx.save();this.ctx.translate(this.offset.x,this.offset.y);this.drawDocument(this.currentDoc);this.originOpacity=.5;this.originColor=
"128,128,128";this.ctx.lineWidth=Math.abs(this.originOpacity-1)*15;this.ctx.fillStyle="rgba("+this.originColor+",1.0)";this.ctx.strokeStyle="rgba("+this.originColor+","+this.originOpacity+")";this.ctx.beginPath();this.ctx.arc(0,0,this.LINE_SIZE*2,0,Math.PI*2,true);this.ctx.closePath();this.ctx.fill();if(!includeLegend)this.ctx.stroke();this.ctx.restore();this.ctx.lineWidth=1;if(includeLegend===true)this.drawLegend();this.lastDrawTime=(new Date).getTime();if(this.progressiveDraw){var done=true;for(var t in this.currentDoc.terms)done=
done&&this.currentDoc.terms[t].done;this.progDrawDone=done;if(done){clearInterval(this.intervalId);this.intervalId=null;this.muteTerms()}else this.drawStep++}}},setAudio:function(audio){this.audio=audio;if(!audio)this.muteTerms()},muteTerms:function(){for(t in this.currentDoc.terms)if(this.currentDoc.terms[t].audio)this.currentDoc.terms[t].audio.gainNode.gain.value=0},drawDocument:function(doc){var terms=doc.terms;for(var t in terms)if(this.termsFilter.indexOf(t)!=-1){var info=terms[t];if(info&&info.pos){var prevXY=
[[0,0],[0,0]];if(this.progressiveDraw){var length=this.drawStep+1;if(info.pos.length<=this.drawStep){info.done=true;length=info.pos.length;if(info.audio)info.audio.gainNode.gain.value=0}else{if(this.audio&&info.audio){info.audio.gainNode.gain.value=.1;setTimeout(function(){info.audio.gainNode.gain.value=0},this.refreshInterval*.75)}info.done=false}for(var i=0;i<length;i++){var xy=info.pos[i];this.drawPolygon(xy,prevXY,info.color);prevXY=[[xy.polygon[0][3],xy.polygon[1][3]],[xy.polygon[0][2],xy.polygon[1][2]]]}}else for(var i=
0;i<info.pos.length;i++){var xy=info.pos[i];this.drawPolygon(xy,prevXY,info.color);prevXY=[[xy.polygon[0][3],xy.polygon[1][3]],[xy.polygon[0][2],xy.polygon[1][2]]]}}}},drawPolygon:function(xy,prevXY,color){var polyX=xy.polygon[0];var polyY=xy.polygon[1];this.ctx.beginPath();this.ctx.moveTo(prevXY[0][0],prevXY[0][1]);this.ctx.lineTo(polyX[0],polyY[0]);this.ctx.lineTo(polyX[1],polyY[1]);this.ctx.lineTo(prevXY[1][0],prevXY[1][1]);this.ctx.closePath();this.ctx.fillStyle="rgba("+color+", 0.6)";this.ctx.fill();
this.ctx.beginPath();this.ctx.moveTo(polyX[0],polyY[0]);this.ctx.lineTo(polyX[1],polyY[1]);this.ctx.lineTo(polyX[2],polyY[2]);this.ctx.lineTo(polyX[3],polyY[3]);this.ctx.closePath();if(xy.over)this.ctx.fillStyle="rgba("+color+", 1.0)";this.ctx.fill()},drawLegend:function(){var x=5;var y=5;this.ctx.textBaseline="top";this.ctx.font="16px serif";this.termStore.each(function(record){var color=record.get("color");this.ctx.fillStyle="rgb("+color+")";var term=record.get("term");this.ctx.fillText(term,x,
y);var width=this.ctx.measureText(term).width;x+=width+8},this)},setCurrentDoc:function(doc){this.currentDoc=doc;this.cacheCurrentDocument()},addTerms:function(termsObj){Ext.apply(this.currentDoc.terms,termsObj);this.recache()},removeTerm:function(term){if(this.currentDoc.terms[term].audio)this.currentDoc.terms[term].audio.oscillator.stop();delete this.currentDoc.terms[term];this.recache()},removeAllTerms:function(){for(term in this.currentDoc.terms)if(this.currentDoc.terms[term].audio)this.currentDoc.terms[term].audio.oscillator.stop();
this.currentDoc.terms={};this.recache()},recache:function(){this.MAX_LINE_LENGTH=Math.sqrt(this.canvas.width*this.canvas.width+this.canvas.height*this.canvas.height);this.cacheCurrentDocument();this.determineGraphSizeAndPosition()},cacheCurrentDocument:function(){var lineLength=this.MAX_LINE_LENGTH;this.currentDoc.lineLength=lineLength;if(this.audio&&this.audioCtx==null)try{this.audioCtx=new (window.AudioContext||window.webkitAudioContext)}catch(e){}for(var term in this.currentDoc.terms){if(this.audio&&
this.audioCtx&&!this.currentDoc.terms[term].audio){var oscillator=this.audioCtx.createOscillator();var gainNode=this.audioCtx.createGain();oscillator.connect(gainNode);gainNode.connect(this.audioCtx.destination);oscillator.frequency.value=Math.random()*500+150;oscillator.start();gainNode.gain.value=0;this.currentDoc.terms[term].audio={oscillator:oscillator,gainNode:gainNode}}this.cacheTurns(this.currentDoc.terms[term],lineLength)}},cacheTurns:function(info,lineLength){var rawFreq=info.rawFreq;if(rawFreq>
0){var doc=this.currentDoc;var term=info.term;var color=info.color;var cachedPositions=[];var tokenIds=info.positions;var lastTokenId=tokenIds[tokenIds.length-1];var angle=this.startAngle;var angleIncrement=this.angleIncrement;var prevX=0;var prevY=0;var x=0;var y=0;var prevLength=0;for(var i=0;i<tokenIds.length;i++){var o=tokenIds[i];var length=o/lastTokenId*lineLength;var segment=length-prevLength;prevX=x;prevY=y;var newPoint=this.findEndPoint([x,y],segment,angle);x=newPoint[0];y=newPoint[1];var polygon=
this.getPolygonFromLine([prevX,prevY],[x,y],angle,this.LINE_SIZE);cachedPositions.push({tokenId:o,polygon:polygon,over:false});prevLength=length;angle+=angleIncrement}doc.terms[term].pos=cachedPositions;doc.terms[term].done=false}},findEndPoint:function(point,length,angle){var radians=this.degreesToRadians(angle);var x2=point[0]+length*Math.cos(radians);var y2=point[1]+length*Math.sin(radians);return[x2,y2]},determineGraphSizeAndPosition:function(){var bb=this.findBoundingBoxForGraph();var width=
bb.maxX-bb.minX;var height=bb.maxY-bb.minY;var widthRatio=this.canvas.width/width;var heightRatio=this.canvas.height/height;var ratio=Math.min(widthRatio,heightRatio);ratio-=.05;width*=ratio;height*=ratio;this.offset.x=Math.abs(bb.minX*ratio-(this.canvas.width/2-width/2));this.offset.y=Math.abs(bb.minY*ratio-(this.canvas.height/2-height/2));this.MAX_LINE_LENGTH=Math.sqrt(this.canvas.width*this.canvas.width+this.canvas.height*this.canvas.height)*ratio;this.cacheCurrentDocument()},findBoundingBoxForGraph:function(){var minX=
null;var maxX=null;var minY=null;var maxY=null;for(var t in this.currentDoc.terms){var pos=this.currentDoc.terms[t].pos;for(var i=0;i<pos.length;i++){var polygon=pos[i].polygon;var bb=this.getBoundingBox(polygon[0],polygon[1]);if(minX==null||bb[0]<minX)minX=bb[0];if(maxX==null||bb[2]>maxX)maxX=bb[2];if(minY==null||bb[1]<minY)minY=bb[1];if(maxY==null||bb[3]>maxY)maxY=bb[3]}}return{minX:minX,minY:minY,maxX:maxX,maxY:maxY}},getBoundingBox:function(polyX,polyY){var minX=Math.min(polyX[0],polyX[2]);var maxX=
Math.max(polyX[0],polyX[2]);var minY=Math.min(polyY[0],polyY[2]);var maxY=Math.max(polyY[0],polyY[2]);return[minX,minY,maxX,maxY]},degreesToRadians:function(d){return d*(Math.PI/180)},clickHandler:function(event){var x=event.layerX-this.offset.x;var y=event.layerY-this.offset.y;var hit=null;var tokenId=0;for(var t in this.currentDoc.terms)if(this.termsFilter.indexOf(t)!=-1){var pos=this.currentDoc.terms[t].pos;for(var i=0;i<pos.length;i++){var polygon=pos[i].polygon;var test=this.isPointInPolygon(polygon[0],
polygon[1],x,y);if(test){hit=t;tokenId=pos[i].tokenId;break}}}if(hit)if(this.externalClickHandler!==undefined)this.externalClickHandler({term:hit,tokenId:tokenId})},moveHandler:function(event){var x=event.layerX-this.offset.x;var y=event.layerY-this.offset.y;if(this.dragInfo!=null){document.body.style.cursor="move";this.dragInfo.lastX=this.dragInfo.x;this.dragInfo.lastY=this.dragInfo.y;this.dragInfo.x=event.layerX;this.dragInfo.y=event.layerY;var xDiff=this.dragInfo.x-this.dragInfo.lastX;var yDiff=
this.dragInfo.y-this.dragInfo.lastY;this.offset.x+=xDiff;this.offset.y+=yDiff}else{this.mouseOver=false;for(var t in this.currentDoc.terms)if(this.termsFilter.indexOf(t)!=-1){var pos=this.currentDoc.terms[t].pos;for(var i=0;i<pos.length;i++)if(!this.mouseOver){var polygon=pos[i].polygon;var test=this.isPointInPolygon(polygon[0],polygon[1],x,y);if(test){this.currentDoc.terms[t].pos[i].over=true;this.mouseOver=true}else this.currentDoc.terms[t].pos[i].over=false}else this.currentDoc.terms[t].pos[i].over=
false}if(this.mouseOver){document.body.style.cursor="pointer";if(!this.progressiveDraw||this.progressiveDraw&&this.progDrawDone){clearInterval(this.intervalId);this.intervalId=setInterval(this.doDraw.createDelegate(this,[false]),50)}}else{document.body.style.cursor="auto";if(!this.progressiveDraw||this.progressiveDraw&&this.progDrawDone){clearInterval(this.intervalId);this.doDraw(false)}}}},mouseDownHandler:function(event){var x=event.layerX;var y=event.layerY;this.dragInfo={lastX:x,lastY:y,x:x,y:y}},
mouseUpHandler:function(event){this.dragInfo=null},getPolygonFromLine:function(point1,point2,angle,size){var perpDown=angle+90;var perpUp=angle-90;var p1=this.findEndPoint(point1,size,perpDown);var p2=this.findEndPoint(point1,size,perpUp);var p3=this.findEndPoint(point2,size,perpUp);var p4=this.findEndPoint(point2,size,perpDown);var polyX=[p1[0],p2[0],p3[0],p4[0]];var polyY=[p1[1],p2[1],p3[1],p4[1]];return[polyX,polyY]},isPointInPolygon:function(polyX,polyY,x,y){var i=0;var j=3;var oddNodes=false;
for(i=0;i<4;i++){if(polyY[i]<y&&polyY[j]>=y||polyY[j]<y&&polyY[i]>=y)if(polyX[i]+(y-polyY[i])/(polyY[j]-polyY[i])*(polyX[j]-polyX[i])<x)oddNodes=!oddNodes;j=i}return oddNodes},clearCanvas:function(){this.canvas.width=this.canvas.width}};function Cirrus(config){var that=this;this.config=config;var canvasId=Ext.id(null,"cirrusCanvas");if(this.config.containerId==null){alert("You must provide a valid container ID!");return}var containerId="#"+this.config.containerId;var wordController=null;var resizeTimer=null;this.clear=function(){this.canvas.width=this.canvas.width};this.addWords=function(words){wordController.addWords(words)};this.arrangeWords=function(){wordController.arrangeWords()};this.clearAll=function(){wordController.setWords([]);
wordController.grid=[];this.clear()};this.resizeWords=function(){that.setCanvasDimensions();wordController.resetWordCoordinates();wordController.calculateSizeAdjustment();wordController.resizeWords();wordController.arrangeWords();resizeTimer=null};this.setCanvasDimensions=function(){var container=$(containerId)[0];var width=Math.max(container.offsetWidth,container.clientWidth);var height=Math.max(container.offsetHeight,container.clientHeight);this.canvas.width=width;this.canvas.height=height};function hex2RGB(hex){hex=
hex.charAt(0)=="#"?hex.substring(1,7):hex;var rgb=[];rgb.push(parseInt(hex.substring(0,2),16));rgb.push(parseInt(hex.substring(2,4),16));rgb.push(parseInt(hex.substring(4,6),16));return rgb}function init(){if($("#"+that.config.containerId).length==0){alert("You must provide a valid container ID!");return}that.canvas=document.createElement("canvas");that.canvas.setAttribute("id",canvasId);that.canvas.setAttribute("tabIndex",1);that.setCanvasDimensions();$(containerId).append(that.canvas);canvasId=
"#"+canvasId;that.context=that.canvas.getContext("2d");var isLocal=false;that.wordData=new Array;that.useFadeEffect=true;that.colors=[[116,116,181],[139,163,83],[189,157,60],[171,75,75],[174,61,155]];wordController=new WordController(that);for(var key in that.config){if(key=="words")that.wordData=that.config[key];if(key=="layout")if(that.config[key]=="circle")wordController.layout=wordController.CIRCLE;else if(that.config[key]=="square")wordController.layout=wordController.SQUARE;if(key=="colors")if($.isArray(that.config[key])&&
that.config[key].length>0){that.colors=[];for(var c in that.config[key])that.colors.push(hex2RGB(that.config[key][c]))}if(key=="background")$(canvasId).css("background-color",that.config[key]);if(key=="fade")if(that.config[key]=="true")that.useFadeEffect=true;else if(that.config[key]=="false")that.useFadeEffect=false;if(key=="smoothness")wordController.wordsToArrange=Math.max(1,Math.min(20,parseInt(that.config[key])))}if(isLocal&&testData){var cnt=0;for(var key in testData){that.wordData.push({word:key,
size:testData[key]/13,label:key});cnt++;if(cnt==100)break}}if(that.wordData.length>0){that.clear();wordController.addWords(that.wordData);wordController.arrangeWords()}$(window).resize(function(){if(resizeTimer!=null)clearTimeout(resizeTimer);resizeTimer=setTimeout(that.resizeWords,1E3)});$(canvasId).keypress(function(event){if(event.which==114)wordController.arrangeWords()});$(canvasId).click(function(event){var matchingWord=wordController.handleWordClick(event);if(matchingWord!==undefined)if(that.config.clickHandler)that.config.clickHandler({term:matchingWord.text,
value:matchingWord.value})});$(canvasId).mouseover(function(event){wordController.startUpdates()});$(canvasId).mouseout(function(event){wordController.stopUpdates()});$(canvasId).mousemove(function(event){wordController.handleMouseMove(event)})}$(document).ready(init)};function Word(_text,_origSize,_color,_rolloverText,_value){this.height=0;this.width=0;this.rotation=0;this.relativeSize=0;this.mask=null;this.size=0;this.text=_text;this.color=_color;this.origSize=_origSize;this.rolloverText=_rolloverText;this.value=_value||0;this.x=0;this.y=0;this.tx=0;this.ty=0;this.fontFamily="Arial";this.fontSize=12;this.alpha=1;this.live=false;this.isOver=false;this.draw=function(ctx){ctx.save();ctx.fillStyle="rgba("+this.color[0]+","+this.color[1]+","+this.color[2]+","+this.alpha+
")";ctx.textBaseline="alphabetic";ctx.font=this.fontSize+"px "+this.fontFamily;ctx.translate(this.x+this.tx,this.y+this.ty);ctx.rotate(this.rotation);ctx.fillText(this.text,0,0);ctx.restore()}};function WordController(parentApp){var that=this;var app=parentApp;var myFont="Impact";this.CIRCLE=0;this.ratio=1;var _layout=this.CIRCLE;this.getLayout=function(){return _layout};this.setLayout=function(value){_layout=value};this.HORIZONTAL=0;this.MIXED=1;var _wordOrientation=this.MIXED;this.getWordOrientation=function(){return _wordOrientation};this.setWordOrientation=function(value){_wordOrientation=value};this.UPDATE_RATE=25;this.COARSENESS=5;this.grid=new Array;var timer_i=0;var timer;this.doingArrange=
false;this.wordsToArrange=5;var overWord=null;var overX=0;var overY=0;var _words=new Array;this.getWords=function(){return _words};this.setWords=function(value){_words=value};this.sizeAdjustment=100;this.minFontSize=12;this.largestWordSize=0;this.smallestWordSize=1E4;var _uniqueWords=new Object;function addWord(word,size,color,label,value){var sizeChanged=false;if(_uniqueWords[word]==null){_uniqueWords[word]=true;if(size>that.largestWordSize){that.largestWordSize=size;sizeChanged=true}if(size<that.smallestWordSize){that.smallestWordSize=
size*.8;sizeChanged=true}var wordObj=new Word(word,size,color,label,value);_words.push(wordObj)}return sizeChanged}this.addWords=function(newWords){var sizeChanged=false;for(var i=0;i<newWords.length;i++){var wordObj=newWords[i];var color;if(typeof wordObj.color==undefined||wordObj.color==null||wordObj.color=="")color=app.colors[Math.floor(Math.random()*app.colors.length)];else color=wordObj.color;var size;if(typeof wordObj.size==undefined||wordObj.size==null||wordObj.size=="")size=Math.floor(Math.random()*
40);else size=parseFloat(wordObj.size);sizeChanged=addWord(wordObj.word,size,color,wordObj.label,wordObj.value)||sizeChanged}sortWords();this.setRelativeSizes();this.calculateSizeAdjustment();if(sizeChanged)this.resizeWords();else createAllGraphics()};this.resetWordCoordinates=function(){app.clear();clearTimeout(timer);for(var i=0;i<_words.length;i++){var word=_words[i];word.x=0;word.y=0;word.tx=0;word.ty=0}};this.calculateSizeAdjustment=function(){this.ratio=app.canvas.width/app.canvas.height;var stageArea=
app.canvas.width*app.canvas.height;if(stageArea<1E5)this.minFontSize=8;else this.minFontSize=12;var pixelsPerWord=stageArea/_words.length;var totalWordsSize=0;for(var i=0;i<_words.length;i++){var word=_words[i];var wordArea=calculateWordArea(word);totalWordsSize+=wordArea}this.sizeAdjustment=stageArea/totalWordsSize};function calculateWordArea(word){var baseSize=Math.log(word.relativeSize*10)*Math.LOG10E;var height=(baseSize+word.relativeSize)/2;var width=0;for(var i=0;i<word.text.length;i++){var letter=
word.text.charAt(i);if(letter=="f"||letter=="i"||letter=="j"||letter=="l"||letter=="r"||letter=="t")width+=baseSize/3;else if(letter=="m"||letter=="w")width+=baseSize/(4/3);else width+=baseSize/1.9}var wordArea=height*width;return wordArea}function measureTextHeight(label){app.context.fillStyle="rgb(255,255,255)";app.context.fillRect(label.x,label.y,label.width,label.height);label.draw(app.context);var imageData=app.context.getImageData(label.x,label.y,label.width,label.height);var first=false;var last=
false;var y=label.height;var x=0;while(!last&&y){y--;for(x=0;x<label.width;x++){var pixel=getPixel(x,y,imageData);if(pixel[0]!=255||pixel[1]!=255||pixel[2]!=255){last=y;break}}}while(y){y--;for(x=0;x<label.width;x++){var pixel=getPixel(x,y,imageData);if(pixel[0]!=255||pixel[1]!=255||pixel[2]!=255){first=y;break}}if(first!=y)return last-first}return 0}function measureDimensions(word){app.context.save();app.context.textBaseline="alphabetic";app.context.font=word.fontSize+"px "+word.fontFamily;word.width=
app.context.measureText(word.text).width;word.height=Math.ceil(app.context.measureText("m").width*1.15);app.context.restore()}function getPixel(x,y,imageData){var index=(x+y*imageData.width)*4;return[imageData.data[index],imageData.data[index+1],imageData.data[index+2],imageData.data[index+3]]}function setPixel(imageData,x,y,r,g,b,a){var index=(x+y*imageData.width)*4;imageData.data[index]=r;imageData.data[index+1]=g;imageData.data[index+2]=b;imageData.data[index+3]=a}function findNewRelativeSize(word,
areaMultiplier){var area=calculateWordArea(word)*areaMultiplier;var newRelativeSize=(Math.sqrt(6)*Math.sqrt(6*Math.pow(word.text.length,2)+area*word.text.length)-6*word.text.length)/(2*word.text.length);return newRelativeSize}this.setRelativeSizes=function(){for(var i=0;i<_words.length;i++){var word=_words[i];word.relativeSize=mapValue(word.origSize,this.smallestWordSize,this.largestWordSize,.1,1)}};this.resizeWords=function(){app.clear();createAllGraphics();sortWords()};function sortWords(){_words.sort(function(a,
b){if(a.origSize>b.origSize)return-1;else if(a.origSize<b.origSize)return 1;else return 0})}function createWordGraphics(wordObj){var adjustedSize=findNewRelativeSize(wordObj,that.sizeAdjustment);wordObj.fontSize=adjustedSize>that.minFontSize?adjustedSize:that.minFontSize;wordObj.fontFamily=myFont;measureDimensions(wordObj);wordObj.tx=0;wordObj.ty=wordObj.height;var angle=0;if(that.getWordOrientation()===that.MIXED)if(wordObj.text.match(/\s/)==null)if(Math.random()>.66){var tempHeight=wordObj.height;
var tempWidth=wordObj.width;wordObj.height=tempWidth;wordObj.width=tempHeight;if(Math.round(Math.random())==0){angle=90;wordObj.ty=0}else{angle=-90;wordObj.ty=wordObj.height;wordObj.tx=wordObj.width}}wordObj.size=Math.max(wordObj.height,wordObj.width);wordObj.rotation=degreesToRadians(angle);app.context.fillStyle=app.canvas.style.backgroundColor;app.context.fillRect(0,0,app.canvas.width,app.canvas.height);wordObj.draw(app.context);var imageData=app.context.getImageData(wordObj.x,wordObj.y,wordObj.width,
wordObj.height);var mask=new Array;for(var x=0;x<wordObj.width;x++){var xm=Math.floor(x/that.COARSENESS)*that.COARSENESS;if(mask[xm]==null)mask[xm]={};for(var y=0;y<wordObj.height;y++){var ym=Math.floor(y/that.COARSENESS)*that.COARSENESS;var pixel=getPixel(x,y,imageData);var pixelColor="rgb("+pixel[0]+", "+pixel[1]+", "+pixel[2]+")";if(pixelColor!=app.canvas.style.backgroundColor)mask[xm][ym]=true;if(mask[xm][ym]){y=ym+that.COARSENESS;continue}}}wordObj.mask=mask}function createAllGraphics(){for(var i=
0;i<_words.length;i++)createWordGraphics(_words[i])}this.arrangeWords=function(){clearTimeout(timer);app.clear();this.toggleLoadingText();if(_words.length>0){this.grid=[];timer_i=0;function doArrange(){var x;var y;var word;var breakOut;var fail;var wordCount=this.wordsToArrange-1;var appCanvasWidth=app.canvas.width;var appCanvasHeight=app.canvas.height;var halfWidth=appCanvasWidth*.5;var halfHeight=appCanvasHeight*.5;var dd=.05;do{word=_words[timer_i];if(word!==undefined){var a=Math.random()*Math.PI;
var d=Math.random()*(word.size*.25);var da=(Math.random()-.5)*.5;var halfWordWidth=word.width*.5;var halfWordHeight=word.height*.5;while(true){x=Math.floor((halfWidth+Math.cos(a)*d*this.ratio-halfWordWidth)/this.COARSENESS)*this.COARSENESS;y=Math.floor((halfHeight+Math.sin(a)*d-halfWordHeight)/this.COARSENESS)*this.COARSENESS;fail=false;if(x+halfWordWidth>=appCanvasWidth||y+halfWordHeight>=appCanvasHeight)fail=true;else fail=hitTest(x,y,word.height,word.width,word.mask);if(!fail)break;a+=da;d+=dd}finalizeWord(x,
y,word);if(app.useFadeEffect){word.alpha=0;for(var w=0;w<timer_i;w++){var wrd=_words[w];if(wrd.alpha<1)fadeWord(wrd)}}else{word.alpha=1;word.draw(app.context)}}timer_i++;if(timer_i>=_words.length){clearTimeout(timer);this.doingArrange=false;this.toggleLoadingText(false);drawWords();break}}while(wordCount--)}function hitTest(x,y,h,w,mask){for(var xt=0;xt<=w;xt+=this.COARSENESS)for(var yt=0;yt<=h;yt+=this.COARSENESS)if(mask[xt]&&mask[xt][yt]&&this.grid[xt+x]!=null&&this.grid[xt+x][yt+y]!=null)return true;
return false}function finalizeWord(x,y,word,drawIt){set_grid(x,y,word);word.x=x;word.y=y;word.live=true;if(drawIt)word.draw(app.context)}function fadeWord(word){word.alpha+=.25;word.draw(app.context)}function set_grid(x,y,word){for(var xt=0;xt<word.width;xt+=this.COARSENESS)for(var yt=0;yt<word.height;yt+=this.COARSENESS)if(word.mask[xt]&&word.mask[xt][yt]){if(!this.grid[xt+x])this.grid[xt+x]=[];this.grid[xt+x][yt+y]=word}}doArrange=doArrange.createDelegate(this);hitTest=hitTest.createDelegate(this);
finalizeWord=finalizeWord.createDelegate(this);fadeWord=fadeWord.createDelegate(this);set_grid=set_grid.createDelegate(this);this.doingArrange=true;timer=setInterval(doArrange,50)}else alert("Error: There are no words to arrange.")};this.toggleLoadingText=function(show){app.context.save();if(show)app.context.fillStyle="black";else app.context.fillStyle=app.canvas.style.backgroundColor;app.context.textBaseline="top";app.context.font="10px Arial";var offset=app.context.measureText("Loading").width+
10;app.context.fillText("Loading",app.canvas.width-offset,10);app.context.restore()};this.startUpdates=function(){timer=setInterval(drawWords,that.UPDATE_RATE)};this.stopUpdates=function(){if(overWord!=null){overWord=null;drawWords()}clearTimeout(timer)};function drawWords(){app.clear();var i=_words.length;while(i--){var word=_words[i];word.alpha=1;if(word.live)word.draw(app.context)}var $canvasEl=$(app.canvas);if(overWord!=null){$canvasEl.css("cursor","pointer");app.context.save();app.context.textBaseline=
"alphabetic";app.context.font="12px Arial";var wordWidth=app.context.measureText(overWord.text).width;var valueWidth=app.context.measureText(overWord.value).width;var maxWidth=wordWidth>valueWidth?wordWidth:valueWidth;maxWidth+=20;var x=overX+15;var y=overY+25;var appWidth=$canvasEl.width();var appHeight=$canvasEl.height();if(x+maxWidth>=appWidth)x-=maxWidth;if(y+40>=appHeight)y-=40;app.context.fillStyle="rgba(255,255,255,0.9)";app.context.strokeStyle="rgba(100,100,100,0.9)";app.context.translate(x,
y);app.context.fillRect(0,0,maxWidth,40);app.context.strokeRect(0,0,maxWidth,40);app.context.fillStyle="rgba(0,0,0,0.9)";app.context.fillText(overWord.text+":",8,18);app.context.fillText(overWord.value,8,30);app.context.restore()}else $canvasEl.css("cursor","default")}this.handleMouseMove=function(event){if(!this.doingArrange){var i=_words.length;while(i--)_words[i].isOver=false;var offset=$(app.canvas).offset();var remainder=(event.pageX-offset.left)%this.COARSENESS;var x=event.pageX-offset.left-
remainder;remainder=(event.pageY-offset.top)%this.COARSENESS;var y=event.pageY-offset.top-remainder;overWord=this.findWordByCoords(x,y);if(overWord!=null){overWord.isOver=true;overX=x;overY=y}}};this.handleWordClick=function(event){var offset=$(app.canvas).offset();var remainder=(event.pageX-offset.left)%this.COARSENESS;var x=event.pageX-offset.left-remainder;remainder=(event.pageY-offset.top)%this.COARSENESS;var y=event.pageY-offset.top-remainder;var matchingWord=this.findWordByCoords(x,y);if(matchingWord!=
null)return{text:matchingWord.text,value:matchingWord.value}};this.findWordByCoords=function(x,y){var matchingWord=null;if(this.grid[x]!=null)if(this.grid[x][y]!=null)matchingWord=this.grid[x][y];else if(this.grid[x][y+this.COARSENESS]!=null)matchingWord=this.grid[x][y+this.COARSENESS];if(matchingWord==null&&this.grid[x+this.COARSENESS]!=null)if(this.grid[x+this.COARSENESS][y]!=null)matchingWord=this.grid[x+this.COARSENESS][y];else if(this.grid[x+this.COARSENESS][y+this.COARSENESS]!=null)matchingWord=
this.grid[x+this.COARSENESS][y+this.COARSENESS];return matchingWord};function degreesToRadians(degrees){var radians=degrees*(Math.PI/180);return radians}function mapValue(value,istart,istop,ostart,ostop){return ostart+(ostop-ostart)*((value-istart)/(istop-istart))}}
Function.prototype.createDelegate=function(obj,args,appendArgs){var method=this;return function(){var callArgs=args||arguments;if(appendArgs===true){callArgs=Array.prototype.slice.call(arguments,0);callArgs=callArgs.concat(args)}else if(typeof appendArgs=="number"){callArgs=Array.prototype.slice.call(arguments,0);var applyArgs=[appendArgs,0].concat(args);Array.prototype.splice.apply(callArgs,applyArgs)}return method.apply(obj||window,callArgs)}};var doubletree={};
(function(){doubletree.DoubleTree=function(){var containers=[];var visWidth=600;var visHt=400;var prefixesOnRight=false;var filters={"left":[],"right":[]};var handlers={"alt":noOp,"shift":noOp,"click":noOp};var showTokenExtra=true;var scaleLabels=true;var sortFun=doubletree.sortByStrFld("token");var nodeText=doubletree.tokenText;var tokenExtraText=function(info){return doubletree.fieldText(info,"POS")};var rectColor=function(info){return"rgba(255,255,255,1)"};var rectBorderColor=function(info){return"rgba(255,255,255,1)"};
var continuationColor=function(info){return"red"};var basicStyles={"node":{"fill":"white","stroke":"steelblue","stroke-width":"1.5px"},"branch":{"stroke":"#aaa","stroke-width":"1.5px"}};var succeeded=false;var dispatch=d3.dispatch("idsUpdated");dispatch.on("idsUpdated",function(){if(this==leftTree){rtTree.setIds(leftTree.continuationIDs);rtTree.updateContinuations()}else if(this==rtTree){leftTree.setIds(rtTree.continuationIDs);leftTree.updateContinuations()}});var leftTrie,rtTrie,leftTree,rtTree;
var visibleIDs;var kFontSize=14;var kBigFontSize=1.15*kFontSize;var kMinFontSize=8;var textScale;function mine(selection){selection.each(function(d,i){containers.push(this.node())})}mine.init=function(containerPattern){d3.select(d3.selectAll(containerPattern)).call(this);return mine};mine.redraw=function(){if(leftTrie!==undefined&&rtTrie!==undefined)mine.setupFromTries(leftTrie,rtTrie);return mine};mine.setupFromTries=function(leftOne,rtOne){leftTrie=leftOne.getUniqRoot();rtTrie=rtOne.getUniqRoot();
var leftTrieTree=leftTrie.toTree(filters.left);var rtTrieTree=rtTrie.toTree(filters.right);var copyIDs=true;if(Object.keys(rtTrieTree.pruned).length>0){new_pruneTree(rtTrieTree,rtTrieTree.pruned,copyIDs);new_pruneTree(leftTrieTree,rtTrieTree.pruned,copyIDs);copyIDs=false}if(Object.keys(leftTrieTree.pruned).length>0){new_pruneTree(leftTrieTree,leftTrieTree.pruned,copyIDs);new_pruneTree(rtTrieTree,leftTrieTree.pruned,copyIDs)}var newInfo={};for(var k in rtTrieTree.info)if(k!="continuations"&&k!="ids"&&
k!="count")newInfo[k]=rtTrieTree.info[k];newInfo["right continuations"]=rtTrieTree.info.continuations;newInfo["left continuations"]=leftTrieTree.info.continuations;newInfo.ids={};addTo(newInfo.ids,rtTrieTree.info.ids);addTo(newInfo.ids,leftTrieTree.info.ids);newInfo.count=Object.keys(newInfo.ids).length;visibleIDs=Object.keys(newInfo.ids);if(rtTrieTree.info.origIDs||leftTrieTree.info.origIDs){newInfo.origIDs={};addTo(newInfo.origIDs,rtTrieTree.info.origIDs);addTo(newInfo.origIDs,leftTrieTree.info.origIDs);
newInfo.origCount=Object.keys(newInfo.origIDs).length}rtTrieTree.info=newInfo;leftTrieTree.info=newInfo;var maxChildren=Math.max(leftTrieTree.maxChildren,rtTrieTree.maxChildren);if(isNaN(maxChildren)||maxChildren==0){succeeded=false;return mine}if(scaleLabels)textScale=d3.scaleLog().range([kMinFontSize,kFontSize]);else{textScale=function(){return kFontSize};textScale.domain=function(){}}var minCount=Math.min(leftTrieTree.minCount,rtTrieTree.minCount);textScale.domain([minCount,leftTrieTree.info.count]);
var margin={top:20,right:20,bottom:20,left:20};var width=visWidth-margin.right-margin.left;var height=visHt-margin.top-margin.bottom;containers.forEach(function(d,i){var thisContainer=d;var thisVis;var tmp=d3.select(thisContainer).select("svg");if(tmp.node()==null){thisVis=d3.select(thisContainer).append("svg").attr("width",width+margin.right+margin.left).attr("height",height+margin.top+margin.bottom).attr("cursor","move").call(d3.zoom().scaleExtent([1,1]).on("zoom",function(){var x=d3.event.transform.x+
width/2;var y=d3.event.transform.y+height/2;d3.select(thisContainer).select("svg \x3e g").attr("transform","translate("+x+","+y+")")}));thisVis.append("g").attr("transform","translate("+width/2+","+height/2+")")}else{thisVis=tmp;thisVis.attr("width",width+margin.right+margin.left).attr("height",height+margin.top+margin.bottom);thisVis.selectAll("g *").remove()}leftTree=new doubletree.Tree(thisVis.select("g"),visWidth,visHt,leftTrieTree,true,sortFun,dispatch,textScale,showTokenExtra,nodeText,tokenExtraText,
rectColor,rectBorderColor,continuationColor,basicStyles);rtTree=new doubletree.Tree(thisVis.select("g"),visWidth,visHt,rtTrieTree,false,sortFun,dispatch,textScale,showTokenExtra,nodeText,tokenExtraText,rectColor,rectBorderColor,continuationColor,basicStyles)});leftTree.handleAltPress=handlers.alt;rtTree.handleAltPress=handlers.alt;leftTree.handleShiftPress=handlers.shift;rtTree.handleShiftPress=handlers.shift;leftTree.handleClick=handlers.click;rtTree.handleClick=handlers.click;succeeded=true;return mine};
mine.setupFromArrays=function(prefixArray,hitArray,suffixArray,idArray,caseSensitive,fieldNames,fieldDelim,distinguishingFieldsArray){if(undefined==caseSensitive&&leftTrie)caseSensitive=leftTrie.caseSensitive();if(undefined==fieldNames&&leftTrie)fieldNames=leftTrie.fieldNames();if(undefined==fieldDelim&&leftTrie)fieldDelim=leftTrie.fieldDelim();if(undefined==distinguishingFieldsArray&&leftTrie)distinguishingFieldsArray=leftTrie.distinguishingFieldsArray();leftTrie=new doubletree.Trie(caseSensitive,
fieldNames,fieldDelim,distinguishingFieldsArray);rtTrie=new doubletree.Trie(caseSensitive,fieldNames,fieldDelim,distinguishingFieldsArray);var n=hitArray.length;for(var i=0;i<n;i++){var thisID=idArray?idArray[i]:i;var thisHit=hitArray[i];var thesePrefixes=prefixArray[i].slice();var theseSuffixes=suffixArray[i].slice();thesePrefixes.push(thisHit);thesePrefixes.reverse();theseSuffixes.unshift(thisHit);if(prefixesOnRight){rtTrie.addNgram(thesePrefixes,thisID);leftTrie.addNgram(theseSuffixes,thisID)}else{leftTrie.addNgram(thesePrefixes,
thisID);rtTrie.addNgram(theseSuffixes,thisID)}}mine.setupFromTries(leftTrie,rtTrie);return mine};mine.filteredIDs=function(){return visibleIDs};mine.search=function(searchRE){leftTree.search(searchRE);rtTree.search(searchRE);var thisVis=d3.select(containers[0]);var found=thisVis.selectAll("text.foundText");if(found.empty())return 0;var what=found[0].length;var foundRt=thisVis.selectAll("text.rtNdText.foundText");if(foundRt.node()!=null)what--;return what};mine.clearSearch=function(){leftTree.clearSearch();
rtTree.clearSearch();return mine};mine.updateTokenExtras=function(){leftTree.showTokenExtras(showTokenExtra);rtTree.showTokenExtras(showTokenExtra);var thisVis=d3.select(containers[0]);var tokExtra=thisVis.select('.tokenExtra[display\x3d"inline"]');if(!tokExtra.empty()){var ht=tokExtra.style("height");if(ht=="0px")mine.redraw()}return mine};mine.visWidth=function(value){if(!arguments.length)return visWidth;visWidth=value;return mine};mine.visHeight=function(value){if(!arguments.length)return visHt;
visHt=value;return mine};mine.prefixesOnRight=function(value){if(!arguments.length)return prefixesOnRight;prefixesOnRight=value;return mine};mine.filters=function(value){if(!arguments.length)return filters;filters=value;return mine};mine.handlers=function(value){if(!arguments.length)return handlers;handlers=value;return mine};mine.showTokenExtra=function(value){if(!arguments.length)return showTokenExtra;showTokenExtra=value;return mine};mine.scaleLabels=function(value){if(!arguments.length)return scaleLabels;
scaleLabels=value;return mine};mine.succeeded=function(){return succeeded};mine.sortFun=function(value){if(!arguments.length)return sortFun;sortFun=value;return mine};mine.nodeText=function(value){if(!arguments.length)return nodeText;nodeText=value;return mine};mine.tokenExtraText=function(value){if(!arguments.length)return tokenExtraText;tokenExtraText=value;return mine};mine.rectColor=function(value){if(!arguments.length)return rectColor;rectColor=value;return mine};mine.rectBorderColor=function(value){if(!arguments.length)return rectBorderColor;
rectBorderColor=value;return mine};mine.continuationColor=function(value){if(!arguments.length)return continuationColor;continuationColor=value;return mine};mine.basicStyles=function(stylesObj){if(!arguments.length)return basicStyles;Object.keys(basicStyles).forEach(function(aspect){if(aspect in stylesObj)Object.keys(basicStyles[aspect]).forEach(function(attr){if(attr in stylesObj[aspect])basicStyles[aspect][attr]=stylesObj[aspect][attr]})});return mine};return mine};doubletree.Tree=function(vis,
visWidth,visHt,data,toLeft,sortFun,dispatch,textScale,showTokenXtra,nodeTextFun,tokenExtraTextFun,rectColorFun,rectBorderFun,contColorFun,baseStyles){var showTokenExtra=false||showTokenXtra;var continuationIDs={};var clickedNode;var nodeText=nodeTextFun;var tokenExtraText=tokenExtraTextFun;var rectColor=rectColorFun;var rectBorderColor=rectBorderFun;var continuationColor=contColorFun;var basicStyles=baseStyles;var margin={top:20,right:20,bottom:20,left:20},width=visWidth-margin.right-margin.left,
height=visHt-margin.top-margin.bottom,i=0,duration=200,root;var dx;if(!sortFun)sortFun=doubletree.sortByStrFld("token");var i=0;var tree=d3.tree().size([height,width]).nodeSize([40,40]);var diagonal=d3.linkHorizontal().x(function(d){return positionX(d.y)}).y(function(d){return positionY(d.x)});vis=vis.append("g").attr("transform","translate("+margin.left+","+margin.top+")");this.readJSONTree=function(json){root=d3.hierarchy(json);root.x0=0;root.y0=0;root.children.forEach(collapse);this.update(root)};
function collapse(d){if(d.children){d._children=d.children;d._children.forEach(collapse);d.children=null}}function collapseSiblings(nd){if(nd.parent)nd.parent.children.forEach(function(d){if(d!=nd)collapse(d)})}this.update=function(source){var treeData=tree(root);var nodes=treeData.descendants();var baseBranchSegmentWidth=25;nodes.forEach(function(d){var textSize=d.textSize;if(textSize==undefined){textSize=0;var parent=d.parent;while(parent!=null){var measured=Ext.draw.TextMeasurer.measureText(parent.data.name,
"arial").width;textSize+=measured;parent=parent.parent}d.textSize=textSize}d.y=d.depth*baseBranchSegmentWidth+textSize});var node=vis.selectAll("g.node_"+toLeft).data(nodes,function(d){return d.id||(d.id=++i)});var nodeEnter=node.enter().append("g").attr("class","node node_"+toLeft).attr("cursor","pointer").attr("transform",function(d){return"translate("+positionX(source.y0)+","+positionY(source.x0)+")"}).on("click",click);nodeEnter.append("title").text(function(d){var what=doubletree.infoToText(d.data.info);
return what});nodeEnter.append("circle").attr("r",1E-6).style("fill",function(d){return d._children?"#fff":basicStyles.node.fill}).style("stroke",function(d){return basicStyles.node.stroke});var txtNode=nodeEnter.append("text").attr("class",function(d){if(d.depth==0)return"rtNdText";else return""}).attr("x",function(d){if(d.children||d._children)return 0;else return toLeft?10:-10}).attr("text-anchor",function(d){if(!d.parent)return"middle";if(d.children||d._children)return toLeft?"end":"start";else return toLeft?
"start":"end"}).style("font-size",function(d){return textScale(d.data.info.count)+"pt"});txtNode.append("tspan").attr("dy",".35em").attr("class","tokenText").text(function(d){return nodeText(d.data.info,d.depth<1)}).style("fill-opacity",1E-6);txtNode.append("tspan").attr("dx",".35em").attr("class","tokenExtra").text(function(d){return tokenExtraText(d.data.info,d.depth<1)}).style("fill-opacity",1E-6);this.drawRects();var nodeUpdate=nodeEnter.merge(node);nodeUpdate.transition().duration(duration).attr("transform",
function(d){return"translate("+positionX(d.y)+","+positionY(d.x)+")"});nodeUpdate.select("circle").attr("r",function(d){return d.children||d._children?1E-6:4.5}).style("fill",function(d){return d._children?"#fff":basicStyles.node.fill}).style("stroke-width",basicStyles.node["stroke-width"]);nodeUpdate.selectAll("tspan").style("fill-opacity",1);var nodeExit=node.exit().transition().duration(duration).attr("transform",function(d){return"translate("+positionX(source.y)+","+positionY(source.x)+")"}).remove();
nodeExit.select("circle").attr("r",1E-6);nodeExit.selectAll("tspan").style("fill-opacity",1E-6);var link=vis.selectAll("path.link_"+toLeft).data(root.links(),function(d){var id=d.source.id+"-"+d.target.id;return id});var linkEnter=link.enter().insert("path","g").attr("class","link link_"+toLeft).attr("d",function(d){var o={x:source.x0,y:source.y0};return diagonal({source:o,target:o})}).style("fill","none").style("stroke",basicStyles.branch.stroke).style("stroke-width",basicStyles.branch["stroke-width"]);
var linkUpdate=linkEnter.merge(link);linkUpdate.transition().duration(duration).attr("d",diagonal);var linkExit=link.exit().transition().duration(duration).attr("d",function(d){var o={x:source.x0,y:source.y0};return diagonal({source:o,target:o})}).remove();nodes.forEach(function(d){d.x0=d.x;d.y0=d.y});this.updateContinuations()};this.drawRects=function(){var which=showTokenExtra?"inline":"none";vis.selectAll(".tokenExtra").attr("display",which);var node=vis.selectAll("g.node_"+toLeft);node.selectAll("rect").remove();
var nodeRect=node.insert("rect","text").attr("class","nodeRect").attr("height",function(){var height=this.parentElement.getBBox().height;if(height<6)height=6.1;return height-6}).attr("y",function(d){if(!d.parent)return-.5*this.parentElement.getBBox().height/2-2;else return-.5*this.parentElement.getBBox().height/2}).attr("width",function(){return this.parentElement.getBBox().width}).attr("x",function(d){var parentW=this.parentElement.getBBox().width;if(!d.parent)return-.33333*parentW;if(!toLeft)return 0;
return-.5*parentW}).style("stroke-opacity",1).style("stroke-width",1).style("stroke",function(d){return rectBorderColor(d.data.info)}).style("fill",function(d){return rectColor(d.data.info)}).style("fill-opacity",function(d){return 1})};var that=this;function click(d,i){if(d3.event.altKey){that.handleAltPress(d,i);return}if(d3.event.shiftKey){that.handleShiftPress(d,i);return}that.handleClick(d,i);if(!d.parent)return;if(that.continuationIDs!=d.data.info.ids){that.setIds(d.data.info.ids);that.clickedNode=
d.id;dispatch.call("idsUpdated",that)}collapseSiblings(d);toggleChildren(d,true)}function toggleChildren(d,update){if(d.children){if(d.children&&d.children.length==1)toggleChildren(d.children[0],true);d._children=d.children;d.children=null}else{d.children=d._children;d._children=null;if(d.children&&d.children.length==1)toggleChildren(d.children[0],false)}if(update)that.update(d)}this.setIds=function(ids){that.continuationIDs=ids};this.updateContinuations=function(){vis.selectAll("g.node_"+toLeft+
" text").classed("continuation",function(d){var isContinuation=overlap(d.data.info.ids,that.continuationIDs||{});return isContinuation}).style("fill",function(d){if(d3.select(this).classed("continuation"))return continuationColor(d.data.info);return"#444"})};this.search=function(searchRE){vis.selectAll("g.node text").classed("foundText",function(d){var what=searchRE.test(nodeText(d.data.info));return what})};this.clearSearch=function(){vis.selectAll("g.node text").classed("foundText",false)};this.showTokenExtras=
function(show){if(arguments.length==0)return showTokenExtra;showTokenExtra=show;this.drawRects();return this};this.setRectColor=function(rectColorFun){if(arguments.length==0)return rectColor;rectColor=rectColorFun;this.drawRects();return this};function positionX(x){return toLeft?-x:x}function positionY(y){return y}this.handleAltPress=function(){};this.handleShifttPress=function(){};this.handleClick=function(){};this.readJSONTree(data);return this};doubletree.sortByStrFld=function(fld){var field=fld;
return function(a,b){var aUndefined=undefined==a.data.info[field];var bUndefined=undefined==b.data.info[field];if(aUndefined&&bUndefined)return 0;else if(aUndefined)return-1;else if(bUndefined)return 1;var aVal=a.data.info[field].join(" ").toLowerCase();var bVal=b.data.info[field].join(" ").toLowerCase();if(aVal<bVal)return-1;else if(aVal>bVal)return 1;return 0}};doubletree.sortByCount=function(){return function(a,b){return b.data.info.count-a.data.info.count}};doubletree.sortByContinuations=function(){return function(a,
b){return b.data.info.continuations-a.data.info.continuations}};doubletree.filterByMinCount=function(n){return function(inf){return inf.count>=n}};doubletree.filterByMaxCount=function(n){return function(inf){return inf.count<=n}};doubletree.filterByPOS=function(pos){var re=new RegExp(pos);return function(inf){return inf["POS"]&&inf["POS"].filter(function(p){return p.search(re)>-1}).length>0}};doubletree.fieldText=function(info,fieldName){return info[fieldName]};doubletree.tokenText=function(info){var tokenText=
"";if(info.token!==undefined)tokenText=info.token;return tokenText};doubletree.infoToText=function(info){var what="";for(var infp in info)if(infp=="ids"||infp=="origIDs")what+=infp+"\t:\t"+Object.keys(info[infp]).join(",")+"\n";else what+=infp+"\t:\t"+info[infp]+"\n";return what};function old_pruneTree(tree,ids){if(!tree.children)return;var n=tree.children.length;for(var i=0;i<n;i++){var c=tree.children[i];if(containedIn(c.info.ids,ids))tree.children[i]=null;else old_pruneTree(c,ids)}tree.children=
tree.children.filter(function(c){return c!=null});var cMax=d3.max(tree.children.map(function(c){return c.maxChildren}));tree.maxChildren=Math.max(tree.children.length,cMax)}function new_pruneTree(tree,ids,copyIDs){if(!tree.children)return;if(copyIDs)if(!tree.info.origIDs){tree.info.origIDs={};addTo(tree.info.origIDs,tree.info.ids);tree.info.origCount=Object.keys(tree.info.origIDs).length}else{tree.info.ids={};addTo(tree.info.ids,tree.info.origIDs);tree.info.count=Object.keys(tree.info.ids).length}var idNums=
Object.keys(ids);for(var i=0,n=idNums.length;i<n;i++){var cid=idNums[i];delete tree.info.ids[cid]}tree.info.count=Object.keys(tree.info.ids).length;var n=tree.children.length;for(var i=0;i<n;i++){var c=tree.children[i];if(containedIn(c.info.ids,ids))tree.children[i]=null;else new_pruneTree(c,ids,false)}tree.children=tree.children.filter(function(c){return c!=null});tree.info.continuations=tree.children.length;var cMax=d3.max(tree.children.map(function(c){return c.maxChildren}));tree.maxChildren=Math.max(tree.children.length,
cMax)}function restoreTree(tree){if(tree.info.origCount){tree.info.ids={};addTo(tree.info.ids,tree.info.origIDs);tree.info.count=tree.info.origCount;var n=tree.children.length;tree.info.continuations=n;for(var i=0;i<n;i++){var c=tree.children[i];restoreTree(c)}}}function overlap(o1,o2){for(var k in o1)if(k in o2)return true;return false}function containedIn(o1,o2){if(!o1||!o2)return false;for(var k in o1)if(!(k in o2))return false;return true}function addTo(o1,o2){for(var k in o2)o1[k]=o2[k]}function noOp(){}
})();var doubletree=doubletree||{};
(function(){doubletree.Trie=function(caseSensitive,fldNames,fldDelim,distinguishingFldsArray,undistinguishedRoot){var endNG=" ";var rootName="_root_";var noCase=!caseSensitive&&true;if(!fldNames)fldNames=["item"];var fieldNames=fldNames;if(!fieldDelim)fieldDelim="\t";var fieldDelim=fldDelim;if(!distinguishingFieldsArray)distinguishingFieldsArray=[fieldNames[0]];var distinguishingFieldsArray=distinguishingFldsArray;var undistinguishedRt=undistinguishedRoot;if(undefined==undistinguishedRt)undistinguishedRt=
true;var trie=new TrieNode(rootName,-1,0);function TrieNode(item,id,count){this.id=id;this.count=count;this.info={"count":count,"ids":{}};if(item==null)this.item=rootName;else{this.item=item;this.info.ids={};this.info.ids[id]=true;var flds=item.split(fieldDelim);for(var i in flds)this.info[fieldNames[i]]=[flds[i]]}this.nodes={};this.addNgram=function(itemArray,id,count){if(!count)count=1;var thisItem,thisKey;if(itemArray.length>0){thisItem=itemArray.shift();var theseFlds=thisItem.split(fieldDelim);
if(undistinguishedRt&&this.item==rootName)thisKey="";else thisKey=theseFlds.filter(function(f,i){return distinguishingFieldsArray.indexOf(fieldNames[i])>-1}).map(function(f){if(noCase)return f.toLocaleLowerCase();return f}).join(fieldDelim)}else{thisItem=endNG;thisKey=thisItem}var subTrie;if(thisKey in this.nodes&&this.nodes[thisKey]instanceof TrieNode){subTrie=this.nodes[thisKey];subTrie.info.count+=count;subTrie.info.ids[id]=true;for(var f in theseFlds){var thisFld=theseFlds[f];if(subTrie.info[fieldNames[f]].indexOf(thisFld)==
-1)subTrie.info[fieldNames[f]].push(thisFld)}}else{subTrie=new TrieNode(thisItem,id,count);this.nodes[thisKey]=subTrie}if(thisItem!=endNG)subTrie.addNgram(itemArray,id,count)};this.getUniqRoot=function(){if(this.item==rootName){var children=Object.keys(this.nodes);if(children.length==1)return this.nodes[children[0]]}return this};this.toTree=function(filterFuns){function toTreeHelper(filterFuns,descendentLevel,trieData){var what={"children":[]};what.name=trieData.item;what.info={};for(var k in trieData.info)if(typeof trieData.info[k]===
"Object"){what.info[k]={};for(var k2 in trieData.info[k])what.info[k][k2]=this.info[k][k2]}else what.info[k]=trieData.info[k];what.pruned={};for(var item in trieData.nodes){var itemNode=trieData.nodes[item];var thisFilter=filterFuns[descendentLevel];if(!thisFilter||thisFilter&&thisFilter(itemNode.info)){what.children.push(toTreeHelper(filterFuns,descendentLevel+1,itemNode));if(itemNode.pruned!={})addTo(what.pruned,itemNode.pruned)}else addTo(what.pruned,itemNode.info.ids)}what.info.continuations=
what.children.length;if(what.children.length==0){what.children=null;what.maxChildren=0;if(what.name)what.maxLen=what.name.length;else what.maxLen=0;what.minCount=what.info.count}else{var cMax=d3.max(what.children.map(function(c){return c.maxChildren}));what.maxChildren=Math.max(what.children.length,cMax);var maxLen=d3.max(what.children.map(function(c){return c.maxLen}));what.maxLen=Math.max(maxLen,what.name.length);what.minCount=d3.min(what.children.map(function(c){return c.minCount}))}return what}
if(!filterFuns)filterFuns=[];var trieData=JSON.parse(JSON.stringify(this));return toTreeHelper(filterFuns,0,trieData)}}this.addNgram=function(itemArray,id,count){trie.addNgram(itemArray,id,count)};this.getUniqRoot=function(){var what=new doubletree.Trie(!noCase,fieldNames,fieldDelim,distinguishingFieldsArray);what.trie(trie.getUniqRoot());return what};this.toTree=function(filterFuns,descendentLevel){return trie.toTree(filterFuns,descendentLevel)};this.serialize=function(){return JSON.stringify(this)};
this.deserialize=function(serialized){var obj=JSON.parse(serialized);endNG=obj.endNG();rootName=obj.rootName();noCase=obj.caseSensitive();fieldNames=obj.fieldNames();fieldDelim=obj.fieldDelim();distinguishingFieldsArray=obj.distinguishingFieldsArray();trie=obj.trie()};this.endNG=function(){return endNG};this.rootName=function(){return rootName};this.trie=function(value){if(arguments.length>0)trie=value;return trie};this.caseSensitive=function(){return!noCase};this.fieldNames=function(){return fieldNames};
this.fieldDelim=function(){return fieldDelim};this.distinguishingFieldsArray=function(){return distinguishingFieldsArray};function addTo(o1,o2){for(var k in o2)o1[k]=o2[k]}}})();function TermsRadio(config){this.parent=config.parent;this.container=config.container;this.isSliderVisible=config.showSlider==undefined?true:config.showSlider;this.chart=null;this.absMaxFreq=0;this.absMinFreq=0;this.allData=[];this.continueTransition=true;this.counterSeries=[];this.displayData=[];this.dragged=false;this.isTransitioning=false;this.lastSlippery=null;this.lastSticky=null;this.maxFont=30;this.minFreq=0;this.numDataPoints=0;this.numVisPoints=5;this.overlayQueue=[];this.records=0;this.recordsLength=
0;this.reselectTop=false;this.shiftCount=0;this.sliderDragSum=0;this.titlesArray=[];this.transitionCall="draw";this.valFraction=1;this.win=0;this.bPadding=25;this.lPadding=40;this.rPadding=20;this.tPadding=10;this.sliderHeightRatio=.1;this.sliderHeight=0;this.sliderBPadding=10;this.largestW=0;this.largestH=0;this.xAxisEl=undefined;this.xAxis=d3.axisBottom();this.xScale=d3.scaleLinear();this.xSliderScale=d3.scaleLinear();this.yAxisEl=undefined;this.yAxis=d3.axisLeft();this.yScale=d3.scaleLinear();
this.ySliderScale=d3.scaleLinear();this.fontScale=d3.scaleLinear();this.opacityScale=d3.scaleLinear();this.container.on("resize",this.doResize,this)}
TermsRadio.prototype={constructor:TermsRadio,loadRecords:function(records){this.initData(records);this.prepareData();var len=this.shiftCount;while(len-- >0)this.displayData.shift();if(this.chart!=null)this.redraw();else this.initializeChart()},highlightQuery:function(query,sticky){var docId=null;if(this.parent.getApiParam("mode")==="document")docId=this.parent.getCorpus().getDocument(0).getId();var info={wordString:query,docId:docId};var paramsBundle=this.buildParamsBundle(info);if(sticky)this.manageOverlaySticky(paramsBundle);
else this.manageOverlaySlippery(paramsBundle)},highlightRecord:function(record,sticky){var info={wordString:record.get("term"),docId:record.get("docId")};var paramsBundle=this.buildParamsBundle(info);if(sticky)this.manageOverlaySticky(paramsBundle);else this.manageOverlaySlippery(paramsBundle)},initData:function(records){this.records=records;this.recordsLength=this.records.length;this.numVisPoints=parseInt(this.parent.getApiParam("visibleBins"));this.shiftCount=parseInt(this.parent.getApiParam("position"));
if(this.parent.getApiParam("mode")==="document"){this.numDataPoints=this.records[0].get("distributions").length;var parentBins=parseInt(this.parent.getApiParam("bins"));if(this.numDataPoints!==parentBins){this.numDataPoints=parentBins;this.loadStore()}}else this.numDataPoints=this.records[0].get("distributions").length;this.counterSeries=[];var transferArray=[];this.absMaxFreq=0;for(var k=0;k<this.numDataPoints;k++)for(var p=0;p<this.recordsLength;p++)if(this.records[p].get("distributions")[k]>this.absMaxFreq)this.absMaxFreq=
this.records[p].get("distributions")[k];this.absMinFreq=this.absMaxFreq;for(var k=0;k<this.numDataPoints;k++)for(var p=0;p<this.recordsLength;p++)if(this.records[p].get("distributions")[k]<=this.absMinFreq&&this.records[p].get("distributions")[k]!==0)this.absMinFreq=this.records[p].get("distributions")[k];if(this.absMinFreq<0)this.absMinFreq=0;this.minFreq=this.absMinFreq*1.01;for(var k=0;k<this.numDataPoints;k++){for(var p=0;p<this.recordsLength;p++){var rec=this.records[p];var dists=rec.get("distributions")[k];
if(dists>0)transferArray.push({freq:dists,wordString:rec.get("term"),counter:k,posInSeries:0,numInSeries:0,docId:rec.get("docId")})}this.counterSeries.push(transferArray);transferArray=[]}},prepareData:function(){var frequencySeries=[],copy1=[],copy2=[],copy3=[],copy4=[],check=0;this.allData=[];this.displayData=[];if(this.numDataPoints<this.numVisPoints)this.numVisPoints=this.numDataPoints;if(this.shiftCount+this.numVisPoints>this.numDataPoints)this.shiftCount=this.numDataPoints-this.numVisPoints;
for(var k=0;k<this.numDataPoints;k++){var check1=0;for(var p=0;p<this.counterSeries[k].length;p++){var check2=0;if(check1===0){copy1.push(this.counterSeries[k][p]);copy2.push({freq:this.counterSeries[k][p].freq,frequencyArray:copy1,numInSeries:0});frequencySeries.push(copy2);copy1=[];copy2=[];check1=1;check2=1}for(var l=0;l<frequencySeries[k].length&&check2===0;l++)if(this.counterSeries[k][p].freq===frequencySeries[k][l].freq){var inSeries=0;inSeries=frequencySeries[k][l].numInSeries;this.counterSeries[k][p].posInSeries=
++inSeries;frequencySeries[k][l].numInSeries=inSeries;frequencySeries[k][l].frequencyArray.push(this.counterSeries[k][p]);check2=1}if(check2===0){copy4.push(this.counterSeries[k][p]);frequencySeries[k].push({freq:this.counterSeries[k][p].freq,frequencyArray:copy4,numInSeries:0});copy4=[];check2=1}}if(this.counterSeries[k].length<1||check1===0)frequencySeries.push([])}for(var k=0;k<this.numDataPoints;k++)for(var p=0;p<frequencySeries[k].length;p++){++frequencySeries[k][p].numInSeries;for(var l=0;l<
frequencySeries[k][p].frequencyArray.length;l++)frequencySeries[k][p].frequencyArray[l].numInSeries=frequencySeries[k][p].numInSeries}var allDataSetup=[];for(var k=0;k<this.numDataPoints;k++)this.allData.push({allDataInternal:frequencySeries[k],outerCounter:k});var displaySetup=[],transferArray=[];for(var k=0;k<this.numVisPoints+this.shiftCount;k++){for(var p=0;p<this.recordsLength;p++)if(this.allData[k].allDataInternal[p])transferArray.push({freq:this.allData[k].allDataInternal[p].freq,inSeries:this.allData[k].allDataInternal[p].numInSeries,
frequencyArray:this.allData[k].allDataInternal[p].frequencyArray,dotObject:[{counter:k,freq:this.allData[k].allDataInternal[p].freq}]});displaySetup.push(transferArray);transferArray=[]}for(var k=0;k<this.numVisPoints+this.shiftCount;k++)this.displayData.push({displayInternal:displaySetup[k],outerCounter:k});displaySetup=[]},manageMvtButtons:function(){this.parent.queryById("play").setPlaying(this.isTransitioning)},nextR:function(){var displaySetup=[];for(var p=0;p<this.recordsLength;p++)if(this.allData[this.numVisPoints+
this.shiftCount].allDataInternal[p])displaySetup.push({freq:this.allData[this.numVisPoints+this.shiftCount].allDataInternal[p].freq,inSeries:this.allData[this.numVisPoints+this.shiftCount].allDataInternal[p].numInSeries,frequencyArray:this.allData[this.numVisPoints+this.shiftCount].allDataInternal[p].frequencyArray,dotObject:[{counter:this.numVisPoints+this.shiftCount,freq:this.allData[this.numVisPoints+this.shiftCount].allDataInternal[p].freq}]});this.displayData.push({displayInternal:displaySetup,
outerCounter:this.numVisPoints+this.shiftCount});displaySetup=[]},toggleRightCheck:function(){if(this.numVisPoints+this.shiftCount<this.numDataPoints){this.isTransitioning=true;this.continueTransition=true;this.manageMvtButtons();this.nextR();this.shiftCount=++this.shiftCount;this.manageXScale();this.parent.setApiParams({position:this.shiftCount});this.transitionCall="right";this.animateVis();this.displayData.shift()}else{this.isTransitioning=false;this.continueTransition=false;this.manageMvtButtons()}},
nextL:function(){var displaySetup=[];for(var p=0;p<this.recordsLength;p++)if(this.allData[this.shiftCount].allDataInternal[p])displaySetup.push({freq:this.allData[this.shiftCount].allDataInternal[p].freq,inSeries:this.allData[this.shiftCount].allDataInternal[p].numInSeries,frequencyArray:this.allData[this.shiftCount].allDataInternal[p].frequencyArray,dotObject:[{counter:this.shiftCount,freq:this.allData[this.shiftCount].allDataInternal[p].freq}]});this.displayData.unshift({displayInternal:displaySetup,
outerCounter:this.shiftCount});displaySetup=[]},startScroll:function(){var me=this;if(me.numDataPoints>me.numVisPoints&&me.shiftCount===0){me.isTransitioning=true;this.manageMvtButtons();setTimeout(function(){me.toggleRightCheck()},3E3)}},initializeChart:function(){this.initChart();this.drawXAxis();this.drawYAxis();this.drawChart();if(this.isSliderVisible){this.drawSlider();this.drawVerticalSlider();this.redrawSliderOverlay()}this.transitionCall="draw"},redraw:function(){this.transitionCall="redraw";
this.updateFullPath();this.redrawXAxis();this.redrawYAxis();this.redrawChart();if(this.isSliderVisible){this.redrawSlider();this.redrawVerticalSlider();this.redrawSliderOverlay()}this.redrawChartOverlay()},initChart:function(){var h=this.container.getHeight(),w=this.container.getWidth();var chartSVG=Ext.DomHelper.append(this.container.down("div[class$\x3dinnerCt]"),'\x3csvg class\x3d"chart" width\x3d"'+w+'" height\x3d"'+h+'"\x3e\x3c/svg\x3e');this.chart=d3.select(chartSVG);this.setSliderHeight();
this.largestW=w;this.largestH=h-this.getSliderHeight();var y=this.tPadding+this.getSliderHeight();this.chart.append("clipPath").attr("id","clip1").append("rect").attr("class","clipping-rectangle").attr("x",0).attr("y",y).attr("width",w).attr("height",this.largestH);this.chart.append("g").attr("class","overlay").attr("clip-path","url(#clip1)");this.setTitleLength()},doResize:function(){if(this.chart){var h=this.container.getHeight(),w=this.container.getWidth();this.setSliderHeight();this.largestH=
h-this.getSliderHeight();this.largestW=w;this.chart.attr("height",h).attr("width",w);this.setTitleLength();this.chart.select("rect[class\x3dclipping-rectangle]").attr("x",0).attr("y",this.tPadding+this.getSliderHeight()).attr("width",w).attr("height",this.largestH);this.redraw()}},drawXAxis:function(){var me=this;var h=this.container.getHeight(),w=this.container.getWidth();this.manageAllXScales();this.xAxis=d3.axisBottom(me.xScale).ticks(Math.round(me.numVisPoints)).tickFormat(function(d){var val;
if(me.parent.getApiParam("mode")==="document")val="Segment "+(parseInt(d)+1);if(me.parent.getApiParam("mode")==="corpus")val=d+1+". "+me.titlesArray[d];return val});this.xAxisEl=this.chart.append("g").attr("class","axisX").attr("transform","translate(0,"+(h-this.bPadding)+")").call(this.xAxis);this.styleXAxis()},styleXAxis:function(){this.xAxisEl.selectAll("text").style("font-family","sans-serif").style("font-size","11px");this.xAxisEl.selectAll("line").style("fill","none").style("stroke","black").style("shape-rendering",
"crispEdges");this.xAxisEl.selectAll("path").style("fill","none").style("stroke","black").style("shape-rendering","crispEdges")},redrawXAxis:function(){this.chart.selectAll("g[class\x3daxisX]").remove();this.drawXAxis()},drawYAxis:function(){var me=this;var h=this.container.getHeight(),w=this.container.getWidth();this.manageAllYScales();var yTicksScale=d3.scaleLinear().domain([200,700]).range([5,15]);var numberFormat=d3.format(".2r");function logFormat(d){var x=Math.log(d)/Math.log(10)+1E-6;return Math.abs(x-
Math.floor(x))<.7?numberFormat(d):""}this.yAxis=d3.axisLeft(me.yScale).ticks(yTicksScale(h)).tickFormat(logFormat).tickSize(-w+this.rPadding+this.lPadding);this.yAxisEl=this.chart.append("g").attr("class","axisY").attr("transform","translate("+this.lPadding+",0)").call(this.yAxis);this.yAxisEl.selectAll("text").style("font-family","sans-serif").style("font-size","11px");this.yAxisEl.selectAll("line").style("fill","none").style("stroke","black").style("shape-rendering","crispEdges").style("stroke-opacity",
.05);this.yAxisEl.selectAll("path").style("fill","none").style("stroke","black").style("shape-rendering","crispEdges")},redrawYAxis:function(){this.chart.selectAll("g[class\x3daxisY]").remove();this.drawYAxis()},drawChart:function(){var me=this;var counterSeriesDiv=this.chart.selectAll("g[class\x3dsection]").data(me.displayData,function(d){return d.outerCounter}).enter().append("g").attr("class","section").attr("clip-path","url(#clip1)");var frequencySeriesDiv=counterSeriesDiv.selectAll("g").data(function(d){return d.displayInternal}).enter().append("g").attr("class",
"frequencies").on("mouseover",function(){d3.select(this).style("fill","red")}).on("mouseout",function(){d3.select(this).style("fill","black")});var dataPoint=frequencySeriesDiv.selectAll("text").data(function(d){return d.frequencyArray}).enter().append("text").attr("class",function(d){return me.removeFilteredCharacters(d.wordString)}).attr("x",function(d){var startPoint=.5/d.numInSeries-.5,valueRange=d.posInSeries/d.numInSeries*.8,x=d.counter+me.callOffset()+startPoint+valueRange;return me.xScale(x)}).attr("y",
function(d){var y=d.freq;return me.yScale(y)}).attr("text-anchor","middle").attr("transform",function(d){var startPoint=.5/d.numInSeries-.5,valueRange=d.posInSeries/d.numInSeries*.8,x=d.counter+me.callOffset()+startPoint+valueRange,y=d.freq;return"translate(0, 0) rotate(-20 "+me.xScale(x)+" "+me.yScale(y)+")"}).style("font-size",function(d){return me.fontScale(d.freq)+"px"}).style("fill-opacity",function(d){return me.opacityScale(d.freq)}).text(function(d){return d.wordString}).on("mouseover",function(d){d3.select(this).style("cursor",
"pointer").style("font-size",function(d){return me.fontScale(d.freq)*me.maxFont/me.fontScale(d.freq)+"px"});var paramsBundle=me.buildParamsBundle(d);me.manageOverlaySlippery(paramsBundle)}).on("mouseout",function(d){d3.select(this).style("cursor","auto").style("font-size",function(d){return me.fontScale(d.freq)+"px"});var paramsBundle=me.buildParamsBundle(d);me.manageOverlaySlippery(paramsBundle)}).on("click",function(d){var paramsBundle=me.buildParamsBundle(d);me.manageOverlaySticky(paramsBundle)}).append("title").text(function(d){return d.wordString})},
redrawChart:function(){this.chart.selectAll("g[class\x3dsection]").remove();this.drawChart()},drawVerticalSlider:function(){},redrawVerticalSlider:function(){this.chart.selectAll("rect[class\x3dminimap]").remove();this.drawVerticalSlider()},drawSlider:function(){var h=this.container.getHeight(),w=this.container.getWidth();var lengthHor=w-(this.rPadding+this.lPadding),offsetVis=this.lPadding+lengthHor*((this.numVisPoints-1)/2)*(1/(this.numDataPoints-1)),offsetVisStart=this.lPadding,offsetVisEnd=this.lPadding+
lengthHor*((this.numVisPoints-1)/(this.numDataPoints-1));var lineX=this.chart.append("line").attr("class","slider axis").attr("x1",this.lPadding).attr("x2",this.container.getWidth()-this.rPadding).attr("y1",this.tPadding+this.sliderHeight).attr("y2",this.tPadding+this.sliderHeight).style("shape-rendering","crispEdges").style("stroke","black").style("stroke-width","1");var lineY=this.chart.append("line").attr("class","slider axis").attr("x1",this.lPadding).attr("x2",this.lPadding).attr("y1",this.tPadding+
this.sliderHeight).attr("y2",this.tPadding).style("shape-rendering","crispEdges").style("stroke","black").style("stroke-width","1");var sliderHorStart=this.chart.append("line").attr("class","slider").attr("id","before").attr("x1",lengthHor*(this.shiftCount-this.callOffset())/(this.numDataPoints-1)+offsetVisStart).attr("x2",lengthHor*(this.shiftCount-this.callOffset())/(this.numDataPoints-1)+offsetVisStart).attr("y1",this.tPadding+this.sliderHeight).attr("y2",this.tPadding).style("stroke","black").style("stroke-width",
"1");var sliderHorEnd=this.chart.append("line").attr("class","slider").attr("id","after").attr("x1",lengthHor*(this.shiftCount-this.callOffset())/(this.numDataPoints-1)+offsetVisEnd).attr("x2",lengthHor*(this.shiftCount-this.callOffset())/(this.numDataPoints-1)+offsetVisEnd).attr("y1",this.tPadding+this.sliderHeight).attr("y2",this.tPadding).style("stroke","black").style("stroke-width","1");var greyBoxBefore=this.chart.append("rect").attr("class","slider").attr("id","boxBefore").attr("x",this.lPadding).attr("y",
this.tPadding).attr("height",this.sliderHeight).attr("width",lengthHor*(this.shiftCount-this.callOffset())/(this.numDataPoints-1)).style("fill","silver").style("fill-opacity",.25).style("cursor","move");var greyBoxAfter=this.chart.append("rect").attr("class","slider").attr("id","boxAfter").attr("x",lengthHor*(this.shiftCount-this.callOffset())/(this.numDataPoints-1)+offsetVisEnd).attr("y",this.tPadding).attr("height",this.sliderHeight).attr("width",lengthHor*(this.numDataPoints-this.numVisPoints-
this.shiftCount+this.callOffset())/(this.numDataPoints-1)).style("fill","silver").style("fill-opacity",.25).style("cursor","move");var me=this;var drag=d3.drag().on("drag",function(d){if(!me.isTransitioning){this.drag=true;var w=me.parent.getWidth(),displaceX=parseInt(d3.event.dx),checkBefore,checkAfter,pos=0;me.sliderDragSum+=d3.event.dx;me.chart.selectAll("#before").attr("x1",function(){checkBefore=parseInt(this.getAttribute("x1"));pos=parseInt(this.getAttribute("x1"))+displaceX;return parseInt(this.getAttribute("x1"))});
me.chart.selectAll("#after").attr("x1",function(){checkAfter=parseInt(this.getAttribute("x1"));return parseInt(this.getAttribute("x1"))});if(checkBefore+displaceX<me.lPadding||checkAfter+displaceX>w-me.rPadding)displaceX=0;me.chart.select("#boxBefore").attr("width",function(){return parseInt(this.getAttribute("width"))+displaceX});me.chart.select("#boxAfter").attr("x",function(){return parseInt(this.getAttribute("x"))+displaceX}).attr("width",function(){return Math.max(0,parseInt(this.getAttribute("width"))-
displaceX)});me.chart.selectAll("#before").attr("x1",function(){return parseInt(this.getAttribute("x1"))+displaceX}).attr("x2",function(){return parseInt(this.getAttribute("x2"))+displaceX});me.chart.selectAll("#after").attr("x1",function(){return parseInt(this.getAttribute("x1"))+displaceX}).attr("x2",function(){return parseInt(this.getAttribute("x2"))+displaceX})}}).on("end",function(d){if(this.drag){this.drag=false;var inverseSliderScale=d3.scaleLinear().domain([0,me.container.getWidth()-(me.lPadding+
me.rPadding)]).range([0,me.numDataPoints]);var moveByThis=inverseSliderScale(me.sliderDragSum),moveShiftCount,oldShiftCount=me.shiftCount;if(moveByThis>0)moveShiftCount=Math.floor(moveByThis);if(moveByThis<0)moveShiftCount=Math.ceil(moveByThis);me.shiftCount+=moveShiftCount;if(me.shiftCount<0)me.shiftCount=0;if(me.shiftCount>me.numDataPoints-1)me.shiftCount=me.numDataPoints-1;if(me.shiftCount!==oldShiftCount){me.sliderDragSum=0;me.parent.setApiParams({position:me.shiftCount});me.prepareData();me.redraw()}}});
greyBoxBefore.call(drag);greyBoxAfter.call(drag)},removeSlider:function(removeTermLines){this.chart.selectAll("rect[class\x3dslider]").remove();this.chart.selectAll("line[class~\x3dslider]").remove();if(removeTermLines)this.chart.selectAll("g[class\x3dslider]").remove()},redrawSlider:function(){this.removeSlider();this.drawSlider()},animateVis:function(){var me=this;var mode=this.parent.getApiParam("mode");var h=this.container.getHeight(),w=this.container.getWidth();var duration=this.getDuration();
if(this.transitionCall==="left"||this.transitionCall==="right"){this.xAxisEl.transition().duration(duration).ease(d3.easeLinear).call(this.xAxis);this.styleXAxis();this.drawChart();this.chart.selectAll(".frequencies").transition().duration(duration).ease(d3.easeLinear).selectAll("text").attr("x",function(d){var startPoint=.5/d.numInSeries-.5,valueRange=d.posInSeries/d.numInSeries*.8,x=d.counter+startPoint+valueRange;return me.xScale(x)}).attr("transform",function(d){var startPoint=.5/d.numInSeries-
.5,valueRange=d.posInSeries/d.numInSeries*.8,x=d.counter+startPoint+valueRange,y=d.freq;return"translate(0, 0) rotate(-20 "+me.xScale(x)+" "+me.yScale(y)+")"});var lengthHor=w-(this.rPadding+this.lPadding),offsetVis=this.lPadding+lengthHor*((this.numVisPoints-1)/2)*(1/(this.numDataPoints-1)),offsetVisStart=this.lPadding,offsetVisEnd=this.lPadding+lengthHor*((this.numVisPoints-1)/(this.numDataPoints-1));this.chart.select("#before").transition().duration(duration).ease(d3.easeLinear).attr("x1",lengthHor*
this.shiftCount/(this.numDataPoints-1)+offsetVisStart).attr("x2",lengthHor*this.shiftCount/(this.numDataPoints-1)+offsetVisStart).attr("y1",this.tPadding+this.getSliderHeight()).attr("y2",this.tPadding).on("end",function(){if(me.parent.isMasked())me.parent.unmask();if(me.continueTransition)setTimeout(function(){me.callTransition()},50);else{me.isTransitioning=false;me.manageMvtButtons()}});this.chart.select("#after").transition().duration(duration).ease(d3.easeLinear).attr("x1",lengthHor*this.shiftCount/
(this.numDataPoints-1)+offsetVisEnd).attr("x2",lengthHor*this.shiftCount/(this.numDataPoints-1)+offsetVisEnd).attr("y1",this.tPadding+this.getSliderHeight()).attr("y2",this.tPadding);this.chart.select("#boxBefore").transition().duration(duration).ease(d3.easeLinear).attr("x",this.lPadding).attr("y",this.tPadding).attr("height",this.getSliderHeight()).attr("width",lengthHor*this.shiftCount/(this.numDataPoints-1));this.chart.select("#boxAfter").transition().duration(duration).ease(d3.easeLinear).attr("x",
lengthHor*this.shiftCount/(this.numDataPoints-1)+offsetVisEnd).attr("y",this.tPadding).attr("height",this.getSliderHeight()).attr("width",lengthHor*(this.numDataPoints-this.numVisPoints-this.shiftCount)/(this.numDataPoints-1))}this.redrawChartOverlay()},callTransition:function(){if(this.transitionCall==="left")this.toggleLeftCheck();if(this.transitionCall==="right")this.toggleRightCheck()},buildParamsBundle:function(info){var type=info.wordString,params={},paramsBundle={},docId;if(this.parent.getApiParam("mode")===
"document"){docId=info.docId;var totalTokens=this.parent.getCorpus().getDocument(docId).get("totalTokens")-1;params.tokenIdStart=parseInt(this.category*totalTokens/this.numDataPoints);params.docIdType=docId+":"+type}else;paramsBundle={params:params,type:type};return paramsBundle},manageOverlaySlippery:function(paramsBundle){var string=paramsBundle.type,selector=this.removeFilteredCharacters(paramsBundle.type),checkOn="on",index;var len=this.overlayQueue.length;while(--len>=0)if(selector===this.overlayQueue[len].selector){checkOn=
"off";index=len}if(selector===this.lastSticky){checkOn="off";this.lastSticky=null}if(checkOn==="on")if(selector!==this.lastSlippery){var pathHolder=this.prepareFullPath(string);var lineObject={word:string,selector:selector,params:paramsBundle,fullPath:pathHolder.path,pathMin:pathHolder.min,pathMax:pathHolder.max,colour:"red"};if(this.lastSlippery!==null){this.chartOverlayOff(this.lastSlippery);if(this.isSliderVisible)this.sliderOverlayOff(this.lastSlippery);this.lastSlippery=null;this.chartOverlayOn(lineObject);
if(this.isSliderVisible)this.sliderOverlayOn(lineObject);this.lastSlippery=selector}else{this.chartOverlayOn(lineObject);if(this.isSliderVisible)this.sliderOverlayOn(lineObject);this.lastSlippery=selector}}else{this.chartOverlayOff(selector);if(this.isSliderVisible)this.sliderOverlayOff(this.lastSlippery);this.lastSlippery=null}else;},manageOverlaySticky:function(paramsBundle){var me=this;var term=paramsBundle.type;this.transitionCall="draw";if(!this.isTermSelected(term))this.doTermSelect(term,true);
else this.doTermDeselect(term,true)},getTermIndex:function(term){var index=-1;var selector=selector=this.removeFilteredCharacters(term);var len=this.overlayQueue.length;while(--len>=0)if(selector===this.overlayQueue[len].selector)index=len;return index},isTermSelected:function(term){return this.getTermIndex(term)!==-1},doTermSelect:function(term,legendAdd){var selector=selector=this.removeFilteredCharacters(term);var apiArray=this.parent.getApiParam("selectedWords");apiArray.push(term);this.parent.setApiParams({selectedWords:apiArray});
var color=this.parent.getApplication().getColorForTerm(term,true);if(legendAdd===true){var legend=this.parent.query("[xtype\x3dlegend]")[0];legend.getStore().add({name:term,mark:color})}else{var legend=this.parent.query("[xtype\x3dlegend]")[0];var record=legend.getStore().findRecord("name",term);if(record!==null){record.set("mark",color);legend.refresh()}}var pathHolder=this.prepareFullPath(term);var lineObject={word:term,selector:selector,params:{params:{},type:term},fullPath:pathHolder.path,pathMin:pathHolder.min,
pathMax:pathHolder.max,colour:color};if(selector===this.lastSlippery){if(this.isSliderVisible)this.sliderOverlayOff(selector);this.lastSlippery=null}this.chart.select("g[class\x3dfrequency-line-"+selector.replace(/'/g,"\\'")+"]").remove();this.overlayQueue.push(lineObject);this.chartOverlayOn(lineObject);if(this.isSliderVisible)this.sliderOverlayOn(lineObject)},doTermDeselect:function(term,legendRemove){var selector=this.removeFilteredCharacters(term);var index=this.getTermIndex(term);if(legendRemove===
true){var legend=this.parent.query("[xtype\x3dlegend]")[0];var index=legend.getStore().findExact("name",term);legend.getStore().removeAt(index)}var updateApi=this.parent.getApiParam("selectedWords");for(var i=0,len=updateApi.length;i<len;i++)if(updateApi[i]===selector){updateApi.splice(i,1);this.parent.setApiParams({selectedWords:updateApi})}this.chartOverlayOff(selector);this.overlayQueue.splice(index,1);if(this.isSliderVisible)this.sliderOverlayOff(selector);this.lastSticky=selector},prepareFullPath:function(string){var linePosArray=
[],pathMin=this.absMaxFreq,pathMax=this.absMinFreq;for(var k=0,len=this.allData.length;k<len;k++){foundB=0;for(var i=0,lenA=this.allData[k].allDataInternal.length;i<lenA;i++)for(var j=0,lenB=this.allData[k].allDataInternal[i].frequencyArray.length;j<lenB;j++)if(this.allData[k].allDataInternal[i].frequencyArray[j].wordString===string){var yVal1=this.allData[k].allDataInternal[i].frequencyArray[j].freq;linePosArray.push({x:k,y:yVal1});if(yVal1<pathMin)pathMin=yVal1;if(yVal1>pathMax)pathMax=yVal1;foundB=
1}if(foundB===0){var yVal2=this.minFreq;linePosArray.push({x:k,y:yVal2});if(yVal2<pathMin)pathMin=yVal2;if(yVal2>pathMax)pathMax=yVal2}}return{path:linePosArray,min:pathMin,max:pathMax}},updateFullPath:function(){var lenA=this.overlayQueue.length;while(lenA-- >0){var pathHolder=this.prepareFullPath(this.overlayQueue[lenA].word);this.overlayQueue[lenA].fullPath=pathHolder.path;this.overlayQueue[lenA].pathMin=pathHolder.min;this.overlayQueue[lenA].pathMax=pathHolder.max}},buildSliderPath:function(pathArray){var me=
this;var line=d3.line().x(function(d){return me.xSliderScale(d.x)}).y(function(d){return me.ySliderScale(d.y)}).curve(d3.curveNatural);return line(pathArray)},sliderOverlayOn:function(objectToSelect){this.transitionSliderOverlay(objectToSelect);this.chart.append("g").attr("class","slider").attr("id","slider-line-"+objectToSelect.word).append("path").attr("d",this.buildSliderPath(objectToSelect.fullPath)).style("stroke",objectToSelect.colour).style("stroke-width",2).style("fill","none");this.redrawSlider()},
sliderOverlayOff:function(selector){this.chart.selectAll("g[id\x3dslider-line-"+selector.replace(/'/g,"\\'")+"]").remove();this.transitionSliderOverlay()},redrawSliderOverlay:function(){for(var l=0;l<this.overlayQueue.length;l++){this.sliderOverlayOff(this.overlayQueue[l].selector);this.sliderOverlayOn(this.overlayQueue[l])}},transitionSliderOverlay:function(objectToSelect){objectToSelect=objectToSelect||0;this.updateYSliderScale(objectToSelect);var lenA=this.overlayQueue.length;while(lenA-- >0)this.chart.selectAll("g#slider-line-"+
this.overlayQueue[lenA].selector.replace(/'/g,"\\'")).select("path").transition().duration(300).ease(d3.easeLinear).attr("d",this.buildSliderPath(this.overlayQueue[lenA].fullPath))},preparePath:function(string){var linePosArray=[];var foundA,foundB,foundC;for(var k=0;k<3&&this.shiftCount-k>0;k++){foundA=0;for(var i=0;i<this.allData[this.shiftCount-(1+k)].allDataInternal.length;i++)for(var j=0;j<this.allData[this.shiftCount-(1+k)].allDataInternal[i].frequencyArray.length;j++)if(this.allData[this.shiftCount-
(1+k)].allDataInternal[i].frequencyArray[j].wordString===string){var yVal3=this.yScale(this.allData[this.shiftCount-(1+k)].allDataInternal[i].frequencyArray[j].freq);linePosArray.unshift({x:this.shiftCount-(1+k),y:yVal3});foundA=1}if(foundA===0){var yVal4=this.yScale(this.minFreq);linePosArray.unshift({x:this.shiftCount-(1+k),y:yVal4})}}for(var k=this.shiftCount,len=this.numVisPoints+this.shiftCount;k<len;k++){foundB=0;for(var i=0,lenA=this.allData[k].allDataInternal.length;i<lenA;i++)for(var j=0,
lenB=this.allData[k].allDataInternal[i].frequencyArray.length;j<lenB;j++)if(this.allData[k].allDataInternal[i].frequencyArray[j].wordString===string){var yVal1=this.yScale(this.allData[k].allDataInternal[i].frequencyArray[j].freq);linePosArray.push({x:k,y:yVal1});foundB=1}if(foundB===0){var yVal2=this.yScale(this.minFreq);linePosArray.push({x:k,y:yVal2})}}for(var k=0;k<3&&this.numVisPoints+this.shiftCount+k<this.numDataPoints;k++){foundC=0;for(var i=0;i<this.allData[this.numVisPoints+this.shiftCount+
k].allDataInternal.length;i++)for(var j=0;j<this.allData[this.numVisPoints+this.shiftCount+k].allDataInternal[i].frequencyArray.length;j++)if(this.allData[this.numVisPoints+this.shiftCount+k].allDataInternal[i].frequencyArray[j].wordString===string){var yVal1=this.yScale(this.allData[this.numVisPoints+this.shiftCount+k].allDataInternal[i].frequencyArray[j].freq);linePosArray.push({x:this.numVisPoints+this.shiftCount+k,y:yVal1});foundC=1}if(foundC===0){var yVal2=this.yScale(this.minFreq);linePosArray.push({x:this.numVisPoints+
this.shiftCount+k,y:yVal2})}}return linePosArray},chartOverlayOn:function(objectToSelect){var me=this;this.chart.selectAll("g[class\x3dsection]").selectAll("g[class\x3dfrequencies]").selectAll("text[class\x3d"+objectToSelect.selector.replace(/'/g,"\\'")+"]").style("fill",objectToSelect.colour).style("fill-opacity",1);var linePosArray=this.preparePath(objectToSelect.word);var pos;var line=d3.line().x(function(d){pos=d.x;return me.xScale(d.x+me.callOffset())}).y(function(d){return d.y}).curve(d3.curveNatural);
var path=this.chart.select(".overlay").append("g").attr("class","frequency-line-"+objectToSelect.selector).append("path").attr("d",line(linePosArray)).style("stroke",objectToSelect.colour).style("stroke-width",2).style("fill","none");var posDif=this.xScale(pos)-this.xScale(pos+this.callOffset());if(this.transitionCall==="left"||this.transitionCall==="right")path.transition().duration(me.getDuration()).ease(d3.easeLinear).attr("transform","translate("+posDif+")")},chartOverlayOff:function(selector){var me=
this;this.chart.selectAll("text."+selector.replace(/'/g,"\\'")).style("fill","black").style("fill-opacity",function(d){return me.opacityScale(d.freq)});this.chart.select("g.frequency-line-"+selector.replace(/'/g,"\\'")).remove()},redrawChartOverlay:function(){for(var i=0;i<this.overlayQueue.length;i++){this.chartOverlayOff(this.overlayQueue[i].selector);this.chartOverlayOn(this.overlayQueue[i])}},manageAllYScales:function(){this.manageFontScale();this.manageOpacityScale();this.manageYScale();this.manageYSliderScale()},
manageFontScale:function(){this.fontScale.domain([this.minFreq,this.absMaxFreq*this.valFraction]).range([10,this.maxFont])},manageOpacityScale:function(){this.opacityScale.domain([0,this.absMaxFreq*this.valFraction]).range([.4,.8])},manageYScale:function(){if(this.parent.getApiParam("yAxisScale")=="linear")this.yScale=d3.scaleLinear();if(this.parent.getApiParam("yAxisScale")=="log")this.yScale=d3.scaleLog();this.yScale.domain([this.minFreq,this.absMaxFreq*this.valFraction*1.25]).rangeRound([this.container.getHeight()-
this.bPadding,this.tPadding+this.getSliderHeight()])},manageYSliderScale:function(){var top=this.tPadding,bottom=this.tPadding+this.getSliderHeight();if(this.parent.getApiParam("yAxisScale")=="linear")this.ySliderScale=d3.scaleLinear();if(this.parent.getApiParam("yAxisScale")=="log")this.ySliderScale=d3.scaleLog();this.ySliderScale.domain([this.minFreq,this.absMaxFreq]).rangeRound([bottom,top])},updateYSliderScale:function(updateWithObject){updateWithObject=updateWithObject||0;var selectedMin=this.minFreq,
selectedMax=0;var len=this.overlayQueue.length;while(len-- >0){if(this.overlayQueue[len].pathMin<selectedMin)selectedMin=this.overlayQueue[len].pathMin;if(this.overlayQueue[len].pathMax>selectedMax)selectedMax=this.overlayQueue[len].pathMax}if(updateWithObject!=0&&updateWithObject.pathMin<selectedMin)selectedMin=updateWithObject.pathMin;if(updateWithObject!=0&&updateWithObject.pathMax>selectedMax)selectedMax=updateWithObject.pathMax;this.ySliderScale.domain([selectedMin,selectedMax])},manageAllXScales:function(){this.manageXScale();
this.manageXSliderScale()},manageXScale:function(){this.xScale.domain([this.shiftCount-.5,this.numVisPoints+this.shiftCount-.5]).range([this.lPadding,this.container.getWidth()-this.rPadding])},manageXSliderScale:function(){this.xSliderScale.domain([0,this.numDataPoints-1]).range([this.lPadding,this.container.getWidth()-this.rPadding])},getSliderHeight:function(){return this.isSliderVisible?this.sliderHeight+this.sliderBPadding:0},setSliderHeight:function(){this.sliderHeight=Math.max(10,this.container.getHeight()*
this.sliderHeightRatio)},hideSlider:function(){this.isSliderVisible=false;this.removeSlider(true);this.doResize()},showSlider:function(){this.isSliderVisible=true;this.doResize()},setTitleLength:function(){var me=this,item;this.titlesArray=[];var scale=d3.scaleLinear().domain([350,1250]).range([10,40]);var corpus=this.parent.getCorpus();for(var i=0,len=corpus.getDocumentsCount();i<len;i++){var item=corpus.getDocument(i);var shortTitle=item.getShortTitle();if(shortTitle.length<=scale(me.container.getWidth()))me.titlesArray.push(shortTitle);
else{var shorterTitle=shortTitle.substring(0,scale(me.container.getWidth())-3);me.titlesArray.push(shorterTitle+"...")}}},callOffset:function(){var callOffset;if(this.transitionCall==="draw"||this.transitionCall==="redraw")callOffset=0;if(this.transitionCall==="left")callOffset=-1;if(this.transitionCall==="right")callOffset=1;return callOffset},removeFilteredCharacters:function(string){return string||"";if(string!==undefined)return string.replace("'","apostrophe-").replace("#","pound-").replace("\x26",
"ampersand-").replace("@","atsign-").replace("!","exclamation-").replace("0","num-o").replace("1","num-a").replace("2","num-b").replace("3","num-c").replace("4","num-d").replace("5","num-e").replace("6","num-f").replace("7","num-g").replace("8","num-h").replace("9","num-i").replace(/[^a-zA-Z]+/g,"-");else return""},getDuration:function(){return this.numDataPoints*(100-this.parent.getSpeed())}};Ext.define("Voyant.util.Assignable",{transferable:["assign"],assign:function(name){if(this.then)return Voyant.application.getDeferredNestedPromise(this,arguments);else{if(Ext.isString(name))window[name]=this;else Voyant.application.showError("The 'assign' method expects a string argument. ("+typeof name+") "+name);return this}}});Ext.define("Voyant.util.Api",{constructor:function(config){var apis=[];if(!this.isApplication){var app=this.getApplication?this.getApplication():Voyant.application;if(this.mixins)for(key in this.mixins){var clz=Ext.ClassManager.get(key);if(clz&&clz.api)apis.splice(0,0,clz.api)}this.addParentApi(apis,Ext.ClassManager.getClass(app));if(app.getApiParams)apis.push(app.getApiParams())}this.addParentApi(apis,Ext.ClassManager.getClass(this));this.api={};apis.forEach(function(a){for(key in a)this.api[key]=
{initial:a[key],value:a[key]}},this);var queryParams=Ext.Object.fromQueryString(document.location.search);var xtype=this.getXType?this.getXType():undefined;for(var key in queryParams)if(this.api[key])this.setApiParam(key,queryParams[key]);else if(xtype&&key.indexOf(".")>0){var k=key.substring(key.indexOf(".")+1);if(k&&k in this.api)this.setApiParam(k,queryParams[key])}if(config&&Ext.isObject(config.api)){for(var key in config.api)if(this.api[key])this.setApiParam(key,config.api[key]);delete config.api}if(queryParams["type"]&&
"query"in this.api&&!this.getApiParam("query"))this.setApiParam("query",queryParams["type"])},addParentApi:function(apis,clz){if(clz.api)apis.splice(0,0,clz.api);if(clz.superclass)this.addParentApi(apis,clz.superclass.self)},getApiParam:function(key,defaultValue){return this.api[key]!==undefined?this.api[key].value:defaultValue},getApiParams:function(keys,keepEmpty){keys=keys||Object.keys(this.api);var api={};if(Ext.isString(keys))keys=[keys];keys.forEach(function(key){var val=this.getApiParam(key);
if(keepEmpty||!Ext.isEmpty(val))api[key]=val},this);return api},getModifiedApiParams:function(){var api={};for(var key in this.api)if(this.api[key].initial!=this.api[key].value)api[key]=this.api[key].value;return api},setApiParams:function(config){for(var key in config)this.setApiParam(key,config[key])},setApiParam:function(key,value){if(this.api&&this.api[key])this.api[key].value=value}});Ext.define("Voyant.util.Localization",{statics:{DEFAULT_LANGUAGE:"en",LANGUAGE:"en",i18n:{}},languageStore:Ext.create("Ext.data.ArrayStore",{fields:["code","language"],data:[["en","English"]]}),getLanguage:function(code){var record=this.languageStore.findRecord(code.length==2?"code":"language",code);if(record)return record.get(code.length==2?"language":"code")},localize:function(key,config){return this._localizeObject(this,key,config)},_localizeObject:function(object,key,config){var val=this._localizeClass(Ext.ClassManager.getClass(object),
key,config);if(val)return val;if(object.mixins)for(mixin in object.mixins){var val=this._localizeClass(Ext.ClassManager.getClass(object.mixins[mixin]),key,config);if(val)return val}if(object.superclass){val=this._localizeObject(object.superclass,key,config);if(val)return val}return config&&config["default"]!=undefined?config["default"]:"["+key+"]"},_localizeClass:function(clazz,key,config){if(clazz&&clazz.i18n&&clazz.i18n[key]){var use=false;if(clazz.i18n[key])use=clazz.i18n[key];if(use){if(use.isTemplate)return use.apply(config);
return use}return config&&config["default"]!=undefined?config["default"]:"["+key+"]"}return false},getLanguageToolMenu:function(){var me=this;return{type:"language",tooltip:this.localize("languageTitle"),xtype:"toolmenu",glyph:"xf1ab@FontAwesome",handler:me.showLanguageOptions,scope:me}},showLanguageOptions:function(){var me=this;var langs=["ar","bs","cz","en","es","fr","he","hr","it","ja","pt","sr"].map(function(lang){return{text:this.localize(lang),value:lang}},this);langs.sort(function(a,b){return a.text.localeCompare(b.text)});
langs.splice(0,0,{text:this.localize("autoRecommended"),value:""});(new Ext.window.Window({title:this.localize("languageTitle"),modal:true,items:{xtype:"form",items:[{xtype:"combo",name:"lang",value:this.getApiParam("lang")||"",queryMode:"local",editable:false,fieldLabel:this.localize("chooseLanguage"),width:450,labelAlign:"right",labelWidth:150,displayField:"text",valueField:"value",store:{fields:["text","value"],data:langs}}],buttons:[{text:this.localize("cancelTitle"),ui:"default-toolbar",glyph:"xf00d@FontAwesome",
flex:1,handler:function(btn){btn.up("window").close()}},{text:this.localize("confirmTitle"),glyph:"xf00c@FontAwesome",flex:1,handler:function(btn){var form=btn.up("form");if(form.isDirty()){var app=me.getApplication();var params=app.getModifiedApiParams();if(app.getCorpus())params.corpus=app.getCorpus().getAliasOrId();else delete params.panels;delete params.lang;var values=form.getValues();if(values.lang)params.lang=values.lang;location.assign("./?"+Ext.Object.toQueryString(params))}btn.up("window").close()},
scope:me}]},bodyPadding:5})).show()}});Ext.define("Voyant.util.Colors",{config:{palettes:undefined,colorTermAssociations:undefined},constructor:function(config){this.setPalettes({"default":[[0,0,255],[51,197,51],[255,0,255],[121,51,255],[28,255,255],[255,174,0],[30,177,255],[182,242,58],[255,0,164],[51,102,153],[34,111,52],[155,20,104],[109,43,157],[128,130,33],[111,76,10],[119,115,165],[61,177,169],[202,135,115],[194,169,204],[181,212,228],[182,197,174],[255,197,197],[228,200,124],[197,179,159]]});this.resetColorTermAssociations();if(d3!==
undefined){var cat10=d3.scaleOrdinal(d3.schemeCategory10).range().map(function(val){return this.hexToRgb(val)},this);var cat20a=d3.scaleOrdinal(d3.schemeCategory20).range().map(function(val){return this.hexToRgb(val)},this);var cat20b=d3.scaleOrdinal(d3.schemeCategory20b).range().map(function(val){return this.hexToRgb(val)},this);var cat20c=d3.scaleOrdinal(d3.schemeCategory20c).range().map(function(val){return this.hexToRgb(val)},this);this.addColorPalette("d3_cat10",cat10);this.addColorPalette("d3_cat20a",
cat20a);this.addColorPalette("d3_cat20b",cat20b);this.addColorPalette("d3_cat20c",cat20c)}var extjs=Ext.create("Ext.chart.theme.Base").getColors().map(function(val){return this.hexToRgb(val)},this);this.addColorPalette("extjs",extjs)},resetColorTermAssociations:function(){this.setColorTermAssociations(new Ext.util.MixedCollection)},rgbToHex:function(a){return"#"+((1<<24)+(a[0]<<16)+(a[1]<<8)+a[2]).toString(16).slice(1)},hexToRgb:function(hex){var shorthandRegex=/^#?([a-f\d])([a-f\d])([a-f\d])$/i;
hex=hex.replace(shorthandRegex,function(m,r,g,b){return r+r+g+g+b+b});var result=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);return result?[parseInt(result[1],16),parseInt(result[2],16),parseInt(result[3],16)]:null},addColorPalette:function(key,values){this.getPalettes()[key]=values},getColorPalette:function(key,returnHex){var paletteKey=key||"default";var palette=this.getPalettes()[paletteKey];if(palette===undefined)palette=[];if(returnHex){var colors=[];for(var i=0;i<palette.length;i++)colors.push(this.rgbToHex(palette[i]));
return colors}else return palette},getColor:function(key,index,returnHex){var paletteKey=key||"default";var palette=this.getPalettes()[paletteKey];if(index>=palette.length)index=index%palette.length;if(returnHex)return this.rgbToHex(palette[index]);else return palette[index]},getColorForTerm:function(key,term,returnHex){var paletteKey=key||"default";var palette=this.getPalettes()[paletteKey];if(term.indexOf(":")!=-1)term=term.split(":")[1];var color=this.getColorTermAssociations().get(term);if(color==
null){var index=this.getColorTermAssociations().getCount()%palette.length;color=palette[index];this.getColorTermAssociations().add(term,color)}if(returnHex)color=this.rgbToHex(color);return color},setColorForTerm:function(term,color){if(Array.isArray(color)===false)color=this.hexToRgb(color);this.getColorTermAssociations().replace(term,color)}});Ext.define("Voyant.util.Deferrable",{deferredStack:[],releaseAllDeferred:function(){this.deferredStack=[]},getDeferredCount:function(){return this.deferredStack.length},getDeferred:function(transferable){var deferred=new Ext.Deferred;var pomise=deferred;if(transferable&&transferable.transfer)transferable.transfer(transferable,deferred.promise);if(!deferred.promise.show&&window.show)deferred.promise.show=show;if(!deferred.promise.assign)Ext.apply(deferred.promise,{assign:(new Voyant.util.Assignable).assign});
this.deferredStack.push(deferred);var me=this;deferred.promise.always(function(){me.deferredStack.pop()});return deferred},getPromiseFromDeferred:function(dfd){return typeof dfd.promise==="object"?dfd.promise:dfd.promise()},getDeferredNestedPromise:function(promise,args,transferable){var callee=arguments.callee.caller;var dfd=Voyant.application.getDeferred(transferable);promise.then(function(promised){dfd.resolve(callee.apply(promised,args))});return dfd.promise}});Ext.define("Voyant.util.DetailedError",{extend:"Ext.Error",mixins:["Voyant.util.Localization"],config:{msg:undefined,error:undefined,details:undefined},statics:{i18n:{error:"Error"}},constructor:function(config){this.setMsg(config.msg);this.setError(config.error);this.setDetails(config.details);this.callParent(arguments)},show:function(config){if(window.showError)showError.call(this);else this.showMsg(config)},showMsg:function(config){config=config||{};Ext.applyIf(config,{message:this.getMsg()+"\x3cp class\x3d'error'\x3e\n"+
this.getError()+"\u2026 "+"\x3ca href\x3d'#' onclick\x3d\"window.open('').document.write(unescape('\x3cpre\x3e"+escape(this.getDetails())+"\x3c/pre\x3e')); return false;\"\x3emore\x3c/a\x3e\x3c/p\x3e",title:this.localize("error"),buttons:Ext.Msg.OK,icon:Ext.MessageBox.ERROR,autoScroll:true});Ext.Msg.show(config)}});Ext.define("Voyant.util.ResponseError",{extend:"Voyant.util.DetailedError",config:{response:undefined},constructor:function(config){this.setResponse(config.response);Ext.applyIf(config,{msg:config.response.statusText,error:"responseText"in config.response?config.response.responseText.split(/(\r\n|\r|\n)/).shift():"",details:"responseText"in config.response?config.response.responseText:""});this.callParent(arguments)}});Ext.define("Voyant.util.SparkLine",{getSparkLine:function(values,stretch){if(values.length<2)return"";var min=Number.MAX_VALUE;var max=Number.MIN_VALUE;var hasDecimal=false;for(var i=0;i<values.length;i++){if(values[i]<min)min=values[i];if(values[i]>max)max=values[i];if(!hasDecimal&&values[i].toString().indexOf(".")>-1)hasDecimal=true}var dif=(max-min).toString();var multiplier=1;var divider=1;var newvalues=[];if(hasDecimal){var multiplier=100;var ind=dif.indexOf(".")+1;for(var i=ind;i<dif.length;i++)if(dif.charAt(i)==
"0")multiplier*=10;else break;for(var i=0;i<values.length;i++)newvalues[i]=parseInt(values[i]*multiplier);max=parseInt(max*multiplier);min=parseInt(min*multiplier)}else{var divider=1;for(var i=dif.length-1;i>-1;i--)if(dif.charAt(i)=="0")divider*=10;else break;if(divider!=1){for(var i=0;i<values.length;i++)newvalues[i]=values[i]/divider;max/=divider;min/=divider}else newvalues=values}var valLen=(max.toString().length>min.toString().length?max.toString().length:min.toString().length)+1;var valuesPerImage=
Math.floor(1800/valLen);var baseUrl="http://chart.apis.google.com/chart?cht\x3dls\x26amp;chco\x3d0077CC\x26amp;chls\x3d1,0,0\x26amp;chds\x3d"+min+","+max;var images=Math.ceil(values.length/valuesPerImage);var counter=0;var response="";var wid;if(values.length<5)wid=5;else if(values.length<10)wid=4;else if(values.length<20)wid=3;else if(values.length<50)wid=2;else wid=1;for(var i=0;i<images;i++){var vals=newvalues.slice(counter,counter+=valuesPerImage);response+="\x3cimg style\x3d'margin: 0; padding: 0;' border\x3d'0' src\x3d'"+
baseUrl+"\x26amp;chs\x3d"+wid*vals.length+"x15\x26amp;chd\x3dt:"+vals.join(",")+"' alt\x3d'' class\x3d'chart-";if(images==1)response+="full";else if(i>0&&i+1<images)response+"middle";else if(i==0)response+="left";else response+="right";response+="' /\x3e"}return response}});Ext.define("Voyant.util.Toolable",{requires:["Voyant.util.Localization","Voyant.util.Api"],statics:{i18n:{},api:{suppressTools:false}},constructor:function(config){config=config||{};if(this.getApiParam&&this.getApiParam("suppressTools")=="true")return;if("header"in config&&config.header===false)return;var me=this;var moreTools=undefined;var parent=this.up("component");if(config.moreTools){moreTools=[];config.moreTools.forEach(function(xtype){if(xtype&&xtype!=this.xtype)moreTools.push(this.getMenuItemFromXtype(xtype))},
this)}else if(parent&&parent.getInitialConfig("moreTools")){moreTools=[];parent.getInitialConfig("moreTools").forEach(function(xtype){if(xtype&&xtype!=this.xtype)moreTools.push(this.getMenuItemFromXtype(xtype))},this)}if(moreTools&&this.getApplication().getMoreTools)moreTools.push({xtype:"menuseparator"});if(this.getApplication().getMoreTools){moreTools=moreTools||[];var app=this.getApplication();var tools=app.getMoreTools();tools.forEach(function(category){var categories=[];category.items.forEach(function(xtype){categories.push(this.getMenuItemFromXtype(xtype))},
this);moreTools.push({text:app.localize(category.i18n),glyph:category.glyph,menu:{items:categories}})},this)}var exportItems=undefined;var toolsMap={save:{glyph:"xf08e@FontAwesome",fn:this.exportToolClick,items:exportItems},plus:moreTools?{glyph:"xf17a@FontAwesome",items:moreTools}:undefined,gear:this.showOptionsClick||this.getOptions?{glyph:"xf205@FontAwesome",fn:this.showOptionsClick?this.showOptionsClick:function(panel){if(panel.isXType("voyanttabpanel"))panel=panel.getActiveTab();Ext.create("Ext.window.Window",
{title:panel.localize("optionsTitle"),modal:true,panel:panel,items:{xtype:"form",items:panel.getOptions(),listeners:{afterrender:function(form){var api=panel.getApiParams(form.getForm().getFields().collect("name"));form.getForm().setValues(api)}},buttons:[{text:panel.localize("reset"),glyph:"xf0e2@FontAwesome",flex:1,panel:panel,ui:"default-toolbar",handler:function(btn){if(this.mixins&&this.mixins["Voyant.util.Api"]){this.mixins["Voyant.util.Api"].constructor.apply(this);if(this.getCorpus&&this.getCorpus())this.fireEvent("loadedCorpus",
this,this.getCorpus())}btn.up("window").close()},scope:panel},{xtype:"tbfill"},{text:panel.localize("cancelTitle"),ui:"default-toolbar",glyph:"xf00d@FontAwesome",flex:1,handler:function(btn){btn.up("window").close()}},{text:panel.localize("confirmTitle"),glyph:"xf00c@FontAwesome",flex:1,panel:panel,handler:function(btn){function doGlobalUpdate(key,value){if(app.setApiParam)app.setApiParam(key,value);var panels=app.getViewport().query("panel,chart");for(var i=0;i<panels.length;i++)if(panels[i].setApiParam)panels[i].setApiParam(key,
value);globalUpdate=true}var values=btn.up("form").getValues();this.setApiParams(values);var app=this.getApplication();var corpus=app.getCorpus();var globalUpdate=false;if(values["stopList"]!=undefined&&values["stopListGlobal"]!=undefined&&values.stopListGlobal)doGlobalUpdate("stopList",values["stopList"]);if(values["palette"]!=undefined){app.resetColorTermAssociations();doGlobalUpdate("palette",values["palette"])}if(values["categories"]!=undefined)doGlobalUpdate("categories",values["categories"]);
if(globalUpdate)if(corpus)app.dispatchEvent("loadedCorpus",this,corpus);else app.dispatchEvent("apiParamsUpdated",this,values);if(corpus)this.fireEvent("loadedCorpus",this,corpus);else this.fireEvent("apiParamsUpdated",this,values);btn.up("window").close()},scope:panel}]},bodyPadding:5}).show()}}:undefined,help:{glyph:"xf128@FontAwesome",fn:this.helpToolClick}};var tools=[];if(config.includeTools)for(var tool in config.includeTools)if(typeof config.includeTools[tool]=="object")tools.push(config.includeTools[tool]);
for(var tool in toolsMap){if(config.includeTools&&!config.includeTools[tool]||!toolsMap[tool])continue;tools.push({type:tool,tooltip:this.localize(tool+"Tip"),callback:toolsMap[tool].fn,xtype:"toolmenu",glyph:toolsMap[tool].glyph,items:toolsMap[tool].items})}Ext.apply(this,{tools:tools});this.on("afterrender",function(){var header=this.getHeader();if(header&&Ext.os.deviceType=="Desktop"&&!this.isXType("corpuscreator")&&!this.isXType("notebook")){var el=header.getEl();el.on("mouseover",function(){this.getHeader().getTools().forEach(function(tool){tool.show()})},
this);el.on("mouseout",function(){this.getHeader().getTools().forEach(function(tool){var type=tool.config.type||tool.type;if(type&&type!="help"&&type.indexOf("collapse")==-1)tool.hide()})},this);header.getTools().forEach(function(tool,i){if(tool.config.type!="help")tool.hide()})}},this)},getMenuItemFromXtype:function(xtype){var xt=xtype;var config=this.getApplication().getToolConfigFromToolXtype(xtype);if(config&&config.tooltip)delete config.tooltip;return Ext.apply(Ext.clone(config),{xtype:"menuitem",
text:config.title,textAlign:"left",handler:function(){this.replacePanel(config.xtype)},scope:this})},maximizeToolClick:function(panel){var name=Ext.getClass(panel).getName();var parts=name.split(".");url=panel.getBaseUrl()+"tool/"+parts[parts.length-1]+"/";params=panel.getModifiedApiParams();if(!params.corpus&&panel.getCorpus&&panel.getCorpus())params.corpus=panel.getCorpus().getId();if(params)url+="?"+Ext.Object.toQueryString(params);panel.openUrl(url)},exportToolClick:function(panel){if(panel.isXType("voyanttabpanel"))panel=
panel.getActiveTab();var items=window.location.hostname=="beta.voyant-tools.org"?[{html:"\x3cp class\x3d'keyword' style\x3d'text-align: center; font-weight: bold; padding: 4px;'\x3ePlease note that this is the beta server and you should not count on corpora persisting (for bookmarks, embedding, etc.)."}]:[];var exportViewItems=[{xtype:"radio",name:"export",inputValue:"embed",boxLabel:panel.localize("exportViewHtmlEmbed")},{xtype:"radio",name:"export",inputValue:"biblio",boxLabel:panel.localize("exportViewBiblio")},
{xtype:"radio",name:"export",inputValue:"spyral",boxLabel:panel.localize("exportViewSpyral")}];if(panel.getExtraExportItems)panel.getExtraExportItems().forEach(function(item){Ext.applyIf(item,{xtype:"radio",name:"export"});exportViewItems.push(item)});items.push({xtype:"radio",name:"export",inputValue:"url",boxLabel:"\x3ca href\x3d'"+panel.getExportUrl.call(panel)+"' target\x3d'_blank'\x3e"+panel.localize("exportViewUrl")+"\x3c/a\x3e",checked:true,listeners:{afterrender:function(){this.boxLabelEl.on("click",
function(){this.up("window").close()},this)}}},{xtype:"fieldset",collapsible:true,collapsed:true,title:panel.localize("exportViewFieldset"),items:exportViewItems});if(panel.isXType("grid")){var exportitems=[{xtype:"radio",name:"export",inputValue:"gridCurrentHtml",boxLabel:panel.localize("exportGridCurrentHtml")},{xtype:"radio",name:"export",inputValue:"gridCurrentTsv",boxLabel:panel.localize("exportGridCurrentTsv")}];if(!panel.getExportGridAll||panel.getExportGridAll()!=false)exportitems.push({xtype:"radio",
name:"export",inputValue:"gridAllJson",boxLabel:panel.localize("exportGridAllJson")},{xtype:"radio",name:"export",inputValue:"gridAllTsv",boxLabel:panel.localize("exportGridAllTsv")});items.push({xtype:"fieldset",collapsible:true,collapsed:true,title:panel.localize("exportGridCurrent"),items:exportitems})}if((!panel.getExportVisualization||panel.getExportVisualization())&&panel.isXType("grid")==false&&(panel.down("chart")||panel.getTargetEl().dom.querySelector("canvas")||panel.getTargetEl().dom.querySelector("svg"))){var formats=
[{xtype:"radio",name:"export",inputValue:"png",boxLabel:panel.localize("exportPng")},{xtype:"slider",width:200,value:1,minValue:.5,maxValue:10,increment:.5,labelAlign:"right",decimalPrecision:1,itemId:"scale",fieldLabel:(new Ext.Template(panel.localize("scaleLabel"))).apply([1]),listeners:{change:function(slider,newVal){this.setFieldLabel((new Ext.Template(panel.localize("scaleLabel"))).apply([newVal]))},changecomplete:function(slider){slider.previousSibling().setValue(true)}}}];if(panel.getTargetEl().dom.querySelector("svg"))formats.push({xtype:"radio",
name:"export",inputValue:"svg",boxLabel:panel.localize("exportSvg")});items.push({xtype:"fieldset",collapsible:true,collapsed:true,title:panel.localize("exportVizTitle"),items:formats})}Ext.create("Ext.window.Window",{title:panel.localize("exportTitle"),modal:true,items:{xtype:"form",items:items,buttons:[{text:panel.localize("exportTitle"),glyph:"xf08e@FontAwesome",flex:1,panel:panel,handler:function(btn){var form=btn.up("form");var fn="export"+Ext.String.capitalize(form.getValues()["export"]);if(Ext.isFunction(panel[fn]))panel[fn].call(panel,
panel,form);else Ext.Msg.show({title:panel.localize("exportError"),message:panel.localize("exportNoFunction"),buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR});btn.up("window").close()},scope:panel},{text:panel.localize("cancelTitle"),glyph:"xf00d@FontAwesome",flex:1,handler:function(btn){btn.up("window").close()}}]},bodyPadding:5}).show()},exportSvg:function(img){var svg=this.getTargetEl().dom.querySelector("svg");if(svg){var html=d3.select(svg).attr("version",1.1).attr("xmlns","http://www.w3.org/2000/svg").node().parentNode.innerHTML;
Ext.Msg.show({title:this.localize("exportSvgTitle"),message:'\x3cimg src\x3d"'+"data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(html)))+'" style\x3d"float: right; max-width: 200px; max-height: 200px; border: thin dotted #ccc;"/\x3e'+this.localize("exportSvgMessage"),buttons:Ext.Msg.OK,icon:Ext.Msg.INFO,prompt:true,multiline:true,value:html})}},exportPngData:function(img){Ext.Msg.show({title:this.localize("exportPngTitle"),message:'\x3cimg class\x3d"thumb" src\x3d"'+img+'" style\x3d"float: right; max-width: 200px; max-height: 200px; border: thin dotted #ccc;"/\x3e'+
this.localize("exportPngMessage"),buttons:Ext.Msg.OK,icon:Ext.Msg.INFO,prompt:true,multiline:true,value:'\x3cimg src\x3d"'+img+'" /\x3e'})},exportPng:function(panel,form){var scale=1;if(form){form.mask(panel.localize("loading"));var slider=form.queryById("scale");if(slider&&slider.getValue)scale=slider.getValue()}var canvasSurface=this.down("draw")||this.down("chart");if(canvasSurface&&(canvasSurface.isChart||canvasSurface.isCanvas)){var size=canvasSurface.innerElement.getSize(),surfaces=Array.prototype.slice.call(canvasSurface.items.items),
zIndexes=canvasSurface.surfaceZIndexes,image,imageElement,i,j,surface,zIndex;for(j=1;j<surfaces.length;j++){surface=surfaces[j];zIndex=zIndexes[surface.type];i=j-1;while(i>=0&&zIndexes[surfaces[i].type]>zIndex){surfaces[i+1]=surfaces[i];i--}surfaces[i+1]=surface}var targetCanvas=document.createElement("canvas"),className=Ext.getClassName(surfaces[0]),ratio=surfaces[0].devicePixelRatio*scale,ctx=targetCanvas.getContext("2d"),surface,canvas,rect,i,j,xy;targetCanvas.width=Math.ceil(size.width*ratio);
targetCanvas.height=Math.ceil(size.height*ratio);for(i=0;i<surfaces.length;i++){surface=surfaces[i];if(Ext.getClassName(surface)!==className)continue;rect=surface.getRect();surfaceSize=surface.el.getSize();for(j=0;j<surface.canvases.length;j++){canvas=surface.canvases[j];xy=canvas.getOffsetsTo(canvas.getParent());ctx.drawImage(canvas.dom,(rect[0]+xy[0])*ratio,(rect[1]+xy[1])*ratio,surfaceSize.width*ratio,surfaceSize.height*ratio)}}if(form&&form.isVisible())form.unmask();return this.exportPngData(targetCanvas.toDataURL())}var targetEl=
this.getTargetEl().dom,canvas=targetEl.querySelector("canvas");if(canvas){if(scale==1){var data=canvas.toDataURL("image/png");if(form&&form.isVisible())form.unmask();return this.exportPngData(data)}var targetCanvas=document.createElement("canvas"),ctx=targetCanvas.getContext("2d");targetCanvas.width=Math.ceil(canvas.width*scale);targetCanvas.height=Math.ceil(canvas.height*scale);var image=new Image;image.src=canvas.toDataURL("image/png");image.panel=this;image.onload=function(){ctx.drawImage(image,
0,0,targetCanvas.width,targetCanvas.height);img=targetCanvas.toDataURL("image/png");if(form&&form.isVisible())form.unmask();this.panel.exportPngData.call(this.panel,img)};return}var svg=targetEl.querySelector("svg");if(svg){var width=targetEl.offsetWidth*scale,height=targetEl.offsetHeight*scale;var clone=svg.cloneNode(true);clone.setAttribute("version",1.1);clone.setAttribute("xmlns","http://www.w3.org/2000/svg");clone.setAttribute("transform","scale("+scale+")");clone.setAttribute("width",width);
clone.setAttribute("height",height);var html=clone.outerHTML,img="data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(html)));var canvas=Ext.DomHelper.createDom({tag:"canvas",width:width,height:height}),context=canvas.getContext("2d"),me=this;var image=new Image;image.src=img;image.panel=this;image.onload=function(){context.drawImage(image,0,0);img=canvas.toDataURL("image/png");if(form&&form.isVisible())form.unmask();return this.panel.exportPngData.call(this.panel,img)}}},exportUrl:function(){this.openUrl(this.getExportUrl())},
exportEmbed:function(){var asTool=this.isXType("voyantheader")==false;Ext.Msg.show({title:this.localize("exportViewEmbedTitle"),message:this.localize("exportViewEmbedMessage"),buttons:Ext.Msg.OK,icon:Ext.Msg.INFO,prompt:true,multiline:true,value:"\x3c!--\tExported from Voyant Tools (voyant-tools.org).\n"+"The iframe src attribute below uses a relative protocol to better function with both\n"+"http and https sites, but if you're embedding this into a local web page (file protocol)\n"+"you should add an explicit protocol (https if you're using voyant-tools.org, otherwise\n"+
"it depends on this server.\n"+"Feel free to change the height and width values or other styling below: --\x3e\n"+"\x3ciframe style\x3d'width: "+(asTool?this.getWidth()+"px":"100%")+"; height: "+(asTool?this.getHeight()+"px":"800px")+";' src\x3d'"+this.getExportUrl(asTool)+"'\x3e\x3c/iframe\x3e"})},exportBiblio:function(){var date=new Date;var url=this.getExportUrl();Ext.Msg.show({title:this.localize("exportBiblioTitle"),message:"\x3cfieldset\x3e\x3clegend\x3eMLA\x3c/legend\x3e"+'\x3cdiv class\x3d"x-selectable"\x3eSinclair, St\u00e9fan and Geoffrey Rockwell. '+
(this.isXType("voyantheader")?"":'"'+this.localize("title")+'." ')+"\x3ci\x3eVoyant Tools\x3c/i\x3e. "+Ext.Date.format(date,"Y")+". Web. "+Ext.Date.format(date,"j M Y")+". \x26lt;"+url+"\x26gt;.\x3c/div\x3e\x3c/fieldset\x3e"+"\x3cbr \x3e"+"\x3cfieldset\x3e\x3clegend\x3eChicago\x3c/legend\x3e"+'\x3cdiv class\x3d"x-selectable"\x3eSt\u00e9fan Sinclair and Geoffrey Rockwell, '+(this.isXType("voyantheader")?"":'"'+this.localize("title")+'", ')+"\x3ci\x3eVoyant Tools\x3c/i\x3e, accessed "+Ext.Date.format(date,
"F j, Y")+", "+url+".\x3c/div\x3e\x3c/fieldset\x3e"+"\x3cbr \x3e"+"\x3cfieldset\x3e\x3clegend\x3eAPA\x3c/legend\x3e"+'\x3cdiv class\x3d"x-selectable"\x3eSinclair, S. \x26amp; G. Rockwell. ('+Ext.Date.format(date,"Y")+"). "+(this.isXType("voyantheader")?"":this.localize("title")+". ")+"\x3ci\x3eVoyant Tools\x3c/i\x3e. Retrieved "+Ext.Date.format(date,"F j, Y")+", from "+url+"\x3c/div\x3e\x3c/fieldset\x3e",buttons:Ext.Msg.OK,icon:Ext.Msg.INFO})},exportSpyral:function(){let toolForUrl=Ext.getClassName(this).split(".").pop();
let api=this.getApplication().getModifiedApiParams();if(this.isXType("voyantheader")==false){delete api.panels;Ext.apply(api,this.getModifiedApiParams());delete api.corpus}let isDebug=api&&"debug"in api;delete api.view;delete api.debug;let enc=function(str){return btoa(encodeURIComponent(str)).replace(/=/g,"%3D")};let input='["'+enc("\x3ch2\x3eSpyral Notebook Imported from Voyant Tools\x3c/h2\x3e")+'","'+enc('loadCorpus("'+this.getApplication().getCorpus().getAliasOrId()+'").tool("'+(toolForUrl==
"VoyantHeader"?"":toolForUrl)+'"'+(Object.keys(api).length>0?","+Ext.encode(api):"")+");")+'"]';this.openUrl(this.getApplication().getBaseUrl()+"spyral/?run\x3dtrue\x26"+(isDebug?"debug\x3dtrue\x26":"")+"inputJsonArrayOfEncodedBase64\x3d"+input)},exportGridCurrentJson:function(grid,form){var store=grid.getStore();var fields=store.getFields();var value="\x3ctable\x3e\n\t\x3cthead\x3e\n\t\t\x3ctr\x3e\n";var visibleColumns=grid.getColumnManager().headerCt.getVisibleGridColumns();values=[];function jsonCollector(row){var val=
{};visibleColumns.forEach(function(column){val[column.text]=row.get(column.dataIndex)});values.push(val)}if(store.buffered)store.data.forEach(jsonCollector);else store.each(jsonCollector);Ext.Msg.show({title:this.localize("exportDataTitle"),message:this.localize("exportDataJsonMessage"),buttons:Ext.Msg.OK,icon:Ext.Msg.INFO,prompt:true,multiline:true,value:Ext.encode(values)})},exportGridCurrentTsv:function(grid,form){var store=grid.getStore();var fields=store.getFields();var visibleColumns=grid.getColumnManager().headerCt.getVisibleGridColumns();
var fields=[];visibleColumns.forEach(function(column){fields.push(column.text)});var value=fields.join("\t")+"\n";function tsvCollector(row){cells=[];visibleColumns.forEach(function(column){var val=row.get(column.dataIndex);if(Ext.isString(val))val=val.replace(/\s+/g," ");cells.push(val)});value+=cells.join("\t")+"\n"}if(store.buffered)store.data.forEach(tsvCollector);else store.each(tsvCollector);Ext.Msg.show({title:this.localize("exportDataTitle"),message:this.localize("exportDataTsvMessage"),buttons:Ext.Msg.OK,
icon:Ext.Msg.INFO,prompt:true,multiline:true,value:value})},exportGridCurrentHtml:function(grid,form){var store=grid.getStore();var fields=store.getFields();var value="\x3ctable\x3e\n\t\x3cthead\x3e\n\t\t\x3ctr\x3e\n";var visibleColumns=grid.getColumnManager().headerCt.getVisibleGridColumns();visibleColumns.forEach(function(column){value+="\t\t\t\x3ctd\x3e"+column.text+"\x3c/td\x3e\n"});value+="\t\t\x3c/tr\x3e\n\t\x3c/thead\x3e\n\t\x3ctbody\x3e\n";function htmlCollector(row){value+="\t\t\x3ctr\x3e\n";
visibleColumns.forEach(function(column){var val=row.get(column.dataIndex);if(Ext.isString(val))val=val.replace(/&/g,"\x26amp;").replace(/</g,"\x26lt;").replace(/>/g,"\x26lg;");value+="\t\t\t\x3ctd\x3e"+val+"\x3c/td\x3e\n"});value+="\t\t\x3c/tr\x3e\n"}if(store.buffered)store.data.forEach(htmlCollector);else store.each(htmlCollector);value+="\t\x3c/tbody\x3e\n\x3c/table\x3e";Ext.Msg.show({title:this.localize("exportDataTitle"),message:this.localize("exportDataHtmlMessage"),buttons:Ext.Msg.OK,icon:Ext.Msg.INFO,
prompt:true,multiline:true,value:value})},exportGridAllJson:function(grid,form){Ext.Msg.confirm(this.localize("exportAllTitle"),this.localize("exportAllJsonWarning"),function(btn){if(btn=="yes"){var params={limit:0,start:0};Ext.applyIf(params,grid.getStore().getProxy().getExtraParams());this.openUrl(this.getTromboneUrl()+"?"+Ext.Object.toQueryString(params))}},this)},exportGridAllTsv:function(grid,form){Ext.Msg.confirm(this.localize("exportAllTitle"),this.localize("exportAllTsvWarning"),function(btn){if(btn==
"yes"){var params={limit:0,start:0,template:this.getXType()+"2tsv"};Ext.applyIf(params,grid.getStore().getProxy().getExtraParams());this.openUrl(this.getTromboneUrl()+"?"+Ext.Object.toQueryString(params))}},this)},getExportUrl:function(asTool){var api=this.getApplication().getModifiedApiParams();var toolForUrl=Ext.getClassName(this).split(".").pop();if(this.isXType("voyantheader")==false){delete api.panels;Ext.apply(api,this.getModifiedApiParams());if(!asTool)api.view=toolForUrl}if(!api.corpus)api.corpus=
this.getApplication().getCorpus().getAliasOrId();return this.getApplication().getBaseUrl()+(asTool?"tool/"+toolForUrl+"/":"")+"?"+Ext.Object.toQueryString(api)},helpToolClick:function(panel){if(panel.isXType("voyanttabpanel"))panel=panel.getActiveTab();var help=panel.localize("help",{"default":false})||panel.localize("helpTip");if(help==panel._localizeClass(Ext.ClassManager.get("Voyant.util.Toolable"),"helpTip"))panel.openUrl(panel.getBaseUrl()+"docs/#!/guide/"+panel.getXType());else Ext.Msg.alert(panel.localize("title"),
help+"\x3cp\x3e\x3ca href\x3d'"+panel.getBaseUrl()+"docs/"+(panel.isXType("voyantheader")?"":"#!/guide/"+panel.getXType())+"' target\x3d'voyantdocs'\x3e"+panel.localize("moreHelp")+"\x3c/a\x3e\x3c/p\x3e")},replacePanel:function(xtype){var corpus=this.getApplication().getCorpus();var config=this.getInitialConfig();var parent;if(this.isXType("voyantheader")&&this.getApplication().getViewComponent){parent=this.getApplication().getViewComponent();parent.removeAll(true);var newTool=parent.add({xtype:xtype});
if(corpus)this.getApplication().dispatchEvent("loadedCorpus",parent,corpus);var queryParams=Ext.Object.fromQueryString(document.location.search);var url=this.getApplication().getBaseUrl();url+="?corpus\x3d"+corpus.getAliasOrId();url+="\x26view\x3d"+xtype;for(var key in queryParams)if(key!=="corpus"&&key!=="view")url+="\x26"+key+"\x3d"+queryParams[key];window.history.pushState({corpus:corpus.getAliasOrId(),view:xtype},"",url)}else{parent=this.isXType("voyantheader")&&this.getApplication().getViewComponent?
this.getApplication().getViewComponent():this.up("component");parent.remove(this,true);var newTool=parent.add({xtype:xtype});if(parent.isXType("voyanttabpanel"))parent.setActiveTab(newTool);if(corpus)newTool.fireEvent("loadedCorpus",newTool,corpus)}this.getApplication().dispatchEvent("panelChange",this)}});
Ext.define("Voyant.util.ToolMenu",{extend:"Ext.panel.Tool",alias:"widget.toolmenu",renderTpl:['\x3cdiv class\x3d"x-menu-tool-hover"\x3e'+"\x3c/div\x3e"+'\x3ctpl if\x3d"glyph"\x3e'+'\x3cspan id\x3d"{id}-toolEl" class\x3d"{baseCls}-glyph {childElCls}" role\x3d"presentation" style\x3d"font-family: {glyphFontFamily}; '+"\x3ctpl if\x3d\"Ext.os.name\x3d\x3d'iOS'\"\x3e"+"margin-right: 15px; "+"\x3c/tpl\x3e"+'"\x3e\x26#{glyph}\x3c/span\x3e'+"\x3ctpl else\x3e"+'\x3cimg id\x3d"{id}-toolEl" src\x3d"{blank}" class\x3d"{baseCls}-img {baseCls}-{type}'+
'{childElCls}" role\x3d"presentation"/\x3e'+"\x3c/tpl\x3e"],privates:{onClick:function(){var me=this,returnValue=me.callParent(arguments);if(returnValue&&me.items){if(!me.toolMenu)me.toolMenu=new Ext.menu.Menu({items:me.items});me.toolMenu.showAt(0,0);me.toolMenu.showAt(me.getX()+me.getWidth()-me.toolMenu.getWidth(),me.getY()+me.getHeight()+10)}return returnValue},onDestroy:function(){Ext.destroyMembers(this,"toolMenu");this.callParent()}},initComponent:function(){var me=this;me.callParent(arguments);
var glyph,glyphParts,glyphFontFamily;glyph=me.glyph||"xf12e@FontAwesome";if(glyph){if(typeof glyph==="string"){glyphParts=glyph.split("@");glyph=glyphParts[0];glyphFontFamily=glyphParts[1]}else if(typeof glyph==="object"&&glyph.glyphConfig){glyphParts=glyph.glyphConfig.split("@");glyph=glyphParts[0];glyphFontFamily=glyphParts[1]}Ext.applyIf(me.renderData,{baseCls:me.baseCls,blank:Ext.BLANK_IMAGE_URL,type:me.type,glyph:glyph,glyphFontFamily:glyphFontFamily})}}});Ext.define("Voyant.util.Transferable",{transferable:["transfer"],transfer:function(source,destination){if(source.transferable)for(var i=0;i<source.transferable.length;i++){var member=source.transferable[i];destination[member]=Ext.bind(source[member],destination)}if(source.mixins)for(mixin in source.mixins)this.transfer(source.mixins[mixin],destination)}});Ext.define("Voyant.util.Variants",{extend:"Ext.Base",constructor:function(variants){this.variants=variants;this.map={};this.variants.forEach(function(variant,index){variant.forEach(function(v){this.map[v]=index},this)},this)},getVariants:function(terms){var variants=[];if(Ext.isString(terms))terms=[terms];if(Ext.isArray(terms))terms.forEach(function(term){if(this.map[term]!=undefined)variants.push.apply(variants,this.variants[this.map[term]])},this);return variants}});Ext.define("Voyant.util.Downloadable",{mixins:["Voyant.util.Localization"],statics:{i18n:{},api:{documentFormat:undefined,documentFilename:undefined}},downloadFromCorpusId:function(corpusId){var panel=this;Ext.create("Ext.window.Window",{title:this.localize("exportTitle"),modal:true,items:{xtype:"form",items:{xtype:"downloadoptions"},listeners:{afterrender:function(form){form.getForm().setValues(panel.getApiParams(["documentFilename","documentFormat"]))}},buttons:[{text:this.localize("cancelButton"),
glyph:"xf00d@FontAwesome",flex:1,ui:"default-toolbar",handler:function(btn){btn.up("window").close()}},{text:this.localize("downloadButton"),glyph:"xf00c@FontAwesome",flex:1,handler:function(btn){var values=btn.up("form").getValues();panel.setApiParams(values);panel.openDownloadCorpus(corpusId);btn.up("window").close()},scope:this}]},bodyPadding:5}).show()},openDownloadCorpus:function(corpusId){var url=this.getTromboneUrl()+"?corpus\x3d"+corpusId+"\x26tool\x3dcorpus.CorpusExporter\x26outputFormat\x3dzip"+
"\x26zipFilename\x3dDownloadedVoyantCorpus-"+corpusId+".zip"+(this.getApiParam("documentFormat")?"\x26documentFormat\x3d"+this.getApiParam("documentFormat"):"")+(this.getApiParam("documentFilename")?"\x26documentFilename\x3d"+this.getApiParam("documentFilename"):"");this.openUrl(url)}});Ext.define("Voyant.util.Storage",{MAX_LENGTH:95E4,storeResource:function(id,data){var dataString=Ext.encode(data);if(dataString.length>this.MAX_LENGTH){var dfd=new Ext.Deferred;var numChunks=Math.ceil(dataString.length/this.MAX_LENGTH);var chunkIds=[];for(var i=0;i<numChunks;i++)chunkIds.push(id+"-chunk"+i);this._doStore(id+"-hasChunks",Ext.encode(chunkIds)).then(function(){var chunkCount=0;var currIndex=0;for(var i=0;i<numChunks;i++){var chunkString=dataString.substr(currIndex,this.MAX_LENGTH);this._doStore(chunkIds[i],
chunkString).then(function(){chunkCount++;if(chunkCount==numChunks)dfd.resolve()},function(){dfd.reject()},null,this);currIndex+=this.MAX_LENGTH}},function(){dfd.reject()},null,this);return dfd.promise}else return this._doStore(id,dataString)},_doStore:function(id,dataString){var dfd=new Ext.Deferred;Ext.Ajax.request({url:this.getTromboneUrl(),params:{tool:"resource.StoredResource",resourceId:id,storeResource:dataString}}).then(function(response){dfd.resolve()},function(response){dfd.reject()});return dfd.promise},
getStoredResource:function(id){var dfd=new Ext.Deferred;Ext.Ajax.request({url:this.getTromboneUrl(),params:{tool:"resource.StoredResource",verifyResourceId:id+"-hasChunks"}}).then(function(response){var json=Ext.decode(response.responseText);if(json&&json.storedResource&&json.storedResource.id&&json.storedResource.id!="")this._doGetStored(json.storedResource.id,false).then(function(chunkIds){var fullData="";var dataChunks={};for(var i=0;i<chunkIds.length;i++)this._doGetStored(chunkIds[i],true).then(function(response){var chunkId=
response[0];var value=response[1];dataChunks[chunkId]=value;var done=true;for(var j=chunkIds.length-1;j>=0;j--)if(dataChunks[chunkIds[j]]===undefined){done=false;break}if(done){for(var j=0;j<chunkIds.length;j++)fullData+=dataChunks[chunkIds[j]];dfd.resolve(Ext.decode(fullData))}},function(){dfd.reject()},null,this)},function(){dfd.reject()},null,this);else this._doGetStored(id,false).then(function(value){dfd.resolve(value)},function(){dfd.reject()},null,this)},function(){dfd.reject()},null,this);
return dfd.promise},_doGetStored:function(id,isChunk){var dfd=new Ext.Deferred;Ext.Ajax.request({url:this.getTromboneUrl(),params:{tool:"resource.StoredResource",retrieveResourceId:id,failQuietly:true}}).then(function(response){var json=Ext.decode(response.responseText);var id=json.storedResource.id;var value=json.storedResource.resource;if(value.length==0)dfd.reject();else if(isChunk!=true){value=Ext.decode(value);dfd.resolve(value)}else dfd.resolve([id,value])},function(){dfd.reject()},null,this);
return dfd.promise}});Ext.define("Voyant.util.DiacriticsRemover",{diacriticsMap:{},constructor:function(){var defaultDiacriticsRemovalMap=[{"base":"A","letters":"A\u24b6\uff21\u00c0\u00c1\u00c2\u1ea6\u1ea4\u1eaa\u1ea8\u00c3\u0100\u0102\u1eb0\u1eae\u1eb4\u1eb2\u0226\u01e0\u00c4\u01de\u1ea2\u00c5\u01fa\u01cd\u0200\u0202\u1ea0\u1eac\u1eb6\u1e00\u0104\u023a\u2c6f"},{"base":"AA","letters":"\ua732"},{"base":"AE","letters":"\u00c6\u01fc\u01e2"},{"base":"AO","letters":"\ua734"},{"base":"AU","letters":"\ua736"},{"base":"AV","letters":"\ua738\ua73a"},
{"base":"AY","letters":"\ua73c"},{"base":"B","letters":"B\u24b7\uff22\u1e02\u1e04\u1e06\u0243\u0182\u0181"},{"base":"C","letters":"C\u24b8\uff23\u0106\u0108\u010a\u010c\u00c7\u1e08\u0187\u023b\ua73e"},{"base":"D","letters":"D\u24b9\uff24\u1e0a\u010e\u1e0c\u1e10\u1e12\u1e0e\u0110\u018b\u018a\u0189\ua779\u00d0"},{"base":"DZ","letters":"\u01f1\u01c4"},{"base":"Dz","letters":"\u01f2\u01c5"},{"base":"E","letters":"E\u24ba\uff25\u00c8\u00c9\u00ca\u1ec0\u1ebe\u1ec4\u1ec2\u1ebc\u0112\u1e14\u1e16\u0114\u0116\u00cb\u1eba\u011a\u0204\u0206\u1eb8\u1ec6\u0228\u1e1c\u0118\u1e18\u1e1a\u0190\u018e"},
{"base":"F","letters":"F\u24bb\uff26\u1e1e\u0191\ua77b"},{"base":"G","letters":"G\u24bc\uff27\u01f4\u011c\u1e20\u011e\u0120\u01e6\u0122\u01e4\u0193\ua7a0\ua77d\ua77e"},{"base":"H","letters":"H\u24bd\uff28\u0124\u1e22\u1e26\u021e\u1e24\u1e28\u1e2a\u0126\u2c67\u2c75\ua78d"},{"base":"I","letters":"I\u24be\uff29\u00cc\u00cd\u00ce\u0128\u012a\u012c\u0130\u00cf\u1e2e\u1ec8\u01cf\u0208\u020a\u1eca\u012e\u1e2c\u0197"},{"base":"J","letters":"J\u24bf\uff2a\u0134\u0248"},{"base":"K","letters":"K\u24c0\uff2b\u1e30\u01e8\u1e32\u0136\u1e34\u0198\u2c69\ua740\ua742\ua744\ua7a2"},
{"base":"L","letters":"L\u24c1\uff2c\u013f\u0139\u013d\u1e36\u1e38\u013b\u1e3c\u1e3a\u0141\u023d\u2c62\u2c60\ua748\ua746\ua780"},{"base":"LJ","letters":"\u01c7"},{"base":"Lj","letters":"\u01c8"},{"base":"M","letters":"M\u24c2\uff2d\u1e3e\u1e40\u1e42\u2c6e\u019c"},{"base":"N","letters":"N\u24c3\uff2e\u01f8\u0143\u00d1\u1e44\u0147\u1e46\u0145\u1e4a\u1e48\u0220\u019d\ua790\ua7a4"},{"base":"NJ","letters":"\u01ca"},{"base":"Nj","letters":"\u01cb"},{"base":"O","letters":"O\u24c4\uff2f\u00d2\u00d3\u00d4\u1ed2\u1ed0\u1ed6\u1ed4\u00d5\u1e4c\u022c\u1e4e\u014c\u1e50\u1e52\u014e\u022e\u0230\u00d6\u022a\u1ece\u0150\u01d1\u020c\u020e\u01a0\u1edc\u1eda\u1ee0\u1ede\u1ee2\u1ecc\u1ed8\u01ea\u01ec\u00d8\u01fe\u0186\u019f\ua74a\ua74c"},
{"base":"OI","letters":"\u01a2"},{"base":"OO","letters":"\ua74e"},{"base":"OU","letters":"\u0222"},{"base":"OE","letters":"\u008c\u0152"},{"base":"oe","letters":"\u009c\u0153"},{"base":"P","letters":"P\u24c5\uff30\u1e54\u1e56\u01a4\u2c63\ua750\ua752\ua754"},{"base":"Q","letters":"Q\u24c6\uff31\ua756\ua758\u024a"},{"base":"R","letters":"R\u24c7\uff32\u0154\u1e58\u0158\u0210\u0212\u1e5a\u1e5c\u0156\u1e5e\u024c\u2c64\ua75a\ua7a6\ua782"},{"base":"S","letters":"S\u24c8\uff33\u1e9e\u015a\u1e64\u015c\u1e60\u0160\u1e66\u1e62\u1e68\u0218\u015e\u2c7e\ua7a8\ua784"},
{"base":"T","letters":"T\u24c9\uff34\u1e6a\u0164\u1e6c\u021a\u0162\u1e70\u1e6e\u0166\u01ac\u01ae\u023e\ua786"},{"base":"TZ","letters":"\ua728"},{"base":"U","letters":"U\u24ca\uff35\u00d9\u00da\u00db\u0168\u1e78\u016a\u1e7a\u016c\u00dc\u01db\u01d7\u01d5\u01d9\u1ee6\u016e\u0170\u01d3\u0214\u0216\u01af\u1eea\u1ee8\u1eee\u1eec\u1ef0\u1ee4\u1e72\u0172\u1e76\u1e74\u0244"},{"base":"V","letters":"V\u24cb\uff36\u1e7c\u1e7e\u01b2\ua75e\u0245"},{"base":"VY","letters":"\ua760"},{"base":"W","letters":"W\u24cc\uff37\u1e80\u1e82\u0174\u1e86\u1e84\u1e88\u2c72"},
{"base":"X","letters":"X\u24cd\uff38\u1e8a\u1e8c"},{"base":"Y","letters":"Y\u24ce\uff39\u1ef2\u00dd\u0176\u1ef8\u0232\u1e8e\u0178\u1ef6\u1ef4\u01b3\u024e\u1efe"},{"base":"Z","letters":"Z\u24cf\uff3a\u0179\u1e90\u017b\u017d\u1e92\u1e94\u01b5\u0224\u2c7f\u2c6b\ua762"},{"base":"a","letters":"a\u24d0\uff41\u1e9a\u00e0\u00e1\u00e2\u1ea7\u1ea5\u1eab\u1ea9\u00e3\u0101\u0103\u1eb1\u1eaf\u1eb5\u1eb3\u0227\u01e1\u00e4\u01df\u1ea3\u00e5\u01fb\u01ce\u0201\u0203\u1ea1\u1ead\u1eb7\u1e01\u0105\u2c65\u0250"},{"base":"aa",
"letters":"\ua733"},{"base":"ae","letters":"\u00e6\u01fd\u01e3"},{"base":"ao","letters":"\ua735"},{"base":"au","letters":"\ua737"},{"base":"av","letters":"\ua739\ua73b"},{"base":"ay","letters":"\ua73d"},{"base":"b","letters":"b\u24d1\uff42\u1e03\u1e05\u1e07\u0180\u0183\u0253"},{"base":"c","letters":"c\u24d2\uff43\u0107\u0109\u010b\u010d\u00e7\u1e09\u0188\u023c\ua73f\u2184"},{"base":"d","letters":"d\u24d3\uff44\u1e0b\u010f\u1e0d\u1e11\u1e13\u1e0f\u0111\u018c\u0256\u0257\ua77a"},{"base":"dz","letters":"\u01f3\u01c6"},
{"base":"e","letters":"e\u24d4\uff45\u00e8\u00e9\u00ea\u1ec1\u1ebf\u1ec5\u1ec3\u1ebd\u0113\u1e15\u1e17\u0115\u0117\u00eb\u1ebb\u011b\u0205\u0207\u1eb9\u1ec7\u0229\u1e1d\u0119\u1e19\u1e1b\u0247\u025b\u01dd"},{"base":"f","letters":"f\u24d5\uff46\u1e1f\u0192\ua77c"},{"base":"g","letters":"g\u24d6\uff47\u01f5\u011d\u1e21\u011f\u0121\u01e7\u0123\u01e5\u0260\ua7a1\u1d79\ua77f"},{"base":"h","letters":"h\u24d7\uff48\u0125\u1e23\u1e27\u021f\u1e25\u1e29\u1e2b\u1e96\u0127\u2c68\u2c76\u0265"},{"base":"hv","letters":"\u0195"},
{"base":"i","letters":"i\u24d8\uff49\u00ec\u00ed\u00ee\u0129\u012b\u012d\u00ef\u1e2f\u1ec9\u01d0\u0209\u020b\u1ecb\u012f\u1e2d\u0268\u0131"},{"base":"j","letters":"j\u24d9\uff4a\u0135\u01f0\u0249"},{"base":"k","letters":"k\u24da\uff4b\u1e31\u01e9\u1e33\u0137\u1e35\u0199\u2c6a\ua741\ua743\ua745\ua7a3"},{"base":"l","letters":"l\u24db\uff4c\u0140\u013a\u013e\u1e37\u1e39\u013c\u1e3d\u1e3b\u017f\u0142\u019a\u026b\u2c61\ua749\ua781\ua747"},{"base":"lj","letters":"\u01c9"},{"base":"m","letters":"m\u24dc\uff4d\u1e3f\u1e41\u1e43\u0271\u026f"},
{"base":"n","letters":"n\u24dd\uff4e\u01f9\u0144\u00f1\u1e45\u0148\u1e47\u0146\u1e4b\u1e49\u019e\u0272\u0149\ua791\ua7a5"},{"base":"nj","letters":"\u01cc"},{"base":"o","letters":"o\u24de\uff4f\u00f2\u00f3\u00f4\u1ed3\u1ed1\u1ed7\u1ed5\u00f5\u1e4d\u022d\u1e4f\u014d\u1e51\u1e53\u014f\u022f\u0231\u00f6\u022b\u1ecf\u0151\u01d2\u020d\u020f\u01a1\u1edd\u1edb\u1ee1\u1edf\u1ee3\u1ecd\u1ed9\u01eb\u01ed\u00f8\u01ff\u0254\ua74b\ua74d\u0275"},{"base":"oi","letters":"\u01a3"},{"base":"ou","letters":"\u0223"},
{"base":"oo","letters":"\ua74f"},{"base":"p","letters":"p\u24df\uff50\u1e55\u1e57\u01a5\u1d7d\ua751\ua753\ua755"},{"base":"q","letters":"q\u24e0\uff51\u024b\ua757\ua759"},{"base":"r","letters":"r\u24e1\uff52\u0155\u1e59\u0159\u0211\u0213\u1e5b\u1e5d\u0157\u1e5f\u024d\u027d\ua75b\ua7a7\ua783"},{"base":"s","letters":"s\u24e2\uff53\u00df\u015b\u1e65\u015d\u1e61\u0161\u1e67\u1e63\u1e69\u0219\u015f\u023f\ua7a9\ua785\u1e9b"},{"base":"t","letters":"t\u24e3\uff54\u1e6b\u1e97\u0165\u1e6d\u021b\u0163\u1e71\u1e6f\u0167\u01ad\u0288\u2c66\ua787"},
{"base":"tz","letters":"\ua729"},{"base":"u","letters":"u\u24e4\uff55\u00f9\u00fa\u00fb\u0169\u1e79\u016b\u1e7b\u016d\u00fc\u01dc\u01d8\u01d6\u01da\u1ee7\u016f\u0171\u01d4\u0215\u0217\u01b0\u1eeb\u1ee9\u1eef\u1eed\u1ef1\u1ee5\u1e73\u0173\u1e77\u1e75\u0289"},{"base":"v","letters":"v\u24e5\uff56\u1e7d\u1e7f\u028b\ua75f\u028c"},{"base":"vy","letters":"\ua761"},{"base":"w","letters":"w\u24e6\uff57\u1e81\u1e83\u0175\u1e87\u1e85\u1e98\u1e89\u2c73"},{"base":"x","letters":"x\u24e7\uff58\u1e8b\u1e8d"},{"base":"y",
"letters":"y\u24e8\uff59\u1ef3\u00fd\u0177\u1ef9\u0233\u1e8f\u00ff\u1ef7\u1e99\u1ef5\u01b4\u024f\u1eff"},{"base":"z","letters":"z\u24e9\uff5a\u017a\u1e91\u017c\u017e\u1e93\u1e95\u01b6\u0225\u0240\u2c6c\ua763"}];this.diacriticsMap={};for(var i=0;i<defaultDiacriticsRemovalMap.length;i++){var letters=defaultDiacriticsRemovalMap[i].letters;for(var j=0;j<letters.length;j++)this.diacriticsMap[letters[j]]=defaultDiacriticsRemovalMap[i].base}},removeDiacritics:function(str){return str.replace(/[^\u0000-\u007E]/g,
function(a){return this.diacriticsMap[a]||a}.bind(this))}});Ext.define("Voyant.notebook.util.Show",{transferable:["show"],show:function(len){if(this.then)return Voyant.application.getDeferredNestedPromise(this,arguments);else show.call(this,this.getString?this.getString(len):this.toString(),!this.getString&&Ext.isNumber(len)?len:undefined)},statics:{show:function(contents,len){var arg=contents;if(this.then)this.then(function(val){show.call(val,val,arg)});else{if(Ext.isArray(contents)){var allContents="";contents.forEach(function(content){allContents+=content.getString?
content.getString():content.toString()});contents=allContents}else if(Ext.isString(this)||this instanceof String){if(Ext.isNumber(contents))len=contents;contents=this}if(contents.toHtml)contents=contents.toHtml();else if(contents.getString)contents=contents.getString();else if(contents.toString)contents=contents.toString();if(contents.then)contents.then(function(text){show(text,len)});else{if(len&&Ext.isNumber(len))contents=contents.substring(0,len);if(Voyant.notebook.util.Show.SINGLE_LINE_MODE==
false)contents="\x3cdiv class\x3d'"+Voyant.notebook.util.Show.MODE+"'\x3e"+contents+"\x3c/div\x3e";Voyant.notebook.util.Show.TARGET.insertHtml("beforeEnd",contents)}}},showError:function(error,more){var mode=Voyant.notebook.util.Show.MODE;Voyant.notebook.util.Show.MODE="error";if(this instanceof Voyant.util.ResponseError)error=this;if(error instanceof Voyant.util.ResponseError){if(console)console.error(error.getResponse());more=error.getResponse().responseText;error=error.getMsg()}else{if(error.stack&&
!more)more=error.stack;if(more&&Ext.isString(more)===false)more=more.toString()}if(console)console.error(error);if(more){if(console)console.error(more);error="\x3ch3\x3e"+error.toString()+"\x3c/h3\x3e\x3cpre\x3e"+Ext.String.htmlEncode(more)+"\x3c/pre\x3e"}show(error);Voyant.notebook.util.Show.MODE=mode},TARGET:null,MODE:"info",SINGLE_LINE_MODE:false}});String.prototype.show=Voyant.notebook.util.Show.show;var show=Voyant.notebook.util.Show.show;var showError=Voyant.notebook.util.Show.showError;Ext.define("Voyant.notebook.util.Embed",{transferable:["embed"],embed:function(){embed.apply(this,arguments)},constructor:function(config){var me=this},statics:{i18n:{},api:{embeddedParameters:undefined,embeddedConfig:undefined},embed:function(cmp,config){if(this.then)this.then(function(embedded){embed.call(embedded,cmp,config)});else if(Ext.isArray(cmp)){Voyant.notebook.util.Show.SINGLE_LINE_MODE=true;show("\x3ctable\x3e\x3ctr\x3e");cmp.forEach(function(embeddable){show("\x3ctd\x3e");if(Ext.isArray(embeddable))if(embeddable[0].embeddable)embeddable[0].embed.apply(embeddable[0],
embeddable.slice(1));else embed.apply(this,embeddable);else embed.apply(this,embeddable);show("\x3c/td\x3e")});show("\x3c/tr\x3e\x3c/table\x3e");Voyant.notebook.util.Show.SINGLE_LINE_MODE=false;return}else{if(this.embeddable&&(!cmp||Ext.isObject(cmp))){if(Ext.isObject(cmp))config=cmp;cmp=this.embeddable[0]}if(Ext.isString(cmp))cmp=Ext.ClassManager.getByAlias("widget."+cmp.toLowerCase())||Ext.ClassManager.get(cmp);var isEmbedded=false;if(Ext.isFunction(cmp)){var name=cmp.getName();if(this.embeddable&&
Ext.Array.each(this.embeddable,function(item){if(item==name){config=config||{};var embeddedParams={};for(key in Ext.ClassManager.get(Ext.getClassName(cmp)).api)if(key in config)embeddedParams[key]=config[key];if(!embeddedParams.corpus)if(Ext.getClassName(this)=="Voyant.data.model.Corpus")embeddedParams.corpus=this.getId();else if(this.getCorpus){var corpus=this.getCorpus();if(corpus)embeddedParams.corpus=this.getCorpus().getId()}Ext.applyIf(config,{style:"width: "+(config.width||"90%")+(Ext.isNumber(config.width)?
"px":"")+"; height: "+(config.height||"400px")+(Ext.isNumber(config.height)?"px":"")});delete config.width;delete config.height;var corpus=embeddedParams.corpus;delete embeddedParams.corpus;Ext.applyIf(embeddedParams,Voyant.application.getModifiedApiParams());var embeddedConfigParamEncodded=Ext.encode(embeddedParams);var embeddedConfigParam=encodeURIComponent(embeddedConfigParamEncodded);var iframeId=Ext.id();var url=Voyant.application.getBaseUrlFull()+"tool/"+name.substring(name.lastIndexOf(".")+
1)+"/?";if(true||embeddedConfigParam.length>1800){show('\x3ciframe style\x3d"'+config.style+'" id\x3d"'+iframeId+'" name\x3d"'+iframeId+'"\x3e\x3c/iframe\x3e');var dfd=Voyant.application.getDeferred(this);Ext.Ajax.request({url:Voyant.application.getTromboneUrl(),params:{tool:"resource.StoredResource",storeResource:embeddedConfigParam}}).then(function(response){var json=Ext.util.JSON.decode(response.responseText);var params={minimal:true,embeddedApiId:json.storedResource.id};if(corpus)params.corpus=
corpus;Ext.applyIf(params,Voyant.application.getModifiedApiParams());document.getElementById(iframeId).setAttribute("src",url+Ext.Object.toQueryString(params));dfd.resolve()}).otherwise(function(response){showError(response);dfd.reject()})}else show('\x3ciframe src\x3d"'+url+embeddedConfigParam+'" style\x3d"'+config.style+'" id\x3d"'+iframeId+'" name\x3d"'+iframeId+'"\x3e\x3c/iframe\x3e');isEmbedded=true;return false}},this)===true)Voyant.notebook.util.Embed.showWidgetNotRecognized.call(this);if(!isEmbedded){var embedded=
Ext.create(cmp,config);embedded.embed(config);isEmbedded=true}}if(!isEmbedded)Voyant.notebook.util.Embed.showWidgetNotRecognized.call(this)}},showWidgetNotRecognized:function(){var msg=Voyant.notebook.util.Embed.i18n.widgetNotRecognized;if(this.embeddable)msg+=Voyant.notebook.util.Embed.i18n.tryWidget+"\x3cul\x3e"+this.embeddable.map(function(cmp){var widget=cmp.substring(cmp.lastIndexOf(".")+1).toLowerCase();return"\"\x3ca href\x3d'../../docs/#!/guide/"+widget+"' target\x3d'voyantdocs'\x3e"+widget+
'\x3c/a\x3e"'}).join(", ")+"\x3c/ul\x3e";showError(msg)}}});embed=Voyant.notebook.util.Embed.embed;Ext.define("Voyant.data.model.AnalysisToken",{extend:"Ext.data.Model",idProperty:"term",fields:[{name:"term"},{name:"rawFreq",type:"int"},{name:"relativeFreq",type:"number"},{name:"cluster",type:"int"},{name:"clusterCenter",type:"boolean"},{name:"vector"}]});Ext.define("Voyant.data.model.Context",{extend:"Ext.data.Model",fields:[{name:"id"},{name:"docIndex","type":"int"},{name:"position","type":"int"},{name:"docId"},{name:"left"},{name:"keyword"},{name:"term"},{name:"right"}],getDocIndex:function(){return this.get("docIndex")},getLeft:function(){return this.get("left")},getMiddle:function(){return this.get("middle")},getHighlightedMiddle:function(){return"\x3cspan class\x3d'keyword'\x3e"+this.getMiddle()+"\x3c/span\x3e"},getRight:function(){return this.get("right")},
getPosition:function(){return this.get("position")},getHighlightedContext:function(){return this.getLeft()+this.getHighlightedMiddle()+this.getRight()}});Ext.define("Voyant.data.model.CorpusFacet",{extend:"Ext.data.Model",idProperty:"label",fields:[{name:"facet"},{name:"label"},{name:"inDocumentsCount",type:"int"}],getLabel:function(){return this.get("label")},getFacet:function(){return this.get("facet")},getInDocumentsCount:function(){return this.get("inDocumentsCount")}});Ext.define("Voyant.data.model.CorpusCollocate",{extend:"Ext.data.Model",fields:[{name:"term"},{name:"rawFreq",type:"int"},{name:"contextTerm"},{name:"contextTermRawFreq",type:"int"}],getTerm:function(){return this.getKeyword()},getRawFreq:function(){return this.getKeywordRawFreq()},getKeyword:function(){return this.get("term")},getKeywordRawFreq:function(){return this.get("rawFreq")},getContextTerm:function(){return this.get("contextTerm")},getContextTermRawFreq:function(){return this.get("contextTermRawFreq")}});Ext.define("Voyant.data.model.CorpusTerm",{extend:"Ext.data.Model",idProperty:"term",fields:[{name:"id"},{name:"rawFreq",type:"int"},{name:"inDocumentsCount",type:"int"},{name:"relativeFreq",type:"float"},{name:"relativePeakedness",type:"float"},{name:"relativeSkewness",type:"float"},{name:"comparisonRelativeFreqDifference",type:"float"},{name:"distributions"},{name:"typeTokenRatio-lexical",type:"float",calculate:function(data){return data["typesCount-lexical"]/data["tokensCount-lexical"]}}],getTerm:function(){return this.get("term")},
getRawFreq:function(){return parseInt(this.get("rawFreq"))},getInDocumentsCount:function(){return parseInt(this.get("inDocumentsCount"))},getDistributions:function(){return this.get("distributions")},show:function(config){show(this.getString(config))},getString:function(){return this.getTerm()+": "+this.getRawFreq()}});Ext.define("Voyant.data.model.CorpusNgram",{extend:"Ext.data.Model",fields:[{name:"term"},{name:"length",type:"int"},{name:"rawFreq",type:"int"},{name:"distributions"}],getTerm:function(){return this.get("term")}});Ext.define("Voyant.data.model.Dimension",{extend:"Ext.data.Model",fields:[{name:"percentage",type:"number"}]});Ext.define("Voyant.data.model.Document",{extend:"Ext.data.Model",fields:[{name:"corpus"},{name:"id"},{name:"pubDate"},{name:"publisher"},{name:"pubPlace"},{name:"keyword"},{name:"collection"},{name:"index",type:"int"},{name:"tokensCount-lexical",type:"int"},{name:"typesCount-lexical",type:"int"},{name:"typeTokenRatio-lexical",type:"float",calculate:function(data){return data["typesCount-lexical"]/data["tokensCount-lexical"]}},{name:"lastTokenStartOffset-lexical",type:"int"},{name:"title"},{name:"language",
convert:function(data){return Ext.isEmpty(data)?"":data}},{name:"sentencesCount",type:"int"},{name:"averageWordsPerSentence",type:"float",calculate:function(data){return data["sentencesCount"]?data["tokensCount-lexical"]/data["sentencesCount"]:0}},{name:"css",type:"string"}],getLexicalTokensCount:function(){return this.get("tokensCount-lexical")},getLexicalTypeTokenRatio:function(){return this.get("typeTokenRatio-lexical")},loadDocumentTerms:function(config){if(this.then)return Voyant.application.getDeferredNestedPromise(this,
arguments);else{var dfd=Voyant.application.getDeferred(this);config=config||{};if(Ext.isNumber(config))config={limit:config};Ext.applyIf(config,{limit:0});var documentTerms=this.getDocumentTerms();documentTerms.load({params:config,callback:function(records,operation,success){if(success)dfd.resolve(documentTerms);else dfd.reject(operation)}});return dfd.promise}},loadTokens:function(config){if(this.then)return Voyant.application.getDeferredNestedPromise(this,arguments);else{var dfd=Voyant.application.getDeferred(this);
config=config||{};if(Ext.isNumber(config))config={limit:config};Ext.applyIf(config,{limit:0});var tokens=this.getTokens({});tokens.load({params:config,callback:function(records,operation,success){if(success)dfd.resolve(tokens);else dfd.reject(operation)}});return dfd.promise}},getTokens:function(config){if(this.then)return Voyant.application.getDeferredNestedPromise(this,arguments);else{config=config||{};Ext.applyIf(config,{proxy:{}});Ext.applyIf(config.proxy,{extraParams:{}});Ext.applyIf(config.proxy.extraParams,
{docIndex:this.get("index")});Ext.apply(config,{docId:this.get("id")});return this.get("corpus").getTokens(config)}},getDocumentTerms:function(config){if(this.then)return Voyant.application.getDeferredNestedPromise(this,arguments);else{config=config||{};Ext.applyIf(config,{proxy:{}});Ext.applyIf(config.proxy,{extraParams:{}});Ext.applyIf(config.proxy.extraParams,{docIndex:this.get("index")});if(config.corpus)return config.corpus.getDocumentTerms(config);return this.get("corpus").getDocumentTerms(config)}},
getIndex:function(){return this.get("index")},getId:function(){return this.get("id")},getFullLabel:function(){var author=this.getAuthor();return this.getTitle()+(author?"("+author+")":"")},getTitle:function(){var title=this.get("title");if(title===undefined)title="";title=Ext.isArray(title)?title.join("; "):title;title=title.trim().replace(/\s+/g," ");return title},getTruncated:function(string,max){if(string.length>max){var slash=string.lastIndexOf("/");if(slash>-1)string=string.substr(slash+1);if(string.length>
max){var space=string.indexOf(" ",max-5);if(space<0||space>max)space=max;string=string.substring(0,space)+"\u2026"}}return string},getShortTitle:function(){var title=this.getTitle();title=title.replace(/\.(html?|txt|xml|docx?|pdf|rtf|\/)$/,"");title=title.replace(/^(the|a|le|l'|un|une)\s/,"");return this.getTruncated(title,25)},getTinyTitle:function(){return this.getTruncated(this.getShortTitle(),10)},getShortLabel:function(){var author=this.getAuthor(25);return parseInt(this.getIndex())+1+") \x3ci\x3e"+
this.getShortTitle()+"\x3c/i\x3e"+(author?" ("+author+")":"")},getTinyLabel:function(){return parseInt(this.getIndex())+1+") "+this.getTinyTitle()},getPubDate:function(){return this.get("pubDate")},getPublisher:function(){return this.get("publisher")},getPubPlace:function(){return this.get("pubPlace")},getKeyword:function(){return this.getMultiple("keyword")},getCollection:function(){return this.getMultiple("collection")},getAuthor:function(max){this.getMultiple("author")},getMultiple:function(field,
max){var val=this.get(field)||"";val=Ext.isArray(val)?val.join("; "):val;val=val.trim().replace(/\s+/g," ");return max?this.getTruncated(author,max):val},getCorpusId:function(){return this.get("corpus").getAliasOrId()},isPlainText:function(){if(this.get("extra.Content-Type")&&(new RegExp("plain","i")).test(this.get("extra.Content-Type")))return true;return false},getAverageWordsPerSentence:function(){return this.get("averageWordsPerSentence")},show:function(){show(this.getFullLabel())},getCorpus:function(){return this.get("corpus")},
getText:function(config){if(this.then)return Voyant.application.getDeferredNestedPromise(this,arguments);else{var dfd=Voyant.application.getDeferred(this);config=config||{};Ext.apply(config,{tool:"corpus.DocumentTokens",corpus:this.getCorpusId()});this.getTokens(config).then(function(tokens){dfd.resolve(tokens)});return dfd.promise}},getPlainText:function(config){if(this.then)return Voyant.application.getDeferredNestedPromise(this,arguments);else{config=config||{};Ext.apply(config,{outputFormat:"text",
template:"docTokens2text",noOthers:true});return this.getText()}},getLemmasArray:function(config){config=config||{};config.docId=this.getId();return this.getCorpus().getLemmasArray(config)},getEntities:function(config){config=config||{};Ext.applyIf(config,{proxy:{}});Ext.applyIf(config.proxy,{extraParams:{}});Ext.applyIf(config.proxy.extraParams,{docIndex:this.get("index")});return Ext.create("Voyant.data.store.DocumentEntities",Ext.apply(config,{corpus:this.getCorpus(),docId:this.getId()}))},loadEntities:function(config){var me=
this;if(this.then)return Voyant.application.getDeferredNestedPromise(this,arguments);else{var dfd=Voyant.application.getDeferred(this);this.getEntities().load({params:config,callback:function(records,operation,success){if(success)dfd.resolve(records);else dfd.reject(operation.error.response)}});return dfd.promise}},getCSS:function(){return this.get("css")||this.get("parent_css")}});Ext.define("Voyant.data.model.DocumentEntity",{extend:"Ext.data.Model",fields:[{name:"term"},{name:"docIndex","type":"int"},{name:"rawFreq",type:"int"},{name:"type"},{name:"positions"}],getTerm:function(){return this.get("term")},getDocIndex:function(){return this.get("docIndex")},getRawFreq:function(){return this.get("rawFreq")},getPositions:function(){return this.get("positions")}});Ext.define("Voyant.data.model.DocumentQueryMatch",{extend:"Ext.data.Model",fields:[{name:"id"},{name:"count","type":"int"},{name:"query"},{name:"distributions"}],getCount:function(){return this.get("count")},getDistributions:function(){return this.get("distributions")},getDocIds:function(){return this.get("docIds")}});Ext.define("Voyant.data.model.DocumentTerm",{extend:"Ext.data.Model",fields:[{name:"id"},{name:"term"},{name:"docIndex","type":"int"},{name:"docId"},{name:"rawFreq",type:"int"},{name:"relativeFreq",type:"float"},{name:"tfidf",type:"float"},{name:"zscore",type:"float"},{name:"zscoreRatio",type:"float"},{name:"distributions"}],getTerm:function(){return this.get("term")},getDocIndex:function(){return this.get("docIndex")},getRawFreq:function(){return this.get("rawFreq")},getRelativeFreq:function(){return this.get("relativeFreq")},
getDistributions:function(){return this.get("distributions")}});Ext.define("Voyant.data.model.PrincipalComponent",{extend:"Ext.data.Model",fields:[{name:"eigenValue",type:"number"},{name:"eigenVectors"}]});Ext.define("Voyant.data.model.RelatedTerm",{extend:"Ext.data.Model",fields:[{name:"source"},{name:"target"},{name:"rawFreq",type:"int"}],getSource:function(){return this.get("source")},getTarget:function(){return this.get("target")},show:function(config){show(this.getString(config))},getString:function(){return this.getSource()+"-"+this.getTarget()}});Ext.define("Voyant.data.model.StatisticalAnalysis",{extend:"Ext.data.Model",requires:["Voyant.data.model.PrincipalComponent","Voyant.data.model.Dimension","Voyant.data.model.AnalysisToken"],fields:[{name:"id"}],getPrincipalComponents:function(){var pcs=[];this.data.principalComponents.forEach(function(pc){pcs.push(Ext.create("Voyant.data.model.PrincipalComponent",pc))});return pcs},getDimensions:function(){var dimensions=[];this.data.dimensions.forEach(function(dim){dimensions.push(Ext.create("Voyant.data.model.Dimension",
{percentage:dim}))});return dimensions},getTokens:function(){var tokens=[];this.data.tokens.forEach(function(tok){tokens.push(Ext.create("Voyant.data.model.AnalysisToken",tok))});return tokens}});Ext.define("Voyant.data.model.Token",{extend:"Ext.data.Model",fields:[{name:"id"},{name:"docId"},{name:"docIndex",type:"int"},{name:"token"},{name:"rawFreq"},{name:"tokenType"},{name:"position",type:"int"},{name:"startOffset",type:"int"},{name:"endOffset",type:"int"}],statics:{getInfoFromElement:function(arg){if(arg&&arg.getId){var parts=arg.getId().split("_");return{docIndex:parseInt(parts[1]),position:parseInt(parts[2])}}}},isWord:function(){return this.getTokenType()=="lexical"},isStopword:function(){return this.get("stopword")==
"true"},getTokenType:function(){return this.get("tokenType")},getId:function(){return["",this.getDocIndex(),this.getPosition()].join("_")},getDocIndex:function(){return this.get("docIndex")},getDocId:function(){return this.get("docId")},getTerm:function(){return this.get("term")},getTermWithLineSpacing:function(isPlainText){var term=this.getTerm().replace(/<\/?\w+\b.*?>/g,"\x3cbr /\x3e\x3cbr /\x3e").replace(/>\s+</g,"\x3e\x3c").replace(/<br \/><br \/>(<br \/>)+/g,"\x3cbr /\x3e\x3cbr /\x3e");if(isPlainText)term=
term.replace(/(\r\n|\r|\n)\s*/g,"\x3cbr /\x3e");return term},getPosition:function(){return this.get("position")},getDocumentRawFreq:function(){return this.get("rawFreq")}});Ext.define("Voyant.data.model.TermCorrelation",{extend:"Ext.data.Model",fields:[{name:"source"},{name:"target"},{name:"correlation",type:"float"},{name:"significance",type:"float"},{name:"source-term",calculate:function(data){return data.source.term}},{name:"target-term",calculate:function(data){return data.target.term}},{name:"source-distributions",calculate:function(data){return data.source.distributions}},{name:"target-distributions",calculate:function(data){return data.target.distributions}}],
getSource:function(){return this.get("source")},getTarget:function(){return this.get("target")},show:function(config){show(this.getString(config))},getString:function(){return this.getSource()+"-"+this.getTarget()}});Ext.define("Voyant.data.store.VoyantStore",{mixins:["Voyant.util.Localization","Voyant.notebook.util.Embed"],config:{corpus:undefined,parentPanel:undefined},constructor:function(config,extras){var me=this;config=config||{};Ext.applyIf(config,{remoteSort:true,autoLoad:false,pagePurgeCount:0,pageSize:100,leadingBufferZone:200});config.proxy=config.proxy||{};Ext.applyIf(config.proxy,{type:"ajax",url:Voyant.application.getTromboneUrl(),actionMethods:{read:"POST"},reader:{type:"json",rootProperty:extras["proxy.reader.rootProperty"],
totalProperty:extras["proxy.reader.totalProperty"],metaProperty:extras["proxy.reader.metaProperty"]||"metaData"},simpleSortMode:true,listeners:{exception:function(proxy,request,operation){if(me.parentPanel&&me.parentPanel.showError)me.parentPanel.showError(operation)}}});config.proxy.extraParams=config.proxy.extraParams||{};Ext.applyIf(config.proxy.extraParams,{tool:extras["proxy.extraParams.tool"]});if(config.parentPanel!==undefined){Ext.applyIf(config.proxy.extraParams,{forTool:config.parentPanel.xtype});
this.setParentPanel(config.parentPanel);config.parentPanel.on("loadedCorpus",function(src,corpus){this.setCorpus(corpus)},this);config.listeners=config.listeners||{};config.listeners.beforeload={fn:function(store,operation){var parent=this.getParentPanel(),proxy=store.getProxy();if(parent!==undefined){var params=parent.getApiParams();operation=operation?operation===1?{}:operation:{};operation.params=operation.params||{};if(proxy&&this.isBufferedStore){Ext.Array.from(this.previouslySetExtraParams).forEach(function(key){proxy.setExtraParam(key,
undefined)});this.previouslySetExtraParams=[]}for(var key in params){if(proxy&&this.isBufferedStore){this.previouslySetExtraParams.push(key);proxy.setExtraParam(key,params[key])}operation.params[key]=params[key]}}},scope:this}}Ext.apply(this,config)},setCorpus:function(corpus){if(corpus&&this.getProxy&&this.getProxy())this.getProxy().setExtraParam("corpus",Ext.isString(corpus)?corpus:corpus.getId());this.callParent(arguments)},getString:function(config){var count=this.getCount();return"This store contains "+
this.getCount()+" items"+(count>0?" with these fields: "+this.getAt(0).getFields().map(function(field){return field.getName()}).join(", "):"")+"."},embed:function(cmp,config){if(!config&&Ext.isObject(cmp)){config=cmp;cmp=this.embeddable[0]}config=config||{};var data=[];this.each(function(record){data.push(record.data)},this);Ext.apply(config,{storeJson:JSON.stringify({storeClass:Ext.getClassName(this),storeData:data})});embed.call(this,cmp,config)}});Ext.define("Voyant.data.store.CAAnalysisMixin",{mixins:["Voyant.data.store.VoyantStore"],embeddable:["Voyant.panel.ScatterPlot"],model:"Voyant.data.model.StatisticalAnalysis",constructor:function(config){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[config,{"proxy.extraParams.tool":"corpus.CA","proxy.reader.rootProperty":"correspondenceAnalysis","proxy.reader.totalProperty":"correspondenceAnalysis.totalTerms"}]);config.proxy.extraParams.withDistributions=true}});
Ext.define("Voyant.data.store.CAAnalysis",{extend:"Ext.data.Store",mixins:["Voyant.data.store.CAAnalysisMixin"],constructor:function(config){config=config||{};this.mixins["Voyant.data.store.CAAnalysisMixin"].constructor.apply(this,[config]);this.callParent([config])}});
Ext.define("Voyant.data.store.CAAnalysisBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.CAAnalysisMixin"],constructor:function(config){config=config||{};this.mixins["Voyant.data.store.CAAnalysisMixin"].constructor.apply(this,[config]);this.callParent([config])}});Ext.define("Voyant.data.store.ContextsMixin",{mixins:["Voyant.data.store.VoyantStore"],model:"Voyant.data.model.Context",constructor:function(config){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[config,{"proxy.extraParams.tool":"corpus.DocumentContexts","proxy.reader.rootProperty":"documentContexts.contexts","proxy.reader.totalProperty":"documentContexts.total"}])}});
Ext.define("Voyant.data.store.Contexts",{extend:"Ext.data.Store",mixins:["Voyant.data.store.ContextsMixin"],constructor:function(config){config=config||{};this.mixins["Voyant.data.store.ContextsMixin"].constructor.apply(this,[config]);this.callParent([config])}});
Ext.define("Voyant.data.store.ContextsBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.ContextsMixin"],constructor:function(config){config=config||{};this.mixins["Voyant.data.store.ContextsMixin"].constructor.apply(this,[config]);this.callParent([config])}});Ext.define("Voyant.data.store.CorpusCollocatesMixin",{mixins:["Voyant.data.store.VoyantStore"],model:"Voyant.data.model.CorpusCollocate",constructor:function(config){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[config,{"proxy.extraParams.tool":"corpus.CorpusCollocates","proxy.reader.rootProperty":"corpusCollocates.collocates","proxy.reader.totalProperty":"corpusCollocates.total"}])}});
Ext.define("Voyant.data.store.CorpusCollocates",{extend:"Ext.data.Store",mixins:["Voyant.data.store.CorpusCollocatesMixin"],constructor:function(config){config=config||{};this.mixins["Voyant.data.store.CorpusCollocatesMixin"].constructor.apply(this,[config]);this.callParent([config])}});
Ext.define("Voyant.data.store.CorpusCollocatesBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.CorpusCollocatesMixin"],constructor:function(config){config=config||{};this.mixins["Voyant.data.store.CorpusCollocatesMixin"].constructor.apply(this,[config]);this.callParent([config])}});Ext.define("Voyant.data.store.CorpusFacetsMixin",{mixins:["Voyant.data.store.VoyantStore"],model:Voyant.data.model.CorpusFacet,constructor:function(config){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[config,{"proxy.extraParams.tool":"corpus.CorpusFacets","proxy.reader.rootProperty":"corpusFacets.facets","proxy.reader.totalProperty":"corpusFacets.total"}])}});
Ext.define("Voyant.data.store.CorpusFacets",{extend:"Ext.data.Store",mixins:["Voyant.data.store.CorpusFacetsMixin"],constructor:function(config){config=config||{};this.mixins["Voyant.data.store.CorpusFacetsMixin"].constructor.apply(this,[config]);this.callParent([config])}});
Ext.define("Voyant.data.store.CorpusFacetsBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.CorpusFacetsMixin"],constructor:function(config){config=config||{};this.mixins["Voyant.data.store.CorpusFacetsMixin"].constructor.apply(this,[config]);this.callParent([config])}});Ext.define("Voyant.data.store.CorpusTermsMixin",{mixins:["Voyant.data.store.VoyantStore"],model:Voyant.data.model.CorpusTerm,constructor:function(config){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[config,{"proxy.extraParams.tool":"corpus.CorpusTerms","proxy.reader.rootProperty":"corpusTerms.terms","proxy.reader.totalProperty":"corpusTerms.total"}])},show:function(config){show(this.getString(config))}});
Ext.define("Voyant.data.store.CorpusTerms",{extend:"Ext.data.Store",mixins:["Voyant.data.store.CorpusTermsMixin"],model:Voyant.data.model.CorpusTerm,constructor:function(config){config=config||{};this.mixins["Voyant.data.store.CorpusTermsMixin"].constructor.apply(this,[config]);this.callParent([config])}});
Ext.define("Voyant.data.store.CorpusTermsBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.CorpusTermsMixin"],model:Voyant.data.model.CorpusTerm,constructor:function(config){config=config||{};this.mixins["Voyant.data.store.CorpusTermsMixin"].constructor.apply(this,[config]);this.callParent([config])}});Ext.define("Voyant.data.store.DocumentQueryMatchesMixin",{mixins:["Voyant.data.store.VoyantStore"],model:"Voyant.data.model.DocumentQueryMatch",constructor:function(config){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[config,{"proxy.extraParams.tool":"corpus.DocumentsFinder","proxy.reader.rootProperty":"documentsFinder.queries","proxy.reader.totalProperty":undefined,"proxy.reader.metaProperty":"documentsFinder.corpus"}])}});
Ext.define("Voyant.data.store.DocumentQueryMatches",{extend:"Ext.data.Store",mixins:["Voyant.data.store.DocumentQueryMatchesMixin"],constructor:function(config){config=config||{};this.mixins["Voyant.data.store.DocumentQueryMatchesMixin"].constructor.apply(this,[config]);this.callParent([config])}});
Ext.define("Voyant.data.store.DocumentQueryMatchesBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.DocumentQueryMatchesMixin"],constructor:function(config){config=config||{};this.mixins["Voyant.data.store.DocumentQueryMatchesMixin"].constructor.apply(this,[config]);this.callParent([config])}});Ext.define("Voyant.data.store.DocumentTermsMixin",{mixins:["Voyant.data.store.VoyantStore"],model:"Voyant.data.model.DocumentTerm",constructor:function(config){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[config,{"proxy.extraParams.tool":"corpus.DocumentTerms","proxy.reader.rootProperty":"documentTerms.terms","proxy.reader.totalProperty":"documentTerms.total"}])}});
Ext.define("Voyant.data.store.DocumentTerms",{extend:"Ext.data.Store",mixins:["Voyant.data.store.DocumentTermsMixin"],constructor:function(config){config=config||{};this.mixins["Voyant.data.store.DocumentTermsMixin"].constructor.apply(this,[config]);this.callParent([config])}});
Ext.define("Voyant.data.store.DocumentTermsBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.DocumentTermsMixin"],constructor:function(config){config=config||{};this.mixins["Voyant.data.store.DocumentTermsMixin"].constructor.apply(this,[config]);this.callParent([config])}});Ext.define("Voyant.data.store.DocumentEntitiesMixin",{mixins:["Voyant.data.store.VoyantStore"],model:"Voyant.data.model.DocumentEntity",constructor:function(config){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[config,{"proxy.extraParams.tool":"corpus.DocumentEntities","proxy.reader.rootProperty":"documentEntities.entities","proxy.reader.totalProperty":"documentEntities.total"}])}});
Ext.define("Voyant.data.store.DocumentEntities",{extend:"Ext.data.Store",mixins:["Voyant.data.store.DocumentEntitiesMixin"],constructor:function(config){config=config||{};this.mixins["Voyant.data.store.DocumentEntitiesMixin"].constructor.apply(this,[config]);this.callParent([config])}});
Ext.define("Voyant.data.store.DocumentEntitiesBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.DocumentEntitiesMixin"],constructor:function(config){config=config||{};this.mixins["Voyant.data.store.DocumentEntitiesMixin"].constructor.apply(this,[config]);this.callParent([config])}});Ext.define("Voyant.data.store.DocumentsMixin",{mixins:["Voyant.data.store.VoyantStore"],model:"Voyant.data.model.Document",statics:{i18n:{}},sorters:{property:"index",direction:"ASC"},remoteSort:true,constructor:function(config){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[config,{"proxy.extraParams.tool":"corpus.DocumentsMetadata","proxy.reader.rootProperty":"documentsMetadata.documents","proxy.reader.totalProperty":"documentsMetadata.total"}])},listeners:{load:function(store,
records,successful,opts){if(successful){var corpus=store.getCorpus();records.forEach(function(record){record.set("corpus",corpus)})}}},getDocument:function(config){return Ext.isNumber(config)?this.getAt(config):this.getById(config)}});
Ext.define("Voyant.data.store.Documents",{extend:"Ext.data.Store",mixins:["Voyant.data.store.DocumentsMixin"],model:"Voyant.data.model.Document",constructor:function(config){config=config||{};this.mixins["Voyant.data.store.DocumentsMixin"].constructor.apply(this,[config]);this.callParent([config])}});
Ext.define("Voyant.data.store.DocumentsBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.DocumentsMixin"],model:"Voyant.data.model.Document",constructor:function(config){config=config||{};this.mixins["Voyant.data.store.DocumentsMixin"].constructor.apply(this,[config]);this.callParent([config])}});Ext.define("Voyant.data.store.PCAAnalysisMixin",{mixins:["Voyant.data.store.VoyantStore"],embeddable:["Voyant.panel.ScatterPlot"],model:"Voyant.data.model.StatisticalAnalysis",constructor:function(config){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[config,{"proxy.extraParams.tool":"corpus.PCA","proxy.reader.rootProperty":"pcaAnalysis","proxy.reader.totalProperty":"pcaAnalysis.totalTerms"}]);config.proxy.extraParams.withDistributions=true}});
Ext.define("Voyant.data.store.PCAAnalysis",{extend:"Ext.data.Store",mixins:["Voyant.data.store.PCAAnalysisMixin"],constructor:function(config){config=config||{};this.mixins["Voyant.data.store.PCAAnalysisMixin"].constructor.apply(this,[config]);this.callParent([config])}});
Ext.define("Voyant.data.store.PCAAnalysisBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.PCAAnalysisMixin"],constructor:function(config){config=config||{};this.mixins["Voyant.data.store.PCAAnalysisMixin"].constructor.apply(this,[config]);this.callParent([config])}});Ext.define("Voyant.data.store.DocSimAnalysisMixin",{mixins:["Voyant.data.store.VoyantStore"],model:"Voyant.data.model.StatisticalAnalysis",constructor:function(config){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[config,{"proxy.extraParams.tool":"corpus.DocumentSimilarity","proxy.reader.rootProperty":"documentSimilarity","proxy.reader.totalProperty":"documentSimilarity.total"}]);config.proxy.extraParams.withDistributions=true}});
Ext.define("Voyant.data.store.DocSimAnalysis",{extend:"Ext.data.Store",mixins:["Voyant.data.store.DocSimAnalysisMixin"],constructor:function(config){config=config||{};this.mixins["Voyant.data.store.DocSimAnalysisMixin"].constructor.apply(this,[config]);this.callParent([config])}});
Ext.define("Voyant.data.store.DocSimAnalysisBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.DocSimAnalysisMixin"],constructor:function(config){config=config||{};this.mixins["Voyant.data.store.DocSimAnalysisMixin"].constructor.apply(this,[config]);this.callParent([config])}});Ext.define("Voyant.data.store.CorpusNgramsMixin",{mixins:["Voyant.data.store.VoyantStore"],model:"Voyant.data.model.CorpusNgram",constructor:function(config){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[config,{"proxy.extraParams.tool":"corpus.CorpusNgrams","proxy.reader.rootProperty":"corpusNgrams.ngrams","proxy.reader.totalProperty":"corpusNgrams.total"}])}});
Ext.define("Voyant.data.store.CorpusNgrams",{extend:"Ext.data.Store",mixins:["Voyant.data.store.CorpusNgramsMixin"],constructor:function(config){config=config||{};this.mixins["Voyant.data.store.CorpusNgramsMixin"].constructor.apply(this,[config]);this.callParent([config])}});
Ext.define("Voyant.data.store.CorpusNgramsBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.CorpusNgramsMixin"],constructor:function(config){config=config||{};this.mixins["Voyant.data.store.CorpusNgramsMixin"].constructor.apply(this,[config]);this.callParent([config])}});Ext.define("Voyant.data.store.RelatedTermsMixin",{mixins:["Voyant.data.store.VoyantStore"],model:"Voyant.data.model.RelatedTerm",constructor:function(config){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[config,{"proxy.extraParams.tool":"corpus.SemanticGraph","proxy.reader.rootProperty":"semanticGraph.edges","proxy.reader.totalProperty":"semanticGraph.total"}])}});
Ext.define("Voyant.data.store.RelatedTerms",{extend:"Ext.data.Store",mixins:["Voyant.data.store.RelatedTermsMixin"],constructor:function(config){config=config||{};this.mixins["Voyant.data.store.RelatedTermsMixin"].constructor.apply(this,[config]);this.callParent([config])}});
Ext.define("Voyant.data.store.RelatedTermsBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.RelatedTermsMixin"],constructor:function(config){config=config||{};this.mixins["Voyant.data.store.RelatedTermsMixin"].constructor.apply(this,[config]);this.callParent([config])}});Ext.define("Voyant.data.store.TermCorrelationsMixin",{mixins:["Voyant.data.store.VoyantStore"],model:"Voyant.data.model.TermCorrelation",constructor:function(config){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[config,{"proxy.extraParams.tool":"corpus.CorpusTermCorrelations","proxy.extraParams.withDistributions":"true","proxy.reader.rootProperty":"termCorrelations.correlations","proxy.reader.totalProperty":"termCorrelations.total"}])}});
Ext.define("Voyant.data.store.TermCorrelations",{extend:"Ext.data.Store",mixins:["Voyant.data.store.TermCorrelationsMixin"],constructor:function(config){config=config||{};this.mixins["Voyant.data.store.TermCorrelationsMixin"].constructor.apply(this,[config]);this.callParent([config])}});
Ext.define("Voyant.data.store.TermCorrelationsBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.TermCorrelationsMixin"],constructor:function(config){config=config||{};this.mixins["Voyant.data.store.TermCorrelationsMixin"].constructor.apply(this,[config]);this.callParent([config])}});Ext.define("Voyant.data.store.TokensMixin",{mixins:["Voyant.data.store.VoyantStore"],model:"Voyant.data.model.Token",constructor:function(config){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[config,{"proxy.extraParams.tool":"corpus.DocumentTokens","proxy.reader.rootProperty":"documentTokens.tokens","proxy.reader.totalProperty":"documentTokens.total"}])}});
Ext.define("Voyant.data.store.Tokens",{extend:"Ext.data.Store",mixins:["Voyant.data.store.TokensMixin"],constructor:function(config){config=config||{};this.mixins["Voyant.data.store.TokensMixin"].constructor.apply(this,[config]);this.callParent([config])}});
Ext.define("Voyant.data.store.TokensBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.TokensMixin"],constructor:function(config){config=config||{};this.mixins["Voyant.data.store.TokensMixin"].constructor.apply(this,[config]);this.callParent([config])}});Ext.define("Voyant.data.store.TSNEAnalysisMixin",{mixins:["Voyant.data.store.VoyantStore"],embeddable:["Voyant.panel.ScatterPlot"],model:"Voyant.data.model.StatisticalAnalysis",constructor:function(config){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[config,{"proxy.extraParams.tool":"corpus.TSNE","proxy.reader.rootProperty":"tsneAnalysis","proxy.reader.totalProperty":"tsneAnalysis.totalTerms"}]);config.proxy.extraParams.withDistributions=true;config.proxy.extraParams.noCache=
1}});Ext.define("Voyant.data.store.TSNEAnalysis",{extend:"Ext.data.Store",mixins:["Voyant.data.store.TSNEAnalysisMixin"],constructor:function(config){config=config||{};this.mixins["Voyant.data.store.TSNEAnalysisMixin"].constructor.apply(this,[config]);this.callParent([config])}});
Ext.define("Voyant.data.store.TSNEAnalysisBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.TSNEAnalysisMixin"],constructor:function(config){config=config||{};this.mixins["Voyant.data.store.TSNEAnalysisMixin"].constructor.apply(this,[config]);this.callParent([config])}});Ext.define("Voyant.data.table.Table",{alternateClassName:["VoyantTable"],mixins:["Voyant.notebook.util.Embed","Voyant.notebook.util.Show"],embeddable:["Voyant.widget.VoyantTableTransform","Voyant.widget.VoyantChart","Voyant.widget.CodeEditor"],config:{rows:[],headers:[],rowsMap:{},headersMap:{},rowKey:undefined,model:undefined},clone:function(){var table=new VoyantTable;table.setRows(Ext.clone(this.getRows()));table.setHeaders(Ext.clone(this.getHeaders()));table.setRowsMap(Ext.clone(this.getRowsMap()));
table.setHeadersMap(Ext.clone(this.getHeadersMap()));table.setRowKey(Ext.clone(this.getRowKey()));return table},constructor:function(config,opts){config=config||{};if(config.fromBlock){var data=Voyant.notebook.Notebook.getDataFromBlock(config.fromBlock);if(data){data=data.trim();config.rows=[];data.split(/\n+/).forEach(function(line,i){var cells=line.split("\t");if(i==0&&!config.noHeaders)config.headers=cells;else config.rows.push(cells)})}}else if(config.count&&Ext.isArray(config.count)){var freqs=
{};config.count.forEach(function(item){freqs[item]=freqs[item]?freqs[item]+1:1});var counts=[];for(var key in freqs)counts.push([key,freqs[key]]);counts.sort(function(a,b){return b[1]-a[1]});if(config.limit&&counts.length>config.limit)counts.splice(config.limit);if(config.orientation&&config.orientation=="horizontal"){config.headers=counts.map(function(item){return item[0]});config.rows=[counts.map(function(item){return item[1]})]}else{config.headers=config.headers?config.headers:["Item","Count"];
config.rows=counts}}else if(config.isStore||config.store){var store=config.store?config.store:config;if(opts&&opts.headers)config.headers=opts.headers;else{var record=store.getAt(0);if(record)config.headers=record.getFields().map(function(field){return field.getName()})}config.rows=[];store.each(function(record){var data=record.getData();var cells=config.headers.map(function(header){return data[header]});config.rows.push(cells)},this)}if(!config.rows&&Ext.isArray(config))config.rows=config;if(!this.getHeaders())if(!config.headers&&
!config.noHeaders&&config.rows)this.setHeaders(config.rows.shift());else this.setHeaders(Ext.Array.from(config.headers));this.setRows(Ext.Array.from(config.rows));this.setRowKey(config.rowKey?config.rowKey:this.getHeaders()[0]);if(this.getHeaders().length==0){var firstRow=this.getRow(0,false);if(firstRow)this.setHeaders(firstRow.map(function(cell,i){return i}))}var headersMap={};this.getHeaders().forEach(function(header,i){headersMap[header]=i});this.setHeadersMap(headersMap);this.reMapRows();this.callParent()},
addRow:function(row){if(Ext.isArray(row))if(Ext.isObject(row)){var len=this.getRows().length;for(var key in row)this.updateCell(len,key,row[key])}else if(Ext.isArray(row)){this.getRows().push(row);var header=this.getColumnIndex(this.getRowKey());if(header!==undefined&&row[header]!==undefined)this.getRowsMap()[row[header]]=this.getRows().length-1}},eachRecord:function(fn,scope){var item,i=0,len=this.getRows().length;for(;i<len;i++){item=this.getRecord(i);if(fn.call(scope||item,item,i,len)===false)break}},
eachRow:function(fn,asMap,scope){var item,i=0,len=this.getRows().length;for(;i<len;i++){item=this.getRow(i,asMap);if(fn.call(scope||item,item,i,len)===false)break}},getRow:function(index,asMap){var r=this.getRowIndex(index);if(asMap){var row={};var headers=this.getHeaders();Ext.Array.from(this.getRows()[r]).forEach(function(item,i){row[headers[i]||i]=item},this);return row}else return this.getRows()[r]},getRecord:function(index){if(this.model)return new this.model(this.getRow(index,true))},mapRows:function(fn,
asMap,scope){var rows=[];this.eachRow(function(row,i){rows.push(fn.call(scope||this,row,i))},asMap,this);return rows},updateCell:function(row,column,value,replace){var rows=this.getRows();var r=Ext.isNumber(row)?row:this.getRowIndex(row);var c=this.getColumnIndex(column);if(rows[r]===undefined)rows[r]=[];if(rows[r][c]===undefined||replace)rows[r][c]=value;else rows[r][c]+=value;if(this.getHeaders()[c]===this.getRowKey())this.getRowsMap()[column]=r},getRowIndex:function(key){if(Ext.isNumber(key))return key;
if(Ext.isString(key)){var rowsMap=this.getRowsMap();if(!(key in rowsMap)){rowsMap[key]=this.getRows().length;this.getRows().push(new Array(this.getHeaders().length))}return rowsMap[key]}},getColumnIndex:function(column){var headers=this.getHeaders();if(Ext.isNumber(column)){if(headers[column]===undefined){headers[column]=column;this.getRows().forEach(function(row){row.splice(column,0,undefined)})}return column}else if(Ext.isString(column)){if(!(column in this.getHeadersMap())){this.getHeaders().push(column);
this.getHeadersMap()[column]=this.getHeaders().length-1;this.getRows().forEach(function(row){row.push(undefined)})}return this.getHeadersMap()[column]}},getColumnHeader:function(column){var c=this.getColumnIndex(column);return this.getHeaders()[c]},getColumnSum:function(column){return Ext.Array.sum(this.getColumnValues(column,true))},getColumnMean:function(column){return Ext.Array.mean(this.getColumnValues(column,true))},getColumnMax:function(column){return Ext.Array.max(this.getColumnValues(column,
true))},getColumnMin:function(column){return Ext.Array.min(this.getColumnValues(column,true))},getColumnValues:function(column,clean){var c=this.getColumnIndex(column),vals=[];this.eachRow(function(row){vals.push(row[c])});if(clean)return Ext.Array.clean(vals);else return vals},reMapRows:function(){var rowKey=this.getRowKey();var rowsMap={};this.eachRow(function(row,i){if(rowKey in row)rowsMap[row[rowKey]]=i},true);this.setRowsMap(rowsMap)},sortByColumn:function(columns){var rows=this.getRows(),sortColumnsIndices=
Ext.Array.from(columns).map(function(column){if(Ext.isObject(column))for(key in column)return{index:this.getColumnIndex(key),direction:column[key].indexOf("asc")>-1?"asc":"desc"};else return{index:this.getColumnIndex(column),direction:"desc"}},this);rows.sort(function(a,b){for(var i=0,len=sortColumnsIndices.length;i<len;i++){var header=sortColumnsIndices[i].index;if(a[header]!=b[header])if(sortColumnsIndices[i].direction=="asc")return a[header]>b[header]?1:-1;else return a[header]>b[header]?-1:1}});
this.reMapRows();return this},loadCorrespondenceAnalysis:function(config){return this._doAnalysisLoad("table.CA","Voyant.data.store.CAAnalysis",config)},loadPrincipalComponentAnalysis:function(config){return this._doAnalysisLoad("table.PCA","Voyant.data.store.PCAAnalysis",config)},loadTSNEAnalysis:function(config){return this._doAnalysisLoad("table.TSNE","Voyant.data.store.TSNEAnalysis",config)},_doAnalysisLoad:function(tool,storeType,config){if(this.then)return Voyant.application.getDeferredNestedPromise(this,
arguments);else{config=config||{};var dfd=Voyant.application.getDeferred(this);Ext.apply(config,{columnHeaders:true,rowHeaders:true,tool:tool,analysisInput:this.toTsv(),inputFormat:"tsv"});var store=Ext.create(storeType,{noCorpus:true});store.load({params:config,callback:function(records,operation,success){if(success)dfd.resolve(store,records);else dfd.reject(operation.error.response)}});return dfd.promise}},embed:function(cmp,config){if(!config&&Ext.isObject(cmp)){config=cmp;cmp=this.embeddable[0]}config=
config||{};var columnHeaders=Ext.Array.from(config.headers||this.getHeaders()).map(function(header){return this.getColumnHeader(header)},this);var json={rowkey:this.getRowKey(),config:config,headers:columnHeaders};if("headers"in config){var columnIndices=Ext.Array.from(config.headers).map(function(header){return this.getColumnIndex(header)},this);var rows=[];this.getRows().forEach(function(row){rows.push(columnIndices.map(function(i){return row[i]}))});Ext.apply(json,{rows:rows})}else Ext.apply(json,
{rows:this.getRows()});Ext.apply(config,{tableJson:JSON.stringify(json)});delete config.axes;delete config.series;embed.call(this,cmp,config)},toTsv:function(config){var tsv=this.getHeaders().join("\t");this.getRows().forEach(function(row,i){if(config&&Ext.isNumber(config)&&i>config)return;tsv+="\n"+row.map(function(cell){return Ext.isString(cell)?cell.replace(/(\n|\t)/g,""):cell}).join("\t")});return tsv},getString:function(config){config=config||{};var table="\x3ctable class\x3d'voyant-table' style\x3d'"+
(config.width?" width: "+config.width:"")+"' id\x3d'"+(config.id?config.id:Ext.id())+"'\x3e";var headers=this.getHeaders();if(headers.length){table+="\x3cthead\x3e\x3ctr\x3e";for(var i=0,len=headers.length;i<len;i++)table+="\x3cth\x3e"+headers[i]+"\x3c/th\x3e";table+="\x3c/tr\x3e\x3c/thead\x3e"}table+="\x3ctbody\x3e";for(var i=0,len=Ext.isNumber(config)?config:this.getRows().length;i<len;i++){var row=this.getRow(i);if(row&&Ext.isArray(row)){table+="\x3ctr\x3e";row.forEach(function(cell){table+="\x3ctd\x3e"+
cell+"\x3c/td\x3e"});table+="\x3c/tr\x3e"}}table+="\x3c/tbody\x3e\x3c/table\x3e";return table}});Ext.define("Voyant.data.util.NetworkGraph",{alternateClassName:["NetworkGraph"],mixins:["Voyant.notebook.util.Embed","Voyant.notebook.util.Show"],embeddable:["Voyant.widget.VoyantNetworkGraph"],config:{edges:[],nodes:[]},constructor:function(config,opts){config=config||{};this.setEdges(Ext.Array.from(config.edges));this.setNodes(Ext.Array.from(config.nodes));this.callParent([config])},addEdge:function(src,target,value){this.getEdges().push(Ext.isObject(src)?src:{source:src,target:target,value:value})},
getNode:function(term){return Ext.Array.binarySearch(this.getNodes(),term,undefined,undefined,function(lhs,rhs){return lhs.term<rhs.term?-1:lhs.term>rhs.term?1:0})},embed:function(cmp,config){if(!config&&Ext.isObject(cmp)){config=cmp;cmp=this.embeddable[0]}config=config||{};var json={edges:this.getEdges(),nodes:this.getNodes(),config:config};if(config.limit&&json.edges.length>config.limit){json.edges=json.edges.slice(0,config.limit);var terms={};json.edges.forEach(function(edge){terms["_"+edge.source]=
true;terms["_"+edge.target]=true});var nodes=[];json.nodes.forEach(function(node){if("_"+node.term in terms)nodes.push(node)});json.nodes=nodes}Ext.apply(config,{jsonData:JSON.stringify(json)});embed.call(this,cmp,config)},getString:function(config){config=config||{};return this.getEdges().map(function(edge){edge.source+"-"+edge.target}).join("; ")}});Ext.define("Voyant.data.util.Geonames",{mixins:["Voyant.util.Localization"],statics:{i18n:{}},config:{data:{},queries:undefined,corpus:undefined,isIncrementalLoadingOccurrences:false,previousParams:{}},constructor:function(config,opts){config=config||{};this.callParent([config]);this.setCorpus(config.corpus)},load:function(params,dfd){this.setPreviousParams(params);dfd=dfd||Voyant.application.getDeferred(this);var me=this,localParams={corpus:this.getCorpus().getAliasOrId(),queries:this.getQueries(),
tool:"corpus.Dreamscape",limit:200};Ext.apply(localParams,params||{});if(!params.noOverwrite)me.setData({});Ext.Ajax.request({url:Voyant.application.getTromboneUrl(),params:localParams,scope:this}).then(function(response){var data=Ext.JSON.decode(response.responseText);if(data&&data.dreamscape&&data.dreamscape.progress)new Voyant.widget.ProgressMonitor({progress:data.dreamscape.progress,maxMillisSinceStart:1E3*60*60,tool:"corpus.Dreamscape",success:function(){me.load.call(me,params,dfd)},failure:function(responseOrProgress){Voyant.application.showResponseError(me.localize("failedToFetchGeonames"),
responseOrProgress)},scope:me});if(data&&data.dreamscape&&!data.dreamscape.progress){if(!params.noOverwrite)me.setData(data.dreamscape);dfd.resolve(data)}},function(response){Voyant.application.showResponseError(me.localize("failedToFetchGeonames"),response)});return dfd.promise},getCitiesCount:function(){return Object.keys(this.getData().locations.locations).length},getTotalCitiesCount:function(){return this.getData().locations.total},hasMoreCities:function(){return this.getCitiesCount()<this.getTotalCitiesCount()},
eachCity:function(fn,scope,max){var locations=this.getData().locations.locations,orderedLocations=[];for(var id in locations)orderedLocations.push(Ext.apply(locations[id],{id:id}));orderedLocations.sort(function(c1,c2){return c1.rawFreq==c2.rawFreq?c1.label-c2.label:c2.rawFreq-c1.rawFreq});if(max&&orderedLocations.length>max)orderedLocations=orderedLocations.slice(0,max);orderedLocations.forEach(function(location){fn.call(scope,location)})},getConnectionsCount:function(){return this.getData().connections.connections.length},
getTotalConnectionsCount:function(){return this.getData().connections.total},eachConnection:function(fn,scope,max){var connections=this.getData().connections.connections,locations=this.getData().locations.locations;orderedConnections=[];for(var i=0,len=connections.length;i<len;i++){fn.call(scope,{source:Ext.apply({id:connections[i].source},locations[connections[i].source]),target:Ext.apply({id:connections[i].target},locations[connections[i].target]),rawFreq:connections[i].rawFreq});if(i>max)break}},
getConnectionOccurrence:function(index){if(!this.getData().locations)return undefined;var connectionOccurrencesData=this.getData().connectionOccurrences,connectionOccurrences=connectionOccurrencesData.connectionOccurrences;locations=this.getData().locations.locations;if(!this.getIsIncrementalLoadingOccurrences()&&connectionOccurrences.length<connectionOccurrencesData.total&&index+100>connectionOccurrences.length){this.setIsIncrementalLoadingOccurrences(true);var me=this;var params={};Ext.apply(params,
this.getPreviousParams);Ext.apply(params,{start:connectionOccurrences.length,noOverwrite:true,suppressLocations:true,suppressConnections:true});this.load(params).then(function(data){me.setIsIncrementalLoadingOccurrences(false);me.getData().connectionOccurrences.connectionOccurrences=connectionOccurrences.concat(data.dreamscape.connectionOccurrences.connectionOccurrences)})}if(connectionOccurrences&&connectionOccurrences[index]){var occurrence=connectionOccurrences[index];occurrence.index=index;Ext.apply(occurrence.source,
locations[occurrence.source.location]);Ext.apply(occurrence.target,locations[occurrence.target.location]);return occurrence}return null},getAllConnectionOccurrences:function(sourceId,targetId){debugger;var occurences=[];for(var i=0;i<this.getTotalConnectionsCount();i++){var occurence=this.getConnectionOccurrence(i);if(occurence&&occurence.target.id==targetId&&occurence.source.id==sourceId)occurences.push(occurence)}return occurences}});Ext.define("Voyant.data.model.Corpus",{alternateClassName:["Corpus"],mixins:["Voyant.notebook.util.Embed","Voyant.notebook.util.Show","Voyant.util.Transferable","Voyant.util.Localization","Voyant.util.Assignable"],transferable:["loadCorpusTerms","loadTokens","getPlainText","getText","getWords","getString","getLemmasArray"],embeddable:["Voyant.panel.Summary","Voyant.panel.Cirrus","Voyant.panel.Documents","Voyant.panel.CorpusTerms","Voyant.panel.Reader","Voyant.panel.Trends","Voyant.panel.TermsRadio",
"Voyant.panel.DocumentTerms","Voyant.panel.TermsBerry","Voyant.panel.CollocatesGraph","Voyant.panel.Contexts","Voyant.panel.WordTree","Voyant.panel.Veliza","Voyant.panel.ScatterPlot","Voyant.panel.Topics"],requires:["Voyant.util.ResponseError","Voyant.data.store.CorpusTerms","Voyant.data.store.Documents"],extend:"Ext.data.Model",config:{documentsStore:undefined},statics:{i18n:{}},fields:[{name:"documentsCount",type:"int"},{name:"lexicalTokensCount",type:"int"},{name:"lexicalTypesCount",type:"int"},
{name:"createdTime",type:"int"},{name:"createdDate",type:"date",dateFormat:"c"},{name:"title",type:"string"},{name:"subTitle",type:"string"},{name:"languagueCodes",type:"string"}],constructor:function(source,config){source=source||{};config=config||{};this.callParent([]);var dfd=Voyant.application.getDeferred(this);if(Ext.isString(source))if(/\s/.test(source)==false&&source.indexOf(":")==-1)Ext.apply(config,{corpus:source});else Ext.apply(config,{input:source});else if(Ext.isArray(source))Ext.apply(config,
{input:source});else if(Ext.isObject(source))Ext.apply(config,source);else{Voyant.application.showError(this.localize("badDataTypeCorpus")+": ("+typeof source+") "+source);Ext.defer(function(){dfd.reject(this.localize("badDataTypeCorpus")+": ("+typeof source+") "+source)},50,this);return dfd.promise}if(Ext.isObject(config)){if(!config.corpus&&!config.input&&!config.inlineData){Voyant.application.showError(this.localize("noCorpusOrInput")+": "+config);Ext.defer(function(){dfd.reject(this.localize("noCorpusOrInput")+
": "+config)},50,this);return dfd.promise}Ext.apply(config,{tool:"corpus.CorpusMetadata"});var me=this;var promise=Ext.Ajax.request({url:Voyant.application.getTromboneUrl(),params:config}).then(function(response){me.set(Ext.JSON.decode(response.responseText).corpus.metadata);if(config.title||config.subTitle){me.set("title",config.title);me.set("subTitle",config.subTitle)}else;return me},function(response){Voyant.application.showResponseError(me.localize("failedCreateCorpus"),response)}).then(function(corpus){if(corpus.getDocumentsCount()==
0)Voyant.application.showError(me.localize("thisCorpus")+" "+me.localize("isEmpty")+".");if(!("docsLimit"in config)||config.docsLimit!==false&&config.docsLimit>0)me.getDocuments().load({params:{limit:"docsLimit"in config?config.docsLimit:me.getDocumentsCount()},callback:function(records,operation,success){if(success){me.setDocumentsStore(this);dfd.resolve(corpus)}else dfd.reject(operation)}});else dfd.resolve(corpus)});return dfd.promise}else{Voyant.application.showError(this.localize("badDataTypeCorpus")+
": ("+typeof config+") "+config);Ext.defer(function(){dfd.reject(this.localize("badDataTypeCorpus")+": ("+typeof config+") "+config)},50,this);return dfd.promise}},getId:function(){return this.then?Voyant.application.getDeferredNestedPromise(this,arguments):this.get("id")},getAliasOrId:function(){return this.then?Voyant.application.getDeferredNestedPromise(this,arguments):this.get("alias")||this.get("id")},loadCorpusTerms:function(config){if(this.then)return Voyant.application.getDeferredNestedPromise(this,
arguments);else{var dfd=Voyant.application.getDeferred(this);config=config||{};if(Ext.isNumber(config))config={limit:config};Ext.applyIf(config,{limit:0});var corpusTerms=this.getCorpusTerms();corpusTerms.load({params:config,callback:function(records,operation,success){if(success)dfd.resolve(corpusTerms);else dfd.reject(operation)}});return dfd.promise}},loadTokens:function(config){if(this.then)return Voyant.application.getDeferredNestedPromise(this,arguments);else{var dfd=Voyant.application.getDeferred(this);
config=config||{};if(Ext.isNumber(config))config={limit:config};Ext.applyIf(config,{limit:0});var tokens=this.getTokens();tokens.load({params:config,callback:function(records,operation,success){if(success)dfd.resolve(tokens);else dfd.reject(operation)}});return dfd.promise}},getCorpusTerms:function(config){return Ext.create("Voyant.data.store.CorpusTerms",Ext.apply(config||{},{corpus:this}))},getTokens:function(config){return Ext.create("Voyant.data.store.Tokens",Ext.apply(config||{},{corpus:this}))},
each:function(fn,scope){this.getDocuments().each(function(doc,i){fn.call(scope||doc,doc,i)})},map:function(fn,scope){return this.getDocuments().getRange().map(function(doc,i){return fn.call(scope||doc,doc,i)},scope||this)},getCorpusCollocates:function(config){return Ext.create("Voyant.data.store.CorpusCollocates",Ext.apply(config||{},{corpus:this}))},getDocumentQueryMatches:function(config){return Ext.create("Voyant.data.store.DocumentQueryMatches",Ext.apply(config||{},{corpus:this}))},getDocumentTerms:function(config){return Ext.create("Voyant.data.store.DocumentTerms",
Ext.apply(config||{},{corpus:this}))},getDocumentEntities:function(config){return Ext.create("Voyant.data.store.DocumentEntities",Ext.apply(config||{},{corpus:this}))},loadContexts:function(config){if(this.then)return Voyant.application.getDeferredNestedPromise(this,arguments);else{var dfd=Voyant.application.getDeferred(this);config=config||{};if(Ext.isNumber(config))config={limit:config};Ext.applyIf(config,{limit:0});var contexts=this.getContexts();contexts.load({params:config,callback:function(records,
operation,success){if(success)dfd.resolve(contexts);else dfd.reject(operation)}});return dfd.promise}},getContexts:function(config){return Ext.create("Voyant.data.store.Contexts",Ext.apply(config||{},{corpus:this}))},getDocuments:function(config){return this.getDocumentsStore()?this.getDocumentsStore():Ext.create("Voyant.data.store.Documents",Ext.apply(config||{},{corpus:this}))},getDocument:function(config){if(this.getDocumentsStore())if(config instanceof Voyant.data.model.Document)return config;
else if(Ext.isNumeric(config))return this.getDocumentsStore().getAt(parseInt(config));else if(Ext.isString(config))return this.getDocumentsStore().getById(config);return this.then?Voyant.application.getDeferredNestedPromise(this,arguments):this.getDocumentsStore().getDocument(config)},getDocumentsCount:function(){return this.then?Voyant.application.getDeferredNestedPromise(this,arguments):this.get("documentsCount")},getWordTokensCount:function(){return this.then?Voyant.application.getDeferredNestedPromise(this,
arguments):this.get("lexicalTokensCount")},getWordTypesCount:function(){return this.then?Voyant.application.getDeferredNestedPromise(this,arguments):this.get("lexicalTypesCount")},getCreatedTime:function(){return this.then?Voyant.application.getDeferredNestedPromise(this,arguments):this.get("createdTime")},requiresPassword:function(){var noPasswordAccess=this.getNoPasswordAccess();return noPasswordAccess=="NONE"||noPasswordAccess=="NONCONSUMPTIVE"},getNoPasswordAccess:function(){return this.then?
Voyant.application.getDeferredNestedPromise(this,arguments):this.get("noPasswordAccess")},getTitle:function(){return this.then?Voyant.application.getDeferredNestedPromise(this,arguments):this.get("title")},getSubTitle:function(){return this.then?Voyant.application.getDeferredNestedPromise(this,arguments):this.get("subTitle")},getRelatedWords:function(config){return Ext.create("Voyant.data.store.RelatedTerms",Ext.apply(config||{},{corpus:this}))},loadRelatedWords:function(config){var me=this;if(this.then)return Voyant.application.getDeferredNestedPromise(this,
arguments);else{var dfd=Voyant.application.getDeferred(this);config=config||{};if(Ext.isNumber(config))config={limit:config};Ext.applyIf(config,{limit:0});var relatedTerms=this.getRelatedWords();relatedTerms.load({params:config,callback:function(records,operation,success){if(success)dfd.resolve(records);else dfd.reject(operation.error.response)}});return dfd.promise}},getText:function(config){if(this.then)return Voyant.application.getDeferredNestedPromise(this,arguments,this);else{var dfd=Voyant.application.getDeferred(this);
config=config||{};if(Ext.isNumber(config))config={limit:config};else if(Ext.isString(config))config={limit:parseInt(config)};Ext.applyIf(config,{limit:0,outputFormat:"text",template:"docTokens2text"});Ext.apply(config,{tool:"corpus.DocumentTokens",corpus:this.getAliasOrId()});Ext.Ajax.request({url:Voyant.application.getTromboneUrl(),params:config,success:function(response,opts){var text=response.responseText.trim();if(config.transformCase)if(config.transformCase.indexOf("lower")>-1)text=text.toLowerCase();
else if(config.transformCase.indexOf("upper")>-1)text=text.toUpperCase();dfd.resolve(text)},failure:function(response,opts){dfd.reject(response)},scope:this});return dfd.promise}},getPlainText:function(config){if(this.then)return Voyant.application.getDeferredNestedPromise(this,arguments);else{config=config||{};if(Ext.isNumber(config))config={limit:config};else if(Ext.isString(config))config={limit:parseInt(config)};Ext.apply(config,{template:"docTokens2plainText"});return this.getText(config)}},
getWords:function(config){if(this.then)return Voyant.application.getDeferredNestedPromise(this,arguments);else{config=config||{};if(Ext.isNumber(config))config={limit:config};else if(Ext.isString(config))config={limit:parseInt(config)};Ext.applyIf(config,{template:"docTokens2words"});return this.getText(config)}},getWordsArray:function(config){if(this.then)return Voyant.application.getDeferredNestedPromise(this,arguments);else{var dfd=Voyant.application.getDeferred(this);this.getWords(config).then(function(text){dfd.resolve(text.split(" "))});
return dfd.promise}},getLemmasArray:function(config){config=config||{};if(this.then)return Voyant.application.getDeferredNestedPromise(this,arguments);else{var dfd=Voyant.application.getDeferred(this);Ext.applyIf(config,{template:"docTokens2lemmas",withPosLemmas:true,noOthers:true});this.getWords(config).then(function(text){var lemmas=text.split(" ").map(function(word){return word.substring(0,word.indexOf("/"))});dfd.resolve(lemmas)});return dfd.promise}},getString:function(config){var size=this.getDocumentsCount();
var message=this.localize("thisCorpus");if(size==0)message+=" "+this.localize("isEmpty")+".";else{message+=" ";if(size>1)message+=(new Ext.XTemplate(this.localize("hasNdocuments"))).apply({count:Ext.util.Format.number(size,"0,000")});else message+=this.localize("has1document");message+=" "+(new Ext.XTemplate(this.localize("widthNwordsAndNTypes"))).apply({words:Ext.util.Format.number(this.getWordTokensCount(),"0,000"),types:Ext.util.Format.number(this.getWordTypesCount(),"0,000")})+".";message+=" "+
this.localize("created")+" ";var createdDate=this.get("createdDate");var now=new Date;if(Ext.Array.each([["year",Ext.Date.YEAR],["month",Ext.Date.MONTH],["day",Ext.Date.DAY],["hour",Ext.Date.HOUR],["minute",Ext.Date.MINUTE],["second",Ext.Date.SECOND]],function(time){if(Ext.Date.diff(createdDate,now,time[1])>(time[0]=="second"?1:0)){var count=Ext.Date.diff(createdDate,now,time[1]);message+="\x3cspan class\x3d'info-tip' data-qtip\x3d'"+Ext.Date.format(createdDate,"Y-m-d, H:i:s")+"'\x3e";if(count==1)message+=
(new Ext.XTemplate(this.localize(time[0]+"Ago"))).apply({count:count,date:createdDate});else message+=(new Ext.XTemplate(this.localize(time[0]+"sAgo"))).apply({count:count,date:createdDate});message+="\x3c/span\x3e";return false}},this)===true)message+=this.localize("now");message+=".";message+=""}if(config===true)message+=" ("+this.getId()+")";return message}});Ext.define("Voyant.widget.CodeEditor",{extend:"Ext.panel.Panel",mixins:["Voyant.util.Localization","Voyant.util.Api","Voyant.notebook.util.Embed"],alias:"widget.codeeditor",statics:{i18n:{},api:{tableJson:undefined,content:"",mode:"ace/mode/text",width:undefined}},constructor:function(config){config=config||{};var me=this;me.mixins["Voyant.util.Api"].constructor.apply(this,arguments);me.buildFromParams();Ext.apply(me,{items:{xtype:"notebookcodeeditor",content:config.content?config.content:this.getApiParam("content"),
mode:config.mode?config.mode:this.getApiParam("mode")}});me.callParent(arguments)},initComponent:function(config){var me=this,config=config||{};me.mixins["Voyant.util.Api"].constructor.apply(this,arguments);me.callParent(arguments)},buildFromParams:function(){var me=this,tableJson=this.getApiParam("tableJson");if(tableJson){var json=Ext.decode(tableJson);var text=json.headers.join("\t")+"\n"+json.rows.map(function(row){return row.join("\t")}).join("\n");this.setApiParam("content",text)}}});Ext.define("Voyant.widget.CorpusSelector",{extend:"Ext.form.field.ComboBox",mixins:["Voyant.util.Localization","Voyant.util.Api"],alias:"widget.corpusselector",statics:{i18n:{},api:{openMenu:undefined}},constructor:function(config){config=config||{};this.mixins["Voyant.util.Api"].constructor.apply(this,arguments);var data=[["shakespeare","Shakespeare's Plays"],["austen","Austen's Novels"]];if(this.getApiParam("openMenu"))data=this.getStoreItemsFromDefinition(this.getApiParam("openMenu"));else if(Voyant.application&&
Voyant.application.getOpenMenu&&Voyant.application.getOpenMenu()){var arg=Voyant.application.getOpenMenu();arg=decodeURIComponent(arg);arg=arg.replace(/\+/g," ");if(arg.charAt(0)=='"'&&arg.charAt(arg.length-1)=='"')arg=arg.substring(1,arg.length-1);data=this.getStoreItemsFromDefinition(arg)}Ext.applyIf(config,{fieldLabel:this.localize("chooseCorpus"),labelWidth:125,labelAlign:"right",name:"corpus",queryMode:"local",store:data});this.callParent([config])},initComponent:function(config){config=config||
{};this.callParent([config])},getStoreItemsFromDefinition:function(definition){var data=[],items=definition.split(";");for(var i=0;i<items.length;i++){var nameValue=items[i].split(":");if(nameValue[0])data.push([nameValue[0],nameValue[1]?nameValue[1]:nameValue[0]])}return data}});Ext.define("Voyant.widget.ListEditor",{extend:"Ext.container.Container",mixins:["Voyant.util.Localization"],alias:"widget.listeditor",layout:"hbox",statics:{i18n:{}},initComponent:function(config){var me=this;var value=this.up("window").panel.getApiParam(this.name);var data=value?[{name:value,value:value}]:[];data.splice(0,0,{name:this.localize("none"),value:""},{name:this.localize("new"),value:"new"});Ext.apply(me,{items:[{xtype:"combo",queryMode:"local",value:value,triggerAction:"all",editable:true,
fieldLabel:this.localize(this.name+"Label"),labelAlign:"right",name:this.name,displayField:"name",valueField:"value",store:{fields:["name","value"],data:data}},{width:10},{xtype:"tbspacer"},{xtype:"button",text:this.localize("editList"),ui:"default-toolbar",handler:this.editList,scope:this}]});me.callParent(arguments)},editList:function(){var win=this.up("window");var panel=win.panel;var value=this.down("combo").getValue();Ext.Ajax.request({url:panel.getTromboneUrl(),params:{tool:"resource.KeywordsManager",
list:value},success:function(response){var json=Ext.util.JSON.decode(response.responseText);var keywords=json.keywords.keywords.sort().join("\n");Ext.Msg.show({title:this.localize("editListTitle"),message:this.localize("editListMessage"),buttons:Ext.Msg.OKCANCEL,buttonText:{ok:this.localize("ok"),cancel:this.localize("cancel")},icon:Ext.Msg.INFO,prompt:true,multiline:true,value:keywords,original:keywords,fn:function(btn,value,list){if(btn=="ok"&&list.original!=value){var combo=this.down("combo");
if(Ext.String.trim(value).length==0)combo.setValue("empty");else Ext.Ajax.request({url:panel.getTromboneUrl(),params:{tool:"resource.StoredResource",storeResource:value},combo:combo,success:function(response,req){var json=Ext.util.JSON.decode(response.responseText);var store=req.combo.getStore();var value="keywords-"+json.storedResource.id;store.add({name:value,value:value});req.combo.setValue(value);req.combo.updateLayout()},scope:this})}},scope:this})},scope:this})}});Ext.define("Voyant.widget.StopListOption",{extend:"Ext.container.Container",mixins:["Voyant.util.Localization"],alias:"widget.stoplistoption",layout:"hbox",statics:{stoplists:{ar:"stop.ar.arabic-lucene.txt",bg:"stop.bu.bulgarian-lucene.txt",br:"stop.br.breton-lucene.txt",ca:"stop.ca.catalan-lucene.txt",ckb:"stop.ckb-turkish-lucene.txt",cn:"stop.cn.chinese-lawrence.txt",cz:"stop.cz.czech-lucene.txt",de:"stop.de.german.txt",el:"stop.el.greek-lucene.txt",en:"stop.en.taporware.txt",es:"stop.es.spanish.txt",
eu:"stop.eu.basque-lucene.txt",fa:"stop.fa.farsi-lucene.txt",fr:"stop.fr.veronis.txt",ga:"stop.ga-irish-lucene.txt",gl:"stop.ga.galician-lucene.txt",grc:"stop.grc.ancient-greek.txt",hi:"stop.hi.hindi-lucene.txt",hu:"stop.hu.hungarian.txt",hy:"stop.hy.armenian-lucene.txt",id:"stop.id.indonesian-lucene.txt",it:"stop.it.italian.txt",ja:"stop.ja.japanese-lucene.txt",la:"stop.la.latin.txt",lv:"stop.lv.latvian-lucene.txt",lt:"stop.lt.lithuanian-lucene.txt",mu:"stop.mu.multi.txt",nl:"stop.nl.dutch.txt",
no:"stop.no.norwegian.txt",pt:"stop.pt.brazilian.txt",ro:"stop.ro.romanian-lucene.txt",ru:"stop.ru.russian.txt",se:"stop.se.swedish-long.txt",th:"stop.th.thai-lucene.txt",tr:"stop.tr.turkish-lucene.txt"},i18n:{}},initComponent:function(config){var me=this;var value=this.up("window").panel.getApiParam("stopList");var data=[];for(id in Voyant.widget.StopListOption.stoplists)data.push({name:this.localize(id),value:Voyant.widget.StopListOption.stoplists[id]});data.sort(function(a,b){return a.name<b.name?
-1:1});data.splice(0,0,{name:this.localize("auto"),value:"auto"},{name:this.localize("none"),value:""},{name:this.localize("new"),value:"new"});Ext.apply(me,{items:[{xtype:"combo",queryMode:"local",value:value,triggerAction:"all",editable:true,fieldLabel:this.localize("label"),labelAlign:"right",name:"stopList",displayField:"name",valueField:"value",store:{fields:["name","value"],data:data}},{width:10},{xtype:"tbspacer"},{xtype:"button",text:this.localize("editList"),ui:"default-toolbar",handler:this.editList,
scope:this},{width:10},{xtype:"checkbox",name:"stopListGlobal",checked:true,boxLabel:this.localize("applyGlobally")}]});me.callParent(arguments)},editList:function(){var win=this.up("window");var panel=win.panel;var value=this.down("combo").getValue();var corpusId=panel.getApplication&&panel.getApplication().getCorpus?panel.getApplication().getCorpus().getId():undefined;if(value=="auto"&&!corpusId){Ext.Msg.show({title:this.localize("noEditAutoTitle"),message:this.localize("noEditAutoMessage"),buttons:Ext.Msg.OK,
icon:Ext.Msg.ERROR});return}Ext.Ajax.request({url:panel.getTromboneUrl(),params:{tool:"resource.KeywordsManager",stopList:value,corpus:corpusId},success:function(response){var json=Ext.util.JSON.decode(response.responseText);var keywords=json.keywords.keywords.sort().join("\n");Ext.Msg.show({title:this.localize("editStopListTitle"),message:this.localize("editStopListMessage"),buttons:Ext.Msg.OKCANCEL,buttonText:{ok:this.localize("ok"),cancel:this.localize("cancel")},icon:Ext.Msg.INFO,prompt:true,
multiline:true,value:keywords,original:keywords,fn:function(btn,value,stoplist){value=value.toLowerCase();if(btn=="ok"&&stoplist.original!=value){var combo=this.down("combo");if(Ext.String.trim(value).length==0)combo.setValue("empty");else Ext.Ajax.request({url:panel.getTromboneUrl(),params:{tool:"resource.StoredResource",storeResource:value,corpus:corpusId},combo:combo,success:function(response,req){var json=Ext.util.JSON.decode(response.responseText);var store=req.combo.getStore();var value="keywords-"+
json.storedResource.id;store.add({name:value,value:value});req.combo.setValue(value);req.combo.updateLayout()},scope:this})}},scope:this})},scope:this})}});Ext.define("Voyant.widget.QuerySearchField",{extend:"Ext.form.field.Tag",mixins:["Voyant.util.Localization"],alias:"widget.querysearchfield",statics:{i18n:{}},config:{corpus:undefined,tokenType:"lexical",isDocsMode:false,inDocumentsCountOnly:undefined,stopList:undefined,showAggregateInDocumentsCount:false,clearOnQuery:false,parentPanel:undefined,currentOriginalRawQueryPlan:undefined},hasCorpusLoadedListener:false,isClearing:false,constructor:function(config){config=config||{};var itemTpl=config.itemTpl?
config.itemTpl:config.inDocumentsCountOnly?"\x3ctpl\x3e\x3ctpl if\x3d\"term.charAt(0)\x3d\x3d'@'\"\x3e{term}\x3c/tpl\x3e\x3ctpl if\x3d\"term.charAt(0)!\x3d'@'\"\x3e{term} ({inDocumentsCount})\x3c/tpl\x3e\x3c/tpl\x3e":"\x3ctpl\x3e\x3ctpl if\x3d\"term.charAt(0)\x3d\x3d'@'\"\x3e{term}\x3c/tpl\x3e\x3ctpl if\x3d\"term.charAt(0)!\x3d'@'\"\x3e{term} ({rawFreq})\x3c/tpl\x3e\x3c/tpl\x3e";Ext.applyIf(config,{minWidth:100,maxWidth:200,matchFieldWidth:false,minChars:2,displayField:"term",valueField:"term",filterPickList:true,
createNewOnEnter:true,createNewOnBlur:false,autoSelect:false,tpl:['\x3cul class\x3d"x-list-plain"\x3e\x3ctpl for\x3d"."\x3e','\x3cli role\x3d"option" class\x3d"x-boundlist-item" style\x3d"white-space: nowrap;"\x3e'+itemTpl+"\x3c/li\x3e","\x3c/tpl\x3e\x3c/ul\x3e"],triggers:{help:{weight:2,cls:"fa-trigger form-fa-help-trigger",handler:function(){Ext.Msg.show({title:this.localize("querySearch"),message:this.getIsDocsMode()?this.localize("querySearchDocsModeTip"):this.localize("querySearchTip"),buttons:Ext.OK,
icon:Ext.Msg.INFO})},scope:"this"}}});if(config.showAggregateInDocumentsCount)config.triggers.count={cls:"fa-trigger",handler:"onHelpClick",scope:"this",hidden:true};if(config.clearOnQuery)this.setClearOnQuery(config.clearOnQuery);this.callParent(arguments)},initComponent:function(config){var me=this;me.on("beforequery",function(queryPlan){if(queryPlan.query){queryPlan.query=queryPlan.query.trim();var originalRawQueryPlan=queryPlan.query.toLowerCase();this.setCurrentOriginalRawQueryPlan(queryPlan.query);
if(queryPlan.query.charAt(0)!="@"){if(queryPlan.query.charAt(0)=="^"){queryPlan.query=queryPlan.query.substring(1);queryPlan.cancel=queryPlan.query.length==0}if(queryPlan.query.charAt(0)=="*")queryPlan.query="."+queryPlan.query;if(queryPlan.query.charAt(queryPlan.query.length-1)=="*"||queryPlan.query.charAt(queryPlan.query.length-1)=="|"){queryPlan.query=queryPlan.query.substring(0,queryPlan.query.length-1);queryPlan.cancel=queryPlan.query.length==0}if(queryPlan.query.charAt(0)==".")queryPlan.cancel=
queryPlan.query.length<(/\W/.test(queryPlan.query.charAt(1))?5:4);try{new RegExp(queryPlan.query)}catch(e){queryPlan.cancel=true}if(queryPlan.query.indexOf('"')>-1){if(queryPlan.query.indexOf(" ")==-1)queryPlan.cancel=true;if((queryPlan.query.match(/"/)||[]).length!=2)queryPlan.cancel=true}if(queryPlan.query.indexOf("*")>-1){if(queryPlan.query.indexOf(" ")==-1&&queryPlan.query.indexOf("|")==-1)queryPlan.query+=",^"+queryPlan.query}else queryPlan.query=queryPlan.query+"*"+(queryPlan.query.indexOf(" ")==
-1&&queryPlan.query.indexOf("|")==-1?","+"^"+queryPlan.query+"*":"")}else if(queryPlan.query=="@")queryPlan.cancel=true;var parent=me.getParentPanel();if(queryPlan.cancel==false&&parent){var originalRawQueryPlanWithoutAt=originalRawQueryPlan.charAt(0)=="@"?originalRawQueryPlan.substring(1):originalRawQueryPlan;for(var cat in parent.getApplication().getCategoriesManager().getCategories())if(cat.toLowerCase().indexOf(originalRawQueryPlanWithoutAt)>-1)queryPlan.query="@"+cat+(originalRawQueryPlan.charAt(0)==
"@"?"":","+queryPlan.query)}}},this);me.on("change",function(tags,queries){if(!me.isClearing){queries=queries.map(function(query){return query.replace(/^(\^?)\*/,"$1.*")});me.up("panel").fireEvent("query",me,queries);if(me.getClearOnQuery()){me.isClearing=true;me.removeValue(me.getValueRecords())}if(me.triggers.count){me.triggers.count.show();me.triggers.count.getEl().setHtml("0");if(queries.length>0)me.getCorpus().getCorpusTerms().load({params:{query:queries.map(function(q){return"("+q+")"}).join("|"),
tokenType:me.getTokenType(),stopList:me.getStopList(),inDocumentsCountOnly:true},callback:function(records,operation,success){if(success&&records&&records.length==1)me.triggers.count.getEl().setHtml(records[0].getInDocumentsCount())}});else me.triggers.count.hide()}}else me.isClearing=false});var parentPanel=me.findParentBy(function(clz){return clz.mixins["Voyant.panel.Panel"]});if(parentPanel!=null){this.setParentPanel(parentPanel);if(parentPanel.getCorpus&&parentPanel.getCorpus()){me.on("afterrender",
function(c){this.doSetCorpus(parentPanel.getCorpus())});me.hasCorpusLoadedListener=true}else{parentPanel.on("loadedCorpus",function(src,corpus){me.doSetCorpus(corpus)},me);me.hasCorpusLoadedListener=true}}me.on("afterrender",function(c){if(me.hasCorpusLoadedListener===false)if(!me.getCorpus()){parentPanel=me.findParentBy(function(clz){return clz.mixins["Voyant.panel.Panel"]});if(parentPanel==null)parentPanel=me.up("window").panel;var corpus=parentPanel.getApplication().getCorpus();if(corpus!==undefined)me.doSetCorpus(corpus);
else{parentPanel.on("loadedCorpus",function(src,corpus){me.doSetCorpus(corpus)},me);me.hasCorpusLoadedListener=true}}if(me.triggers&&me.triggers.help)Ext.tip.QuickTipManager.register({target:me.triggers.help.getEl(),text:me.getIsDocsMode()?me.localize("querySearchDocsModeTip"):me.localize("querySearchTip")});if(me.triggers&&me.triggers.count)Ext.tip.QuickTipManager.register({target:me.triggers.count.getEl(),text:me.localize("aggregateInDocumentsCount")})});me.on("beforedestroy",function(c){if(me.triggers&&
me.triggers.help)Ext.tip.QuickTipManager.unregister(me.triggers.help.getEl());if(me.triggers&&me.triggers.count)Ext.tip.QuickTipManager.unregister(me.triggers.count.getEl())});me.callParent(arguments)},doSetCorpus:function(corpus){if(corpus!=null){this.setCorpus(corpus);var stopList=this.getStopList();if(stopList==undefined)if(this.getApiParam)this.setStopList(this.getApiParam("stopList"));else{var parent=this.up("panel");while(parent){if(parent&&parent.getApiParam){this.setStopList(parent.getApiParam("stopList"));
break}parent=parent.up("panel")}}var categories=this.getApiParam?this.getApiParam("categories"):undefined;if(!categories){var parent=this.up("panel");while(parent){if(parent&&parent.getApiParam){categories=parent.getApiParam("categories");break}parent=parent.up("panel")}}var store=corpus.getCorpusTerms({corpus:corpus.getAliasOrId(),proxy:{extraParams:{limit:10,tokenType:this.tokenType,stopList:this.getStopList(),inDocumentsCountOnly:this.getInDocumentsCountOnly(),categories:categories}}});this.setStore(store)}}});Ext.define("Voyant.widget.TotalPropertyStatus",{extend:"Ext.Component",mixins:["Voyant.util.Localization"],alias:"widget.totalpropertystatus",statics:{i18n:{}},initComponent:function(){var me=this;Ext.applyIf(me,{tpl:this.localize("totalPropertyStatus"),itemId:"totalpropertystatus",style:"margin-right:5px",listeners:{afterrender:function(cmp){var grid=cmp.up("grid");if(grid){var store=grid.getStore();cmp.updateStatus(store.getTotalCount());grid.getStore().on("totalcountchange",cmp.updateStatus,cmp)}}}});
me.callParent(arguments)},updateStatus:function(count){this.update({count:count})}});Ext.define("Voyant.widget.DocumentSelector",{mixins:["Voyant.util.Localization"],alias:"widget.documentselector",glyph:"xf10c@FontAwesome",statics:{i18n:{}},config:{docs:undefined,corpus:undefined,singleSelect:false},initComponent:function(){var me=this;this.setSingleSelect(this.config.singleSelect==undefined?this.getSingleSelect():this.config.singleSelect);Ext.apply(me,{text:this.localize("documents"),menu:{width:250,fbar:[{xtype:"checkbox",hidden:this.getSingleSelect(),boxLabel:this.localize("all"),
listeners:{change:{fn:function(item,checked){this.getMenu().items.each(function(item){item.setChecked(checked)})},scope:this}}},{xtype:"tbfill"},{xtype:"button",text:this.localize("ok"),hidden:this.getSingleSelect(),scale:"small",handler:function(button,e){var docs=[];this.getMenu().items.each(function(item){if(item.checked)docs.push(item.docId)},this);var panel=button.findParentBy(function(clz){return clz.mixins["Voyant.panel.Panel"]});if(panel)panel.fireEvent("documentsSelected",button,docs);button.findParentBy(function(clz){if(clz.isXType("button")&&
clz.hasVisibleMenu()){clz.hideMenu();return true}return false})},scope:this},{xtype:"button",text:this.localize("cancel"),scale:"small",handler:function(b,e){this.findParentBy(function(clz){if(clz.isXType("button")&&clz.hasVisibleMenu()){clz.hideMenu();return true}return false},this);this.hideMenu()},scope:this}]},listeners:{afterrender:function(selector){selector.on("loadedCorpus",function(src,corpus){this.setCorpus(corpus);if(corpus.getDocumentsCount()==1)this.hide();else selector.populate(corpus.getDocumentsStore().getRange(),
true)},selector);var panel=selector.findParentBy(function(clz){return clz.mixins["Voyant.panel.Panel"]});if(panel){panel.on("loadedCorpus",function(src,corpus){selector.fireEvent("loadedCorpus",src,corpus)},selector);if(panel.getCorpus&&panel.getCorpus())selector.fireEvent("loadedCorpus",selector,panel.getCorpus());else if(panel.getStore&&panel.getStore()&&panel.getStore().getCorpus&&panel.getStore().getCorpus())selector.fireEvent("loadedCorpus",selector,panel.getStore().getCorpus())}}}})},populate:function(docs,
replace){this.setDocs(docs);var menu=this.getMenu();if(replace)menu.removeAll();var isSingleSelect=this.getSingleSelect();var groupId="docGroup"+Ext.id();docs.forEach(function(doc,index){menu.add({xtype:"menucheckitem",text:doc.getShortTitle(),docId:doc.get("id"),checked:isSingleSelect&&index==0||!isSingleSelect,group:isSingleSelect?groupId:undefined,checkHandler:function(item,checked){if(this.getSingleSelect()&&checked){var panel=this.findParentBy(function(clz){return clz.mixins["Voyant.panel.Panel"]});
if(panel)panel.fireEvent("documentSelected",this,doc)}},scope:this})},this)}});Ext.define("Voyant.widget.DocumentSelectorButton",{extend:"Ext.button.Button",alias:"widget.documentselectorbutton",mixins:["Voyant.widget.DocumentSelector"],initComponent:function(){this.mixins["Voyant.widget.DocumentSelector"].initComponent.apply(this,arguments);this.callParent()}});
Ext.define("Voyant.widget.DocumentSelectorMenuItem",{extend:"Ext.menu.Item",alias:"widget.documentselectormenuitem",mixins:["Voyant.widget.DocumentSelector"],initComponent:function(){this.mixins["Voyant.widget.DocumentSelector"].initComponent.apply(this,arguments);this.callParent()}});Ext.define("Voyant.widget.CorpusDocumentSelector",{extend:"Ext.button.Button",mixins:["Voyant.util.Localization"],alias:"widget.corpusdocumentselector",statics:{i18n:{}},config:{corpus:undefined,singleSelect:false},initComponent:function(){var me=this;this.setSingleSelect(this.config.singleSelect==undefined?this.getSingleSelect():this.config.singleSelect);Ext.apply(me,{text:this.localize("scale"),glyph:"xf059@FontAwesome",menu:{items:[{text:this.localize("corpus"),glyph:"xf111@FontAwesome",handler:function(button){var panel=
this.findParentBy(function(clz){return clz.mixins["Voyant.panel.Panel"]});if(panel){button.nextSibling().menu.items.each(function(item){item.setChecked(false,true)});panel.fireEvent("corpusSelected",this,this.getCorpus())}},scope:this},{xtype:"documentselectormenuitem",singleSelect:this.getSingleSelect()}]},listeners:{afterrender:function(selector){selector.on("loadedCorpus",function(src,corpus){this.setCorpus(corpus);if(corpus.getDocumentsCount()==1)this.hide()},selector);var panel=selector.findParentBy(function(clz){return clz.mixins["Voyant.panel.Panel"]});
if(panel){panel.on("loadedCorpus",function(src,corpus){selector.fireEvent("loadedCorpus",src,corpus)},selector);if(panel.getCorpus&&panel.getCorpus())selector.fireEvent("loadedCorpus",selector,panel.getCorpus());else if(panel.getStore&&panel.getStore()&&panel.getStore().getCorpus&&panel.getStore().getCorpus())selector.fireEvent("loadedCorpus",selector,panel.getStore().getCorpus())}}}});me.callParent(arguments)}});Ext.define("Voyant.widget.DownloadFilenameBuilder",{extend:"Ext.form.FieldContainer",mixins:["Voyant.util.Localization","Ext.form.field.Field"],alias:"widget.downloadfilenamebuilder",statics:{i18n:{}},config:{name:"documentFilename",itemId:"documentFilename",fields:["pubDate","title","author"],value:["pubDate","title"],width:400},initComponent:function(config){config=config||{};var me=this;me.initField();me.on("afterrender",function(){this.items.eachKey(function(key){new Ext.dd.DropZone(this.items.get(key).getTargetEl(),
{ddGroup:"downloadfilename",getTargetFromEvent:function(e){var target=e.getTarget();return target.className&&target.className.indexOf("dragsource")>-1?target.parentNode:target},onNodeDrop:function(target,dd,e,data){target.appendChild(dd.el.dom);return true}})},this);this.getFields().map(function(item){item=Ext.isString(item)?{tag:"span",html:this.localize(item+"Label"),value:item}:item;var container=this.queryById(Ext.Array.contains(this.getValue(),item.value)?"enabled":"available");var el=Ext.dom.Helper.append(container.getTargetEl(),
Ext.apply(item,{cls:"dragsource"}));Ext.create("Ext.dd.DragSource",el,{ddGroup:"downloadfilename"})},this)},me);me.callParent(arguments)},defaults:{xtype:"container",width:"100%"},items:[{itemId:"enabled",cls:"dropzone dropzone-enabled"},{itemId:"available",cls:"dropzone dropzone-disabled"}],getValue:function(){return this.rendered?this.getTargetEl().query(".dropzone-enabled .dragsource").map(function(source){return source.getAttribute("value")}):this.value},setValue:function(val){if(this.rendered)this.getTargetEl().query(".dragsource",
false).forEach(function(source){var enabled=Ext.Array.contains(this.value,source.getAttribute("value"));if(enabled&&source.parent().hasCls("dropzone-disabled"))this.queryById("enabled").getTargetEl().appendChild(source.dom);else if(!enabled&&source.parent().hasCls("dropzone-enabled"))this.queryById("available").getTargetEl().appendChild(source.dom)},this);else this.value=val}});Ext.define("Voyant.widget.DownloadFileFormat",{extend:"Ext.form.CheckboxGroup",mixins:["Voyant.util.Localization"],alias:"widget.downloadfileformat",statics:{i18n:{}},initComponent:function(config){config=config||{};var me=this;Ext.apply(this,{labelAlign:config.labelAlign?config.labelAlign:"right"});Ext.applyIf(this,{fieldLabel:this.localize("fieldLabel"),items:[{boxLabel:this.localize("original"),name:"documentFormat",inputValue:"SOURCE"},{boxLabel:this.localize("voyantXml"),name:"documentFormat",
inputValue:"VOYANT"},{boxLabel:this.localize("plainText"),name:"documentFormat",inputValue:"TXT"}],width:450});me.on("afterrender",function(){this.query("checkbox").forEach(function(cmp){var tooltip=this.localize(cmp.inputValue+"Tip");if(tooltip.indexOf(cmp.inputValue+"Tip")==-1)Ext.tip.QuickTipManager.register({target:cmp.getEl(),text:tooltip})},this)},this);me.on("beforedestroy",function(){this.query("checkbox").forEach(function(cmp){Ext.tip.QuickTipManager.unregister(cmp.getEl())},this)},this);
me.callParent(arguments)}});Ext.define("Voyant.widget.DownloadOptions",{extend:"Ext.form.FieldSet",mixins:["Voyant.util.Localization"],requires:["Voyant.widget.DownloadFileFormat","Voyant.widget.DownloadFilenameBuilder"],alias:"widget.downloadoptions",statics:{i18n:{}},config:{items:[{xtype:"downloadfileformat"},{xtype:"downloadfilenamebuilder"}]},initComponent:function(config){config=config||{};var me=this;Ext.apply(this,{title:config.title?config.title:this.localize("title")});me.callParent(arguments)}});Ext.define("Voyant.widget.FontFamilyOption",{extend:"Ext.container.Container",mixins:["Voyant.util.Localization"],alias:"widget.fontfamilyoption",statics:{i18n:{},fonts:[{name:"Georgia",value:"Georgia, serif"},{name:"Palatino",value:'"Palatino Linotype", "Book Antiqua", Palatino, serif'},{name:"Times New Roman",value:'"Times New Roman", Times, serif'},{name:"Arial",value:"Arial, Helvetica, sans-serif"},{name:"Arial Black",value:'"Arial Black", Gadget, sans-serif'},{name:"Comic Sans MS",value:'"Comic Sans MS", cursive, sans-serif'},
{name:"Impact",value:"Impact, Charcoal, sans-serif"},{name:"Lato",value:"LatoWeb"},{name:"Lucida",value:'"Lucida Sans Unicode", "Lucida Grande", sans-serif'},{name:"Tahoma/Geneva",value:"Tahoma, Geneva, sans-serif"},{name:"Trebuchet MS/Helvetica",value:'"Trebuchet MS", Helvetica, sans-serif'},{name:"Verdana/Geneva",value:"Verdana, Geneva, sans-serif"},{name:"Courrier New",value:'"Courier New", Courier, monospace'},{name:"Lucida/Monaco",value:'"Lucida Console", Monaco, monospace'}]},name:"fontFamily",
initComponent:function(config){config=config||{};var me=this;var value=this.up("window").panel.getApiParam("fontFamily");var data=Ext.ClassManager.getClass(this).fonts;if(!Ext.Array.contains(data.map(function(item){return item.value}),value))data.splice(0,0,{name:value,value:value});Ext.apply(me,{items:{xtype:"combo",queryMode:"local",name:"fontFamily",value:value,triggerAction:"all",editable:true,fieldLabel:this.localize("label"),labelAlign:"right",displayField:"name",valueField:"value",store:{fields:["name",
"value"],data:data},width:400}});me.callParent(arguments)}});Ext.define("Voyant.widget.ColorPaletteOption",{extend:"Ext.container.Container",mixins:["Voyant.util.Localization"],alias:"widget.colorpaletteoption",layout:"hbox",statics:{i18n:{}},paletteTpl:new Ext.XTemplate('\x3ctpl for\x3d"."\x3e','\x3cdiv class\x3d"color" style\x3d"background-color: rgb({color});"\x3e\x3c/div\x3e',"\x3c/tpl\x3e"),paletteStore:new Ext.data.ArrayStore({fields:["id","color"],listeners:{update:function(store,record,op,mod,details){},scope:this}}),editPaletteWin:null,spectrum:null,
initComponent:function(config){var me=this;var app=this.up("window").panel.getApplication();var data=[];for(var key in app.getPalettes())data.push({name:key,value:key});var value=app.getApiParam("palette");Ext.apply(me,{items:[{xtype:"combo",queryMode:"local",value:value,triggerAction:"all",editable:true,fieldLabel:me.localize("palette"),labelAlign:"right",name:"palette",displayField:"name",valueField:"value",store:{fields:["name","value"],data:data}},{width:10},{xtype:"tbspacer"},{xtype:"button",
text:this.localize("editList"),ui:"default-toolbar",handler:this.editPalette,scope:this}]});me.callParent(arguments)},editPalette:function(){var value=this.down("combo").getValue();this.loadPalette(value);this.editPaletteWin=Ext.create("Ext.window.Window",{title:this.localize("paletteEditor"),modal:true,height:300,width:425,padding:5,layout:{type:"hbox",align:"stretch"},items:[{flex:1,layout:{type:"vbox",align:"stretch"},items:[{height:24,margin:"0 0 5 0",items:[{xtype:"button",text:this.localize("add"),
margin:"0 5 0 0",handler:function(btn){var color=this.spectrum.spectrum("get").toRgb();var dv=this.editPaletteWin.down("dataview");this.paletteStore.add([[Ext.id(),[color.r,color.g,color.b]]]);dv.refresh()},scope:this},{xtype:"button",text:this.localize("remove"),margin:"0 5 0 0",handler:function(btn){var dv=this.editPaletteWin.down("dataview");var sel=dv.getSelectionModel().getSelection()[0];if(sel!=null)this.paletteStore.remove(sel);dv.refresh()},scope:this},{xtype:"button",text:this.localize("clear"),
handler:function(btn){this.paletteStore.removeAll()},scope:this}]},{xtype:"dataview",flex:1,scrollable:"y",store:this.paletteStore,tpl:this.paletteTpl,itemSelector:"div.color",overItemCls:"over",selectedItemCls:"selected",selectionModel:{mode:"SINGLE"},listeners:{selectionchange:function(viewmodel,selected,opts){if(selected[0]!=null){var color=selected[0].get("color");var parentPanel=this.up("window").panel;var hex=parentPanel.getApplication().rgbToHex(color);this.spectrum.spectrum("set",hex)}},scope:this}}]},
{itemId:"colorEditor",width:200,margin:"0 0 0 5",html:'\x3cinput type\x3d"text" style\x3d"display: none;" /\x3e'}],buttons:[{text:this.localize("saveNewPalette"),handler:function(btn){this.savePalette();btn.up("window").close()},scope:this},{text:this.localize("cancel"),handler:function(btn){btn.up("window").close()},scope:this}],listeners:{close:function(panel){if(this.spectrum){this.spectrum.spectrum("destroy");this.spectrum=null}},scope:this}}).show();this.initSpectrum()},setColorForSelected:function(color){if(this.spectrum!==
null){var rgb=color.toRgb();var rgbA=[rgb.r,rgb.g,rgb.b];var dv=this.editPaletteWin.down("dataview");var sel=dv.getSelectionModel().getSelection()[0];if(sel!=null)sel.set("color",rgbA)}},initSpectrum:function(){if(this.spectrum===null){var editor=this.editPaletteWin.down("#colorEditor");var input=editor.el.down("input");this.spectrum=$(input.dom).spectrum({flat:true,showInput:true,showButtons:false,preferredFormat:"hex",change:this.setColorForSelected.bind(this),move:this.setColorForSelected.bind(this)})}},
loadPalette:function(paletteId){var parentPanel=this.up("window").panel;var palette=parentPanel.getApplication().getColorPalette(paletteId);var paletteData=[];palette.forEach(function(c){paletteData.push([Ext.id(),c])},this);this.paletteStore.loadData(paletteData)},savePalette:function(){var value=[];this.paletteStore.each(function(c){value.push(c.get("color"))});var valueString=Ext.encode(value);var parentPanel=this.up("window").panel;var corpusId=parentPanel.getCorpus().getId();Ext.Ajax.request({url:parentPanel.getTromboneUrl(),
params:{tool:"resource.StoredResource",storeResource:valueString,corpus:corpusId},success:function(response,req){var json=Ext.util.JSON.decode(response.responseText);var id=json.storedResource.id;var combo=this.down("combo");var store=combo.getStore();store.add({name:id,value:id});combo.setValue(id);combo.updateLayout();parentPanel.getApplication().addColorPalette(id,value)},scope:this})}});Ext.define("Voyant.widget.VoyantChart",{extend:"Ext.chart.CartesianChart",mixins:["Voyant.util.Localization","Voyant.util.Api","Voyant.notebook.util.Embed"],alias:"widget.voyantchart",statics:{i18n:{},api:{tableJson:undefined}},constructor:function(config){config=config||{};var me=this;this.mixins["Voyant.util.Api"].constructor.apply(this,arguments);this.callParent(arguments)},initComponent:function(config){config=config||{};this.on("afterrender",function(){if(config&&"tableJson"in config)Ext.apply(this,
this.getConfigFromTableJson(config.tableJson));else if(this.getApiParam("tableJson")){var chart=this.getConfigFromTableJson();this.setAxes(chart.axes);this.setSeries(chart.series);this.setLegend(chart.legend);this.setStore(chart.store);this.redraw()}},this);this.callParent(arguments)},getConfigFromTableJson:function(jsonString){jsonString=jsonString||this.getApiParam("tableJson");if(!jsonString)return{};var json=JSON.parse(jsonString);json.headers=json.headers.map(function(header){return header});
if(json.headers.length==1){json.headers.push(1);json.rowKey=1;json.rows.forEach(function(row,i){if(row)row.push(i)})}var data=[];if(!json.rowKey)json.rowKey=json.headers[0];json.rows.forEach(function(row,i){if(row){var map={};map[json.rowKey]=i;row=row.forEach(function(cell,j){map[json.headers[j]]=cell});data.push(map)}});if(!json.config)json.config={};var chart={store:{fields:Object.keys(data[0]),data:data},axes:Ext.isArray(json.config.axes)?json.config.axes:[{},{}],series:[],legend:json.config.noLegend||
Object.keys(data[0]).length<3?undefined:{docked:"top"}};if(!json.config.axes)json.config.axes=[{},{}];chart.axes.forEach(function(axis,i){if(Ext.isObject(json.config.axes))Ext.apply(axis,json.config.axes);else if(Ext.isArray(json.config.axes))Ext.apply(axis,json.config.axes[i]);Ext.applyIf(axis,{type:i==0?"numeric":"category",position:i==0?"left":"bottom",label:i==0?{}:{rotation:{degrees:-30}}})});for(var i=0,len=json.headers.length;i<len;i++){if(json.headers[i]==json.rowKey)continue;var cfg={};if(json.config.series)if(Ext.isObject(json.config.series))Ext.apply(cfg,
json.config.series);else if(Ext.isArray(json.config.series))Ext.apply(cfg,json.config.series[chart.series.length]);Ext.applyIf(cfg,{type:"line",xField:json.rowKey,yField:json.headers[i],marker:{radius:2},highlightCfg:{scaling:2},tooltip:{trackMouse:true,renderer:function(tooltip,record,item){tooltip.setHtml(record.get(item.series.getYField())+": "+record.get(item.series.getYField()))}}});chart.series.push(cfg)}return chart}});Ext.define("Voyant.widget.LiveSearchGrid",{extend:"Ext.grid.Panel",searchValue:null,matches:[],currentIndex:null,searchRegExp:null,caseSensitive:false,regExpMode:false,matchCls:"keyword",initComponent:function(){var me=this;me.callParent(arguments)},tagsRe:/<[^>]*>/gm,tagsProtect:"\u000f",onTextFieldChange:function(field,val){var me=this,count=0,view=me.view,cellSelector=view.cellSelector,innerSelector=view.innerSelector,columns=me.visibleColumnManager.getColumns();view.refresh();me.searchValue=val;
me.matches=[];me.currentIndex=null;if(me.searchValue!==null){me.searchRegExp=new RegExp(val,"g"+(me.caseSensitive?"":"i"));me.store.each(function(record,idx){var node=view.getNode(record);if(node)Ext.Array.forEach(columns,function(column){var cell=Ext.fly(node).down(column.getCellInnerSelector(),true),matches,cellHTML,seen;if(cell&&column.isXType("widgetcolumn")==false){matches=cell.innerHTML.match(me.tagsRe);cellHTML=cell.innerHTML.replace(me.tagsRe,me.tagsProtect);cellHTML=cellHTML.replace(me.searchRegExp,
function(m){++count;if(!seen){me.matches.push({record:record,column:column});seen=true}return'\x3cspan class\x3d"'+me.matchCls+'"\x3e'+m+"\x3c/span\x3e"},me);Ext.each(matches,function(match){cellHTML=cellHTML.replace(me.tagsProtect,match)});cell.innerHTML=cellHTML}})},me);if(count){me.currentIndex=0;me.gotoCurrent()}}if(me.currentIndex===null)me.getSelectionModel().deselectAll();field.focus()},privates:{gotoCurrent:function(){var pos=this.matches[this.currentIndex];this.getNavigationModel().setPosition(pos.record,
pos.column);this.getSelectionModel().select(pos.record)}}});Ext.define("Voyant.widget.ProgressMonitor",{extend:"Ext.Base",mixins:["Voyant.util.Localization"],msgbox:undefined,statics:{i18n:{}},config:{progress:undefined,scope:undefined,success:undefined,failure:undefined,args:undefined,tool:undefined,delay:1E3,maxMillisSinceStart:undefined},constructor:function(config){config=config||{};this.mixins["Voyant.util.Localization"].constructor.apply(this,arguments);if(!config||!config.progress||!config.progress.id)return Voyant.application.showError(this.localize("noProgress"));
this.initConfig(config);this.callParent(arguments);this.update()},update:function(){var progress=this.getProgress(),scope=this.getScope();var msg=scope.localize?scope.localize(progress.code):this.localize(progress.code);if(msg=="["+progress.code+"]")msg=progress.message;msg+=" ("+parseInt(progress.completion*100)+"%)";var text=this.localize(progress.status.toLowerCase());if(!this.msgbox||this.msgbox.msg.html!=msg||!this.msgbox.progressBar||this.msgbox.progressBar.getText()!=text)this.msgbox=Ext.Msg.wait(msg,
this.localize("progress"),{text:text});if(progress.status=="LAUNCH"||progress.status=="RUNNING"){var me=this;Ext.defer(function(){Ext.Ajax.request({url:Voyant.application.getTromboneUrl(),params:{tool:"progress.ProgressMonitor",id:progress.id,maxMillisSinceStart:me.getMaxMillisSinceStart()}}).then(function(response,opt){var data=Ext.decode(response.responseText);if(data&&data.progress.progress){me.setProgress(data.progress.progress);me.update()}else me.finish(false,me.localize("badProgress"))},function(response,
opt){me.finish(false,response)})},this.getDelay(),this)}else this.finish(progress.status=="FINISHED",msg);if(this.getDelay()<5E3)this.setDelay(this.getDelay()+500)},finish:function(success,response){var callback=success?this.getSuccess():this.getFailure();var args=this.getArgs(),progress=this.getProgress(),scope=this.getScope();this.close();if(callback&&callback.apply)callback.apply(scope,[success?args:response||progress]);else Voyant.application.showError(response)},close:function(){if(this.msgbox)this.msgbox.close();
this.destroy()}});Ext.define("Voyant.widget.VoyantTableTransform",{extend:"Ext.panel.Panel",mixins:["Voyant.util.Localization","Voyant.util.Api","Voyant.notebook.util.Embed"],alias:"widget.voyanttabletransform",statics:{i18n:{},api:{tableHtml:undefined,tableJson:undefined,width:undefined,api:undefined}},html:"",config:{hiddenColumns:undefined},constructor:function(config){config=config||{};var me=this;me.callParent(arguments)},initComponent:function(config){var me=this,config=config||{};me.mixins["Voyant.util.Api"].constructor.apply(this,
arguments);if(this.config.api&&this.config.api.tableJson)this.setApiParam("tableJson",this.config.api.tableJson);me.on("afterrender",function(){me.buildFromParams();var table=this.getTargetEl().down("table");if(table){var parent=table.parent();var grid=new Ext.ux.grid.TransformGrid(table,{width:this.getApiParam("width")||parent.getWidth(),height:this.getApiParam("height")||20+table.query("tr").length*24});grid.render(parent);if(this.getHiddenColumns()){var hides={};Ext.Array.from(this.getHiddenColumns()).forEach(function(header){hides[header]=
true});grid.getColumns().forEach(function(column){if(column.text in hides)column.hide()});Ext.defer(function(){grid.setWidth(grid.getEl().dom.parentNode.offsetWidth)},10)}}},me);me.callParent(arguments)},buildFromParams:function(){var me=this,tableHtml=this.getApiParam("tableHtml"),tableJson=this.getApiParam("tableJson");if(tableHtml)this.setHtml(tableHtml);else if(tableJson){var html="\x3ctable\x3e\x3cthead\x3e\x3ctr\x3e",json=JSON.parse(tableJson);if(json.headers)json.headers.forEach(function(header){html+=
"\x3cth\x3e"+header+"\x3c/th\x3e"});else json.rows[0].forEach(function(cell,i){html+="\x3cth\x3e"+(i+1)+"\x3c/th\x3e"});html+="\x3c/tr\x3e\x3c/thead\x3e\x3ctbody\x3e";json.rows.forEach(function(row){html+="\x3ctr\x3e";row.forEach(function(cell){html+="\x3ctd\x3e"+cell+"\x3c/td\x3e"});html+="\x3c/tr\x3e"});html+="\x3c/tbody\x3e\x3c/table\x3e";this.setHtml(html);if(json.config&&json.config.hidden)this.setHiddenColumns(json.config.hidden)}}});
Ext.define("Ext.ux.grid.TransformGrid",{extend:"Ext.grid.Panel",constructor:function(table,config){config=Ext.apply({},config);this.table=Ext.get(table);var configFields=config.fields||[],configColumns=config.columns||[],fields=[],cols=[],headers=table.query("thead th"),i=0,len=headers.length,data=table.dom,width,height,store,col,text,name;for(;i<len;++i){col=headers[i];text=col.innerHTML;name="tcol-"+i;fields.push(Ext.applyIf(configFields[i]||{},{name:name,mapping:"td:nth("+(i+1)+")/@innerHTML"}));
cols.push(Ext.applyIf(configColumns[i]||{},{text:text,dataIndex:name,flex:1,tooltip:col.title,sortable:true}))}if(config.width)width=config.width;else width=table.getWidth()+1;if(config.height)height=config.height;Ext.applyIf(config,{store:{data:data,fields:fields,proxy:{type:"memory",reader:{record:"tbody tr",type:"xml"}}},columns:cols,width:width,height:height});this.callParent([config]);if(config.remove!==false)data.parentNode.removeChild(data)},doDestroy:function(){this.table.remove();this.tabl=
null;this.callParent()}});Ext.define("Voyant.widget.CategoriesOption",{extend:"Ext.container.Container",mixins:["Voyant.util.Localization"],alias:"widget.categoriesoption",statics:{i18n:{}},config:{builderWin:undefined},initComponent:function(){var value=this.up("window").panel.getApiParam("categories");var data=value?[{name:value,value:value}]:[];Ext.apply(this,{layout:"hbox",items:[{xtype:"combo",queryMode:"local",triggerAction:"all",fieldLabel:this.localize("categories"),labelAlign:"right",displayField:"name",valueField:"value",
store:{fields:["name","value"],data:data},name:"categories",value:value},{width:10},{xtype:"tbspacer"},{xtype:"button",text:this.localize("edit"),ui:"default-toolbar",handler:function(){if(this.getBuilderWin()===undefined){var panel=this.up("window").panel;var win=Ext.create("Voyant.widget.CategoriesBuilder",{panel:panel,height:panel.getApplication().getViewport().getHeight()*.75,width:panel.getApplication().getViewport().getWidth()*.75});win.on("close",function(win){var id=win.getCategoriesId();
if(id!==undefined){var combo=this.down("combo");var name=id;combo.getStore().add({name:name,value:id});combo.setValue(id);this.up("window").panel.setApiParam("categories",id)}},this);this.setBuilderWin(win)}var categoriesId=this.down("combo").getValue();this.getBuilderWin().setCategoriesId(categoriesId);this.getBuilderWin().show()},scope:this}]});this.callParent(arguments)}});
Ext.define("Voyant.widget.CategoriesBuilder",{extend:"Ext.window.Window",requires:["Voyant.widget.FontFamilyOption"],mixins:["Voyant.util.Localization","Voyant.util.Api"],alias:"widget.categoriesbuilder",statics:{i18n:{title:"Categories Builder",terms:"Terms",term:"Term",rawFreq:"Count",relativeFreq:"Relative",categories:"Categories",addCategory:"Add Category",removeCategory:"Remove Category",removeTerms:"Remove Selected Terms",categoryName:"Category Name",add:"Add",cancel:"Cancel",exists:"Category already exists",
confirmRemove:"Are you sure you want to remove the category?",save:"Save",features:"Features",category:"Category",color:"Color",font:"Font",orientation:"Orientation"},api:{stopList:"auto",query:undefined},features:{color:{xtype:"colorfield",format:"#hex6"},font:{xtype:"combobox",queryMode:"local",displayField:"name",valueField:"value",store:{fields:["name","value"],data:Voyant.widget.FontFamilyOption.fonts}},orientation:{xtype:"combobox",queryMode:"local",displayField:"name",valueField:"value",store:{fields:["name",
"value"],data:[{name:"Horizontal",value:0},{name:"Vertical",value:90}]}}}},config:{corpus:undefined,builderWin:undefined,addCategoryWin:undefined,categoriesId:undefined},closeAction:"hide",modal:true,height:250,width:500,constructor:function(config){config=config||{};if(config.panel){this.panel=config.panel;this.app=this.panel.getApplication();this.categoriesManager=this.app.getCategoriesManager()}else if(window.console)console.warn("can't find panel!");this.mixins["Voyant.util.Api"].constructor.apply(this,
arguments);this.callParent(arguments)},initComponent:function(){Ext.apply(this,{header:false,layout:"fit",onEsc:Ext.emptyFn,items:{xtype:"tabpanel",title:this.localize("title"),tabBarHeaderPosition:1,items:[{layout:"border",title:this.localize("categories"),items:[{title:this.localize("terms"),split:true,width:250,region:"west",layout:"fit",items:{itemId:"terms",xtype:"grid",store:Ext.create("Voyant.data.store.CorpusTermsBuffered",{parentPanel:this}),viewConfig:{plugins:{ptype:"gridviewdragdrop",
ddGroup:"terms",copy:true,enableDrop:false,dragZone:{getDragText:function(){var text="";this.dragData.records.forEach(function(d){text+=d.get("term")+", "});text=text.substr(0,text.length-2);if(text.length>20)text=text.substr(0,20)+"...";return text}}}},selModel:{mode:"MULTI"},columns:[{text:this.localize("term"),dataIndex:"term",flex:1,sortable:true},{text:this.localize("rawFreq"),dataIndex:"rawFreq",width:"autoSize",sortable:true},{text:this.localize("relativeFreq"),dataIndex:"relativeFreq",renderer:function(val){return Ext.util.Format.number(val*
1E6,"0,000")},width:"autoSize",hidden:true,sortable:true}],dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{xtype:"querysearchfield"}]}],listeners:{query:function(src,query){this.setApiParam("query",query);var store=this.queryById("terms").getStore();store.removeAll();store.load()},scope:this}}},{title:this.localize("categories"),itemId:"categories",region:"center",xtype:"panel",layout:{type:"hbox",align:"stretch"},scrollable:"x",dockedItems:[{dock:"bottom",xtype:"toolbar",
overflowHandler:"scroller",items:[{text:this.localize("addCategory"),handler:function(){this.getAddCategoryWin().show()},scope:this},{text:this.localize("removeTerms"),handler:function(){this.queryById("categories").query("grid").forEach(function(grid){grid.getStore().remove(grid.getSelection())},this)},scope:this}]}],items:[]}]},{layout:"fit",itemId:"features",title:this.localize("features"),xtype:"grid",scrollable:"y",store:Ext.create("Ext.data.JsonStore",{fields:["category"]}),columns:[{text:this.localize("category"),
dataIndex:"category",sortable:false,hideable:false,flex:1}]}]},buttons:[{text:this.localize("cancel"),handler:function(btn){this.setCategoriesId(undefined);btn.up("window").close()},scope:this},{text:this.localize("save"),handler:function(btn){this.processFeatures();this.setColorTermsFromCategoryFeatures();this.app.saveCategoryData(this.categoriesManager.getCategoryExportData()).then(function(id){this.setCategoriesId(id);btn.up("window").close()},function(){this.setCategoriesId(undefined);btn.up("window").close()},
null,this)},scope:this}],listeners:{show:function(){if(this.getCategoriesId()&&this.getCategoriesId()!=this.getApiParam("categories"))this.categoriesManager.loadCategoryData(this.getCategoriesId()).then(function(data){this.setColorTermsFromCategoryFeatures();this.buildCategories();this.buildFeatures()},null,null,this);else{this.buildCategories();this.buildFeatures()}this.down("tabpanel").setActiveTab(0)},afterrender:function(builder){builder.on("loadedCorpus",function(src,corpus){this.setCorpus(corpus);
var terms=this.queryById("terms");terms.getStore().load()},builder);this.panel.on("loadedCorpus",function(src,corpus){builder.fireEvent("loadedCorpus",src,corpus)},builder);if(this.panel.getCorpus&&this.panel.getCorpus())builder.fireEvent("loadedCorpus",builder,this.panel.getCorpus());else if(this.panel.getStore&&this.panel.getStore()&&this.panel.getStore().getCorpus&&this.panel.getStore().getCorpus())builder.fireEvent("loadedCorpus",builder,this.panel.getStore().getCorpus())},scope:this}});this.setAddCategoryWin(Ext.create("Ext.window.Window",
{title:this.localize("addCategory"),modal:true,closeAction:"hide",layout:"fit",items:{xtype:"form",width:300,defaults:{labelAlign:"right"},items:[{xtype:"textfield",fieldLabel:this.localize("categoryName"),name:"categoryName",allowBlank:false,validator:function(val){return this.categoriesManager.getCategoryTerms(val)===undefined?true:this.localize("exists")}.bind(this),enableKeyEvents:true,listeners:{keypress:function(field,evt){if(evt.getKey()===Ext.event.Event.ENTER)field.up("form").queryById("addCategoryButton").click()},
scope:this}}],buttons:[{text:this.localize("cancel"),handler:function(btn){btn.up("window").close()}},{itemId:"addCategoryButton",text:this.localize("add"),handler:function(btn){var form=btn.up("form");if(form.isValid()){var name=form.getValues()["categoryName"];this.addCategory(name);btn.up("window").close()}},scope:this}]},listeners:{show:function(win){var form=win.down("form").getForm();form.reset();form.clearInvalid()}}}));this.callParent(arguments)},addCategory:function(name){this.categoriesManager.addCategory(name);
this.queryById("features").getStore().add({category:name});var termsData=[];var terms=this.categoriesManager.getCategoryTerms(name);if(terms!==undefined)for(var i=0;i<terms.length;i++)termsData.push({term:terms[i]});var grid=this.queryById("categories").add({xtype:"grid",category:name,title:name,frame:true,width:150,margin:"10 0 10 10",layout:"fit",tools:[{type:"close",tooltip:this.localize("removeCategory"),callback:function(panel){Ext.Msg.confirm(this.localize("removeCategory"),this.localize("confirmRemove"),
function(btn){if(btn==="yes")this.removeCategory(name)},this)},scope:this}],store:Ext.create("Ext.data.JsonStore",{data:termsData,fields:["term"]}),viewConfig:{plugins:{ptype:"gridviewdragdrop",ddGroup:"terms",dragZone:{getDragText:function(){var text="";this.dragData.records.forEach(function(d){text+=d.get("term")+", "});return text.substr(0,text.length-2)}}}},selModel:{mode:"MULTI"},columns:[{dataIndex:"term",flex:1,sortable:true}],listeners:{beforedrop:function(node,data){var categoriesManager=
this.up("categoriesbuilder").categoriesManager;for(var i=data.records.length-1;i>=0;i--){var term=data.records[i].get("term");if(categoriesManager.getCategoryForTerm(term)!==undefined)data.records.splice(i,1)}},drop:function(node,data){data.view.getSelectionModel().deselectAll();this.getSelectionModel().deselectAll();var categoriesManager=this.up("categoriesbuilder").categoriesManager;var terms=[];for(var i=0;i<data.records.length;i++){var term=data.records[i].get("term");if(categoriesManager.getCategoryForTerm(term)===
undefined)terms.push(term)}categoriesManager.addTerms(name,terms);var source=data.view.up("grid");if(source.category)categoriesManager.removeTerms(source.category,terms)}}});var titleEditor=new Ext.Editor({updateEl:true,alignment:"l-l",autoSize:{width:"boundEl"},field:{xtype:"textfield",allowBlank:false,validator:function(val){return this.categoriesManager.getCategoryTerms(val)===undefined||val===grid.getTitle()?true:this.localize("exists")}.bind(this)},listeners:{complete:function(ed,newvalue,oldvalue){this.categoriesManager.renameCategory(oldvalue,
newvalue);this.buildFeatures()},scope:this}});grid.header.getTitle().textEl.on("dblclick",function(e,t){titleEditor.startEdit(t)})},removeCategory:function(name){var categoriesParent=this.queryById("categories");var panel=categoriesParent.queryBy(function(cmp){if(cmp.category&&cmp.category==name)return true;return false});categoriesParent.remove(panel[0]);var featuresStore=this.queryById("features").getStore();featuresStore.removeAt(featuresStore.findExact("category",name));this.categoriesManager.removeCategory(name)},
addFeature:function(name){this.categoriesManager.addFeature(name);this.buildFeatures()},buildFeatures:function(){this.queryById("features").getStore().removeAll();var fields=["category"];var columns=[{sortable:false,text:this.localize("category"),dataIndex:"category",flex:1}];var data=[];for(var category in this.categoriesManager.getCategories())data.push({category:category});var features=this.categoriesManager.getFeatures();var featuresConfigs=Ext.ClassManager.getClass(this).features;for(var feature in features){fields.push(feature);
var featureConfig=featuresConfigs[feature];var widgetConfig=Ext.applyIf({feature:feature,listeners:{change:function(cmp,newvalue){if(cmp.rendered){var rowIndex=cmp.up("gridview").indexOf(cmp.el.up("table"));var record=cmp.up("grid").getStore().getAt(rowIndex);if(record)record.set(cmp.feature,newvalue);else if(window.console)console.warn("no record for",rowIndex,cmp)}},scope:this}},featureConfig);if(featureConfig.listeners)Ext.applyIf(widgetConfig.listeners,featureConfig.listeners);columns.push({sortable:false,
hideable:false,text:this.localize(feature),dataIndex:feature,flex:.5,xtype:"widgetcolumn",widget:widgetConfig});for(var category in this.categoriesManager.getCategories()){var value=this.categoriesManager.getCategoryFeature(category,feature);for(var i=0;i<data.length;i++)if(data[i].category==category){data[i][feature]=value;break}}}var store=Ext.create("Ext.data.JsonStore",{fields:fields,data:data});this.queryById("features").reconfigure(store,columns)},processFeatures:function(){var store=this.queryById("features").getStore();
var features=Object.keys(this.categoriesManager.getFeatures());store.each(function(record){var category=record.get("category");features.forEach(function(feature){var featureValue=record.get(feature);if(featureValue!==undefined)this.categoriesManager.setCategoryFeature(category,feature,featureValue)},this)},this)},setColorTermsFromCategoryFeatures:function(){for(var category in this.categoriesManager.getCategories()){var color=this.categoriesManager.getCategoryFeature(category,"color");if(color!==
undefined){var rgb=this.app.hexToRgb(color);var terms=this.categoriesManager.getCategoryTerms(category);for(var i=0;i<terms.length;i++)this.app.setColorForTerm(terms[i],rgb)}}},buildCategories:function(){this.queryById("categories").removeAll();var cats=this.categoriesManager.getCategories();for(var key in cats)this.addCategory(key)}});Ext.define("Voyant.widget.VoyantNetworkGraph",{extend:"Ext.panel.Panel",mixins:["Voyant.util.Localization","Voyant.util.Api","Voyant.notebook.util.Embed"],embeddable:["Voyant.widget.VoyantNetworkGraph"],alias:"widget.voyantnetworkgraph",statics:{i18n:{},api:{jsonData:undefined,docId:undefined,docIndex:undefined,json:undefined,api:undefined}},config:{vis:undefined,visLayout:undefined,nodeData:undefined,edgeData:undefined,nodeSelection:undefined,edgeSelection:undefined,currentNode:undefined,currentEdge:undefined,
zoom:undefined,zoomExtent:[.25,8],fixOnDrag:true,nodeScaling:{minSize:8,maxSize:36,scalingFunction:undefined},edgeScaling:{minSize:1,maxSize:10,scalingFunction:undefined},graphStyle:{node:{normal:{fill:"#c6dbef",fillOpacity:1,stroke:"#6baed6",strokeOpacity:1,strokeWidth:1},highlight:{fill:"#9ecae1",fillOpacity:1,stroke:"#3182bd",strokeOpacity:1,strokeWidth:3}},edge:{normal:{stroke:"#000000",strokeOpacity:.25,strokeWidth:1},highlight:{stroke:"#000000",strokeOpacity:.5,strokeWidth:3}}},graphPhysics:{damping:.4,
centralGravity:.1,nodeGravity:-50,springLength:100,springStrength:.25,collisionScale:1.25}},constructor:function(config){config=config||{};this.setNodeData([]);this.setEdgeData([]);this.mixins["Voyant.util.Api"].constructor.apply(this,arguments);this.callParent(arguments);var json={};if(this.getApiParam("jsonData"))json=Ext.decode(this.getApiParam("jsonData"));else if(this.getApiParam("json"))json=this.getApiParam("json");else if(config.json)json=config.json;else if(config.edges){json.edges=config.edges;
if(config.nodes)json.nodes=config.nodes}else if(config&&config.jsonData)json=JSON.parse(config.jsonData);this.loadJson(json)},initComponent:function(config){this.on("boxready",function(src,corpus){this.initGraph();this.refreshGraph()},this);this.on("resize",function(panel,width,height){var vis=this.body.down("svg");if(vis){var el=this.body;var elHeight=el.getHeight();var elWidth=el.getWidth();vis.dom.setAttribute("width",elWidth);vis.dom.setAttribute("height",elHeight);this.getVisLayout().force("x",
d3.forceX(elWidth/2)).force("y",d3.forceY(elHeight/2));if(this.getVisLayout().alpha()<.075)this.getVisLayout().alpha(-1)}},this);this.callParent(arguments)},processJson:function(json){if(!json||!json.edges){if(json&&json.links){json.edges=json.links;delete json.links}if(!json||!json.edges){json=json||{};json.edges=[]}}if(!json.nodes)json.nodes=[];if(json.nodes.length===0){var wordFreq={};json.edges.forEach(function(edge){["source","target"].forEach(function(loc){var term=edge[loc];if(term in wordFreq==
false){wordFreq[term]=1;json.nodes.push({term:term})}else wordFreq[term]++;edge.value=1})},this);json.nodes.forEach(function(node){var val=wordFreq[node.term]===undefined?1:wordFreq[node.term];Ext.applyIf(node,{value:val})})}else json.nodes.forEach(function(node){Ext.applyIf(node,{value:1})});return json},loadJson:function(json){this.processJson(json);var existingTerms={};this.getNodeData().forEach(function(node){existingTerms[node.term]=true},this);var newNodes=[];var newEdges=[];json.nodes.forEach(function(node){if(existingTerms[node.term]===
undefined){node.id=this.idGet(node.term);newNodes.push(node)}},this);json.edges.forEach(function(newedge){var sourceId=this.idGet(newedge.source);var targetId=this.idGet(newedge.target);var edges=this.getEdgeData();var exists=false;for(var i=0;i<edges.length;i++){var edge=edges[i];if(edge.source.id==sourceId&&edge.target.id==targetId||edge.target.id==sourceId&&edge.source.id==targetId){exists=true;break}}if(!exists){newedge.source=sourceId;newedge.target=targetId;newedge.id=sourceId+"-"+targetId;
newEdges.push(newedge)}},this);this.setNodeData(this.getNodeData().concat(newNodes));this.setEdgeData(this.getEdgeData().concat(newEdges));this.refreshGraph()},idGet:function(term){return term.replace(/\W/g,"_")},updateDataForNode:function(nodeId,dataObj){var data=this.getNodeData();for(var i=0;i<data.length;i++)if(data[i].id===nodeId){Ext.apply(data[i],dataObj);break}},updateDataForEdge:function(edgeId,dataObj){var data=this.getEdgeData();for(var i=0;i<data.length;i++)if(data[i].id===edgeId){Ext.apply(data[i],
dataObj);break}},addNode:function(dataObj){if(Ext.isString(dataObj))dataObj={term:dataObj};if(dataObj.term)this.loadJson({nodes:[dataObj]})},removeNode:function(nodeId,removeOrphans){var data=this.getNodeData();for(var i=0;i<data.length;i++)if(data[i].id===nodeId){data.splice(i,1);break}var potentialOrphans={};data=this.getEdgeData();for(var i=data.length-1;i>=0;i--){var match=false;if(data[i].source.id===nodeId){match=true;potentialOrphans[data[i].target.id]=true}if(data[i].target.id===nodeId){match=
true;potentialOrphans[data[i].source.id]=true}if(match)data.splice(i,1)}if(removeOrphans){for(var i=0;i<data.length;i++){if(potentialOrphans[data[i].source.id])delete potentialOrphans[data[i].source.id];if(potentialOrphans[data[i].target.id])delete potentialOrphans[data[i].target.id]}for(var orphanId in potentialOrphans)this.removeNode(orphanId,true)}this.refreshGraph()},addEdge:function(dataObj){if(Ext.isObject(dataObj)&&dataObj.source&&dataObj.target)this.loadJson({edges:[dataObj]})},removeEdge:function(edgeId,
removeOrphans){var data=this.getEdgeData();for(var i=data.length-1;i>=0;i--)if(data[i].id===edgeId)data.splice(i,1);if(removeOrphans){var potentialOrphans={};data=this.getNodeData();for(var i=0;i<data.length;i++)potentialOrphans[data[i].id]=true;data=this.getEdgeData();for(var i=0;i<data.length;i++){if(potentialOrphans[data[i].source.id])delete potentialOrphans[data[i].source.id];if(potentialOrphans[data[i].target.id])delete potentialOrphans[data[i].target.id]}for(var orphanId in potentialOrphans)this.removeNode(orphanId,
true)}this.refreshGraph()},initGraph:function(){var el=this.getLayout().getRenderTarget();el.update("");var width=el.getWidth();var height=el.getHeight();var physics=this.getGraphPhysics();this.setVisLayout(d3.forceSimulation().velocityDecay(physics.damping).force("x",d3.forceX(width/2).strength(physics.centralGravity)).force("y",d3.forceY(height/2).strength(physics.centralGravity)).force("link",d3.forceLink().id(function(d){return d.id}).distance(physics.springLength).strength(physics.springStrength)).force("charge",
d3.forceManyBody().strength(physics.nodeGravity)).force("collide",d3.forceCollide().radius(function(d){return Math.sqrt(d.bbox.width*d.bbox.height)*physics.collisionScale})).on("tick",function(){this.getEdgeSelection().attr("x1",function(d){return d.source.x}).attr("y1",function(d){return d.source.y}).attr("x2",function(d){return d.target.x}).attr("y2",function(d){return d.target.y});this.getNodeSelection().attr("transform",function(d){var x=d.x-d.bbox.width*.5;var y=d.y-d.bbox.height*.5;return"translate("+
x+","+y+")"});if(this.getVisLayout().alpha()<.075)this.getVisLayout().alpha(-1)}.bind(this)).on("end",function(){this.zoomToFit()}.bind(this)));var svg=d3.select(el.dom).append("svg").attr("width",width).attr("height",height);var g=svg.append("g");var zoom=d3.zoom().scaleExtent(this.getZoomExtent()).on("zoom",function(){g.attr("transform",d3.event.transform)});this.setZoom(zoom);svg.call(zoom);this.setEdgeSelection(g.append("g").attr("class","edges").selectAll(".edge"));this.setNodeSelection(g.append("g").attr("class",
"nodes").selectAll(".node"));this.setVis(g)},resetGraph:function(){this.setNodeData([]);this.setEdgeData([]);this.refreshGraph()},refreshGraph:function(){if(this.getVisLayout()===undefined)return;var edgeData=this.getEdgeData();var nodeData=this.getNodeData();var nodeExtent=d3.extent(nodeData,function(d){return d.value});var nodeSum=d3.sum(nodeData,function(d){return d.value});var edgeExtent=d3.extent(edgeData,function(d){return d.value});var edgeSum=d3.sum(edgeData,function(d){return d.value});var edgeScaling=
this.getEdgeScaling();if(edgeScaling.scalingFunction===undefined)edgeScaling.scalingFunction=d3.scaleLinear().domain(edgeExtent).range([edgeScaling.minSize,edgeScaling.maxSize]);var nodeScaling=this.getNodeScaling();if(nodeScaling.scalingFunction===undefined)nodeScaling.scalingFunction=d3.scaleLog().domain(nodeExtent).range([nodeScaling.minSize,nodeScaling.maxSize]);var edge=this.getEdgeSelection().data(edgeData,function(d){return d.id});edge.exit().remove();var edgeEnter=edge.enter().append("line").attr("class",
"edge").attr("id",function(d){return d.id}).style("cursor","pointer").style("stroke-width",function(d){return edgeScaling.scalingFunction(d.value)}).on("mouseover",this.edgeMouseOver.bind(this)).on("mouseout",this.edgeMouseOut.bind(this)).on("click",function(d){d3.event.stopImmediatePropagation();d3.event.preventDefault();this.setCurrentEdge(d);this.fireEvent("edgeclicked",this,d)}.bind(this));this.setEdgeSelection(edgeEnter.merge(edge));var node=this.getNodeSelection().data(nodeData,function(d){return d.id});
node.exit().remove();var nodeEnter=node.enter().append("g").attr("class","node").attr("id",function(d){return d.id}).style("cursor","pointer").on("mouseover",this.nodeMouseOver.bind(this)).on("mouseout",this.nodeMouseOut.bind(this)).on("click",function(d){d3.event.stopImmediatePropagation();d3.event.preventDefault();this.setCurrentNode(d);this.fireEvent("nodeclicked",this,d)}.bind(this)).on("dblclick",function(d){d3.event.stopImmediatePropagation();d3.event.preventDefault();this.fireEvent("nodedblclicked",
this,d)}.bind(this)).on("contextmenu",function(d){d3.event.stopImmediatePropagation();d3.event.preventDefault();this.fireEvent("nodecontextclicked",this,d)}.bind(this)).call(d3.drag().on("start",function(d){if(!d3.event.active)this.getVisLayout().alphaTarget(.3).restart();if(this.getFixOnDrag()){d.fx=d.x;d.fy=d.y}this.fireEvent("nodedragstart",this,d)}.bind(this)).on("drag",function(d){if(this.getFixOnDrag()){d.fx=d3.event.x;d.fy=d3.event.y}else{d.x=d3.event.x;d.y=d3.event.y}this.fireEvent("nodedrag",
this,d)}.bind(this)).on("end",function(d){if(!d3.event.active)this.getVisLayout().alphaTarget(0);this.fireEvent("nodedragend",this,d)}.bind(this)));nodeEnter.append("rect");nodeEnter.append("text").text(function(d){return d.term}).attr("font-size",function(d){return nodeScaling.scalingFunction(d.value)+"px"}).attr("dominant-baseline","middle").style("user-select","none").each(function(d){d.bbox=this.getBBox()});this.setNodeSelection(nodeEnter.merge(node));this.getNodeSelection().selectAll("rect").attr("width",
function(d){return d.bbox.width+16}).attr("height",function(d){return d.bbox.height+8}).attr("rx",function(d){return Math.max(2,d.bbox.height*.2)}).attr("ry",function(d){return Math.max(2,d.bbox.height*.2)});this.getNodeSelection().selectAll("text").attr("dx",8).attr("dy",function(d){return d.bbox.height*.5+4});this.getEdgeSelection().call(this.applyEdgeStyle.bind(this));this.getNodeSelection().call(this.applyNodeStyle.bind(this));this.getVisLayout().nodes(nodeData);this.getVisLayout().force("link").links(edgeData);
this.getVisLayout().alpha(1).restart()},zoomToFit:function(paddingPercent,transitionDuration){var bounds=this.getVis().node().getBBox();var width=bounds.width;var height=bounds.height;var midX=bounds.x+width/2;var midY=bounds.y+height/2;var svg=this.getVis().node().parentElement;var svgRect=svg.getBoundingClientRect();var fullWidth=svgRect.width;var fullHeight=svgRect.height;var scale=(paddingPercent||.8)/Math.max(width/fullWidth,height/fullHeight);var translate=[fullWidth/2-scale*midX,fullHeight/
2-scale*midY];d3.select(svg).transition().duration(transitionDuration||500).call(this.getZoom().transform,d3.zoomIdentity.translate(translate[0],translate[1]).scale(scale))},nodeScaling:function(min,max,total,value){if(min===max)return.5;else{var scale=1/(max-min);return Math.max(0,(value-min)*scale)}},applyNodeStyle:function(sel,nodeState){var state=nodeState===undefined?"normal":nodeState;var style=this.getGraphStyle().node[state];sel.selectAll(":not(text)").style("fill",function(d){return style.fill}.bind(this)).style("fill-opacity",
function(d){return style.fillOpacity}.bind(this)).style("stroke",function(d){return style.stroke}.bind(this)).style("stroke-opacity",function(d){return style.strokeOpacity}.bind(this)).style("stroke-width",function(d){return style.strokeWidth}.bind(this))},applyEdgeStyle:function(sel,edgeState){var state=edgeState===undefined?"normal":edgeState;var style=this.getGraphStyle().edge[state];sel.style("stroke",function(d){return style.stroke}.bind(this)).style("stroke-opacity",function(d){return style.strokeOpacity}.bind(this))},
edgeMouseOver:function(d){this.getEdgeSelection().call(this.applyEdgeStyle.bind(this));this.getVis().select("#"+d.id).call(this.applyEdgeStyle.bind(this),"highlight")},edgeMouseOut:function(d){this.getEdgeSelection().call(this.applyEdgeStyle.bind(this))},nodeMouseOver:function(d){this.setCurrentNode(d);this.getNodeSelection().call(this.applyNodeStyle.bind(this));this.getEdgeSelection().each(function(link){var id;if(link.source.id==d.id)id=link.target.id;else if(link.target.id==d.id)id=link.source.id;
if(id!==undefined){this.getVis().select("#"+id).call(this.applyNodeStyle.bind(this),"highlight");this.getVis().select("#"+link.id).call(this.applyEdgeStyle.bind(this),"highlight")}}.bind(this));this.getVis().select("#"+d.id).call(this.applyNodeStyle.bind(this),"highlight")},nodeMouseOut:function(d){this.getNodeSelection().call(this.applyNodeStyle.bind(this));this.getEdgeSelection().call(this.applyEdgeStyle.bind(this))}});Ext.define("Voyant.widget.ReaderGraph",{extend:"Ext.container.Container",mixins:["Voyant.util.Localization"],alias:"widget.readergraph",statics:{i18n:{}},config:{parentPanel:undefined,corpus:undefined,documentsStore:undefined,documentTermsStore:undefined,locationMarker:undefined,isDetailedGraph:true},locationMarkerColor:"#157fcc",DETAILED_GRAPH_DOC_LIMIT:25,LOCATION_UPDATE_FREQ:100,SCROLL_UP:-1,SCROLL_EQ:0,SCROLL_DOWN:1,constructor:function(config){this.callParent(arguments)},initComponent:function(){Ext.apply(this,
{layout:{type:"hbox"},items:[]});this.setDocumentTermsStore(Ext.create("Ext.data.Store",{model:"Voyant.data.model.DocumentTerm",autoLoad:false,remoteSort:false,proxy:{type:"ajax",url:Voyant.application.getTromboneUrl(),extraParams:{tool:"corpus.DocumentTerms",withDistributions:true,withPositions:true,bins:25,forTool:"reader"},reader:{type:"json",rootProperty:"documentTerms.terms",totalProperty:"documentTerms.total"},simpleSortMode:true},listeners:{load:function(store,records,successful,opts){store.sort("docIndex",
"ASC");var graphDatas={};var maxValue=0;store.each(function(r){var graphData=[];var dist=r.get("distributions");var docId=r.get("docId");var docIndex=r.get("docIndex");var term=r.get("term");for(var i=0;i<dist.length;i++){var bin=i;var val=dist[i];if(val>maxValue)maxValue=val;graphData.push([docId,docIndex,bin,val,term])}graphDatas[docIndex]=graphData},this);if(this.getIsDetailedGraph()){var graphs=this.query("cartesian");for(var i=0;i<graphs.length;i++){var graph=graphs[i];var data=graphDatas[i];
if(data!==undefined){graph.getAxes()[0].setMaximum(maxValue);graph.getStore().loadData(data)}else graph.getStore().removeAll()}}},scope:this}}));this.callParent(arguments);var parentPanel=this.findParentBy(function(clz){return clz.mixins["Voyant.panel.Panel"]});if(parentPanel!=null){this.setParentPanel(parentPanel);if(parentPanel.getCorpus&&parentPanel.getCorpus())this.on("afterrender",function(c){this.setCorpus(parentPanel.getCorpus())},this);else{parentPanel.on("loadedCorpus",function(src,corpus){this.setCorpus(corpus)},
this);this.hasCorpusLoadedListener=true}}this.on("boxready",function(){if(this.getLocationMarker()==undefined)this.setLocationMarker(Ext.DomHelper.append(this.getEl(),{tag:"div",style:"background-color: "+this.locationMarkerColor+"; height: 100%; width: 2px; position: absolute; top: 0; left: 0;"}))})},updateCorpus:function(corpus){var docs=corpus.getDocuments();this.setDocumentsStore(docs);this.getDocumentTermsStore().getProxy().setExtraParam("corpus",corpus.getId());this.setIsDetailedGraph(docs.getTotalCount()<
this.DETAILED_GRAPH_DOC_LIMIT);this.generateChart(corpus,this)},loadQueryTerms:function(queryTerms){if(queryTerms&&queryTerms.length>0)this.getDocumentTermsStore().load({params:{query:queryTerms}})},generateChart:function(corpus,container){function getColor(index,alpha){var c=this.getParentPanel().getApplication().getColor(index);return"rgba("+c[0]+","+c[1]+","+c[2]+","+alpha+")"}function map(value,istart,istop,ostart,ostop){return ostart+(ostop-ostart)*((value-istart)/(istop-istart))}function addChart(docInfo){var index=
docInfo.index;var fraction=docInfo.fraction;var height=docInfo.relativeHeight;var bColor=getColor.call(this,index,.3);var sColor=getColor.call(this,index,1);var chart=container.add({xtype:"cartesian",plugins:{ptype:"chartitemevents"},flex:fraction,height:"100%",insetPadding:0,background:{type:"linear",degrees:90,stops:[{offset:0,color:bColor},{offset:height,color:bColor},{offset:height,color:"white"},{offset:1,color:"white"}]},axes:[{type:"numeric",position:"left",fields:"distribution",hidden:true},
{type:"category",position:"bottom",fields:"bin",hidden:true}],series:[{type:"line",xField:"bin",yField:"distribution",style:{lineWidth:2,strokeStyle:sColor},tooltip:{corpus:corpus,trackMouse:true,style:"background: #fff",showDelay:0,dismissDelay:500,hideDelay:5,renderer:function(toolTip,record,ctx){toolTip.setHtml(corpus.getDocument(record.get("docIndex")).getTitle()+"\x3cbr\x3e"+record.get("term")+": "+record.get("distribution"))}}}],store:Ext.create("Ext.data.ArrayStore",{fields:["docId","docIndex",
"bin","distribution","term"],data:[]}),listeners:{itemclick:function(chart,item,event){},scope:this}});chart.body.on("click",function(event,target){var el=Ext.get(target);var x=event.getX();var box=el.getBox();var fraction=(x-box.x)/box.width;var chartContainer=el.parent(".x-panel");var containerParent=chartContainer.parent();var children=Ext.toArray(containerParent.dom.children);var docIndex=children.indexOf(chartContainer.dom);this.fireEvent("documentRelativePositionSelected",this,{docIndex:docIndex,
fraction:fraction})},this)}container.removeAll();var docs=corpus.getDocuments();var tokensTotal=corpus.getWordTokensCount();var docInfos=[];var docMinSize=Number.MAX_VALUE;var docMaxSize=-1;for(var i=0;i<docs.getCount();i++){var d=docs.getAt(i);var docIndex=d.get("index");var count=d.get("tokensCount-lexical");if(count<docMinSize)docMinSize=count;if(count>docMaxSize)docMaxSize=count;var fraction=count/tokensTotal;docInfos.push({index:docIndex,count:count,fraction:fraction})}if(this.getIsDetailedGraph())for(var i=
0;i<docInfos.length;i++){var d=docInfos[i];d.relativeHeight=d.count==docMaxSize?1:map(d.count,docMinSize,docMaxSize,.25,1);addChart.call(this,d)}else var chart=container.add({xtype:"cartesian",plugins:{ptype:"chartitemevents"},flex:1,height:"100%",insetPadding:0,axes:[{type:"numeric",position:"left",fields:"count",hidden:true},{type:"category",position:"bottom",fields:"index",hidden:true}],series:[{type:"bar",xField:"index",yField:"count",style:{minGapWidth:0,minBarWidth:1,lineWidth:0,strokeStyle:"none"},
renderer:function(sprite,config,rendererData,index){return{fillStyle:getColor.call(this,index,.3)}}.bind(this)}],store:Ext.create("Ext.data.JsonStore",{fields:[{name:"index",type:"int"},{name:"count",type:"int"},{name:"fraction",type:"float"}],data:docInfos}),listeners:{itemclick:function(chart,item,event){var el=Ext.get(event.getTarget());var x=event.getX();var box=el.getBox();var docWidth=box.width/this.getCorpus().getDocuments().getCount();var docX=(x-box.x)%docWidth;var fraction=docX/docWidth;
var data=item.record.data;var doc=this.getDocumentsStore().getAt(data.index);var docIndex=doc.getIndex();this.fireEvent("documentRelativePositionSelected",this,{docIndex:docIndex,fraction:fraction})},scope:this}})},moveLocationMarker:function(docIndex,fraction,scrollDir){var locMarkEl=Ext.get(this.getLocationMarker());var locX=locMarkEl.getX();if(this.getIsDetailedGraph()){var graph=this.query("cartesian")[docIndex];if(graph)locX=graph.getX()+graph.getWidth()*fraction}else{var graph=this.down("cartesian");
var docWidth=graph.getWidth()/this.getCorpus().getDocuments().getCount();locX=graph.getX()+docWidth*docIndex+docWidth*fraction}if(scrollDir!=null){var currX=locMarkEl.getX();if(scrollDir==this.SCROLL_DOWN&&currX>locX||scrollDir==this.SCROLL_UP&&currX<locX)locX=currX}locMarkEl.setX(locX)}});Ext.define("Voyant.panel.Panel",{mixins:["Voyant.util.Localization","Voyant.util.Api","Voyant.util.Toolable","Voyant.util.DetailedError"],requires:["Voyant.widget.QuerySearchField","Voyant.widget.StopListOption","Voyant.widget.CategoriesOption","Voyant.widget.TotalPropertyStatus"],alias:"widget.voyantpanel",statics:{i18n:{},config:{corpusValidated:false},api:{corpus:undefined,input:undefined,inputFormat:undefined,subtitle:undefined}},config:{corpus:undefined},constructor:function(config){this.mixins["Voyant.util.Api"].constructor.apply(this,
arguments);this.mixins["Voyant.util.Toolable"].constructor.apply(this,arguments);if(!this.glyph)this.glyph=Ext.ClassManager.getClass(this).glyph;this.on("afterrender",function(){if(this.getXType()!="facet"&&this.getApiParam("subtitle")&&this.getTitle())this.setTitle(this.getTitle()+" \x3ci style\x3d'font-size: smaller;'\x3e"+this.getApiParam("subtitle")+"\x3c/i\x3e");if(this.isXType("grid")){this.getSelectionModel().on("selectionchange",function(store,records){},this);this.getStore().on("beforeload",
function(){this.selectedRecordsToRemember=this.getSelection()},this);this.getStore().on("load",function(store,records){if(Ext.Array.from(this.selectedRecordsToRemember).length>0){var seen={};var mergedRecords=Ext.Array.merge(this.selectedRecordsToRemember,records).filter(function(item){if(!(item.getId()in seen)){seen[item.getId()]=true;return true}else return false});if(store.isBufferedStore){if(store.currentPage==1){store.data.addAll(mergedRecords);store.totalCount=mergedRecords.length;store.fireEvent("refresh",
store)}}else{store.loadRecords(mergedRecords);this.getSelectionModel().select(this.selectedRecordsToRemember);store.fireEvent("refresh",store);this.selectedRecordsToRemember=[]}}},this)}},this);this.on({loadedCorpus:{fn:function(src,corpus){this.setApiParam("corpus",corpus.getAliasOrId());this.setCorpus(corpus)},priority:999,scope:this}})},getApplication:function(){return Voyant.application},getBaseUrl:function(){return this.getApplication().getBaseUrl()},openUrl:function(url){this.getApplication().openUrl.apply(this,
arguments)},getTromboneUrl:function(){return this.getApplication().getTromboneUrl()},dispatchEvent:function(){var application=this.getApplication();application.dispatchEvent.apply(application,arguments)},showError:function(config,response){if(Ext.isString(config))config={message:config};Ext.applyIf(config,{title:this.localize("error")+" ("+this.localize("title")+")"});this.getApplication().showError(config,response)},showResponseError:function(config,response){this.getApplication().showResponseError(config,
response)},toastError:function(config){if(Ext.isString(config))config={html:config};Ext.applyIf(config,{glyph:"xf071@FontAwesome",title:this.localize("error")});this.toast(config)},toastInfo:function(config){if(Ext.isString(config))config={html:config};Ext.applyIf(config,{glyph:"xf05a@FontAwesome",title:this.localize("info")});this.toast(config)},toast:function(config){if(Ext.isString(config))config={html:config};Ext.applyIf(config,{slideInDuration:500,shadow:true,align:"b",anchor:this.getTargetEl()});
Ext.toast(config)},hasCorpusAccess:function(corpus){var app=this.getApplication();if(app){var corpusAccess=app.getCorpusAccess();if(corpusAccess=="ADMIN"||corpusAccess=="ACCESS")return true}if(!corpus){if(this.getCorpus)corpus=this.getCorpus();if(!corpus&&app.getCorpus)corpus=app.getCorpus()}if(corpus)return corpus.getNoPasswordAccess()!="NONCONSUMPTIVE"&&corpus.getNoPasswordAccess()!="NONE";return false}});Ext.define("Voyant.panel.VoyantTabPanel",{extend:"Ext.tab.Panel",alias:"widget.voyanttabpanel",mixins:["Voyant.panel.Panel"],statics:{i18n:{}},constructor:function(config){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},initComponent:function(){this.callParent(arguments)},listeners:{tabchange:function(panel,newTab){this.tools=[];this.getHeader().tools=[];this.query("toolmenu").forEach(function(toolMenu){toolMenu.destroy()});this.addTool(newTab.tools);
this.getApplication().dispatchEvent("panelChange",this)},afterrender:function(panel){this.fireEvent("tabchange",this,this.getActiveTab())}},showOptionsClick:function(panel){var tab=panel.getActiveTab();if(tab.showOptionsClick)tab.showOptionsClick.apply(tab,arguments)}});Ext.define("Voyant.widget.Facet",{extend:"Ext.grid.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.facet",statics:{i18n:{},api:{stopList:"auto",query:undefined}},constructor:function(config){this.callParent(arguments);Ext.applyIf(config||{},{includeTools:[],rowLines:false,columnLines:false,subtitle:undefined});this.mixins["Voyant.panel.Panel"].constructor.apply(this,[config])},rowLines:false,initComponent:function(){var me=this;if(!this.store){this.store=new Ext.create("Voyant.data.store.CorpusFacets",
{proxy:{extraParams:{facet:this.facet}},parentPanel:this});this.store.getProxy().on("exception",function(proxy,request,operation,eOpts){me.showResponseError("Unable to fetch facet: "+me.facet,response)})}Ext.applyIf(this,{emptyText:this.localize("emptyText"),hideHeaders:true,selType:"checkboxmodel",columns:[{renderer:function(value,metaData,record){return"("+record.getInDocumentsCount()+") "+record.getLabel()},flex:1}]});this.callParent();if(this.corpus)this.setStoreCorpus(this.corpus);this.on("loadedCorpus",
function(src,corpus){this.setStoreCorpus(corpus)},this);this.on("query",function(src,query){this.setApiParam("query",query);this.store.load({params:this.getApiParams()})})},setStoreCorpus:function(corpus){if(this.getStore()){this.getStore().setCorpus(corpus);this.getStore().load()}}});Ext.define("Voyant.panel.Bubbles",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.bubbles",statics:{i18n:{},api:{stopList:"auto",docIndex:0,limit:100,audio:false,speed:30},glyph:"xf06e@FontAwesome"},config:{options:{xtype:"stoplistoption"},audio:false},constructor:function(){this.mixins["Voyant.util.Localization"].constructor.apply(this,arguments);Ext.apply(this,{title:this.localize("title"),html:'\x3ccanvas style\x3d"width: 100%; height: 100%"\x3e\x3c/canvas\x3e',dockedItems:[{dock:"bottom",
xtype:"toolbar",overflowHandler:"scroller",items:[{xtype:"documentselectorbutton",singleSelect:true},{xtype:"slider",fieldLabel:this.localize("speed"),labelAlign:"right",labelWidth:40,width:100,increment:1,minValue:1,maxValue:60,value:30,listeners:{render:function(cmp){cmp.setValue(parseInt(this.getApiParam("speed")));if(this.bubbles)this.bubbles.frameRate(cmp.getValue());this.setAudio(cmp.getValue());Ext.tip.QuickTipManager.register({target:cmp.getEl(),text:this.localize("speedTip")})},beforedestroy:function(cmp){Ext.tip.QuickTipManager.unregister(cmp.getEl())},
changecomplete:function(cmp,val){this.setApiParam("speed",val);if(this.bubbles)this.bubbles.frameRate(val)},scope:this}},{xtype:"checkbox",boxLabel:this.localize("sound"),listeners:{render:function(cmp){cmp.setValue(this.getApiParam("audio")===true||this.getApiParam("audio")=="true");this.setAudio(cmp.getValue());Ext.tip.QuickTipManager.register({target:cmp.getEl(),text:this.localize("soundTip")})},beforedestroy:function(cmp){Ext.tip.QuickTipManager.unregister(cmp.getEl())},change:function(cmp,val){this.setApiParam("audio",
val);this.setAudio(val)},scope:this}},{xtype:"tbfill"},{xtype:"tbtext",html:this.localize("adaptation")}]}]});this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("loadedCorpus",function(src,corpus){var canvas=this.getTargetEl().dom.querySelector("canvas");var me=this;Ext.Ajax.request({url:this.getBaseUrl()+"resources/voyant/current/bubbles/bubbles.pjs"}).then(function(data){var canvas=me.getTargetEl().dom.querySelector("canvas");me.bubbles=new Processing(canvas,
data.responseText);me.bubbles.size(me.getTargetEl().getWidth(),me.getTargetEl().getHeight());me.bubbles.frameRate(me.getApiParam("speed"));me.bubbles.bindJavascript(me);me.bubbles.noLoop();me.loadDocument()})},this);this.on("resize",function(){if(this.bubbles)this.bubbles.size(this.body.getWidth(),this.body.getHeight())});this.on("documentselected",function(src,doc){this.setApiParam("docIndex",this.getCorpus().getDocument(doc).getIndex());this.loadDocument()})},setAudio:function(val){if(this.gainNode)this.gainNode.gain.value=
val?1:0;this.callParent(arguments)},handleCurrentTerm:function(term){if(this.oscillator)this.oscillator.frequency.value=this.terms[term]?parseInt((this.terms[term]-this.minFreq)*2E3/(this.maxFreq-this.minFreq)):0},handleDocFinished:function(){if(this.gainNode)this.gainNode.gain.value=0;var index=parseInt(this.getApiParam("docIndex"));if(index+1<this.getCorpus().getDocumentsCount()){this.setApiParam("docIndex",index+1);this.loadDocument()}},loadDocument:function(){var me=this,doc=this.getCorpus().getDocument(parseInt(this.getApiParam("docIndex")));
if(!this.up("tabpanel"))this.setTitle(this.localize("title")+" \x3cspan class\x3d'subtitle'\x3e"+doc.getFullLabel()+"\x3c/span\x3e");doc.loadDocumentTerms(Ext.apply(this.getApiParams(["stopList"]),{limit:100})).then(function(documentTerms){me.terms={};documentTerms.each(function(documentTerm){me.terms[documentTerm.getTerm()]=documentTerm.getRawFreq()});var values=Object.keys(me.terms).map(function(k){return me.terms[k]});me.minFreq=Ext.Array.min(values);me.maxFreq=Ext.Array.max(values);me.getCorpus().loadTokens({whitelist:Object.keys(me.terms),
noOthers:true,limit:0,docIndex:me.getApiParam("docIndex")}).then(function(tokens){var words=[];tokens.each(function(token){words.push(token.getTerm().toLowerCase())});me.bubbles.setLines([doc.getTitle(),words.join(" ")]);me.bubbles.loop();me.oscillator.frequency.value=150;me.gainNode.gain.value=me.getAudio()?1:0})})},initComponent:function(){Ext.Loader.loadScript(this.getBaseUrl()+"resources/processingjs/processing.min.js");var audioCtx=new (window.AudioContext||window.webkitAudioContext);this.oscillator=
audioCtx.createOscillator();this.gainNode=audioCtx.createGain();this.oscillator.connect(this.gainNode);this.gainNode.connect(audioCtx.destination);this.oscillator.frequency.value=0;this.oscillator.start();this.gainNode.gain.value=0;this.callParent(arguments)}});Ext.define("Voyant.panel.Bubblelines",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.bubblelines",statics:{i18n:{},api:{bins:50,query:null,stopList:"auto",docId:undefined,docIndex:undefined,maxDocs:50},glyph:"xf06e@FontAwesome"},config:{bubblelines:undefined,termStore:undefined,docTermStore:undefined,selectedDocs:undefined,options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"},{xtype:"colorpaletteoption"}]},termTpl:new Ext.XTemplate('\x3ctpl for\x3d"."\x3e','\x3cdiv class\x3d"term" style\x3d"color: rgb({color});float: left;padding: 3px;margin: 2px;"\x3e{term}\x3c/div\x3e',
"\x3c/tpl\x3e"),constructor:function(){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("loadedCorpus",function(src,corpus){this.setDocTermStore(corpus.getDocumentTerms({proxy:{extraParams:{withDistributions:"raw",withPositions:true}},listeners:{load:function(store,records,successful,options){records.forEach(function(record){var termData=this.processTerms(record);var docId=record.get("docId");var term=record.get("term");var termObj={};termObj[term]=
termData;this.getBubblelines().addTermsToDoc(termObj,docId)},this);this.getBubblelines().doBubblelinesLayout()},scope:this}}));if(this.isVisible()&&this.getBubblelines())this.initLoad()},this);this.on("activate",function(){if(this.getCorpus())Ext.Function.defer(this.initLoad,100,this)},this);this.on("query",function(src,query){if(query!==undefined&&query!="")this.getDocTermsFromQuery(query)},this);this.on("documentsSelected",function(src,docIds){this.setApiParam("docId",docIds);this.getBubblelines().cache.each(function(d){d.hidden=
docIds.indexOf(d.id)===-1});this.getBubblelines().drawGraph()},this);this.on("termsClicked",function(src,terms){if(src!==this){var queryTerms=[];terms.forEach(function(term){if(Ext.isString(term))queryTerms.push(term);else if(term.term)queryTerms.push(term.term);else if(term.getTerm)queryTerms.push(term.getTerm())});this.getDocTermsFromQuery(queryTerms)}},this);this.on("documentTermsClicked",function(src,terms){var queryTerms=[];terms.forEach(function(term){if(term.getTerm())queryTerms.push(term.getTerm())});
this.getDocTermsFromQuery(queryTerms)},this);this.down("#granularity").setValue(parseInt(this.getApiParam("bins")))},initComponent:function(){this.setTermStore(Ext.create("Ext.data.ArrayStore",{fields:["term","color"],listeners:{load:function(store,records,successful,options){var termsView=this.down("#termsView");for(var i=0;i<records.length;i++){var r=records[i];termsView.select(r,true)}},scope:this}}));Ext.apply(this,{title:this.localize("title"),dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",
items:[{xtype:"querysearchfield"},{text:this.localize("clearTerms"),glyph:"xf014@FontAwesome",handler:function(){this.down("#termsView").getSelectionModel().deselectAll(true);this.getTermStore().removeAll();this.setApiParams({query:null});this.getBubblelines().removeAllTerms();this.getBubblelines().drawGraph()},scope:this},{xtype:"documentselectorbutton"},{xtype:"slider",itemId:"granularity",fieldLabel:this.localize("granularity"),labelAlign:"right",labelWidth:70,width:150,increment:10,minValue:10,
maxValue:300,listeners:{changecomplete:function(slider,newvalue){this.setApiParams({bins:newvalue});this.getBubblelines().bubbleSpacing=newvalue;this.reloadTermsData()},scope:this}},{xtype:"checkbox",boxLabel:this.localize("separateLines"),boxLabelAlign:"before",checked:false,handler:function(checkbox,checked){this.getBubblelines().SEPARATE_LINES_FOR_TERMS=checked;this.getBubblelines().lastClickedBubbles={};this.getBubblelines().setCanvasHeight();this.getBubblelines().drawGraph()},scope:this}]}],
border:false,layout:"fit",items:{layout:{type:"vbox",align:"stretch"},defaults:{border:false},items:[{height:30,itemId:"termsView",xtype:"dataview",store:this.getTermStore(),tpl:this.termTpl,itemSelector:"div.term",overItemCls:"over",selectedItemCls:"selected",selectionModel:{mode:"SIMPLE"},focusCls:"",listeners:{beforeitemclick:function(dv,record,item,index,event,opts){event.preventDefault();event.stopPropagation();dv.fireEvent("itemcontextmenu",dv,record,item,index,event,opts);return false},beforecontainerclick:function(){event.preventDefault();
event.stopPropagation();return false},selectionchange:function(selModel,selections){var dv=this.down("#termsView");var terms=[];dv.getStore().each(function(r){if(selections.indexOf(r)!==-1){terms.push(r.get("term"));Ext.fly(dv.getNodeByRecord(r)).removeCls("unselected").addCls("selected")}else Ext.fly(dv.getNodeByRecord(r)).removeCls("selected").addCls("unselected")});for(var index in this.getBubblelines().lastClickedBubbles){var lcTerms=this.getBubblelines().lastClickedBubbles[index];for(var term in lcTerms)if(terms.indexOf(term)==
-1)delete this.getBubblelines().lastClickedBubbles[index][term]}this.getBubblelines().termsFilter=terms;this.getBubblelines().setCanvasHeight();this.getBubblelines().drawGraph()},itemcontextmenu:function(dv,record,el,index,event){event.preventDefault();event.stopPropagation();var isSelected=dv.isSelected(el);var menu=new Ext.menu.Menu({floating:true,items:[{text:isSelected?this.localize("hideTerm"):this.localize("showTerm"),handler:function(){if(isSelected)dv.deselect(index);else dv.select(index,
true)},scope:this},{text:this.localize("removeTerm"),handler:function(){dv.deselect(index);var term=this.getTermStore().getAt(index).get("term");this.getTermStore().removeAt(index);dv.refresh();this.getBubblelines().removeTerm(term);this.getBubblelines().setCanvasHeight();this.getBubblelines().drawGraph()},scope:this}]});menu.showAt(event.getXY())},scope:this}},{flex:1,xtype:"container",autoEl:"div",itemId:"canvasParent",layout:"fit",overflowY:"auto",overflowX:"hidden"}],listeners:{render:function(component){var canvasParent=
this.down("#canvasParent");this.setBubblelines(new Bubblelines({container:canvasParent,clickHandler:this.bubbleClickHandler.bind(this)}));this.getBubblelines().bubbleSpacing=parseInt(this.getApiParam("bins"))},afterlayout:function(container){if(this.getBubblelines().initialized===false)this.getBubblelines().initializeCanvas()},resize:function(cnt,width,height){this.getBubblelines().doBubblelinesLayout()},scope:this}}});this.callParent(arguments)},initLoad:function(){var docIds=[];this.getCorpus().getDocuments().each(function(doc,
index,total){var inLimit=index<this.getApiParam("maxDocs");this.getBubblelines().addDocToCache({id:doc.getId(),index:doc.getIndex(),title:doc.getShortTitle(),totalTokens:doc.get("tokensCount-lexical"),terms:{},hidden:!inLimit});if(inLimit)docIds.push(doc.getId())},this);this.setApiParam("docId",docIds);this.getCorpus().getCorpusTerms({autoload:false}).load({callback:function(records,operation,success){var query=[];records.forEach(function(record,index){query.push(record.get("term"))},this);this.getDocTermsFromQuery(query)},
scope:this,params:{limit:this.getApiParam("query")?undefined:5,stopList:this.getApiParams("stopList"),query:this.getApiParam("query")}})},getDocTermsFromQuery:function(query){if(query)this.setApiParam("query",query);if(this.getCorpus()&&this.isVisible())this.getDocTermStore().load({params:this.getApiParams()})},reloadTermsData:function(){var terms=[];for(var term in this.getBubblelines().currentTerms)terms.push(term);this.getDocTermsFromQuery(terms)},filterDocuments:function(){var docIds=this.getApiParam("docId");
if(docIds==""){docIds=[];this.getCorpus().getDocuments().each(function(item,index){docIds.push(item.getId())});this.setApiParams({docId:docIds})}if(typeof docIds=="string")docIds=[docIds];if(docIds==null){this.setSelectedDocs(this.getCorpus().getDocuments().clone());var count=this.getSelectedDocs().getCount();if(count>10)for(var i=10;i<count;i++)this.getSelectedDocs().removeAt(10);docIds=[];this.getSelectedDocs().eachKey(function(docId,doc){docIds.push(docId)},this);this.setApiParams({docId:docIds})}else this.setSelectedDocs(this.getCorpus().getDocuments().filterBy(function(doc,
docId){return docIds.indexOf(docId)!=-1},this))},processTerms:function(termRecord){var termObj;var term=termRecord.get("term");var rawFreq=termRecord.get("rawFreq");var positions=termRecord.get("positions");if(rawFreq>0){var color=this.getApplication().getColorForTerm(term);if(this.getTermStore().find("term",term)===-1){this.getTermStore().loadData([[term,color]],true);var index=this.getTermStore().find("term",term);this.down("#termsView").select(index,true)}var distributions=termRecord.get("distributions");
termObj={positions:positions,distributions:distributions,rawFreq:rawFreq,color:color}}else termObj=false;return termObj},bubbleClickHandler:function(data){this.getApplication().dispatchEvent("termsClicked",this,data)}});Ext.define("Voyant.panel.Catalogue",{extend:"Ext.panel.Panel",requires:["Voyant.widget.Facet"],mixins:["Voyant.panel.Panel","Voyant.util.Downloadable"],alias:"widget.catalogue",statics:{i18n:{},api:{config:undefined,stopList:"auto",facet:["facet.title","facet.author","facet.language"],title:undefined,splash:undefined,reader:"reader"},glyph:"xf1ea@FontAwesome"},config:{facets:{},matchingDocIds:[],customResultsHtml:undefined},constructor:function(config){config=config||{};this.mixins["Voyant.util.Api"].constructor.apply(this,
arguments);Ext.apply(this,{title:this.localize("title"),layout:"hbox",items:[{layout:"vbox",height:"100%",align:"stretch",itemId:"facets",defaults:{width:250,flex:1,xtype:"facet",margin:5,border:true,frame:true,includeTools:{close:{type:"close",tooltip:this.localize("closeFacetTip"),callback:function(facetCmp){delete this.facets[facetCmp.facet];facetCmp.destroy();this.updateResults()},scope:this},add:{type:"plus",tooltip:this.localize("plusFacetTip"),callback:function(){this.addFacet()},scope:this}}},
items:[]},{xtype:"panel",html:config.customResultsHtml||"",flex:1,itemId:"results",height:"100%",align:"stretch",scrollable:true,margin:5,getCorpus:function(){return this.findParentByType("panel").getCorpus()},listeners:{query:function(src,query){this.findParentByType("panel").updateResults(Ext.isString(query)?[query]:query)}},dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{itemId:"sendToVoyant",text:this.localize("sendToVoyantButton"),disabled:true,handler:function(){this.mask(this.localize("exportInProgress"));
var catalogue=this;Ext.Ajax.request({url:this.getApplication().getTromboneUrl(),params:{corpus:this.getCorpus().getId(),tool:"corpus.CorpusManager",keepDocuments:true,docId:this.getMatchingDocIds()},success:function(response,opts){catalogue.unmask();var json=Ext.JSON.decode(response.responseText);var url=catalogue.getBaseUrl()+"?corpus\x3d"+json.corpus.id;catalogue.openUrl(url)},failure:function(response,opts){catalogue.unmask();me.showResponseError("Unable to export corpus: "+catalogue.getCorpus().getId(),
response)}})},scope:this},{itemId:"export",text:this.localize("downloadButton"),disabled:true,handler:function(){this.mask(this.localize("exportInProgress"));var catalogue=this;Ext.Ajax.request({url:this.getApplication().getTromboneUrl(),params:{corpus:this.getCorpus().getId(),tool:"corpus.CorpusManager",keepDocuments:true,docId:this.getMatchingDocIds()},success:function(response,opts){catalogue.unmask();var json=Ext.JSON.decode(response.responseText);catalogue.downloadFromCorpusId(json.corpus.id)},
failure:function(response,opts){catalogue.unmask();me.showResponseError("Unable to export corpus: "+catalogue.getCorpus().getId(),response)}})},scope:this},{xtype:"querysearchfield",width:200,flex:1},{itemId:"status",xtype:"tbtext"}]}]},{xtype:this.getApiParam("reader"),flex:1,height:"100%",align:"stretch",header:false}]});this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("loadedCorpus",function(src,corpus){this.queryById("status").update((new Ext.XTemplate(this.localize("noMatches"))).apply([corpus.getDocumentsCount()]));
if(!this.getCustomResultsHtml()){if(this.getApiParam("splash")){this.setCustomResultsHtml(this.getApiParam("splash"));this.updateResults();return}this.setCustomResultsHtml((new Ext.XTemplate(this.localize("noMatches"))).apply([corpus.getDocumentsCount()]));this.updateResults();Ext.Ajax.request({url:this.getTromboneUrl(),params:{tool:"resource.StoredResource",verifyResourceId:"customhtml-"+corpus.getAliasOrId()},success:function(response,req){var json=Ext.util.JSON.decode(response.responseText);if(json&&
json.storedResource&&json.storedResource.id)Ext.Ajax.request({url:this.getTromboneUrl(),params:{tool:"resource.StoredResource",retrieveResourceId:"customhtml-"+corpus.getAliasOrId()},success:function(response,req){var json=Ext.util.JSON.decode(response.responseText);if(json&&json.storedResource&&json.storedResource.resource){this.setCustomResultsHtml(json.storedResource.resource);this.updateResults()}},scope:this})},scope:this})}});this.on("afterrender",function(panel){var facetsCmp=this.queryById("facets");
this.addFacet({facet:"lexical",includeTools:{add:{type:"plus",tooltip:this.localize("plusFacetTip"),callback:function(){this.addFacet()},scope:this}},store:new Voyant.data.store.CorpusTerms({parentPanel:this,proxy:{extraParams:{stopList:this.getApiParam("stopList")}}})},facetsCmp);var facets=this.getApiParam("facet");if(Ext.isString(facets))facets=facets.split(",");facets.forEach(function(facet){this.addFacet({facet:facet},facetsCmp)},this);var title=this.getApiParam("title");if(title)this.setTitle(title)})},
addFacet:function(config,facetsCmp){if(!config)return this.selectFacet(function(facet){this.addFacet({facet:facet})});facetsCmp=facetsCmp||this.queryById("facets");var facet=config.facet,itemTpl='\x3cspan style\x3d"font-size: smaller;"\x3e(\x3cspan class\x3d"info-tip" data-qtip\x3d"'+this.localize("matchingDocuments")+'"\x3e{inDocumentsCount}\x3c/span\x3e)\x3c/span\x3e {term}'+'\x3cspan style\x3d"font-size: smaller;"\x3e (\x3cspan class\x3d"info-tip" data-qtip\x3d"'+this.localize("rawFreqs")+'"\x3e{rawFreq}\x3c/span\x3e)\x3c/span\x3e';
var title=this.localize(facet+"Title");if(title=="["+facet+"Title]")title=facet.replace(/^facet\./,"").replace(/^extra./,"");var matchingDocumentsLabel=this.localize("matchingDocuments");Ext.applyIf(config,{title:title,collapsible:true,facet:facet,columns:[{renderer:function(value,metaData,record){return'\x3cspan style\x3d"font-size: smaller;"\x3e(\x3cspan class\x3d"info-tip" data-qtip\x3d"'+this.localize("matchingDocuments")+'"\x3e'+record.getInDocumentsCount()+"\x3c/span\x3e) \x3c/span\x3e"+(record.getLabel?
record.getLabel():record.getTerm()+'\x3cspan style\x3d"font-size: smaller;"\x3e (\x3cspan class\x3d"info-tip" data-qtip\x3d"'+this.localize("rawFreqs")+'"\x3e'+record.getRawFreq()+"\x3c/span\x3e)\x3c/span\x3e")},flex:1}],bbar:[{xtype:"querysearchfield",width:"100%",tokenType:facet.replace("facet.",""),itemTpl:itemTpl}],corpus:this.getCorpus()});var facetCmp=facetsCmp.add(config);facetCmp.getSelectionModel().on("selectionchange",function(model,selected){var labels=[];selected.forEach(function(model){labels.push({facet:facetCmp.facet,
label:model.getLabel?model.getLabel():model.getTerm()})});this.getFacets()[facet]=labels;this.updateResults()},this);facetCmp.on("query",function(model,selected){this.getFacets()[facetCmp.facet]=[];this.updateResults()},this);return facetCmp},updateResults:function(queries){var facets=this.getFacets();if(!queries){var queries=[];for(facet in facets)facets[facet].forEach(function(label){queries.push(label.facet+":"+label.label)});if(queries)return this.updateResults(queries)}var results=this.queryById("results").getTargetEl();
var catalogue=this;results.update(this.getCustomResultsHtml()?this.getCustomResultsHtml():(new Ext.XTemplate(this.localize("noMatches"))).apply([this.getCorpus().getDocumentsCount()]));this.queryById("status").update((new Ext.XTemplate(this.localize("noMatches"))).apply([this.getCorpus().getDocumentsCount()]));this.queryById("sendToVoyant").setDisabled(true);this.queryById("export").setDisabled(true);if(queries&&queries.length>0){this.mask(this.localize("loading"));var documentQueryMatches=this.getCorpus().getDocumentQueryMatches();
documentQueryMatches.load({params:{query:queries,includeDocIds:true},callback:function(records,operation,success){this.unmask();if(records&&records.length>0){this.queryById("status").setHtml(records.length);var list="\x3cul\x3e";var matchingDocIds=[];records.forEach(function(record){record.getDocIds().forEach(function(docId){matchingDocIds.push(docId);var doc=documentQueryMatches.getCorpus().getDocument(docId);var item="\x3cli id\x3d'"+results.getId()+"_"+docId+"' class\x3d'cataloguedoc'\x3e";item+=
"\x3ca href\x3d'#' class\x3d'cataloguedoctitle' data\x3d'"+docId+"'\x3e"+doc.getTitle()+"\x3c/a\x3e";for(facet in facets){if(facets[facet].length==0)continue;var labelItems="";if(facet!="facet.title"){var suffix=facet.replace(/^.+?\./,"");var label=doc.get(suffix);if(label){var isArray=Ext.isArray(label);if(isArray)labelItems+="\x3cli\x3e"+suffix+"\x3cul\x3e";else label=[label];label.forEach(function(l){var isMatch=false;facets[facet].forEach(function(f){if(f.label==l)isMatch=true;else if(f.facet.indexOf("facet")==
-1)f.label.split(/\W+/).forEach(function(part){if(part.trim().length>0&&l.toLowerCase().indexOf(part.toLowerCase())>-1)isMatch=true})});labelItems+="\x3cli\x3e"+(isArray?"":suffix.replace("extra.","")+": ")+(isMatch?'\x3cspan class\x3d"keyword"\x3e'+l+"\x3c/span\x3e":l)+"\x3c/li\x3e"});if(isArray)labelItems+="\x3c/ul\x3e\x3c/li\x3e"}}if(labelItems)item+="\x3cul\x3e"+labelItems+"\x3c/ul\x3e"}item+="\x3c/li\x3e";list+=item})});list+="\x3c/ul\x3e";results.update(list);var me=this;var lnks=results.query(".cataloguedoctitle");
lnks.forEach(function(lnk){Ext.get(lnk).on("click",function(e,el){this.dispatchEvent("documentSelected",me,el.getAttribute("data"))},me)});if(lnks.length==1)this.dispatchEvent("documentSelected",me,lnks[0].getAttribute("data"));this.queryById("status").update((new Ext.XTemplate(this.localize("queryMatches"))).apply([matchingDocIds.length,this.getCorpus().getDocumentsCount()]));this.setMatchingDocIds(Ext.Array.clone(matchingDocIds));if(matchingDocIds.length>0){this.queryById("export").setDisabled(false);
this.queryById("sendToVoyant").setDisabled(false)}if(facets["lexical"]){var firstDocIds=matchingDocIds.splice(0,5);this.loadSnippets(firstDocIds,results.first().first());if(matchingDocIds&&matchingDocIds.length>0)this.loadSnippets(matchingDocIds)}}},scope:this})}},loadSnippets:function(docIds,elToMask){var results=this.queryById("results").getTargetEl();var facets=this.getFacets();if(facets["lexical"]){var queries=facets["lexical"].map(function(label){return label.facet+":"+label.label});var contexts=
this.getCorpus().getContexts({buffered:false});if(elToMask)elToMask.mask(this.localize("loadingSnippets"));contexts.load({method:"POST",params:{stripTags:"all",query:queries,docId:docIds,perDocLimit:3,limit:100,accurateTotalNotNeeded:true},scope:this,callback:function(records,operation,success){if(elToMask)elToMask.unmask();if(success&&Ext.isArray(records)&&records.length>0){var snippets={};records.forEach(function(record){if(!snippets[record.getDocIndex()])snippets[record.getDocIndex()]=[];snippets[record.getDocIndex()].push(record)});
for(docIndex in snippets){var id=this.getCorpus().getDocument(docIndex).getId();var html='\x3cli style\x3d"list-style-type: none; font-size: smaller;"\x3e'+snippets[docIndex].map(function(snippet){return snippet.getHighlightedContext()}).join(" \u2026 ")+"\x3c/li\x3e";var docItem=results.down("#"+results.getId()+"_"+id);if(docItem.query("ul"))html="\x3cul\x3e"+html+"\x3c/ul\x3e";docItem.insertHtml("beforeEnd",html)}}}})}},selectFacet:function(callback){if(!this.facetsSelectionStore){var keys={};this.getCorpus().getDocuments().each(function(doc){for(var key in doc.getData())if(key!=
"corpus"&&key.indexOf("parent")!==0&&key.indexOf("-lexical")=="-1")keys[key]=true});keys=Object.keys(keys);keys.sort();this.facetsSelectionStore=Ext.create("Ext.data.ArrayStore",{fields:["text"],data:keys.map(function(key){return[key]})})}var existingFacets={};this.queryById("facets").items.each(function(cmp){existingFacets[cmp.facet]=true});this.facetsSelectionStore.filterBy(function(record){return!("facet."+record.get("text")in existingFacets)});var win=Ext.create("Ext.window.Window",{title:this.localize("selectFacet"),
modal:true,items:{xtype:"form",width:300,items:{xtype:"combo",store:this.facetsSelectionStore,forceSelection:true,width:300},buttons:[{text:this.localize("cancel"),ui:"default-toolbar",glyph:"xf00d@FontAwesome",flex:1,handler:function(btn){btn.up("window").close()}},{text:this.localize("select"),glyph:"xf00c@FontAwesome",flex:1,handler:function(btn){var facet=btn.up("window").down("combo").getValue();if(!facet)return this.showError(this.localize("selectValidFacet"));else{callback.call(this,"facet."+
facet);btn.up("window").close()}},scope:this}]},bodyPadding:5}).show()}});Ext.define("Voyant.panel.Cirrus",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.cirrus",statics:{i18n:{},api:{stopList:"auto",categories:undefined,whiteList:undefined,limit:500,visible:50,terms:undefined,docId:undefined,docIndex:undefined,inlineData:undefined,fontFamily:'"Palatino Linotype", "Book Antiqua", Palatino, serif',cirrusForceFlash:false,background:"0xffffff",fade:true,smoothness:2,diagonals:"none"},glyph:"xf06e@FontAwesome"},config:{mode:undefined,options:[{xtype:"stoplistoption"},
{xtype:"listeditor",name:"whiteList"},{xtype:"categoriesoption"},{xtype:"fontfamilyoption"},{xtype:"colorpaletteoption"}],records:undefined,terms:undefined,cirrusId:undefined,visLayout:undefined,vis:undefined,tip:undefined,sizeAdjustment:100,minFontSize:12,largestWordSize:0,smallestWordSize:1E6},MODE_CORPUS:"corpus",MODE_DOCUMENT:"mode_document",layout:"fit",constructor:function(config){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.getApplication().getCategoriesManager().addFeature("orientation",
function(){return~~(Math.random()*2)*90});this.setCirrusId(Ext.id(null,"cirrus_"))},initComponent:function(config){Ext.apply(this,{title:this.localize("title"),dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{xtype:"corpusdocumentselector",singleSelect:true},{fieldLabel:this.localize("visibleTerms"),labelWidth:40,width:120,xtype:"slider",increment:25,minValue:25,maxValue:500,listeners:{afterrender:function(slider){slider.maxValue=this.getApiParam("limit");slider.increment=
parseInt(slider.maxValue/50);slider.setValue(this.getApiParam("visible"))},changecomplete:function(slider,newvalue){this.setApiParams({visible:newvalue});this.loadFromTermsRecords()},scope:this}}]}]});this.callParent(arguments)},listeners:{boxready:function(){this.initVisLayout();var dataString=this.getApiParam("inlineData");if(dataString!==undefined){if(dataString.charAt(0)=="[")var jsonData=Ext.decode(dataString,true);else if(dataString.indexOf(":")>-1){jsonData=[];dataString.split(",").forEach(function(term){parts=
term.split(":");jsonData.push({text:parts[0],rawFreq:parseInt(parts[1])})})}else{var terms={};jsonData=[];dataString.split(",").forEach(function(term){if(term in terms)terms[term]++;else terms[term]=1});for(term in terms)jsonData.push({text:term,rawFreq:terms[term]})}if(jsonData!==null&&jsonData.length>0){this.setApiParam("inlineData",jsonData);this.setTerms(jsonData);this.buildFromTerms()}}},resize:function(panel,width,height){if(this.getVisLayout()&&this.getCorpus()){this.setAdjustedSizes();var el=
this.getLayout().getRenderTarget();width=el.getWidth();height=el.getHeight();el.down("svg").set({width:width,height:height});if(this.getTerms())this.getVisLayout().size([width,height]).stop().words(this.getTerms()).start()}},loadedCorpus:function(src,corpus){this.getApplication().getCategoriesManager().addFeature("font",this.getApiParam("fontFamily"));this.initVisLayout();if(this.getApiParam("docIndex"))this.fireEvent("documentSelected",this,corpus.getDocument(this.getApiParam("docIndex")));else if(this.getApiParam("docId"))this.fireEvent("documentSelected",
this,corpus.getDocument(this.getApiParam("docId")));else this.loadFromCorpus(corpus)},corpusSelected:function(src,corpus){this.loadFromCorpus(corpus)},documentSelected:function(src,document){if(document){var corpus=this.getCorpus();var document=corpus.getDocument(document);this.setApiParam("docId",document.getId());var documentTerms=document.getDocumentTerms({autoload:false,corpus:corpus,pageSize:this.getApiParam("maxVisible"),parentPanel:this});this.loadFromDocumentTerms(documentTerms)}},ensureCorpusView:function(src,
corpus){if(this.getMode()!=this.MODE_CORPUS)this.loadFromCorpus(corpus)}},loadFromCorpus:function(corpus){var jsonData=this.getApiParam("inlineData");if(jsonData===undefined){this.setApiParams({docId:undefined,docIndex:undefined});this.loadFromCorpusTerms(corpus.getCorpusTerms({autoload:false,pageSize:this.getApiParam("maxVisible"),parentPanel:this}))}else;},loadFromDocumentTerms:function(documentTerms){documentTerms.load({callback:function(records,operation,success){this.setMode(this.MODE_DOCUMENT);
this.setRecords(operation.getRecords());this.loadFromTermsRecords()},scope:this,params:this.getApiParams()})},loadFromCorpusTerms:function(corpusTerms){corpusTerms.load({callback:function(records,operation,success){this.setMode(this.MODE_CORPUS);this.setRecords(operation.getRecords());this.loadFromTermsRecords()},scope:this,params:this.getApiParams()})},loadFromTermsRecords:function(){var records=this.getRecords();var visible=this.getApiParam("visible");if(visible>records.length)visible=records.length;
var terms=[];for(var i=0;i<visible;i++)if(records[i].get("rawFreq")>0)terms.push({text:records[i].get("term").replace(/"/g,""),rawFreq:records[i].get("rawFreq")});this.setTerms(terms);this.buildFromTerms()},initVisLayout:function(forceLayout){if(forceLayout||this.getVisLayout()==undefined){var cirrusForceFlash=this.getApiParam("cirrusForceFlash");if(cirrusForceFlash=="true"||cirrusForceFlash===true){this.setApiParam("cirrusForceFlash",true);var id=this.getCirrusId();var appVars={id:id};var keys=["background",
"fade","smoothness","diagonals"];for(var i=0;i<keys.length;i++)appVars[keys[i]]=this.getApiParam(keys[i]);var swfscript='\x3cscript type\x3d"text/javascript" src\x3d"'+this.getApplication().getBaseUrl()+"resources/swfobject/swfobject.js"+'"\x3e\x3c/script\x3e';var cirrusLinks='\x3cscript type\x3d"text/javascript"\x3e'+"cirrusClickHandler"+id+" \x3d function(word, value) {\n"+"\tif (window.console \x26\x26 console.info) console.info(word, value);\n"+'\tvar cirrusTool \x3d Ext.getCmp("'+this.id+'");\n'+
'\tcirrusTool.dispatchEvent("termsClicked", cirrusTool, [word]);\n'+"}\n"+"cirrusLoaded"+id+" \x3d function() {\n"+'\tif (window.console \x26\x26 console.info) console.info("cirrus flash loaded");\n'+"}\n"+"cirrusPNGHandler"+id+" \x3d function(base64String) {\n"+'\tvar cirrusTool \x3d Ext.getCmp("'+this.id+'");\n'+"\tcirrusTool.cirrusPNGHandler(base64String);\n"+"}"+"\x3c/script\x3e";this.update(swfscript+cirrusLinks,true,function(){function loadFlash(component){if(typeof swfobject!=="undefined"){var el=
component.getLayout().getRenderTarget();var width=el.getWidth();var height=el.getHeight();var cirrusFlash=component.getApplication().getBaseUrl()+"resources/cirrus/flash/Cirrus.swf";component.add({xtype:"flash",id:appVars.id,url:cirrusFlash,width:width,height:height,flashVars:appVars,flashParams:{menu:"false",scale:"showall",allowScriptAccess:"always",bgcolor:"#222222",wmode:"opaque"}});component.cirrusFlashApp=Ext.get(appVars.id).first().dom}else setTimeout(loadFlash,50,component)}loadFlash(this)},
this)}else{var el=this.getLayout().getRenderTarget();el.update("");var width=el.getWidth();var height=el.getHeight();this.setVisLayout(d3.layoutCloud().size([width,height]).overflow(true).padding(1).rotate(function(d){return this.getApplication().getCategoriesManager().getFeatureForTerm("orientation",d.text)}.bind(this)).spiral("archimedean").font(function(d){return this.getApplication().getCategoriesManager().getFeatureForTerm("font",d.text)}.bind(this)).fontSize(function(d){return d.fontSize}.bind(this)).text(function(d){return d.text}).on("end",
this.draw.bind(this)));var svg=d3.select(el.dom).append("svg").attr("id",this.getCirrusId()).attr("class","cirrusGraph").attr("width",width).attr("height",height);this.setVis(svg.append("g").attr("transform","translate("+width/2+","+height/2+")"));if(this.getTip()===undefined)this.setTip(Ext.create("Ext.tip.Tip",{}))}}},buildFromTerms:function(){var terms=this.getTerms();if(this.rendered&&terms)if(this.getApiParam("cirrusForceFlash")===true)if(this.cirrusFlashApp!==undefined&&this.cirrusFlashApp.clearAll!==
undefined){var words=[];for(var i=0;i<terms.length;i++){var t=terms[i];if(!t.text&&t.term)t.text=t.term;words.push({word:t.text,size:t.rawFreq,label:t.rawFreq})}this.cirrusFlashApp.clearAll();this.cirrusFlashApp.addWords(words);this.cirrusFlashApp.arrangeWords()}else Ext.defer(this.buildFromTerms,50,this);else{var minSize=1E3;var maxSize=-1;for(var i=0;i<terms.length;i++){var size=terms[i].rawFreq;if(size<minSize)minSize=size;if(size>maxSize)maxSize=size}this.setSmallestWordSize(minSize);this.setLargestWordSize(maxSize);
this.setRelativeSizes();this.setAdjustedSizes();this.getVisLayout().words(terms).start()}else Ext.defer(this.buildFromTerms,50,this)},draw:function(words,bounds){var panel=this;var el=this.getLayout().getRenderTarget();var width=this.getVisLayout().size()[0];var height=this.getVisLayout().size()[1];var scale=bounds?Math.min(width/Math.abs(bounds[1].x-width/2),width/Math.abs(bounds[0].x-width/2),height/Math.abs(bounds[1].y-height/2),height/Math.abs(bounds[0].y-height/2))/2:1;var t=d3.transition().duration(1E3);
var nodes=this.getVis().selectAll("text").data(words,function(d){return d.text});nodes.exit().transition(t).style("font-size","1px").remove();var nodesEnter=nodes.enter().append("text").text(function(d){return d.text}).attr("text-anchor","middle").attr("data-freq",function(d){return d.rawFreq}).attr("transform",function(d){return"translate("+[d.x,d.y]+")rotate("+d.rotate+")"}).style("font-family",function(d){return panel.getApplication().getCategoriesManager().getFeatureForTerm("font",d.text)}).style("fill",
function(d){return panel.getApplication().getColorForTerm(d.text,true)}).style("font-size","1px").on("click",function(obj){panel.dispatchEvent("termsClicked",panel,[obj.text])}).on("mouseover",function(obj){this.getTip().show()}.bind(this)).on("mousemove",function(obj){var tip=this.getTip();tip.update(obj.text+": "+obj.rawFreq);var container=Ext.get(this.getCirrusId()).dom;var coords=d3.mouse(container);coords[1]+=30;tip.setPosition(coords)}.bind(this)).on("mouseout",function(obj){this.getTip().hide()}.bind(this));
var nodesUpdate=nodes.merge(nodesEnter);nodesUpdate.transition(t).style("font-family",function(d){return panel.getApplication().getCategoriesManager().getFeatureForTerm("font",d.text)}).style("fill",function(d){return panel.getApplication().getColorForTerm(d.text,true)}).attr("transform",function(d){return"translate("+[d.x,d.y]+")rotate("+d.rotate+")"}).style("font-size",function(d){return d.fontSize+"px"});this.getVis().transition(t).attr("transform","translate("+width/2+","+height/2+")scale("+scale+
")")},map:function(value,istart,istop,ostart,ostop){return ostart+(ostop-ostart)*((value-istart)/(istop-istart))},calculateSizeAdjustment:function(){var terms=this.getTerms();if(terms!==undefined){var el=this.getLayout().getRenderTarget();var stageArea=el.getWidth()*el.getHeight();if(stageArea<1E5)this.setMinFontSize(8);else this.setMinFontSize(12);var pixelsPerWord=stageArea/terms.length;var totalWordsSize=0;for(var i=0;i<terms.length;i++){var word=terms[i];var wordArea=this.calculateWordArea(word);
totalWordsSize+=wordArea}this.setSizeAdjustment(stageArea/totalWordsSize)}},calculateWordArea:function(word){var baseSize=Math.log(word.relativeSize*10)*Math.LOG10E;var height=(baseSize+word.relativeSize)/2;var width=0;for(var i=0;i<word.text.length;i++){var letter=word.text.charAt(i);if(letter=="f"||letter=="i"||letter=="j"||letter=="l"||letter=="r"||letter=="t")width+=baseSize/3;else if(letter=="m"||letter=="w")width+=baseSize/(4/3);else width+=baseSize/1.9}var wordArea=height*width;return wordArea},
setAdjustedSizes:function(){this.calculateSizeAdjustment();var terms=this.getTerms();if(terms!==undefined)for(var i=0;i<terms.length;i++){var term=terms[i];var adjustedSize=this.findNewRelativeSize(term);term.fontSize=adjustedSize>this.getMinFontSize()?adjustedSize:this.getMinFontSize()}},setRelativeSizes:function(){var terms=this.getTerms();if(terms!==undefined)for(var i=0;i<terms.length;i++){var word=terms[i];word.relativeSize=this.map(word.rawFreq,this.getSmallestWordSize(),this.getLargestWordSize(),
.1,1)}},findNewRelativeSize:function(word){var areaMultiplier=this.getSizeAdjustment();var area=this.calculateWordArea(word)*areaMultiplier;var newRelativeSize=(Math.sqrt(6)*Math.sqrt(6*Math.pow(word.text.length,2)+area*word.text.length)-6*word.text.length)/(2*word.text.length);return newRelativeSize}});Ext.define("Voyant.panel.CollocatesGraph",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.collocatesgraph",statics:{i18n:{},api:{query:undefined,mode:undefined,limit:5,stopList:"auto",terms:undefined,context:5,centralize:undefined},glyph:"xf1e0@FontAwesome"},config:{options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"}],nodeData:undefined,linkData:undefined,visId:undefined,vis:undefined,visLayout:undefined,nodes:undefined,links:undefined,zoom:undefined,dragging:false,
contextMenu:undefined,currentNode:undefined,networkMode:undefined,graphStyle:{keywordNode:{normal:{fill:"#c6dbef",stroke:"#6baed6"},highlight:{fill:"#9ecae1",stroke:"#3182bd"}},contextNode:{normal:{fill:"#fdd0a2",stroke:"#fdae6b"},highlight:{fill:"#fd9a53",stroke:"#e6550d"}},link:{normal:{stroke:"#000000",strokeOpacity:.1},highlight:{stroke:"#000000",strokeOpacity:.5}}},graphPhysics:{defaultMode:{damping:.4,centralGravity:.1,nodeGravity:-50,springLength:100,springStrength:.25,collisionScale:1.25},
centralizedMode:{damping:.4,centralGravity:.1,nodeGravity:-1,springLength:200,springStrength:1,collisionScale:1}}},DEFAULT_MODE:0,CENTRALIZED_MODE:1,constructor:function(config){this.setNodeData([]);this.setLinkData([]);this.setVisId(Ext.id(null,"links_"));this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},initComponent:function(){var me=this;Ext.apply(me,{title:this.localize("title"),dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",
items:[{xtype:"querysearchfield"},{text:me.localize("clearTerms"),glyph:"xf014@FontAwesome",handler:this.resetGraph,scope:me},this.localize("context"),{xtype:"slider",itemId:"contextSlider",minValue:3,value:5,maxValue:30,increment:2,width:50,listeners:{render:function(slider){slider.setValue(this.getApiParam("context"))},changecomplete:function(slider,newValue){this.setApiParam("context",slider.getValue());if(this.getNetworkMode()===this.DEFAULT_MODE){var terms=this.getNodeData().map(function(node){return node.term});
if(terms.length>0){this.setNodeData([]);this.setLinkData([]);this.refresh();this.loadFromQuery(terms)}}},scope:me}}]}]});this.setContextMenu(Ext.create("Ext.menu.Menu",{renderTo:Ext.getBody(),items:[{xtype:"box",itemId:"label",margin:"5px 0px 5px 5px",html:""},{xtype:"menuseparator"},{xtype:"menucheckitem",text:"Fixed",itemId:"fixed",listeners:{checkchange:function(c,checked,e){var node=this.getCurrentNode();if(node!==undefined){var data={fixed:checked};if(checked){data.fx=node.x;data.fy=node.y}else{data.fx=
null;data.fy=null}this.updateDataForNode(node.id,data)}},scope:this}},{xtype:"button",text:"Fetch Collocates",style:"margin: 5px;",handler:function(b,e){var node=this.getCurrentNode();if(node!==undefined){if(this.getNetworkMode()===this.CENTRALIZED_MODE){this.resetGraph();this.setNetworkMode(this.DEFAULT_MODE);this.setApiParam("centralize",undefined);node.start=0;node.limit=this.getApiParam("limit")}this.fetchCollocatesForNode(node)}},scope:this},{xtype:"button",text:"Centralize",style:"margin: 5px;",
handler:function(b,e){var node=this.getCurrentNode();if(node!==undefined)this.doCentralize(node.term);this.getContextMenu().hide()},scope:this},{xtype:"button",text:"Remove",style:"margin: 5px;",handler:function(b,e){var node=this.getCurrentNode();if(node!==undefined)this.removeNode(node.id);b.up("menu").hide()},scope:this}]}));this.on("loadedCorpus",function(src,corpus){if(this.isVisible())this.initLoad()},this);this.on("activate",function(){if(this.getCorpus())if(this.getNodeData().length===0)Ext.Function.defer(this.initLoad,
100,this)},this);this.on("query",function(src,query){this.loadFromQuery(query)},this);this.on("resize",function(panel,width,height){var vis=Ext.get(this.getVisId());if(vis){var el=this.body;var elHeight=el.getHeight();var elWidth=el.getWidth();vis.el.dom.setAttribute("width",elWidth);vis.el.dom.setAttribute("height",elHeight);this.getVisLayout().force("x",d3.forceX(elWidth/2)).force("y",d3.forceY(elHeight/2));Ext.Function.defer(this.zoomToFit,100,this)}},this);me.callParent(arguments)},initLoad:function(){this.initGraph();
this.setNetworkMode(this.DEFAULT_MODE);if(this.getApiParam("centralize")){this.setNetworkMode(this.CENTRALIZED_MODE);var term=this.getApiParam("centralize");this.doCentralize(term)}else{var limit=3;var query=this.getApiParam("query");if(query!==undefined)limit=Ext.isArray(query)?query.length:query.split(",").length;this.getCorpus().getCorpusTerms({autoLoad:false}).load({params:{limit:limit,query:query,stopList:this.getApiParam("stopList"),categories:this.getApiParam("categories")},callback:function(records,
operation,success){if(success)this.loadFromCorpusTermRecords(records)},scope:this})}},loadFromQuery:function(query){if(Ext.isArray(query)&&query.length==0){this.setApiParam("query",undefined);this.resetGraph();return}this.setApiParams({mode:"corpus",query:query});var params=this.getApiParams();params.noCache=true;(Ext.isString(query)?[query]:query).forEach(function(q){this.getCorpus().getCorpusCollocates({autoLoad:false}).load({params:Ext.apply(Ext.clone(params),{query:q}),callback:function(records,
operations,success){if(success)this.loadFromCorpusCollocateRecords(records)},scope:this})},this)},loadFromCorpusTermRecords:function(corpusTerms){if(Ext.isArray(corpusTerms)&&corpusTerms.length>0){var terms=[];corpusTerms.forEach(function(corpusTerm){terms.push(corpusTerm.getTerm())});this.loadFromQuery(terms)}},loadFromCorpusCollocateRecords:function(records,keywordId){if(Ext.isArray(records)){var start=this.getApiParam("limit");var el=this.getLayout().getRenderTarget();var cX=el.getWidth()/2;var cY=
el.getHeight()/2;var existingKeys={};this.getNodeData().forEach(function(item){existingKeys[item.id]=true},this);var newNodes=[];var newLinks=[];records.forEach(function(corpusCollocate,index){var term=corpusCollocate.getTerm();var contextTerm=corpusCollocate.getContextTerm();var termFreq=corpusCollocate.getKeywordRawFreq();var contextFreq=corpusCollocate.getContextTermRawFreq();var termValue=termFreq;var contextValue=contextFreq;if(this.getNetworkMode()===this.CENTRALIZED_MODE){termValue=0;contextValue=
Math.log(contextFreq)}var termEntry=undefined;var contextTermEntry=undefined;if(index==0){if(keywordId===undefined)keywordId=this.idGet(term);if(existingKeys[keywordId]!==undefined)this.updateDataForNode(keywordId,{title:term+" ("+termFreq+")",type:"keyword",value:termValue});else{existingKeys[keywordId]=true;termEntry={id:keywordId,term:term,title:term+" ("+termFreq+")",type:"keyword",value:termValue,start:start,fixed:false,x:cX,y:cY};newNodes.push(termEntry)}}if(term!=contextTerm){var contextId=
this.idGet(contextTerm);if(existingKeys[contextId]!==undefined);else{existingKeys[contextId]=true;contextTermEntry={id:contextId,term:contextTerm,title:contextTerm+" ("+contextFreq+")",type:"context",value:contextValue,start:0,fixed:false,x:cX,y:cY};newNodes.push(contextTermEntry)}var existingLink=null;var linkData=this.getLinkData();for(var i=0;i<linkData.length;i++){var link=linkData[i];if(link.source.id==keywordId&&link.target.id==contextId||link.source.id==contextId&&link.target.id==keywordId){existingLink=
link;break}}var linkValue=corpusCollocate.getContextTermRawFreq();if(existingLink===null)newLinks.push({source:keywordId,target:contextId,value:linkValue,id:keywordId+"-"+contextId});else if(existingLink.value<linkValue);}},this);this.setNodeData(this.getNodeData().concat(newNodes));this.setLinkData(this.getLinkData().concat(newLinks));this.refresh()}},idGet:function(term){return term.replace(/\W/g,"_")},updateDataForNode:function(nodeId,dataObj){var data=this.getNodeData();for(var i=0;i<data.length;i++)if(data[i].id===
nodeId){Ext.apply(data[i],dataObj);break}},removeNode:function(nodeId,removeOrphans){var data=this.getNodeData();for(var i=0;i<data.length;i++)if(data[i].id===nodeId){data.splice(i,1);break}data=this.getLinkData();for(var i=data.length-1;i>=0;i--)if(data[i].source.id===nodeId||data[i].target.id===nodeId)data.splice(i,1);this.setApiParam("query",Ext.Array.remove(Ext.Array.from(this.getApiParam("query")),nodeId));if(removeOrphans);this.refresh()},doCentralize:function(term){this.setApiParam("centralize",
term);this.resetGraph();this.setNetworkMode(this.CENTRALIZED_MODE);var data={id:this.idGet(term),term:term,title:term+" ("+1+")",type:"keyword",value:1E3,start:0};this.setNodeData([data]);this.refresh();var centralizeLimit=150;var limit=this.getApiParam("limit");this.setApiParam("limit",centralizeLimit);this.fetchCollocatesForNode(data);this.setApiParam("limit",limit)},applyNetworkMode:function(mode){if(this.getVisLayout())if(mode===this.DEFAULT_MODE){var physics=this.getGraphPhysics().defaultMode;
this.getVisLayout().velocityDecay(physics.damping).force("link",d3.forceLink().id(function(d){return d.id}).distance(physics.springLength).strength(physics.springStrength)).force("charge",d3.forceManyBody().strength(physics.nodeGravity)).force("collide",d3.forceCollide(function(d){return Math.sqrt(d.bbox.width*d.bbox.height)*physics.collisionScale}));this.getVisLayout().force("x").strength(physics.centralGravity);this.getVisLayout().force("y").strength(physics.centralGravity)}else{var physics=this.getGraphPhysics().centralizedMode;
this.getVisLayout().velocityDecay(physics.damping).force("link",d3.forceLink().id(function(d){return d.id}).distance(physics.springLength).strength(physics.springStrength)).force("charge",d3.forceManyBody().strength(function(d){if(d.type==="keyword")return-1E4;else return 0})).force("collide",d3.forceCollide(function(d){if(d.type==="keyword")return d.value;else return Math.sqrt(d.bbox.width*d.bbox.height)*physics.collisionScale}));this.getVisLayout().force("x").strength(physics.centralGravity);this.getVisLayout().force("y").strength(physics.centralGravity)}return mode},
initGraph:function(){var el=this.getLayout().getRenderTarget();el.update("");var width=el.getWidth();var height=el.getHeight();this.setVisLayout(d3.forceSimulation().force("x",d3.forceX(width/2)).force("y",d3.forceY(height/2)).on("tick",function(){this.getLinks().attr("x1",function(d){return d.source.x}).attr("y1",function(d){return d.source.y}).attr("x2",function(d){return d.target.x}).attr("y2",function(d){return d.target.y});this.getNodes().attr("transform",function(d){var x=d.x;var y=d.y;if(this.getNetworkMode()===
this.DEFAULT_MODE||d.type!=="keyword"){x-=d.bbox.width*.5;y-=d.bbox.height*.5}else;return"translate("+x+","+y+")"}.bind(this));if(!this.getDragging()&&this.getVisLayout().alpha()<.075)this.getVisLayout().alpha(-1)}.bind(this)).on("end",function(){Ext.Function.defer(this.zoomToFit,100,this)}.bind(this)));var svg=d3.select(el.dom).append("svg").attr("id",this.getVisId()).attr("class","linksGraph").attr("width",width).attr("height",height);var g=svg.append("g");var zoom=d3.zoom().scaleExtent([1/4,4]).on("zoom",
function(){g.attr("transform",d3.event.transform)});this.setZoom(zoom);svg.call(zoom);svg.on("click",function(){this.getContextMenu().hide()}.bind(this));this.setLinks(g.append("g").attr("class","links").selectAll(".link"));this.setNodes(g.append("g").attr("class","nodes").selectAll(".node"));this.setVis(g)},resetGraph:function(){this.setNodeData([]);this.setLinkData([]);this.setNetworkMode(this.DEFAULT_MODE);this.refresh()},refresh:function(){var me=this;var nodeData=this.getNodeData();var linkData=
this.getLinkData();var link=this.getLinks().data(linkData,function(d){return d.id});link.exit().remove();var linkEnter=link.enter().append("line").attr("class","link").attr("id",function(d){return d.id}).on("mouseover",me.linkMouseOver.bind(me)).on("mouseout",me.linkMouseOut.bind(me)).on("click",function(data){d3.event.stopImmediatePropagation();d3.event.preventDefault();this.dispatchEvent("termsClicked",this,['"'+data.source.term+" "+data.target.term+'"~'+this.getApiParam("context")])}.bind(me)).style("cursor",
"pointer").style("stroke-width",function(d){if(me.getNetworkMode()===me.DEFAULT_MODE)return Math.max(1,Math.min(15,Math.sqrt(d.value)));else return 1});this.setLinks(linkEnter.merge(link));var node=this.getNodes().data(nodeData,function(d){return d.id});node.exit().remove();var nodeEnter=node.enter().append("g").attr("class",function(d){return"node "+d.type}).attr("id",function(d){return d.id}).on("mouseover",me.nodeMouseOver.bind(me)).on("mouseout",me.nodeMouseOut.bind(me)).on("click",function(data){d3.event.stopImmediatePropagation();
d3.event.preventDefault();this.dispatchEvent("termsClicked",this,[data.term])}.bind(me)).on("dblclick",function(data){d3.event.stopImmediatePropagation();d3.event.preventDefault();this.fetchCollocatesForNode(data)}.bind(me)).on("contextmenu",function(d,i){d3.event.preventDefault();var menu=me.getContextMenu();menu.queryById("label").setHtml(d.term);menu.queryById("fixed").setChecked(d.fixed);menu.showAt(d3.event.pageX+10,d3.event.pageY-50)}).call(d3.drag().on("start",function(d){me.setDragging(true);
if(!d3.event.active)me.getVisLayout().alpha(.3).restart();d.fx=d.x;d.fy=d.y;d.fixed=true}).on("drag",function(d){me.getVisLayout().alpha(.3);d.fx=d3.event.x;d.fy=d3.event.y;if(me.isMasked()){if(!me.isOffCanvas(d3.event.x,d3.event.y))me.unmask()}else if(me.isOffCanvas(d3.event.x,d3.event.y))me.mask(me.localize("releaseToRemove"))}).on("end",function(d){me.setDragging(false);if(d.fixed!=true){d.fx=null;d.fy=null}if(me.isOffCanvas(d3.event.x,d3.event.y)){me.unmask();me.mask(me.localize("cleaning"));
me.removeNode(d.id);me.unmask()}}));nodeEnter.append("title").text(function(d){return d.title});if(this.getNetworkMode()===this.DEFAULT_MODE)nodeEnter.append("rect").style("stroke-width",1).style("stroke-opacity",1);else nodeEnter.filter(function(d){return d.type==="keyword"}).append("circle").style("stroke-width",1).style("stroke-opacity",1);nodeEnter.append("text").attr("font-family",function(d){return me.getApplication().getCategoriesManager().getFeatureForTerm("font",d.term)}).attr("font-size",
function(d){return Math.max(10,Math.sqrt(d.value))}).text(function(d){return d.term}).each(function(d){d.bbox=this.getBBox()}).style("cursor","pointer").style("user-select","none").attr("dominant-baseline","middle");this.setNodes(nodeEnter.merge(node));if(this.getNetworkMode()===this.DEFAULT_MODE){this.getVis().selectAll("rect").attr("width",function(d){return d.bbox.width+16}).attr("height",function(d){return d.bbox.height+8}).attr("rx",function(d){return Math.max(2,d.bbox.height*.2)}).attr("ry",
function(d){return Math.max(2,d.bbox.height*.2)}).call(this.applyNodeStyle.bind(this));this.getVis().selectAll("text").attr("dx",8).attr("dy",function(d){return d.bbox.height*.5+4})}else{this.getVis().selectAll("circle").attr("r",function(d){return Math.min(150,d.bbox.width)}).call(this.applyNodeStyle.bind(this));this.getVis().selectAll("text").attr("dx",function(d){if(d.type==="keyword")return-d.bbox.width*.5;else return 8}).attr("dy",function(d){if(d.type==="keyword")return 0;else return d.bbox.height*
.5+4})}this.getVis().selectAll("line").call(this.applyLinkStyle.bind(this));this.getVisLayout().nodes(nodeData);this.getVisLayout().force("link").links(linkData);this.getVisLayout().alpha(1).restart()},isOffCanvas:function(x,y){var vis=Ext.get(this.getVisId());return x<0||y<0||x>vis.getWidth()||y>vis.getHeight()},zoomToFit:function(paddingPercent,transitionDuration){var bounds=this.getVis().node().getBBox();var width=bounds.width;var height=bounds.height;var midX=bounds.x+width/2;var midY=bounds.y+
height/2;var svg=this.getVis().node().parentElement;var svgRect=svg.getBoundingClientRect();var fullWidth=svgRect.width;var fullHeight=svgRect.height;var scale=(paddingPercent||.8)/Math.max(width/fullWidth,height/fullHeight);var translate=[fullWidth/2-scale*midX,fullHeight/2-scale*midY];if(width<1)return;d3.select(svg).transition().duration(transitionDuration||500).call(this.getZoom().transform,d3.zoomIdentity.translate(translate[0],translate[1]).scale(scale))},applyNodeStyle:function(sel,nodeState){var state=
nodeState===undefined?"normal":nodeState;sel.style("fill",function(d){var type=d.type+"Node";return this.getGraphStyle()[type][state].fill}.bind(this));sel.style("stroke",function(d){var type=d.type+"Node";return this.getGraphStyle()[type][state].stroke}.bind(this))},applyLinkStyle:function(sel,linkState){var state=linkState===undefined?"normal":linkState;sel.style("stroke",function(d){return this.getGraphStyle().link[state].stroke}.bind(this));sel.style("stroke-opacity",function(d){return this.getGraphStyle().link[state].strokeOpacity}.bind(this))},
linkMouseOver:function(d){this.getVis().selectAll("line").call(this.applyLinkStyle.bind(this));this.getVis().select("#"+d.id).call(this.applyLinkStyle.bind(this),"highlight")},linkMouseOut:function(d){this.getVis().selectAll("line").call(this.applyLinkStyle.bind(this))},nodeMouseOver:function(d){this.setCurrentNode(d);this.getVis().selectAll("rect").call(this.applyNodeStyle.bind(this));this.getLinks().each(function(link){var id;if(link.source.id==d.id)id=link.target.id;else if(link.target.id==d.id)id=
link.source.id;if(id!==undefined){this.getVis().select("#"+id+" rect").call(this.applyNodeStyle.bind(this),"highlight");this.getVis().select("#"+link.id).call(this.applyLinkStyle.bind(this),"highlight")}}.bind(this));this.getVis().select("#"+d.id+" rect").style("stroke-width",3).call(this.applyNodeStyle.bind(this),"highlight")},nodeMouseOut:function(d){if(!this.getContextMenu().isVisible())this.setCurrentNode(undefined);this.getVis().selectAll("rect").style("stroke-width",1).call(this.applyNodeStyle.bind(this));
this.getVis().selectAll("line").call(this.applyLinkStyle.bind(this))},fetchCollocatesForNode:function(d){var limit=this.getApiParam("limit");var query=this.getApiParam("query");var query=Ext.Array.from(this.getApiParam("query"));Ext.Array.include(query,d.term);this.setApiParam("query",query);var corpusCollocates=this.getCorpus().getCorpusCollocates({autoLoad:false});corpusCollocates.load({params:Ext.apply(this.getApiParams(),{query:d.term,start:d.start,limit:limit}),callback:function(records,operation,
success){if(success){this.updateDataForNode(d.id,{start:d.start+limit});this.loadFromCorpusCollocateRecords(records,d.id)}},scope:this})}});Ext.define("Voyant.panel.Contexts",{extend:"Ext.grid.Panel",mixins:["Voyant.panel.Panel"],requires:["Voyant.data.store.Contexts"],alias:"widget.contexts",isConsumptive:true,statics:{i18n:{},api:{query:undefined,docId:undefined,docIndex:undefined,stopList:"auto",context:5,expand:50},glyph:"xf0ce@FontAwesome"},config:{options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"}]},constructor:function(){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},initComponent:function(){var me=
this;Ext.apply(me,{title:this.localize("title"),emptyText:this.localize("emptyText"),store:Ext.create("Voyant.data.store.ContextsBuffered",{parentPanel:this,proxy:{extraParams:{stripTags:"all"}}}),selModel:{type:"rowmodel",listeners:{selectionchange:{fn:function(sm,selections){this.getApplication().dispatchEvent("termLocationClicked",this,selections)},scope:this}}},plugins:[{ptype:"rowexpander",rowBodyTpl:new Ext.XTemplate("")}],dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",
items:[{xtype:"querysearchfield"},{xtype:"totalpropertystatus"},this.localize("context"),{xtype:"slider",minValue:5,value:5,maxValue:50,increment:5,width:50,listeners:{render:function(slider){slider.setValue(me.getApiParam("context"))},changecomplete:function(slider,newValue){me.setApiParam("context",slider.getValue());me.getStore().clearAndLoad({params:me.getApiParams()})}}},this.localize("expand"),{xtype:"slider",minValue:5,value:5,maxValue:500,increment:10,width:50,listeners:{render:function(slider){slider.setValue(me.getApiParam("expand"))},
changecomplete:function(slider,newValue){me.setApiParam("expand",newValue);var view=me.getView();var recordsExpanded=me.plugins[0].recordsExpanded;var store=view.getStore();for(var id in recordsExpanded){var record=store.getByInternalId(id);var row=view.getRow(record);var expandRow=row.parentNode.childNodes[1];if(recordsExpanded[id])view.fireEvent("expandbody",row,record,expandRow,{force:true});else Ext.fly(expandRow).down(".x-grid-rowbody").setHtml("")}}}},{xtype:"corpusdocumentselector"}]}],columns:[{text:this.localize("document"),
toolTip:this.localize("documentTip"),width:"autoSize",dataIndex:"docIndex",sortable:true,renderer:function(value,metaData,record,rowIndex,colIndex,store){return store.getCorpus().getDocument(value).getTinyLabel()}},{text:this.localize("left"),tooltip:this.localize("leftTip"),align:"right",dataIndex:"left",sortable:true,flex:1},{text:this.localize("term"),tooltip:this.localize("termTip"),dataIndex:"term",sortable:true,width:"autoSize"},{text:this.localize("right"),tooltip:this.localize("rightTip"),
dataIndex:"right",sortable:true,flex:1},{text:this.localize("position"),tooltip:this.localize("positionTip"),dataIndex:"position",sortable:true,hidden:true,flex:1}],listeners:{scope:this,corpusSelected:function(){if(this.getStore().getCorpus()){this.setApiParams({docId:undefined,docIndex:undefined});this.getStore().clearAndLoad()}},documentsSelected:function(src,docs){var docIds=[];var corpus=this.getStore().getCorpus();docs.forEach(function(doc){docIds.push(corpus.getDocument(doc).getId())},this);
this.setApiParams({docId:docIds,docIndex:undefined});this.getStore().clearAndLoad()},documentSegmentTermClicked:{fn:function(src,documentSegmentTerm){if(!documentSegmentTerm.term)return;params={query:documentSegmentTerm.term};if(documentSegmentTerm.docId)params.docId=documentSegmentTerm.docId;else params.docIndex=documentSegmentTerm.docIndex?documentSegmentTerm.docIndex:0;this.setApiParams(params);if(this.isVisible())this.getStore().clearAndLoad()},scope:this},documentIndexTermsClicked:{fn:function(src,
documentIndexTerms){var queriesHash={};var queries=[];var docIndexHash={};var docIndex=[];documentIndexTerms.forEach(function(item){if(!queriesHash[item.term]){queries.push(item.term);queriesHash[item.term]=true}if(!docIndexHash[item.docIndex]){docIndex.push(item.docIndex);docIndexHash[item.docIndex]=true}});this.setApiParams({docId:undefined,docIndex:docIndex,query:queries});if(this.isVisible())this.getStore().clearAndLoad({params:this.getApiParams()})},scope:this},afterrender:function(me){me.getView().on("expandbody",
function(rowNode,record,expandRow,eOpts){if(expandRow.textContent===""||eOpts&&eOpts.force){var store=Ext.create("Voyant.data.store.Contexts",{stripTags:"all",corpus:me.getStore().getCorpus()});var data=record.getData();store.load({params:{query:data.query,docIndex:data.docIndex,position:data.position,limit:1,context:me.getApiParam("expand")},callback:function(records,operation,success){if(success&&records.length==1){data=records[0].getData();Ext.fly(operation.expandRow).down(".x-grid-rowbody").setHtml(data.left+
" \x3cspan class\x3d'word keyword'\x3e"+data.middle+"\x3c/span\x3e "+data.right)}},expandRow:expandRow})}})}}});me.on("loadedCorpus",function(src,corpus){if(this.hasCorpusAccess(corpus)==false)this.mask(this.localize("limitedAccess"),"mask-no-spinner");else{var corpusTerms=corpus.getCorpusTerms({autoLoad:false});corpusTerms.load({callback:function(records,operation,success){if(success&&records.length>0){this.setApiParam("query",[records[0].getTerm()]);this.getStore().clearAndLoad({params:this.getApiParams()})}},
scope:me,params:{limit:1,query:this.getApiParam("query"),stopList:this.getApiParam("stopList"),forTool:"contexts"}})}});me.on("query",function(src,query){this.setApiParam("query",query);this.getStore().clearAndLoad({params:this.getApiParams()})},me);me.on("documentTermsClicked",function(src,documentTerms){var documentIndexTerms=[];documentTerms.forEach(function(documentTerm){documentIndexTerms.push({term:documentTerm.getTerm(),docIndex:documentTerm.getDocIndex()})});this.fireEvent("documentIndexTermsClicked",
this,documentIndexTerms)});me.on("termsClicked",function(src,terms){var documentIndexTerms=[];if(Ext.isString(terms))terms=[terms];terms.forEach(function(term){if(term.docIndex!==undefined)documentIndexTerms.push({term:term.term,docIndex:term.docIndex})});if(documentIndexTerms.length>0)this.fireEvent("documentIndexTermsClicked",this,documentIndexTerms)});me.callParent(arguments)}});Ext.define("Voyant.panel.CorpusCollocates",{extend:"Ext.grid.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.corpuscollocates",statics:{i18n:{},api:{stopList:"auto",context:5,query:undefined,docId:undefined,docIndex:undefined,sort:"contextTermRawFreq"},glyph:"xf0ce@FontAwesome"},config:{options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"}]},constructor:function(config){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("loadedCorpus",
function(src,corpus){if(this.isVisible())this.loadFromApis()});if(config.embedded);else if(config.corpus)this.fireEvent("loadedCorpus",this,config.corpus);this.on("corpusTermsClicked",function(src,terms){if(this.getStore().getCorpus()){var query=[];terms.forEach(function(term){query.push(term.get("term"))});this.setApiParams({query:query,docId:undefined,docIndex:undefined});if(this.isVisible())this.loadFromApis()}});this.on("documentsClicked",function(src,documents){var docIds=[];documents.forEach(function(doc){docIds.push(doc.get("id"))});
this.setApiParams({docId:docIds,docid:undefined,query:undefined});if(this.isVisible())this.loadFromApis()});this.on("activate",function(){if(this.getStore().getCorpus())this.loadFromApis()},this);this.on("query",function(src,query){this.setApiParam("query",query);this.getStore().getProxy().setExtraParam("query",query);this.loadFromApis()},this)},loadFromApis:function(){if(this.getStore().getCorpus())if(this.getApiParam("query"))this.getStore().clearAndLoad({params:this.getApiParams()});else{var corpusTerms=
this.getStore().getCorpus().getCorpusTerms({leadingBufferZone:0,autoLoad:false});corpusTerms.load({callback:function(records,operation,success){if(success){var terms=[];records.forEach(function(term){terms.push(term.getTerm())});this.getStore().getProxy().setExtraParam("query",terms);this.setApiParam("query",terms);this.loadFromApis()}},scope:this,params:{limit:10,stopList:this.getApiParam("stopList")}})}},initComponent:function(){var me=this;var store=Ext.create("Voyant.data.store.CorpusCollocatesBuffered",
{parentPanel:this});Ext.apply(me,{title:this.localize("title"),emptyText:this.localize("emptyText"),store:store,selModel:Ext.create("Ext.selection.CheckboxModel",{listeners:{selectionchange:{fn:function(sm,selections){var terms=[];var context=this.getApiParam("context");selections.forEach(function(selection){terms.push('"'+selection.getKeyword()+" "+selection.getContextTerm()+'"~'+context)});this.getApplication().dispatchEvent("termsClicked",this,terms)},scope:this}}}),dockedItems:[{dock:"bottom",
xtype:"toolbar",overflowHandler:"scroller",items:[{xtype:"querysearchfield"},{xtype:"totalpropertystatus"},this.localize("context"),{xtype:"slider",minValue:1,value:5,maxValue:30,increment:2,width:50,listeners:{render:function(slider){slider.setValue(me.getApiParam("context"))},changecomplete:function(slider,newValue){me.setApiParam("context",slider.getValue());me.loadFromApis()}}},{xtype:"corpusdocumentselector"}]}],columns:[{text:this.localize("term"),dataIndex:"term",tooltip:this.localize("termTip"),
sortable:true,flex:1},{text:this.localize("rawFreq"),dataIndex:"rawFreq",tooltip:this.localize("termRawFreqTip"),sortable:true,width:"autoSize",hidden:true},{text:this.localize("contextTerm"),dataIndex:"contextTerm",tooltip:this.localize("contextTermTip"),flex:1,sortable:true},{text:this.localize("contextTermRawFreq"),tooltip:this.localize("contextTermRawFreqTip"),dataIndex:"contextTermRawFreq",width:"autoSize",sortable:true}],listeners:{scope:this,termsClicked:function(src,terms){if(this.getStore().getCorpus()){var queryTerms=
[];terms.forEach(function(term){if(Ext.isString(term))queryTerms.push(term);else if(term.term)queryTerms.push(term.term);else if(term.getTerm)queryTerms.push(term.getTerm())});if(queryTerms.length>0){this.setApiParams({docIndex:undefined,docId:undefined,query:queryTerms});if(this.isVisible())this.loadFromApis()}}},corpusSelected:function(){if(this.getStore().getCorpus()){this.setApiParams({docId:undefined,docIndex:undefined});this.loadFromApis()}},documentsSelected:function(src,docs){var docIds=[];
var corpus=this.getStore().getCorpus();docs.forEach(function(doc){docIds.push(corpus.getDocument(doc).getId())},this);this.setApiParams({docId:docIds,docIndex:undefined});this.loadFromApis()}}});me.callParent(arguments);me.getStore().getProxy().setExtraParam("withDistributions",true)}});Ext.define("Voyant.widget.CorpusTermSummary",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.corpustermsummary",statics:{i18n:{},api:{stopList:"auto",query:undefined,limit:5}},config:{corpus:undefined,record:undefined,collocatesStore:undefined,correlationsStore:undefined,phrasesStore:undefined,documentTermsStore:undefined},cls:"corpus-term-summary",constructor:function(config){if(config.record===undefined){console.warn("CorpusTermSummary: no config.record!");return false}Ext.apply(this,
{items:{itemId:"main",minHeight:200,scrollable:true,margin:5},dockedItems:{dock:"bottom",xtype:"toolbar",items:{fieldLabel:this.localize("items"),labelWidth:40,width:120,xtype:"slider",increment:5,minValue:5,maxValue:59,listeners:{boxready:function(slider){slider.setValue(this.getApiParam("limit"))},changecomplete:function(slider,newvalue){this.setApiParam("limit",newvalue);this.loadStuff()},scope:this}}},listeners:{boxready:function(){this.body.on("click",function(e){var target=e.getTarget(null,
null,true);if(target&&target.dom.tagName=="A")if(target.hasCls("corpus-type"))this.dispatchEvent("termsClicked",this,[target.getHtml()])},this,{stopPropagation:true});this.getDockedItems().forEach(function(i){i.getEl().on("click",null,this,{stopPropagation:true})});this.loadStuff()},scope:this}});Ext.applyIf(config,{title:this.localize("title")+config.record.getTerm()});this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);var corpus=this.getRecord().store.getCorpus();
this.setCorpus(corpus);this.setApiParam("query",this.getRecord().getTerm());this.setCollocatesStore(Ext.create("Voyant.data.store.CorpusCollocates",{corpus:corpus}));this.setCorrelationsStore(Ext.create("Voyant.data.store.TermCorrelations",{corpus:corpus}));this.setPhrasesStore(Ext.create("Voyant.data.store.CorpusNgrams",{corpus:corpus}));this.setDocumentTermsStore(Ext.create("Voyant.data.store.DocumentTerms",{corpus:corpus}))},loadStuff:function(){this.getComponent("main").removeAll();var docIndexes=
[];for(var i=0;i<this.getCorpus().getDocumentsCount();i++)docIndexes[i]=i;this.getComponent("main").add({xtype:"container",cls:"section",layout:"hbox",align:"bottom",items:[{xtype:"container",html:'\x3cdiv class\x3d"header"\x3e'+this.localize("distribution")+"\x3c/div\x3e"},{itemId:"distLine",xtype:"sparklineline",values:[],height:20,width:200}],listeners:{afterrender:function(container){container.mask(this.localize("loading"));this.getDocumentTermsStore().load({params:{query:this.getApiParam("query"),
docIndex:docIndexes,withDistributions:true,bins:parseInt(this.getApiParam("limit"))*2},callback:function(records,op,success){if(success&&records&&records.length>0){var arrays=records.map(function(r){return r.getDistributions()});var values=arrays.reduce(function(a,b){return a.concat(b)});this.down("#distLine").setValues(values);container.unmask()}},scope:this})},scope:this}});this.addSection(this.localize("collocates"),this.getCollocatesStore(),this.getApiParams(),'\x3ctpl for\x3d"." between\x3d"; "\x3e\x3ca href\x3d"#" onclick\x3d"return false" class\x3d"corpus-type keyword" voyant:recordId\x3d"{term}"\x3e{term}\x3c/a\x3e\x3cspan style\x3d"font-size: smaller"\x3e ({val})\x3c/span\x3e\x3c/tpl\x3e',
function(r){return{term:r.getContextTerm(),val:r.getContextTermRawFreq()}});this.addSection(this.localize("correlations"),this.getCorrelationsStore(),this.getApiParams(),'\x3ctpl for\x3d"." between\x3d"; "\x3e\x3ca href\x3d"#" onclick\x3d"return false" class\x3d"corpus-type keyword" voyant:recordId\x3d"{term}"\x3e{term}\x3c/a\x3e\x3cspan style\x3d"font-size: smaller"\x3e ({val})\x3c/span\x3e\x3c/tpl\x3e',function(r){return{term:r.get("source-term"),val:r.get("source").rawFreq}});this.addSection(this.localize("phrases"),
this.getPhrasesStore(),Ext.apply({minLength:3,sort:"length"},this.getApiParams()),'\x3ctpl for\x3d"."\x3e\x3cdiv\x3e\x26ldquo;{phrase}\x26rdquo;\x3c/div\x3e\x3c/tpl\x3e',function(r){return{phrase:r.getTerm()}})},addSection:function(title,store,params,template,mapping){return this.getComponent("main").add({xtype:"container",html:'\x3cdiv class\x3d"header"\x3e'+title+"\x3c/div\x3e",cls:"section",listeners:{afterrender:function(container){container.mask(this.localize("loading"));store.load({params:params,
callback:function(records,op,success){if(success&&records&&records.length>0){container.unmask();Ext.dom.Helper.append(container.getTargetEl().first().first(),(new Ext.XTemplate('\x3cdiv class\x3d"contents"\x3e'+template+"\x3c/div\x3e")).apply(records.map(mapping)))}}})},scope:this}})}});Ext.define("Voyant.panel.Correlations",{extend:"Ext.grid.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.correlations",statics:{i18n:{},api:{query:undefined,docId:undefined,docIndex:undefined,stopList:"auto",minInDocumentsCountRatio:100},glyph:"xf0ce@FontAwesome"},config:{options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"}]},constructor:function(){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},initComponent:function(){var me=this;Ext.apply(me,
{title:this.localize("title"),emptyText:this.localize("emptyText"),store:Ext.create("Voyant.data.store.TermCorrelationsBuffered",{parentPanel:this}),columns:[{text:this.localize("source"),tooltip:this.localize("sourceTip"),dataIndex:"source-term",sortable:false},{xtype:"widgetcolumn",tooltip:this.localize("trendTip"),width:100,dataIndex:"source-distributions",widget:{xtype:"sparklineline"},text:"\u2190"},{xtype:"widgetcolumn",tooltip:this.localize("trendTip"),width:100,dataIndex:"target-distributions",
widget:{xtype:"sparklineline"},text:"\u2192",align:"right"},{text:this.localize("target"),tooltip:this.localize("targetTip"),dataIndex:"target-term",sortable:false},{text:this.localize("correlation"),tooltip:this.localize("correlationTip"),dataIndex:"correlation"},{text:this.localize("significance"),tooltip:this.localize("significanceTip"),dataIndex:"significance"}],listeners:{scope:this,corpusSelected:function(){this.setApiParams({docIndex:undefined,docId:undefined});this.getStore().getProxy().setExtraParam("tool",
"corpus.CorpusTermCorrelations");this.getStore().load()},documentsSelected:function(src,docs){var docIds=[];var corpus=this.getStore().getCorpus();docs.forEach(function(doc){docIds.push(corpus.getDocument(doc).getId())},this);this.setApiParams({docId:docIds,docIndex:undefined});this.getStore().getProxy().setExtraParam("tool","corpus.DocumentTermCorrelations");this.getStore().load()}},dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{xtype:"querysearchfield"},{xtype:"totalpropertystatus"},
{xtype:"tbspacer"},{xtype:"tbtext",itemId:"minInDocumentsCountRatioLabel",text:me.localize("minInDocumentsCountRatioLabel")},{xtype:"slider",increment:5,minValue:0,maxValue:100,width:75,listeners:{afterrender:function(slider){slider.setValue(this.getApiParam("minInDocumentsCountRatio"));slider.up("toolbar").getComponent("minInDocumentsCountRatioLabel").setText((new Ext.XTemplate(me.localize("minInDocumentsCountRatioLabel"))).apply([this.getApiParam("minInDocumentsCountRatio")]))},changecomplete:function(slider,
newvalue){this.setApiParams({minInDocumentsCountRatio:newvalue});slider.up("toolbar").getComponent("minInDocumentsCountRatioLabel").setText((new Ext.XTemplate(me.localize("minInDocumentsCountRatioLabel"))).apply([newvalue]));this.getStore().load()},scope:this}},{xtype:"corpusdocumentselector"}]}]});me.on("loadedCorpus",function(src,corpus){if(corpus.getDocumentsCount()==1)this.getStore().getProxy().setExtraParam("tool","corpus.DocumentTermCorrelations");if(this.isVisible())this.getStore().load()});
me.on("activate",function(){if(this.getStore().getCorpus())this.getStore().load()},this);me.on("query",function(src,query){this.setApiParam("query",query);this.getStore().load()},me);me.callParent(arguments)}});Ext.define("Voyant.panel.CorpusCreator",{extend:"Ext.form.Panel",requires:["Ext.form.field.File"],mixins:["Voyant.panel.Panel"],alias:"widget.corpuscreator",isConsumptive:true,statics:{i18n:{},api:{inputFormat:undefined,language:undefined,xmlDocumentsXpath:undefined,xmlGroupByXpath:undefined,xmlContentXpath:undefined,xmlTitleXpath:undefined,xmlAuthorXpath:undefined,xmlPubDateXpath:undefined,xmlPublisherXpath:undefined,xmlPubPlaceXpath:undefined,xmlKeywordsXpath:undefined,xmlCollectionXpath:undefined,
xmlExtraMetadataXpath:undefined,htmlGroupByQuery:undefined,htmlDocumentsQuery:undefined,htmlContentQuery:undefined,htmlTitleQuery:undefined,htmlAuthorQuery:undefined,htmlPubDateQuery:undefined,htmlPublisherQuery:undefined,htmlPubPlaceQuery:undefined,htmlKeywordsQuery:undefined,htmlCollectionQuery:undefined,htmlExtraMetadataQuery:undefined,jsonDocumentsPointer:undefined,jsonContentPointer:undefined,jsonTitlePointer:undefined,jsonAuthorPointer:undefined,jsonPubDatePointer:undefined,jsonPublisherPointer:undefined,
jsonPubPlacePointer:undefined,jsonKeywordsPointer:undefined,jsonCollectionPointer:undefined,jsonExtraMetadataPointer:undefined,tokenization:undefined,adminPassword:undefined,accessPassword:undefined,noPasswordAccess:undefined,tableDocuments:undefined,tableContent:undefined,tableTitle:undefined,tableAuthor:undefined,title:undefined,subTitle:undefined,inputRemoveFrom:undefined,inputRemoveFromAfter:undefined,inputRemoveUntil:undefined,inputRemoveUntilAfter:undefined,sort:undefined}},constructor:function(config){this.callParent(arguments);
config=config||{};var me=this;this.mixins["Voyant.panel.Panel"].constructor.call(this,Ext.apply(config,{includeTools:{gear:true,help:true,language:this.getLanguageToolMenu()}}))},initComponent:function(){var me=this;Ext.apply(me,{title:this.localize("title"),width:800,frame:true,padding:10,style:{borderColor:"#aaa",borderStyle:"solid"},frameHeader:true,layout:{type:"vbox",align:"stretch"},dockedItems:[{xtype:"toolbar",overflowHandler:"scroller",dock:"bottom",buttonAlign:"right",items:[{text:me.localize("Open"),
glyph:"xf115@FontAwesome",tooltip:me.localize("SelectExisting"),hidden:this.getCorpus()!=undefined,handler:function(){Ext.create("Ext.window.Window",{title:me.localize("Open"),layout:"fit",modal:true,items:{xtype:"form",submitEmptyText:false,margin:"5,5,5,5",items:{xtype:"corpusselector"},buttons:[{text:me.localize("Open"),glyph:"xf00c@FontAwesome",handler:function(btn){var form=btn.up("form").getForm();var corpus=btn.up("form").getForm().getValues().corpus;if(corpus!=""){me.loadCorpus({corpus:corpus});
btn.up("window").close()}else Ext.Msg.show({title:me.localize("SelectExisting"),message:me.localize("PleaseSelectExisting"),buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR})},flex:1},{text:me.localize("cancel"),glyph:"xf00d@FontAwesome",flex:1,handler:function(btn){btn.up("window").close()}}]}}).show()}},{xtype:"fileuploadfield",glyph:"xf093@FontAwesome",name:"upload",buttonOnly:true,hideLabel:true,ui:"default-toolbar",buttonText:me.localize("Upload"),listeners:{render:function(filefield){filefield.fileInputEl.dom.setAttribute("multiple",
true);Ext.tip.QuickTipManager.register({target:filefield.getEl(),text:me.localize("UploadLocal")})},beforedestroy:function(cmp){Ext.tip.QuickTipManager.unregister(cmp.getEl())},change:function(filefield,value){if(value){var form=filefield.up("form").getForm();if(form.isValid()){var files=filefield.fileInputEl.dom.files;var badFilesRe=/\.(png|gif|jpe?g|xls|mp[234a]|mpeg|exe|wmv|avi|ppt|mpg|tif|wav|mov|psd|wma|ai|bmp|pps|aif|pub|dwg|indd|swf|asf|mbd|dmg|flv)$/i;var goodFilesRe=/\.(txt|pdf|html?|xml|docx?|rtf|pages|epub|odt|zip|jar|tar|gz|ar|cpio|bzip2|bz2|gzip|xlsx?)$/i;
var badFiles=[];var unknownFiles=[];for(var i=0,len=files.length;i<len;i++){var filename=files[i].name;if(badFilesRe.test(filename))badFiles.push(filename.split("/").pop());else if(!goodFilesRe.test(filename))unknownFiles.push(filename.split("/").pop())}if(badFiles.length>0||unknownFiles.length>0){var file=filefield;Ext.Msg.show({title:me.localize("fileTypesWarning"),icon:Ext.MessageBox.ERROR,message:me.localize("fileTypesMessage")+"\x3cul\x3e"+(badFiles.length>0?"\x3cli\x3e"+me.localize("badFiles")+
badFiles.slice(0,5).join(", ")+(badFiles.length>5?"\u2026":"")+"\x3c/li\x3e":"")+(unknownFiles.length>0?"\x3cli\x3e"+me.localize("unknownFiles")+unknownFiles.slice(0,5).join(", ")+(unknownFiles.length>5?"\u2026":"")+"\x3c/li\x3e":"")+"\x3c/ul\x3e"+me.localize("sureContinue"),buttons:Ext.Msg.YESNO,fn:function(btn){if(btn==="yes")me.loadForm(form);else{file.reset();file.fileInputEl.dom.setAttribute("multiple",true)}},scope:form})}else me.loadForm(form)}}}}},"-\x3e",{xtype:"button",scale:"large",glyph:"xf00d@FontAwesome",
text:this.localize("cancel"),hidden:this.getCorpus()==undefined,handler:function(btn){var win=this.up("window");if(win&&win.isFloating())win.close()}},{xtype:"button",scale:"large",glyph:"xf00c@FontAwesome",text:this.localize("reveal"),ui:"default",width:200,handler:function(btn){var input=btn.up("form").down("#input").getValue();if(input!==""){var api=me.getApiParams();delete api.view;delete api.stopList;if(api.inputFormat&&input.trim().indexOf("\x3c")!==0)Ext.Msg.confirm(me.localize("error"),me.localize("errorNotXmlContinue"),
function(buttonId){if(buttonId=="yes")me.loadCorpus(Ext.apply(api,{input:input}))},me);else me.loadCorpus(Ext.apply(api,{input:input}))}else Ext.Msg.show({title:me.localize("noTextProvided"),message:me.localize("pleaseProvideText"),buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR})}}]}],items:[{html:this.getInitialConfig().addTextLabel,hidden:this.getInitialConfig().addTextLabel==undefined},{height:100,xtype:"textareafield",itemId:"input",emptyText:this.localize("emptyInput")}]});me.on("boxready",function(panel){var app=
this.getApplication();if(app.getAllowInput&&app.getAllowInput()=="false")if(app.getNoAllowInputText&&app.getNoAllowInputText().trim().length>0)Ext.defer(function(){var parent=panel.up("container");parent.removeAll();parent.add({frame:false,padding:10,style:{borderColor:"#aaa",borderStyle:"solid"},html:app.getNoAllowInputText()})},100);else{panel.hide();Ext.create("Ext.window.Window",{layout:"fit",header:false,modal:true,bodyPadding:10,items:{html:"\x3cp style\x3d'color: red;'\x3e"+panel.localize("noAllowInputMessage")+
"\x3c/p\x3e"}}).show()}});me.callParent(arguments)},loadForm:function(form){var params={tool:this.getCorpus()?"corpus.CorpusMetadata":"corpus.CorpusCreator"};if(this.getCorpus())Ext.apply(params,{corpus:this.getCorpus().getId(),addDocuments:true});var apiParams=this.getApiParams();delete apiParams.view;delete apiParams.stopList;Ext.apply(params,apiParams);var view=this.getApplication().getViewport();view.mask(this.localize("uploadingCorpus"));form.submit({url:this.getTromboneUrl(),params:params,failure:function(form,
action){view.unmask();if(action.result&&(action.result.corpus||action.result.stepEnabledCorpusCreator)){var corpusParams={corpus:action.result.corpus?action.result.corpus.metadata.id:action.result.stepEnabledCorpusCreator.storedId};Ext.applyIf(corpusParams,apiParams);this.setCorpus(undefined);this.loadCorpus(corpusParams)}else this.showResponseError("Unable to load corpus.",action.response)},scope:this})},loadCorpus:function(params){if(this.getCorpus())Ext.apply(params,{corpus:this.getCorpus().getId(),
addDocuments:true});var win=this.up("window");if(win&&win.isFloating())win.close();this.getApplication().loadCorpusFromParams(params)},showOptionsClick:function(panel){var me=panel;if(me.optionsWin===undefined)me.optionsWin=Ext.create("Ext.window.Window",{title:me.localize("gearWinTitle"),closeAction:"hide",layout:"fit",bodyPadding:10,anchor:"100% 100%",items:[{xtype:"form",defaultType:"textfield",maxHeight:me.getApplication().getViewport().getHeight()-120,scrollable:true,fieldDefaults:{labelAlign:"right",
labelWidth:110,width:350},items:[{xtype:"combo",fieldLabel:me.localize("inputFormat"),labelWidth:90,name:"inputFormat",queryMode:"local",store:[["",me.localize("inputFormatAuto")],["dtoc","DToC: Dynamic Table of Contexts"],["TEI","TEI: Text Encoding Initative"],["TEI","TEI Corpus"],["RSS","Really Simple Syndication: RSS"]],value:"",listeners:{afterrender:{fn:function(combo){var inputFormat=this.getApiParam("inputFormat");if(inputFormat)combo.setValue(inputFormat)},scope:me}}},{xtype:"container",html:"\x3cp\x3e\x3ci\x3e"+
(new Ext.Template(me.localize("advancedOptionsText"))).applyTemplate([me.getBaseUrl()+"docs/#!/guide/corpuscreator-section-xml"])+"\x3c/i\x3e\x3c/p\x3e",width:375},{xtype:"fieldset",title:"\x3ca href\x3d'"+me.getBaseUrl()+"docs/#!/guide/corpuscreator-section-titles' target\x3d'voyantdocs'\x3e"+me.localize("corpusOptions")+"\x3c/a\x3e",collapsible:true,collapsed:true,defaultType:"textfield",items:[{xtype:"container",html:"\x3cp\x3e\x3ci\x3e"+"\x3c/i\x3e\x3c/p\x3e",width:375},{fieldLabel:me.localize("corpusTitle"),
name:"title"},{fieldLabel:me.localize("corpusSubTitle"),name:"subTitle"},{fieldLabel:me.localize("corpusSort"),name:"sort",xtype:"combo",queryMode:"local",store:[["",me.localize("corpusSortAuto")],["TITLEASC",me.localize("corpusSortTitle")],["AUTHORASC",me.localize("corpusSortAuthor")],["PUBDATEASC",me.localize("corpusSortPubDate")]],value:"",listeners:{afterrender:{fn:function(combo){var inputFormat=this.getApiParam("sort");if(inputFormat)combo.setValue(inputFormat)},scope:me}}}]},{xtype:"fieldset",
title:"\x3ca href\x3d'"+me.getBaseUrl()+"docs/#!/guide/corpuscreator-section-text' target\x3d'voyantdocs'\x3e"+me.localize("textOptions")+"\x3c/a\x3e",collapsible:true,collapsed:true,defaultType:"textfield",items:[{xtype:"container",html:"\x3cp\x3e\x3ci\x3e"+me.localize("textOptionsText")+"\x3c/i\x3e\x3c/p\x3e",width:375},{fieldLabel:me.localize("inputRemoveUntil"),name:"inputRemoveUntil"},{fieldLabel:me.localize("inputRemoveUntilAfter"),name:"inputRemoveUntilAfter"},{fieldLabel:me.localize("inputRemoveFrom"),
name:"inputRemoveFrom"},{fieldLabel:me.localize("inputRemoveFromAfter"),name:"inputRemoveFromAfter"}]},{xtype:"fieldset",title:"\x3ca href\x3d'"+me.getBaseUrl()+"docs/#!/guide/corpuscreator-section-xml' target\x3d'voyantdocs'\x3e"+me.localize("xmlOptions")+"\x3c/a\x3e",collapsible:true,collapsed:true,defaultType:"textfield",items:[{xtype:"container",html:"\x3cp\x3e\x3ci\x3e"+me.localize("xmlOptionsText")+"\x3c/i\x3e\x3c/p\x3e",width:375},{fieldLabel:me.localize("xpathContent"),name:"xmlContentXpath"},
{fieldLabel:me.localize("xpathTitle"),name:"xmlTitleXpath"},{fieldLabel:me.localize("xpathAuthor"),name:"xmlAuthorXpath"},{fieldLabel:me.localize("xpathDocuments"),name:"xmlDocumentsXpath"},{fieldLabel:me.localize("xpathGroupBy"),name:"xmlGroupByXpath"},{xtype:"fieldset",title:me.localize("xmlAdditionalOptions"),collapsible:true,collapsed:true,defaultType:"textfield",items:[{fieldLabel:me.localize("xpathPubDate"),name:"xmlPubDateXpath"},{fieldLabel:me.localize("xpathPublisher"),name:"xmlPublisherXpath"},
{fieldLabel:me.localize("xpathPubPlace"),name:"xmlPubPlaceXpath"},{fieldLabel:me.localize("xpathKeywords"),name:"xmlKeywordsXpath"},{fieldLabel:me.localize("xpathCollection"),name:"xmlCollectionXpath"},{xtype:"textareafield",grow:true,fieldLabel:me.localize("xpathExtra"),name:"xmlExtraMetadataXpath"}]}]},{xtype:"fieldset",title:"\x3ca href\x3d'"+me.getBaseUrl()+"docs/#!/guide/corpuscreator-section-html' target\x3d'voyantdocs'\x3e"+me.localize("htmlOptions")+"\x3c/a\x3e",collapsible:true,collapsed:true,
defaultType:"textfield",items:[{xtype:"container",html:"\x3cp\x3e\x3ci\x3e"+(new Ext.Template(me.localize("htmlOptionsText"))).applyTemplate([me.getBaseUrl()+"docs/#!/guide/corpuscreator-section-html"])+"\x3c/i\x3e\x3c/p\x3e",width:375},{fieldLabel:me.localize("xpathContent"),name:"htmlContentQuery"},{fieldLabel:me.localize("xpathTitle"),name:"htmlTitleQuery"},{fieldLabel:me.localize("xpathAuthor"),name:"htmlAuthorQuery"},{fieldLabel:me.localize("xpathDocuments"),name:"htmlDocumentsQuery"},{fieldLabel:me.localize("xpathGroupBy"),
name:"htmlGroupByQuery"},{xtype:"fieldset",title:me.localize("xmlAdditionalOptions"),collapsible:true,collapsed:true,defaultType:"textfield",items:[{fieldLabel:me.localize("xpathPubDate"),name:"htmlPubDateQuery"},{fieldLabel:me.localize("xpathPublisher"),name:"htmlPublisherQuery"},{fieldLabel:me.localize("xpathPubPlace"),name:"htmlPubPlaceQuery"},{fieldLabel:me.localize("xpathKeywords"),name:"htmlKeywordsQuery"},{fieldLabel:me.localize("xpathCollection"),name:"htmlCollectionQuery"},{xtype:"textareafield",
grow:true,fieldLabel:me.localize("xpathExtra"),name:"htmlExtraMetadataQuery"}]}]},{xtype:"fieldset",title:"\x3ca href\x3d'"+me.getBaseUrl()+"docs/#!/guide/corpuscreator-section-json' target\x3d'voyantdocs'\x3e"+me.localize("jsonOptions")+"\x3c/a\x3e",collapsible:true,collapsed:true,defaultType:"textfield",items:[{xtype:"container",html:"\x3cp\x3e\x3ci\x3e"+(new Ext.Template(me.localize("jsonOptionsText"))).applyTemplate([me.getBaseUrl()+"docs/#!/guide/corpuscreator-section-json"])+"\x3c/i\x3e\x3c/p\x3e",
width:375},{fieldLabel:me.localize("xpathContent"),name:"jsonContentPointer"},{fieldLabel:me.localize("xpathTitle"),name:"jsonTitlePointer"},{fieldLabel:me.localize("xpathAuthor"),name:"jsonAuthorPointer"},{fieldLabel:me.localize("xpathDocuments"),name:"jsonDocumentsPointer"},{xtype:"fieldset",title:me.localize("xmlAdditionalOptions"),collapsible:true,collapsed:true,defaultType:"textfield",items:[{fieldLabel:me.localize("xpathPubDate"),name:"jsonPubDatePointer"},{fieldLabel:me.localize("xpathPublisher"),
name:"jsonPublisherPointer"},{fieldLabel:me.localize("xpathPubPlace"),name:"jsonPubPlacePointer"},{fieldLabel:me.localize("xpathKeywords"),name:"jsonKeywordsPointer"},{fieldLabel:me.localize("xpathCollection"),name:"jsonCollectionPointer"},{xtype:"textareafield",grow:true,fieldLabel:me.localize("xpathExtra"),name:"jsonExtraMetadataPointer"}]}]},{xtype:"fieldset",title:"\x3ca href\x3d'"+me.getBaseUrl()+"docs/#!/guide/corpuscreator-section-tables' target\x3d'voyantdocs'\x3e"+me.localize("tableOptions")+
"\x3c/a\x3e",collapsible:true,collapsed:true,defaultType:"textfield",items:[{xtype:"container",html:"\x3cp\x3e\x3ci\x3e"+(new Ext.Template(me.localize("tableOptionsText"))).applyTemplate([me.getBaseUrl()+"docs/#!/guide/corpuscreator-section-tables"])+"\x3c/i\x3e\x3c/p\x3e",width:375},{xtype:"combo",fieldLabel:me.localize("tableDocuments"),name:"tableDocuments",queryMode:"local",store:[["",me.localize("tableDocumentsTable")],["rows",me.localize("tableDocumentsRows")],["columns",me.localize("tableDocumentsColumns")]],
forceSelection:true,value:""},{xtype:"container",html:"\x3cp\x3e\x3ci\x3e"+me.localize("tableNoHeadersRowText")+"\x3c/i\x3e\x3c/p\x3e",width:375},{fieldLabel:me.localize("tableNoHeadersRow"),xtype:"checkboxfield",name:"tableNoHeadersRow",inputValue:"true"},{xtype:"container",html:"\x3cp\x3e\x3ci\x3e"+me.localize("tableContentText")+"\x3c/i\x3e\x3c/p\x3e",width:375},{fieldLabel:me.localize("tableContent"),validator:function(val){return me.validatePositiveNumbersCsv.call(me,val)},name:"tableContent"},
{xtype:"container",html:"\x3cp\x3e\x3ci\x3e"+me.localize("tableMetadataText")+"\x3c/i\x3e\x3c/p\x3e",width:375},{fieldLabel:me.localize("tableAuthor"),validator:function(val){return me.validatePositiveNumbersCsv.call(me,val)},name:"tableAuthor"},{fieldLabel:me.localize("tableTitle"),validator:function(val){return me.validatePositiveNumbersCsv.call(me,val)},name:"tableTitle"}]},{xtype:"fieldset",title:"\x3ca href\x3d'"+me.getBaseUrl()+"docs/#!/guide/corpuscreator-section-processing' target\x3d'voyantdocs'\x3e"+
me.localize("processingOptions")+"\x3c/a\x3e",collapsible:true,collapsed:true,items:[{xtype:"combo",fieldLabel:me.localize("language"),name:"language",queryMode:"local",store:[["",me._localizeClass(Voyant.widget.StopListOption,"auto")],["cn",me._localizeClass(Voyant.widget.StopListOption,"cn")],["bo",me._localizeClass(Voyant.widget.StopListOption,"bo")],["grc",me._localizeClass(Voyant.widget.StopListOption,"grc")]],forceSelection:true,value:""},{xtype:"combo",fieldLabel:me.localize("tokenization"),
name:"tokenization",queryMode:"local",store:[["",me.localize("tokenizationAuto")],["wordBoundaries",me.localize("tokenizationWordBoundaries")],["whitespace",me.localize("tokenizationWhitespace")]],forceSelection:true,value:""}]},{xtype:"fieldset",title:"\x3ca href\x3d'"+me.getBaseUrl()+"docs/#!/guide/corpuscreator-section-access-management' target\x3d'voyantdocs'\x3e"+me.localize("accessOptions")+"\x3c/a\x3e",collapsible:true,collapsed:true,defaultType:"textfield",items:[{xtype:"container",html:"\x3cp\x3e\x3ci\x3e"+
me.localize("accessOptionsText")+"\x3c/i\x3e\x3c/p\x3e",width:375},{fieldLabel:me.localize("adminPassword"),name:"adminPassword"},{fieldLabel:me.localize("accessPassword"),name:"accessPassword"},{xtype:"container",html:"\x3cp\x3e\x3ci\x3e"+me.localize("accessModeWithoutPasswordText")+"\x3c/i\x3e\x3c/p\x3e",width:375},{xtype:"combo",fieldLabel:me.localize("accessModeWithoutPassword"),name:"noPasswordAccess",queryMode:"local",store:[["",me.localize("accessModeNonConsumptive")],["none",me.localize("accessModeNone")]],
forceSelection:true,value:""}]}]}],buttons:[{text:me.localize("ok"),handler:function(button,event){var win=button.findParentByType("window");var form=win.down("form");if(form.isValid()){var params=form.getValues();me.setApiParams(params);win.hide()}else me.showError({message:me.localize("invalidForm")})}},{text:me.localize("cancel"),handler:function(button,event){button.findParentByType("window").hide()}}]});me.optionsWin.showAt(me.getApplication().getViewport().getWidth()/2-200,10)},validatePositiveNumbersCsv:function(val){val=
val.trim();if(val.length>0){if(/[^\d,+ ]/.test(val))return this.localize("numbersCommasOnly");if(/\d\s+\d/.test(val))return this.localize("numbersNeedCommas");var numbers=val.split(/\s*[,+]\s*/),number;for(var i=0,len=numbers.length;i<len;i++){number=numbers[i];if(number.length==0)return this.localize("numberEmpty");if(parseInt(number)==0)return this.localize("numberZero")}}return true}});Ext.define("Voyant.panel.DreamScape",{extend:"Ext.Panel",xtype:"dreamscape",mixins:["Voyant.panel.Panel"],statics:{i18n:{},api:{stopList:"auto",hide:[],author:undefined,title:undefined,keyword:undefined,pubDate:undefined,citiesMaxCount:500,minPopulation:1E4,citiesMinFreq:1,connectionsMaxCount:2500,connectionsMinFreq:1,millisPerAnimation:2E3,annotationsId:undefined,source:undefined,overridesId:undefined,filterHasLowerCaseForm:true,filterIsPersonName:true,preferredCoordinates:undefined},glyph:"xf124@FontAwesome"},
config:{map:undefined,overlay:undefined,contentEl:undefined,isOpenLayersLoaded:false,isArcLoaded:false,animationDelay:25,isProj4Loaded:false,projection:undefined,filterWidgets:new Ext.util.MixedCollection,drawInteraction:undefined,drawMode:false,baseLayers:{},annotations:undefined,annotationsLoadedIfAvailable:false,overrides:{}},html:'\x3cdiv class\x3d"map"\x3e\x3c/div\x3e\x3cdiv class\x3d"ticker"\x3e\x3c/div\x3e',cls:"dreamscape",constructor:function(config){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,
arguments);Ext.Loader.loadScript({url:this.getBaseUrl()+"resources/openlayers/ol.js",onLoad:function(){if(ol.Map.prototype.getLayer===undefined)ol.Map.prototype.getLayer=function(id){var layer=undefined;this.getLayers().forEach(function(lyr){if(id===lyr.get("id"))layer=lyr});return layer};this.setIsOpenLayersLoaded(true)},scope:this});Ext.Loader.loadScript({url:this.getBaseUrl()+"resources/dreamscape/arc.js",onLoad:function(){this.setIsArcLoaded(true)},scope:this});Ext.Loader.loadScript({url:"https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.4.4/proj4.js",
onLoad:function(){this.setIsProj4Loaded(true)},scope:this});var annotationsId=this.getApiParam("annotationsId");if(annotationsId){var me=this;Ext.Ajax.request({url:this.getTromboneUrl(),params:{tool:"resource.StoredResource",retrieveResourceId:annotationsId},scope:this}).then(function(response){var data=Ext.JSON.decode(response.responseText);if(data.storedResource.resource){var annotations=Ext.JSON.decode(data.storedResource.resource);if(Ext.isString(annotations)){annotations=Ext.JSON.decode(annotations);
me.setAnnotations(annotations)}}if(!me.getAnnotations())me.showError(me.localize("annotationsLoadFailed"));me.setAnnotationsLoadedIfAvailable(true)},function(response){me.showResponseError(me.localize("annotationsLoadFailed"),response);me.setAnnotationsLoadedIfAvailable(true)})}else this.setAnnotationsLoadedIfAvailable(true)},initComponent:function(){var me=this;this.mixins["Voyant.util.Api"].constructor.apply(this,arguments);var hide=this.getApiParam("hide");if(Ext.isString(hide)){hide=hide.split(",");
this.setApiParam("hide")}var iconBase=this.getApplication().getBaseUrl()+"resources/dreamscape/";Ext.apply(this,{title:this.localize("title"),bodyBorder:true,dockedItems:[{dock:"bottom",xtype:"toolbar",itemId:"bottomToolbar",overflowHandler:"scroller",items:[{text:this.localize("display"),tooltip:this.localize("displayTip"),glyph:"xf013@FontAwesome",menu:{defaults:{xtype:"menucheckitem",checkHandler:function(item,checked){var map=this.getMap(),id=item.getItemId();this.getFilterWidgets().each(function(filter){map.getLayer(filter.getId()+
"-"+id).setVisible(checked)});var hide=Ext.Array.from(this.getApiParam("hide"));if(checked)hide=Ext.Array.remove(hide,id);else{hide.push(id);hide=Ext.Array.unique(hide)}this.setApiParam("hide",hide);item.getMenu().setDisabled(checked==false)},scope:this,checked:true},items:[{xtype:"menuitem",text:this.localize("baseLayer"),tooltip:this.localize("baseLayerTip"),glyph:"xf279@FontAwesome",menu:{items:[{xtype:"radiogroup",columns:1,vertical:true,defaults:{cls:"map-menu-item",handler:function(item,checked){if(checked){var panel=
this;id=item.getItemId();var layer=this.getBaseLayers()[id];if(layer){layer.setOpacity(1);this.getMap().getLayers().setAt(0,layer)}if(id=="osm"||id=="arcGIS")this.getMap().getLayer("overlayLayer").setVisible(false);else this.getMap().getLayer("overlayLayer").setVisible(true)}},listeners:{afterrender:function(item){Ext.create("Ext.tip.ToolTip",{target:item,html:'\x3cdiv class\x3d"map-menu-item-tooltip '+item.getItemId()+'"\x3e\x3c/div\x3e',anchor:"right"})}},scope:this},items:[{boxLabel:this.localize("watercolor"),
itemId:"watercolor",cls:["map-menu-item","watercolor"],checked:true},{boxLabel:this.localize("wms4326"),cls:["map-menu-item","wms4326"],itemId:"wms4326"},{boxLabel:this.localize("osm"),cls:["map-menu-item","osm"],itemId:"osm"},{boxLabel:this.localize("arcGIS"),cls:["map-menu-item","arcGIS"],itemId:"arcGIS"}]}]}},{xtype:"menuitem",text:this.localize("projection"),tooltip:this.localize("projectionTip"),glyph:"xf0ac@FontAwesome",menu:{items:[{xtype:"radiogroup",columns:1,vertical:true,defaults:{handler:function(item,
checked){if(checked){var panel=this;id=item.getItemId();var view=undefined;if(id==="webMercatorProjection")this.setProjection(ol.proj.get("EPSG:3857"));else if(id==="mercatorProjection")this.setProjection(ol.proj.get("EPSG:4326"));else if(id==="gallPetersProjection"){proj4.defs("cea","+proj\x3dcea +lon_0\x3d0 +lat_ts\x3d45 +x_0\x3d0 +y_0\x3d0 +ellps\x3dWGS84 +units\x3dm +no_defs");var gallPetersProjection=ol.proj.get("cea");this.setProjection(gallPetersProjection)}else if(id==="sphereMollweideProjection"){proj4.defs("ESRI:54009",
"+proj\x3dmoll +lon_0\x3d0 +x_0\x3d0 +y_0\x3d0 +datum\x3dWGS84 +units\x3dm +no_defs");var sphereMollweideProjection=ol.proj.get("ESRI:54009");sphereMollweideProjection.setExtent([-18E6,-9E6,18E6,9E6]);this.setProjection(sphereMollweideProjection)}var newProjExtent=this.getProjection().getExtent();var earthWidth=this.getProjection()==ol.proj.get("EPSG:4326")?360:4.007501668557849E7;var newView=new ol.View({projection:this.getProjection(),center:ol.extent.getCenter(newProjExtent||[0,0,0,0]),maxResolution:earthWidth/
panel.body.dom.offsetWidth,zoom:0});var map=this.getMap();var layers=map.getLayers();layers.forEach(function(layer){if(layer.getSource().getFeatures){var features=layer.getSource().getFeatures();features.forEach(function(feature){var newGeometry=feature.getGeometry().transform(map.getView().getProjection(),panel.getProjection());feature.setGeometry(newGeometry)})}});map.setView(newView)}},listeners:{afterrender:function(item){Ext.create("Ext.tip.ToolTip",{target:item,html:'\x3cdiv class\x3d"map-menu-item-tooltip '+
item.getItemId()+'"\x3e\x3c/div\x3e',anchor:"right"})}},scope:this},items:[{boxLabel:this.localize("webMercatorProjection"),itemId:"webMercatorProjection",cls:["map-menu-item","webMercatorProjection"],checked:true},{boxLabel:this.localize("mercatorProjection"),cls:["map-menu-item","mercatorProjection"],itemId:"mercatorProjection"},{boxLabel:this.localize("gallPetersProjection"),cls:["map-menu-item","gallPetersProjection"],itemId:"gallPetersProjection"},{boxLabel:this.localize("sphereMollweideProjection"),
cls:["map-menu-item","sphereMollweideProjection"],itemId:"sphereMollweideProjection"}]}]}},"-",{text:this.localize("cities"),checked:Ext.Array.contains(hide,"cities")==false,itemId:"cities",menu:{defaults:{labelAlign:"right",labelWidth:140},items:[{xtype:"numberfield",fieldLabel:this.localize("citiesMaxCount"),minValue:1,value:parseInt(this.getApiParam("citiesMaxCount")),listeners:{change:function(cmp,newVal,oldVal){this.getFilterWidgets().each(function(filter){this.setApiParam("citiesMaxCount",newVal);
var currentCitiesCount=filter.getGeonames().getCitiesCount();if(newVal<oldVal||newVal<=currentCitiesCount)this.filterUpdate(filter);else if(filter.getGeonames().hasMoreCities())filter.loadGeonames();else{cmp.setValue(currentCitiesCount);this.toastInfo((new Ext.XTemplate(this.localize("allNCitiesShown"))).apply([currentCitiesCount]))}},this)},scope:this}},{xtype:"numberfield",fieldLabel:this.localize("citiesMinPopulation"),minValue:1,value:parseInt(this.getApiParam("minPopulation")),listeners:{change:function(cmp,
newVal,oldVal){this.setApiParam("minPopulation",newVal);this.getFilterWidgets().each(function(filter){if(newVal>oldVal)this.filterUpdate(filter);else filter.loadGeonames()},this)},scope:this}},{xtype:"numberfield",fieldLabel:this.localize("citiesMinFreq"),minValue:1,value:parseInt(this.getApiParam("citiesMinFreq")),listeners:{change:function(cmp,newVal,oldVal){this.getFilterWidgets().each(function(filter){this.setApiParam("citiesMinFreq",newVal);if(newVal>oldVal)this.filterUpdate(filter);else filter.loadGeonames()},
this)},scope:this}}]}},{text:this.localize("connections"),checked:Ext.Array.contains(hide,"connections")==false,itemId:"connections",menu:{defaults:{labelWidth:140,labelAlign:"right"},items:[{xtype:"numberfield",fieldLabel:this.localize("connectionsMaxCount"),minValue:1,value:parseInt(this.getApiParam("connectionsMaxCount")),listeners:{change:function(cmp,newVal,oldVal){this.getFilterWidgets().each(function(filter){this.setApiParam("connectionsMaxCount",newVal);if(newVal>oldVal)this.filterUpdate(filter);
else filter.loadGeonames()},this)},scope:this}},{xtype:"numberfield",fieldLabel:this.localize("connectionsMinFreq"),minValue:1,value:parseInt(this.getApiParam("connectionsMinFreq")),listeners:{change:function(cmp,newVal,oldVal){this.getFilterWidgets().each(function(filter){this.setApiParam("connectionsMinFreq",newVal);if(newVal>oldVal)this.filterUpdate(filter);else filter.loadGeonames()},this)},scope:this}}]}},{xtype:"menucheckitem",checked:Ext.Array.contains(hide,"animation")==false,text:this.localize("animations"),
itemId:"animation",menu:{defaults:{labelWidth:170,labelAlign:"right",width:280},items:[{xtype:"sliderfield",fieldLabel:this.localize("millisPerAnimation"),value:parseInt(this.getApiParam("millisPerAnimation")),minValue:this.getAnimationDelay(),maxValue:1E4,listeners:{change:function(cmp,newVal,oldVal){this.getFilterWidgets().each(function(filter){filter.setMillisPerAnimation(newVal);filter.animate()},this)},scope:this}}]}}]}},"-",{text:this.localize("add"),itemId:"addFilter",glyph:"xf067@FontAwesome",
handler:function(cmp){var colors=this.getApplication().getColorPalette(this.getApiParam("palette"),true),color=colors[0];for(var i=0,len=colors.length;i<len;i++){var hasMatch=false;this.getFilterWidgets().each(function(filter){if(filter.getColor()==colors[i]){hasMatch=true;return false}});if(hasMatch==false){color=colors[i];break}}var filter=cmp.ownerCt.add({xtype:"geonamesfilter",corpus:this.getCorpus(),color:color,listeners:{removeFilterWidget:function(filter){var map=this.getMap(),id=filter.getItemId(),
filters=this.getFilterWidgets();["connections","cities","animation"].forEach(function(layer){map.removeLayer(map.getLayer(id+"-"+layer))});filters.remove(filter);if(filters.getCount()==0)this.getDockedComponent("bottomToolbar").getComponent("addFilter").click()},filterUpdate:this.filterUpdate,scope:this}});this.getFilterWidgets().add(filter.getId(),filter);var map=this.getMap();var connectionsLayer=new ol.layer.Vector({source:new ol.source.Vector({wrapX:false,useSpatialIndex:true}),id:filter.getId()+
"-connections",visible:true,opacity:.2,style:this.travelStyleFunction.bind(this),updateWhileAnimating:true,updateWhileInteracting:true});map.addLayer(connectionsLayer);var citiesLayer=new ol.layer.Vector({source:new ol.source.Vector({wrapX:false,useSpatialIndex:true}),id:filter.getId()+"-cities",opacity:.5,style:this.cityStyleFunction.bind(this)});map.addLayer(citiesLayer);var animationLayer=new ol.layer.Vector({source:new ol.source.Vector({wrapX:false,useSpatialIndex:true}),id:filter.getId()+"-animation",
style:this.animationStyleFunction.bind(this)});map.addLayer(animationLayer)},scope:this}]}]});this.on("loadedCorpus",function(src,corpus){this.tryInit()},this);this.callParent()},tryInit:function(){if(this.getIsOpenLayersLoaded()&&this.getIsArcLoaded()&&this.getIsProj4Loaded()&&this.getAnnotationsLoadedIfAvailable()){var el=this.body.down(".map").setId(Ext.id());var panel=this;var baseLayers=this.getBaseLayers();baseLayers["wms4326"]=new ol.layer.Tile({preload:Infinity,source:new ol.source.TileWMS({url:"https://ahocevar.com/geoserver/wms",
crossOrigin:"",params:{"LAYERS":"ne:NE1_HR_LC_SR_W_DR","TILED":true},projection:"EPSG:4326"})});baseLayers["watercolor"]=new ol.layer.Tile({preload:Infinity,source:new ol.source.Stamen({layer:"watercolor",projection:"EPSG:3857"})});baseLayers["osm"]=new ol.layer.Tile({preload:Infinity,source:new ol.source.OSM({projection:"EPSG:3857"})});baseLayers["arcGIS"]=new ol.layer.Tile({preload:Infinity,source:new ol.source.TileArcGISRest({url:"https://services.arcgisonline.com/ArcGIS/rest/services/NatGeo_World_Map/MapServer",
projection:"EPSG:3857"})});var map=new ol.Map({layers:[baseLayers["watercolor"],new ol.layer.Tile({preload:Infinity,source:new ol.source.Stamen({cacheize:2048,layer:"toner-hybrid",projection:"EPSG:3857"}),id:"overlayLayer"})],target:el.getId(),loadTilesWhileInteracting:true,view:new ol.View({center:[0,0],maxResolution:4.007501668557849E7/panel.body.dom.offsetWidth,zoom:0})});map.on("singleclick",this.handleSingleClick,this);map.on("singleclicking",function(event){var pixel=event.pixel;var features=
map.getFeaturesAtPixel(pixel);if(features){for(var i=0;i<features.length;i++){var feature=features[i];if(feature.get("type")=="city")this.handleLocationClick(feature)}var feature=features[0];debugger}if(features){var foundFeature=false;features.forEach(function(feature){if(feature.get("type")==="city"&&feature.get("selected")){panel.dispatchEvent("termsClicked",panel,[feature.get("forms").join("|")]);foundFeature=true}else if(feature.get("type")==="connection"&&feature.get("selected")&&!foundFeature){panel.getFilterWidgets().each(function(filter){var geonames=
filter.getGeonames();if(geonames!=null){var occurrences=geonames.getAllConnectionOccurrences(feature.get("source"),feature.get("target"));var infos="\x3cul\x3e";var docIndex=-1;occurrences.forEach(function(occ){if(occ.docIndex!=docIndex){docIndex=occ.docIndex;infos+="\x3ch4\x3e"+panel.getCorpus().getDocument(docIndex).getFullLabel()+":\x3c/h4\x3e"}infos+="\x3cli\x3e"+occ.source.left+'\x3ca href\x3d"http://www.geonames.org/'+occ.source.id+'" target\x3d"_blank" docIndex\x3d'+occ.docIndex+" offset\x3d"+
occ.source.position+" location\x3d"+occ.source.form+" cityId\x3d"+occ.source.id+" coordinates\x3d"+JSON.stringify(sourceCoordinates)+' class\x3d"termLocationLink"\x3e'+occ.source.form+"\x3c/a\x3e "+occ.source.right+" [...] "+occ.target.left+'\x3ca href\x3d"http://www.geonames.org/'+occ.target.id+'" target\x3d"_blank" docIndex\x3d'+occ.docIndex+" offset\x3d"+occ.target.position+" location\x3d"+occ.target.form+" cityId\x3d"+occ.target.id+" coordinates\x3d"+JSON.stringify(targetCoordinates)+' class\x3d"termLocationLink"\x3e'+
occ.target.form+"\x3c/a\x3e "+occ.target.right+"\x3c/li\x3e"});var header=feature.get("text");infos+="\x3c/ul\x3e";panel.getContentEl().setHtml("\x3ch3\x3e"+header+"\x3c/h3\x3e"+infos);panel.getOverlay().setPosition(event.coordinate);var links=Ext.select(".termLocationLink");links.elements.forEach(function(link){link.onmouseover=function(){panel.showTermInCorpus(link.getAttribute("docIndex"),link.getAttribute("offset"),link.getAttribute("location"))}})}});foundFeature=true}},this)}});var selectedLayer=
new ol.layer.Vector({map:map,source:new ol.source.Vector({wrapX:false,useSpatialIndex:false}),zIndex:10,selected:true,style:function(feature){if(feature.get("type")==="city")return panel.cityStyleFunction(feature,map.getView().getResolution());else if(feature.get("type")==="connection")return panel.travelStyleFunction(feature,map.getView().getResolution())},updateWhileAnimating:true,updateWhileInteracting:true});var previewLayer=new ol.layer.Vector({map:map,source:new ol.source.Vector({wrapX:false,
useSpatialIndex:false}),preview:true,zIndex:15,id:"preview",style:function(feature){if(feature.get("type")==="city")return panel.cityStyleFunction(feature,map.getView().getResolution());else if(feature.get("type")==="connection")return panel.travelStyleFunction(feature,map.getView().getResolution())},updateWhileAnimating:true,updateWhileInteracting:true});map.addLayer(previewLayer);map.on("pointermove",function(event){var pixel=map.getEventPixel(event.originalEvent);var hit=map.hasFeatureAtPixel(pixel);
map.getViewport().style.cursor=hit?"pointer":"";if(!panel.getDrawMode()){selectedLayer.getSource().clear();var coordinate=event.coordinate;var pixel=event.pixel;var features=map.getFeaturesAtPixel(pixel);if(features){var i=0;while(features[i].get("selected")){i++;if(i===features.length)break}if(i<features.length){var feature=features[i];var baseTextStyle={font:"12px Calibri,sans-serif",textAlign:"center",offsetY:-15,fill:new ol.style.Fill({color:[0,0,0,1]}),stroke:new ol.style.Stroke({color:[255,
255,255,.5],width:4})};baseTextStyle.text=feature.get("text");var textOverlayStyle=new ol.style.Style({text:new ol.style.Text(baseTextStyle),zIndex:1});if(!(feature.get("type")==="annotation")){var selectedFeature=new ol.Feature({text:feature.get("text"),geometry:feature.getGeometry(),forms:feature.get("forms"),selected:true,coordinates:feature.get("coordinates"),width:feature.get("width"),visible:feature.get("visible"),color:feature.get("color"),type:feature.get("type"),confidence:feature.get("confidence"),
source:feature.get("source"),target:feature.get("target"),cityId:feature.get("cityId")});selectedLayer.getSource().addFeature(selectedFeature)}var geometry=feature.getGeometry();var point=event.coordinate;var textFeature=new ol.Feature({geometry:new ol.geom.Point(point),selected:true});textFeature.setStyle(textOverlayStyle);selectedLayer.getSource().addFeature(textFeature);if(feature.get("type")==="city"){var layers=panel.getMap().getLayers();layers.forEach(function(layer){var layerId=layer.get("id");
if(layerId&&layerId.indexOf("connections")!==-1){connections=layer.getSource().getFeatures();connections.forEach(function(connection){if(connection.get("target")===feature.get("cityId")||connection.get("source")===feature.get("cityId"))selectedLayer.getSource().addFeature(new ol.Feature({geometry:connection.getGeometry(),selected:true,coordinates:connection.get("coordinates"),width:connection.get("width"),visible:connection.get("visible"),color:connection.get("color"),type:connection.get("type")}))})}})}}}}});
var source=new ol.source.Vector({wrapX:false});var annotations=new ol.layer.Vector({source:source,id:"annotations"});var annotationsObj=this.getAnnotations();if(annotationsObj){var geojson=new ol.format.GeoJSON;var features=geojson.readFeatures(annotationsObj);source.addFeatures(features)}map.addLayer(annotations);this.setDrawInteraction(new ol.interaction.Draw({source:source,type:"Polygon",freehand:true,alias:"draw"}));this.getDrawInteraction().on("drawend",function(evt){evt.feature.set("type","annotation");
panel.editAnnotation(evt.feature)});this.setMap(map);var zoom=this.getTargetEl().down(".ol-zoom");Ext.create("Ext.Button",{glyph:"xf075@FontAwesome",cls:"annotate",renderTo:this.getTargetEl().down(".ticker").parent(),tooltip:this.localize("annotateTip"),enableToggle:true,toggleHandler:function(cmp,state){if(state)this.getMap().addInteraction(this.getDrawInteraction());else this.getMap().removeInteraction(this.getDrawInteraction())},scope:this});this.getDockedComponent("bottomToolbar").getComponent("addFilter").click()}else Ext.defer(this.tryInit,
500,this)},editAnnotation:function(feature){var text=feature.get("text"),buttons=[];Ext.Msg.show({title:this.localize("editAnnotation"),message:this.localize("editAnnotationMessage"),buttons:Ext.Msg.OKCANCEL,multiline:true,value:text,scope:this,callback:function(btn,val){if(btn=="ok"){if(val=="")this.getMap().getLayer("annotations").getSource().removeFeature(feature);else feature.set("text",val);var geojson=new ol.format.GeoJSON;var features=this.getMap().getLayer("annotations").getSource().getFeatures();
var transformedFeatures=[];var projection=this.getProjection();features.forEach(function(feature){transformedFeature=feature.clone();transformedFeature.getGeometry().transform(projection?projection:"EPSG:3857","EPSG:3857");transformedFeatures.push(transformedFeature)});var json=geojson.writeFeatures(transformedFeatures);this.storeAnnotations(json)}}})},storeAnnotations:function(json){this.mask("storingAnnotations");var me=this;Ext.Ajax.request({url:this.getTromboneUrl(),params:{tool:"resource.StoredResource",
storeResource:JSON.stringify(json)},scope:this}).then(function(response){me.unmask();var data=Ext.JSON.decode(response.responseText);me.setApiParam("annotationsId",data.storedResource.id);me.toastInfo(me.localize("annotationsUpdated"))},function(response){me.unmask();me.showResponseError(me.localize("annotationsUpdateFailed"),response)})},travelStyleFunction:function(feature,resolution){var stroke=new ol.style.Stroke({color:feature.get("color"),width:feature.get("width")});var styles=[new ol.style.Style({stroke:stroke})];
var geometry=feature.getGeometry();var end=geometry.getLastCoordinate();var beforeEnd=geometry.getCoordinateAt(.9);var dx=end[0]-beforeEnd[0];var dy=end[1]-beforeEnd[1];var rotation=Math.atan2(dy,dx);var lineStr1=new ol.geom.LineString([end,[end[0]-10*resolution,end[1]+10*resolution]]);lineStr1.rotate(rotation,end);var lineStr2=new ol.geom.LineString([end,[end[0]-10*resolution,end[1]-10*resolution]]);lineStr2.rotate(rotation,end);styles.push(new ol.style.Style({geometry:lineStr1,stroke:stroke}));
styles.push(new ol.style.Style({geometry:lineStr2,stroke:stroke}));return styles},cityStyleFunction:function(feature,resolution){if(feature.get("visible")){var diameter=Math.PI*2*feature.get("width");var confArc=feature.get("confidence")?diameter*feature.get("confidence"):diameter;return new ol.style.Style({image:new ol.style.Circle({radius:feature.get("width"),fill:new ol.style.Fill({color:feature.get("color")}),stroke:new ol.style.Stroke({lineDash:[confArc,diameter-confArc],color:"rgb(255, 255, 255)",
width:2})})})}else return false},animationStyleFunction:function(feature){return[new ol.style.Style({stroke:new ol.style.Stroke({color:feature.get("color"),width:5})}),new ol.style.Style({geometry:new ol.geom.Circle(feature.getGeometry().getFirstCoordinate()),stroke:new ol.style.Stroke({color:"white",width:10})}),new ol.style.Style({geometry:new ol.geom.Circle(feature.getGeometry().getLastCoordinate()),stroke:new ol.style.Stroke({color:"white",width:10})})]},showTermInCorpus:function(docIndex,position,
location){var term=Ext.create("Voyant.data.model.Context",{docIndex:docIndex,position:position,term:location});this.getApplication().dispatchEvent("termLocationClicked",this,[term])},reloadFilters:function(){this.getFilterWidgets().each(function(filter){filter.loadGeonames()},this)},filterUpdate:function(filter){var panel=this;filter.clearAnimation();var map=this.getMap(),color=filter.getColor();var citiesMaxCount=parseInt(this.getApiParam("citiesMaxCount"));var max=0;filter.getGeonames().eachCity(function(city){if(city.rawFreq>
max)max=city.rawFreq},this,citiesMaxCount);var layerSource=map.getLayer(filter.getId()+"-cities").getSource();var hide=Ext.Array.from(this.getApiParam("hide"));layerSource.clear();var minPopulation=parseInt(this.getApiParam("minPopulation"));var citiesMinFreq=parseInt(this.getApiParam("citiesMinFreq"));var validCitiesHash={};filter.getGeonames().eachCity(function(city){if((!minPopulation||city.population>=minPopulation)&&(!citiesMinFreq||city.rawFreq>=citiesMinFreq)){validCitiesHash[city.id]=true;
var coordinates=[parseFloat(city.lng),parseFloat(city.lat)];var feature=new ol.Feature({geometry:(new ol.geom.Point(coordinates)).transform(ol.proj.get("EPSG:4326"),panel.getProjection()?panel.getProjection():ol.proj.get("EPSG:3857")),text:city.label+" ("+city.rawFreq+")",description:city.label,color:color,selected:false,width:3+Math.sqrt(city.rawFreq/max)*20,visible:true,coordinates:coordinates,forms:city.forms,cityId:city.id,type:"city",confidence:city.confidence?city.confidence*100:undefined});
layerSource.addFeature(feature)}},this,citiesMaxCount);if(layerSource.getFeatures().length>0)map.getView().fit(layerSource.getExtent());map.getLayer(filter.getId()+"-cities").setVisible(Ext.Array.contains(hide,"cities")==false);layerSource=map.getLayer(filter.getId()+"-connections").getSource();layerSource.clear();if(Object.keys(validCitiesHash).length==0)this.toastInfo("No cities available for current criteria.");max=0;filter.getGeonames().eachConnection(function(connection){if(connection.rawFreq>
max)max=connection.rawFreq},this);var counter=0,maxConnectionsCount=parseInt(this.getApiParam("connectionsMaxCount")),connectionsMinFreq=parseInt(this.getApiParam("connectionsMinFreq"));filter.getGeonames().eachConnection(function(connection){if((!connectionsMinFreq||connection.rawFreq>=connectionsMinFreq)&&(!maxConnectionsCount||counter<maxConnectionsCount)&&connection.source.id in validCitiesHash&&connection.target.id in validCitiesHash&&(!minPopulation||connection.source.population>=minPopulation&&
connection.target.population>=minPopulation)){var arcGenerator=new arc.GreatCircle({x:connection.source.lng,y:connection.source.lat},{x:connection.target.lng,y:connection.target.lat});var arcLine=arcGenerator.Arc(100,{offset:100});var label=connection.source.label+" -\x3e "+connection.target.label+" ("+connection.rawFreq+")";arcLine.geometries.forEach(function(geometry){var line=new ol.geom.LineString(geometry.coords);line.transform(ol.proj.get("EPSG:4326"),panel.getProjection()?panel.getProjection():
ol.proj.get("EPSG:3857"));var feature=new ol.Feature({geometry:line,text:label,color:color,width:3+Math.sqrt(connection.rawFreq/max)*10,source:connection.source.id,target:connection.target.id,type:"connection"});layerSource.addFeature(feature)},this);counter++}},this);map.getLayer(filter.getId()+"-connections").setVisible(Ext.Array.contains(hide,"connections")==false);filter.animate()},handleSingleClick:function(event){var features=this.getMap().getFeaturesAtPixel(event.pixel);if(features)for(var i=
0;i<features.length;i++){var feature=features[i];var featureType=feature.get("type");if(featureType=="city"){this.handleLocationClick(event,feature);break}else if(featureType=="connection"){this.handleConnectionClick(feature,event.pixel[0],event.pixel[1]);break}else if(featureType=="annotation"){this.editAnnotation(feature);break}}},handleConnectionClick:function(feature,x,y){Ext.create("Ext.menu.Menu",{items:[{text:this.localize("viewConnections"),tooltip:this.localize("viewConnectionsTip"),glyph:"xf02d@FontAwesome",
handler:function(){this.mask("loadingConnections");var me=this;Ext.Ajax.request({url:this.getTromboneUrl(),params:{tool:"corpus.Dreamscape",corpus:this.getCorpus().getId(),suppressLocations:true,suppressConnections:true,sourceId:feature.get("source"),targetId:feature.get("target"),context:2,limit:25},scope:this}).then(function(response){me.unmask();var data=Ext.JSON.decode(response.responseText);if(data&&data.dreamscape&&data.dreamscape.connectionOccurrences){var out="\x3ctable style\x3d'font-size:smaller'\x3e";
data.dreamscape.connectionOccurrences.connectionOccurrences.forEach(function(occurrence){out+="\x3ctr\x3e\x3ctd style\x3d'text-align: right'\x3e"+occurrence.source.left+"\x3c/td\x3e\x3ctd class\x3d'keyword' style\x3d'text-align: center'\x3e"+occurrence.source.term+"\x3c/td\x3e\x3ctd\x3e"+occurrence.source.right+"\x3c/td\x3e\x3ctd\x3e\u2026\x3c/td\x3e\x3ctd style\x3d'text-align: right'\x3e"+occurrence.target.left+"\x3c/td\x3e\x3ctd class\x3d'keyword' style\x3d'text-align: center'\x3e"+occurrence.target.term+
"\x3c/td\x3e\x3ctd\x3e"+occurrence.target.right+"\x3c/td\x3e\x3c/tr\x3e"});out+="\x3c/table\x3e";Ext.Msg.alert(me.localize("occurrences"),out)}},function(response){me.unmask();return me.showError(me.localize("occurrencesNotLoaded"))})},scope:this}]}).showAt(x,y)},handleLocationClick:function(event,feature){var currentGeonameId=feature.get("cityId");var e=Ext.create("Ext.menu.Menu",{items:[{text:this.localize("viewOccurrences"),tooltip:this.localize("viewOccurrencesTip"),glyph:"xf02d@FontAwesome",
handler:function(){this.mask("loadingOccurrences");var me=this;Ext.Ajax.request({url:this.getTromboneUrl(),params:{tool:"corpus.Dreamscape",corpus:this.getCorpus().getId(),suppressLocations:true,suppressConnections:true,suppressConnectionOccurrences:true,locationId:currentGeonameId,limit:25},scope:this}).then(function(response){me.unmask();var data=Ext.JSON.decode(response.responseText);if(data&&data.dreamscape&&data.dreamscape.occurrences){var out="\x3ctable style\x3d'font-size:smaller'\x3e";data.dreamscape.occurrences.occurrences.forEach(function(occurrence){out+=
"\x3ctr\x3e\x3ctd style\x3d'text-align: right'\x3e"+occurrence.left+"\x3c/td\x3e\x3ctd class\x3d'keyword' style\x3d'text-align: center'\x3e"+occurrence.term+"\x3c/td\x3e\x3ctd\x3e"+occurrence.right+"\x3c/td\x3e\x3c/tr\x3e"});out+="\x3c/table\x3e";Ext.Msg.alert(me.localize("occurrences"),out)}},function(response){me.unmask();return me.showError(me.localize("occurrencesNotLoaded"))})},scope:this},{text:this.localize("openInVoyant"),tooltip:this.localize("openInVoyantTip"),glyph:"xf08e@FontAwesome",
handler:function(){this.dispatchEvent("termsClicked",this,feature.get("forms"))},scope:this},{text:this.localize("editLocation"),tooltip:this.localize("editLocationTip"),glyph:"xf124@FontAwesome",handler:function(){this.mask("loadingAlternatives");var me=this;Ext.Ajax.request({url:this.getTromboneUrl(),params:{tool:"util.Geonames",query:feature.get("forms")},scope:this}).then(function(response){me.unmask();var data=Ext.JSON.decode(response.responseText);if(data&&data.geonames&&data.geonames.locations){var items=
[];Object.values(data.geonames.locations.locations).forEach(function(location){items.push({boxLabel:location.label+" ("+location.population+")",name:"id",inputValue:location.id,checked:location.id==currentGeonameId})});if(items.length==0)return me.showError(me.localize("editLocationNoLocationsFound"));else if(items.length==1&&items[0].inputValue==currentGeonameId)return me.showError(me.localize("editLocationNoAlternativesFound"));Ext.create("Ext.window.Window",{title:me.localize("editLocation"),modal:true,
items:{xtype:"form",items:[{xtype:"radiogroup",columns:1,vertical:true,items:items}],listeners:{afterrender:function(form){},scope:this},buttons:[{text:me.localize("cancel"),ui:"default-toolbar",glyph:"xf00d@FontAwesome",flex:1,handler:function(btn){btn.up("window").destroy()}},{text:me.localize("confirmTitle"),glyph:"xf00c@FontAwesome",flex:1,handler:function(btn){var newId=btn.up("form").getValues().id;if(newId&&newId!=currentGeonameId){var config={};config[currentGeonameId]=newId;me.appendOverrides(config)}btn.up("window").destroy()}}]}}).show()}},
function(response){me.unmask();me.showResponseError(me.localize("editLocationServerError"),response)})},scope:this},{text:this.localize("removeLocation"),tooltip:this.localize("removeLocationTip"),glyph:"xf00d@FontAwesome",handler:function(){Ext.Msg.confirm(this.localize("removeLocationConfirmTitle"),this.localize("removeLocationConfirm"),function(btn){if(btn=="yes"){var config={};config[currentGeonameId]="";this.appendOverrides(config)}},this)},scope:this}],listeners:{focusleave:function(menu){menu.destroy()}}}).showAt(event.pixel[0],
event.pixel[1])},appendOverrides:function(config,isAll){if(this.getApiParam("overridesId")&&!isAll){var me=this;Ext.Ajax.request({url:this.getTromboneUrl(),params:{tool:"resource.StoredResource",retrieveResourceId:this.getApiParam("overridesId")},scope:this}).then(function(response){var data=Ext.JSON.decode(response.responseText);if(data&&data.storedResource&&data.storedResource.resource){var newConfig=Ext.decode(data.storedResource.resource);Ext.apply(newConfig,config);me.appendOverrides(newConfig,
true)}else me.showResponseError(me.localize("overidesRetrieveError"),response)},function(response){me.showResponseError(me.localize("overidesRetrieveError"),response)})}else{var me=this;Ext.Ajax.request({url:this.getTromboneUrl(),params:{tool:"resource.StoredResource",storeResource:Ext.encode(config)},scope:this}).then(function(response){var data=Ext.JSON.decode(response.responseText);if(data&&data.storedResource&&data.storedResource.id){me.setApiParam("overridesId",data.storedResource.id);me.reloadFilters()}else me.showResponseError(me.localize("overidesRetrieveError"),
response)},function(response){me.showResponseError(me.localize("overidesStorageError"),response)})}}});
Ext.define("Voyant.widget.GeonamesFilter",{extend:"Ext.Button",xtype:"geonamesfilter",mixins:["Voyant.util.Localization"],statics:{i18n:{filter:"Filter",authorLabel:"authors",titleLabel:"titles",keywordLabel:"full text",pubDateLabel:"dates",loading:"Loading geographical information\u2026",disclaimer:"This is an experimental tool and the accuracy of the data is variable (\x3ca href\x3d'{url}' target\x3d'_blank'\x3esee help\x3c/a\x3e).",noDataForField:"No data seems to be available for this field so it will be disabled.",
close:"Close"}},config:{corpus:undefined,geonames:undefined,color:"#f00",timeout:undefined,currentConnectionOccurrence:undefined,animationLayer:undefined,millisPerAnimation:2E3,stepByStepMode:false,keepAnimationInFrame:false},constructor:function(config){config=config||{};var geonames=new Voyant.data.util.Geonames({corpus:config.corpus});this.setGeonames(geonames);var me=this;Ext.applyIf(config,{tooltip:this.localize("filterTip"),style:"background-color: white; color: "+config.color,glyph:"xf0b0@FontAwesome",
menu:{defaults:{xtype:"querysearchfield",labelWidth:60,labelAlign:"right",width:250,maxWidth:250,padding:2,listeners:{change:function(cmp,vals){me.loadGeonames()},load:function(store,records,success,operation){if(records.length==0&&operation.getParams().query==""){Ext.Msg.show({buttonText:{ok:me.localize("close")},icon:Ext.MessageBox.INFO,message:me.localize("noDataForField"),buttons:Ext.Msg.OK});this.disable()}}}},items:[{fieldLabel:this.localize("authorLabel"),tokenType:"author",itemId:"author"},
{fieldLabel:this.localize("titleLabel"),itemId:"title",tokenType:"title"},{fieldLabel:this.localize("keywordLabel")},{xtype:"multislider",fieldLabel:this.localize("pubDateLabel"),itemId:"pubDate",tokenType:"pubDate",values:[0,1],hidden:true,listeners:{afterrender:function(cmp){this.getCorpus().getCorpusTerms().load({params:{tokenType:"pubDate",limit:1,sort:"TERMASC"},callback:function(records){if(records.length==0){var vals=[];this.getCorpus().each(function(doc){var val=parseInt(doc.getTitle());if(isNaN(val)==
false)vals.push(parseInt(doc.getTitle()))},this);if(vals.length>1){cmp.setMinValue(vals[0]);cmp.setMaxValue(vals[vals.length-1]);cmp.tokenType="title";cmp.suspendEvent("changecomplete");cmp.setValue([vals[0],vals[vals.length-1]]);cmp.resumeEvent("changecomplete");cmp.setVisible(true)}}else{cmp.setMinValue(parseInt(records[0].getTerm()));this.getCorpus().getCorpusTerms().load({params:{tokenType:"pubDate",limit:1,sort:"TERMDESC"},callback:function(records){cmp.setMaxValue(parseInt(records[0].getTerm())),
cmp.setVisible(true)},scope:this})}},scope:this})},changecomplete:function(cmp,newVal){this.loadGeonames()},scope:this}},{xtype:"fieldset",title:"Animation",items:[{xtype:"container",layout:"hbox",defaults:{xtype:"button",text:"",ui:"default-toolbar"},items:[{glyph:"xf048@FontAwesome",handler:function(){this.getAnimationLayer().getSource().clear();this.clearAnimation();var currentConnectionOccurrence=this.getCurrentConnectionOccurrence();currentConnectionOccurrence=this.getGeonames().getConnectionOccurrence(currentConnectionOccurrence?
currentConnectionOccurrence.index-1:0);this.setCurrentConnectionOccurrence(currentConnectionOccurrence);this.animate()},scope:this},{glyph:"xf04c@FontAwesome",handler:function(cmp){if(cmp.getGlyph().glyphConfig=="xf04b@FontAwesome"){this.clearAnimation();cmp.setGlyph(new Ext.Glyph("xf04c@FontAwesome"));this.setStepByStepMode(false);this.animate()}else{cmp.setGlyph(new Ext.Glyph("xf04b@FontAwesome"));this.setStepByStepMode(true)}},scope:this},{glyph:"xf051@FontAwesome",handler:function(){this.getAnimationLayer().getSource().clear();
this.clearAnimation();var currentConnectionOccurrence=this.getCurrentConnectionOccurrence();currentConnectionOccurrence=this.getGeonames().getConnectionOccurrence(currentConnectionOccurrence?currentConnectionOccurrence.index+1:0);this.setCurrentConnectionOccurrence(currentConnectionOccurrence);this.animate()},scope:this},{xtype:"tbtext",text:"\x26nbsp;\x26nbsp;"},{glyph:"xf01e@FontAwesome",handler:function(){this.getAnimationLayer().getSource().clear();this.clearAnimation();this.setCurrentConnectionOccurrence(this.getGeonames().getConnectionOccurrence(0));
this.animate()},scope:this}]},{xtype:"checkbox",checked:false,handler:function(item,checked){me.setKeepAnimationInFrame(checked)},boxLabel:"Keep animation in frame"}]},{xtype:"container",text:"\x26nbsp;"},{xtype:"button",text:"remove",scope:this,handler:function(cmp){this.fireEvent("removeFilterWidget",this);cmp.ownerCt.ownerCmp.destroy()}}]}});this.callParent([config]);this.on("afterrender",function(cmp){cmp.getTargetEl().down(".x-btn-glyph").setStyle("color",this.getColor());var panel=cmp.up("panel");
panel.mask(cmp.localize("loading"));cmp.loadGeonames().then(function(geonames){panel.unmask();if(panel.getFilterWidgets().getCount()==1){var currentCitiesCount=geonames.getCitiesCount(),totalCitiesCount=geonames.getTotalCitiesCount(),currentConnectionsCount=geonames.getConnectionsCount(),totalConnectionsCount=geonames.getTotalConnectionsCount();message=cmp.localize(currentCitiesCount==totalCitiesCount&&currentConnectionsCount==totalConnectionsCount?"loadedAll":"loadedSome")+"\x3cbr\x3e\x3cbr\x3e"+
cmp.localize("disclaimer");panel.toastInfo({autoCloseDelay:5E3,closable:true,maxWidth:"90%",html:(new Ext.Template(cmp.localize("disclaimer"))).apply({currentCitiesCount:currentCitiesCount,totalCitiesCount:totalCitiesCount,currentConnectionsCount:currentConnectionsCount,totalConnectionsCount:totalConnectionsCount,url:panel.getBaseUrl()+"docs/#!/guide/dreamscape"})})}})},this)},loadGeonames:function(params){var me=this;params=params||{};var queries=[];this.query("querysearchfield").forEach(function(querysearchfield){var id=
querysearchfield.getItemId();querysearchfield.getValue().forEach(function(query){queries.push(id+":"+query)})});var pubDateSlider=this.down("multislider");if(pubDateSlider&&pubDateSlider.isVisible()){var vals=pubDateSlider.getValue();queries.push(pubDateSlider.tokenType+":["+vals[0]+"-"+vals[1]+"]")}if(queries.length>0&&!("query"in params))params.query=queries;var panel=this.up("panel");if(panel&&panel.getApiParams)Ext.applyIf(params,panel.getApiParams(["minPopulation","connectionsMaxCount","connectionsMinFreq",
"source","overridesId","filterHasLowerCaseForm","filterIsPersonName","preferredCoordinates"]));this.mask("\u2026");var geonames=this.getGeonames();return geonames.load(params).then(function(){me.unmask();me.fireEvent("filterUpdate",me,geonames);return geonames})},clearAnimation:function(){if(this.getTimeout())clearTimeout(this.getTimeout())},animate:function(){var panel=this.up("panel");if(!panel)return;this.clearAnimation();var currentConnectionOccurrence=this.getCurrentConnectionOccurrence();if(currentConnectionOccurrence){var animationLayer=
this.getAnimationLayer();if(!animationLayer){animationLayer=this.up("panel").getMap().getLayer(this.getId()+"-animation");this.setAnimationLayer(animationLayer)}if(animationLayer){var features=animationLayer.getSource().getFeatures();if(features.length==0){if(!panel)return;var connectionsLayerSource=panel.getMap().getLayer(this.getId()+"-connections").getSource();var connectionsFeatures=connectionsLayerSource.getFeatures();var hasMatch=false;for(var i=0,len=connectionsFeatures.length;i<len;i++)if(currentConnectionOccurrence.source.id==
connectionsFeatures[i].get("source")&&currentConnectionOccurrence.target.id==connectionsFeatures[i].get("target")){hasMatch=connectionsFeatures[i];break}if(hasMatch){if(this.getKeepAnimationInFrame()){var map=panel.getMap();var extent=panel.getMap().getView().calculateExtent(map.getSize());var isVisible=ol.extent.containsExtent(extent,hasMatch.getGeometry().getExtent());if(!isVisible){newExtent=ol.extent.extend(extent,hasMatch.getGeometry().getExtent());map.getView().fit(newExtent)}}var arcGenerator=
new arc.GreatCircle({x:currentConnectionOccurrence.source.lng,y:currentConnectionOccurrence.source.lat},{x:currentConnectionOccurrence.target.lng,y:currentConnectionOccurrence.target.lat});var arcLine=arcGenerator.Arc(100,{offset:100});var label=currentConnectionOccurrence.source.label+" -\x3e "+currentConnectionOccurrence.target.label;arcLine.geometries.forEach(function(geometry){var line=new ol.geom.LineString([]);line.transform(ol.proj.get("EPSG:4326"),panel.getProjection()?panel.getProjection():
ol.proj.get("EPSG:3857"));var feature=new ol.Feature({geometry:line,allcoords:geometry.coords,text:label,color:this.getColor(),width:5,start:(new Date).getTime()});animationLayer.getSource().addFeature(feature)},this);var ticker=panel.body.down(".ticker");panel.body.down(".ticker").setHtml(currentConnectionOccurrence.source.left+" \x3cspan class\x3d'keyword'\x3e"+currentConnectionOccurrence.source.term+"\x3c/span\x3e "+currentConnectionOccurrence.source.right+" \u2026 "+currentConnectionOccurrence.target.left+
" \x3cspan class\x3d'keyword'\x3e"+currentConnectionOccurrence.target.term+"\x3c/span\x3e "+currentConnectionOccurrence.target.right);return this.setTimeout(setTimeout(this.animate.bind(this),1))}else{if(!this.getGeonames())return;currentConnectionOccurrence=this.getGeonames().getConnectionOccurrence(currentConnectionOccurrence.index+1);this.setCurrentConnectionOccurrence(currentConnectionOccurrence);animationLayer.getSource().clear();return this.setTimeout(setTimeout(this.animate.bind(this),1))}}else if(features.length>
0){var coords=features[0].getGeometry().getCoordinates(),allcoords=features[0].get("allcoords");if(coords.length<allcoords.length){var elapsed=(new Date).getTime()-features[0].get("start"),len=elapsed*allcoords.length/this.getMillisPerAnimation();line=new ol.geom.LineString(allcoords.slice(0,len));line.transform(ol.proj.get("EPSG:4326"),panel.getProjection()?panel.getProjection():ol.proj.get("EPSG:3857"));features[0].set("geometry",line);return this.setTimeout(setTimeout(this.animate.bind(this),25))}currentConnectionOccurrence=
this.getGeonames().getConnectionOccurrence(currentConnectionOccurrence.index+1);if(!this.getStepByStepMode()){this.setCurrentConnectionOccurrence(currentConnectionOccurrence);animationLayer.getSource().clear();return this.setTimeout(setTimeout(this.animate.bind(this),1))}}}}else{if(!this.getGeonames())return;currentConnectionOccurrence=this.getGeonames().getConnectionOccurrence(0);if(currentConnectionOccurrence){this.setCurrentConnectionOccurrence(currentConnectionOccurrence);return this.setTimeout(setTimeout(this.animate.bind(this),
1))}}}});Ext.define("Voyant.panel.Knots",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.knots",statics:{i18n:{},api:{query:null,stopList:"auto",docId:undefined,audio:false},glyph:"xf06e@FontAwesome"},config:{knots:undefined,termStore:undefined,docTermStore:undefined,tokensStore:undefined,options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"},{xtype:"colorpaletteoption"}],refreshInterval:100,startAngle:315,angleIncrement:15,currentTerm:undefined},termTpl:new Ext.XTemplate('\x3ctpl for\x3d"."\x3e',
'\x3cdiv class\x3d"term" style\x3d"color: rgb({color});float: left;padding: 3px;margin: 2px;"\x3e{term}\x3c/div\x3e',"\x3c/tpl\x3e"),constructor:function(){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("loadedCorpus",function(src,corpus){var firstDoc=corpus.getDocument(0);var pDoc=this.processDocument(firstDoc);this.getKnots().setCurrentDoc(pDoc);this.setApiParams({docId:firstDoc.getId()});this.getDocTermStore().getProxy().setExtraParam("corpus",
corpus.getId());this.getTokensStore().setCorpus(corpus);this.getDocTermStore().load({params:{limit:5,stopList:this.getApiParams("stopList")}})},this);this.on("activate",function(){if(this.getCorpus())Ext.Function.defer(function(){this.getDocTermStore().load({params:{limit:5,stopList:this.getApiParams("stopList")}})},100,this)},this);this.on("query",function(src,query){if(query!==undefined&&query!="")this.getDocTermsFromQuery(query)},this);this.on("documentSelected",function(src,doc){var document=
this.getCorpus().getDocument(doc);this.setApiParam("docId",document.getId());var terms=this.getKnots().currentDoc.terms;var termsToKeep=[];for(var t in terms)termsToKeep.push(t);this.setApiParams({query:termsToKeep});var limit=termsToKeep.length;if(limit===0)limit=5;this.getKnots().setCurrentDoc(this.processDocument(document));this.getDocTermStore().load({params:{query:termsToKeep,limit:limit,stopList:this.getApiParams("stopList")}})},this);this.on("termsClicked",function(src,terms){var queryTerms=
[];terms.forEach(function(term){if(Ext.isString(term))queryTerms.push(term);else if(term.term)queryTerms.push(term.term);else if(term.getTerm)queryTerms.push(term.getTerm())});if(queryTerms.length>0)this.getDocTermsFromQuery(queryTerms)},this);this.on("corpusTermsClicked",function(src,terms){var queryTerms=[];terms.forEach(function(term){if(term.getTerm())queryTerms.push(term.getTerm())});this.getDocTermsFromQuery(queryTerms)},this);this.on("documentTermsClicked",function(src,terms){var queryTerms=
[];terms.forEach(function(term){if(term.getTerm())queryTerms.push(term.getTerm())});this.getDocTermsFromQuery(queryTerms)},this)},initComponent:function(){this.setTermStore(Ext.create("Ext.data.ArrayStore",{fields:["term","color"]}));this.setDocTermStore(Ext.create("Ext.data.Store",{model:"Voyant.data.model.DocumentTerm",autoLoad:false,remoteSort:false,proxy:{type:"ajax",url:Voyant.application.getTromboneUrl(),extraParams:{tool:"corpus.DocumentTerms",withDistributions:"raw",withPositions:true},reader:{type:"json",
rootProperty:"documentTerms.terms",totalProperty:"documentTerms.total"},simpleSortMode:true},listeners:{beforeload:function(store){store.getProxy().setExtraParam("docId",this.getApiParam("docId"))},load:function(store,records,successful,options){var termObj={};if(records&&records.length>0){records.forEach(function(record){var termData=this.processTerms(record);var docId=record.get("docId");var term=record.get("term");termObj[term]=termData},this);this.getKnots().addTerms(termObj);this.getKnots().buildGraph()}else this.toastInfo({html:this.localize("noTermsFound"),
align:"bl"})},scope:this}}));this.setTokensStore(Ext.create("Voyant.data.store.Tokens",{stripTags:"all",listeners:{beforeload:function(store){store.getProxy().setExtraParam("docId",this.getApiParam("docId"))},load:function(store,records,successful,options){var context="";var currTerm=this.getCurrentTerm();records.forEach(function(record){if(record.getPosition()==currTerm.tokenId)context+="\x3cstrong\x3e"+record.getTerm()+"\x3c/strong\x3e";else context+=record.getTerm()});Ext.Msg.show({title:this.localize("context"),
message:context,buttons:Ext.Msg.OK,icon:Ext.Msg.INFO})},scope:this}}));Ext.apply(this,{title:this.localize("title"),dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{xtype:"querysearchfield"},{text:this.localize("clearTerms"),glyph:"xf00d@FontAwesome",handler:function(){this.down("#termsView").getSelectionModel().deselectAll(true);this.getTermStore().removeAll();this.setApiParams({query:null});this.getKnots().removeAllTerms();this.getKnots().drawGraph()},scope:this},{xtype:"documentselectorbutton",
singleSelect:true},{xtype:"slider",itemId:"speed",fieldLabel:this.localize("speed"),labelAlign:"right",labelWidth:50,width:100,increment:50,minValue:0,maxValue:500,value:500-this.getRefreshInterval(),listeners:{changecomplete:function(slider,newvalue){this.setRefreshInterval(500-newvalue);if(this.getKnots())this.getKnots().buildGraph()},scope:this}},{xtype:"slider",itemId:"startAngle",fieldLabel:this.localize("startAngle"),labelAlign:"right",labelWidth:35,width:85,increment:15,minValue:0,maxValue:360,
value:this.getStartAngle(),listeners:{changecomplete:function(slider,newvalue){this.setStartAngle(newvalue);if(this.getKnots())this.getKnots().buildGraph()},scope:this}},{xtype:"slider",itemId:"tangles",fieldLabel:this.localize("tangles"),labelAlign:"right",labelWidth:30,width:80,increment:5,minValue:5,maxValue:90,value:this.getAngleIncrement(),listeners:{changecomplete:function(slider,newvalue){this.setAngleIncrement(newvalue);if(this.getKnots())this.getKnots().buildGraph()},scope:this}},{xtype:"checkbox",
boxLabel:this.localize("sound"),listeners:{render:function(cmp){cmp.setValue(this.getApiParam("audio")===true||this.getApiParam("audio")=="true");Ext.tip.QuickTipManager.register({target:cmp.getEl(),text:this.localize("soundTip")})},beforedestroy:function(cmp){Ext.tip.QuickTipManager.unregister(cmp.getEl())},change:function(cmp,val){if(this.getKnots())this.getKnots().setAudio(val)},scope:this}}]}],border:false,layout:"fit",items:{layout:{type:"vbox",align:"stretch"},defaults:{border:false},items:[{height:30,
itemId:"termsView",xtype:"dataview",store:this.getTermStore(),tpl:this.termTpl,itemSelector:"div.term",overItemCls:"over",selectedItemCls:"selected",selectionModel:{mode:"SIMPLE"},focusCls:"",listeners:{beforeitemclick:function(dv,record,item,index,event,opts){event.preventDefault();event.stopPropagation();dv.fireEvent("itemcontextmenu",dv,record,item,index,event,opts);return false},beforecontainerclick:function(){event.preventDefault();event.stopPropagation();return false},selectionchange:function(selModel,
selections){var dv=this.down("#termsView");var terms=[];dv.getStore().each(function(r){if(selections.indexOf(r)!==-1){terms.push(r.get("term"));Ext.fly(dv.getNodeByRecord(r)).removeCls("unselected").addCls("selected")}else Ext.fly(dv.getNodeByRecord(r)).removeCls("selected").addCls("unselected")});this.getKnots().termsFilter=terms;this.getKnots().drawGraph()},itemcontextmenu:function(dv,record,el,index,event){event.preventDefault();event.stopPropagation();var isSelected=dv.isSelected(el);var menu=
new Ext.menu.Menu({floating:true,items:[{text:isSelected?this.localize("hideTerm"):this.localize("showTerm"),handler:function(){if(isSelected)dv.deselect(index);else dv.select(index,true)},scope:this},{text:this.localize("removeTerm"),handler:function(){dv.deselect(index);var term=this.getTermStore().getAt(index).get("term");this.getTermStore().removeAt(index);dv.refresh();this.getKnots().removeTerm(term);this.getKnots().drawGraph()},scope:this}]});menu.showAt(event.getXY())},scope:this}},{flex:1,
xtype:"container",autoEl:"div",itemId:"canvasParent",layout:"fit",overflowY:"auto",overflowX:"hidden"}],listeners:{render:function(component){var canvasParent=this.down("#canvasParent");this.setKnots(new Knots({container:canvasParent,clickHandler:this.knotClickHandler.bind(this),audio:this.getApiParam("audio")===true||this.getApiParam("audio")=="true"}))},afterlayout:function(container){if(this.getKnots().initialized===false)this.getKnots().initializeCanvas()},resize:function(cnt,width,height){this.getKnots().doLayout()},
scope:this}}});this.callParent(arguments)},updateRefreshInterval:function(value){if(this.getKnots()){if(value<50){value=50;this.getKnots().progressiveDraw=false}else this.getKnots().progressiveDraw=true;this.getKnots().refreshInterval=value;this.getKnots().buildGraph(this.getKnots().drawStep)}},updateStartAngle:function(value){if(this.getKnots()){this.getKnots().startAngle=value;this.getKnots().recache();this.getKnots().buildGraph()}},updateAngleIncrement:function(value){if(this.getKnots()){this.getKnots().angleIncrement=
value;this.getKnots().recache();this.getKnots().buildGraph()}},loadFromCorpusTerms:function(corpusTerms){if(this.getKnots()){this.getKnots().removeAllTerms();this.getTermStore().removeAll(true)}corpusTerms.load({callback:function(records,operation,success){var query=[];if(typeof query=="string")query=[query];records.forEach(function(record,index){query.push(record.get("term"))},this);this.getDocTermsFromQuery(query)},scope:this,params:{limit:5,stopList:this.getApiParams("stopList")}})},getDocTermsFromQuery:function(query){if(query)this.setApiParam("query",
query);var corpus=this.getCorpus();if(corpus&&this.isVisible()){this.setApiParams({query:query});this.getDocTermStore().load({params:this.getApiParams()})}},reloadTermsData:function(){var terms=[];for(var term in this.bubblelines.currentTerms)terms.push(term);this.getDocTermsFromQuery(terms)},filterDocuments:function(){var docIds=this.getApiParam("docId");if(docIds==""){docIds=[];this.getCorpus().getDocuments().each(function(item,index){docIds.push(item.getId())});this.setApiParams({docId:docIds})}if(typeof docIds==
"string")docIds=[docIds];if(docIds==null){this.selectedDocs=this.getCorpus().getDocuments().clone();var count=this.selectedDocs.getCount();if(count>10)for(var i=10;i<count;i++)this.selectedDocs.removeAt(10);docIds=[];this.selectedDocs.eachKey(function(docId,doc){docIds.push(docId)},this);this.setApiParams({docId:docIds})}else this.selectedDocs=this.getCorpus().getDocuments().filterBy(function(doc,docId){return docIds.indexOf(docId)!=-1},this)},processDocument:function(doc){var title=doc.getShortTitle();
title=title.replace("\x26hellip;","...");return{id:doc.getId(),index:doc.get("index"),title:title,totalTokens:doc.get("tokensCount-lexical"),terms:{},lineLength:undefined}},processTerms:function(termRecord){var termObj;var term=termRecord.get("term");var rawFreq=termRecord.get("rawFreq");var positions=termRecord.get("positions");if(rawFreq>0){var color=this.getApplication().getColorForTerm(term);if(this.getTermStore().find("term",term)===-1){this.getTermStore().loadData([[term,color]],true);var index=
this.getTermStore().find("term",term);this.down("#termsView").select(index,true)}var distributions=termRecord.get("distributions");termObj={term:term,positions:positions,distributions:distributions,rawFreq:rawFreq,color:color}}else termObj=false;return termObj},knotClickHandler:function(data){this.setCurrentTerm(data);var start=data.tokenId-10;if(start<0)start=0;this.getTokensStore().load({start:start,limit:21});data=[data].map(function(item){return item.term});this.getApplication().dispatchEvent("termsClicked",
this,data)}});Ext.define("Voyant.panel.Phrases",{extend:"Ext.grid.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.phrases",isConsumptive:true,statics:{i18n:{},api:{stopList:"auto",query:undefined,docId:undefined,docIndex:undefined,sort:"length",dir:"desc",minLength:2,maxLength:50,overlapFilter:"length"},glyph:"xf0ce@FontAwesome"},config:{options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"}]},constructor:function(config){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,
arguments);this.on("loadedCorpus",function(src,corpus){if(this.isVisible())if(this.hasCorpusAccess(corpus)==false)this.mask(this.localize("limitedAccess"),"mask-no-spinner");else this.loadFromApis()});if(config.embedded);else if(config.corpus)this.fireEvent("loadedCorpus",this,config.corpus);this.on("corpusTermsClicked",function(src,terms){if(this.getStore().getCorpus()){var query=[];terms.forEach(function(term){query.push(term.get("term"))});this.setApiParams({query:query,docId:undefined,docIndex:undefined});
if(this.isVisible())this.getStore().load({params:this.getApiParams()})}});this.on("activate",function(){if(this.getStore().getCorpus())this.loadFromApis()},this);this.on("query",function(src,query){this.setApiParam("query",query);this.getStore().getProxy().setExtraParam("query",query);this.loadFromApis()},this)},loadFromApis:function(){if(this.getStore().getCorpus())this.getStore().load({params:this.getApiParams()})},initComponent:function(){var me=this;var store=Ext.create("Voyant.data.store.CorpusNgramsBuffered",
{parentPanel:me});store.on("beforeload",function(store){return me.hasCorpusAccess(store.getCorpus())});me.on("sortchange",function(ct,column,direction,eOpts){this.setApiParam("sort",column.dataIndex);this.setApiParam("dir",direction);var api=this.getApiParams(["stopList","query","docId","docIndex","sort","dir","minLength","maxLength","overlapFilter"]);var proxy=this.getStore().getProxy();for(var key in api)proxy.setExtraParam(key,api[key])},me);Ext.apply(me,{title:this.localize("title"),emptyText:this.localize("emptyText"),
store:store,selModel:Ext.create("Ext.selection.CheckboxModel",{listeners:{selectionchange:{fn:function(sm,selections){var terms=[];var context=this.getApiParam("context");selections.forEach(function(selection){terms.push('"'+selection.getTerm()+'"')});this.getApplication().dispatchEvent("termsClicked",this,terms)},scope:this}}}),dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{xtype:"querysearchfield"},{xtype:"totalpropertystatus"},"-",{text:me.localize("length"),tooltip:"test",
xtype:"label"},{xtype:"slider",minValue:2,values:[2,30],maxValue:30,increment:1,width:75,tooltip:this.localize("lengthTip"),listeners:{render:{fn:function(slider){var values=slider.getValues();slider.setValue(0,parseInt(this.getApiParam("minLength",values[0])));slider.setValue(1,parseInt(this.getApiParam("maxLength",values[1])))},scope:me},changecomplete:{fn:function(slider,newValue){var values=slider.getValues();this.setApiParam("minLength",parseInt(values[0]));this.setApiParam("maxLength",parseInt(values[1]));
this.getStore().load({params:this.getApiParams()})},scope:me}}},{xtype:"corpusdocumentselector"},"-",{xtype:"button",text:this.localize("overlap"),tooltip:this.localize("overlapTip"),menu:{items:[{xtype:"menucheckitem",text:this.localize("overlapNone"),group:"overlap",inputValue:"none",checkHandler:function(){this.setApiParam("overlapFilter","none");this.getStore().load({params:this.getApiParams()})},scope:this},{xtype:"menucheckitem",text:this.localize("overlapLength"),group:"overlap",inputValue:"length",
checkHandler:function(){this.setApiParam("overlapFilter","length");this.getStore().load({params:this.getApiParams()})},scope:this},{xtype:"menucheckitem",text:this.localize("overlapFreq"),group:"overlap",inputValue:"rawFreq",checkHandler:function(){this.setApiParam("overlapFilter","rawfreq");this.getStore().load({params:this.getApiParams()})},scope:this}],listeners:{afterrender:{fn:function(menu){var overlapFilter=this.getApiParam("overlapFilter");menu.items.each(function(item){if(item.group)item.setChecked(item.inputValue==
overlapFilter)},this)},scope:this}}}}]}],columns:[{text:this.localize("term"),dataIndex:"term",tooltip:this.localize("termTip"),sortable:true,flex:1},{text:this.localize("rawFreq"),dataIndex:"rawFreq",tooltip:this.localize("termRawFreqTip"),sortable:true,width:"autoSize"},{text:this.localize("length"),dataIndex:"length",tooltip:this.localize("lengthTip"),sortable:true,width:"autoSize"},{xtype:"widgetcolumn",text:this.localize("trend"),tooltip:this.localize("trendTip"),width:120,dataIndex:"distributions",
widget:{xtype:"sparklineline"}}],listeners:{corpusSelected:function(){this.setApiParams({docIndex:undefined,docId:undefined});this.loadFromApis()},documentsSelected:function(src,docs){var docIds=[];var corpus=this.getStore().getCorpus();docs.forEach(function(doc){docIds.push(corpus.getDocument(doc).getId())},this);this.setApiParams({docId:docIds,docIndex:undefined});this.loadFromApis()},termsClicked:{fn:function(src,terms){if(this.getStore().getCorpus()){var queryTerms=[];terms.forEach(function(term){if(Ext.isString(term))queryTerms.push(term);
else if(term.term)queryTerms.push(term.term);else if(term.getTerm)queryTerms.push(term.getTerm())});if(queryTerms.length>0){this.setApiParams({docIndex:undefined,docId:undefined,query:queryTerms});if(this.isVisible())if(this.isVisible())this.getStore().clearAndLoad({params:this.getApiParams()})}}},scope:this}}});me.callParent(arguments);me.getStore().getProxy().setExtraParam("withDistributions",true)}});Ext.define("Voyant.panel.CorpusTerms",{extend:"Ext.grid.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.corpusterms",statics:{i18n:{},api:{stopList:"auto",query:undefined,maxBins:100,comparisonCorpus:undefined},glyph:"xf0ce@FontAwesome"},config:{options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"},{xtype:"corpusselector",name:"comparisonCorpus",fieldLabel:"comparison corpus"}]},constructor:function(config){this.mixins["Voyant.util.Api"].constructor.apply(this,arguments);this.callParent(arguments);
this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},initComponent:function(){var me=this;var store=Ext.create("Voyant.data.store.CorpusTermsBuffered",{parentPanel:this,proxy:{extraParams:{withDistributions:"relative",forTool:"corpusterms"}}});Ext.apply(me,{title:this.localize("title"),emptyText:this.localize("emptyText"),store:store,selModel:Ext.create("Ext.selection.CheckboxModel",{pruneRemoved:false,listeners:{selectionchange:{fn:function(sm,selections){if(selections&&selections.length>
0)this.getApplication().dispatchEvent("corpusTermsClicked",this,selections)},scope:this}},mode:"SIMPLE"}),dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{xtype:"querysearchfield"},{xtype:"totalpropertystatus"}]}],plugins:[{ptype:"rowexpander",rowBodyTpl:new Ext.XTemplate("")}],viewConfig:{listeners:{expandbody:function(rowNode,record,expandRow,eOpts){if(expandRow.textContent===""||eOpts&&eOpts.force)Ext.create("Voyant.widget.CorpusTermSummary",{record:record,header:false,
renderTo:expandRow.querySelector("div")})},scope:this}},columns:[{xtype:"rownumberer",width:"autoSize",sortable:false},{text:this.localize("term"),tooltip:this.localize("termTip"),dataIndex:"term",flex:1,sortable:true},{text:this.localize("rawFreq"),tooltip:this.localize("rawFreqTip"),dataIndex:"rawFreq",width:"autoSize",sortable:true},{text:this.localize("relativeFreq"),tooltip:this.localize("relativeFreqTip"),dataIndex:"relativeFreq",renderer:function(val){var percent=val*100;return Ext.util.Format.number(val*
1E6,"0,000")},width:"autoSize",hidden:true,sortable:true},{text:this.localize("relativePeakedness"),tooltip:this.localize("relativePeakednessTip"),dataIndex:"relativePeakedness",renderer:Ext.util.Format.numberRenderer("0,000.0"),width:"autoSize",hidden:true,sortable:true},{text:this.localize("relativeSkewness"),tooltip:this.localize("relativeSkewnessTip"),dataIndex:"relativeSkewness",renderer:Ext.util.Format.numberRenderer("0,000.0"),width:"autoSize",hidden:true,sortable:true},{text:this.localize("corpusComparisonDifference"),
tooltip:this.localize("corpusComparisonDifferenceTip"),dataIndex:"comparisonRelativeFreqDifference",renderer:Ext.util.Format.numberRenderer("0,000.00000"),width:"autoSize",hidden:!this.getApiParam("comparisonCorpus"),sortable:true,listeners:{show:function(ct,column,eopts){if(!me.getApiParam("comparisonCorpus"))me.showError(me.localize("noCorpusComparison"))}}},{xtype:"widgetcolumn",text:this.localize("trend"),tooltip:this.localize("trendTip"),flex:1,dataIndex:"distributions",widget:{xtype:"sparklineline",
tipTpl:new Ext.XTemplate("{[this.getDocumentTitle(values.x,values.y)]}",{getDocumentTitle:function(docIndex,relativeFreq){return this.panel.store.getCorpus().getDocument(docIndex).getTitle()+"\x3cbr\x3e"+this.panel.localize("relativeFreqLabel")+" "+Ext.util.Format.number(relativeFreq*1E6,"0,000")},panel:me})}}]});me.on("loadedCorpus",function(src,corpus){if(corpus.getDocumentsCount()>100)this.getStore().getProxy().setExtraParam("bins",this.getApiParam("maxBins"));if(this.isVisible())this.getStore().load()},
me);me.on("activate",function(){if(me.getStore().getCorpus())me.getStore().load({params:this.getApiParams()})},me);me.on("query",function(src,query){this.setApiParam("query",query);this.getStore().removeAll();this.getStore().load()},me);me.callParent(arguments)}});Ext.define("Voyant.panel.DocumentTerms",{extend:"Ext.grid.Panel",mixins:["Voyant.panel.Panel"],requires:["Voyant.data.store.DocumentTerms"],alias:"widget.documentterms",config:{options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"}]},statics:{i18n:{},api:{stopList:"auto",query:undefined,docId:undefined,docIndex:undefined,bins:10},glyph:"xf0ce@FontAwesome"},constructor:function(config){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("loadedCorpus",
function(src,corpus){var store=this.getStore();store.setCorpus(corpus);if(this.isVisible())store.load()});if(config.embedded){if(window.console)console.warn(config.embedded.then);var cls=Ext.getClass(config.embedded).getName();if(cls=="Voyant.data.store.DocumentTerms"||cls=="Voyant.data.model.Document")this.fireEvent("loadedCorpus",this,config.embedded.getCorpus())}else if(config.corpus)this.fireEvent("loadedCorpus",this,config.corpus);this.on("query",function(src,query){this.fireEvent("corpusTermsClicked",
src,query)},this);this.on("corpusTermsClicked",function(src,terms){if(this.getStore().getCorpus()){var query=[];terms.forEach(function(term){query.push(Ext.isString(term)?term:term.get("term"))});this.setApiParams({query:query,docId:undefined,docIndex:undefined});if(this.isVisible())this.getStore().load({params:this.getApiParams()})}});this.on("documentsClicked",function(src,documents){var docIds=[];documents.forEach(function(doc){docIds.push(doc.get("id"))});this.setApiParams({docId:docIds,query:undefined});
if(this.isVisible())this.getStore().load({params:this.getApiParams()})});this.on("activate",function(){if(this.getStore().getCorpus())this.getStore().load({params:this.getApiParams()})},this)},initComponent:function(){var me=this;var store=Ext.create("Voyant.data.store.DocumentTermsBuffered",{parentPanel:this});Ext.apply(me,{title:this.localize("title"),emptyText:this.localize("emptyText"),store:store,selModel:Ext.create("Ext.selection.CheckboxModel",{listeners:{selectionchange:{fn:function(sm,selections){this.getApplication().dispatchEvent("documentTermsClicked",
this,selections)},scope:this}},pruneRemoved:false,mode:"SIMPLE"}),dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{xtype:"querysearchfield"},{xtype:"totalpropertystatus"},{xtype:"corpusdocumentselector"}]}],columns:[{text:"#",width:30,dataIndex:"docIndex",sortable:true,renderer:function(v){return v+1}},{text:this.localize("term"),dataIndex:"term",tooltip:this.localize("termTip"),sortable:true,flex:1},{text:this.localize("rawFreq"),dataIndex:"rawFreq",tooltip:this.localize("rawFreqTip"),
width:"autoSize",sortable:true},{text:this.localize("relativeFreq"),tooltip:this.localize("relativeFreqTip"),dataIndex:"relativeFreq",width:"autoSize",sortable:true,renderer:Ext.util.Format.numberRenderer("0,000")},{text:this.localize("tfidf"),tooltip:this.localize("tfidfTip"),dataIndex:"tfidf",width:"autoSize",sortable:true,hidden:true,renderer:Ext.util.Format.numberRenderer("0,000.000")},{text:this.localize("zscore"),tooltip:this.localize("zscoreTip"),dataIndex:"zscore",width:"autoSize",sortable:true,
hidden:true,renderer:Ext.util.Format.numberRenderer("0,000.000")},{xtype:"widgetcolumn",text:this.localize("trend"),tooltip:this.localize("trendTip"),flex:1,dataIndex:"distributions",widget:{xtype:"sparklineline"}}],listeners:{termsClicked:{fn:function(src,terms){if(this.getStore().getCorpus()){var queryTerms=[];terms.forEach(function(term){if(Ext.isString(term))queryTerms.push(term);else if(term.term)queryTerms.push(term.term);else if(term.getTerm)queryTerms.push(term.getTerm())});if(queryTerms.length>
0){this.setApiParams({docIndex:undefined,docId:undefined,query:queryTerms});if(this.isVisible())if(this.isVisible())this.getStore().load({params:this.getApiParams()})}}},scope:this}}});me.callParent(arguments);me.getStore().getProxy().setExtraParam("withDistributions",true)}});Ext.define("Voyant.panel.Documents",{extend:"Ext.grid.Panel",mixins:["Voyant.panel.Panel","Voyant.util.Downloadable"],alias:"widget.documents",isConsumptive:true,statics:{i18n:{},api:{query:undefined,docIndex:undefined,docId:undefined},glyph:"xf0ce@FontAwesome"},MODE_EDITING:"editing",MODE_NORMAL:"normal",config:{options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"}],mode:this.MODE_NORMAL},constructor:function(config){var store=Ext.create("Voyant.data.store.Documents",{selModel:{pruneRemoved:false},
proxy:{extraParams:{forTool:"documents"}}});var dockedItemsItems=[{xtype:"querysearchfield"},{xtype:"totalpropertystatus"}];var me=this;if(!config||config.mode!=this.MODE_EDITING)dockedItemsItems.push({text:this.localize("modify"),tooltip:this.localize("modifyTip"),glyph:"xf044@FontAwesome",scope:this,itemId:"modifyButton",handler:function(btn){var win=Ext.create("Ext.window.Window",{title:this.localize("title"),modal:true,width:"80%",minWidth:300,minHeight:200,height:"80%",layout:"fit",frame:true,
border:true,items:{xtype:"documents",mode:this.MODE_EDITING,corpus:this.getStore().getCorpus(),header:false,viewConfig:{plugins:{ptype:"gridviewdragdrop"},listeners:{beforedrop:function(node,data,overModel,dropPosition,dropHandlers){if(this.getStore().getCount()<this.getStore().getCorpus().getDocumentsCount()){var panel=this.up("panel");Ext.Msg.show({title:panel.localize("error"),message:panel.localize("reorderFilteredError"),buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR});return false}return true}}}},buttons:[{text:this.localize("add"),
tooltip:this.localize("addTip"),glyph:"xf067@FontAwesome",handler:function(btn){btn.up("window").close();Ext.create("Ext.window.Window",{header:false,modal:true,layout:"fit",items:{xtype:"corpuscreator",corpus:this.getStore().getCorpus()}}).show()},scope:this},{text:this.localize("remove"),tooltip:this.localize("removeTip"),glyph:"xf05e@FontAwesome",hidden:this.getStore().getCorpus().getDocumentsCount()==1,handler:this.keepRemoveReorderHandler,itemId:"remove",scope:this},{text:this.localize("keep"),
tooltip:this.localize("keepTip"),glyph:"xf00c@FontAwesome",hidden:this.getStore().getCorpus().getDocumentsCount()==1,handler:this.keepRemoveReorderHandler,itemId:"keep",scope:this},{text:this.localize("reorder"),tooltip:this.localize("reorderTip"),glyph:"xf0dc@FontAwesome",hidden:this.getStore().getCorpus().getDocumentsCount()==1,handler:this.keepRemoveReorderHandler,itemId:"reorder",scope:this},{text:"Cancel",glyph:"xf00d@FontAwesome",handler:function(btn){btn.up("window").close()}}]}).show()}},
{text:this.localize("downloadButton"),glyph:"xf019@FontAwesome",itemId:"downloadButton",handler:function(){me.downloadFromCorpusId(me.getStore().getCorpus().getId())}});Ext.apply(this,{title:this.localize("title"),emptyText:this.localize("emptyText"),columns:[{xtype:"rownumberer",renderer:function(value,metaData,record){return record.getIndex()+1},sortable:false},{text:this.localize("documentTitle"),dataIndex:"title",sortable:true,renderer:function(val,metadata,record){return record.getTitle()},flex:3},
{text:this.localize("documentAuthor"),dataIndex:"author",sortable:true,hidden:true,renderer:function(val,metadata,record){return record.getAuthor()},flex:2},{text:this.localize("documentPubDate"),dataIndex:"pubDate",sortable:true,hidden:true,renderer:function(val,metadata,record){return record.getPubDate()},flex:2},{text:this.localize("documentPublisher"),dataIndex:"publisher",sortable:false,hidden:true,renderer:function(val,metadata,record){return record.getPublisher()},flex:2},{text:this.localize("documentPubPlace"),
dataIndex:"pubPlace",sortable:false,hidden:true,renderer:function(val,metadata,record){return record.getPubPlace()},flex:2},{text:this.localize("documentKeyword"),dataIndex:"keyword",sortable:false,hidden:true,renderer:function(val,metadata,record){return record.getKeyword()},flex:2},{text:this.localize("documentCollection"),dataIndex:"collection",sortable:false,hidden:true,renderer:function(val,metadata,record){return record.getCollection()},flex:2},{text:this.localize("tokensCountLexical"),dataIndex:"tokensCount-lexical",
renderer:Ext.util.Format.numberRenderer("0,000"),sortable:true,width:"autoSize"},{text:this.localize("typesCountLexical"),dataIndex:"typesCount-lexical",renderer:Ext.util.Format.numberRenderer("0,000"),width:"autoSize"},{text:this.localize("typeTokenRatioLexical"),dataIndex:"typeTokenRatio-lexical",renderer:function(val){return Ext.util.Format.percent(val)},width:"autoSize"},{text:this.localize("averageWordsPerSentence"),dataIndex:"averageWordsPerSentence",renderer:Ext.util.Format.numberRenderer("0,000.0"),
tooltip:this.localize("averageWordsPerSentenceTip"),width:"autoSize"},{text:this.localize("language"),dataIndex:"language",hidden:true,renderer:function(val,metaData,record,rowIndex,colIndex,store,view){return view.ownerCt.getLanguage(val)},width:"autoSize"}],store:store,selModel:{type:"rowmodel",mode:"MULTI",listeners:{selectionchange:{fn:function(sm,selections){this.getApplication().dispatchEvent("documentsClicked",this,selections,this.getStore().getCorpus())},scope:this}}},dockedItems:[{dock:"bottom",
xtype:"toolbar",overflowHandler:"scroller",items:dockedItemsItems}]});this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("loadedCorpus",function(src,corpus){this.store.setCorpus(corpus);if(this.isVisible())this.store.load({params:this.getApiParams()});else this.on("afterrender",function(){this.store.load({params:this.getApiParams()})},this);if(this.hasCorpusAccess(corpus)==false){this.queryById("modifyButton").hide();this.queryById("downloadButton").hide()}});
this.on("activate",function(){if(this.getStore().getCorpus())this.getStore().load({params:this.getApiParams()})},this);this.on("query",function(src,query){this.setApiParam("query",query);this.store.load({params:this.getApiParams()})});if(config.embedded)if(Ext.getClass(config.embedded).getName()=="Voyant.data.model.Corpus")config.corpus=config.embedded;else if(Ext.getClass(config.embedded).getName()=="Voyant.data.store.Documents"){this.store.setRecords(config.embedded.getData());config.corpus=config.embedded.getCorpus()}if(config.corpus)this.fireEvent("loadedCorpus",
this,config.corpus)},keepRemoveReorderHandler:function(btn){var panel=btn.up("window").down("documents");var selection=panel.getSelection();var docs=panel.getStore().getCorpus().getDocumentsCount();var btnMode=btn.getItemId();if(btnMode=="reorder")if(panel.getStore().getCount()<docs)return Ext.Msg.show({title:this.localize("error"),message:this.localize("reorderFilteredError"),buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR});else{docIndex=[];panel.getStore().each(function(doc){docIndex.push(doc.getIndex())},
this);for(var i=1;i<docIndex.length;i++)if(docIndex[i-1]>docIndex[i])return Ext.Msg.confirm(panel.localize("newCorpus"),(new Ext.Template(panel.localize(btnMode+"Documents"))).applyTemplate([selection.length]),function(confirmBtn){if(confirmBtn==="yes"){docIndex=[];this.getStore().each(function(doc){docIndex.push(doc.getIndex())},this);var params={docIndex:docIndex};params[btnMode+"Documents"]=true;this.editCorpus(params)}},panel);return Ext.Msg.show({title:this.localize("error"),message:this.localize("reorderOriginalError"),
buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR})}if(selection.length>0)if(selection.length==docs)if(docs==1)return Ext.Msg.show({title:this.localize("error"),message:this.localize("onlyOneError"),buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR});else return Ext.Msg.show({title:this.localize("error"),message:this.localize("allSelectedError"),buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR});else return Ext.Msg.confirm(this.localize("newCorpus"),(new Ext.Template(this.localize(btnMode+"SelectedDocuments"))).applyTemplate([selection.length]),
function(confirmBtn){if(confirmBtn==="yes"){docIndex=[];selection.forEach(function(doc){docIndex.push(doc.getIndex())});var params={docIndex:docIndex};params[btnMode+"Documents"]=true;this.editCorpus(params)}},panel);else if(panel.getApiParam("query")&&panel.getStore().getCount()<docs)return Ext.Msg.confirm(this.localize("newCorpus"),(new Ext.Template(this.localize(btnMode+"FilteredDocuments"))).applyTemplate([selection.length]),function(confirmBtn){if(confirmBtn==="yes"){docIndex=[];this.getStore().each(function(doc){docIndex.push(doc.getIndex())},
this);var params={docIndex:docIndex};params[btnMode+"Documents"]=true;this.editCorpus(params)}},panel);else return Ext.Msg.show({title:this.localize("error"),message:this.localize("selectOrFilterError"),buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR})},editCorpus:function(params){Ext.apply(params,{tool:"corpus.CorpusManager",corpus:this.getStore().getCorpus().getId()});var app=this.getApplication();var view=app.getViewport();view.mask(this.localize("Creating new corpus\u2026"));Ext.Ajax.request({url:this.getApplication().getTromboneUrl(),
method:"POST",params:params,success:function(response){view.unmask();var obj=Ext.decode(response.responseText);app.openUrl(app.getBaseUrl()+"?corpus\x3d"+obj.corpus.id)}});var win=this.up("window");if(win&&win.isFloating())win.close()}});Ext.define("Voyant.panel.DocumentsFinder",{extend:"Ext.grid.Panel",require:["Voyant.data.store.DocumentQueryMatches","Ext.grid.plugin.CellEditing"],mixins:["Voyant.panel.Panel"],alias:"widget.documentsfinder",statics:{i18n:{}},config:{exportGridAll:false},constructor:function(config){this.cellEditing=Ext.create("Ext.grid.plugin.CellEditing",{clicksToEdit:1});this.cellEditing.on("edit",this.onEditComplete,this);var me=this;Ext.apply(this,{title:this.localize("title"),emptyText:this.localize("emptyText"),
plugins:[this.cellEditing],bbar:[{text:this.localize("addRow"),glyph:"xf055@FontAwesome",handler:this.addRow,scope:this},{text:this.localize("exportNewCorpus"),disabled:true,glyph:"xf08e@FontAwesome",tooltip:this.localize("exportNewCorpusTip"),handler:function(){var query=this.getQueryFromStore();if(query){this.setLoading(true);var documentQueryMatches=this.getCorpus().getDocumentQueryMatches();documentQueryMatches.load({params:{query:query,createNewCorpus:true},callback:function(records,operation,
success){this.setLoading(false);if(success){var corpus=operation.getProxy().getReader().rawData.documentsFinder.corpus;var url=this.getBaseUrl()+"?corpus\x3d"+corpus;Ext.Msg.alert({title:this.localize("title"),message:"\x3ca href\x3d'"+url+"' target\x3d'_blank'\x3eNew Corpus\x3c/a\x3e"})}else Ext.create("Voyant.util.ResponseError",{msg:this.localize("unsuccessfulQuery"),response:operation.getError().response}).show()},scope:this})}else Ext.Msg.alert({title:this.localize("title"),message:this.localize("noMatches")})},
scope:this,cls:"exportBtn"},{xtype:"tbtext",name:"status",cls:"status"}],columns:[{text:this.localize("query"),dataIndex:"query",renderer:function(value){return Ext.isEmpty(value)?'\x3cspan class\x3d"placeholder"\x3e'+me.localize("emptyQuery")+"\x3c/span\x3e":value},editor:true,minWidth:150,maxWidth:300},{text:this.localize("field"),dataIndex:"field",editor:{xtype:"combo",typeAhead:true,triggerAction:"all",forceSelection:true,value:"",valueField:"value",listeners:{change:function(){if(Ext.isEmpty(this.getValue()))this.reset()}},
store:new Ext.data.Store({fields:["text","value"],data:[[this.localize("textField"),"text"],[this.localize("advancedField"),"advanced"]]})},width:150,renderer:function(v){return Ext.isEmpty(v)?"":me.localize(v+"Field")}},{text:this.localize("operator"),dataIndex:"operator",editor:{xtype:"combo",forceSelection:true,store:new Ext.data.Store({autoDestroy:true,fields:["text","value"],displayField:"text",valueField:"value",data:[{text:"AND",value:"+"},{text:"OR",value:""}]})},minWidth:75,maxWidth:75},
{text:this.localize("count"),dataIndex:"count",renderer:function(value,metadata,record){return Ext.isEmpty(record.get("query"))?"":Ext.util.Format.number(value,"0,000")},minWidth:100,maxWidth:100},{xtype:"actioncolumn",width:25,getGlyph:"xf014@FontAwesome",tooltip:this.localize("deleteQueryTip"),menuDisabled:true,sortable:false,handler:this.removeRow,scope:this}],store:new Ext.data.Store({autoDestroy:true,fields:["id","operator","field","query","count"],data:[["","","","",0]]})});this.callParent(arguments);
this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("loadedCorpus",function(src,corpus){var docs=corpus.getDocuments();if(docs&&docs.getCount()>0){var doc=docs.getDocument(0);var records=[];["title","author","pubDate","publisher","pubPlace"].forEach(function(field){if(!Ext.isEmpty(doc.get(field)))records.push([this.localize(field+"Field"),field])},this);if(records){var editor=this.getColumnManager().getHeaderByDataIndex("field").getEditor();var store=editor.getStore();store.each(function(record){records.push([record.get("text"),
record.get("value")])},this);editor.setStore(Ext.create("Ext.data.Store",{fields:["text","value"],data:records}))}this.updateStatus(0);this.setLoading(false)}})},removeRow:function(grid,rowIndex){this.getStore().removeAt(rowIndex);if(this.getStore().getCount()==0)this.addRow();this.updateAggregate()},addRow:function(){this.store.loadData([["","","","",0]],true)},onEditComplete:function(editor,context){var query=this.getQueryFromRecord(context.record);if(Ext.isEmpty(query)){context.record.set("count",
"");this.updateAggregate()}else{var cell=context.view.getCell(context.record,this.getColumnManager().getHeaderByDataIndex("count"));cell.mask("loading");var documentQueryMatches=this.getCorpus().getDocumentQueryMatches();documentQueryMatches.load({params:{query:query},callback:function(records,operation,success){cell.unmask();if(success)context.record.set("count",records.length==0?0:records[0].get("count"));else{Ext.create("Voyant.util.ResponseError",{msg:this.localize("unsuccessfulQuery"),response:operation.getError().response}).show();
context.record.set("count",0)}this.updateAggregate()},scope:this})}},getQueryFromRecord:function(record){if(Ext.isEmpty(record)||Ext.isEmpty(record.get("query")))return"";var query=record.get("query").trim();if(Ext.isEmpty(query))return"";var field=record.get("field");return Ext.isEmpty(field?field.trim():field)?query:field+":"+query},getQueryFromStore:function(){var query="";this.getStore().each(function(record){var q=this.getQueryFromRecord(record);if(!Ext.isEmpty(q)){if(!Ext.isEmpty(query)){var op=
record.get("operator");query+=op=="AND"?" + ":" | "}query+=q}},this);console.warn(query);return query},updateAggregate:function(){var count=this.getStore().sum("count");if(!count||typeof count=="string")this.updateStatus(0);else if(count==1){var count=this.getStore().getAt(0).get("count");this.updateStatus(this.getStore().getAt(0).get("count"))}else{var query=this.getQueryFromStore();if(!Ext.isEmpty(query)){if(!this.status)this.status=this.down("[cls~\x3dstatus]");this.status.mask(this.localize("loading"));
var documentQueryMatches=this.getCorpus().getDocumentQueryMatches();documentQueryMatches.load({params:{query:query},callback:function(records,operation,success){this.status.unmask();if(success)this.updateStatus(records[0].get("count"));else{Ext.create("Voyant.util.ResponseError",{msg:this.localize("unsuccessfulQuery"),response:operation.getError().response}).show();this.updateStatus(0)}},scope:this})}}},updateStatus:function(count){if(!this.status)this.status=this.down("[cls~\x3dstatus]");if(!this.exportBtn)this.exportBtn=
this.down("[cls~\x3dexportBtn]");if(count==0)this.status.update((new Ext.XTemplate(this.localize("noMatches"))).apply([this.getCorpus().getDocumentsCount()]));else this.status.update((new Ext.XTemplate(this.localize("queryMatches"))).apply([count,this.getCorpus().getDocumentsCount()]));this.exportBtn.setDisabled(count==0)}});Ext.define("Voyant.panel.Dummy",{extend:"Ext.Panel",xtype:"dummy",autoScroll:true,initComponent:function(){var me=this;var columns=3;Ext.apply(this,{xtype:"tabpanel",items:[{title:"Tab 1",icon:null,glyph:42,html:"one"},{title:"Tab 2",icon:null,glyph:70,html:"two"}]});this.callParent()}});Ext.define("Voyant.panel.Fountain",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.fountain",statics:{i18n:{title:"FountainMeter"},api:{stopList:"auto",docIndex:0,speed:30,groups:undefined},glyph:"xf06e@FontAwesome"},config:{options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"}],audio:false,words:[],groups:{},moveWordsTimeout:undefined},constructor:function(){this.mixins["Voyant.util.Localization"].constructor.apply(this,arguments);Ext.apply(this,{title:this.localize("title"),
layout:{type:"hbox",align:"stretch"},items:[{html:"\x3csvg\x3e\x3c/svg\x3e",itemId:"fountain",flex:2},{flex:1,layout:"vbox",items:[{xtype:"polar",itemId:"gauge",width:300,flex:1,store:{fields:["mph","fuel","temp","rpm"],data:[{val:10}]},series:{type:"gauge",colors:this.getApplication().getColorPalette(this.getApplication().getApiParam("palette"),true),angleField:"val",donut:20}},{width:300,height:16,items:{xtype:"sparklineline",itemId:"gaugsparkline",values:[0,1,2,34],height:16,width:300},listeners:{afterrender:function(cmp){cmp.getTargetEl().setStyle("cursor",
"pointer");cmp.getTargetEl().on("click",function(e,t,eOpts){clearTimeout(this.getMoveWordsTimeout());this.getWords().forEach(function(word){if(word.svg){word.svg.remove();delete word.svg}word.direction=-1});var pos=Math.floor(e.event.offsetX*this.getWords().length/t.offsetWidth);this.moveWords(pos)},this)},scope:this}}]}],dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{xtype:"documentselectorbutton",singleSelect:true},{xtype:"slider",fieldLabel:this.localize("speed"),
labelAlign:"right",labelWidth:40,width:100,increment:1,minValue:1,maxValue:60,value:30,listeners:{render:function(cmp){cmp.setValue(parseInt(this.getApiParam("speed")));if(this.bubbles)this.bubbles.frameRate(cmp.getValue());this.setAudio(cmp.getValue());Ext.tip.QuickTipManager.register({target:cmp.getEl(),text:this.localize("speedTip")})},beforedestroy:function(cmp){Ext.tip.QuickTipManager.unregister(cmp.getEl())},changecomplete:function(cmp,val){this.setApiParam("speed",val);if(this.bubbles)this.bubbles.frameRate(val)},
scope:this}}]}]});this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("loadedCorpus",function(src,corpus){this.loadDocument()},this)},loadDocument:function(){var me=this;var docIndex=parseInt(this.getApiParam("docIndex"))||0;this.getCorpus().getWordsArray({docIndex:docIndex,stopList:"auto"}).then(function(words){var lcwords=words.map(function(w){return w.toLowerCase()});if(me.getApiParam("groups")==undefined){var group={};lcwords.forEach(function(w){if(w.length>
5&&!(w in group))group[w]=w.length});var maxLen=Math.max.apply(this,Object.values(group));var lenVal=d3.scaleLinear().domain([4,maxLen]).range([.5,1]);for(var w in group)group[w]=lenVal(group[w]);me.setGroups({length:{color:me.getApplication().getColorForTerm("length"),terms:group}})}var el=me.getComponent("fountain").getTargetEl();var svgEl=el.down("svg");svgEl.set({width:el.getWidth(),height:el.getHeight()});var svgDom=svgEl.dom;var svg=d3.select(svgDom);svg.selectAll("*").remove();var types={};
var groups=me.getGroups();me.setWords(words.slice(0,1E3).map(function(w){var word=new me.FountainWord(w.toLowerCase());if(word.word in types)types[word.word]++;else types[word.word]=1;word.min=parseInt(Math.random()*svgDom.clientHeight*.05);var yshift=Math.sqrt(Math.random()*10);word.yshift=Math.random()*2<1?-yshift:yshift;word.jump=svgDom.clientHeight/10;word.groupVals={};for(var g in groups)if(word.word in groups[g].terms)word.groupVals[g]=groups[g].terms[word.word];return word}));var max=Math.max.apply(this,
Object.values(types));var fontSize=d3.scaleLog().domain([1,Math.max.apply(this,Object.values(types))]).range([4,12]);me.getWords().forEach(function(word){word.fontSize=fontSize(types[word.word])});me.moveWords()})},FountainWord:function(word){this.word=word;this.direction=-1},moveWords:function(until){var words=this.getWords(),svg=this.getComponent("fountain").getTargetEl().down("svg").dom,height=svg.clientHeight,width=svg.clientWidth,groups=this.getGroups();var opacity=d3.scaleLinear().domain([0,
height]).range([1,0]);var gaugeVals=[];var seen=0;for(var i=0;i<words.length;i++){seen++;if(Object.keys(words[i].groupVals).length==0)gaugeVals.push(0);else Object.values(words[i].groupVals).forEach(function(val){gaugeVals.push(val)});if(words[i].direction<0)if(!words[i].svg){var word=d3.select(svg).append("text").text(words[i].word).attr("font-size",words[i].fontSize).attr("text-anchor","middle").attr("x",width/2).attr("y",height-Math.random()*height/5).attr("fill",Object.keys(words[i].groupVals).length==
0?"black":this.getApplication().getColorForTerm(Object.keys(words[i].groupVals).shift(),true));words[i].ys=[height];words[i].svg=word;if(!until||i>until)break}else{var y=parseInt(words[i].svg.attr("y"));var delta=y-words[i].min;var change=delta/5;words[i].svg.attr("y",y-change);words[i].svg.attr("x",parseInt(words[i].svg.attr("x"))+words[i].yshift);y=parseInt(words[i].svg.attr("y"));words[i].ys.push(y);if(y<=words[i].min)words[i].direction=1}else if(words[i].direction>0)if(words[i].svg&&words[i].ys.length>
0){words[i].svg.attr("y",words[i].ys.pop());words[i].svg.attr("x",parseInt(words[i].svg.attr("x"))+words[i].yshift);words[i].svg.attr("opacity",opacity(parseInt(words[i].svg.attr("y"))))}else words[i].direction=0;else if("svg"in words[i]){words[i].svg.remove();delete words[i].svg}}var avg=gaugeVals.length==0?0:Ext.mean(gaugeVals)*100;var polar=this.down("polar");polar.getStore().getAt(0).set("val",avg);polar.setSprites({type:"text",text:Ext.util.Format.number(avg,"%0.0"),x:145,y:240});var sparkline=
this.down("sparklineline");sparkline.setValues(gaugeVals.length>100?this.chunkify(gaugeVals,100,true).map(function(vals){return Ext.mean(vals)}):gaugeVals);sparkline.setWidth(seen*sparkline.ownerCt.getWidth()/words.length);this.setMoveWordsTimeout(Ext.defer(this.moveWords,100,this))},chunkify:function(a,n,balanced){if(n<2)return[a];var len=a.length,out=[],i=0,size;if(len%n===0){size=Math.floor(len/n);while(i<len)out.push(a.slice(i,i+=size))}else if(balanced)while(i<len){size=Math.ceil((len-i)/n--);
out.push(a.slice(i,i+=size))}else{n--;size=Math.floor(len/n);if(len%size===0)size--;while(i<size*n)out.push(a.slice(i,i+=size));out.push(a.slice(size*n))}return out},initComponent:function(){this.callParent(arguments)}});Ext.define("Voyant.panel.RezoViz",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.rezoviz",statics:{i18n:{},api:{query:undefined,limit:25,stopList:"auto",type:["organization","location","person"],minEdgeCount:2},glyph:"xf1cb@FontAwesome"},config:{network:undefined,nodesStore:undefined,nodesDataSet:undefined,edgesDataSet:undefined,isNetworkBounded:true,options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"}]},categorizedNodeOptions:{location:{font:{color:"green"}},person:{font:{color:"maroon"}},
organization:{font:{color:"purple"}}},nodeOptions:{shape:"box",color:{border:"rgba(0,0,0,0.1)",background:"rgba(255,255,255,1)"},scaling:{label:{min:8,max:20}}},edgeOptions:{color:{color:"rgba(0,0,0,0.1)",highlight:"black",hover:"red"},labelHighlightBold:false},highlightOptions:{font:{color:"white"},color:{background:"black"}},constructor:function(config){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},initComponent:function(){var me=this;this.setNodesStore(Ext.create("Ext.data.Store",
{fields:["id","term","type","rawFreq"],sortOnLoad:true,sorters:"term"}));Ext.apply(me,{title:this.localize("title"),dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{xtype:"combo",queryMode:"local",valueField:"term",displayField:"term",store:this.getNodesStore(),listeners:{select:function(combo,record){this.getNetwork().selectNodes([record.get("id")])},scope:this}},{xtype:"button",text:this.localize("categories"),menu:{items:[{xtype:"menucheckitem",text:this.localize("people"),
itemId:"person",checked:true},{xtype:"menucheckitem",text:this.localize("locations"),itemId:"location",checked:true},{xtype:"menucheckitem",text:this.localize("organizations"),itemId:"organization",checked:true},{xtype:"button",text:this.localize("reload"),style:"margin: 5px;",handler:this.categoriesHandler,scope:this}]}},{xtype:"numberfield",itemId:"minEdgeCount",fieldLabel:this.localize("minEdgeCount"),labelAlign:"right",labelWidth:120,width:170,maxValue:10,minValue:1,allowDecimals:false,allowExponential:false,
allowOnlyWhitespace:false,listeners:{render:function(field){field.setRawValue(this.getApiParam("minEdgeCount"))},change:function(field,newVal){if(field.isValid()){this.setApiParam("minEdgeCount",newVal);this.getEntities()}},scope:this}},{xtype:"tbseparator"},{xtype:"slider",fieldLabel:this.localize("repulsion"),labelAlign:"right",labelWidth:70,width:150,value:100,increment:10,minValue:0,maxValue:500,listeners:{changecomplete:function(slider,val){this.getNetwork().physics.options.repulsion.nodeDistance=
val;this.getNetwork().startSimulation()},scope:this}},{xtype:"slider",fieldLabel:this.localize("stiffness"),labelAlign:"right",labelWidth:70,width:150,value:4,increment:1,minValue:0,maxValue:10,listeners:{changecomplete:function(slider,val){val/=100;this.getNetwork().physics.options.repulsion.springConstant=val;this.getNetwork().startSimulation()},scope:this}},{xtype:"slider",fieldLabel:this.localize("friction"),labelAlign:"right",labelWidth:55,width:150,value:9,increment:10,minValue:0,maxValue:100,
listeners:{changecomplete:function(slider,val){val/=100;this.getNetwork().physics.options.repulsion.damping=val;this.getNetwork().startSimulation()},scope:this}}]}]});this.on("loadedCorpus",function(src,corpus){debugger;if(corpus.getDocumentsCount()==1)this.setApiParam("minEdgeCount",1);this.getEntities()},this);this.on("resize",function(panel,width,height){},this);me.callParent(arguments)},getEntities:function(){var corpusId=this.getCorpus().getId();var el=this.getLayout().getRenderTarget();el.mask(this.localize("loadingEntities"));
Ext.Ajax.request({url:this.getApplication().getTromboneUrl(),method:"POST",params:{tool:"corpus.EntityCollocationsGraph",type:this.getApiParam("type"),limit:this.getApiParam("limit"),minEdgeCount:this.getApiParam("minEdgeCount"),corpus:corpusId},success:function(response){el.unmask();var obj=Ext.decode(response.responseText);if(obj.entityCollocationsGraph.edges.length==0){this.showError({msg:this.localize("noEntities")});Ext.Msg.confirm(this.localize("error"),this.localize("noEntitiesForEdgeCount"),
function(button){if(button==="yes"){var newEdgeCount=Math.max(1,this.getApiParam("minEdgeCount")-1);this.queryById("minEdgeCount").setRawValue(newEdgeCount);this.setApiParam("minEdgeCount",newEdgeCount);this.getEntities()}},this)}else{this.processEntities(obj.entityCollocationsGraph);this.initGraph()}},scope:this})},processEntities:function(entityParent){var nodes=entityParent.nodes;var edges=entityParent.edges;var extent=d3.extent(nodes,function(node){return node.rawFreq});var min=extent[0];var max=
extent[1];var scaleFont=d3.scale.linear().domain([min,max]).range([10,24]);var visNodes=[];for(var i=0;i<nodes.length;i++){var n=nodes[i];n.id=i;visNodes.push({id:i,label:n.term,value:nodes[i].rawFreq,font:{size:scaleFont(n.rawFreq),color:this.categorizedNodeOptions[n.type].font.color},type:n.type,rawFreq:n.rawFreq,title:n.term+(n.rawFreq?" ("+n.rawFreq+")":"")})}this.getNodesStore().loadData(nodes);var visEdges=[];for(var i=0;i<edges.length;i++){var link=edges[i].nodes;visEdges.push({from:link[0],
to:link[1],title:edges[i].count,value:200*edges[i].count})}this.setNodesDataSet(new vis.DataSet(visNodes));this.setEdgesDataSet(new vis.DataSet(visEdges))},initGraph:function(){var el=this.getLayout().getRenderTarget();el.update("");el.setWidth(el.getWidth());el.setHeight(el.getHeight());var options={interaction:{hover:true,hoverConnectedEdges:true,multiselect:false},physics:{solver:"repulsion",repulsion:{centralGravity:.1}},nodes:this.nodeOptions,edges:this.edgeOptions};var network=new vis.Network(el.dom,
{nodes:this.getNodesDataSet(),edges:this.getEdgesDataSet()},options);if(this.getIsNetworkBounded())network.on("beforeDrawing",function(ctx){var el=this.getLayout().getRenderTarget();var width=el.getWidth();var height=el.getHeight();var nodePositions=network.getPositions();for(var id in nodePositions){var node=nodePositions[id];var xy=network.canvasToDOM(node);var boundedX=Math.max(0,Math.min(width,xy.x));var boundedY=Math.max(0,Math.min(height,xy.y));var bXY=network.DOMtoCanvas({x:boundedX,y:boundedY});
network.body.nodes[id].x=bXY.x;network.body.nodes[id].y=bXY.y}}.bind(this));network.on("selectNode",function(params){var node=params.nodes[0];this.doNodeSelect(node)}.bind(this));network.on("deselectNode",function(params){network.unselectAll();var node=params.nodes[0];if(node!==undefined)setTimeout(this.doNodeSelect.bind(this),5,node)}.bind(this));network.on("selectEdge",function(params){network.unselectAll()});this.setNetwork(network)},doNodeSelect:function(node){var term=this.getNodesDataSet().get(node).label;
this.dispatchEvent("termsClicked",this,[term]);var network=this.getNetwork();var nodes=network.getConnectedNodes(node);nodes.push(node);var edges=network.getConnectedEdges(node);network.unselectAll();for(var i=0;i<nodes.length;i++){var n=nodes[i];var nodeObj=network.body.nodes[n];network.selectionHandler.selectObject(nodeObj,false)}for(var i=0;i<edges.length;i++){var e=edges[i];var edgeObj=network.body.edges[e];network.selectionHandler.selectObject(edgeObj,false)}network.redraw()},categoriesHandler:function(item){var categories=
[];item.up("menu").items.each(function(checkitem){if(checkitem.checked)categories.push(checkitem.itemId)});this.setApiParam("type",categories);this.getEntities()},map:function(value,istart,istop,ostart,ostop){return ostart+(ostop-ostart)*((value-istart)/(istop-istart))}});Ext.define("Voyant.panel.Loom",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.loom",statics:{i18n:{title:"Loom",controls:"Controls",frequenciesGroup:"Frequencies",coverageGroup:"Coverage",distributionsGroup:"Distribution",termsGroup:"Terms",inDocumentsLabel:"in documents",inDocumentsLabelTip:"each term must be present in the number of documents defined by this range",spanSomeLabel:"some documents",spanSomeLabelTip:"each term must be present in at least one document defined by this range",
spanAllLabel:"all documents",spanAllLabelTip:"each term must be present in all documents defined by this range",spanOnlyLabel:"only documents",spanOnlyLabelTip:"each term must be present in only the documents defined by this range",rawFreqLabel:"raw frequency",rawFreqLabelTip:"raw term frequencies for the term must be between these values (inclusively)",rawFreqPercentileLabel:"raw frequency percentile",rawFreqPercentileLabelTip:"raw term frequencies for the term must be between these percentile values (inclusively), this is useful for saying something like terms in the top 90th percentile which will provide 10% of words regardless of the variation in values.",
distributionsStdDevLabel:"standard deviation of distributions",distributionsStdDevLabelTip:"the standard deviation of term distribution scores must be between the defined range of values (lower will be for values that are more consistent, higher will be for values that have greater variability)",distributionsStdDevPercentileLabel:"percentile of standard deviations of distributions",distributionsStdDevPercentileLabelTip:"the percentile of standard deviations of distributions must be between the defined range of values (lower will be for values that are more consistent, higher will be for values that have greater variability)",
termsLengthLabel:"term length",termsLengthLabelTip:"the length (number of characters) of the term (word)",termsLengthPercentileLabel:"term length percentile",termsLengthPercentileLabelTip:"the percentile of the length (number of characters) of the term (word)",distributionIncreasesLabel:"increases in distribution values",distributionIncreasesLabelTip:"the number of increases of the distribution values must be between the defined range (inclusively)",distributionConsecutiveIncreasesLabel:"consecutive decreases in distribution values",
distributionConsecutiveIncreasesLabelTip:"the number of consecutive decreases of the distribution values must be between the defined range (inclusively)",distributionDecreasesLabel:"decreases in distribution values",distributionDecreasesLabelTip:"the number of decreases of the distribution values must be between the defined range (inclusively)",distributionConsecutiveDecreasesLabel:"consecutive decreases in distribution values",distributionConsecutiveDecreasesLabelTip:"the number of consecutive decreases of the distribution values must be between the defined range (inclusively)",
distributionMaxLabel:"distribution maximum",distributionMaxLabelTip:"the maximum of the distribution values must be between the defined range (inclusively)",distributionMinLabel:"distribution minimum",distributionMinLabelTip:"the minimum of the distribution values must be between the defined range (inclusively)",presetsGroup:"pre-sets",presetHighFreq:"terms that are high frequency",presetHighFreqLonger:"terms that are longer and high frequency",presetSingleDoc:"higher frequency terms that only occur once",
presetIncreaseDistributions:"terms that generally increase in frequency",presetDecreaseDistributions:"terms that generally decrease in frequency ",presetNearStartDistributions:"terms that peak in distribution toward the beginning ",presetNearEndDistributions:"terms that peak in distribution toward the end ",presetSporadicDistributions:"terms whose distributions vary the most",visibleTerms:"max terms",scaling:"scaling",scaleLinear:"linear",scaleLog:"logarithmic",scaleSqrt:"square root"},api:{limit:500,
stopList:"auto",inDocuments:undefined,spanSome:undefined,spanAll:undefined,spanOnly:undefined,termLength:undefined,termsLengthPercentile:undefined,rawFreq:undefined,rawFreqPercentile:undefined,distributionsStdDev:undefined,distributionsStdDevPercentile:undefined,distributionIncreases:undefined,distributionDecreases:undefined,distributionConsecutiveIncreases:undefined,distributionConsecutiveDecreases:undefined,distributionMax:undefined,distributionMin:undefined,scaling:"linear"},glyph:"xf1e0@FontAwesome"},
config:{store:undefined,terms:undefined,options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"}],controls:undefined},constructor:function(config){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},initComponent:function(){this.mixins["Voyant.util.Api"].constructor.apply(this,arguments);var controls=new Ext.util.MixedCollection({allowFunctions:true});controls.addAll({inDocuments:new Voyant.util.LoomControl({group:"coverage",name:"inDocuments",initControl:function(store){this.setMin(1);
this.setMax(store.getAt(0).getDistributions().length)},validateRecord:function(record){var count=record.getDistributions().filter(function(val){return val>0}).length;return count>=this.getLow()&&count<=this.getHigh()}}),spanSome:new Voyant.util.LoomControl({group:"coverage",name:"spanSome",offsetTipText:true,initControl:function(store){this.setMax(store.getAt(0).getDistributions().length-1)},validateRecord:function(record){var low=this.getLow(),high=this.getHigh(),vals=record.getDistributions();for(var i=
low;i<high+1;i++)if(vals[i]>0)return true;return false}}),spanAll:new Voyant.util.LoomControl({group:"coverage",name:"spanAll",offsetTipText:true,initControl:function(store){this.setMax(store.getAt(0).getDistributions().length-1)},validateRecord:function(record){var low=this.getLow(),high=this.getHigh(),vals=record.getDistributions();for(var i=low;i<high+1;i++)if(vals[i]==0)return false;return true}}),spanOnly:new Voyant.util.LoomControl({group:"coverage",name:"spanOnly",offsetTipText:true,initControl:function(store){this.setMax(store.getAt(0).getDistributions().length-
1)},validateRecord:function(record){var low=this.getLow(),high=this.getHigh(),vals=record.getDistributions();for(var i=0;i<vals.length;i++)if(i<low||i>high){if(vals[i]>0)return false}else if(vals[i]==0)return false;return true}}),rawFreq:new Voyant.util.LoomControl({group:"frequencies",name:"rawFreq",offsetTipText:true,initControl:function(store){var vals=store.getRange().map(function(r){return r.get("rawFreq")});this.setMin(Ext.Array.min(vals));this.setMax(Ext.Array.max(vals))},validateRecord:function(record){var low=
this.getLow(),high=this.getHigh(),val=record.get("rawFreq");return val>=low&&val<=high}}),rawFreqPercentile:new Voyant.util.LoomControl({group:"frequencies",name:"rawFreqPercentile",min:0,max:100,initControl:function(store){this.vals=store.getRange().map(function(r){return r.get("rawFreq")});this.vals.sort(function(a,b){return a-b})},validateRecord:function(record){var low=this.getLow(),high=this.getHigh(),ind=Ext.Array.indexOf(this.vals,record.get("rawFreq")),val=Math.round(ind*100/this.vals.length);
return val>=low&&val<=high}}),distributionsStdDev:new Voyant.util.LoomControl({group:"frequencies",name:"distributionsStdDev",initControl:function(store){var allvals=Ext.Array.flatten(store.getRange().map(function(r){return r.getDistributions()}));var scale=d3.scaleLinear().domain([d3.min(allvals),d3.max(allvals)]).range([0,100]);store.each(function(record){if(record.get("distributionsStdDev")===undefined){var vals=record.getDistributions();var scaledVals=vals.map(function(v){return scale(v)});var avg=
Ext.Array.mean(scaledVals);var squareDiffs=vals.map(function(value){var diff=value-avg;var sqrDiff=diff*diff;return sqrDiff});var avgSquareDiff=Ext.Array.mean(squareDiffs);var stdDev=Math.sqrt(avgSquareDiff);record.set("distributionsStdDev",stdDev)}});var vals=store.getRange().map(function(r){return r.get("distributionsStdDev")});this.setMin(Ext.Array.min(vals));this.setMax(Ext.Array.max(vals))},validateRecord:function(record){var low=this.getLow(),high=this.getHigh(),val=record.get("distributionsStdDev");
return val>=low&&val<=high}}),distributionsStdDevPercentile:new Voyant.util.LoomControl({group:"frequencies",name:"distributionsStdDevPercentile",min:0,max:100,initControl:function(store){this.vals=store.getRange().map(function(r){return r.get("distributionsStdDev")});this.vals.sort(function(a,b){return a-b})},validateRecord:function(record){var low=this.getLow(),high=this.getHigh(),ind=Ext.Array.indexOf(this.vals,record.get("distributionsStdDev")),val=Math.round(ind*100/this.vals.length);return val>=
low&&val<=high}}),termsLength:new Voyant.util.LoomControl({group:"terms",name:"termsLength",offsetTipText:true,initControl:function(store){var vals=store.getRange().map(function(r){return r.get("term").length});this.setMin(Ext.Array.min(vals));this.setMax(Ext.Array.max(vals))},validateRecord:function(record){var low=this.getLow(),high=this.getHigh(),val=record.get("term").length;return val>=low&&val<=high}}),termsLengthPercentile:new Voyant.util.LoomControl({group:"terms",name:"termsLengthPercentile",
min:0,max:100,initControl:function(store){this.vals=store.getRange().map(function(r){return r.get("term").length});this.vals.sort(function(a,b){return a-b})},validateRecord:function(record){var low=this.getLow(),high=this.getHigh(),ind=Ext.Array.indexOf(this.vals,record.get("term").length),val=Math.round(ind*100/this.vals.length);return val>=low&&val<=high}}),distributionIncreases:new Voyant.util.LoomControl({group:"distributions",name:"distributionIncreases",initControl:function(store){this.setMax(store.getAt(0).getDistributions().length)},
validateRecord:function(record){var low=this.getLow(),high=this.getHigh(),vals=record.getDistributions();var increases=0;for(var i=1;i<vals.length;i++)if(vals[i]>vals[i-1]){increases++;if(increases>high)return false}return increases>=low}}),distributionConsecutiveIncreases:new Voyant.util.LoomControl({group:"distributions",name:"distributionConsecutiveIncreases",initControl:function(store){this.setMax(store.getAt(0).getDistributions().length)},validateRecord:function(record){var low=this.getLow(),
high=this.getHigh(),vals=record.getDistributions();var increases=0;for(var i=1;i<vals.length;i++)if(vals[i]>vals[i-1]){increases++;if(increases>high)return false}else increases=0;return increases>=low}}),distributionDecreases:new Voyant.util.LoomControl({group:"distributions",name:"distributionDecreases",initControl:function(store){this.setMax(store.getAt(0).getDistributions().length)},validateRecord:function(record){var low=this.getLow(),high=this.getHigh(),vals=record.getDistributions();var decreases=
0;for(var i=1;i<vals.length;i++)if(vals[i]<vals[i-1]){decreases++;if(decreases>high)return false}return decreases>=low}}),distributionConsecutiveDecreases:new Voyant.util.LoomControl({group:"distributions",name:"distributionConsecutiveDecreases",initControl:function(store){this.setMax(store.getAt(0).getDistributions().length)},validateRecord:function(record){var low=this.getLow(),high=this.getHigh(),vals=record.getDistributions();var decreases=0;for(var i=1;i<vals.length;i++)if(vals[i]<vals[i-1]){decreases++;
if(decreases>high)return false}else decreases=0;return decreases>=low}}),distributionMax:new Voyant.util.LoomControl({group:"distributions",name:"distributionMax",initControl:function(store){this.setMax(store.getAt(0).getDistributions().length)},validateRecord:function(record){var low=this.getLow(),high=this.getHigh(),vals=record.getDistributions(),val=Ext.Array.max(vals);for(var i=low;i<high;i++)if(vals[i]==val)return true;return false}}),distributionMin:new Voyant.util.LoomControl({group:"distributions",
name:"distributionMin",initControl:function(store){this.setMax(store.getAt(0).getDistributions().length)},validateRecord:function(record){var low=this.getLow(),high=this.getHigh(),vals=record.getDistributions(),val=Ext.Array.min(vals);for(var i=low;i<high;i++)if(vals[i]==val)return true;return false}})});controls.each(function(control){var val=this.getApiParam(control.getName()),vals=(val||"").split(",");control.setEnabled(val!==undefined);if(vals.length==2){control.setLow(parseInt(vals[0]));control.setHigh(parseInt(vals[1]))}control.on("change",
function(control){if(control.getEnabled())this.setApiParam(control.getName(),control.getLow()+","+control.getHigh());else this.setApiParam(control.getName(),undefined);this.filterRecords()},this)},this);this.setControls(controls);var me=this;var clearApiParamsForControls=function(){var currentParams=me.getApiParams();var params={};me.controls.each(function(control){control.setEnabled(false,true);var name=control.getName();if(name in currentParams)me.setApiParam(name,undefined)})};var tbitems=[{text:this.localize("presetsGroup"),
menu:{items:[{text:this.localize("presetHighFreq"),handler:function(){clearApiParamsForControls();this.filterRecords()},scope:this},{text:this.localize("presetHighFreqLonger"),handler:function(){clearApiParamsForControls();this.controls.getByKey("termsLengthPercentile").setEnabled(true,true).setValues(50,100,true);this.controls.getByKey("rawFreqPercentile").setEnabled(true,true).setValues(50,100)},scope:this},{text:this.localize("presetSingleDoc"),handler:function(){clearApiParamsForControls();this.controls.getByKey("inDocuments").setEnabled(true,
true).setValues(1,1)},scope:this},{text:this.localize("presetIncreaseDistributions"),handler:function(){clearApiParamsForControls();var control=this.controls.getByKey("distributionIncreases");var max=control.getMax();control.setEnabled(true,true).setValues(Math.round(max*.75),max)},scope:this},{text:this.localize("presetDecreaseDistributions"),handler:function(){clearApiParamsForControls();var control=this.controls.getByKey("distributionDecreases");var max=control.getMax();control.setEnabled(true,
true).setValues(Math.round(max*.75),max)},scope:this},{text:this.localize("presetNearStartDistributions"),handler:function(){clearApiParamsForControls();var control=this.controls.getByKey("distributionMax");var max=control.getMax();control.setEnabled(true,true).setValues(0,Math.round(max*.2))},scope:this},{text:this.localize("presetNearEndDistributions"),handler:function(){clearApiParamsForControls();var control=this.controls.getByKey("distributionMax");var max=control.getMax();control.setEnabled(true,
true).setValues(Math.round(max*.8),max)},scope:this},{text:this.localize("presetSporadicDistributions"),handler:function(){clearApiParamsForControls();this.controls.getByKey("distributionsStdDevPercentile").setEnabled(true,true).setValues(80,100)},scope:this}]}},{xtype:"tbspacer"}];["frequencies","coverage","distributions","terms"].map(function(group){tbitems.push({text:this.localize(group+"Group"),menu:{items:controls.filterBy(function(control){return control.getGroup()==group}).getRange().map(function(control){return{xtype:"menucheckitem",
checked:control.getEnabled(),text:this.localize(control.getName()+"Label"),tooltip:this.localize(control.getName()+"LabelTip"),listeners:{beforerender:function(cmp){cmp.setChecked(control.getEnabled());control.on("change",function(){cmp.setChecked(control.getEnabled())})},click:function(cmp){control.setEnabled(cmp.checked);cmp.getMenu().setDisabled(!cmp.checked);if(cmp.checked)cmp.getMenu().show();else cmp.getMenu().hide()}},menu:{disabled:!control.getEnabled(),items:{xtype:"multislider",width:100,
minValue:control.getMin()||0,maxValue:control.getMax()||0,values:[control.getLow()||0,control.getHigh()||0],tipText:function(t){return control.getOffsetTipText()?t.value+1:t.value},listeners:{beforerender:function(slider){slider.updateFromControl(control);control.on("change",function(){slider.updateFromControl(control)})},changecomplete:function(slider){control.setValues(slider.getValues())}},updateFromControl:function(control){this.setMinValue(control.getMin()||0);this.setMaxValue(control.getMax());
this.setValue(0,control.getLow()||0);this.setValue(1,control.getHigh()===undefined?control.getMax()||0:control.getHigh())}}}}},this)}})},this);Ext.apply(this,{title:this.localize("title"),layout:{type:"hbox",align:"stretch"},listeners:{afterrender:function(){var terms=this.getComponent("terms"),threads=this.getComponent("threads");terms.on("termHovered",function(src,term){var thick=threads.getTargetEl().dom.querySelector("path[term\x3d"+term+"]");if(thick){var fadeIt=function(node,time){opacity=node.getAttribute("opacity");
if(opacity>0){opacity-=.01;node.setAttribute("opacity",opacity);time=time/2;Ext.defer(fadeIt,time,this,[node,time])}};thick.setAttribute("opacity",1);fadeIt(thick,1E3)}})}},items:[{itemId:"terms",width:100,layout:"fit",listeners:{filterchange:function(store){var el=this.getTargetEl(),width=el.getWidth(),height=el.getHeight(),len=store.getCount();el.setHtml(" ");terms=store.getRange().map(function(r,i){return{term:r.getTerm(),col:Voyant.application.getColorForTerm(r.getTerm(),true),x:width/2,y:i*height/
len}});terms.sort(function(a,b){return a.term.localeCompare(b.term)});var svg=d3.select(el.dom).append("svg").attr("width",width).attr("height",height).append("g").attr("transform","translate(-.5,-.5)");var textHeight=Math.ceil(height/terms.length);var text=svg.selectAll("ytext").data(terms).enter().append("text").text(function(d,i){return d.term}).attr("class","ytext").attr("text-anchor","middle").attr("x",width/2).attr("y",function(t,i){return textHeight*i}).attr("fill",function(d){return Voyant.application.getColorForTerm(d.term,
true)});var textHeight=Math.ceil(height/terms.length);var fisheye=d3.fisheye.circular().radius(50).distortion(2);yFisheye=d3.fisheye.scale(d3.scaleIdentity).domain([0,height]);var me=this;svg.on("mousemove",function(){var mouse=d3.mouse(this);currentItem=Math.round(mouse[1]*terms.length/height),currentItem=Math.min(currentItem,terms.length-1);fisheye.focus(mouse[1]);yFisheye.focus(mouse[1]);var nodes=text.nodes();if(nodes[currentItem])me.fireEvent("termHovered",me,nodes[currentItem].textContent);
var fs=14,y=Math.max(mouse[1],fs),fo=1;d3.select(nodes[currentItem]).attr("y",function(d){return y}).attr("font-size",fs).attr("fill-opacity",fo);var yin=undefined;for(var i=currentItem-1;i>-1;i--){if(fs>=8){y-=fs;fs-=.5}else{if(yin==undefined)yin=y/i;y-=yin}if(fo>.1)fo-=.05;d3.select(nodes[i]).attr("y",function(d){return y}).attr("font-size",fs).attr("fill-opacity",fo)}fs=14,y=Math.max(mouse[1],fs),fo=1,yin=undefined;for(var i=currentItem+1,len=terms.length;i<len;i++){if(fs>=8){y+=fs;fs-=.5}else{if(yin==
undefined)yin=(height-y)/(len-i);y+=yin}if(fo>.1)fo-=.05;d3.select(nodes[i]).attr("y",function(d){return y}).attr("font-size",fs).attr("fill-opacity",fo)}})}}},{itemId:"threads",layout:"fit",flex:1,listeners:{filterchange:function(store){var el=this.getTargetEl(),width=el.getWidth(),height=el.getHeight();el.setHtml(" ");terms=store.getRange().map(function(r){return{term:r.getTerm(),vals:r.getDistributions()}});var svg=d3.select(el.dom).append("svg").attr("width",el.getWidth()).attr("height",el.getHeight());
if(terms.length==0)return this.up("panel").toastInfo("No hits");var xincrement=width/terms[0].vals.length;var scale,scaleApi=this.up("loom").getApiParam("scaling");if(scaleApi=="sqrt")scale=d3.scaleSqrt();else if(scaleApi=="log")scale=d3.scaleLog();else scale=d3.scaleLinear();var yscale=scale.domain([Math.max(1E-6,Ext.Array.min(terms.map(function(t){return Ext.Array.min(t.vals)}))),Math.max(1E-6,Ext.Array.max(terms.map(function(t){return Ext.Array.max(t.vals)})))]).range([1E-6,height-2]);var valueline=
d3.line().curve(d3.curveCardinal).x(function(d,i){return xincrement/2+xincrement*i}).y(function(d){return height-1-yscale(d)});var tooltip=svg.append("g").attr("opacity",0);var tooltipbox=tooltip.append("rect").attr("fill","white").attr("text-anchor","middle").attr("alignment-baseline","middle").attr("stroke","rgba(0,0,0,.05)").attr("class","rect").attr("x",100).attr("y",100).attr("width",70).attr("height",16).attr("opacity",1);var tooltiptext=tooltip.append("text").attr("text-anchor","middle").attr("alignment-baseline",
"middle").attr("x",100).attr("y",100).text("testing");terms.forEach(function(term){var color=Voyant.application.getColorForTerm(term.term,true);svg.append("path").datum(term.vals).attr("fill","none").attr("stroke",color).attr("opacity",.5).attr("stroke-linejoin","round").attr("stroke-linecap","round").attr("stroke-width",1).attr("class","line").attr("d",valueline);svg.append("path").datum(term.vals).attr("fill","none").attr("stroke",color).attr("opacity",0).attr("stroke-width",3).attr("class","line").attr("term",
term.term).attr("d",valueline).on("mouseover",function(){d3.select(this).attr("opacity",1);var coords=d3.mouse(this);tooltip.attr("opacity",1);tooltipbox.attr("x",coords[0]-35).attr("y",coords[1]-8+(coords[1]>height/2?-18:18));tooltiptext.text(term.term).attr("fill",color).attr("x",coords[0]).attr("y",coords[1]+(coords[1]>height/2?-18:18))}).on("mouseout",function(){d3.select(this).attr("opacity",0);tooltip.attr("opacity",0)});tooltip.raise()},this)}}}],dockedItems:[{dock:"bottom",xtype:"toolbar",
overflowHandler:"scroller",items:[tbitems[0],tbitems[2],tbitems[3],tbitems[4],tbitems[5],{fieldLabel:this.localize("visibleTerms"),labelWidth:70,width:120,xtype:"slider",increment:25,minValue:25,maxValue:5E3,listeners:{afterrender:function(slider){slider.setValue(parseInt(this.getApiParam("limit")))},changecomplete:function(slider,newvalue){this.setApiParams({limit:newvalue});this.fireEvent("loadedCorpus",this,this.getCorpus())},scope:this}},{text:this.localize("scaling"),menu:{defaults:{xtype:"menucheckitem",
handler:function(cmp){this.setApiParam("scaling",cmp.getItemId());this.getComponent("threads").fireEventArgs("filterchange",[this.getStore()])},scope:this,listeners:{afterrender:function(cmp){cmp.setChecked(cmp.getItemId()==this.getApiParam("scaling"))},scope:this},group:"scaling"},items:[{text:this.localize("scaleLinear"),itemId:"linear"},{text:this.localize("scaleLog"),itemId:"log"},{text:this.localize("scaleSqrt"),itemId:"sqrt"}]}}]}]});this.on("loadedCorpus",function(src,corpus){var store=corpus.getDocumentsCount()==
1?corpus.getDocumentTerms():corpus.getCorpusTerms();store.on("load",function(){this.updateControlsFromStore();this.filterRecords()},this);store.on("filterchange",function(){this.getComponent("terms").fireEventArgs("filterchange",arguments);this.getComponent("threads").fireEventArgs("filterchange",arguments)},this);this.setStore(store);params=this.getApiParams();Ext.apply(params,{withDistributions:true});store.load({callback:function(records,operation,success){this.filterRecords()},scope:this,params:params})},
this);this.callParent(arguments)},filterRecords:function(){var store=this.getStore();store.clearFilter();var limit=parseInt(this.getApiParam("limit")),hit=0;store.filterBy(function(record){var keep=Ext.Array.every(this.getControls().getRange(),function(control){return control.getEnabled()==false||control.getValidateRecord().call(control,record)},this);return keep&&hit++<limit},this)},updateControlsFromStore:function(){var store=this.getStore();this.getControls().each(function(control){control.suspendEvent("change");
control.initControl.call(this,store);if(control.getMin()===undefined)control.setMin(0);if(control.getLow()==undefined)control.setLow(control.getMin());if(control.getMax()===undefined)control.setMax(1);if(control.getHigh()==undefined)control.setHigh(control.getMax());control.resumeEvent("change")})},revalidate:function(){var canvas=this.body.down("canvas").dom,ctx=canvas.getContext("2d");ctx.clearRect(0,0,canvas.width,canvas.height);var controls=this.query("loomcontrol");var loomTermRecords=new Voyant.panel.LoomTermRecords;
this.getStore().each(function(record){var vals=record.getDistributions().map(function(v){return true});Ext.Array.each(controls,function(control){if(control.getChecked())if(control.validateRecord){var newvals=control.validateRecord.call(this,control.getField(),record,record.getDistributions());if(Ext.isBoolean(newvals)&&!newvals){vals=false;return false}else if(Ext.isArray(newvals)){for(var i=0;i<vals.length;i++)vals[i]=vals[i]&&newvals[i];return Ext.Array.some(vals,function(v){return v})}}});if(Ext.isArray(vals)&&
Ext.Array.some(vals,function(v){return v}))loomTermRecords.add(record)});loomTermRecords.update(canvas,ctx)}});
Ext.define("Voyant.panel.LoomTermRecords",{config:{termRecords:[]},constructor:function(config){this.setTermRecords([]);this.callParent(arguments)},add:function(record){this.getTermRecords().push(new Voyant.panel.LoomTermRecord(record))},update:function(canvas,ctx){var min=Ext.Array.min(this.getTermRecords().map(function(r){return Ext.Array.min(r.getValues())}));var max=Ext.Array.max(this.getTermRecords().map(function(r){return Ext.Array.max(r.getValues())}));this.getTermRecords().forEach(function(r){r.update(canvas,
ctx,min,max)})}});
Ext.define("Voyant.panel.LoomTermRecord",{config:{record:undefined,values:undefined,term:undefined,texts:undefined},constructor:function(config){this.setRecord(config);this.setValues(config.getDistributions());var term=config.getTerm();this.setTerm(term);this.setTexts(config.getDistributions().map(function(v){return new Ext.draw.sprite.Text({type:"text",text:term})}));this.callParent(arguments)},update:function(canvas,ctx,min,max){var values=this.getValues(),columnWidth=canvas.offsetWidth/values.length,
height=canvas.offsetHeight,term=this.getTerm();this.getTexts().forEach(function(text,i){var y=values[i]*height/max;ctx.fillText(term,columnWidth/2+i*columnWidth,height-y)})}});
Ext.define("Voyant.util.LoomControl",{extend:"Ext.Base",mixins:["Ext.mixin.Observable"],constructor:function(config){this.mixins.observable.constructor.call(this,config);this.callParent(arguments)},config:{group:undefined,name:undefined,enabled:false,min:undefined,max:undefined,low:undefined,high:undefined,initControls:Ext.emptyFn,validateRecord:Ext.emptyFn,offsetTipText:false},setMin:function(){this.callParent(arguments);this.fireEvent("change",this);return this},setMax:function(){this.callParent(arguments);
this.fireEvent("change",this);return this},setLow:function(){this.callParent(arguments);this.fireEvent("change",this);return this},setHigh:function(){this.callParent(arguments);this.fireEvent("change",this);return this},setValues:function(low,high){this.suspendEvent("change");if(Ext.isArray(low)){this.setLow(low[0]);this.setHigh(low[1])}else{this.setLow(low);this.setHigh(high)}this.resumeEvent("change");if(arguments.length<3||!arguments[2])this.fireEvent("change",this);return this},setEnabled:function(){this.callParent(arguments);
if(arguments.length<2||!arguments[1])this.fireEvent("change",this);return this}});Ext.define("Voyant.panel.MicroSearch",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.microsearch",statics:{i18n:{},api:{stopList:"auto",query:undefined},glyph:"xf1ea@FontAwesome"},config:{options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"}],maxTokens:0,tokensPerSegment:0,maxVerticalLines:0,maxSegments:0},constructor:function(config){Ext.apply(this,{title:this.localize("title"),dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{xtype:"querysearchfield"}]}]});
this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("loadedCorpus",function(src,corpus){if(this.rendered)this.initialize();else this.on("afterrender",function(){this.initialize()},this)});this.on("query",function(src,query){this.setApiParam("query",query);this.updateSearchResults()})},initialize:function(){var el=this.getTargetEl(),corpus=this.getCorpus();var lineSize=5;this.setMaxVerticalLines(Math.floor((el.getHeight()-10)/lineSize));var gutterSize=
10;var corpusSize=corpus.getDocumentsCount();var gutter=corpusSize*gutterSize;var columnSize=Math.floor((el.getWidth()-gutter-10)/corpusSize);if(columnSize>200)columnSize=200;var segmentWidth=3;var maxSegmentsPerLine=Math.floor(columnSize/segmentWidth);if(maxSegmentsPerLine<1)maxSegmentsPerLine=1;this.setMaxSegments(maxSegmentsPerLine*this.getMaxVerticalLines());var documentsStore=corpus.getDocuments();this.setMaxTokens(documentsStore.max("tokensCount-lexical"));this.setTokensPerSegment(this.getMaxTokens()<
this.getMaxSegments()?1:Math.ceil(this.getMaxTokens()/this.getMaxSegments()));var canvas="\x3ctable cellpadding\x3d'0' cellspacing\x3d'0' style\x3d'height: 100%'\x3e\x3ctr\x3e";this.segments=[];documentsStore.each(function(document){docIndex=document.getIndex();canvas+='\x3ctd style\x3d"overflow: hidden; vertical-align: top; width: '+columnSize+'px;"\x3e'+'\x3cdiv class\x3d"docLabel" style\x3d"white-space: nowrap; width: '+columnSize+'px;" data-qtip\x3d"'+document.getFullLabel()+'"\x3e'+document.getFullLabel()+
"\x3c/div\x3e"+'\x3ccanvas style\x3d"display: block;" width\x3d"'+columnSize+'" height\x3d"'+el.getHeight()+'" id\x3d"'+this.body.id+"-"+docIndex+'"\x3e'+"\x3c/td\x3e";if(docIndex+1<corpusSize)canvas+='\x3ctd style\x3d"width: '+gutterSize+'px;"\x3e\x26nbsp;\x3c/td\x3e'},this);canvas+="\x3c/tr\x3e\x3c/table\x3e";el.update(canvas);this.updateSearchResults();if(!this.getApiParam("query")){var me=this;return this.getCorpus().loadCorpusTerms({limit:1,stopList:this.getApiParam("stopList"),categories:this.getApiParam("categories")}).then(function(corpusTerms){var term=
corpusTerms.getAt(0).getTerm();var q=me.down("querysearchfield");q.addValue(new Voyant.data.model.CorpusTerm({term:term}));me.fireEvent("query",me,[term])})}},updateSearchResults:function(){query=this.getApiParam("query");if(Ext.Array.from(query).length==0)this.getCorpus().getDocuments().each(function(document){var distributions=this.redistributeDistributions(document,new Array(this.getMaxSegments()));this.drawDocumentDistributions(document,distributions)},this);else{this.mask(this.localize("loading"));
this.getCorpus().getDocumentTerms().load({params:{query:Ext.Array.from(query).join("|"),withDistributions:"relative",bins:this.getMaxSegments(),categories:this.getApiParam("categories")},callback:function(records,operation,success){this.unmask();var max=0,min=Number.MAX_VALUE,docs=[],m;records.forEach(function(record){var doc=this.getCorpus().getDocument(record.getDocIndex());var distributions=this.redistributeDistributions(doc,record.getDistributions());m=Ext.Array.max(distributions);if(m>max)max=
m;distributions.forEach(function(d){if(d&&d<min)min=d});docs[record.getDocIndex()]=this.redistributeDistributions(doc,record.getDistributions())},this);docs.forEach(function(distributions,i){this.drawDocumentDistributions(this.getCorpus().getDocument(i),distributions,min||Ext.Array.min(distributions),max||Ext.Array.max(distributions))},this)},scope:this})}},redistributeDistributions:function(doc,distributions){var segments=Math.ceil(doc.getLexicalTokensCount()/this.getTokensPerSegment());if(distributions.length>
segments){var newdistributions=[];for(var i=0;i<distributions.length;i++){var a=parseInt(i*segments/distributions.length);if(newdistributions[a])newdistributions[a].push(distributions[i]);else newdistributions[a]=[distributions[i]]}distributions=newdistributions;for(var i=0;i<distributions.length;i++)distributions[i]=Ext.Array.mean(distributions[i])}return distributions},drawDocumentDistributions:function(doc,distributions,min,max){var canvas=this.getTargetEl().dom.querySelector("#"+this.body.id+
"-"+doc.getIndex());var c=canvas.getContext("2d");var x=0,w=canvas.clientWidth,y=0;for(var j=0;j<distributions.length;j++){c.fillStyle=distributions[j]?"rgba(250,0,0,"+((distributions[j]-min)*.8/(max-min)+.2)+")":"rgb(230,230,230)";c.fillRect(x,y,3,3);x+=3;if(x>=w){x=0;y+=5}}}});Ext.define("Voyant.panel.Mandala",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.mandala",statics:{i18n:{},api:{stopList:"auto",query:undefined,labels:true},glyph:"xf1db@FontAwesome"},gutter:5,textFont:"12px sans-serif",config:{options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"}]},constructor:function(){this.mixins["Voyant.util.Localization"].constructor.apply(this,arguments);Ext.apply(this,{title:this.localize("title"),html:'\x3cdiv style\x3d"text-align: center"\x3e\x3ccanvas width\x3d"800" height\x3d"600"\x3e\x3c/canvas\x3e\x3c/div\x3e',
dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{text:this.localize("add"),glyph:"xf067@FontAwesome",handler:function(){this.editMagnet()},scope:this},{text:this.localize("clear"),glyph:"xf014@FontAwesome",handler:function(){this.setApiParam("query",undefined);this.updateFromQueries(true);this.editMagnet()},scope:this},{xtype:"checkbox",boxLabel:this.localize("labels"),listeners:{render:function(cmp){cmp.setValue(this.getApiParam("labels")===true);Ext.tip.QuickTipManager.register({target:cmp.getEl(),
text:this.localize("labelsTip")})},beforedestroy:function(cmp){Ext.tip.QuickTipManager.unregister(cmp.getEl())},change:function(cmp,val){this.setApiParam("labels",val);this.draw()},scope:this}}]}]});this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("boxready",function(cmp){var canvas=this.getTargetEl().dom.querySelector("canvas");var me=this;canvas.addEventListener("mousemove",function(evt){var rect=canvas.getBoundingClientRect(),x=evt.clientX-
rect.left,y=evt.clientY-rect.top,change=false,docRadius=parseInt(me.textFont)/2;if(me.documents)me.documents.forEach(function(doc){var isHovering=x>doc.x-docRadius&&x<doc.x+docRadius&&y>doc.y-docRadius&&y<doc.y+docRadius;if(isHovering!=doc.isHovering)change=true;doc.isHovering=isHovering});radius=parseInt(me.textFont)/2;for(term in me.magnets){var isHovering=x>me.magnets[term].x-radius&&x<me.magnets[term].x+radius&&y>me.magnets[term].y-radius&&y<me.magnets[term].y+radius;if(isHovering!=me.magnets[term].isHovering)change=
true;me.magnets[term].isHovering=isHovering}if(change)me.draw()},false);canvas.addEventListener("click",function(evt){var rect=canvas.getBoundingClientRect(),x=evt.clientX-rect.left,y=evt.clientY-rect.top,docRadius=parseInt(me.textFont)/2;for(term in me.magnets)if(x>me.magnets[term].x-radius&&x<me.magnets[term].x+radius&&y>me.magnets[term].y-radius&&y<me.magnets[term].y+radius)me.editMagnet(term)},false)});this.on("loadedCorpus",function(src,corpus){this.documents=[];var canvas=this.getTargetEl().dom.querySelector("canvas"),
ctx=canvas.getContext("2d"),radius=canvas.width/2;ctx.font=this.textFont;corpus.getDocuments().each(function(document){var label=document.getTinyTitle();this.documents.push({doc:document,label:label,width:ctx.measureText(label).width,x:radius,y:radius,matches:[],isHovering:false})},this);this.updateDocs(canvas);this.draw();this.updateFromQueries()},this);this.on("resize",function(){var canvas=this.getTargetEl().dom.querySelector("canvas"),diam=Math.min(this.getTargetEl().getWidth(),this.getTargetEl().getHeight());
canvas.width=diam;canvas.height=diam;this.updateMagnets();this.updateDocs();this.draw(canvas)})},editMagnet:function(term){var me=this,currentTerms=Ext.Array.from(me.getApiParam("query"));Ext.create("Ext.window.Window",{title:this.localize("EditMagnet"),modal:true,items:{xtype:"form",width:300,items:[{xtype:"querysearchfield",corpus:this.getCorpus(),store:this.getCorpus().getCorpusTerms({proxy:{extraParams:{stopList:this.getApiParam("stopList")}}}),stopList:this.getApiParam("stopList"),listeners:{afterrender:function(field){if(term){var termObj=
new Ext.create("Voyant.data.model.CorpusTerm",{term:term});field.getStore().loadData(termObj,true);field.setValue(termObj)}}}},{xtype:"numberfield",fieldLabel:me.localize("rotateClockwise"),minValue:0,maxValue:currentTerms.length-1,value:0,stepValue:1,width:200,name:"rotate"}],buttons:[{text:this.localize("remove"),glyph:"xf0e2@FontAwesome",flex:1,ui:"default-toolbar",handler:function(btn){var queries=Ext.Array.filter(Ext.Array.from(me.getApiParam("query")),function(query){return query!=term});me.setApiParam("query",
queries);me.updateFromQueries(queries.length==0);btn.up("window").close()},scope:this},{xtype:"tbfill"},{text:this.localize("cancel"),ui:"default-toolbar",glyph:"xf00d@FontAwesome",flex:1,handler:function(btn){btn.up("window").close()}},{text:this.localize("update"),glyph:"xf00c@FontAwesome",flex:1,handler:function(btn){var val=btn.up("window").down("querysearchfield").getValue().join("|");if(val){var position=-1;for(var i=0;i<currentTerms.length;i++)if(term==currentTerms[i]){position=i;currentTerms[i]=
val;var rotate=btn.up("window").down("numberfield").getValue();if(rotate){currentTerms.splice(i,1);var newpos=i+rotate;if(newpos>currentTerms.length)newpos-=currentTerms.length+1;currentTerms.splice(newpos,0,val)}break}if(position==-1)currentTerms.push(val)}me.setApiParam("query",currentTerms);me.updateFromQueries(currentTerms.length==0);btn.up("window").close()},scope:this}]},bodyPadding:5}).show()},updateFromQueries:function(allowEmpty){this.magnets=undefined;this.documents.forEach(function(doc){doc.matches=
[]});this.updateDocs();this.draw();if(this.documents){var params=this.getApiParams();if(!params.query)params.limit=10;var queries=Ext.Array.from(this.getApiParam("query"));if(!allowEmpty||queries.length>0)this.getCorpus().getCorpusTerms().load({params:Ext.apply(params,{withDistributions:true}),callback:function(records){var canvas=this.getTargetEl().dom.querySelector("canvas"),ctx=canvas.getContext("2d");diam=canvas.width,rad=diam/2;ctx.font=this.textFont;var magnets={};for(var i=0,len=records.length;i<
len;i++){var term=records[i].getTerm();records[i].getDistributions().forEach(function(val,i){if(val>0)this.documents[i].matches.push(term)},this);magnets[term]={record:records[i],colour:this.getApplication().getColor(i),width:ctx.measureText(term).width,isHovering:false}}this.magnets={};queries.forEach(function(query){if(magnets[query]){this.magnets[query]=magnets[query];delete magnets[query]}},this);for(term in magnets)this.magnets[term]=magnets[term];this.setApiParam("query",Object.keys(this.magnets));
this.updateMagnets();this.updateDocs();this.draw()},scope:this})}},updateMagnets:function(canvas){var canvas=this.getTargetEl().dom.querySelector("canvas"),diam=canvas.width,rad=diam/2;var len=Object.keys(this.magnets||{}).length;var i=0;for(var term in this.magnets){Ext.apply(this.magnets[term],{x:rad+(rad-this.gutter-50)*Math.cos(2*Math.PI*i/len),y:rad+(rad-this.gutter-50)*Math.sin(2*Math.PI*i/len)});i++}},updateDocs:function(canvas){canvas=canvas||this.getTargetEl().dom.querySelector("canvas"),
diam=canvas.width,rad=diam/2;var notMatching=[];if(this.documents){this.documents.forEach(function(doc,i){if(Ext.Array.from(doc.matches).length==0)notMatching.push(i);else if(Ext.Array.from(doc.matches).length==1){var x=Math.random()*15+15,y=Math.random()*15+15;doc.targetX=this.magnets[doc.matches[0]].x+(Math.round(Math.random())==0?x:-x);doc.targetY=this.magnets[doc.matches[0]].y+(Math.round(Math.random())==0?y:-y)}else{var x=0,y=0,vals=doc.matches.map(function(term){return this.magnets[term].record.getDistributions()[i]},
this),min=Ext.Array.min(vals),max=Ext.Array.max(vals);var weights=0;doc.matches.forEach(function(term,j){weight=max==min?1:(vals[j]-min+min)/(max-min+min);weights+=weight;x+=this.magnets[term].x*weight;y+=this.magnets[term].y*weight},this);doc.targetX=x/weights;doc.targetY=y/weights}},this);for(var i=0,len=notMatching.length;i<len;i++)Ext.apply(this.documents[i],{targetX:rad+(rad-this.gutter)*Math.cos(2*Math.PI*i/len),targetY:rad+(rad-this.gutter)*Math.sin(2*Math.PI*i/len)})}},draw:function(canvas,
ctx){canvas=canvas||this.getTargetEl().dom.querySelector("canvas");ctx=ctx||canvas.getContext("2d");ctx.font=this.textFont;var radius=canvas.width/2;ctx.clearRect(0,0,canvas.width,canvas.height);var labels=this.getApiParam("labels");ctx.beginPath();ctx.strokeStyle="rgba(0,0,0,.1)";ctx.fillStyle="rgba(0,0,0,.02)";ctx.arc(radius,radius,radius-this.gutter,0,2*Math.PI,false);ctx.fill();ctx.lineWidth=2;ctx.stroke();var needRedraw=false;if(this.documents&&this.documents.length>0){var needMove=false;var noHovering=
Ext.Array.each(this.documents,function(doc){return!doc.isHovering},this);if(noHovering===true)noHovering=Ext.Array.each(Object.keys(this.magnets||{}),function(term){return!this.magnets[term].isHovering},this);var hoveringTerms={};hoveringDocs=[];this.documents.forEach(function(document,j){document.matches.forEach(function(term,i){ctx.beginPath();ctx.moveTo(document.x,document.y);ctx.lineTo(this.magnets[term].x,this.magnets[term].y);if(noHovering===true)ctx.strokeStyle="rgba("+this.magnets[term].colour.join(",")+
",.1)";else if(document.isHovering||this.magnets[term].isHovering){hoveringDocs[j]=true;hoveringTerms[term]=true;ctx.strokeStyle="rgba("+this.magnets[term].colour.join(",")+",.5)"}else ctx.strokeStyle="rgba(0,0,0,.02)";ctx.stroke()},this)},this);var halfSize=parseInt(this.textFont)/2,height=parseInt(this.textFont)+4;this.documents.forEach(function(document,i){if(labels||document.isHovering||hoveringDocs[i]==true){var width=document.width+4;ctx.fillStyle=document.isHovering||hoveringDocs[i]==true||
noHovering===true?"white":"rgba(255,255,255,.05)";ctx.fillRect(document.x-width/2,document.y-height/2,width,height);ctx.strokeStyle=document.isHovering||hoveringDocs[i]==true||noHovering===true?"rgba(0,0,0,.2)":"rgba(0,0,0,.05)";ctx.strokeRect(document.x-width/2,document.y-height/2,width,height);ctx.textAlign="center";ctx.fillStyle=document.isHovering||hoveringDocs[i]==true||noHovering===true?"rgba(0,0,0,.8)":"rgba(0,0,0,.05)";ctx.fillText(document.label,document.x,document.y)}else{ctx.beginPath();
ctx.fillStyle="rgba(0,0,0,.8)";ctx.arc(document.x,document.y,halfSize,0,2*Math.PI);ctx.fill();ctx.stroke()}var dx=Math.abs(document.x-document.targetX),dy=Math.abs(document.y-document.targetY);if(dx!=0||dy!=0){if(dx<1)document.x=document.targetX;else{dx/=2;document.x=document.x>document.targetX?document.x-dx:document.x+dx}if(dy<1)document.y=document.targetY;else{dy/=2;document.y=document.y>document.targetY?document.y-dy:document.y+dy}needRedraw=true}},this);var i=0,height=parseInt(this.textFont)+
4;ctx.textAlign="center";ctx.textBaseline="middle";for(var term in this.magnets)if(labels||term in hoveringTerms||this.magnets[term].isHovering){var width=this.magnets[term].width+4;ctx.fillStyle=term in hoveringTerms||this.magnets[term].isHovering||noHovering===true?"white":"rgba(255,255,255,.05)";ctx.fillRect(this.magnets[term].x-width/2,this.magnets[term].y-height/2,width,height);ctx.strokeStyle=term in hoveringTerms||this.magnets[term].isHovering||noHovering===true?"rgb("+this.magnets[term].colour.join(",")+
")":"rgba(0,0,0,.05)";ctx.strokeRect(this.magnets[term].x-width/2,this.magnets[term].y-height/2,width,height);ctx.textAlign="center";ctx.fillStyle=term in hoveringTerms||this.magnets[term].isHovering||noHovering===true?"rgba(0,0,0,.8)":"rgba(0,0,0,.05)";ctx.fillText(term,this.magnets[term].x,this.magnets[term].y)}else{ctx.beginPath();ctx.fillStyle="rgb("+this.magnets[term].colour.join(",")+")";ctx.strokeStyle="rgb("+this.magnets[term].colour.join(",")+")";ctx.arc(this.magnets[term].x,this.magnets[term].y,
12,0,2*Math.PI);ctx.fill();ctx.stroke()}}if(needRedraw){var me=this;setTimeout(function(){me.draw()},100)}else if(this.documents){var minDist=Math.max(radius/this.documents.length,50),spring=.1;for(var i=0,len=this.documents.length;i<len;i++)for(var j=0;j<len;j++)if(i<j){var dx=this.documents[i].x-this.documents[j].x,dy=this.documents[i].y-this.documents[j].y,dist=Math.sqrt(dx*dx+dy*dy);if(dist<minDist){var ax=dx*spring,ay=dy*spring;this.documents[i].targetX+=ax;this.documents[j].targetX-=ax;this.documents[i].targetY+=
ay;this.documents[j].targetY-=ay;needRedraw=true}}if(needRedraw){var me=this;setTimeout(function(){me.draw()},100)}}}});Ext.define("Voyant.panel.MicroOcp",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.microocp",statics:{i18n:{title:"MicroOCP"},api:{config:undefined,stopList:"auto",uri:undefined},glyph:"xf1ea@FontAwesome"},config:{editor:undefined},constructor:function(config){config=config||{};this.mixins["Voyant.util.Api"].constructor.apply(this,arguments);var store=Ext.create("Ext.data.Store",{fields:[{name:"cocoa",type:"string"}]});var microocp=this;Ext.apply(this,{title:this.localize("title"),
layout:"border",dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",groupId:"tbar",items:[{text:"Create New Voyant Corpus",handler:function(){var items=this.down("grid").getSelectionModel().getSelection().map(function(item){return item.get("cocoa")});if(items.length==0)return this.showError({title:"Error",msg:"No items are selected in the grid (on the right)."});itemsMap={};items.forEach(function(item){itemsMap[item]=true});var str=this.getEditor().getValue();var tags=/<(\/)?(\w+)(\s(\w+))?>/g;
var matches;var tagsMap={};while((matches=tags.exec(str))!=null){var isClose=matches[1]=="/",tag=matches[2],attr=matches[4],item=matches[4]?matches[2]+" "+matches[4]:matches[2];if(isClose||item in itemsMap){if(tag in tagsMap)tagsMap[tag][tagsMap[tag].length-1].end=matches.index;if(!isClose){if(!(tag in tagsMap))tagsMap[tag]=[];tagsMap[tag].push({start:matches.index+matches[0].length,tag:tag,attr:attr})}}else if(item in itemsMap)if(tag in tagsMap)tagsMap[tag][tagsMap[tag].length-1].end=matches.index}isGroupItems=
this.getDockedComponent(1).down("checkbox").checked;var documents=[];if(isGroupItems){var docs={};for(var tag in tagsMap)tagsMap[tag].forEach(function(entry,i){var text=str.substring(entry.start,entry.end).replace(/<\/?\w+(\s+\w)*>/g,"").trim();if(text){var item=entry.tag+(entry.attr?" "+entry.attr:"");if(item in docs)docs[item]+=text;else docs[item]=text}});for(var item in docs)documents.push({title:item,text:docs[item]})}else for(var tag in tagsMap)tagsMap[tag].forEach(function(entry,i){var text=
str.substring(entry.start,entry.end).replace(/<\/?\w+(\s+\w)*>/g,"").trim();if(text)documents.push({title:entry.tag+(entry.attr?" "+entry.attr:"")+" "+(i+1),text:text})});if(documents.length==0)return this.showError({title:"Error",msg:"No documents found."});this.mask();var progress=Ext.Msg.progress("Creating","Creating new corpus.");var me=this;(new Corpus({inputFormat:"json",input:Ext.JSON.encode({documents:documents}),jsonDocumentsPointer:"/documents",jsonTitlePointer:"/title",jsonContentPointer:"/text"})).then(function(corpus){progress.close();
me.unmask();var app=me.getApplication();me.openUrl(app.getBaseUrl()+"?corpus\x3d"+corpus.getAliasOrId())})},scope:this},{xtype:"checkbox",boxLabel:"Combine documents with the same tag attribute.",checked:true}]}],items:[{xtype:"panel",autoScroll:true,flex:1,height:"100%",align:"stretch",header:false,region:"center",listeners:{boxready:function(){var me=this;var editor=ace.edit(Ext.getDom(this.getEl()));microocp.setEditor(editor);editor.getSession().setMode("ace/mode/xml");editor.renderer.setShowPrintMargin(false);
editor.renderer.setShowGutter(false);editor.$blockScrolling=Infinity;editor.setOptions({autoScrollEditorIntoView:true});editor.setBehavioursEnabled(false);editor.on("change",function(delta){reparse=false;if(delta.action=="insert"){if(delta.lines[0].indexOf("\x3e")==0)reparse=true}else if(delta.action=="remove")for(var i=0;i<delta.lines.length;i++)if(delta.lines[i].indexOf("\x3e")>-1){reparse=true;break}if(reparse)Ext.defer(function(){var str=editor.getValue();var tags=/<(\w+)(\s(\w+))?>/g;var matches;
var expressions={};while((matches=tags.exec(str))!=null)if(matches[3])expressions[matches[1]+" "+matches[3]]=true;else expressions[matches[1]]=true;var store=this.up("panel").down("grid").getStore();var inStoreItems={};store.getRange().forEach(function(item){inStoreItems[item.get("cocoa")]=true});for(item in expressions)if(!(item in inStoreItems))store.add({cocoa:item});for(inStoreItem in inStoreItems)if(!(inStoreItem in expressions)){var rec=store.findRecord("cocoa",inStoreItem);store.remove(rec)}},
100,me)});if(microocp.getApiParam("uri"))Notebook.loadDataFromUrl(microocp.getApiParam("uri")).then(function(data){microocp.getEditor().setValue(data)})}}},{xtype:"grid",region:"east",height:"100%",align:"stretch",scrollable:true,header:false,width:200,selModel:Ext.create("Ext.selection.CheckboxModel",{mode:"SIMPLE"}),store:store,columns:[{text:"COCOA",flex:1,dataIndex:"cocoa"}]}]});this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("loadedCorpus",
function(src,corpus){if(this.getApiParam("uri"))return;var me=this;corpus.getPlainText().then(function(text){text=text.replace(/(\r\n|\r|\n)(\r\n|\r|\n)(\r\n|\r|\n)+/g,"\n\n");var editor=me.getEditor();editor.setValue(text).trim();editor.scrollToLine(1,true,true,function(){})})},this);this.on("afterrender",function(panel){Ext.Msg.alert("MicroOCP","MicroOCP is an experimental prototype that is intended to give a taste of working with the COCOA markup format (COunt and COncordance on the Atlas). Cocoa tags are like switches, you can place one and that tag remains in effect until the next instance of the tag, which can have an optional attribute (single word). As an enhancement to COCOA, you can also close a tag.\x3cpre\x3e\x26lt;speaker jack\x26gt;I'm falling \x26lt;speaker jill\x26gt;down the hill.\x26lt;/speaker\x26gt;\x3c/pre\x3e")})}});Ext.define("Voyant.panel.Reader",{extend:"Ext.panel.Panel",requires:["Voyant.data.store.Tokens"],mixins:["Voyant.panel.Panel"],alias:"widget.reader",isConsumptive:true,statics:{i18n:{},api:{start:0,limit:1E3,skipToDocId:undefined,query:undefined},glyph:"xf0f6@FontAwesome"},config:{innerContainer:undefined,tokensStore:undefined,documentsStore:undefined,documentTermsStore:undefined,exportVisualization:false,lastScrollTop:0,scrollIntoView:false,insertWhere:"beforeEnd",lastLocationUpdate:new Date,options:[{xtype:"stoplistoption"},
{xtype:"categoriesoption"}]},SCROLL_UP:-1,SCROLL_EQ:0,SCROLL_DOWN:1,LOCATION_UPDATE_FREQ:100,INITIAL_LIMIT:1E3,constructor:function(config){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},initComponent:function(config){var tokensStore=Ext.create("Voyant.data.store.Tokens",{parentTool:this,proxy:{extraParams:{forTool:"reader"}}});var me=this;tokensStore.on("beforeload",function(store){return me.hasCorpusAccess(store.getCorpus())});tokensStore.on("load",
function(s,records,success){if(success){var contents="";var documentFrequency=this.localize("documentFrequency");var isPlainText=false;var docIndex=-1;var isLastNewLine=false;records.forEach(function(record){if(record.getPosition()==0)contents+="\x3ch3\x3e"+this.getDocumentsStore().getById(record.getDocId()).getFullLabel()+"\x3c/h3\x3e";if(record.getDocIndex()!=docIndex){isPlainText=this.getDocumentsStore().getById(record.getDocId()).isPlainText();docIndex=record.getDocIndex()}if(record.isWord()){isLastNewLine=
false;contents+="\x3cspan class\x3d'word' id\x3d'"+record.getId()+"' data-qtip\x3d'"+documentFrequency+" "+record.getDocumentRawFreq()+"'\x3e"+record.getTerm()+"\x3c/span\x3e"}else{var newContents=record.getTermWithLineSpacing(isPlainText);var isNewLine=newContents.indexOf("\x3cbr /\x3e")==0;if(isLastNewLine&&(isNewLine||newContents.trim().length==0));else{contents+=newContents;isLastNewLine=isNewLine}}},this);this.updateText(contents);var keyword=this.down("querysearchfield").getValue();if(keyword!=
"");}},this);this.setTokensStore(tokensStore);this.on("query",function(src,queries){this.loadQueryTerms(queries)},this);this.setDocumentTermsStore(Ext.create("Ext.data.Store",{model:"Voyant.data.model.DocumentTerm",autoLoad:false,remoteSort:false,proxy:{type:"ajax",url:Voyant.application.getTromboneUrl(),extraParams:{tool:"corpus.DocumentTerms",withDistributions:true,withPositions:true,bins:25,forTool:"reader"},reader:{type:"json",rootProperty:"documentTerms.terms",totalProperty:"documentTerms.total"},
simpleSortMode:true},listeners:{load:function(store,records,successful,opts){store.sort("docIndex","ASC");var term;store.each(function(r){term=r.get("term")},this);this.highlightKeywords(term)},scope:this}}));this.on("afterrender",function(){var centerPanel=this.down('panel[region\x3d"center"]');this.setInnerContainer(centerPanel.getLayout().getRenderTarget());centerPanel.body.on("scroll",function(event,target){var scrollDir=this.getLastScrollTop()<target.scrollTop?this.SCROLL_DOWN:this.getLastScrollTop()>
target.scrollTop?this.SCROLL_UP:this.SCROLL_EQ;if(scrollDir==this.SCROLL_UP&&target.scrollTop<1)this.fetchPrevious(true);else if(scrollDir==this.SCROLL_DOWN&&target.scrollHeight-target.scrollTop<target.offsetHeight*1.5)this.fetchNext(false);else{var amount;if(target.scrollTop==0)amount=0;else if(target.scrollHeight-target.scrollTop==target.clientHeight)amount=1;else amount=(target.scrollTop+target.clientHeight*.5)/target.scrollHeight;var now=new Date;if(now-this.getLastLocationUpdate()>this.LOCATION_UPDATE_FREQ||
amount==0||amount==1)this.updateLocationMarker(amount,scrollDir)}this.setLastScrollTop(target.scrollTop)},this);centerPanel.body.on("click",function(event,target){target=Ext.get(target);if(target.hasCls("word")){var info=Voyant.data.model.Token.getInfoFromElement(target);var term=target.getHtml();var data=[{term:term,docIndex:info.docIndex}];this.loadQueryTerms([term]);this.getApplication().dispatchEvent("termsClicked",this,data)}},this);if(this.getCorpus()){this.load();var query=this.getApiParam("query");
if(query)this.loadQueryTerms(Ext.isString(query)?[query]:query)}this.on("loadedCorpus",function(){this.load(true);var query=this.getApiParam("query");if(query)this.loadQueryTerms(Ext.isString(query)?[query]:query)},this)},this);Ext.apply(this,{title:this.localize("title"),cls:"voyant-reader",layout:"fit",items:{layout:"border",items:[{bodyPadding:10,region:"center",border:false,autoScroll:true,html:'\x3cdiv class\x3d"readerContainer"\x3e\x3c/div\x3e'},{xtype:"readergraph",region:"south",height:40,
split:{size:2},splitterResize:true,border:false,listeners:{documentRelativePositionSelected:function(src,data){var doc=this.getDocumentsStore().getAt(data.docIndex);var totalTokens=doc.get("tokensCount-lexical");var position=Math.floor(totalTokens*data.fraction);var bufferPosition=position-this.getApiParam("limit")/2;this.setApiParams({"skipToDocId":doc.getId(),start:bufferPosition<0?0:bufferPosition});this.load(true)},scope:this}}]},dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",
items:[{glyph:"xf060@FontAwesome",handler:function(){this.fetchPrevious(true)},scope:this},{glyph:"xf061@FontAwesome",handler:function(){this.fetchNext(true)},scope:this},{xtype:"tbseparator"},{xtype:"querysearchfield"}]}],listeners:{loadedCorpus:function(src,corpus){this.getTokensStore().setCorpus(corpus);this.getDocumentTermsStore().getProxy().setExtraParam("corpus",corpus.getId());var docs=corpus.getDocuments();this.setDocumentsStore(docs);if(this.rendered){this.load();if(this.hasCorpusAccess(corpus)==
false)this.mask(this.localize("limitedAccess"),"mask-no-spinner");var query=this.getApiParam("query");if(query)this.loadQueryTerms(Ext.isString(query)?[query]:query)}},termsClicked:function(src,terms){var queryTerms=[];terms.forEach(function(term){if(Ext.isString(term))queryTerms.push(term);else if(term.term)queryTerms.push(term.term);else if(term.getTerm)queryTerms.push(term.getTerm())});if(queryTerms.length>0)this.loadQueryTerms(queryTerms)},corpusTermsClicked:function(src,terms){var queryTerms=
[];terms.forEach(function(term){if(term.getTerm())queryTerms.push(term.getTerm())});this.loadQueryTerms(queryTerms)},documentTermsClicked:function(src,terms){var queryTerms=[];terms.forEach(function(term){if(term.getTerm())queryTerms.push(term.getTerm())});this.loadQueryTerms(queryTerms)},documentSelected:function(src,document){var corpus=this.getTokensStore().getCorpus();var doc=corpus.getDocument(document);this.setApiParams({"skipToDocId":doc.getId(),start:0});this.load(true)},documentsClicked:function(src,
documents,corpus){if(documents.length>0){var doc=documents[0];this.setApiParams({"skipToDocId":doc.getId(),start:0});this.load(true)}},termLocationClicked:function(src,terms){if(terms[0]!==undefined){var term=terms[0];var docIndex=term.get("docIndex");var position=term.get("position");var bufferPosition=position-this.getApiParam("limit")/2;var doc=this.getCorpus().getDocument(docIndex);this.setApiParams({"skipToDocId":doc.getId(),start:bufferPosition<0?0:bufferPosition});this.load(true,{callback:function(){var el=
this.body.dom.querySelector("#_"+docIndex+"_"+position);if(el)el.scrollIntoView();this.highlightKeywords(term.get("term"),false)},scope:this})}},documentIndexTermsClicked:function(src,terms){if(terms[0]!==undefined){var term=terms[0];var termRec=Ext.create("Voyant.data.model.Token",term);this.fireEvent("termLocationClicked",this,[termRec])}},scope:this}});this.callParent(arguments)},loadQueryTerms:function(queryTerms){if(queryTerms&&queryTerms.length>0){this.getDocumentTermsStore().load({params:{query:queryTerms}});
this.down("readergraph").loadQueryTerms(queryTerms)}},highlightKeywords:function(query,doScroll){if(!Ext.isArray(query))query=[query];this.getInnerContainer().first().select("span[class*\x3dkeyword]").removeCls("keyword");var spans=[];var caseInsensitiveQuery=new RegExp("^"+query[0]+"$","i");var nodes=this.getInnerContainer().first().select("span.word");nodes.each(function(el,compEl,index){if(el.dom.firstChild&&el.dom.firstChild.nodeValue.match(caseInsensitiveQuery)){el.addCls("keyword");spans.push(el.dom)}})},
fetchPrevious:function(scroll){var readerContainer=this.getInnerContainer().first();var first=readerContainer.first(".word");if(first!=null&&first.hasCls("loading")===false)while(first){if(first.hasCls("word")){var info=Voyant.data.model.Token.getInfoFromElement(first);var docIndex=info.docIndex;var start=info.position;var doc=this.getDocumentsStore().getAt(docIndex);var limit=this.getApiParam("limit");var getPrevDoc=false;if(docIndex===0&&start===0){var scrollContainer=this.down('panel[region\x3d"center"]').body;
var scrollNeeded=first.getScrollIntoViewXY(scrollContainer,scrollContainer.dom.scrollTop,scrollContainer.dom.scrollLeft);if(scrollNeeded.y!=0)first.dom.scrollIntoView();first.frame("red");break}if(docIndex>0&&start===0){getPrevDoc=true;docIndex--;doc=this.getDocumentsStore().getAt(docIndex);var totalTokens=doc.get("tokensCount-lexical");start=totalTokens-limit;if(start<0){start=0;this.setApiParam("limit",totalTokens)}}else{limit--;start-=limit}if(start<0)start=0;var mask=first.insertSibling("\x3cdiv class\x3d'loading'\x3e"+
this.localize("loading")+"\x3c/div\x3e","before",false).mask();if(!getPrevDoc)first.destroy();var id=doc.getId();this.setApiParams({"skipToDocId":id,start:start});this.setInsertWhere("afterBegin");this.setScrollIntoView(scroll);this.load();this.setApiParam("limit",this.INITIAL_LIMIT);break}first.destroy();first=readerContainer.first()}},fetchNext:function(scroll){var readerContainer=this.getInnerContainer().first();var last=readerContainer.last();if(last.hasCls("loading")===false)while(last){if(last.hasCls("word")){var info=
Voyant.data.model.Token.getInfoFromElement(last);var docIndex=info.docIndex;var start=info.position;var doc=this.getDocumentsStore().getAt(info.docIndex);var id=doc.getId();var totalTokens=doc.get("tokensCount-lexical");if(start+this.getApiParam("limit")>=totalTokens&&docIndex==this.getCorpus().getDocumentsCount()-1){var limit=totalTokens-start;if(limit<=1){last.dom.scrollIntoView();last.frame("red");break}else this.setApiParam("limit",limit)}var nextSib=last.dom.nextSibling;while(nextSib){var oldNext=
nextSib;nextSib=nextSib.nextSibling;oldNext.parentNode.removeChild(oldNext)}var mask=last.insertSibling("\x3cdiv class\x3d'loading'\x3e"+this.localize("loading")+"\x3c/div\x3e","after",false).mask();last.destroy();this.setApiParams({"skipToDocId":id,start:info.position});this.setInsertWhere("beforeEnd");this.setScrollIntoView(scroll);this.load();this.setApiParam("limit",this.INITIAL_LIMIT);break}last.destroy();last=readerContainer.last()}},load:function(doClear,config){if(doClear){this.getInnerContainer().first().destroy();
this.getInnerContainer().setHtml('\x3cdiv class\x3d"readerContainer"\x3e\x3cdiv class\x3d"loading"\x3e'+this.localize("loading")+"\x3c/div\x3e\x3c/div\x3e");this.getInnerContainer().first().first().mask()}this.getTokensStore().load(Ext.apply(config||{},{params:Ext.apply(this.getApiParams(),{stripTags:"blocksOnly",stopList:""})}))},updateText:function(contents){var loadingMask=this.getInnerContainer().down(".loading");if(loadingMask)loadingMask.destroy();var inserted=this.getInnerContainer().first().insertHtml(this.getInsertWhere(),
contents,true);if(inserted&&this.getScrollIntoView()){inserted.dom.scrollIntoView();Ext.Function.defer(function(){var el=Ext.get(inserted.id);if(el)el.frame("red")},100)}var target=this.down('panel[region\x3d"center"]').body.dom;var amount;if(target.scrollTop==0)amount=0;else if(target.scrollHeight-target.scrollTop==target.clientHeight)amount=1;else amount=(target.scrollTop+target.clientHeight*.5)/target.scrollHeight;this.updateLocationMarker(amount)},updateLocationMarker:function(amount,scrollDir){var readerWords=
Ext.DomQuery.select(".word",this.getInnerContainer().down(".readerContainer",true));var firstWord=readerWords[0];var lastWord=readerWords[readerWords.length-1];if(firstWord!==undefined&&lastWord!==undefined){var corpus=this.getCorpus();var partialFirstDoc=false;var info1=Voyant.data.model.Token.getInfoFromElement(Ext.get(firstWord));var info2=Voyant.data.model.Token.getInfoFromElement(Ext.get(lastWord));if(info1.position!==0)partialFirstDoc=true;var docTokens={};var totalTokens=0;var currIndex=info1.docIndex;
while(currIndex<=info2.docIndex){var tokens=corpus.getDocument(currIndex).get("tokensCount-lexical");if(currIndex===info2.docIndex)tokens=info2.position;if(currIndex===info1.docIndex)tokens-=info1.position;totalTokens+=tokens;docTokens[currIndex]=tokens;currIndex++}var tokenPos=Math.round(totalTokens*amount);var docIndex=0;var currToken=0;for(var i=info1.docIndex;i<=info2.docIndex;i++){docIndex=i;currToken+=docTokens[i];if(currToken>=tokenPos)break}var remains=currToken-tokenPos;var tokenPosInDoc=
docTokens[docIndex]-remains;if(partialFirstDoc&&docIndex===info1.docIndex)tokenPosInDoc+=info1.position;var fraction=tokenPosInDoc/corpus.getDocument(docIndex).get("tokensCount-lexical");this.down("readergraph").moveLocationMarker(docIndex,fraction,scrollDir)}},updateChart:function(){}});Ext.define("Voyant.panel.SimpleDocReader",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.simpledocreader",isConsumptive:true,statics:{i18n:{},api:{docIndex:undefined,docId:undefined},glyph:"xf0f6@FontAwesome"},config:{},constructor:function(config){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},initComponent:function(config){var me=this;Ext.apply(this,{html:'\x3ciframe style\x3d"width: 100%; height: 100%; border: none;"\x3e\x3c/iframe\x3e',
dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{glyph:"xf060@FontAwesome",handler:this.fetchPrevious,scope:this},{glyph:"xf061@FontAwesome",handler:this.fetchNext,scope:this}]}],listeners:{loadedCorpus:function(src,corpus){if(this.getApiParam("autoLoadOnLoadedCorpus","false")==="true")return;this.fireEvent("documentSelected",this,0)},documentSelected:function(src,document){this.setApiParams({docIndex:this.getCorpus().getDocument(document).getIndex(),docId:undefined});
this.fetch()},scope:this}});this.callParent(arguments)},fetchPrevious:function(){var doc;if(this.getApiParam("docIndex")!==undefined)doc=this.getCorpus().getDocument(this.getApiParam("docIndex"));else if(this.getApiParam("docId")!==undefined)doc=this.getCorpus().getDocument(this.getApiParam("docId"));else doc=this.getCorpus().getDocument(1);if(doc.getIndex()>0){this.setApiParams({docIndex:doc.getIndex()-1,docId:undefined});this.fetch()}else this.toastInfo(this.localize("noPrevious"))},fetchNext:function(){var doc;
if(this.getApiParam("docIndex")!==undefined)doc=this.getCorpus().getDocument(this.getApiParam("docIndex"));else if(this.getApiParam("docId")!==undefined)doc=this.getCorpus().getDocument(this.getApiParam("docId"));else{this.setApiParams({docIndex:0,docId:undefined});return this.fetch()}if(doc.getIndex()<this.getCorpus().getDocumentsCount()-1){this.setApiParams({docIndex:doc.getIndex()+1,docId:undefined});this.fetch()}else this.toastInfo(this.localize("noNext"))},fetch:function(){var doc;if(this.getApiParam("docIndex")!==
undefined)doc=this.getCorpus().getDocument(this.getApiParam("docIndex"));else if(this.getApiParam("docId")!==undefined)doc=this.getCorpus().getDocument(this.getApiParam("docId"));else doc=this.getCorpus().getDocument(0);var iframe=this.getTargetEl().down("iframe",true);iframe.setAttribute("src","about:blank");if(this.getApiParam("originalUrlMetadataKey")){var url=doc.get(this.getApiParam("originalUrlMetadataKey"));if(url){iframe.setAttribute("src",url);return}}var params={corpus:this.getCorpus().getId(),
docIndex:doc.getIndex(),tool:"corpus.DocumentTokens",template:"docTokensPlusStructure2html",outputFormat:"html",limit:0};var url=this.getTromboneUrl()+"?"+Ext.Object.toQueryString(params);iframe.setAttribute("src",url)}});Ext.define("Voyant.panel.ScatterPlot",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],requires:["Ext.chart.CartesianChart"],alias:"widget.scatterplot",statics:{i18n:{},api:{docId:undefined,analysis:"ca",limit:50,dimensions:3,bins:10,clusters:3,perplexity:15,iterations:1500,comparisonType:"relative",stopList:"auto",target:undefined,term:undefined,query:undefined,whitelist:undefined,label:["summary","docs","terms"],storeJson:undefined},glyph:"xf06e@FontAwesome"},config:{options:[{xtype:"stoplistoption"},
{xtype:"categoriesoption"}],caStore:null,pcaStore:null,tsneStore:null,docSimStore:null,termStore:null,chartMenu:null,newTerm:null,termsTimeout:null,highlightData:{x:0,y:0,r:0},highlightTask:null},tokenFreqTipTemplate:null,docFreqTipTemplate:null,constructor:function(config){this.mixins["Voyant.util.Api"].constructor.apply(this,arguments);if("storeJson"in config){var json=JSON.parse(config.storeJson);Ext.apply(config,json)}this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,
arguments)},initComponent:function(){this.setCaStore(Ext.create("Voyant.data.store.CAAnalysis",{listeners:{load:this.maskAndBuildChart,scope:this}}));this.setPcaStore(Ext.create("Voyant.data.store.PCAAnalysis",{listeners:{load:this.maskAndBuildChart,scope:this}}));this.setTsneStore(Ext.create("Voyant.data.store.TSNEAnalysis",{listeners:{load:this.maskAndBuildChart,scope:this}}));this.setDocSimStore(Ext.create("Voyant.data.store.DocSimAnalysis",{listeners:{load:this.maskAndBuildChart,scope:this}}));
this.setTermStore(Ext.create("Ext.data.JsonStore",{fields:[{name:"term"},{name:"rawFreq",type:"int"},{name:"relativeFreq",type:"number"},{name:"coordinates",mapping:"vector"},{name:"category"}],sorters:[{property:"rawFreq",direction:"DESC"}],groupField:"category"}));this.setChartMenu(Ext.create("Ext.menu.Menu",{items:[{text:this.localize("remove"),itemId:"remove",glyph:"xf068@FontAwesome"},{text:this.localize("nearby"),itemId:"nearby",glyph:"xf0b2@FontAwesome"}],listeners:{hide:function(){var series=
this.down("#chart").getSeries();series[0].enableToolTips();series[1].enableToolTips()},scope:this}}));this.tokenFreqTipTemplate=new Ext.Template(this.localize("tokenFreqTip"));this.docFreqTipTemplate=new Ext.Template(this.localize("docFreqTip"));Ext.apply(this,{title:this.localize("title"),layout:"border",autoDestroy:true,items:[{itemId:"chartParent",region:"center",layout:"fit",tbar:{overflowHandler:"scroller",items:[{xtype:"querysearchfield",itemId:"filterTerms",width:150},{text:this.localize("labels"),
itemId:"labels",glyph:"xf02b@FontAwesome",menu:{items:[{text:this.localize("summaryLabel"),itemId:"summary",xtype:"menucheckitem"},{text:this.localize("docsLabel"),itemId:"docs",xtype:"menucheckitem"},{text:this.localize("termsLabel"),itemId:"terms",xtype:"menucheckitem"}],listeners:{afterrender:function(menu){var labels=this.getApiParam("label");menu.items.each(function(item){item.setChecked(labels.indexOf(item.getItemId())>-1)})},click:function(menu,item){var labels=this.getApiParam("label");var label=
item.getItemId();if(Ext.isString(labels))labels=[labels];if(item.checked&&labels.indexOf(label)==-1)labels.push(label);else if(!item.checked&&labels.indexOf(label)>-1)labels=labels.filter(function(item){return item!=label});this.setApiParam("label",labels);this.doLabels();this.queryById("chart").redraw()},scope:this}}}]},listeners:{query:function(component,value){this.getTermStore().filter([{property:"term",value:value,anyMatch:true}]);this.filterChart(value)},scope:this}},{itemId:"optionsPanel",
title:this.localize("options"),region:"west",split:true,collapsible:true,collapseMode:"header",width:135,scrollable:"y",layout:{type:"vbox",align:"stretch"},defaults:{xtype:"button",margin:"5",labelAlign:"top"},items:[{xtype:"label",text:this.localize("input")},{xtype:"documentselectorbutton"},{text:this.localize("freqsMode"),itemId:"comparisonType",glyph:"xf201@FontAwesome",tooltip:this.localize("freqsModeTip"),menu:{items:[{text:this.localize("rawFrequencies"),itemId:"comparisonType_raw",group:"freqsMode",
xtype:"menucheckitem"},{text:this.localize("relativeFrequencies"),itemId:"comparisonType_relative",group:"freqsMode",xtype:"menucheckitem"},{text:this.localize("tfidf"),itemId:"comparisonType_tfidf",group:"freqsMode",xtype:"menucheckitem"}],listeners:{click:function(menu,item){if(item!==undefined){var type=item.getItemId().split("_")[1];if(type!==this.getApiParam("comparisonType")){this.setApiParam("comparisonType",type);this.loadFromApis(true)}}},scope:this}}},{fieldLabel:this.localize("numTerms"),
itemId:"limit",xtype:"numberfield",minValue:5,listeners:{change:function(numb,newValue,oldValue){function doLoad(){this.setApiParam("limit",newValue);this.loadFromApis()}if(oldValue!==null){if(this.getTermsTimeout()!==null)clearTimeout(this.getTermsTimeout());if(numb.isValid())this.setTermsTimeout(setTimeout(doLoad.bind(this),500))}},scope:this}},{xtype:"container",html:'\x3chr style\x3d"border: none; border-top: 1px solid #cfcfcf;"/\x3e'},{xtype:"label",text:this.localize("output")},{text:this.localize("analysis"),
itemId:"analysis",glyph:"xf1ec@FontAwesome",overflowHandler:"scroller",menu:{items:[{text:this.localize("pca"),itemId:"analysis_pca",group:"analysis",xtype:"menucheckitem"},{text:this.localize("ca"),itemId:"analysis_ca",group:"analysis",xtype:"menucheckitem"},{text:this.localize("tsne"),itemId:"analysis_tsne",group:"analysis",xtype:"menucheckitem"},{text:this.localize("docSim"),itemId:"analysis_docSim",group:"analysis",xtype:"menucheckitem"}],listeners:{click:function(menu,item){if(item!==undefined){var analysis=
item.getItemId().split("_")[1];if(analysis!==this.getApiParam("analysis")){this.doAnalysisChange(analysis);this.loadFromApis(true)}}},scope:this}}},{fieldLabel:this.localize("perplexity"),itemId:"perplexity",xtype:"slider",minValue:5,maxValue:100,increment:1,listeners:{changecomplete:function(slider,newValue){this.setApiParam("perplexity",newValue);this.loadFromApis(true)},scope:this}},{fieldLabel:this.localize("iterations"),itemId:"iterations",xtype:"slider",minValue:100,maxValue:5E3,increment:100,
listeners:{changecomplete:function(slider,newValue){this.setApiParam("iterations",newValue);this.loadFromApis(true)},scope:this}},{text:this.localize("clusters"),itemId:"clusters",glyph:"xf192@FontAwesome",menu:{items:[{text:"1",itemId:"clusters_1",group:"clusters",xtype:"menucheckitem"},{text:"2",itemId:"clusters_2",group:"clusters",xtype:"menucheckitem"},{text:"3",itemId:"clusters_3",group:"clusters",xtype:"menucheckitem"},{text:"4",itemId:"clusters_4",group:"clusters",xtype:"menucheckitem"},{text:"5",
itemId:"clusters_5",group:"clusters",xtype:"menucheckitem"}],listeners:{click:function(menu,item){if(item!==undefined){var clusters=parseInt(item.getItemId().split("_")[1]);if(clusters!==this.getApiParam("clusters")){this.setApiParam("clusters",clusters);this.loadFromApis(true)}}},scope:this}}},{text:this.localize("dimensions"),itemId:"dimensions",glyph:"xf1b2@FontAwesome",menu:{items:[{text:"2",itemId:"dimensions_2",group:"dimensions",xtype:"menucheckitem"},{text:"3",itemId:"dimensions_3",group:"dimensions",
xtype:"menucheckitem"}],listeners:{click:function(menu,item){if(item!==undefined){var dims=parseInt(item.getItemId().split("_")[1]);if(dims!==this.getApiParam("dimensions")){if(dims==3&&this.getApiParam("analysis")=="ca"&&this.getCorpus().getDocumentsCount()==3){dims=2;return false}this.setApiParam("dimensions",dims);this.loadFromApis(true)}}},scope:this}}},{itemId:"reloadButton",text:this.localize("reload"),glyph:"xf021@FontAwesome",handler:function(){this.loadFromApis()},scope:this}]},{itemId:"termsGrid",
xtype:"grid",title:this.localize("terms"),region:"east",width:250,split:true,collapsible:true,collapseMode:"header",forceFit:true,features:[{ftype:"grouping",hideGroupedHeader:true,enableGroupingMenu:false}],bbar:{overflowHandler:"scroller",items:[{itemId:"nearbyButton",xtype:"button",text:this.localize("nearby"),glyph:"xf0b2@FontAwesome",flex:1,handler:function(btn){var sel=btn.up("panel").getSelection()[0];if(sel===undefined)this.toastError({html:this.localize("noTermSelected"),anchor:btn.up("panel").getTargetEl()});
else{var term=sel.get("term");this.getNearbyForTerm(term)}},scope:this},{itemId:"removeButton",xtype:"button",text:this.localize("remove"),glyph:"xf068@FontAwesome",flex:1,handler:function(btn){var sel=btn.up("panel").getSelection()[0];if(sel===undefined)this.toastError({html:this.localize("noTermSelected"),anchor:btn.up("panel").getTargetEl()});else{var term=sel.get("term");this.removeTerm(term)}},scope:this}]},tbar:{overflowHandler:"scroller",items:[{xtype:"querysearchfield",itemId:"addTerms",flex:1}]},
columns:[{text:this.localize("term"),dataIndex:"term",flex:1,sortable:true},{text:this.localize("rawFreq"),dataIndex:"rawFreq",flex:.75,minWidth:70,sortable:true},{text:this.localize("relFreq"),dataIndex:"relativeFreq",flex:.75,minWidth:70,sortable:true,hidden:true}],selModel:{type:"rowmodel",mode:"SINGLE",allowDeselect:true,toggleOnClick:true,listeners:{selectionchange:{fn:function(sm,selections){var sel=selections[0];if(sel!==undefined){var term=sel.get("term");var isDoc=sel.get("category")==="document";
this.selectTerm(term,isDoc);if(isDoc){this.queryById("nearbyButton").disable();this.queryById("removeButton").disable()}else{this.queryById("nearbyButton").enable();this.queryById("removeButton").enable()}}else this.selectTerm()},scope:this}}},store:this.getTermStore(),listeners:{expand:function(panel){panel.getView().refresh()},query:function(component,value){if(value.length>0&&this.getTermStore().findExact("term",value[0])===-1){this.setNewTerm(value);this.loadFromApis()}else this.setNewTerm(null)},
scope:this}}]});this.on("boxready",function(component,width,height){if(width<400){this.queryById("optionsPanel").collapse();this.queryById("termsGrid").collapse()}if(this.config.storeClass&&this.config.storeData)this.loadStoreFromJson(this.config.storeClass,this.config.storeData)},this);this.on("beforedestroy",function(component){var oldChart=this.queryById("chart");if(oldChart!==null)this.queryById("chartParent").remove(oldChart)},this);this.on("loadedCorpus",function(src,corpus){function setCheckItemFromApi(apiParamName){var value=
this.getApiParam(apiParamName);var menu=this.queryById(apiParamName);var item=menu.down("#"+apiParamName+"_"+value);item.setChecked(true)}var setCheckBound=setCheckItemFromApi.bind(this);setCheckBound("analysis");this.doAnalysisChange(this.getApiParam("analysis"));setCheckBound("comparisonType");setCheckBound("clusters");this.queryById("perplexity").setValue(this.getApiParam("perplexity"));this.queryById("iterations").setValue(this.getApiParam("iterations"));if(corpus.getDocumentsCount()==3)this.setApiParam("dimensions",
2);setCheckBound("dimensions");this.getCaStore().setCorpus(corpus);this.getPcaStore().setCorpus(corpus);this.getDocSimStore().setCorpus(corpus);this.loadFromApis()},this);this.on("documentsSelected",function(src,docIds){this.setApiParam("docId",docIds);this.loadFromApis()},this);this.callParent(arguments)},doAnalysisChange:function(analysis){this.setApiParam("analysis",analysis);this.queryById("nearbyButton").setDisabled(analysis==="tsne");this.queryById("reloadButton").setVisible(analysis==="tsne");
this.queryById("perplexity").setVisible(analysis==="tsne");this.queryById("iterations").setVisible(analysis==="tsne");if(analysis==="ca")if(this.getCorpus().getDocumentsCount()==3){this.setApiParam("dimensions",2);this.queryById("dimensions").menu.items.get(0).setChecked(true)}},loadStoreFromJson:function(storeClass,storeData){if(storeClass=="Voyant.data.store.CAAnalysis"){this.getCaStore().loadRawData(storeData);this.doAnalysisChange("ca");this.maskAndBuildChart.call(this,this.getCaStore())}else if(storeClass==
"Voyant.data.store.PCAAnalysis"){this.getPcaStore().loadRawData(storeData);this.doAnalysisChange("pca");this.maskAndBuildChart.call(this,this.getPcaStore())}else if(storeClass=="Voyant.data.store.TSNEAnalysis"){this.getTsneStore().loadRawData(storeData);this.doAnalysisChange("tsne");this.maskAndBuildChart.call(this,this.getTsneStore())}else if(storeClass=="Voyant.data.store.DocSimAnalysis"){this.getDocSimStore().loadRawData(storeData);this.doAnalysisChange("docSim");this.maskAndBuildChart.call(this,
this.getDocSimStore())}},maskAndBuildChart:function(store){this.queryById("chartParent").mask(this.localize("plotting"));Ext.defer(this.buildChart,50,this,[store])},buildChart:function(store){var that=this;var oldChart=this.queryById("chart");if(oldChart!==null)this.queryById("chartParent").remove(oldChart);this.queryById("termsGrid").getSelectionModel().deselectAll();var rec=store.getAt(0);var numDims=this.getApiParam("dimensions");var summary="";if(this.getApiParam("analysis")==="pca"){var pcs=
rec.getPrincipalComponents();var eigenTotal=0;for(var i=0;i<pcs.length;i++){var pc=pcs[i];eigenTotal+=parseFloat(pc.get("eigenValue"))}if(eigenTotal==0);else{summary=this.localize("pcTitle")+"\n";var pcMapping=["xAxis","yAxis","fill"];for(var i=0;i<pcs.length;i++){if(i>=numDims)break;var eigenValue=pcs[i].get("eigenValue");var percentage=eigenValue/eigenTotal*100;summary+=this.localize("pc")+" "+(i+1)+" ("+this.localize(pcMapping[i])+"): "+Math.round(percentage*100)/100+"%\n"}}}else if(this.getApiParam("analysis")===
"tsne");else{summary=this.localize("caTitle")+"\n";var pcMapping=["xAxis","yAxis","fill"];var dimensions=rec.getDimensions();for(var i=0;i<dimensions.length;i++){if(i>=numDims)break;var percentage=dimensions[i].get("percentage");summary+=this.localize("dimension")+" "+(i+1)+" ("+this.localize(pcMapping[i])+"): "+Math.round(percentage*100)/100+"%\n"}}var maxFreq=0;var minFreq=Number.MAX_VALUE;var maxFill=0;var minFill=Number.MAX_VALUE;if(this.getApiParam("analysis")!=="docSim")this.getTermStore().removeAll();
var tokens=rec.getTokens();var termData=[];var docData=[];tokens.forEach(function(token){var freq=token.get("rawFreq");var category=token.get("category");if(category===undefined){category="term";token.set("category","term")}var isTerm=category==="term";if(isTerm){if(freq>maxFreq)maxFreq=freq;if(freq<minFreq)minFreq=freq}if(this.getTermStore().findExact("term",token.get("term")===-1))this.getTermStore().addSorted(token);if(numDims===3){var z=token.get("vector")[2];if(z!==undefined){if(z<minFill)minFill=
z;if(z>maxFill)maxFill=z}}var tokenData={x:token.get("vector")[0],y:token.get("vector")[1]||0,z:token.get("vector")[2]||0,term:token.get("term"),rawFreq:freq,relativeFreq:token.get("relativeFreq"),cluster:token.get("cluster"),category:category,disabled:false};if(!isTerm){if(token.get("category")==="bin")tokenData.term=tokenData.title="Bin "+token.get("docIndex");else{tokenData.docIndex=token.get("docIndex");var doc=this.getCorpus().getDocument(tokenData.docIndex);if(doc!==null){tokenData.term=doc.getShortTitle();
tokenData.title=doc.getTitle()}}docData.push(tokenData)}else termData.push(tokenData)},this);var newCount=this.getTermStore().getCount();this.queryById("limit").setRawValue(newCount);this.setApiParam("limit",newCount);var termSeriesStore=Ext.create("Ext.data.JsonStore",{fields:["term","x","y","z","rawFreq","relativeFreq","cluster","category","docIndex","disabled"],data:termData});var docSeriesStore=Ext.create("Ext.data.JsonStore",{fields:["term","x","y","z","rawFreq","relativeFreq","cluster","category",
"docIndex","disabled"],data:docData});var config={itemId:"chart",xtype:"cartesian",interactions:["crosszoom","panzoom","itemhighlight"],plugins:{ptype:"chartitemevents"},axes:[{type:"numeric",position:"bottom",fields:["x"],label:{rotate:{degrees:-30}}},{type:"numeric",position:"left",fields:["y"]}],sprites:[{type:"text",text:summary,x:70,y:70}],innerPadding:{top:25,right:25,bottom:25,left:25},series:[{type:"customScatter",xField:"x",yField:"y",store:termSeriesStore,label:{font:"14px Helvetica",field:"term",
display:"over"},tooltip:{trackMouse:true,style:"background: #fff",renderer:function(toolTip,record,ctx){toolTip.setHtml(that.tokenFreqTipTemplate.apply([record.get("term"),record.get("rawFreq"),record.get("relativeFreq")]))}},marker:{type:"circle"},highlight:{fillStyle:"yellow",strokeStyle:"black"},renderer:function(sprite,config,rendererData,index){var store=rendererData.store;var item=store.getAt(index);if(item!==null){var clusterIndex=item.get("cluster");var scatterplot=that;if(clusterIndex===
-1)clusterIndex=0;var fillAlpha=.65;var strokeAlpha=1;if(item.get("disabled")===true){fillAlpha=.1;strokeAlpha=.1}else if(numDims===3&&item.get("z"))fillAlpha=scatterplot.interpolate(item.get("z"),minFill,maxFill,0,1);var color=scatterplot.getApplication().getColor(clusterIndex);config.fillStyle="rgba("+color.join(",")+","+fillAlpha+")";config.strokeStyle="rgba("+color.join(",")+","+strokeAlpha+")";var freq=item.get("rawFreq");var radius=scatterplot.interpolate(freq,minFreq,maxFreq,2,20);config.radius=
radius}},scope:this},{type:"customScatter",xField:"x",yField:"y",store:docSeriesStore,label:{font:"14px Helvetica",field:"term",display:"over",color:this.getDefaultDocColor(true)},tooltip:{trackMouse:true,style:"background: #fff",renderer:function(toolTip,record,ctx){toolTip.setHtml(that.docFreqTipTemplate.apply([record.get("title"),record.get("rawFreq")]))}},marker:{type:"diamond"},highlight:{fillStyle:"yellow",strokeStyle:"black"},renderer:function(sprite,config,rendererData,index){var store=rendererData.store;
var item=store.getAt(index);if(item!==null){var clusterIndex=item.get("cluster");var scatterplot=that;var color;if(clusterIndex===-1||scatterplot.getApiParam("analysis")!=="docSim")color=scatterplot.getDefaultDocColor();else color=scatterplot.getApplication().getColor(clusterIndex);var a=.65;if(numDims===3&&item.get("z"))a=scatterplot.interpolate(item.get("z"),minFill,maxFill,0,1);config.fillStyle="rgba("+color.join(",")+","+a+")";config.strokeStyle="rgba("+color.join(",")+",1)";config.radius=5}},
scope:this}],listeners:{itemclick:function(chart,item,event){var data=item.record.data;if(data.category==="doc"){var record=this.getCorpus().getDocument(data.docIndex);this.getApplication().dispatchEvent("documentsClicked",this,[record])}else if(data.category==="term"){var record=Ext.create("Voyant.data.model.CorpusTerm",data);this.getApplication().dispatchEvent("corpusTermsClicked",this,[record])}},render:function(chart){chart.body.on("contextmenu",function(event,target){event.preventDefault();var xy=
event.getXY();var parentXY=Ext.fly(target).getXY();var x=xy[0]-parentXY[0];var y=xy[1]-parentXY[1];var chartItem=this.down("#chart").getItemForPoint(x,y);if(chartItem!=null&&chartItem.record.get("category")==="term"){var series=this.down("#chart").getSeries();series[0].disableToolTips();series[1].disableToolTips();var term=chartItem.record.get("term");var text=(new Ext.Template(this.localize("removeTerm"))).apply([term]);this.getChartMenu().queryById("remove").setText(text);text=(new Ext.Template(this.localize("nearbyTerm"))).apply([term]);
var nearby=this.getChartMenu().queryById("nearby");nearby.setText(text);nearby.setDisabled(this.getApiParam("analysis")==="tsne");this.getChartMenu().on("click",function(menu,item){if(item!==undefined){var term=chartItem.record.get("term");if(item.getItemId()==="nearby")this.getNearbyForTerm(term);else this.removeTerm(term)}},this,{single:true});this.getChartMenu().showAt(xy)}},this)},scope:this}};var chart=Ext.create("Ext.chart.CartesianChart",config);this.queryById("chartParent").insert(0,chart);
this.queryById("chartParent").unmask();this.doLabels();if(this.getNewTerm()!==null){this.selectTerm(this.getNewTerm()[0]);this.setNewTerm(null)}},getDefaultDocColor:function(returnHex){var color=this.getApplication().getColor(6,returnHex);return color},doLabels:function(){var chart=this.queryById("chart");var series=chart.getSeries();var summary=chart.getSurface("chart").getItems()[0];var labels=this.getApiParam("label");if(labels.indexOf("summary")>-1)summary.show();else summary.hide();if(labels.indexOf("terms")>
-1)series[0].getLabel().show();else series[0].getLabel().hide();if(labels.indexOf("docs")>-1)series[1].getLabel().show();else series[1].getLabel().hide()},selectTerm:function(term,isDoc){var chart=this.down("#chart");if(chart!==null)if(term===undefined){chart.getSeries()[0].setHighlightItem(null);chart.getSeries()[1].setHighlightItem(null)}else{var series,index;if(isDoc===true){series=chart.getSeries()[1];index=series.getStore().findExact("title",term)}else{series=chart.getSeries()[0];index=series.getStore().findExact("term",
term)}if(index!==-1){var record=series.getStore().getAt(index);var sprite=series.getSprites()[0];var item={series:series,category:series.getItemInstancing()?"items":"markers",index:index,record:record,field:series.getYField(),sprite:sprite};series.setHighlightItem(item);if(isDoc)chart.getSeries()[0].setHighlightItem(null);else chart.getSeries()[1].setHighlightItem(null);var point=this.getPointFromIndex(series,index);this.setHighlightData({x:point[0],y:point[1],r:50});if(this.getHighlightTask()==null)this.setHighlightTask(Ext.TaskManager.newTask({run:this.doHighlight,
scope:this,interval:25,repeat:this.getHighlightData().r}));this.getHighlightTask().restart()}}},getPointFromIndex:function(series,index){var sprite=series.getSprites()[0];if(sprite.surfaceMatrix!==null){var matrix=sprite.attr.matrix.clone().prependMatrix(sprite.surfaceMatrix);var dataX=sprite.attr.dataX[index];var dataY=sprite.attr.dataY[index];return matrix.transformPoint([dataX,dataY])}else return[0,0]},doHighlight:function(){var chart=this.down("#chart");if(this.getHighlightData().r>0){var surf=
chart.getSurface();var highlight=null;var items=surf.getItems();for(var i=0;i<items.length;i++){var item=items[i];if(item.id=="customHighlight"){highlight=item;break}}if(highlight==null)surf.add({id:"customHighlight",type:"circle",strokeStyle:"red",fillStyle:"none",radius:this.getHighlightData().r,x:this.getHighlightData().x,y:this.getHighlightData().y});else{highlight.setAttributes({x:this.getHighlightData().x,y:this.getHighlightData().y,radius:this.getHighlightData().r});this.getHighlightData().r-=
1.5;if(this.getHighlightData().r<=0){this.getHighlightData().r=0;surf.remove(highlight,true)}}chart.redraw()}},filterChart:function(query){if(Ext.isString(query))query=[query];var reQueries=[];for(var i=0;i<query.length;i++){var re=new RegExp(query[i]);reQueries.push(re)}var chart=this.queryById("chart");var series0=chart.getSeries()[0];var label0=series0.getLabel();series0.getStore().each(function(item){var match=false;if(reQueries.length==0)match=true;else for(var i=0;i<reQueries.length;i++){match=
match||reQueries[i].test(item.get("term"));if(match)break}item.set("disabled",!match);var index=item.store.indexOf(item);label0.setAttributesFor(index,{hidden:!match})},this);chart.redraw()},getCurrentTerms:function(){var terms=[];this.getTermStore().each(function(r){if(r.get("category")==="term")terms.push(r.get("term"))});return terms},getNearbyForTerm:function(term){var limit=Math.max(2E3,Math.round(this.getCorpus().getWordTokensCount()/100));this.setApiParams({limit:limit,target:term});this.loadFromApis();
this.setApiParam("target",undefined)},removeTerm:function(term){var series=this.down("#chart").getSeries()[0];var index=series.getStore().findExact("term",term);series.getStore().removeAt(index);index=this.getTermStore().findExact("term",term);this.getTermStore().removeAt(index);var newCount=this.getTermStore().getCount();this.queryById("limit").setRawValue(newCount)},loadFromApis:function(keepCurrentTerms){this.queryById("chartParent").mask(this.localize("analyzing"));var params={};var terms=this.getCurrentTerms();
if(this.getNewTerm()!==null){terms=terms.concat(this.getNewTerm());this.setApiParam("limit",terms.length)}if(terms.length>0)if(this.getNewTerm()!==null||keepCurrentTerms)params.query=terms.join(",");Ext.apply(params,this.getApiParams());if(params.target!=null)params.term=terms;if(params.analysis==="pca")this.getPcaStore().load({params:params});else if(params.analysis==="tsne")this.getTsneStore().load({params:params});else if(params.analysis==="docSim")this.getDocSimStore().load({params:params});else this.getCaStore().load({params:params})},
interpolate:function(lambda,minSrc,maxSrc,minDst,maxDst){return minDst+(maxDst-minDst)*Math.max(0,Math.min(1,(lambda-minSrc)/(maxSrc-minSrc)))}});Ext.define("Ext.chart.series.CustomScatter",{extend:"Ext.chart.series.Scatter",alias:"series.customScatter",type:"customScatter",seriesType:"scatterSeries",tipsDisabled:false,enableToolTips:function(){this.tipsDisabled=false},disableToolTips:function(){this.tipsDisabled=true},showTip:function(item,xy){if(this.tipsDisabled)return;this.callParent(arguments)}});Ext.define("Voyant.panel.StreamGraph",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.streamgraph",statics:{i18n:{},api:{limit:5,stopList:"auto",query:undefined,withDistributions:"relative",bins:50,docIndex:undefined,docId:undefined},glyph:"xf1fe@FontAwesome"},config:{visLayout:undefined,vis:undefined,mode:"corpus",layerData:undefined,graphId:undefined,options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"}]},graphMargin:{top:20,right:60,bottom:110,left:80},MODE_CORPUS:"corpus",
MODE_DOCUMENT:"document",constructor:function(config){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.setGraphId(Ext.id(null,"streamgraph_"))},initComponent:function(){var me=this;Ext.apply(me,{title:this.localize("title"),tbar:new Ext.Toolbar({overflowHandler:"scroller",items:["-\x3e",{xtype:"legend",store:new Ext.data.JsonStore({fields:["name","mark","active"]}),listeners:{itemclick:function(view,record,el,index){var isActive=Ext.fly(el.firstElementChild).hasCls("x-legend-inactive");
record.set("active",isActive);var terms=this.getCurrentTerms();this.setApiParams({query:terms,limit:terms.length,stopList:undefined,categories:this.getApiParam("categories")});this.loadFromCorpus()},scope:this}},"-\x3e"]}),bbar:{overflowHandler:"scroller",items:[{xtype:"querysearchfield"},{xtype:"button",text:this.localize("clearTerms"),handler:function(){this.setApiParams({query:undefined});this.loadFromRecords([])},scope:this},{xtype:"corpusdocumentselector",singleSelect:true},{text:this.localize("freqsMode"),
glyph:"xf201@FontAwesome",tooltip:this.localize("freqsModeTip"),menu:{items:[{text:this.localize("relativeFrequencies"),checked:true,itemId:"relative",group:"freqsMode",checkHandler:function(item,checked){if(checked){this.setApiParam("withDistributions","relative");this.loadFromCorpus()}},scope:this},{text:this.localize("rawFrequencies"),checked:false,itemId:"raw",group:"freqsMode",checkHandler:function(item,checked){if(checked){this.setApiParam("withDistributions","raw");this.loadFromCorpus()}},
scope:this}]}},{xtype:"slider",itemId:"segmentsSlider",fieldLabel:this.localize("segments"),labelAlign:"right",labelWidth:70,width:150,increment:10,minValue:10,maxValue:300,listeners:{afterrender:function(slider){slider.setValue(this.getApiParam("bins"))},changecomplete:function(slider,newvalue){this.setApiParams({bins:newvalue});this.loadFromCorpus()},scope:this}}]}});this.on("loadedCorpus",function(src,corpus){if(this.getCorpus().getDocumentsCount()==1&&this.getMode()!=this.MODE_DOCUMENT)this.setMode(this.MODE_DOCUMENT);
if(!("bins"in this.getModifiedApiParams()))if(this.getMode()==this.MODE_CORPUS){var count=corpus.getDocumentsCount();var binsMax=100;this.setApiParam("bins",count>binsMax?binsMax:count)}if(this.isVisible())this.loadFromCorpus()},this);this.on("corpusSelected",function(src,corpus){if(src.isXType("corpusdocumentselector")){this.setMode(this.MODE_CORPUS);this.setApiParams({docId:undefined,docIndex:undefined});this.setCorpus(corpus);this.loadFromCorpus()}});this.on("documentSelected",function(src,doc){var docId=
doc.getId();this.setApiParam("docId",docId);this.loadFromDocumentTerms()},this);this.on("query",function(src,query){var terms=this.getCurrentTerms();terms.push(query);this.setApiParams({query:terms,limit:terms.length,stopList:undefined});if(this.getMode()===this.MODE_DOCUMENT)this.loadFromDocumentTerms();else this.loadFromCorpusTerms(this.getCorpus().getCorpusTerms())},this);this.on("resize",this.resizeGraph,this);this.on("boxready",this.initGraph,this);me.callParent(arguments)},loadFromCorpus:function(){var corpus=
this.getCorpus();if(this.getApiParam("docId")||this.getApiParam("docIndex"))this.loadFromDocumentTerms();else if(corpus.getDocumentsCount()==1)this.loadFromDocument(corpus.getDocument(0));else this.loadFromCorpusTerms(corpus.getCorpusTerms())},loadFromCorpusTerms:function(corpusTerms){var params=this.getApiParams(["limit","stopList","query","withDistributions","bins","categories"]);if(params.bins&&params.bins>this.getCorpus().getDocumentsCount())params.bins=this.getCorpus().getDocumentsCount();corpusTerms.load({callback:function(records,
operation,success){if(success){this.setMode(this.MODE_CORPUS);this.loadFromRecords(records)}else Voyant.application.showResponseError(this.localize("failedGetCorpusTerms"),operation)},scope:this,params:params})},loadFromDocument:function(document){if(document.then){var me=this;document.then(function(document){me.loadFromDocument(document)})}else{var ids=[];if(Ext.getClassName(document)=="Voyant.data.model.Document"){this.setApiParams({docIndex:undefined,query:undefined,docId:document.getId()});if(this.isVisible())this.loadFromDocumentTerms()}}},
loadFromDocumentTerms:function(documentTerms){if(this.getCorpus()){documentTerms=documentTerms||this.getCorpus().getDocumentTerms({autoLoad:false});documentTerms.load({callback:function(records,operation,success){if(success){this.setMode(this.MODE_DOCUMENT);this.loadFromRecords(records)}else Voyant.application.showResponseError(this.localize("failedGetDocumentTerms"),operation)},scope:this,params:this.getApiParams(["docId","docIndex","limit","stopList","query","withDistributions","bins","categories"])})}},
loadFromRecords:function(records){var legendData=[];var layers=[];records.forEach(function(record,index){var key=record.getTerm();var values=record.get("distributions");for(var i=0;i<values.length;i++){if(layers[i]===undefined)layers[i]={};layers[i][key]=values[i]}legendData.push({id:key,name:key,mark:this.getApplication().getColorForTerm(key,true),active:true})},this);this.setLayerData(layers);this.down("[xtype\x3dlegend]").getStore().loadData(legendData);this.doLayout()},doLayout:function(layers){var layers=
this.getLayerData();if(layers!==undefined){var me=this;var keys=[];this.down("[xtype\x3dlegend]").getStore().each(function(r){keys.push(r.getId())});var steps;if(this.getMode()===this.MODE_DOCUMENT)steps=this.getApiParam("bins");else{var bins=this.getApiParam("bins");var docsCount=this.getCorpus().getDocumentsCount();steps=bins<docsCount?bins:docsCount}this.getVisLayout().keys(keys);var processedLayers=this.getVisLayout()(layers);var width=this.body.down("svg").getWidth()-this.graphMargin.left-this.graphMargin.right;
var x=d3.scaleLinear().domain([0,steps-1]).range([0,width]);var min=d3.min(processedLayers,function(layer){return d3.min(layer,function(d){return d[0]})});var max=d3.max(processedLayers,function(layer){return d3.max(layer,function(d){return d[1]})});var height=this.body.down("svg").getHeight()-this.graphMargin.top-this.graphMargin.bottom;var y=d3.scaleLinear().domain([min,max]).range([height,0]);var area=d3.area().x(function(d,i){return x(i)}).y0(function(d){return y(d[0])}).y1(function(d){return y(d[1])}).curve(d3.curveCatmullRom);
var xAxis;if(this.getMode()===this.MODE_CORPUS){var xAxisDomain=[];this.getCorpus().getDocuments().each(function(doc){xAxisDomain.push(doc.getTinyLabel())});var xAxisScale=d3.scalePoint().domain(xAxisDomain).range([0,width]);xAxis=d3.axisBottom(xAxisScale)}else xAxis=d3.axisBottom(x);var yAxis=d3.axisLeft(y);var paths=this.getVis().selectAll("path").data(processedLayers,function(d){return d});paths.attr("d",function(d){return area(d)}).style("fill",function(d){return me.getApplication().getColorForTerm(d.key,
true)}).select("title").text(function(d){return d.key});paths.enter().append("path").attr("d",function(d){return area(d)}).style("fill",function(d){return me.getApplication().getColorForTerm(d.key,true)}).append("title").text(function(d){return d.key});paths.exit().remove();this.getVis().selectAll("g.axis").remove();this.getVis().append("g").attr("class","axis x").attr("transform","translate(0,"+height+")").call(xAxis);var xAxisText;if(this.getMode()===this.MODE_CORPUS){this.getVis().select("g.axis.x").selectAll("text").each(function(){d3.select(this).attr("text-anchor",
"end").attr("transform","rotate(-45)")});xAxisText=this.localize("documents")}else xAxisText=this.localize("documentSegments");this.getVis().select("g.axis.x").append("text").attr("text-anchor","middle").attr("transform","translate("+width/2+", "+(this.graphMargin.bottom-30)+")").attr("fill","#000").text(xAxisText);this.getVis().append("g").attr("class","axis y").attr("transform","translate(0,0)").call(yAxis);var yAxisText;if(this.getApiParam("withDistributions")==="raw")yAxisText=this.localize("rawFrequencies");
else yAxisText=this.localize("relativeFrequencies");this.getVis().select("g.axis.y").append("text").attr("text-anchor","middle").attr("transform","translate(-"+(this.graphMargin.left-20)+", "+height/2+") rotate(-90)").attr("fill","#000").text(yAxisText)}},getCurrentTerms:function(){var terms=[];this.down("[xtype\x3dlegend]").getStore().each(function(record){if(record.get("active"))terms.push(record.get("name"))},this);return terms},initGraph:function(){if(this.getVisLayout()===undefined){var el=this.getLayout().getRenderTarget();
this.setVisLayout(d3.stack().offset(d3.stackOffsetWiggle).order(d3.stackOrderInsideOut));this.setVis(d3.select(el.dom).append("svg").attr("id",this.getGraphId()).append("g").attr("transform","translate("+this.graphMargin.left+","+this.graphMargin.top+")"));this.resizeGraph()}},resizeGraph:function(){var el=this.body;var width=el.getWidth();var height=el.getHeight();d3.select(el.dom).select("svg").attr("width",width).attr("height",height);this.doLayout()}});Ext.define("Voyant.panel.Summary",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.summary",statics:{i18n:{},api:{stopList:"auto",start:0,limit:5,numberOfDocumentsForDistinctiveWords:10},glyph:"xf1ea@FontAwesome"},config:{options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"}]},autoScroll:true,cls:"corpus-summary",constructor:function(config){Ext.apply(this,{title:this.localize("title"),items:{itemId:"main",cls:"main",margin:10},dockedItems:[{dock:"bottom",xtype:"toolbar",
overflowHandler:"scroller",items:[{fieldLabel:this.localize("items"),labelWidth:40,width:120,xtype:"slider",increment:5,minValue:5,maxValue:59,listeners:{afterrender:function(slider){slider.setValue(this.getApiParam("limit"))},changecomplete:function(slider,newvalue){this.setApiParams({limit:newvalue});this.loadSummary()},scope:this}}]}]});this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("afterrender",function(){this.body.addListener("click",function(e){var target=
e.getTarget(null,null,true);if(target&&target.dom.tagName=="A")if(target.hasCls("document-id")){var docId=target.getAttribute("val","voyant");var doc=this.getCorpus().getDocuments().getById(docId);this.dispatchEvent("documentsClicked",this,[doc])}else if(target.hasCls("corpus-type"))this.dispatchEvent("termsClicked",this,[target.getHtml()]);else if(target.hasCls("document-type"))this.dispatchEvent("documentIndexTermsClicked",this,[{term:target.getHtml(),docIndex:target.getAttribute("docIndex","voyant")}])},
this)});this.on("loadedCorpus",function(src,corpus){if(this.rendered)this.loadSummary();else this.on("afterrender",function(){this.loadSummary()},this)});if(config&&config.corpus)this.fireEvent("loadedCorpus",this,config.corpus);this.on("resize",function(){var available=this.getWidth()-200;this.query("sparklineline").forEach(function(spark){if(spark.getWidth()>available)spark.setWidth(available)})},this)},loadSummary:function(){var me=this;var main=this.queryById("main");main.removeAll();main.add({html:this.getCorpus().getString()});
var docs=this.getCorpus().getDocuments().getRange();var limit=this.getApiParam("limit");if(docs.length>1){docs.sort(function(d1,d2){return d2.getLexicalTokensCount()-d1.getLexicalTokensCount()});var docsLengthTpl=new Ext.XTemplate('\x3ctpl for\x3d"." between\x3d"; "\x3e\x3ca href\x3d"#" onclick\x3d"return false" class\x3d"document-id" voyant:val\x3d"{id}" data-qtip\x3d"{title}"\x3e{shortTitle}\x3c/a\x3e\x3cspan style\x3d"font-size: smaller"\x3e (\x3cspan class\x3d"info-tip" data-qtip\x3d"{valTip}"\x3e{val}\x3c/span\x3e)\x3c/span\x3e\x3c/a\x3e\x3c/tpl\x3e');
var sparkWidth;if(docs.length<25)sparkWidth=docs.length*4;else if(docs.length<50)sparkWidth=docs.length*2;else if(docs.length>100){var available=main.getWidth()-200;sparkWidth=available<docs.length?docs.length:available}var numberOfTerms=this.localize("numberOfTerms");main.add({cls:"section",items:[{layout:"hbox",align:"bottom",items:[{html:this.localize("docsLength"),cls:"header"},{xtype:"sparklineline",values:this.getCorpus().getDocuments().getRange().map(function(doc){return doc.getLexicalTokensCount()}),
tipTpl:new Ext.XTemplate("{[this.getDocumentTitle(values.x,values.y)]}",{getDocumentTitle:function(docIndex,len){return"("+len+") "+this.panel.getCorpus().getDocument(docIndex).getTitle()},panel:me}),height:16,width:sparkWidth}]},{html:"\x3cul\x3e\x3cli\x3e"+this.localize("longest")+" "+docsLengthTpl.apply(docs.slice(0,docs.length>limit?limit:parseInt(docs.length/2)).map(function(doc){return{id:doc.getId(),shortTitle:doc.getShortTitle(),title:doc.getTitle(),val:doc.getLexicalTokensCount(),valTip:numberOfTerms}}))+
"\x3c/li\x3e"+"\x3cli\x3e"+this.localize("shortest")+" "+docsLengthTpl.apply(docs.slice(-(docs.length>limit?limit:parseInt(docs.length/2))).reverse().map(function(doc){return{id:doc.getId(),shortTitle:doc.getShortTitle(),title:doc.getTitle(),val:doc.getLexicalTokensCount(),valTip:numberOfTerms}}))+"\x3c/li\x3e"}]});docs.sort(function(d1,d2){return d2.getLexicalTypeTokenRatio()-d1.getLexicalTypeTokenRatio()});main.add({cls:"section",items:[{layout:"hbox",align:"bottom",cls:"section",items:[{html:this.localize("docsDensity"),
cls:"header"},{xtype:"sparklineline",values:this.getCorpus().getDocuments().getRange().map(function(doc){return Ext.util.Format.number(doc.getLexicalTypeTokenRatio(),"0.000")}),tipTpl:new Ext.XTemplate("{[this.getDocumentTitle(values.x,values.y)]}",{getDocumentTitle:function(docIndex,len){return"("+len+") "+this.panel.getCorpus().getDocument(docIndex).getTitle()},panel:me}),height:16,width:sparkWidth}]},{html:"\x3cul\x3e\x3cli\x3e"+this.localize("highest")+docsLengthTpl.apply(docs.slice(0,docs.length>
limit?limit:parseInt(docs.length/2)).map(function(doc){return{id:doc.getId(),shortTitle:doc.getShortTitle(),title:doc.getTitle(),val:Ext.util.Format.number(doc.getLexicalTypeTokenRatio(),"0.000"),valTip:numberOfTerms}}))+"\x3c/li\x3e"+"\x3cli\x3e"+this.localize("lowest")+docsLengthTpl.apply(docs.slice(-(docs.length>limit?limit:parseInt(docs.length/2))).reverse().map(function(doc){return{id:doc.getId(),shortTitle:doc.getShortTitle(),title:doc.getTitle(),val:Ext.util.Format.number(doc.getLexicalTypeTokenRatio(),
"0.000"),valTip:numberOfTerms}}))+"\x3c/li\x3e"}]});docs.sort(function(d1,d2){return d2.getAverageWordsPerSentence()-d1.getAverageWordsPerSentence()});main.add({cls:"section",items:[{layout:"hbox",align:"bottom",cls:"section",items:[{html:this.localize("averageWordsPerSentence"),cls:"header"},{xtype:"sparklineline",values:this.getCorpus().getDocuments().getRange().map(function(doc){return Ext.util.Format.number(doc.getAverageWordsPerSentence(),"0.0")}),tipTpl:new Ext.XTemplate("{[this.getDocumentTitle(values.x,values.y)]}",
{getDocumentTitle:function(docIndex,len){return"("+len+") "+this.panel.getCorpus().getDocument(docIndex).getTitle()},panel:me}),height:16,width:sparkWidth}]},{html:"\x3cul\x3e\x3cli\x3e"+this.localize("highest")+docsLengthTpl.apply(docs.slice(0,docs.length>limit?limit:parseInt(docs.length/2)).map(function(doc){return{id:doc.getId(),shortTitle:doc.getShortTitle(),title:doc.getTitle(),val:Ext.util.Format.number(doc.getAverageWordsPerSentence(),"0.0"),valTip:numberOfTerms}}))+"\x3c/li\x3e"+"\x3cli\x3e"+
this.localize("lowest")+docsLengthTpl.apply(docs.slice(-(docs.length>limit?limit:parseInt(docs.length/2))).reverse().map(function(doc){return{id:doc.getId(),shortTitle:doc.getShortTitle(),title:doc.getTitle(),val:Ext.util.Format.number(doc.getAverageWordsPerSentence(),"0.0"),valTip:numberOfTerms}}))+"\x3c/li\x3e"}]})}else{var doc=docs[0];if(doc){main.add({cls:"section",html:"\x3cb\x3e"+this.localize("docsDensity")+"\x3c/b\x3e "+Ext.util.Format.number(doc.getLexicalTypeTokenRatio(),"0.000")});main.add({cls:"section",
html:"\x3cb\x3e"+this.localize("averageWordsPerSentence")+"\x3c/b\x3e "+Ext.util.Format.number(doc.getAverageWordsPerSentence(),"0.0")})}}main.add({html:this.localize("mostFrequentWords"),cls:"section",listeners:{afterrender:function(container){container.mask(me.localize("loading"));me.getCorpus().getCorpusTerms().load({params:{limit:me.getApiParam("limit"),stopList:me.getApiParam("stopList"),forTool:"summary"},callback:function(records,operation,success){if(success&&records&&records.length>0){container.unmask();
Ext.dom.Helper.append(container.getTargetEl().first().first(),(new Ext.XTemplate('\x3ctpl for\x3d"." between\x3d"; "\x3e\x3ca href\x3d"#" onclick\x3d"return false" class\x3d"corpus-type keyword" voyant:recordId\x3d"{id}"\x3e{term}\x3c/a\x3e\x3cspan style\x3d"font-size: smaller"\x3e ({val})\x3c/span\x3e\x3c/tpl\x3e')).apply(records.map(function(term){return{id:term.getId(),term:term.getTerm(),val:term.getRawFreq()}})))}}})}},scope:this});if(docs.length>1)main.add({html:this.localize("distinctiveWords")+
"\x3col\x3e\x3c/ol\x3e",cls:"section",itemId:"distinctiveWords",listeners:{afterrender:function(container){me.showMoreDistinctiveWords()}},scope:this})},showMoreDistinctiveWords:function(){var distinctiveWordsContainer=this.queryById("distinctiveWords");var list=distinctiveWordsContainer.getTargetEl().selectNode("ol");var count=Ext.dom.Query.select("li:not(.more)",list).length;var numberOfDocumentsForDistinctiveWords=parseInt(this.getApiParam("numberOfDocumentsForDistinctiveWords"));var range=this.getCorpus().getDocuments().getRange(count,
count+numberOfDocumentsForDistinctiveWords-1);if(range&&Ext.isArray(range)){var docIndex=[];range.forEach(function(doc){docIndex.push(doc.getIndex())});if(docIndex.length>0)this.getCorpus().getDocumentTerms().load({addRecords:true,params:{docIndex:docIndex,perDocLimit:parseInt(this.getApiParam("limit")),limit:numberOfDocumentsForDistinctiveWords*parseInt(this.getApiParam("limit")),stopList:this.getApiParam("stopList"),sort:"TFIDF",dir:"DESC",forTool:"summary"},scope:this,callback:function(records,
operation,success){var docs={};if(success&&records&&Ext.isArray(records)){records.forEach(function(r,index,array){var i=r.getDocIndex();if(!(i in docs))docs[i]=[];docs[i].push({id:r.getId(),docIndex:r.getDocIndex(),type:r.getTerm(),val:Ext.util.Format.number(r.get("rawFreq"),"0,000"),docId:r.get("docId")})});var len;docIndex.forEach(function(index){if(docs[index]){var doc=this.getCorpus().getDocument(index);len=docs[index].length;Ext.dom.Helper.append(list,{tag:"li","voyant:index":String(index),html:'\x3ca href\x3d"#" onclick\x3d"return false" class\x3d"document-id document-id-distinctive" voyant:val\x3d"'+
doc.get("id")+'"\x3e'+doc.getShortTitle()+"\x3c/a\x3e"+this.localize("colon")+" "+(new Ext.XTemplate(this.localize("documentType"))).apply({types:docs[index]})+"."})}},this);distinctiveWordsContainer.updateLayout();len=numberOfDocumentsForDistinctiveWords;remaining=this.getCorpus().getDocuments().getTotalCount()-count-docIndex.length;if(remaining>0){var tpl=new Ext.Template(this.localize("moreDistinctiveWords"));var more=Ext.dom.Helper.append(list,{tag:"li",cls:"more",html:tpl.apply([len>remaining?
remaining:len,remaining])},true);more.on("click",function(){more.remove();this.showMoreDistinctiveWords()},this)}}}})}}});Ext.define("Voyant.panel.TextualArc",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.textualarc",statics:{i18n:{},api:{stopList:"auto",docIndex:0,speed:50,minRawFreq:2},glyph:"xf06e@FontAwesome"},config:{options:[{xtype:"stoplistoption"},{xtype:"container",items:{xtype:"numberfield",name:"minRawFreq",minValue:1,maxValue:10,value:2,labelWidth:150,labelAlign:"right",initComponent:function(){var panel=this.up("window").panel;this.fieldLabel=panel.localize(this.fieldLabel);this.on("afterrender",
function(cmp){Ext.tip.QuickTipManager.register({target:cmp.getEl(),text:panel.localize("minRawFreqTip")})});this.on("beforedestroy",function(cmp){Ext.tip.QuickTipManager.unregister(cmp.getEl())});this.callParent(arguments)},fieldLabel:"minRawFreq"}}],perim:[],diam:undefined},tokensFetch:500,constructor:function(){this.mixins["Voyant.util.Localization"].constructor.apply(this,arguments);this.config.options[1].fieldLabel=this.localize(this.config.options[1].fieldLabel);Ext.apply(this,{title:this.localize("title"),
html:'\x3ccanvas width\x3d"800" height\x3d"600"\x3e\x3c/canvas\x3e',dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{xtype:"combo",itemId:"search",queryMode:"local",displayField:"term",valueField:"term",width:90,emptyText:this.localize("search"),forceSelection:true,disabled:true},{xtype:"documentselectorbutton",singleSelect:true},{xtype:"slider",fieldLabel:this.localize("speed"),labelAlign:"right",labelWidth:40,width:100,increment:1,minValue:0,maxValue:100,value:30,listeners:{render:function(cmp){cmp.setValue(parseInt(this.getApiParam("speed")));
Ext.tip.QuickTipManager.register({target:cmp.getEl(),text:this.localize("speedTip")})},beforedestroy:function(cmp){Ext.tip.QuickTipManager.unregister(cmp.getEl())},changecomplete:function(cmp,val){this.setApiParam("speed",val);this.isReading=val!==0;this.draw()},scope:this}},{xtype:"tbfill"},{xtype:"tbtext",html:this.localize("adaptation")}]}]});this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("boxready",function(cmp){var canvas=this.getTargetEl().dom.querySelector("canvas");
this.draw(canvas);canvas.addEventListener("mousemove",function(evt){if(cmp.documentTerms){var rect=canvas.getBoundingClientRect(),x=evt.clientX-rect.left,y=evt.clientY-rect.top;var currentTerms={};cmp.documentTerms.each(function(documentTerm){var dx=documentTerm.get("x"),dy=documentTerm.get("y");if(dx>x-15&&dx<x+15&&dy>y-15&&dy<y+15){currentTerms[documentTerm.getTerm()]=true;return false}});if(Object.keys(cmp.currentTerms||{}).length==0&&Object.keys(currentTerms).length==0)return;cmp.currentTerms=
currentTerms;cmp.draw(canvas)}},false)});this.on("loadedCorpus",function(src,corpus){this.loadDocument()},this);this.on("documentselected",function(src,doc){this.setApiParam("docIndex",this.getCorpus().getDocument(doc).getIndex());this.loadDocument()});this.on("resize",function(){var gutter=20,availableWidth=this.getTargetEl().getWidth()-gutter-gutter,availableHeight=this.getTargetEl().getHeight()-gutter-gutter,diam=Math.max(availableWidth,availableHeight),rad=diam/2,ratio=Math.min(availableWidth,
availableHeight)/diam,canvas=this.getTargetEl().dom.querySelector("canvas");canvas.width=this.getTargetEl().getWidth();canvas.height=this.getTargetEl().getHeight();this.setDiam(diam);this.setPerim([]);var i=parseInt(diam*.75);while(this.getPerim().length<diam){this.getPerim().push({x:gutter+availableWidth/2+rad*(availableWidth>availableHeight?1:ratio)*Math.cos(2*Math.PI*i/diam),y:gutter+availableHeight/2+rad*(availableHeight>availableWidth?1:ratio)*Math.sin(2*Math.PI*i/diam)});if(i++==diam)i=0}})},
draw:function(canvas,ctx){canvas=canvas||this.getTargetEl().dom.querySelector("canvas");ctx=ctx||canvas.getContext("2d");ctx.clearRect(0,0,canvas.width,canvas.height);ctx.fillStyle="rgba(0,0,0,.1)";this.getPerim().forEach(function(p,i){if(i%3==0)ctx.fillRect(p.x-5,p.y,10,1)});if(this.documentTerms){this.drawTerms(canvas,ctx);this.drawReading(canvas,ctx);if(this.isReading){var me=this;setTimeout(function(){me.draw()},10)}}},drawReading:function(canvas,ctx){ctx=ctx||this.getTargetEl().dom.querySelector("canvas").getContext("2d");
var delay=2E3-parseInt(this.getApiParam("speed"))*1999/100;if(this.isReading&&this.documentTerms){var current=parseInt(this.readingIndex*this.getPerim().length/this.lastToken);ctx.fillStyle="purple";ctx.fillRect(this.getPerim()[current].x,this.getPerim()[current].y,5,5);var first=this.readingStartTime==undefined;this.readingStartTime=this.readingStartTime||(new Date).getTime();var delta=this.readingStartTime+delay-(new Date).getTime();if(this.sourceTerm&&this.targetTerm){var maxTail=10;if(first||
delta<=0){this.previousBeziers=this.previousBeziers||[];var sx=this.sourceTerm.get("x"),sy=this.sourceTerm.get("y"),tx=this.targetTerm.get("x"),ty=this.targetTerm.get("y"),px=this.previousTerm?this.previousTerm.get("x"):sx,py=this.previousTerm?this.previousTerm.get("y"):sy,round=100,multiplier=.3;var ix,iy,xd=Math.max(round,Math.abs(sx-tx)*.5),yd=Math.max(round,Math.abs(sy-ty)*.5);ix=sx>tx?sx-xd:sx+xd;iy=ty>sy?sy+yd:sy-yd;this.previousBeziers.unshift([sx,sy,ix,iy,tx,ty]);if(this.previousBeziers.length>
maxTail)this.previousBeziers.pop()}for(var i=0;i<this.previousBeziers.length;i++){ctx.strokeStyle="rgba(0,0,255,"+(1-i*.1)+")";var start=i+1==this.previousBeziers.length?1-delta/delay:0;var end=i==0?1-delta/delay:1;this.drawBezierSplit.apply(this,Ext.Array.merge([ctx],this.previousBeziers[i],[start],[end]))}if(delta<=0){this.readingStartTime=undefined;this.read()}}var nextReadingIndex=this.readingIndex+1;for(var len=this.tokens.getCount();nextReadingIndex<len;nextReadingIndex++)if(this.tokens.getAt(nextReadingIndex).getTerm().toLowerCase()==
this.targetTerm.getTerm())break;var startReadingIndex=nextReadingIndex-parseInt(delta*(nextReadingIndex-this.readingIndex)/delay),count=this.tokens.getCount();for(;startReadingIndex<nextReadingIndex;startReadingIndex++)if(startReadingIndex<count&&this.tokens.getAt(startReadingIndex).isWord())break;var tokens=this.tokens.getRange(startReadingIndex,len=Math.min(this.readingIndex+50,this.tokens.getCount())).map(function(token){return token.getTerm()});ctx.font="14px sans-serif";ctx.fillStyle="rgba(0,0,0,.5)";
ctx.textAlign="left";ctx.fillText(tokens.join(""),canvas.width/4,canvas.height-5);ctx.clearRect(canvas.width*.75,canvas.height-20,canvas.width,30)}else if(this.documentTerms&&this.documentTerms.getCount()<this.documentTerms.getTotalCount()){var x=canvas.width/4;ctx.strokeStyle="rgba(0,0,0,.5)";ctx.fillStyle="rgba(0,0,0,.2)";ctx.strokeRect(x,canvas.height-12,x*2,10);ctx.fillRect(x,canvas.height-12,this.documentTerms.getCount()*x*2/this.documentTerms.getTotalCount(),10)}},drawTerms:function(canvas,
ctx){canvas=canvas||this.getTargetEl().dom.querySelector("canvas");ctx=ctx||canvas.getContext("2d");ctx.textAlign="center";if(this.documentTerms&&this.getPerim().length>0)this.documentTerms.each(function(documentTerm){var me=this,freq=documentTerm.getRawFreq(),term=documentTerm.getTerm(),x=documentTerm.get("x"),y=documentTerm.get("y");isCurrentTerm=me.currentTerms&&term in me.currentTerms;isReadingTerm=this.sourceTerm&&this.sourceTerm.getTerm()==term;ctx.font=Math.log(freq)*(canvas.width*10/800)/
Math.log(this.maxRawFreq)+(isCurrentTerm||isReadingTerm?10:5)+"px sans-serif";if(isCurrentTerm)ctx.fillStyle="red";else if(isReadingTerm)ctx.fillStyle="blue";else ctx.fillStyle="rgba(0,0,0,"+(freq*.9/this.maxRawFreq+.1)+")";if(isCurrentTerm||isReadingTerm){ctx.strokeStyle=isCurrentTerm?"rgba(255,0,0,.2)":"rgba(0,255,0,.4)";documentTerm.getDistributions().forEach(function(d,i){if(d>0&&this.getPerim()[i]){ctx.beginPath();ctx.moveTo(x,y);ctx.lineTo(this.getPerim()[i].x,this.getPerim()[i].y);ctx.stroke()}},
this)}ctx.fillText(term,x,y)},this)},read:function(index){if(Ext.isNumber(index))this.readingIndex=index;else this.readingIndex++;if(this.sourceTerm)this.previousTerm=this.sourceTerm;for(var i=this.readingIndex,len=this.tokens.getCount();i<len;i++){var token=this.tokens.getAt(i),term=token.getTerm().toLowerCase();if(term in this.termsMap){this.sourceTerm=this.termsMap[term];if(this.sourceTerm.getRawFreq()>=1){this.readingIndex=i;break}}}for(var i=this.readingIndex+1,len=this.tokens.getCount();i<len;i++){var token=
this.tokens.getAt(i),term=token.getTerm().toLowerCase();if(term in this.termsMap){this.targetTerm=this.termsMap[term];if(this.targetTerm.getRawFreq()>=1)break}}if(!this.tokensLoading&&this.tokens.getCount()-this.readingIndex<this.tokensFetch)this.fetchMoreTokens();this.draw()},loadDocument:function(){if(this.documentTerms){this.documentTerms.destroy();this.documentTerms=undefined}this.termsMap={};this.draw();var doc=this.getCorpus().getDocument(parseInt(this.getApiParam("docIndex")));if(!this.up("tabpanel"))this.setTitle(this.localize("title")+
" \x3cspan class\x3d'subtitle'\x3e"+doc.getFullLabel()+"\x3c/span\x3e");this.lastToken=parseInt(doc.get("lastTokenStartOffset-lexical"));this.documentTerms=doc.getDocumentTerms({proxy:{extraParams:{stopList:this.getApiParam("stopList"),bins:this.getDiam(),withDistributions:"raw",minRawFreq:parseInt(this.getApiParam("minRawFreq"))}}});var search=this.queryById("search");search.setDisabled(true);search.setStore(this.documentTerms);this.fetchMoreDocumentTerms()},fetchMoreDocumentTerms:function(){if(!this.documentTerms){this.loadDocument();
return}this.documentTerms.load({params:{start:this.documentTerms.getCount(),limit:this.documentTerms.getCount()==0?10:250},callback:function(records){if(records.length>0){this.maxRawFreq=this.documentTerms.max("rawFreq");records.forEach(function(documentTerm){var x=y=0;documentTerm.get("distributions").forEach(function(d,i){x+=this.getPerim()[i].x*d;y+=this.getPerim()[i].y*d},this);documentTerm.set("x",x/documentTerm.getRawFreq());documentTerm.set("y",y/documentTerm.getRawFreq())},this);Ext.Function.defer(this.fetchMoreDocumentTerms,
0,this);this.draw()}else{this.queryById("search").setDisabled(false);this.termsMap={};this.documentTerms.each(function(documentTerm){this.termsMap[documentTerm.getTerm()]=documentTerm},this);if(this.tokens)this.tokens.removeAll(true);this.fetchMoreTokens()}},addRecords:true,scope:this})},fetchMoreTokens:function(){if(!this.tokens){this.tokens=this.getCorpus().getDocument(parseInt(this.getApiParam("docIndex"))).getTokens({proxy:{extraParams:{stripTags:"all"}}});this.noMoreTokens=false}else if(this.noMoreTokens)return;
var first=this.tokens.getCount()==0;this.tokensLoading=true;var speed=parseInt(this.getApiParam("speed"));this.tokens.load({params:{start:this.tokens.getCount(),limit:speed==50&&first?200:Math.pow(110-speed,2)},callback:function(records){this.tokensLoading=false;if(records.length>0){records.forEach(function(token){if(token.getTokenType()=="other")token.set("term",token.getTerm().replace(/\s+/g," "))});if(first){this.previousBeziers=[];this.isReading=true;this.read(0)}}else this.noMoreTokens=true},
addRecords:true,scope:this})},animatePathDrawing:function(ctx,x0,y0,x1,y1,x2,y2,duration){var start=null;var step=function animatePathDrawingStep(timestamp){if(start===null)start=timestamp;var delta=timestamp-start,progress=Math.min(delta/duration,1);ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);drawBezierSplit(ctx,x0,y0,x1,y1,x2,y2,0,progress);if(progress<1)window.requestAnimationFrame(step)};window.requestAnimationFrame(step)},drawBezierSplit:function(ctx,x0,y0,x1,y1,x2,y2,t0,t1){ctx.beginPath();
if(0==t0&&t1==1){ctx.moveTo(x0,y0);ctx.quadraticCurveTo(x1,y1,x2,y2)}else if(t0!=t1){var t00=t0*t0,t01=1-t0,t02=t01*t01,t03=2*t0*t01;var nx0=t02*x0+t03*x1+t00*x2,ny0=t02*y0+t03*y1+t00*y2;t00=t1*t1;t01=1-t1;t02=t01*t01;t03=2*t1*t01;var nx2=t02*x0+t03*x1+t00*x2,ny2=t02*y0+t03*y1+t00*y2;var nx1=this.lerp(this.lerp(x0,x1,t0),this.lerp(x1,x2,t0),t1),ny1=this.lerp(this.lerp(y0,y1,t0),this.lerp(y1,y2,t0),t1);ctx.moveTo(nx0,ny0);ctx.quadraticCurveTo(nx1,ny1,nx2,ny2)}ctx.stroke();ctx.closePath()},lerp:function(v0,
v1,t){return(1-t)*v0+t*v1}});Ext.define("Voyant.panel.TopicContexts",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.topiccontexts",statics:{i18n:{},api:{},glyph:"xf06e@FontAwesome"},constructor:function(config){Ext.apply(this,{title:this.localize("title"),cls:"twic_body"});this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},listeners:{loadedCorpus:function(src,corpus){this.loadFromCorpus(corpus)}},loadFromCorpus:function(corpus){var url=Ext.Loader.getPath("resources")+
"/twic/current/data/input/json";var twicLevel=TWiC.Level.prototype.Instance();twicLevel.LoadJSON(url+"/twic_corpusinfo.json",url+"/twic_corpusmap.json");var panel=this;twicLevel.m_queue.await(function(){var graphViews=[];var infoViews=[];var divName="dickinson";var topicBar=new TWiC.TopicBar({x:0,y:635},{width:1280,height:165},divName,twicLevel,[]);infoViews.push(topicBar);var docBar=new TWiC.DocumentBar({"x":1055,"y":0},{"width":225,"height":635},divName,twicLevel,[]);infoViews.push(docBar);var corpusClusterView=
new TWiC.CorpusClusterView({"x":0,"y":0},{"width":1055,"height":635},divName,twicLevel,[topicBar,docBar]);graphViews.push(corpusClusterView);topicBar.m_linkedViews.push(corpusClusterView);var body=panel.getLayout().getRenderTarget();twicLevel.Initialize([0,0],{width:body.getWidth(),height:body.getHeight()},divName,graphViews,infoViews,"#"+body.getId());twicLevel.Start()}.bind(twicLevel))}});Ext.define("Voyant.panel.TermsBerry",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.termsberry",statics:{i18n:{},api:{stopList:"auto",context:2,numInitialTerms:75,query:undefined,docIndex:undefined,docId:undefined,categories:undefined},glyph:"xf1db@FontAwesome"},config:{options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"}],mode:undefined,scalingFactor:3,minRawFreq:undefined,maxRawFreq:undefined,maxCollocateValue:undefined,minFillValue:undefined,maxFillValue:undefined,
currentData:{},blacklist:{},visLayout:undefined,vis:undefined,visInfo:undefined,visId:undefined,currentNode:undefined,tip:undefined,contextMenu:undefined},MODE_TOP:"top",MODE_DISTINCT:"distinct",MIN_TERMS:5,MAX_TERMS:500,COLLOCATES_LIMIT:1E6,MIN_SCALING:1,MAX_SCALING:5,MIN_STROKE_OPACITY:.1,MAX_STROKE_OPACITY:.3,layout:"fit",constructor:function(config){this.setMode(this.MODE_TOP);this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.setVisId(Ext.id(null,
"termspack_"))},initComponent:function(){Ext.apply(this,{title:this.localize("title"),dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{xtype:"querysearchfield",clearOnQuery:true},{xtype:"button",text:this.localize("strategy"),menu:{items:[{xtype:"menucheckitem",group:"strategy",checked:this.getMode()===this.MODE_TOP,text:this.localize("topTerms"),checkHandler:function(item,checked){if(checked){this.setMode(this.MODE_TOP);this.doLoad()}},scope:this},{xtype:"menucheckitem",
group:"strategy",checked:this.getMode()===this.MODE_DISTINCT,text:this.localize("distinctTerms"),checkHandler:function(item,checked){if(checked){this.setMode(this.MODE_DISTINCT);this.doLoad()}},scope:this}]}},{fieldLabel:this.localize("numTerms"),labelWidth:50,labelAlign:"right",width:120,xtype:"slider",increment:1,minValue:this.MIN_TERMS,maxValue:this.MAX_TERMS,listeners:{afterrender:function(slider){slider.setValue(parseInt(this.getApiParam("numInitialTerms")))},changecomplete:function(slider,newvalue){this.setApiParam("numInitialTerms",
newvalue);this.doLoad()},scope:this}},{fieldLabel:this.localize("context"),labelWidth:50,labelAlign:"right",width:120,xtype:"slider",increment:1,minValue:1,maxValue:30,listeners:{afterrender:function(slider){slider.setValue(this.getApiParam("context"))},changecomplete:function(slider,newvalue){this.setApiParams({context:newvalue});this.doLoad()},scope:this}},{fieldLabel:this.localize("scaling"),labelWidth:50,labelAlign:"right",width:120,xtype:"slider",increment:1,minValue:this.MIN_SCALING,maxValue:this.MAX_SCALING,
listeners:{afterrender:function(slider){slider.setValue(this.getScalingFactor())},changecomplete:function(slider,newvalue){var value=Math.abs(newvalue-(this.MAX_SCALING+1));this.setScalingFactor(value);this.reload()},scope:this}}]}]});this.setContextMenu(Ext.create("Ext.menu.Menu",{renderTo:Ext.getBody(),items:[{xtype:"box",itemId:"label",margin:"5px 0px 5px 5px",html:""},{xtype:"menuseparator"},{xtype:"button",text:"Remove",style:"margin: 5px;",handler:function(b,e){var node=this.getCurrentNode();
if(node!==undefined){delete this.getCurrentData()[node.data.term];this.getBlacklist()[node.data.term]=true;this.setCurrentNode(undefined)}this.getContextMenu().hide();this.reload()},scope:this}]}));this.on("query",function(src,query){if(query.length>0)this.doLoad(query)},this);this.callParent(arguments)},listeners:{boxready:function(){this.initVisLayout()},resize:function(panel,width,height){if(this.getVisLayout()&&this.getCorpus()){var el=this.getLayout().getRenderTarget();width=el.getWidth();height=
el.getHeight();el.down("svg").set({width:width,height:height});this.getVisLayout().size([width,height]);this.reload()}},loadedCorpus:function(src,corpus){if(this.isVisible())this.doLoad()},activate:function(){if(this.getCorpus())this.doLoad()}},doLoad:function(query){this.resetVis();if(query===undefined){this.resetMinMax();this.setCurrentData({})}if(this.getMode()===this.MODE_DISTINCT)this.getDistinctTerms(query);else this.getTopTerms(query)},reload:function(){var data=this.processCollocates([]);
if(data.length>0){this.resetVis();this.buildVisFromData(data)}},resetMinMax:function(){this.setMinRawFreq(undefined);this.setMaxRawFreq(undefined);this.setMaxCollocateValue(undefined);this.setMinFillValue(undefined);this.setMaxFillValue(undefined)},resetVis:function(){var vis=this.getVis();if(vis)vis.selectAll(".node").remove()},getTopTerms:function(query){var limit=parseInt(this.getApiParam("numInitialTerms"));var stopList=this.getApiParam("stopList");if(query!==undefined){limit=undefined;stopList=
undefined}this.getCorpus().getCorpusTerms().load({params:{query:query,limit:limit,stopList:stopList},callback:function(records,operation,success){if(success)this.loadFromRecords(records)},scope:this})},getDistinctTerms:function(query){var limit=parseInt(this.getApiParam("numInitialTerms"));var stopList=this.getApiParam("stopList");if(query!==undefined){limit=undefined;stopList=undefined}var perDocLimit=Math.ceil(parseInt(this.getApiParam("numInitialTerms"))/this.getCorpus().getDocumentsCount());this.getCorpus().getDocumentTerms().load({params:{query:query,
limit:limit,perDocLimit:perDocLimit,stopList:stopList,sort:"TFIDF",dir:"DESC"},callback:function(records,operation,success){if(success)this.loadFromRecords(records)},scope:this})},loadFromQuery:function(query){this.getCorpus().getCorpusTerms().load({params:{query:query},callback:function(records,operation,success){if(success)this.loadFromRecords(records)},scope:this})},loadFromRecords:function(records){if(Ext.isArray(records)&&records.length>0){var maxFreq=this.getMaxRawFreq();var minFreq=this.getMinRawFreq();
var minFillVal=this.getMinFillValue();var maxFillVal=this.getMaxFillValue();var terms=[];records.forEach(function(r){var term=r.getTerm();if(!this.getBlacklist()[term]){var rawFreq=r.getRawFreq();var fillVal=this.getMode()===this.MODE_DISTINCT?r.get("tfidf"):r.getInDocumentsCount();if(maxFreq===undefined||rawFreq>maxFreq)maxFreq=rawFreq;if(minFreq===undefined||rawFreq<minFreq)minFreq=rawFreq;if(maxFillVal===undefined||fillVal>maxFillVal)maxFillVal=fillVal;if(minFillVal===undefined||fillVal<minFillVal)minFillVal=
fillVal;this.getCurrentData()[term]={term:term,rawFreq:rawFreq,relativeFreq:r.get("relativeFreq"),fillValue:fillVal,collocates:[]};terms.push(term)}},this);this.setMaxRawFreq(maxFreq);this.setMinRawFreq(minFreq);this.setMinFillValue(minFillVal);this.setMaxFillValue(maxFillVal);this.getCollocatesForQuery(terms)}},getCollocatesForQuery:function(query){var whitelist=[];for(var term in this.getCurrentData())whitelist.push(term);this.setApiParams({mode:"corpus"});var params=this.getApiParams();this.getCorpus().getCorpusCollocates().load({params:Ext.apply(Ext.clone(params),
{query:query,collocatesWhitelist:whitelist,limit:this.COLLOCATES_LIMIT}),callback:function(records,op,success){if(success)this.buildVisFromData(this.processCollocates(records))},scope:this})},processCollocates:function(records){var currentTerms=this.getCurrentData();var maxCol=this.getMaxCollocateValue();for(var i=0;i<records.length;i++){var r=records[i];var term=r.getTerm();var contextTerm=r.getContextTerm();var contextFreq=r.getContextTermRawFreq();if(maxCol===undefined||contextFreq>maxCol)maxCol=
contextFreq;if(currentTerms[term]===undefined);else if(term!=contextTerm)currentTerms[term].collocates.push({term:contextTerm,value:contextFreq})}this.setMaxCollocateValue(maxCol);var data=[];for(var term in currentTerms)data.push(currentTerms[term]);return data},buildVisFromData:function(data){var me=this;if(!this.getVis())return;var rootId="$$$root$$$";data.push({term:rootId,collocates:[],rawFreq:1});var root=d3.stratify().id(function(d){return d.term}).parentId(function(d){if(d.term!==rootId)return rootId;
else return""})(data).sort(function(a,b){return a.rawFreq<b.rawFreq?1:a.rawFreq>b.rawFreq?-1:0}).sum(function(d){return Math.pow(d.rawFreq,1/me.getScalingFactor())});this.getVisLayout()(root);var nodes=this.getVis().selectAll(".node").data(root.descendants());nodes.attr("transform",function(d){return"translate("+d.x+","+d.y+")"});nodes.selectAll("circle").attr("r",function(d){return d.r});var idGet=function(term){return term.replace(/\W/g,"_")};var collocateFill=d3.scalePow().exponent(1/3).domain([0,
this.getMaxCollocateValue()]).range(["#fff","#bd3163"]);var defaultFill;if(this.getMode()===this.MODE_DISTINCT)defaultFill=d3.scalePow().exponent(1/5).domain([this.getMinFillValue(),this.getMaxFillValue()]).range(["#dedede","#fff"]);else defaultFill=d3.scaleLinear().domain([this.getMaxFillValue(),this.getMinFillValue()]).range(["#dedede","#fff"]);var size=this.getVisLayout().size();var layoutRadius=Math.min(size[0],size[1])/2;var layoutArea=Math.PI*(layoutRadius*layoutRadius);var totalTerms=data.length;
var termArea=layoutArea/totalTerms;var termRadius=Math.sqrt(termArea/Math.PI);var minFontSize=termRadius/3;var scalingInverse=Math.abs(this.getScalingFactor()-(this.MAX_SCALING+1));scalingInverse=Math.max(1,scalingInverse-1);var maxFontSize=minFontSize*scalingInverse;var textSizer=d3.scaleLinear().domain([this.getMinRawFreq(),this.getMaxRawFreq()]).range([minFontSize,maxFontSize]);var node=nodes.enter().append("g").attr("class","node").style("visibility",function(d){return d.depth>0?"visible":"hidden"}).attr("transform",
function(d){return"translate("+d.x+","+d.y+")"}).on("click",function(d){me.dispatchEvent("termsClicked",me,[d.data.term])}).on("mouseover",function(d,i){me.setCurrentNode(d);me.getVis().selectAll("circle").style("stroke-width",1).style("stroke","#111").style("fill",function(d){return defaultFill(d.data.fillValue)});d3.select(this).select("circle").style("fill","#89e1c2").style("stroke","#26926c").style("stroke-opacity",me.MAX_STROKE_OPACITY);var fillLabel;if(me.getMode()===me.MODE_DISTINCT)fillLabel=
me.localize("tfidf");else fillLabel=me.localize("inDocs");if(!me.getContextMenu().isVisible()){var info="\x3cb\x3e"+d.data.term+"\x3c/b\x3e ("+d.data.rawFreq+")\x3cbr/\x3e"+fillLabel+": "+d.data.fillValue;var tip=me.getTip();tip.update(info);tip.show()}for(var i=0;i<d.data.collocates.length;i++){var collocate=d.data.collocates[i];var match=me.getVis().selectAll(".node").filter(function(d){return d.data.term===collocate.term});match.select("circle").style("fill",function(d){return collocateFill(collocate.value)}).style("stroke",
"#bd3163").style("stroke-opacity",me.MAX_STROKE_OPACITY);match.select("tspan.value").text(function(d){return collocate.value})}}).on("mousemove",function(){me.getTip().setPosition(d3.event.pageX+5,d3.event.pageY-50)}).on("mouseout",function(){if(!me.getContextMenu().isVisible())me.setCurrentNode(undefined);me.getVis().selectAll("circle").style("stroke-opacity",me.MIN_STROKE_OPACITY).style("stroke","#111").style("fill",function(d){return defaultFill(d.data.fillValue)});me.getVis().selectAll("tspan.value").text("");
me.getTip().hide()}).on("contextmenu",function(d,i){d3.event.preventDefault();me.getTip().hide();var menu=me.getContextMenu();menu.queryById("label").setHtml(d.data.term);menu.showAt(d3.event.pageX+5,d3.event.pageY-50)});node.append("circle").attr("id",function(d){return idGet(d.data.term)}).attr("r",function(d){return d.r}).style("fill",function(d){return defaultFill(d.data.fillValue)}).style("stroke","#111").style("stroke-opacity",me.MIN_STROKE_OPACITY).style("stroke-width",1);node.append("clipPath").attr("id",
function(d){return"clip-"+idGet(d.data.term)}).append("use").attr("xlink:href",function(d){return"#"+idGet(d.data.term)});var text=node.append("text").attr("clip-path",function(d){return"url(#clip-"+idGet(d.data.term)+")"}).style("font-family",function(d){return me.getApplication().getCategoriesManager().getFeatureForTerm("font",d.data.term)}).style("text-anchor","middle").style("cursor","default");text.append("tspan").attr("class","term").attr("font-size",function(d){return textSizer(d.data.rawFreq)}).attr("x",
0).attr("y",function(d){return textSizer(d.data.rawFreq)/4}).text(function(d){return d.data.term});text.append("tspan").attr("class","value").attr("font-size",function(d){return textSizer(d.data.rawFreq)*.75}).attr("x",0).attr("y",function(d){return textSizer(d.data.rawFreq)+1});nodes.exit().remove()},initVisLayout:function(){var el=this.getLayout().getRenderTarget();el.update("");var width=el.getWidth();var height=el.getHeight();var me=this;this.setVisLayout(d3.pack().size([width,height]).padding(1.5));
var svg=d3.select(el.dom).append("svg").attr("id",this.getVisId()).attr("width",width).attr("height",height);this.setVis(svg.append("g"));this.setVisInfo(svg.append("text").attr("x",10).attr("y",10));if(this.getTip()===undefined)this.setTip(Ext.create("Ext.tip.Tip",{}))}});Ext.define("Voyant.panel.TermsRadio",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.termsradio",config:{options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"}],speed:50,termsRadio:undefined},statics:{i18n:{},api:{withDistributions:true,bins:5,visibleBins:5,docIdType:null,limit:50,mode:null,position:0,selectedWords:[],stopList:"auto",query:null,yAxisScale:"log",speed:50,slider:undefined},glyph:"xf201@FontAwesome"},constructor:function(config){var onLoadHandler=function(mode,
store,records,success,operation){this.setApiParams({mode:mode});this.getTermsRadio().loadRecords(records);var query=this.getApiParam("query");if(query)if(records.length==0||records.length==1&&records[0].getRawFreq()==0)this.toastInfo({html:this.localize("termNotFound"),align:"bl"});else this.getTermsRadio().highlightQuery(query,true)};this.corpusStore=Ext.create("Voyant.data.store.CorpusTerms",{listeners:{load:{fn:onLoadHandler.bind(this,"corpus"),scope:this}}});this.documentStore=Ext.create("Voyant.data.store.DocumentTerms",
{listeners:{load:{fn:onLoadHandler.bind(this,"document"),scope:this}}});Ext.apply(config,{title:this.localize("title"),legendMenu:Ext.create("Ext.menu.Menu",{items:[{text:"",itemId:"remove",glyph:"xf068@FontAwesome"}]}),tbar:new Ext.Toolbar({overflowHandler:"scroller",items:{xtype:"legend",store:new Ext.data.JsonStore({fields:["name","mark"]}),listeners:{itemclick:function(view,record,el,index){var term=record.get("name");if(this.getTermsRadio().isTermSelected(term))this.getTermsRadio().doTermDeselect(term);
else this.getTermsRadio().doTermSelect(term)},itemcontextmenu:function(view,record,el,index,event){event.preventDefault();var xy=event.getXY();var term=record.get("name");var text=(new Ext.Template(this.localize("removeTerm"))).apply([term]);this.legendMenu.queryById("remove").setText(text);this.legendMenu.on("click",function(menu,item){if(item!==undefined)this.doTermDeselect(term,true)},this,{single:true});this.legendMenu.showAt(xy)},scope:this}}}),bbar:{overflowHandler:"scroller",items:[{xtype:"querysearchfield"},
{glyph:"xf04b@FontAwesome",itemId:"play",handler:function(btn){var playing=btn.glyph=="xf04c@FontAwesome";if(playing){this.getTermsRadio().continueTransition=false;this.mask(this.localize("completingTransition"));btn.setPlaying(false)}else{this.getTermsRadio().toggleRightCheck();btn.setPlaying(true)}},scope:this,setPlaying:function(bool){this.setGlyph(bool?"xf04c@FontAwesome":"xf04b@FontAwesome")}},{glyph:"xf0e2@FontAwesome",tooltip:this.localize("resetTip"),listeners:{click:{fn:function(){this.queryById("play").setPlaying(false);
this.getTermsRadio().shiftCount=0;this.getTermsRadio().prepareData();this.getTermsRadio().redraw()},scope:this}}},{xtype:"label",forId:"terms",text:this.localize("terms")},{xtype:"slider",itemId:"terms",hideLabel:true,width:60,increment:5,minValue:5,maxValue:100,listeners:{afterrender:function(slider){slider.setValue(parseInt(this.getApiParam("limit")))},changecomplete:function(slider,newvalue){this.setApiParams({limit:newvalue});this.loadStore()},scope:this}},{xtype:"label",forId:"speed",text:this.localize("speed")},
{xtype:"slider",itemId:"speed",hideLabel:true,width:60,increment:5,minValue:5,maxValue:100,listeners:{afterrender:function(slider){slider.setValue(parseInt(this.getApiParam("speed")));this.setSpeed(slider.getValue())},changecomplete:function(slider,newvalue){this.setApiParams({speed:newvalue});this.setSpeed(newvalue)},scope:this}},{xtype:"label",itemId:"visibleSegmentsLabel",forId:"visibleBins",text:this.localize("visibleSegments")},{xtype:"slider",itemId:"visibleBins",hideLabel:true,width:60,increment:1,
minValue:1,maxValue:100,listeners:{afterrender:function(slider){slider.setValue(parseInt(this.getApiParam("visibleBins")))},changecomplete:function(slider,newvalue){this.setApiParams({visibleBins:newvalue});this.numVisPoints=newvalue;this.loadStore();if(this.numVisPoints==this.getCorpus().getDocumentsCount())this.getTermsRadio().hideSlider();else if(this.getApiParam("slider")!="false")this.getTermsRadio().showSlider()},scope:this}},{xtype:"label",itemId:"segmentsLabel",forId:"segments",text:this.localize("segments")},
{xtype:"slider",itemId:"segments",hideLabel:true,width:60,increment:1,minValue:1,maxValue:100,listeners:{afterrender:function(slider){slider.setValue(parseInt(this.getApiParam("bins")))},changecomplete:function(slider,newvalue){this.setApiParams({bins:newvalue});this.numDataPoints=newvalue;this.loadStore();var visibleBins=this.queryById("visibleBins");visibleBins.setMaxValue(newvalue)},scope:this}}]}});this.config.options.push({xtype:"combo",queryMode:"local",triggerAction:"all",forceSelection:true,
editable:false,fieldLabel:this.localize("yScale"),labelAlign:"right",name:"yAxisScale",valueField:"value",displayField:"name",store:new Ext.data.JsonStore({fields:["name","value"],data:[{name:this.localize("linear"),value:"linear"},{name:this.localize("log"),value:"log"}]}),listeners:{afterrender:function(combo){combo.setValue(this.getApiParam("yAxisScale"))},scope:this}});this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("boxready",function(component){var sliderParam=
this.getApiParam("slider");var showSlider=sliderParam===undefined?true:sliderParam==="true";var config={parent:this,container:this.body,showSlider:showSlider};this.setTermsRadio(new TermsRadio(config))},this);this.addListener("corpusTermsClicked",function(src,terms){if(this.getCorpus().getDocumentsCount()>1)terms.forEach(function(term){var t=term.getTerm();this.setApiParams({query:t});this.loadStore()})});this.addListener("documentTermsClicked",function(src,terms){if(src&&src.xtype==this.xtype)return false;
terms.forEach(function(term){var t=term.getTerm();this.setApiParams({query:t});this.loadStore()})});this.on("query",function(src,query){this.fireEvent("termsClicked",src,query)});this.on("termsClicked",function(src,terms){terms.forEach(function(term){var queryTerm;if(Ext.isString(term))queryTerm=term;else if(term.term)queryTerm=term.term;else if(term.getTerm)queryTerm=term.getTerm();this.setApiParams({query:queryTerm});this.loadStore()},this)});this.on("loadedCorpus",function(src,corpus){this.documentStore.setCorpus(corpus);
this.corpusStore.setCorpus(corpus);var params=this.getApiParams();if(params.type)delete params.limit;var store;var docsCount=this.getCorpus().getDocumentsCount();var segments=this.queryById("segments");var visibleBins=this.queryById("visibleBins");if(params.mode=="document"||docsCount==1){this.setApiParam("mode","document");store=this.documentStore;visibleBins.setMaxValue(segments.getValue())}else{this.setApiParam("mode","corpus");delete params.bins;store=this.corpusStore;segments.hide();this.queryById("segmentsLabel").hide();
var visibleBins=this.queryById("visibleBins");visibleBins.setMaxValue(docsCount);if(parseInt(this.getApiParam("visibleBins")>docsCount))visibleBins.setValue(docsCount)}store.on("load",function(store,records){for(var i=0;i<3;i++){var r=records[i];if(r)this.getTermsRadio().highlightRecord(r,true)}},this,{single:true});store.load({params:params})},this)},loadStore:function(){this.queryById("play").setPlaying(false);var params=this.getApiParams();if(this.getApiParam("mode")==="document")this.documentStore.load({params:params});
if(this.getApiParam("mode")==="corpus"){delete params.bins;this.corpusStore.load({params:params})}}});Ext.define("Voyant.panel.Trends",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],requires:["Voyant.data.store.Documents"],alias:"widget.trends",config:{options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"},{name:"bins",xtype:"slider",labelAlign:"right",width:200,minValue:2,maxValue:100,listeners:{afterrender:function(slider){var trends=slider.up("window").panel;slider.setFieldLabel(trends.localize("segmentsSlider"))}}},{xtype:"radiogroup",labelAlign:"right",columns:3,vertical:true,
name:"withDistributions",items:[{boxLabel:"raw",name:"withDistributions",inputValue:"raw"},{boxLabel:"relative",name:"withDistributions",inputValue:"relative",style:"margin-left: 1em;"}],listeners:{afterrender:function(radiogroup){var panel=this.up("window").panel;this.setFieldLabel("frequencies");var val=panel.getApiParam("withDistributions");radiogroup.getBoxes().forEach(function(item){item.setBoxLabel(panel.localize(item.inputValue));item.checked=item.inputValue==val});this.setValue({withDistributions:val})}}},
{xtype:"colorpaletteoption"}]},statics:{i18n:{},api:{limit:5,stopList:"auto",query:undefined,withDistributions:"relative",bins:10,docIndex:undefined,docId:undefined,mode:"corpus",chartType:"barline",labels:false},glyph:"xf201@FontAwesome"},layout:"fit",documentTermsStore:undefined,constructor:function(config){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},initComponent:function(){this.mixins["Voyant.util.Api"].constructor.apply(this,arguments);Ext.apply(this,
{title:this.localize("title"),dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{xtype:"querysearchfield"},{itemId:"reset",text:this.localize("reset"),tooltip:this.localize("resetTip"),handler:function(btn){this.setApiParams({docIndex:undefined,mode:undefined,query:undefined});this.loadCorpusTerms()},scope:this},{text:this.localize("display"),tooltip:this.localize("displayTip"),glyph:"xf013@FontAwesome",menu:{listeners:{afterrender:function(menu){var val=this.getApiParam("chartType");
menu.items.each(function(item){if(item.getItemId()==val)item.addCls(item.activeCls)})},scope:this},defaults:{xtype:"menuitem",handler:function(item,checked){if(item.xtype=="menucheckitem")this.setApiParam("labels",item.checked);else this.setApiParam("chartType",item.getItemId());this.loadCorpusTerms()},scope:this},items:[{xtype:"menucheckitem",text:this.localize("labels"),tooltip:this.localize("labelsTip"),checked:this.getApiParam("labels")===true||this.getApiParam("labels")=="true"},"-",{itemId:"area",
text:this.localize("area"),tooltip:this.localize("areaTip"),glyph:"xe76b@Sencha-Examples"},{itemId:"bar",text:this.localize("bar"),tooltip:this.localize("barTip"),glyph:"xe768@Sencha-Examples"},{itemId:"line",text:this.localize("line"),tooltip:this.localize("lineTip"),glyph:"xe773@Sencha-Examples"},{itemId:"stacked",text:this.localize("stacked"),tooltip:this.localize("stackedTip"),glyph:"xe6c8@Sencha-Examples"},{itemId:"barline",text:this.localize("barline"),tooltip:this.localize("barlineTip"),glyph:"xe779@Sencha-Examples"}]}}]}]});
this.callParent(arguments)},listeners:{loadedCorpus:function(src,corpus){this.loadCorpusTerms()},termsClicked:function(src,terms){var queryTerms=[];terms.forEach(function(term){if(Ext.isString(term))queryTerms.push(term);else if(term.term)queryTerms.push(term.term);else if(term.getTerm)queryTerms.push(term.getTerm())});this.setApiParam("query",queryTerms&&queryTerms.length>0?queryTerms:undefined);this.loadCorpusTerms()},corpusTermsClicked:function(src,terms){this.setApiParam("query",terms.map(function(term){return term.getTerm()}));
this.loadCorpusTerms()},documentSelected:function(src,document){this.setApiParam("docIndex",this.getCorpus().getDocument(document).getIndex());this.loadDocumentTerms()},documentsClicked:function(src,documents){if(documents.length==1)this.fireEvent("documentSelected",this,documents[0])},query:function(src,query){this.fireEvent("termsClicked",this,query)}},loadCorpusTerms:function(params){if(this.getCorpus().getDocumentsCount()<2||this.getApiParam("mode")=="document"||Array.from(this.getApiParam("docIndex")||
"").length>0)return this.loadDocumentTerms();if(!this.getApiParam("query")){this.getCorpus().getCorpusTerms().load({params:{limit:5,stopList:this.getApiParam("stopList")},callback:function(records,operation,success){if(records.length==0)if(operation&&operation.error)this.showError(this.localize("noResults")+"\x3cp style\x3d'color: red'\x3e"+operation.error+"\x3c/p\x3e");else this.showError(this.localize("noResults"));else{this.setApiParam("query",records.map(function(r){return r.getTerm()}));this.loadCorpusTerms()}},
scope:this});return}params=params||{};var withDistributions=this.getApiParam("withDistributions");Ext.applyIf(params,{bins:this.getCorpus().getDocumentsCount(),limit:100,stopList:""});var docLabels=this.getCorpus().map(function(doc){return doc.getTinyTitle()});if(Ext.Array.unique(docLabels).length<docLabels.length)docLabels=docLabels.map(function(doc,i){return i+1+")"+doc});Ext.applyIf(params,this.getApiParams());this.getCorpus().getCorpusTerms().load({params:params,callback:function(records,operation,
success){var data=[],series=[],chartType=this.getApiParam("chartType");records.forEach(function(record,index){var term=record.get("term"),docIndex=record.get("docIndex");var color=this.getApplication().getColorForTerm(term,true);record.get("distributions").forEach(function(r,i){if(!data[i])data[i]={"index":docLabels[i]};data[i]["_"+index]=withDistributions=="relative"?r.toFixed(7):r;data[i]["term"+index]=term},this);if(chartType!="bar"){var kinds=chartType=="barline"?["bar","line"]:[chartType];kinds.forEach(function(kind){series.push({type:kind==
"stacked"?"bar":kind,title:term,xField:"index",yField:"_"+index,term:term,colors:[color],label:chartType=="barline"&&kind=="bar"?{display:"none"}:{field:"term"+index}})},this)}},this);var terms=records.map(function(r){return r.getTerm()});var colors=terms.map(function(term){return this.getApplication().getColorForTerm(term,true)},this);if(chartType=="bar")series.push({type:"bar",title:terms,colors:colors,xField:"index",yField:data.length>0?Object.keys(data[0]).filter(function(field){return field.charAt(0)==
"_"}):undefined,label:{field:records.map(function(r,i){return"term"+i})}});var store=Ext.create("Ext.data.JsonStore",{fields:data.length>0?Object.keys(data[0]):undefined,data:data});this.buildChart({store:store,series:series,axes:[{type:"numeric",position:"left",increment:1,title:{text:this.localize(this.getApiParam("withDistributions")+"Title")}},{type:"category",position:"bottom",title:{text:this.localize("corpusTitle")}}]})},scope:this})},getItemToolTip:function(toolTip,record,ctx){var parts=ctx.field.split("_"),
docIndex=parts.length==2?ctx.index:parts[2],pos=parseInt(parts[1]),title=ctx.series.getTitle(),term=Ext.isArray(title)?title[pos]:title,colors=ctx.series.getColors(),color=colors.length==1?colors[0]:colors[pos];var html="\x3cspan class\x3d'x-legend-item-marker' style\x3d'background:"+color+"; left: 2px;'\x3e\x3c/span\x3e \x3cspan style\x3d'padding-left: 1.2em; font-weight: bold;'\x3e"+term+"\x3c/span\x3e: "+record.get(ctx.field)+"\x3cbr/\x3e\x3ci\x3e"+this.getCorpus().getDocument(docIndex).getShortTitle()+
"\x3c/i\x3e";if(this.getApiParam("mode")=="corpus")html+="\x3cdiv style\x3d'font-size: smaller'\x3e"+this.localize("dblClickItem");else html+="\x3cbr/\x3e"+this.localize("segment")+" "+(ctx.index+1);toolTip.setHtml(html)},loadDocumentTerms:function(params){if(!this.getApiParam("query")){this.getCorpus().getCorpusTerms().load({params:{limit:this.getCorpus().getDocumentsCount()<2?5:2,stopList:this.getApiParam("stopList")},callback:function(records,operation,success){this.setApiParam("query",records.map(function(r){return r.getTerm()}));
this.loadDocumentTerms()},scope:this});return}this.setApiParam("mode","document");params=params||{};var withDistributions=this.getApiParam("withDistributions");Ext.applyIf(params,{limit:0,sort:"termasc",stopList:undefined});var docLabels=this.getCorpus().map(function(doc){return doc.getTinyTitle()});var singleDoc;if(this.getCorpus().getDocumentsCount()==1)singleDoc=this.getCorpus().getDocument(0);else singleDoc=this.getCorpus().getDocument(this.getApiParam("docIndex"));Ext.applyIf(params,this.getApiParams());
this.getCorpus().getDocumentTerms().load({params:params,callback:function(records,operation,success){var data=[],series=[],chartType=this.getApiParam("chartType");if(!singleDoc)records.sort(function(a,b){if(a.getTerm()==b.getTerm())return a.getDocIndex()-b.getDocIndex();return a.getTerm().localeCompare(b.getTerm())});records.forEach(function(record,index){var term=record.get("term");var docIndex=record.get("docIndex");var color=singleDoc?this.getApplication().getColorForTerm(term,true):this.getApplication().getColor(docIndex,
true);var docIndex=record.get("docIndex");record.get("distributions").forEach(function(r,i){if(!data[i])data[i]={docIndex:docIndex,index:i+1};data[i]["_"+index+"_"+docIndex]=withDistributions=="relative"?r.toFixed(7):r;data[i]["term"+index]=term},this);if(chartType!="bar"){var kinds=chartType=="barline"?["bar","line"]:[chartType];kinds.forEach(function(kind){series.push({type:kind=="stacked"?"bar":kind,title:singleDoc?term:docIndex+1+") "+term,xField:"index",yField:"_"+index+"_"+docIndex,term:term,
colors:[color],label:chartType=="barline"&&kind=="bar"?{display:"none"}:{field:"term"+index}})},this)}},this);if(chartType=="bar"){var isOneTerm=Ext.Array.unique(records.map(function(r){return r.getTerm()})).length;var terms=records.map(function(r){return 1+r.get("docIndex")+") "+r.getTerm()});var colors=records.map(function(r){return isOneTerm?this.getApplication().getColor(r.get("docIndex"),true):this.getApplication().getColorForTerm(r.getTerm(),true)},this);series.push({type:"bar",title:terms.length>
0?terms:this.localize("noResults"),colors:colors,xField:"index",yField:data.length>0?Object.keys(data[0]).filter(function(field){return field.charAt(0)=="_"}):undefined,label:{field:terms}})}var store=Ext.create("Ext.data.JsonStore",{fields:data.length>0?Object.keys(data[0]):undefined,data:data});this.buildChart({store:store,series:series,axes:[{type:"numeric",position:"left",title:{text:this.localize(this.getApiParam("withDistributions")+"Title")}},{type:"category",position:"bottom",title:{text:this.localize("segmentsTitle")+
(singleDoc?" ("+singleDoc.getShortTitle()+")":"")}}]})},scope:this})},buildChart:function(config){var chartType=this.getApiParam("chartType"),labels=false;if(this.getApiParam("labels")===true||this.getApiParam("labels")=="true")labels=true;Ext.applyIf(config,{cls:this.getApiParam("mode")});config.series.forEach(function(serie){Ext.applyIf(serie,{stacked:serie.type=="bar"?false:true,showInLegend:chartType=="barline"&&serie.type=="line"?false:true,smooth:true,showMarkers:serie.type=="bar"?false:true,
marker:chartType=="barline"&&serie.type=="line"?null:{type:"circle",radius:2},style:{lineWidth:1,fillOpacity:chartType=="barline"&&serie.type=="bar"?.01:1,strokeOpacity:chartType=="barline"&&serie.type=="bar"?.1:1},highlight:true,highlightCfg:{scaling:serie.type=="bar"?1.1:2},label:{},tooltip:{trackMouse:true,renderer:this.getItemToolTip,scope:this},listeners:{itemclick:function(chart,item,event,eOpts){if(this.clickTimer)clearTimeout(this.clickTimer);if(this.blockClick)return;this.blockClick=true;
Ext.defer(function(){this.blockClick=false},1E3,this);if(this.getApiParam("mode")=="document"){var parts=item.field.split("_"),docIndex=parts[2],doc=this.getCorpus().getDocument(docIndex),tokens=doc.get("tokensCount-lexical"),position=parseInt(item.index*tokens/parseInt(this.getApiParam("bins")));this.dispatchEvent("documentIndexTermsClicked",this,[{term:item.series.term,docIndex:parts[2],position:position}])}else{if(this.clickTimer)clearTimeout(this.clickTimer);var me=this;this.clickTimer=setTimeout(function(){me.dispatchEvent("documentIndexTermsClicked",
me,[{term:item.series.term,docIndex:item.index}])},300)}},itemdblclick:function(chart,item,event,eOpts){if(this.clickTimer)clearTimeout(this.clickTimer);this.blockClick=true;Ext.defer(function(){this.blockClick=false},1E3,this);if(this.getApiParam("mode")!="document")var m=Ext.create("Ext.menu.Menu",{items:[{text:this.localize("drillTerm"),tooltip:this.localize("drillTermTip"),handler:function(){this.setApiParams({mode:"document",query:item.series.term});this.loadDocumentTerms()},scope:this},{text:this.localize("drillDocument"),
tooltip:this.localize("drillDocumentTip"),handler:function(){this.setApiParams({mode:"document",docIndex:item.index});this.loadDocumentTerms()},scope:this}],listeners:{hide:function(m){Ext.defer(function(){this.destroy()},200,m)},scope:this}}).showAt(event.pageX,event.pageY)},scope:this}});Ext.applyIf(serie.label,{display:"over",field:"index",fontSize:11,translateY:chartType=="line"?9:undefined});if(!labels)serie.label.display="none"},this);Ext.applyIf(config,{animation:true,plugins:{ptype:"chartitemevents",
moveEvents:true},legend:{docked:"top",listeners:{itemclick:function(legend,record,dom,index){if(legend.getStore().getCount()<legend.chart.series.length&&this.getApiParam("chartType")=="barline"){var term=record.get("name"),disabled=record.get("disabled");legend.chart.series.forEach(function(serie){if(serie.getTitle()==term)serie.setHidden(disabled)});legend.chart.redraw()}},scope:this}},interactions:["itemhighlight","crosszoom"],listeners:{}});Ext.applyIf(config.listeners,{itemhighlightchange:function(chart,
item){chart.el.dom.style.cursor=item?"pointer":""},afterrender:function(){return;Ext.defer(function(){Ext.tip.QuickTipManager.register({target:this.getTargetEl().down(".x-legend-container"),text:this.localize("toggleTip")})},1,this)},scope:this});config.axes.forEach(function(axis){Ext.applyIf(axis,{title:{},label:{}});Ext.applyIf(axis.title,{scaling:.75});Ext.applyIf(axis.label,{scaling:.75});if(axis.type=="category"){var titles="";config.store.each(function(r){titles+=r.get("index")});if(titles.length>
this.getTargetEl().getWidth()/9)Ext.applyIf(axis.label,{rotate:{degrees:-30}});Ext.applyIf(axis,{labelInSpan:true})}},this);this.query("chart").forEach(function(chart){this.remove(chart,true)},this);var chart=Ext.create("Ext.chart.CartesianChart",config);this.add(chart)},reloadFromChart:function(){var chart=this.down("chart");if(chart){var terms=[];chart.series.forEach(function(serie){terms.push(serie.getTitle())});this.fireEvent("termsClicked",this,terms)}}});Ext.define("Voyant.panel.NoTool",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.notool",statics:{i18n:{},api:{tool:undefined}},config:{html:undefined,notYetImplemented:["Centroid","DocumentInputAdd","DocumentTypeCollocateFrequenciesGrid","EntitiesBrowser","Equalizer","FeatureClusters","Flowerbed","KwicsTagger","Lava","Mandala","MicroSearch","NetVizApplet","PaperDrill","RezoViz","Sunburst","Termometer","Ticker","TokensViz","ToolBrowser","ToolBrowserLarge","VoyeurTagline","WordCloud",
"VoyeurTagline","WordCountFountain"]},constructor:function(){Ext.apply(this,{title:this.localize("title")});this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},listeners:{boxready:function(container,width,height){var tool=this.getApiParam("notool");if(tool){if(Ext.isArray(tool))tool=tool[0];var msg="";var oldTools=this.getNotYetImplemented();for(var i=0,len=oldTools.length;i<len;i++)if(tool==oldTools[i])return Ext.Msg.show({title:this.localize("error"),
message:(new Ext.Template(this.localize("notImplemented"))).applyTemplate([tool]),buttons:Ext.Msg.YESNO,buttonText:{yes:this.localize("currentButton"),no:this.localize("oldButton")},icon:Ext.Msg.ERROR,scope:this,fn:function(btn){var url;if(btn=="yes")url=this.getNewUrl();else{url="http://voyant-tools.org/tool/"+tool+"/";var query=Ext.Object.fromQueryString(document.location.search);delete query["tool"];queryString=Ext.Object.toQueryString(query);if(queryString)url+="?"+queryString}window.location.replace(url)}});
Ext.Msg.show({title:this.localize("error"),message:(new Ext.Template(this.localize("badToolSpecified"))).applyTemplate([tool]),buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR,scope:this,fn:function(btn){window.location.replace(this.getNewUrl())}})}else if(!this.config.html)Ext.Msg.show({title:this.localize("error"),message:this.localize("noToolSpecified"),buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR,scope:this,fn:function(btn){window.location.replace(this.getNewUrl())}})}},getNewUrl:function(){var query=Ext.Object.fromQueryString(document.location.search);
delete query["tool"];queryString=Ext.Object.toQueryString(query);return this.getApplication().getBaseUrl()+(queryString?"?"+queryString:"")}});Ext.define("Voyant.panel.VoyantFooter",{extend:"Ext.container.Container",mixins:["Voyant.panel.Panel"],alias:"widget.voyantfooter",statics:{i18n:{}},height:18,cls:"x-tab-bar-default voyant-footer",listeners:{boxready:function(container,width,height){var parts=["\x3ca href\x3d'"+container.getBaseUrl()+"docs/' target\x3d'voyantdocs'\x3e"+container.localize("voyantTools")+"\x3c/a\x3e ",", \x3ca href\x3d'http://stefansinclair.name/'\x3eSt\x26eacute;fan Sinclair\x3c/a\x3e \x26amp; \x3ca href\x3d'http://geoffreyrockwell.com'\x3eGeoffrey Rockwell\x3c/a\x3e",
" (\x3ca href\x3d'http://creativecommons.org/licenses/by/4.0/' target\x3d'_blank'\x3e\x3cspan class\x3d'cc'\x3ec\x3c/span\x3e\x3c/a\x3e "+(new Date).getFullYear()+")"," \x3ca class\x3d'privacy' href\x3d'"+this.getBaseUrl()+"docs/#!/guide/about-section-privacy-statement' target\x3d'top'\x3e"+container.localize("privacy")+"\x3c/a\x3e"," v. "+Voyant.application.getVersion()+(Voyant.application.getBuild()?" ("+Voyant.application.getBuild()+")":"")];var footer="";var footerWidth=0;var partWidth;var el=
container.getEl();for(var i=0;i<parts.length;i++){partWidth=el.getTextWidth(parts[i].replace(/data-qtip.+?--\x3e/,"\x3e").replace(/<.+?>/g,""));if(footerWidth+partWidth<width){footer+=parts[i];footerWidth+=partWidth}}container.update(footer);Ext.tip.QuickTipManager.register({target:container.getTargetEl().dom.querySelector(".privacy"),text:this.localize("privacyMsg")})},beforedestroy:function(container){Ext.tip.QuickTipManager.unregister(container.getTargetEl().dom.querySelector(".privacy"))}}});Ext.define("Voyant.panel.VoyantHeader",{extend:"Ext.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.voyantheader",statics:{i18n:{}},constructor:function(config){Ext.apply(this,{id:"voyantheader",title:"",layout:"fit",html:'\x3cdiv id\x3d"logo-container"\x3e\x3c/div\x3e',collapseMode:undefined,collapsible:true,animCollapse:false,titleCollapse:false,floatable:false,header:true,hideCollapseTool:true,listeners:{collapse:this.onCollapse},titleAlign:"center"});this.callParent(arguments);Ext.applyIf(config,
{moreTools:["corpusset","scatterplot","termsradio"],includeTools:{save:true,plus:true,help:true,language:this.getLanguageToolMenu(),home:{type:"home",tooltip:this.localize("homeTip"),xtype:"toolmenu",glyph:"xf015@FontAwesome",handler:function(btn){var panel=this.up("panel");Ext.Msg.confirm(panel.localize("home"),panel.localize("homeConfirm"),function(buttonId){if(buttonId=="yes")document.location.href=panel.getBaseUrl()},this)}}}});this.mixins["Voyant.panel.Panel"].constructor.call(this,config)},
onCollapse:function(panel){Ext.defer(function(){this.setTitle("\x3cimg src\x3d'"+this.getBaseUrl()+"resources/images/voyant-logo-tiny.png' style\x3d'vertical-align: middle' alt\x3d'Voyant Tools' /\x3e "+this.localize("title"))},10,panel)}});Ext.define("Voyant.panel.CorpusSet",{extend:"Ext.panel.Panel",requires:["Voyant.panel.VoyantTabPanel","Voyant.panel.Cirrus","Voyant.panel.Summary","Voyant.panel.CorpusTerms","Voyant.panel.Reader","Voyant.panel.Documents","Voyant.panel.Trends","Voyant.panel.Contexts","Voyant.panel.Phrases","Voyant.panel.DocumentTerms","Voyant.panel.CorpusCollocates","Voyant.panel.CollocatesGraph","Voyant.panel.StreamGraph","Voyant.panel.TermsBerry"],mixins:["Voyant.panel.Panel"],alias:"widget.corpusset",isConsumptive:true,
statics:{i18n:{},api:{panels:undefined},glyph:"xf17a@FontAwesome"},constructor:function(config){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},layout:"border",header:false,items:[{region:"west",flex:3,layout:"fit",moreTools:["cirrus","corpusterms"],xtype:"voyanttabpanel",split:{width:5},tabBarHeaderPosition:0,items:[{xtype:"cirrus"},{xtype:"corpusterms"},{xtype:"collocatesgraph"}]},{region:"center",flex:3,layout:"fit",xtype:"voyanttabpanel",tabBarHeaderPosition:0,
items:[{xtype:"reader"},{xtype:"termsberry"}]},{region:"east",flex:3,layout:"fit",xtype:"voyanttabpanel",split:{width:5},tabBarHeaderPosition:0,moreTools:["trends","collocatesgraph","corpuscollocates"],items:[{xtype:"trends"},{xtype:"documentterms"}]},{region:"south",flex:2,split:{width:5},layout:"border",items:[{layout:"fit",region:"center",flex:1,xtype:"voyanttabpanel",split:{width:5},tabBarHeaderPosition:0,moreTools:["summary","documents","phrases"],items:[{xtype:"summary"},{xtype:"documents"},
{xtype:"phrases"}]},{layout:"fit",region:"east",flex:1,xtype:"voyanttabpanel",split:{width:5},tabBarHeaderPosition:0,moreTools:["contexts","documentterms"],items:[{xtype:"contexts"},{xtype:"bubblelines"},{xtype:"correlations"}]}]}],listeners:{boxready:function(){var panelsString=this.getApiParam("panels");if(panelsString){var panels=panelsString.toLowerCase().split(",");var tabpanels=this.query("voyanttabpanel");for(var i=0,len=panels.length;i<len;i++){var panel=panels[i];if(panel&&Ext.ClassManager.getByAlias("widget."+
panel)&&tabpanels[i]){var tabpanel=tabpanels[i];if(tabpanel.getActiveTab().isXType(panel))continue;tabpanel.items.each(function(item,index){if(item.isXType(panel)){this.setActiveTab(index);return false}},tabpanel);if(tabpanel.getActiveTab().isXType(panel))continue;tabpanel.getActiveTab().replacePanel(panel)}}}var cirrus=this.down("cirrus");var me=this;if(cirrus){var toolbar=cirrus.down("toolbar");toolbar.add({xtype:"tbfill"});toolbar.add({text:" ",listeners:{click:{fn:function(){me.add({region:"north",
width:"100%",html:'\x3cdiv align\x3d"center"\x3e\x3ctable\x3e\x3ctr\x3e\x3ctd\x3e\x3cimg src\x3d"http://stefansinclair.name/wordpress/wp-content/uploads/2011/07/Sinclair_Stefan_small.jpg" style\x3d"height: 60px"\x3e\x3c/td\x3e\x3ctd style\x3d"text-align: center; padding-left: 2em; padding-right: 2em;"\x3eBy Athena, you found us hidden\x3cbr\x3eup here between the panels!\x3c/td\x3e\x3ctd\x3e\x3cimg src\x3d"http://geoffreyrockwell.com/images/home_09.jpg" style\x3d"height: 60px"\x3e\x3c/td\x3e\x3c/tr\x3e\x3c/table\x3e\x3c/div\x3e'})},
single:true},render:function(b){b.getTargetEl().dom.className=""}}})}},loadedCorpus:function(src,corpus){if(this.hasCorpusAccess(corpus)==false&&!this.getApiParam("panels")){var tabpanels=this.query("voyanttabpanel");tabpanels[1].setActiveTab(1);tabpanels[1].getActiveTab().fireEvent("loadedCorpus",src,corpus);tabpanels[4].setActiveTab(1)}if(corpus.getDocumentsCount()>30){var bubblelines=this.down("bubblelines");if(bubblelines)bubblelines.up("voyanttabpanel").remove(bubblelines)}},panelChange:function(src){var panels=
[];this.query("voyanttabpanel").forEach(function(item){panels.push(item.getActiveTab().xtype)});this.getApplication().setApiParam("panels",panels.join(","))}}});Ext.define("Voyant.panel.ScatterSet",{extend:"Ext.panel.Panel",requires:["Voyant.panel.ScatterPlot","Voyant.panel.Documents","Voyant.panel.Trends","Voyant.panel.Contexts"],mixins:["Voyant.panel.Panel"],alias:"widget.scatterset",statics:{i18n:{},glyph:"xf17a@FontAwesome"},constructor:function(config){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},layout:"hbox",header:false,items:[{flex:3,height:"100%",xtype:"scatterplot"},{split:{width:5},flex:1,height:"100%",
layout:"vbox",defaults:{width:"100%",flex:1},items:[{xtype:"documents",collapsible:true},{xtype:"trends",collapsible:true},{xtype:"contexts",collapsible:true}]}]});Ext.define("Voyant.panel.Subset",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel","Voyant.util.Downloadable"],alias:"widget.subset",isConsumptive:true,statics:{i18n:{},api:{stopList:"auto",documentFilename:["pubDate","title"],documentFormat:"SOURCE"},glyph:"xf0ce@FontAwesome"},config:{options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"}],inDocumentsCountOnly:false,stopList:"auto",store:undefined},constructor:function(config){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,
arguments)},initComponent:function(config){var me=this;Ext.applyIf(me,{introHtml:"",fieldItems:[{xtype:"querysearchfield",fieldLabel:this.localize("titleLabel"),tokenType:"title"},{xtype:"querysearchfield",fieldLabel:this.localize("authorLabel"),tokenType:"author"},{xtype:"querysearchfield",fieldLabel:this.localize("lexicalLabel")}],fieldColumns:2});Ext.applyIf(me,{intro:{margin:"5 0 5 0",layout:"center",items:{itemId:"intro",html:me.introHtml}},fields:{xtype:"container",layout:"center",items:{xtype:"container",
maxWidth:1200,layout:{type:"table",columns:me.fieldColumns},items:me.fieldItems.map(function(item){return{xtype:"container",defaults:{margin:"5 10 5 10",inDocumentsCountOnly:me.getInDocumentsCountOnly(),stopList:me.getStopList(),showAggregateInDocumentsCount:true,isDocsMode:true,flex:1,maxWidth:800,labelAlign:"right"},items:Ext.applyIf(item,{fieldLabel:me.localize((item.tokenType?item.tokenType:"lexical")+"Label")})}},this)}},foot:{layout:"center",margin:"20 0 0 0",items:{xtype:"container",layout:{type:"hbox",
align:"middle"},defaults:{margin:"0 5 0 5",width:200},items:[{xtype:"button",itemId:"export",glyph:"xf08e@FontAwesome",text:this.localize("sendToVoyantButton"),handler:me.handleSendToVoyant,scope:me},{xtype:"button",glyph:"xf019@FontAwesome",itemId:"download",text:this.localize("downloadButton"),handler:me.handleExport,scope:me},{xtype:"container",hidden:true,itemId:"statuscontainer",layout:"vbox",items:[{itemId:"status",bodyStyle:"text-align: center",width:200},{xtype:"container",width:200,items:{xtype:"sparklineline",
chartRangeMin:0,itemId:"sparkline",margin:"0 0 0 10",values:[1,1],height:20,width:200}}]}]}}});Ext.applyIf(me,{items:[me.intro,me.fields,me.foot]});me.on("loadedCorpus",function(src,corpus){me.getStore().setCorpus(corpus);if(me.getInitialConfig("introHtml")==undefined&&me.getInitialConfig("intro")==undefined)me.queryById("intro").setHtml(corpus.getString())},me);me.on("query",function(src,queries){this.performAggregateQuery(this.getAggregateQuery())});me.setStore(Ext.create("Voyant.data.store.DocumentQueryMatches"));
me.callParent([config])},handleSendToVoyant:function(){if(!this.getStore().lastOptions||!this.getStore().lastOptions.params.query)Ext.Msg.alert(this.localize("sendToVoyantButton"),(new Ext.XTemplate(this.localize("sendToVoyantNoQuery"))).apply([this.getBaseUrl()+"?corpus\x3d"+this.getStore().getCorpus().getId()]));else{var me=this;this.mask("Creating corpus\u2026");this.getStore().load({params:{query:this.getStore().lastOptions.params.query,createNewCorpus:true},callback:function(records,operation,
success){me.unmask();if(success&&records&&records.length==1){var corpus=operation.getProxy().getReader().metaData;var url=me.getBaseUrl()+"?corpus\x3d"+corpus;me.openUrl(url)}}})}},handleExport:function(){if(!this.getStore().lastOptions||!this.getStore().lastOptions.params.query)this.downloadFromCorpusId(this.getStore().getCorpus().getId());else{var record=this.getStore().getAt(0);if(this.getStore().lastOptions.params.query&&record&&record.getCount()==0)this.showMsg({message:this.localize("noMatches")});
else this.getStore().load({params:{query:this.getStore().lastOptions.params.query,createNewCorpus:true,temporaryCorpus:true},callback:function(records,operation,success){if(success&&records&&records.length==1)this.downloadFromCorpusId(operation.getProxy().getReader().metaData)},scope:this})}},openDownloadCorpus:function(corpus){var url=this.getTromboneUrl()+"?corpus\x3d"+corpus+"\x26tool\x3dcorpus.CorpusExporter\x26outputFormat\x3dzip"+"\x26zipFilename\x3dDownloadedVoyantCorpus-"+corpus+".zip"+(this.getApiParam("documentFormat")?
"\x26documentFormat\x3d"+this.getApiParam("documentFormat"):"")+(this.getApiParam("documentFilename")?"\x26documentFilename\x3d"+this.getApiParam("documentFilename"):"");this.openUrl(url)},performAggregateQuery:function(query){var me=this,statuscontainer=me.queryById("statuscontainer"),status=me.queryById("status"),spark=me.queryById("sparkline");if(statuscontainer)statuscontainer.show();if(status)status.setHtml((new Ext.XTemplate('{0:plural("documents")} matching.')).apply([0]));if(spark)spark.setValues([0,
0]);if(query){var docsCount=this.getStore().getCorpus().getDocumentsCount();this.getStore().load({params:{query:query,withDistributions:true,bins:docsCount>100?100:docsCount},callback:function(records,operation,success){var exp=me.queryById("export");var spark=me.queryById("sparkline");if(success&&records&&records.length==1){if(status)status.setHtml((new Ext.XTemplate('{0:plural("document")} matching.')).apply([records[0].getCount()]));if(spark)spark.setValues(records[0].getDistributions())}}})}else if(this.getStore().lastOptions)this.getStore().lastOptions.params.query=
undefined},getAggregateQuery:function(){var aggregateQueries=[];Ext.ComponentQuery.query("field",this).forEach(function(field){if(field.getTokenType&&field.getValue){var tokenType=field.getTokenType();var vals=Ext.Array.from(field.getValue());if(vals.length>0)if(vals.length>0)aggregateQueries.push("+("+vals.map(function(val){return tokenType+":"+val}).join("|")+")")}});return aggregateQueries.join(" ")}});Ext.define("Voyant.panel.CollocatesSet",{extend:"Ext.panel.Panel",requires:["Voyant.panel.ScatterPlot","Voyant.panel.Documents","Voyant.panel.Trends","Voyant.panel.Contexts"],mixins:["Voyant.panel.Panel"],alias:"widget.collocatesset",statics:{i18n:{},glyph:"xf17a@FontAwesome"},constructor:function(config){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},layout:"vbox",header:false,items:[{layout:"hbox",align:"stretch",width:"100%",height:"100%",flex:2,
defaults:{width:"100%",height:"100%",flex:1,frame:true,border:true},items:[{xtype:"corpusterms"},{xtype:"documentterms"},{xtype:"corpuscollocates"}]},{width:"100%",height:"100%",split:{width:5},layout:"hbox",flex:3,defaults:{width:"100%",height:"100%",flex:1,frame:true,border:true},items:[{xtype:"contexts"},{xtype:"collocatesgraph"}]}]});Ext.define("Voyant.panel.BubblelinesSet",{extend:"Ext.panel.Panel",requires:["Voyant.panel.Bubblelines","Voyant.panel.Contexts","Voyant.panel.Reader"],mixins:["Voyant.panel.Panel"],alias:"widget.bubblelinesset",statics:{i18n:{},glyph:"xf17a@FontAwesome"},constructor:function(config){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},layout:"vbox",header:false,items:[{width:"100%",height:"100%",xtype:"bubblelines",flex:5},{width:"100%",height:"100%",split:{width:5},
layout:"hbox",flex:4,defaults:{width:"100%",height:"100%",flex:1,frame:true,border:true},items:[{xtype:"contexts"},{xtype:"reader"}]}]});Ext.define("Voyant.panel.CustomSet",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.customset",statics:{i18n:{},api:{layout:undefined,tableLayout:undefined},glyph:"xf17a@FontAwesome"},header:false,height:"100%",width:"100%",constructor:function(){this.mixins["Voyant.util.Api"].constructor.apply(this,arguments);this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},initComponent:function(){if(this.getApiParam("layout"))Ext.apply(this,{layout:"border",
items:[]});else if(this.getApiParam("tableLayout"))this.initTableLayout();this.callParent()},listeners:{loadedCorpus:function(src,corpus){if(this.getApiParam("layout"))this.query("panel").forEach(function(p){p.fireEvent("loadedCorpus",src,corpus)})},boxready:function(panel){if(this.getApiParam("layout"))this.initBorderLayoutComponents();else if(this.getApiParam("tableLayout")){this.doTableSizing();this.on("resize",function(panel,newwidth,newheight,oldwidth,oldheight){if(oldwidth!==undefined&&oldheight!==
undefined){var widthRatio=newwidth/oldwidth;var heightRatio=newheight/oldheight;this.doTableSizing(widthRatio,heightRatio)}},this)}else this.showError(this.localize("noLayoutSpecified"))}},initBorderLayoutComponents:function(){var layoutString=decodeURI(this.getApiParam("layout")).replace(/r1/g,"region").replace(/i1/g,"items").replace(/s1/g,"split").replace(/c1/g,"collapsible").replace(/c2/g,"collapsed").replace(/w1/g,"width").replace(/h1/g,"height").replace(/p1/g,"%").replace(/"x1":"/g,'"xtype":"').replace(/c3/g,
"center").replace(/n1/g,"north").replace(/e1/g,"east").replace(/s2/g,"south").replace(/w2/g,"west").replace(/"xtype":"(\w+)"/g,function(match,tool){if(!Ext.ClassManager.getByAlias("widget."+tool.toLowerCase()))if(tool=="Links")tool="CollocatesGraph";else if(tool=="CorpusGrid")tool="Documents";else if(tool=="CorpusSummary")tool="Summary";else if(tool=="CorpusTypeFrequenciesGrid")tool="CorpusTerms";else if(tool=="DocumentInputAdd")tool="CorpusTerms";else if(tool=="DocumentTypeCollocateFrequenciesGrid")tool=
"CorpusTerms";else if(tool=="DocumentTypeFrequenciesGrid")tool="DocumentTerms";else if(tool=="DocumentTypeKwicsGrid")tool="Contexts";else if(tool=="TypeFrequenciesChart")tool="Trends";else if(tool=="VisualCollocator")tool="CollocatesGraph";else tool="NoTool";return'"xtype":"'+tool.toLowerCase()+'"'+(tool=="NoTool"?',"html":"'+(new Ext.Template(panel.localize("noSuchTool"))).applyTemplate([tool])+'"':"")});var items;try{items=Ext.decode(layoutString)}catch(e){items={region:"center",html:"\x3cdiv\x3eError constructing layout:"+
e+"\x3c/div\x3e"}}if(items==null)items={region:"center",html:"\x3cdiv\x3eError: no layout information found.\x3c/div\x3e"};this.addBorderLayouts(items);this.on("add",function(custom,cmp){cmp.on("boxready",function(cmp){})});this.add(items)},addBorderLayouts:function(items){var size=Ext.getBody().getSize();for(var i=0;i<items.length;i++){var item=items[i];if(Ext.isString(item.width))item.width=Math.round(size.width*parseInt(item.width)/100);else if(Ext.isString(item.height))item.height=Math.round(size.height*
parseInt(item.height)/100);if(item.items&&item.items.length>1){item.layout="border";this.addBorderLayouts(item.items)}else item.layout="fit"}},initTableLayout:function(){Ext.suspendLayouts();var tableLayout=decodeURI(this.getApiParam("tableLayout"));if(tableLayout&&tableLayout.charAt(0)!="{"&&tableLayout.charAt(0)!="["){var cells=[];tableLayout.replace(/;/g,",").split(/,\s*/).forEach(function(cell){cells.push(/^"'/.test(cell)?cell:'"'+cell+'"')});tableLayout="["+cells.join(",")+"]"}var layout=Ext.decode(tableLayout);
if(Ext.isArray(layout))layout={cells:layout};if(!layout.numCols&&layout.cells&&Ext.isArray(layout.cells))if(layout.cells.length<3)layout.numCols=layout.cells.length;else if(layout.cells.length<5)layout.numCols=Math.ceil(layout.cells.length/2);else layout.numCols=Math.ceil(layout.cells.length/3);if(layout.numCols!=null&&layout.cells&&Ext.isArray(layout.cells)){var items=[];for(var i=0;i<layout.cells.length;i++){var cell=layout.cells[i];if(Ext.isObject(cell)){cell.cellWidth=parseFloat(cell.width)||
undefined;cell.cellHeight=parseFloat(cell.height)||undefined;delete cell.width;delete cell.height;items.push(cell)}else if(Ext.isArray(cell)){var colspan=1,rowspan=1;xtype=undefined;if(cell[0]&&Ext.isNumber(cell[0])){colspan=cell[0];cell.shift()}if(cell[0]&&Ext.isString(cell[0])){xtype=cell[0].toLowerCase();cell.shift()}if(cell[0]&&Ext.isNumber(cell[0]))rowspan=cell[0];if(xtype)items.push({colspan:colspan,rowspan:rowspan,xtype:xtype})}else if(Ext.isString(cell))items.push({xtype:cell.toLowerCase(),
colspan:1,rowspan:1})}Ext.apply(this,{layout:{type:"table",width:"100%",height:"100%",columns:layout.numCols,tableAttrs:{style:{width:"100%",height:"100%"}},tdAttrs:{style:{padding:"0px",verticalAlign:"top"}}},defaults:{width:10,height:10,border:true},items:items})}else this.showError("badTableLayoutDefinition");Ext.resumeLayouts()},doTableSizing:function(widthRatio,heightRatio){var sizeMap={};var table=this.getTargetEl().down(".x-table-layout");var tableSize=table.getSize(false);var rows=table.dom.rows;
for(var i=0;i<rows.length;i++){var cells=rows[i].cells;for(var j=0;j<cells.length;j++){var cell=cells[j];var cellEl=Ext.get(cell);var panelEl=cellEl.down(".x-panel");var cmpId=panelEl.id;var size;if(widthRatio!==undefined&&heightRatio!==undefined){size=panelEl.getSize(false);size.width=size.width*widthRatio;size.height=size.height*heightRatio}else{var sizeObj=cellEl.getSize(false);var cmp=Ext.getCmp(cmpId);var widthPercent=cmp.initialConfig.cellWidth;var heightPercent=cmp.initialConfig.cellHeight;
if(widthPercent!==undefined){sizeObj.width=tableSize.width*(widthPercent/100);cellEl.setWidth(sizeObj.width)}if(heightPercent!==undefined){sizeObj.height=tableSize.height*(heightPercent/100);cellEl.setHeight(sizeObj.height)}size=sizeObj}sizeMap[cmpId]=size}}for(var id in sizeMap){var size=sizeMap[id];Ext.getCmp(id).setSize(size)}this.updateLayout()}});Ext.define("Voyant.panel.Veliza",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],xtype:"veliza",autoScroll:true,statics:{i18n:{},api:{script:"",message:undefined},glyph:"xf0e6@FontAwesome"},config:{previous:[]},constructor:function(){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);var me=this;Ext.apply(this,{title:this.localize("title"),glyph:"xf0e6@FontAwesome",layout:{type:"border",align:"stretch"},items:[{itemId:"chat",html:"\x3cform class\x3d'chat'\x3e\x3c/form\x3e",
region:"center",flex:2,autoScroll:true},{itemId:"script",xtype:"form",region:"east",split:true,title:this.localize("scriptEditor"),layout:{type:"vbox",align:"stretch"},items:[{html:(new Ext.XTemplate(this.localize("scriptIntro"))).apply([me.getBaseUrl()+"docs/#!/guide/veliza"])},{xtype:"textarea",name:"editor",fieldStyle:"white-space: pre",value:me.getApiParam("script"),flex:1,listeners:{afterrender:function(editor){var corpus=me.getApiParam("corpus");if(!corpus)return;editor.mask(me.localize("loadingScript"));
Ext.Ajax.request({url:me.getTromboneUrl(),params:{tool:"corpus.Veliza",script:me.getApiParam("script"),corpus:corpus}}).then(function(response){var obj=Ext.decode(response.responseText);if(obj&&obj.veliza&&obj.veliza.script){editor.setValue(obj.veliza.script);editor.resetOriginalValue()}else if(obj&&obj.veliza&&obj.veliza.id)me.setApiParam("script",obj.veliza.id);else me.showError(me.localize("unableFetchScript"));editor.unmask()},function(response){me.showError(response)})},scope:this}}],collapsed:true,
collapsible:true,flex:1}],dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{xtype:"textfield",itemId:"chatfield",emptyText:this.localize("typeAndEnter"),flex:1,listeners:{specialkey:function(field,e){if(e.getKey()==e.ENTER){me.handleUserSentence(field.getValue());field.setValue("")}}}},{xtype:"button",text:this.localize("send"),handler:function(){var tf=this.up("toolbar").down("textfield");me.handleUserSentence(tf.getValue(),false);tf.setValue("")}},{xtype:"button",text:this.localize("fromCorpus"),
handler:function(){me.handleUserSentence("",true)}}]}]});this.callParent();this.on("boxready",function(cmp){cmp.addSentence("fromThem","Hello, I'm Veliza, and I'm here to talk to you about your texts (you may know my sister \x3ca href\x3d'https://en.wikipedia.org/wiki/ELIZA' target\x3d'_blank'\x3eEliza\x3c/a\x3e she's a famous psychotherapist). I'm just learning to talk about text documents, but please, let me know about any anxieties you're feeling about your texts. Type a message in the box below and hit enter. Or, if you're feeling playful, hit the \x3ci\x3efrom text\x3c/i\x3e bottom in the lower right-hand corner to fetch a sentence from the corpus.");
this.sendApiParamMessage()})},sendApiParamMessage:function(){if(this.getApiParam("message"))if(this.getCorpus()){var sentences=Ext.Array.from(this.getApiParam("message"));var sentence=sentences.shift();if(sentence){if(sentences)this.setApiParam("message",sentences);this.handleUserSentence(sentence,undefined,true)}}else Ext.defer(this.sendApiParamMessage,100,this,[true])},handleUserSentence:function(sentence,fromCorpus,noScroll){sentence=sentence.trim();if(sentence||fromCorpus){if(sentence)this.addSentence("myMessage",
sentence);this.mask();var me=this;var editor=this.getComponent("script").down("textarea");Ext.Ajax.request({url:this.getApplication().getTromboneUrl(),params:{corpus:me.getCorpus()?me.getCorpus().getId():undefined,tool:"corpus.Veliza",sentence:sentence,fromCorpus:fromCorpus?true:false,script:editor.isDirty()?editor.getValue():this.getApiParam("script"),noCache:Ext.id()},success:function(response,opts){me.unmask();var response=Ext.decode(response.responseText);if(response.veliza.id){me.setApiParam("script",
response.veliza.id);editor.resetOriginalValue()}var veliza=response.veliza.response;var hidden=veliza.match(/\x3c!-- (.+?) --\x3e/);if(hidden){var json=Ext.decode(hidden[1]);for(key in json.params)json.params[key]=json.params[key].trim();veliza+="\x3cbr/\x3e\x3ciframe width\x3d'"+(json.width?json.width:"100%")+"' height\x3d'"+(json.height?json.height:"250px")+"' src\x3d'"+me.getApplication().getBaseUrl()+"tool/"+json.tool+"/?corpus\x3d"+me.getCorpus().getId()+"\x26minimal\x3dtrue\x26"+Ext.Object.toQueryString(json.params)+
"'\x3e\x3c/iframe\x3e"}var sentence=response.veliza.sentence;me.setPrevious(response.veliza.previous);if(fromCorpus){meta=response.veliza.docIndex>-1?me.getCorpus().getDocument(response.veliza.docIndex).getShortLabel():undefined;me.addSentence("myMessage",sentence,meta);Ext.Function.defer(function(){this.addSentence("fromThem",veliza);if(!noScroll)this.body.scroll("b",Infinity)},500,me)}else{me.addSentence("fromThem",veliza);if(!noScroll)me.body.scroll("b",Infinity)}if(me.getApiParam("message"))me.sendApiParamMessage()},
failure:function(response,opts){me.showResponseError("Unable to get response from Veliza.",response)}})}},addSentence:function(speaker,sentence,meta){var body=this.getComponent("chat").body;var el=body.down("form").insertHtml("beforeEnd",'\x3cdiv class\x3d"message"\x3e\x3cdiv class\x3d"'+speaker+'"\x3e\x3cp\x3e'+sentence+"\x3c/p\x3e"+(meta?"\x3cdate\x3e"+meta+"\x3c/date\x3e":"")+"\x3c/div\x3e\x3c/div\x3e",true);body.scroll("b",Infinity)}});Ext.define("Voyant.panel.WordTree",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.wordtree",statics:{i18n:{},api:{query:undefined,docId:undefined,docIndex:undefined,stopList:"auto",context:10,limit:100},glyph:"xf0e8@FontAwesome"},config:{tree:undefined,kwicStore:undefined,options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"}],numBranches:5,lastClick:1},doubleClickDelay:300,constructor:function(config){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,
arguments)},initComponent:function(){Ext.apply(this,{title:this.localize("title"),dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{xtype:"querysearchfield"},'\x3cspan data-qtip\x3d"'+this.localize("poolTip")+'" class\x3d"info-tip"\x3e'+this.localize("pool")+"\x3c/span\x3e",{xtype:"slider",itemId:"poolSlider",minValue:10,value:100,maxValue:1E3,increment:5,width:50,listeners:{render:function(slider){slider.setValue(this.getApiParam("limit"))},changecomplete:function(slider,
newValue){this.setApiParam("limit",slider.getValue());this.reload()},scope:this}},'\x3cspan data-qtip\x3d"'+this.localize("branchesTip")+'" class\x3d"info-tip"\x3e'+this.localize("branches")+"\x3c/span\x3e",{xtype:"slider",itemId:"branchesSlider",minValue:2,value:5,maxValue:15,increment:1,width:50,listeners:{render:function(slider){slider.setValue(this.getNumBranches())},changecomplete:function(slider,newValue){this.setNumBranches(slider.getValue());this.reload()},scope:this}},'\x3cspan data-qtip\x3d"'+
this.localize("contextTip")+'" class\x3d"info-tip"\x3e'+this.localize("context")+"\x3c/span\x3e",{xtype:"slider",itemId:"contextSlider",minValue:3,value:10,maxValue:20,increment:2,width:50,listeners:{render:function(slider){slider.setValue(this.getApiParam("context"))},changecomplete:function(slider,newValue){this.setApiParam("context",slider.getValue());this.reload()},scope:this}}]}]});this.setKwicStore(Ext.create("Voyant.data.store.Contexts",{parentPanel:this,proxy:{extraParams:{stripTags:"all"}},
listeners:{load:function(store,records,success,operation){if(success)this.parseRecords(records)},scope:this}}));this.on("loadedCorpus",function(src,corpus){var corpusTerms=corpus.getCorpusTerms({autoLoad:false});corpusTerms.load({callback:function(records,operation,success){if(success&&records.length>0){var firstTerm=records[0].getTerm();this.setRoot(firstTerm)}},scope:this,params:{limit:1,query:this.getApiParam("query"),stopList:this.getApiParam("stopList")}})},this);this.on("query",function(src,
query){if(query!==undefined&&query!="")this.setRoot(query)},this);this.on("termsClicked",function(src,terms){var queryTerms=[];terms.forEach(function(term){if(Ext.isString(term))queryTerms.push(term);else if(term.term)queryTerms.push(term.term);else if(term.getTerm)queryTerms.push(term.getTerm())});this.setRoot(queryTerms)},this);this.on("documentTermsClicked",function(src,terms){var queryTerms=[];terms.forEach(function(term){if(term.getTerm())queryTerms.push(term.getTerm())});this.setRoot(queryTerms)},
this);this.on("resize",function(panel,width,height){var tree=this.getTree();if(tree!==undefined){tree.visWidth(width).visHeight(height);tree.redraw()}},this);this.on("boxready",this.initGraph,this);this.callParent(arguments)},parseRecords:function(records){var parsedRecords=[];for(var i=0;i<records.length;i++){var r=records[i];var pr={id:i,prefix:r.getLeft().trim().split(/\s+/),hit:r.getMiddle(),suffix:r.getRight().trim().split(/\s+/)};parsedRecords.push(pr)}var prefixTokenCounts={};var suffixTokenCounts=
{};for(var i=0;i<parsedRecords.length;i++){var pr=parsedRecords[i];var prefixToken=pr.prefix[pr.prefix.length-1];var suffixToken=pr.suffix[0];if(prefixTokenCounts[prefixToken])prefixTokenCounts[prefixToken]++;else prefixTokenCounts[prefixToken]=1;if(suffixTokenCounts[suffixToken])suffixTokenCounts[suffixToken]++;else suffixTokenCounts[suffixToken]=1}var sortableTokens=[];for(var i=0;i<parsedRecords.length;i++){var pr=parsedRecords[i];var prefixToken=pr.prefix[pr.prefix.length-1];var suffixToken=pr.suffix[0];
sortableTokens.push({suffix:suffixToken,suffixCount:suffixTokenCounts[suffixToken],prefix:prefixToken,prefixCount:prefixTokenCounts[prefixToken]})}var prioritizeSuffix=false;sortableTokens.sort(function(a,b){var s1=a.suffixCount;var s2=b.suffixCount;var p1=a.prefixCount;var p2=b.prefixCount;if(prioritizeSuffix){if(s1>s2)return-1;if(s1<s2)return 1;if(p1>p2)return-1;if(p1<p2)return 1}else{if(p1>p2)return-1;if(p1<p2)return 1;if(s1>s2)return-1;if(s1<s2)return 1}return 0});var len=Math.min(this.getNumBranches(),
sortableTokens.length);var topSuffixTokens=[];var topPrefixTokens=[];for(var i=0;i<len;i++){topSuffixTokens.push(sortableTokens[i].suffix);topPrefixTokens.push(sortableTokens[i].prefix)}var prefixes=[],hits=[],suffixes=[],ids=[];for(var i=0;i<parsedRecords.length;i++){var parsedRecord=parsedRecords[i];if(topSuffixTokens.indexOf(parsedRecord.suffix[0])!=-1||topPrefixTokens.indexOf(parsedRecord.suffix[0])!=-1){prefixes.push(parsedRecord.prefix);hits.push(parsedRecord.hit);suffixes.push(parsedRecord.suffix);
ids.push(parsedRecord.id)}}var caseSensitive=false;var fieldNames=["token","POS"];var fieldDelim="/";var distinguishingFieldsArray=["token","POS"];this.getTree().setupFromArrays(prefixes,hits,suffixes,ids,caseSensitive,fieldNames,fieldDelim,distinguishingFieldsArray);if(!this.getTree().succeeded())this.toastInfo({html:this.localize("emptyText"),align:"bl"})},initGraph:function(){var el=this.getLayout().getRenderTarget();var w=el.getWidth();var h=el.getHeight();var dt=new doubletree.DoubleTree;dt.init("#"+
el.getId()).visWidth(w).visHeight(h).handlers({click:this.clickHandler.bind(this)});this.setTree(dt)},clickHandler:function(node){var now=(new Date).getTime();if(this.getLastClick()&&now-this.getLastClick()<this.doubleClickDelay){this.setLastClick(1);var terms=[],parent=node;while(parent!=null){terms.push(parent.name);parent=parent.parent}this.getApplication().dispatchEvent("termsClicked",this,[terms.reverse().join(" ")])}else this.setLastClick(now)},setRoot:function(query){this.setApiParam("query",
this.stripPunctuation(query));this.getKwicStore().load({params:this.getApiParams()})},reload:function(){var query=this.getApiParam("query");if(query!==undefined)this.setRoot(query)},stripPunctuation:function(value){if(Ext.isString(value))return value.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"");else{var values=[];value.forEach(function(v){values.push(v.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,""))});return values}return""}});Ext.define("Voyant.panel.WordWall",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel","Voyant.util.DiacriticsRemover"],alias:"widget.wordwall",statics:{i18n:{},api:{limit:500,stopList:"auto"},glyph:"xf1e0@FontAwesome"},config:{visId:undefined,vis:undefined,simulation:undefined,nodes:undefined,tempNodes:undefined,zoom:undefined,terms:undefined,segments:undefined,filterOutUniqueTerms:true,currentSegment:undefined,segmentTerms:undefined,segmentTermsQueue:[],segmentDelay:5E3,segmentDelayTimer:undefined,
webWorker:undefined,isSimulating:false,transitionTime:2E3,isTransitioning:false,minFreq:undefined,maxFreq:undefined,letterDistribution:undefined,frequencyScale:undefined,xForceStrength:.2,yForceStrength:.1,chargeStrength:-75,chargeDistance:100,minFontSize:7,maxFontSize:60},count:0,MIN_TERMS:10,MAX_TERMS:2E3,MIN_SCALING:1,MAX_SCALING:20,debugMsg:false,constructor:function(config){this.mixins["Voyant.util.DiacriticsRemover"].constructor.apply(this,arguments);this.setVisId(Ext.id(null,"wordwall_"));
this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},initComponent:function(){Ext.apply(this,{title:this.localize("title"),dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[this.localize("terms"),{width:50,xtype:"slider",minValue:this.MIN_TERMS,maxValue:this.MAX_TERMS,increment:10,listeners:{render:function(slider){slider.setValue(this.getApiParam("limit"))},changecomplete:function(slider,newValue){this.setApiParam("limit",slider.getValue());
this.initLoad()},scope:this}},this.localize("delay"),{width:50,xtype:"slider",minValue:1,maxValue:60,increment:1,listeners:{render:function(slider){slider.setValue(this.getSegmentDelay()/1E3)},changecomplete:function(slider,newValue){this.setSegmentDelay(slider.getValue()*1E3);this.restartSegmentTimer()},scope:this}},this.localize("transition"),{width:50,xtype:"slider",minValue:100,maxValue:5E3,increment:1,listeners:{render:function(slider){slider.setValue(this.getTransitionTime())},changecomplete:function(slider,
newValue){this.setTransitionTime(slider.getValue())},scope:this}},this.localize("xStrength"),{width:50,xtype:"slider",minValue:0,maxValue:1E3,increment:10,listeners:{render:function(slider){slider.setValue(this.getXForceStrength()*1E3)},changecomplete:function(slider,newValue){this.setXForceStrength(slider.getValue()/1E3)},scope:this}},this.localize("yStrength"),{width:50,xtype:"slider",minValue:0,maxValue:1E3,increment:10,listeners:{render:function(slider){slider.setValue(this.getYForceStrength()*
1E3)},changecomplete:function(slider,newValue){this.setYForceStrength(slider.getValue()/1E3)},scope:this}},this.localize("chargeStrength"),{width:50,xtype:"slider",minValue:-1E3,maxValue:0,increment:10,listeners:{render:function(slider){slider.setValue(this.getChargeStrength())},changecomplete:function(slider,newValue){this.setChargeStrength(slider.getValue())},scope:this}},this.localize("chargeDistance"),{width:50,xtype:"slider",minValue:0,maxValue:1E3,increment:10,listeners:{render:function(slider){slider.setValue(this.getChargeDistance())},
changecomplete:function(slider,newValue){this.setChargeDistance(slider.getValue())},scope:this}},{xtype:"button",text:this.localize("stop"),handler:function(b){if(b.getText()===this.localize("stop")){clearInterval(this.getSegmentDelayTimer());b.setText(this.localize("start"))}else{this.restartSegmentTimer();b.setText(this.localize("stop"))}},scope:this},{itemId:"status",xtype:"tbtext",text:""}]}]});this.on("loadedCorpus",function(src,corpus){if(this.isVisible())this.initLoad()},this);this.on("resize",
function(panel,width,height){var vis=Ext.get(this.getVisId());if(vis){var el=this.body;var elHeight=el.getHeight();var elWidth=el.getWidth();vis.el.dom.setAttribute("width",elWidth);vis.el.dom.setAttribute("height",elHeight)}},this);this.callParent(arguments)},initVis:function(){var el=this.getLayout().getRenderTarget();el.update("");var width=el.getWidth();var height=el.getHeight();var svg=d3.select(el.dom).append("svg").attr("id",this.getVisId()).attr("class","wordWall").attr("width",width).attr("height",
height);var g=svg.append("g");this.setVis(g);this.setNodes(g.append("g").attr("class","nodes").selectAll(".node"));this.setTempNodes(g.append("g").attr("class","tempNodes").selectAll("text"));if(this.getWebWorker()===undefined){this.setWebWorker(new Worker(this.getBaseUrl()+"resources/d3/WordWallWorker.js"));this.getWebWorker().onmessage=this.handleWebWorkerMessage.bind(this)}},initLoad:function(){this.initVis();this.count=0;var params=this.getApiParams();params.tool="corpus.CorpusSegmentTerms";Ext.Ajax.request({url:this.getTromboneUrl(),
params:params,success:function(response){var data=Ext.decode(response.responseText);this.setSegments(data.corpusSegmentTerms.segments);var terms=data.corpusSegmentTerms.terms;if(this.getFilterOutUniqueTerms())terms=terms.filter(function(el,index){return el.rawFreqs.indexOf(0)==-1});this.setTerms(terms);this.setCurrentSegment(this.getSegments().length);this.getNextSegment();this.restartSegmentTimer()},failure:function(response){if(this.debugMsg)console.log("failed",response)},scope:this})},restartSegmentTimer:function(){clearInterval(this.getSegmentDelayTimer());
this.setSegmentDelayTimer(setInterval(function(){this.updateNodePositions()}.bind(this),this.getSegmentDelay()))},getNextSegment:function(){var index=this.getCurrentSegment();index++;if(index>=this.getSegments().length)index=0;this.setCurrentSegment(index);if(this.debugMsg)console.log("getNextSegment",index);this.processTermsForSegment(this.getCurrentSegment())},processTermsForSegment:function(segmentIndex){var min=Number.MAX_VALUE;var max=Number.MIN_VALUE;var letterDistMap={a:0,b:0,c:0,d:0,e:0,f:0,
g:0,h:0,i:0,j:0,k:0,l:0,m:0,n:0,o:0,p:0,q:0,r:0,s:0,t:0,u:0,v:0,w:0,x:0,y:0,z:0};this.getTerms().forEach(function(d){d.id=this.idGet(d.term);d.value=d.rawFreqs[segmentIndex];if(d.value>0){if(d.value<min)min=d.value;if(d.value>max)max=d.value;d.title=d.term+" ("+d.value+")";var firstLetter=this.removeDiacritics(d.term.charAt(0)).toLowerCase();d.letter=firstLetter;if(letterDistMap[firstLetter]===undefined)letterDistMap[firstLetter]=0;letterDistMap[firstLetter]++}},this);this.setSegmentTerms(this.getTerms().filter(function(d){return d.value>
0}));this.setMinFreq(min);this.setMaxFreq(max);var letterDist=[];for(var letter in letterDistMap){var count=letterDistMap[letter];var percent=count/this.getTerms().length;letterDist.push({letter:letter,percent:percent})}letterDist.sort(function(a,b){if(a.letter<b.letter)return-1;if(a.letter>b.letter)return 1;return 0});this.setLetterDistribution(letterDist);this.calculateNodeSizes(this.getSegmentTerms());this.runSimulation(this.getSegmentTerms())},calculateNodeSizes:function(terms){var nodes=this.getTempNodes().data(terms,
function(d){return d.id});var fontSizer=function(value){var t=Math.min(1,terms.length/this.MAX_TERMS);var exponent=t*2+1;value=this.getFrequencyScale()(value);var val=d3.scalePow().exponent(exponent).domain([0,1]).range([this.getMinFontSize(),this.getMaxFontSize()])(value);return val}.bind(this);var bboxTotal=0;nodes.enter().append("text").attr("fill-opacity",0).attr("font-family",function(d){return"Arial"}).attr("font-size",function(d){var fontSize=fontSizer(d.value);d.fontSize=fontSize;return fontSize}).text(function(d){return d.term}).each(function(d){var bbox=
this.getBBox();d.bbox={};d.bbox.x=bbox.x;d.bbox.y=bbox.y;d.bbox.width=bbox.width;d.bbox.height=bbox.height;bboxTotal+=bbox.width*bbox.height}).remove();var el=this.getLayout().getRenderTarget();var width=el.getWidth();var height=el.getHeight();var availableSpace=width*height;if(bboxTotal>availableSpace*.6){this.setMaxFontSize(this.getMaxFontSize()*.9);this.setMinFontSize(this.getMinFontSize()*.9);this.calculateNodeSizes(terms)}else if(bboxTotal<availableSpace*.5){this.setMaxFontSize(this.getMaxFontSize()*
1.1);this.setMinFontSize(this.getMinFontSize()*1.1);this.calculateNodeSizes(terms)}},runSimulation:function(terms){this.setIsSimulating(true);var el=this.getLayout().getRenderTarget();var width=el.getWidth();var height=el.getHeight();if(this.debugMsg)console.time("runSim");this.getWebWorker().postMessage({terms:terms,width:width,height:height,minFreq:this.getMinFreq(),maxFreq:this.getMaxFreq(),xForceStrength:this.getXForceStrength(),yForceStrength:this.getYForceStrength(),chargeDistance:this.getChargeDistance(),
chargeStrength:this.getChargeStrength(),letterDistribution:this.getLetterDistribution()})},handleWebWorkerMessage:function(event){switch(event.data.type){case "progress":var t=event.data.progress;var percent=parseInt(t*100);this.getDockedItems()[1].getComponent("status").update(percent+"%");break;case "msg":if(this.debugMsg)console.log(event.data.msg);break;case "end":if(this.debugMsg)console.timeEnd("runSim");this.getDockedItems()[1].getComponent("status").update("");this.setIsSimulating(false);
this.getSegmentTermsQueue().push(event.data.nodes);break}},updateNodePositions:function(){if(this.getIsTransitioning())Ext.Function.defer(this.updateNodePositions,100,this);else{this.count++;var nodes=this.getSegmentTermsQueue().shift();if(this.debugMsg)console.log("queue length",this.getSegmentTermsQueue().length);if(nodes===undefined){if(this.debugMsg)console.log("no nodes",this.count);if(this.getIsSimulating()===false)this.getNextSegment()}else{this.setIsTransitioning(true);if(this.getSegmentTermsQueue().length==
0)this.getNextSegment();var nodeUpdate=this.getNodes().data(nodes,function(d){return d.id});nodeUpdate.transition().duration(this.getTransitionTime()).attr("transform",function(d){var x=d.x;var y=d.y;return"translate("+x+","+y+")"});var nodeEnter=nodeUpdate.enter().append("g").attr("class","node").attr("id",function(d){return d.id}).attr("transform",function(d){var x=d.x;var y=d.y;return"translate("+x+","+y+")"}).attr("fill-opacity",0);nodeEnter.append("title").text(function(d){return d.title});nodeEnter.append("text").attr("font-family",
function(d){return"Arial"}).attr("font-size",function(d){return d.fontSize}).attr("fill",function(d){return this.getApplication().getCategoriesManager().getFeatureForTerm("color",d.term)}.bind(this)).style("cursor","pointer").style("user-select","none").attr("alignment-baseline","middle").text(function(d){return d.term});nodeEnter.transition().duration(this.getTransitionTime()).attr("fill-opacity",1);var allNodes=nodeEnter.merge(nodeUpdate);allNodes.select("text").transition().duration(this.getTransitionTime()).attr("font-size",
function(d){return d.fontSize});nodeUpdate.exit().transition().duration(this.getTransitionTime()).attr("fill-opacity",0).remove();setTimeout(function(){this.setIsTransitioning(false)}.bind(this),this.getTransitionTime());this.setNodes(allNodes)}}},updateMinFreq:function(){this.setFrequencyScale(d3.scaleLog().domain([this.getMinFreq(),this.getMaxFreq()]).range([0,1]))},updateMaxFreq:function(){this.setFrequencyScale(d3.scaleLog().domain([this.getMinFreq(),this.getMaxFreq()]).range([0,1]))},zoomToFit:function(paddingPercent,
transitionDuration){var bounds=this.getVis().node().getBBox();var width=bounds.width;var height=bounds.height;var midX=bounds.x+width/2;var midY=bounds.y+height/2;var svg=this.getVis().node().parentElement;var fullWidth=svg.clientWidth;var fullHeight=svg.clientHeight;var scale=(paddingPercent||.8)/Math.max(width/fullWidth,height/fullHeight);var translate=[fullWidth/2-scale*midX,fullHeight/2-scale*midY];d3.select(svg).transition().duration(transitionDuration||500).call(this.getZoom().transform,d3.zoomIdentity.translate(translate[0],
translate[1]).scale(scale))},idGet:function(term){return term.replace(/\W/g,"_")}});Ext.define("Voyant.panel.Topics",{extend:"Ext.grid.Panel",mixins:["Voyant.panel.Panel","Voyant.widget.LiveSearchGrid"],alias:"widget.topics",statics:{i18n:{},api:{stopList:"auto",numTopics:25,limit:10,iterations:100,perDocLimit:1E3,query:undefined},glyph:"xf1ea@FontAwesome"},config:{options:[{xtype:"stoplistoption"},{xtype:"numberfield",name:"perDocLimit",fieldLabel:"maximum words per document",labelAlign:"right",value:1E3,minValue:1,step:100,listeners:{afterrender:function(field){var win=field.up("window");
if(win&&win.panel){field.setValue(parseInt(win.panel.getApiParam("perDocLimit")));field.setFieldLabel(win.panel.localize("perDocLimit"))}},change:function(field,val){var win=field.up("window");if(val>5E3&&win&&win.panel)win.panel.toastInfo({html:win.panel.localize("perDocLimitHigh"),anchor:win.getTargetEl(),align:"tr",maxWidth:400})}}},{xtype:"numberfield",name:"iterations",fieldLabel:"iterations per run",labelAlign:"right",value:100,minValue:1,maxValue:1E4,step:50,listeners:{afterrender:function(field){var win=
field.up("window");if(win&&win.panel){field.setValue(parseInt(win.panel.getApiParam("iterations")));field.setFieldLabel(win.panel.localize("iterations"))}}}}],corpus:undefined,documentTopicSmoothing:.1,topicWordSmoothing:.01,vocabularySize:0,vocabularyCounts:{},stopwords:{},docSortSmoothing:10,sumDocSortSmoothing:10*25,requestedSweeps:0,wordTopicCounts:{},topicWordCounts:[],tokensPerTopic:[],topicWeights:Array(25),documents:[],progress:undefined,totalIterations:0,exportGridAll:false},zeros:function(count,
val){val=val||0;var ret=Array(count);for(var i=0;i<count;i++)ret[i]=val;return ret},constructor:function(config){var me=this;Ext.apply(this,{title:this.localize("title"),layout:{type:"hbox",pack:"start",align:"stretch"},store:{fields:["topic","scores"],data:[]},columns:[{text:this.localize("topic"),tooltip:this.localize("topicTip"),flex:3,dataIndex:"topic",sortable:false},{xtype:"widgetcolumn",text:this.localize("scores"),tooltip:this.localize("scoresTip"),flex:1,dataIndex:"scores",widget:{xtype:"sparklineline",
tipTpl:new Ext.XTemplate("{[this.getDocumentTitle(values.x,values.y)]}",{getDocumentTitle:function(docIndex,score){return this.panel.getCorpus().getDocument(docIndex).getTitle()+"\x3cbr\x3ecoverage: "+Ext.util.Format.number(score*100,"0,000.0")+"%"},panel:me})}}],dockedItems:{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:['\x3cspan class\x3d"info-tip" data-qtip\x3d"'+this.localize("searchTip")+'"\x3e'+this.localize("search")+"\x3c/span\x3e",{xtype:"textfield",name:"searchField",hideLabel:true,
width:80,listeners:{change:{fn:me.onTextFieldChange,scope:me,buffer:500}}},'\x3cspan class\x3d"info-tip" data-qtip\x3d"'+this.localize("limitTermsTip")+'"\x3e'+this.localize("limitTerms")+"\x3c/span\x3e",{width:80,hideLabel:true,xtype:"slider",increment:1,minValue:1,maxValue:100,listeners:{afterrender:function(slider){slider.setValue(parseInt(this.getApiParam("limit")))},changecomplete:function(slider,newvalue){this.setApiParams({limit:newvalue});this.postSweep()},scope:this}},'\x3cspan class\x3d"info-tip" data-qtip\x3d"'+
this.localize("numTopicsTip")+'"\x3e'+this.localize("numTopics")+"\x3c/span\x3e",{width:80,hideLabel:true,xtype:"slider",increment:1,minValue:1,maxValue:200,listeners:{afterrender:function(slider){slider.setValue(parseInt(this.getApiParam("numTopics")))},changecomplete:function(slider,newvalue){this.setApiParams({numTopics:newvalue});this.loadFromExistingDocuments()},scope:this}},{text:(new Ext.Template(this.localize("runIterations"))).apply([100]),itemId:"iterations",glyph:"xf04b@FontAwesome",tooltip:this.localize("runIterationsTip"),
handler:this.runIterations,scope:this},{xtype:"tbtext",itemId:"done"},{xtype:"tbfill"},{xtype:"tbtext",html:this.localize("adaptation")}]}});this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.resetData();this.on("loadedCorpus",function(src,corpus){this.setCorpus(corpus);if(this.rendered)this.initialize();else this.on("afterrender",function(){this.initialize()},this)});this.on("query",function(src,query){this.setApiParam("query",query);this.updateSearchResults()})},
loadStopwords:function(){this.mask(this.localize("loadingStopWords"));Ext.Ajax.request({url:this.getTromboneUrl(),params:{tool:"resource.KeywordsManager",stopList:this.getApiParam("stopList"),corpus:this.getCorpus()?this.getCorpus().getAliasOrId():undefined},success:function(response,req){this.unmask();var json=Ext.util.JSON.decode(response.responseText);var stopwords={};json.keywords.keywords.forEach(function(stop){stopwords[stop]=1});this.setStopwords(stopwords);this.loadDocuments()},scope:this})},
loadDocuments:function(){this.mask(this.localize("loadingDocuments"));var corpus=this.getCorpus();if(corpus)Ext.Ajax.request({url:this.getTromboneUrl(),params:{tool:"corpus.DocumentTokens",corpus:corpus.getAliasOrId(),outputFormat:"text",template:"docTokens2idsAndText",limit:0,noOthers:true,perDocLimit:corpus.getDocumentsCount()==1?undefined:parseInt(this.getApiParam("perDocLimit"))},success:function(response,req){this.unmask();this.mask(this.localize("parsingDocuments"));var lines=response.responseText.trim().split(/(\r\n|\r|\n)/);
if(lines.length==1){var parts=lines[0].split(": ");if(parts.length>1){var doc=corpus.getDocument(parts[0]);var allwords=parts[1].split(" ");var totalWords=doc.getLexicalTokensCount();if(totalWords<10)bins=totalWords;else if(totalWords<1E3)bins=10;else bins=100;var bins=10;var wordsPerBin=Math.floor(allwords.length/bins);for(var i=0;i<bins;i++){var text=allwords.slice(i*wordsPerBin,i*wordsPerBin+wordsPerBin).join(" ");this.parseLine(parts[0]+"-"+i+"\t"+parts[0]+"-"+i+"\t"+text)}}}else lines.forEach(function(line){var parts=
line.split(": ");if(parts.length>1){var doc=corpus.getDocument(parts[0]);this.parseLine(parts[0]+"\t"+doc.getTinyLabel()+"\t"+parts[1])}},this);this.unmask();this.runIterations()},scope:this})},resetData:function(){var numTopics=parseInt(this.getApiParam("numTopics"));this.setVocabularyCounts({});this.setSumDocSortSmoothing(this.getDocSortSmoothing()*numTopics);this.setRequestedSweeps(0);this.setWordTopicCounts({});this.setTopicWordCounts([]);this.setTokensPerTopic(this.zeros(numTopics));this.setTopicWeights(this.zeros(numTopics));
this.setDocuments([]);this.setTotalIterations(0)},loadFromExistingDocuments:function(){var data=this.getDocuments().map(function(doc){return doc.id+"\t"+doc.date+"\t"+doc.originalText});this.resetData();data.forEach(function(doc){this.parseLine(doc)},this);this.runIterations()},runIterations:function(){var sweeps=this.getRequestedSweeps();var iterations=parseInt(this.getApiParam("iterations"));sweeps+=parseInt(iterations);this.setTotalIterations(this.getTotalIterations()+iterations);this.setRequestedSweeps(sweeps);
if(!this.getProgress()){var progress=Ext.MessageBox.show({title:this.localize("runningIterations"),message:(new Ext.Template(this.localize("runningIterationsCount"))).apply([sweeps]),progress:true,progressText:"",target:sweeps,customUpdateProgress:function(val){this.updateProgress((this.config.target-val)*this.config.target," iterations")}});this.setProgress(progress);this.updateProgress(sweeps)}this.sweep()},updateProgress:function(sweeps){var progress=this.getProgress(),sweeps=this.getRequestedSweeps();
if(progress){var target=progress.cfg.target;var val=(target-sweeps)/target;progress.updateProgress(val,parseInt(val)*100+"% done")}},sweep:function(){var startTime=Date.now(),numTopics=parseInt(this.getApiParam("numTopics")),vocabularySize=this.getVocabularySize(),topicWordSmoothing=this.getTopicWordSmoothing(),tokensPerTopic=this.getTokensPerTopic(),documents=this.getDocuments(),wordTopicCounts=this.getWordTopicCounts(),topicWeights=this.getTopicWeights(),documentTopicSmoothing=this.getDocumentTopicSmoothing();
var topicNormalizers=this.zeros(numTopics);for(var topic=0;topic<numTopics;topic++)topicNormalizers[topic]=1/(vocabularySize*topicWordSmoothing+tokensPerTopic[topic]);for(var doc=0;doc<documents.length;doc++){var currentDoc=documents[doc];var docTopicCounts=currentDoc.topicCounts;for(var position=0;position<currentDoc.tokens.length;position++){var token=currentDoc.tokens[position];if(token.isStopword)continue;tokensPerTopic[token.topic]--;var currentWordTopicCounts=wordTopicCounts[token.word];currentWordTopicCounts[token.topic]--;
if(currentWordTopicCounts[token.topic]==0);docTopicCounts[token.topic]--;topicNormalizers[token.topic]=1/(vocabularySize*topicWordSmoothing+tokensPerTopic[token.topic]);var sum=0;for(var topic=0;topic<numTopics;topic++){if(currentWordTopicCounts[topic])topicWeights[topic]=(documentTopicSmoothing+docTopicCounts[topic])*(topicWordSmoothing+currentWordTopicCounts[topic])*topicNormalizers[topic];else topicWeights[topic]=(documentTopicSmoothing+docTopicCounts[topic])*topicWordSmoothing*topicNormalizers[topic];
sum+=topicWeights[topic]}var sample=sum*Math.random();var i=0;sample-=topicWeights[i];while(sample>0){i++;sample-=topicWeights[i]}token.topic=i;tokensPerTopic[token.topic]++;if(!currentWordTopicCounts[token.topic])currentWordTopicCounts[token.topic]=1;else currentWordTopicCounts[token.topic]+=1;docTopicCounts[token.topic]++;topicNormalizers[token.topic]=1/(vocabularySize*topicWordSmoothing+tokensPerTopic[token.topic])}}var sweeps=this.getRequestedSweeps()-1;this.setRequestedSweeps(sweeps);var progress=
this.getProgress();if(sweeps>0){this.updateProgress(sweeps);Ext.defer(this.sweep,0,this)}else{progress.close();this.setProgress(undefined);this.postSweep()}},postSweep:function(){this.sortTopicWords();var store=this.getStore();var done=(new Ext.Template(this.localize("totalDone"))).apply([Ext.util.Format.number(parseInt(this.getTotalIterations()),"0,000")]);this.down("#done").setHtml(done);var numTopics=parseInt(this.getApiParam("numTopics")),topicWordCounts=this.getTopicWordCounts(),data=[],documents=
this.getDocuments(),docSortSmoothing=this.getDocSortSmoothing(),sumDocSortSmoothing=this.getSumDocSortSmoothing();var limit=parseInt(this.getApiParam("limit"));for(var topic=0;topic<numTopics;topic++){var scores=documents.map(function(doc,i){return(doc.topicCounts[topic]+docSortSmoothing)/(doc.tokens.length+sumDocSortSmoothing)});data.push({topic:this.topNWords(topicWordCounts[topic],limit),scores:scores})}store.loadData(data)},topNWords:function(wordCounts,n){return wordCounts.slice(0,n).map(function(d){return d.word}).join(" ")},
sortTopicWords:function(){var topicWordCounts=this.getTopicWordCounts(),numTopics=parseInt(this.getApiParam("numTopics")),wordTopicCounts=this.getWordTopicCounts();topicWordCounts=[];for(var topic=0;topic<numTopics;topic++)topicWordCounts[topic]=[];for(var word in wordTopicCounts)for(var topic in wordTopicCounts[word])topicWordCounts[topic].push({"word":word,"count":wordTopicCounts[word][topic]});for(var topic=0;topic<numTopics;topic++)topicWordCounts[topic].sort(this.byCountDescending);this.setTopicWordCounts(topicWordCounts)},
byCountDescending:function(a,b){return b.count-a.count},initialize:function(){var val=(new Ext.Template(this.localize("runIterations"))).apply([Ext.util.Format.number(parseInt(this.getApiParam("iterations")),"0,000")]);var iterations=this.down("#iterations").setText(val);this.loadStopwords()},parseLine:function(line){var stopwords=this.getStopwords(),vocabularyCounts=this.getVocabularyCounts(),tokensPerTopic=this.getTokensPerTopic(),vocabularySize=this.getVocabularySize(),vocabularyCounts=this.getVocabularyCounts(),
documents=this.getDocuments(),numTopics=parseInt(this.getApiParam("numTopics")),wordTopicCounts=this.getWordTopicCounts();if(line=="")return;var docID=documents.length;var docDate="";var fields=line.split("\t");var text=fields[0];if(fields.length==3){docID=fields[0];docDate=fields[1];text=fields[2]}var tokens=[];var rawTokens=text.toLowerCase().split(" ");if(rawTokens==null)return;var topicCounts=this.zeros(numTopics);rawTokens.forEach(function(word){if(word!==""){var topic=Math.floor(Math.random()*
numTopics);if(word.length<=2)stopwords[word]=1;var isStopword=stopwords[word];if(isStopword)if(!vocabularyCounts[word])vocabularyCounts[word]=1;else vocabularyCounts[word]+=1;else{tokensPerTopic[topic]++;if(!wordTopicCounts[word]){wordTopicCounts[word]={};vocabularySize++;vocabularyCounts[word]=0}if(!wordTopicCounts[word][topic])wordTopicCounts[word][topic]=0;wordTopicCounts[word][topic]+=1;vocabularyCounts[word]+=1;topicCounts[topic]+=1}tokens.push({"word":word,"topic":topic,"isStopword":isStopword})}});
this.setVocabularySize(vocabularySize);documents.push({"originalOrder":documents.length,"id":docID,"date":docDate,"originalText":text,"tokens":tokens,"topicCounts":topicCounts})}});Ext.define("Voyant.panel.Via",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.via",statics:{i18n:{},api:{stopList:"auto",limit:100,docIndex:undefined},glyph:"xf06e@FontAwesome"},config:{mode:undefined,options:[{xtype:"stoplistoption"},{xtype:"listeditor",name:"whiteList"},{xtype:"categoriesoption"}]},layout:"fit",constructor:function(config){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},initComponent:function(config){Ext.apply(this,
{title:this.localize("title"),dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{xtype:"corpusdocumentselector",singleSelect:true},{fieldLabel:this.localize("visible"),labelWidth:40,width:120,xtype:"slider",increment:10,minValue:10,maxValue:1E3,listeners:{afterrender:function(slider){slider.setValue(this.getApiParam("limit"))},changecomplete:function(slider,newvalue){this.setApiParams({limit:newvalue});this.loadFromCorpus(this.getCorpus())},scope:this}}]}]});this.callParent(arguments)},
listeners:{resize:function(panel,width,height){},loadedCorpus:function(src,corpus){var langs=corpus.get("languageCodes");var val=Ext.Array.each(langs,function(lang){if(lang!="en"){this.showError(this.localize("englishOnly"));return false}},this);if(corpus.getWordTokensCount()>1E5&&!this.getApiParam("docIndex"))this.setApiParam("docIndex",0);this.loadFromCorpus(corpus)},corpusSelected:function(src,corpus){this.setApiParam("docIndex","");this.loadFromCorpus(corpus)},documentSelected:function(src,document){this.setApiParam("docIndex",
document.getIndex());this.loadFromCorpus(this.getCorpus())}},loadFromCorpus:function(corpus){var me=this;this.mask(this.localize("loading"));var params=this.getApiParams();var a=corpus.loadRelatedWords(params).then(function(relatedWords){me.unmask();var edges=relatedWords.map(function(item){return{source:item.getSource(),target:item.getTarget()}});var graph=me.down("voyantnetworkgraph");if(graph)graph.loadJson({edges:edges});else{graph=Ext.create("Voyant.widget.VoyantNetworkGraph",{edges:edges,listeners:{nodeclicked:function(src,
node){me.dispatchEvent("termsClicked",me,[node.term])}}});me.add(graph)}},function(response){me.unmask();if(response.timedout)me.showError(me.localize("timedout"));else me.showError(response)})}});Ext.define("Voyant.notebook.editor.button.Add",{extend:"Ext.button.Button",mixins:["Voyant.util.Localization"],alias:"widget.notebookwrapperadd",statics:{i18n:{}},constructor:function(config){Ext.apply(this,{tooltip:this.localize("tip")});this.callParent(arguments)},glyph:"xf067@FontAwesome",textAlign:"left",listeners:{click:function(btn,e){this.findParentByType("notebook").fireEvent("notebookWrapperAdd",this.findParentByType("notebookeditorwrapper"),e)}}});Ext.define("Voyant.notebook.editor.button.Edit",{extend:"Ext.button.Button",mixins:["Voyant.util.Localization"],alias:"widget.notebookwrapperedit",statics:{i18n:{}},constructor:function(config){Ext.apply(this,{toolTip:this.localize("tip")});this.callParent(arguments)},glyph:"xf040@FontAwesome",listeners:{click:function(){this.findParentByType("notebook").fireEvent("notebookWrapperEdit",this.findParentByType("notebookeditorwrapper"))}}});Ext.define("Voyant.notebook.editor.button.Export",{extend:"Ext.button.Button",mixins:["Voyant.util.Localization"],alias:"widget.notebookwrapperexport",statics:{i18n:{tip:"Export",exportTitle:"Export",exportOpen:"export content into new window",exportDownload:"download file to your machine",cancelTitle:"Cancel"}},constructor:function(config){Ext.apply(this,{toolTip:this.localize("tip")});this.callParent(arguments)},glyph:"xf08e@FontAwesome",listeners:{click:function(cmp){var exportCmp=cmp;Ext.create("Ext.window.Window",
{title:this.localize("exportTitle"),modal:true,items:{xtype:"form",defaultType:"radio",items:[{inputValue:"html",boxLabel:this.localize("exportOpen"),name:"export"},{inputValue:"htmlDownload",boxLabel:'\x3ca href\x3d"#"\x3e'+this.localize("exportDownload")+"\x3c/a\x3e",name:"export",listeners:{afterrender:function(cmp){var wrapper=exportCmp.up("notebookcodeeditorwrapper");var content=wrapper.getContent();var filename=wrapper.getCellId()+"."+(content.mode=="text"?"txt":content.mode);var properties=
{type:content.mode=="text"||true?"text/plain":"text/"+content.mode};try{file=new File([content.input],filename,properties)}catch(e){file=new Blob([content.input],properties)}var url=URL.createObjectURL(file);var a=cmp.boxLabelEl.dom.querySelector("a");a.setAttribute("download",filename);a.setAttribute("href",url);a.addEventListener("click",function(){cmp.up("window").close()})},scope:this},handler:function(cmp){cmp.boxLabelEl.dom.querySelector("a").click()}}],buttons:[{text:this.localize("exportTitle"),
glyph:"xf08e@FontAwesome",flex:1,handler:function(btn){var form=btn.up("form");var val=form.getValues()["export"];if(val=="html"){var wrapper=exportCmp.up("notebookcodeeditorwrapper");var content=wrapper.getContent();var myWindow=window.open();myWindow.document.write(content.input);myWindow.document.close();myWindow.focus()}btn.up("window").close()},scope:this},{text:this.localize("cancelTitle"),glyph:"xf00d@FontAwesome",flex:1,handler:function(btn){btn.up("window").close()}}]},bodyPadding:5}).show()}}});Ext.define("Voyant.notebook.editor.button.Counter",{extend:"Ext.toolbar.TextItem",mixins:["Voyant.util.Localization"],alias:"widget.notebookwrappercounter",statics:{i18n:{}},config:{order:0,name:undefined},cls:"notebookwrappercounter",constructor:function(config){Ext.apply(this,{toolTip:this.localize("tip")});this.callParent(arguments)},setOrder:function(pos){this.callParent(arguments);this.updateHtml()},updateHtml:function(){var pos=this.getOrder()+1;var lnk="spyralcounter_"+pos;var name=this.getName();
this.setHtml('\x3ca name\x3d"'+name+'" href\x3d"#'+name+'"\x3e'+pos+"\x3c/a\x3e")}});Ext.define("Voyant.notebook.editor.button.MoveDown",{extend:"Ext.button.Button",mixins:["Voyant.util.Localization"],alias:"widget.notebookwrappermovedown",statics:{i18n:{}},constructor:function(config){Ext.apply(this,{tooltip:this.localize("tip")});this.callParent(arguments)},glyph:"xf063@FontAwesome",textAlign:"left",listeners:{click:function(){this.findParentByType("notebook").fireEvent("notebookWrapperMoveDown",this.findParentByType("notebookeditorwrapper"))}}});Ext.define("Voyant.notebook.editor.button.MoveUp",{extend:"Ext.button.Button",mixins:["Voyant.util.Localization"],alias:"widget.notebookwrappermoveup",statics:{i18n:{}},constructor:function(config){Ext.apply(this,{tooltip:this.localize("tip")});this.callParent(arguments)},glyph:"xf062@FontAwesome",textAlign:"left",listeners:{click:function(){this.findParentByType("notebook").fireEvent("notebookWrapperMoveUp",this.findParentByType("notebookeditorwrapper"))}}});Ext.define("Voyant.notebook.editor.button.Remove",{extend:"Ext.button.Button",mixins:["Voyant.util.Localization"],alias:"widget.notebookwrapperremove",statics:{i18n:{}},constructor:function(config){Ext.apply(this,{tooltip:this.localize("tip")});this.callParent(arguments)},glyph:"xf014@FontAwesome",textAlign:"left",listeners:{click:function(){Ext.Msg.show({buttons:Ext.Msg.OKCANCEL,icon:Ext.MessageBox.QUESTION,msg:this.localize("confirmRemove"),title:this.localize("confirmRemoveTitle"),fn:function(buttonId){if(buttonId==
"ok")this.findParentByType("notebook").fireEvent("notebookWrapperRemove",this.findParentByType("notebookeditorwrapper"))},scope:this})}}});Ext.define("Voyant.notebook.editor.button.Metadata",{extend:"Ext.button.Button",mixins:["Voyant.util.Localization"],alias:"widget.notebookwrappermetadata",statics:{i18n:{}},constructor:function(config){Ext.apply(this,{tooltip:this.localize("tip")});this.callParent(arguments)},glyph:"xf02c@FontAwesome",textAlign:"left",listeners:{click:function(btn,e){this.findParentByType("notebook").fireEvent("notebookWrapperMetadata",this.findParentByType("notebookeditorwrapper"),e)}}});Ext.define("Voyant.notebook.editor.button.Movement",{extend:"Ext.button.Button",mixins:["Voyant.util.Localization"],requires:["Voyant.notebook.editor.button.MoveUp","Voyant.notebook.editor.button.MoveDown","Voyant.notebook.editor.button.Remove"],alias:"widget.notebookwrappermovement",statics:{i18n:{}},constructor:function(config){Ext.apply(this,{tooltip:this.localize("tip")});this.callParent(arguments)},glyph:"xf07d@FontAwesome",menu:[{xtype:"notebookwrappermoveup"},{xtype:"notebookwrappermovedown"},
{xtype:"notebookwrapperremove"}]});Ext.define("Voyant.notebook.editor.button.Run",{extend:"Ext.button.Button",mixins:["Voyant.util.Localization"],alias:"widget.notebookwrapperrun",statics:{i18n:{}},glyph:"xf04b@FontAwesome",constructor:function(config){config=config||{};config.tooltip=this.localize("tip");this.callParent(arguments)}});Ext.define("Voyant.notebook.editor.button.RunAll",{extend:"Ext.button.Button",mixins:["Voyant.util.Localization"],alias:"widget.notebookwrapperrunall",statics:{i18n:{}},glyph:"xf04e@FontAwesome",constructor:function(config){config=config||{};config.tooltip=this.localize("tip");this.callParent(arguments)}});Ext.define("Voyant.notebook.editor.button.RunUntil",{extend:"Ext.button.Button",mixins:["Voyant.util.Localization"],alias:"widget.notebookwrapperrununtil",statics:{i18n:{}},glyph:"xf050@FontAwesome",constructor:function(config){config=config||{};config.tooltip=this.localize("tip");this.callParent(arguments)}});Ext.define("Voyant.notebook.editor.EditorWrapper",{extend:"Ext.panel.Panel",mixins:["Voyant.util.Localization"],requires:["Voyant.notebook.editor.button.Movement","Voyant.notebook.editor.button.Add"],alias:"widget.notebookeditorwrapper",cls:"notebook-editor-wrapper",config:{cellId:undefined,content:"",isEditing:false},border:false,bodyBorder:false,initComponent:function(){this.setCellId(this.config.cellId);this.on("afterrender",function(){this.getDockedItems().forEach(function(tb){tb.getTargetEl().setVisibilityMode(Ext.dom.Element.VISIBILITY)});
this.setActiveMode(false);this.body.on("click",function(){this.removeCls("notebook-editor-wrapper-hover");this.setActiveMode(true)},this);this.mon(this.getEl(),"mouseover",function(){this.setActiveMode(true)},this);this.mon(this.getEl(),"mouseout",function(){this.setActiveMode(false)},this)},this);this.callParent(arguments)},setActiveMode:function(mode){this.getDockedItems().forEach(function(tb){if(tb.dock=="right")tb.items.each(function(item){if(item.hasCls("notebookwrappercounter")==false)item.getTargetEl().setVisibility(mode)});
else tb.getTargetEl().setVisibility(mode)},this);if(!this.getIsEditing())if(mode)this.body.addCls("notebook-editor-wrapper-hover");else this.body.removeCls("notebook-editor-wrapper-hover")}});Ext.define("Voyant.notebook.editor.CodeEditor",{extend:"Ext.Component",alias:"widget.notebookcodeeditor",mixins:["Voyant.util.Localization","Voyant.notebook.util.Embed"],embeddable:["Voyant.notebook.editor.CodeEditor"],cls:"notebook-code-editor",config:{theme:"ace/theme/chrome",mode:"ace/mode/javascript",content:"",docs:undefined,isChangeRegistered:false,editor:undefined,editedTimeout:undefined,lines:0},statics:{i18n:{},api:{content:undefined}},constructor:function(config){this.callParent(arguments)},
listeners:{boxready:function(){var me=this;var editor=ace.edit(Ext.getDom(this.getEl()));editor.$blockScrolling=Infinity;editor.getSession().setUseWorker(true);editor.setTheme(this.getTheme());editor.getSession().setMode(this.getMode());editor.setOptions({minLines:6,maxLines:Infinity,autoScrollEditorIntoView:true,scrollPastEnd:true});editor.setHighlightActiveLine(false);editor.setHighlightGutterLine(false);editor.renderer.setShowPrintMargin(false);editor.setValue(this.getContent()?this.getContent():
"");editor.clearSelection();editor.on("focus",function(){setTimeout(function(){me.getEditor().setHighlightGutterLine(true)},100)},this);editor.on("change",function(ev,editor){var lines=editor.getSession().getScreenLength();if(lines!=me.getLines()){me.up("notebookcodeeditorwrapper").setSize({height:lines*editor.renderer.lineHeight+editor.renderer.scrollBar.getWidth()});me.setLines(lines)}if(me.getIsChangeRegistered()==false){me.setIsChangeRegistered(true);var wrapper=me.up("notebookcodeeditorwrapper");
if(wrapper){wrapper.setIsRun(false);var notebook=wrapper.up("notebook");if(notebook)notebook.setIsEdited(true)}}else if(!me.getEditedTimeout())me.setEditedTimeout(setTimeout(function(){me.setIsChangeRegistered(false)},3E4))},this);editor.on("blur",function(){me.getEditor().setHighlightGutterLine(false)});editor.commands.addCommand({name:"run",bindKey:{win:"Shift-Enter",mac:"Shift-Enter"},exec:function(editor){var wrapper=me.up("notebookcodeeditorwrapper");if(wrapper)wrapper.run()}});editor.commands.addCommand({name:"rununtil",
bindKey:{win:"Command-Shift-Enter",mac:"Command-Shift-Enter"},exec:function(editor){var wrapper=me.up("notebookcodeeditorwrapper");var notebook=wrapper.up("notebook");notebook.runUntil(wrapper)}});this.setEditor(editor);ace.config.loadModule("ace/ext/tern",function(module){me.getEditor().setOptions({enableTern:{defs:me.docs?["browser","ecma5",me.docs]:["ecma5","browser"],plugins:{doc_comment:{fullDocs:true}},useWorker:true},enableSnippets:false,enableBasicAutocompletion:false})})},removed:function(cmp,
container){if(cmp.getEditor())cmp.getEditor().destroy()}},switchModes:function(mode){this.setMode("ace/mode/"+mode);this.getEditor().getSession().setMode(this.getMode())},getValue:function(){return this.getEditor().getValue()}});Ext.define("Voyant.notebook.editor.CodeEditorWrapper",{extend:"Voyant.notebook.editor.EditorWrapper",requires:["Voyant.notebook.editor.CodeEditor","Voyant.notebook.editor.button.Run","Voyant.notebook.editor.button.RunAll"],alias:"widget.notebookcodeeditorwrapper",cls:"notebook-code-wrapper",statics:{i18n:{runMultiple:"Run multiple cells",runUntil:"Run up to here",runUntilTip:"Run previous code blocks and this one.",runFrom:"Run from here onwards",runFromTip:"Run this and following code blocks.",codeMode:"select from several formats for this cell",
codeModeTitle:"Code Mode",codeModeTip:"Select from multiple code formats for this cell.",configureTip:"Configuration Options",autoExecuteOnLoad:"auto-run this cell on page load",ok:"OK",cancel:"Cancel"}},config:{isRun:false,autoExecute:false,isWarnedAboutPreviousCells:false},layout:{type:"vbox",align:"stretch"},height:130,border:false,EMPTY_RESULTS_TEXT:" ",constructor:function(config){this.results=this._getResultsComponent(Ext.Array.from(config.output).join(""));this.editor=Ext.create("Voyant.notebook.editor.CodeEditor",
{content:Ext.Array.from(config.input).join("\n"),docs:config.docs,mode:"ace/mode/"+(config.mode?config.mode:"javascript")});Ext.apply(this,{dockedItems:[{xtype:"toolbar",dock:"left",defaults:{textAlign:"left"},items:[{xtype:"notebookwrapperadd"},{xtype:"notebookwrapperrun",listeners:{click:{fn:this.run,scope:this}}},{glyph:"xf050@FontAwesome",tooltip:this.localize("runMultiple"),itemId:"runMultiple",listeners:{click:{fn:function(btn,ev){Ext.create("Ext.menu.Menu",{items:[{text:this.localize("runUntil"),
tooltip:this.localize("runUntilTip"),glyph:"xf049@FontAwesome",handler:function(){this.up("notebook").runUntil(this)},scope:this},{text:this.localize("runFrom"),tooltip:this.localize("runFromTip"),glyph:"xf050@FontAwesome",handler:function(){this.up("notebook").runFrom(this)},scope:this}]}).showAt(ev.pageX,ev.pageY)},scope:this}}},{xtype:"button",glyph:"xf013@FontAwesome",tooltip:this.localize("configureTip"),scope:this,cls:config.autoExecute?"autoExecute":"",handler:function(btn,ev){var button=btn;
var mode=this.editor.getMode().split("/").pop();(new Ext.Window({title:this.localize("codeModeTitle"),layout:"fit",width:240,items:[{xtype:"form",layout:{type:"vbox",align:"stretch"},bodyPadding:10,items:[{xtype:"fieldset",title:this.localize("modeCode"),items:[{xtype:"radiofield",boxLabel:this.localize("modeJavascript"),name:"codeMode",inputValue:"javascript",flex:1,checked:mode==="javascript",listeners:{change:function(cmp,newval,oldval){var autoExecCheck=cmp.up().queryById("autoExecute");autoExecCheck.setHidden(!newval);
if(!newval)autoExecCheck.setValue(false)}}},{xtype:"checkbox",boxLabel:this.localize("autoExecuteOnLoad"),name:"autoExecute",itemId:"autoExecute",hidden:mode!=="javascript",checked:this.getAutoExecute()}]},{xtype:"fieldset",title:this.localize("modeData"),items:[{items:{xtype:"radiofield",boxLabel:this.localize("modeJson"),name:"codeMode",inputValue:"json",flex:1,checked:mode==="json"}},{items:{xtype:"radiofield",boxLabel:this.localize("modeText"),name:"codeMode",inputValue:"text",flex:1,checked:mode===
"text"}},{items:{xtype:"radiofield",boxLabel:this.localize("modeHtml"),name:"codeMode",inputValue:"html",flex:1,checked:mode==="html"}},{items:{xtype:"radiofield",boxLabel:this.localize("modeXml"),name:"codeMode",inputValue:"xml",flex:1,checked:mode==="xml"}}]}]}],buttons:[{text:this.localize("ok"),handler:function(btn){var win=btn.up("window");var form=win.down("form");if(form.isDirty()){var values=form.getValues();this.switchModes(values.codeMode);this.setAutoExecute(values.autoExecute==="on");
button.toggleCls("autoExecute",values.autoExecute==="on");this.up("notebook").setIsEdited(true)}win.close()},scope:this},{text:this.localize("cancel"),handler:function(btn){btn.up("window").close()},scope:this}]})).show()},scope:this},{xtype:"notebookwrapperexport"}]},{xtype:"toolbar",dock:"right",items:[{xtype:"notebookwrappercounter",order:config.order,name:config.cellId},{xtype:"notebookwrapperremove"},{xtype:"notebookwrappermoveup"},{xtype:"notebookwrappermovedown"}]}],items:[this.editor,this.results]});
if(config.uiHtml!==undefined)this.items.push(this._getUIComponent(config.uiHtml));this.callParent(arguments)},initComponent:function(config){var me=this;me.on("afterrender",function(){if(this.editor&&this.editor.getMode()!="ace/mode/javavscript")this.switchModes(this.editor.getMode(),true);this.getTargetEl().on("resize",function(el){var height=20;me.items.each(function(item){height+=item.getHeight()});me.setSize({height:height})})},this);me.callParent(arguments)},switchModes:function(mode,light){var runnable=
mode.indexOf("javascript")>-1;this.down("notebookwrapperrun").setVisible(runnable);this.down("notebookwrapperexport").setVisible(!runnable);this.queryById("runMultiple").setVisible(runnable);this.results.setVisible(runnable);if(!light)this.editor.switchModes(mode)},run:function(forceRun){if(this.editor.getMode()=="ace/mode/javascript")if(forceRun===true||this.getIsWarnedAboutPreviousCells())return this._run();else{var notebook=this.up("notebook");Ext.Array.each(notebook.query("notebookcodeeditorwrapper"),
function(wrapper){if(wrapper==this){this._run();return false}if(wrapper.editor&&wrapper.editor.getMode()=="ace/mode/javascript"&&wrapper.getIsRun()==false){Ext.Msg.confirm(this.localize("previousNotRunTitle"),this.localize("previousNotRun"),function(btnId){if(btnId=="yes")notebook.runUntil(this);else this._run()},this);this.setIsWarnedAboutPreviousCells(true);return false}},this)}},_run:function(){this.results.show();this.results.update(this.EMPTY_RESULTS_TEXT);this.results.mask("working\u2026");
var code=this.editor.getValue();Voyant.notebook.util.Show.TARGET=this.results.getEl();Voyant.notebook.Notebook.currentBlock=this;Voyant.notebook.Notebook.currentNotebook.setCurrentBlock(this);var result;try{result=eval.call(window,code)}catch(e){this.results.unmask();Voyant.notebook.util.Show.showError(e);this.getTargetEl().fireEvent("resize");return e}this.setIsRun(true);if(result!==undefined)if(result.then&&result.catch&&result.finally){var me=this;result.then(function(result){me.results.unmask();
if(result!==undefined)me._showResult(result)}).catch(function(err){me.results.unmask();Voyant.notebook.util.Show.showError(err)}).finally(function(){Ext.defer(function(){this.getTargetEl().fireEvent("resize")},50,me)})}else{this.results.unmask();this._showResult(result);this.getTargetEl().fireEvent("resize")}else{this.results.unmask();this.getTargetEl().fireEvent("resize")}return result},_getResultsComponent:function(html){return Ext.create("Ext.Component",{align:"stretch",cls:"notebook-code-results",
html:html,getValue:function(){var el=this.getTargetEl(),resultEl=el.dom.cloneNode(true);var output=resultEl.innerHTML;if(!resultEl.style.height)output="\x3cdiv style\x3d'height: "+el.getHeight()+"px'\x3e"+output+"\x3c/div\x3e";return output}})},_getUIComponent:function(html){return Ext.create("Ext.Component",{align:"stretch",cls:"notebook-code-ui",padding:"20 10",html:html,getValue:function(){const el=this.getTargetEl();const resultEl=el.dom.cloneNode(true);let output=resultEl.innerHTML;return output}})},
_showResult:function(result){if(this.results.getEl().dom.innerHTML===this.EMPTY_RESULTS_TEXT)this.results.update(result.toString?result.toString():result)},clearResults:function(){this.results.show();var panel=this.results.el.down(".x-panel");if(panel){var id=panel.id;var cmp=Ext.getCmp(id);if(cmp)cmp.destroy();else panel.destroy()}else this.results.update(" ");this.getTargetEl().fireEvent("resize")},tryToUnmask:function(){if(Spyral&&Spyral.promises)Ext.defer(this.tryToUnmask,20,this);if(Voyant.application.getDeferredCount()===
0){for(var key in window)if(typeof window[key]=="object"&&window[key]&&key!="opener"&&window[key].isFulfilled&&window[key].isFulfilled())window[key]=window[key].valueOf();this.results.unmask();if(this.results.getTargetEl().getHtml().trim().length===0)this.results.hide();this.getTargetEl().fireEvent("resize")}else Ext.defer(this.tryToUnmask,20,this)},getContent:function(){var toReturn={input:this.editor.getValue(),mode:this.editor.getMode().split("/").pop()};if(toReturn.mode==="javascript"){toReturn.output=
this.results.getValue();var ui=this.down('component[cls\x3d"notebook-code-ui"]');if(ui!==null)toReturn.ui=ui.getValue()}return toReturn},setContentAndMode:function(content,mode,config){debugger;this.editor.setContent(content);this.switchModes(mode||"javascript")}});Ext.define("Voyant.notebook.editor.TextEditor",{extend:"Ext.Component",mixins:["Voyant.util.Localization"],alias:"widget.notebooktexteditor",cls:"notebook-text-editor",config:{ckeditorConfig:{toolbar:[{name:"basicstyles",items:["Bold","Italic","-","RemoveFormat"]},{name:"paragraph",items:["NumberedList","BulletedList","-","Justify","Outdent","Indent","Blockquote","JustifyLeft","JustifyCenter","JustifyRight"]},{name:"colors",items:["TextColor","BGColor"]},{name:"styles",items:["Styles","Format"]},
{name:"links",items:["Link","Unlink","Anchor"]},{name:"insert",items:["Image","Table"]},{name:"document",items:["inserthtml4x","Sourcedialog","Stopediting"]}],extraPlugins:"stopediting,sourcedialog,justify,colorbutton,inserthtml4x",allowedContent:true,toolbarCanCollapse:true,startupFocus:true},editor:undefined,isEditRegistered:false,currentHeight:0},statics:{i18n:{}},border:false,constructor:function(config){Ext.apply(this,{html:config.content?config.content:this.localize("emptyText")});this.callParent(arguments)},
listeners:{boxready:function(cmp){this.getTargetEl().on("click",function(e,t){if(t.tagName!="A")this.handleClick(cmp)},this)},removed:function(cmp,container){if(cmp.getEditor()){cmp.getEditor().focusManager.blur(true);cmp.getEditor().destroy()}}},handleClick:function(cmp){if(!cmp.getEditor()||cmp.getEditor()&&cmp.getEditor().readOnly){var el=this.getTargetEl();el.set({contenteditable:true});this.findParentByType("notebookeditorwrapper").setIsEditing(true);if(!cmp.getEditor()){var editor=CKEDITOR.inline(el.dom,
this.getCkeditorConfig());editor.on("focus",function(evt){if(this.getTargetEl().dom.innerText==this.localize("emptyText"))this.getTargetEl().update("")},this);editor.on("blur",function(evt){cmp.findParentByType("notebookeditorwrapper").setIsEditing(false).getEl().fireEvent("mouseout");editor.setReadOnly(true)});editor.on("change",function(){var editorHeight=editor.container.$.clientHeight;if(editorHeight!=this.getCurrentHeight()){this.findParentByType("notebookeditorwrapper").setHeight(editorHeight);
this.setCurrentHeight(editor.container.$.clientHeight)}if(!this.getIsEditRegistered()){this.findParentByType("notebook").setIsEdited(true);this.setIsEditRegistered(true)}else{var me=this;setTimeout(function(){me.setIsEditRegistered(false)},3E4)}},this);this.setEditor(editor)}else cmp.getEditor().setReadOnly(false)}},getContent:function(){return this.getTargetEl().dom.innerHTML}});Ext.define("Voyant.notebook.editor.TextEditorWrapper",{extend:"Voyant.notebook.editor.EditorWrapper",requires:["Voyant.notebook.editor.TextEditor","Voyant.notebook.editor.button.Edit"],alias:"widget.notebooktexteditorwrapper",cls:"notebook-text-wrapper",config:{content:""},minHeight:85,constructor:function(config){Ext.apply(this,{items:[{xtype:"notebooktexteditor",content:Ext.Array.from(config.input).join("")}],dockedItems:[{xtype:"toolbar",dock:"left",items:[{xtype:"notebookwrapperadd"}]},{xtype:"toolbar",
dock:"right",items:[{xtype:"notebookwrappercounter",order:config.order,name:config.cellId},{xtype:"notebookwrapperremove"},{xtype:"notebookwrappermoveup"},{xtype:"notebookwrappermovedown"}]}]});this.callParent(arguments)},getContent:function(){return this.items.get(0).getContent()}});Ext.define("Voyant.notebook.github.OctokitWrapper",{extend:"Ext.Base",alias:"octokitwrapper",octokit:undefined,constructor:function(config){const authToken=config.authToken;this.octokit=new Octokit({auth:authToken,userAgent:"https://github.com/sgsinclair/Voyant"})},getInfoForAuthenticatedUser:function(){return this.octokit.users.getAuthenticated()},getReposForAuthenticatedUser:function(affiliation="owner",page=0,per_page=10){return this.octokit.repos.listForAuthenticatedUser({affiliation,page,per_page})},
getReposForUser:function(owner,page=0,per_page=10){return this.octokit.search.repos({q:"user:"+owner,page,per_page})},searchWithinRepositories:function(query,page=0,per_page=10){console.log(query)},getRepoContents:function(repoId){let {owner,repo}=this.parseFullName(repoId);return this.getBranchSHAs({owner,repo,branch:"master"}).then(function(resp){return this.getTreeContentsRecursively(resp)}.bind(this))},getTreeContentsRecursively:function(params){return this.octokit.git.getTree({owner:params.owner,
repo:params.repo,tree_sha:params.baseTreeSHA,recursive:1,headers:{"If-None-Match":""}}).then(function(resp){return{...params,contents:this.unflattenContents(resp.data.tree),truncated:resp.data.truncated}}.bind(this))},loadFile:function(repoId,path){let {owner,repo}=this.parseFullName(repoId);let ref="master";return this.octokit.repos.getContents({owner,repo,ref,path}).then(function(resp){return{owner,repo,ref,path,sha:resp.data.sha,file:atob(resp.data.content)}}.bind(this))},doesRepoExist:function(owner,
repo){return this.getRepoContents(owner+"/"+repo).then(function(resp){return true}.bind(this),function(err){console.log(err);return false}.bind(this))},getPermissionsForUser:function(owner,repo,username){return this.octokit.repos.getCollaboratorPermissionLevel({owner,repo,username}).then(function(resp){return resp.data.permission}.bind(this),function(err){return"none"}.bind(this))},saveFile:async function(owner,repo,path,content,branch,message,sha){if(sha===undefined)sha=await this.getLatestFileSHA({owner,
repo,branch,path});return this.octokit.repos.createOrUpdateFile({owner,repo,path,content:btoa(content),branch,message,sha})},parseFullName:function(fullName){let [owner,repo]=fullName.split("/");return{owner,repo}},getBranchSHAs:function(params){return this.octokit.repos.getBranch({owner:params.owner,repo:params.repo,branch:params.branch,headers:{"If-None-Match":""}}).then(resp=>{return{...params,baseTreeSHA:resp.data.commit.commit.tree.sha,parentCommitSHA:resp.data.commit.sha}})},getLatestFileSHA:async function(params){const {owner,
repo,branch,path}=params;const {data:{data:{repository:{object:result}}}}=await this.octokit.request({method:"POST",url:"/graphql",query:`{
				repository(owner: "${owner}", name: "${repo}") {
					object(expression: "${branch}:${path}") {
						... on Blob {
							oid
						}
					}
				}
			}`}).catch(function(error){console.log(error)});const sha=result?result.oid:undefined;return sha},unflattenContents:function(flatContents){const files=flatContents.filter(file=>file.type==="blob");var result={type:"folder",name:"",path:"",contents:[]};const findSubFolder=(parentFolder,folderNameToFind)=>{const subfolder=parentFolder.contents.find(el=>{return el.type==="folder"&&el.name===folderNameToFind});return subfolder};const addSubFolder=(newFolderName,parentFolder)=>{const newSubFolder={type:"folder",
name:newFolderName,path:`${parentFolder.path}/${newFolderName}`,contents:[]};parentFolder.contents.push(newSubFolder);return newSubFolder};const addFile=(newFileName,parentFolder)=>{const newFile={type:"file",name:newFileName,path:`${parentFolder.path}/${newFileName}`};parentFolder.contents.push(newFile)};const isFile=(pathSections,currentIndex)=>{return pathSections.length-1==currentIndex};files.forEach(file=>{const pathSections=file.path.split("/");pathSections.reduce(function(parentFolder,pathSection,
pathSectionIndex){const subFolder=findSubFolder(parentFolder,pathSection);if(subFolder)return subFolder;else if(isFile(pathSections,pathSectionIndex))return addFile(pathSection,parentFolder);else return addSubFolder(pathSection,parentFolder)},result)});return result}});Ext.define("Voyant.notebook.github.ReposBrowser",{extend:"Ext.container.Container",xtype:"githubreposbrowser",config:{repoType:"owner",selectedNode:undefined,repoId:undefined,path:undefined},octokit:undefined,constructor:function(config){config=config||{};this.octokit=config.octokit;this.callParent(arguments)},initComponent:function(){Ext.apply(this,{layout:{type:"hbox",align:"stretch",pack:"start"},items:[{layout:{type:"vbox",align:"stretch",pack:"start"},flex:1,items:[{layout:{type:"accordion"},
items:[{title:"My Repositories",frame:true,items:{xtype:"radiogroup",fieldLabel:"Show repositories for which I am",labelAlign:"top",layout:"vbox",items:[{boxLabel:"Owner",name:"repoType",inputValue:"owner",checked:true},{boxLabel:"Collaborator",name:"repoType",inputValue:"collaborator"},{boxLabel:"Organization Member",name:"repoType",inputValue:"organization_member"}],listeners:{change:function(field,newValues,oldValue){this.setRepoType(newValues.repoType);this.clearTree(true);this.octokit.getReposForAuthenticatedUser(this.getRepoType(),
0,100).then(resp=>{this.addReposToTree(resp.data)},error=>{console.log(error)})},scope:this}},listeners:{expand:function(){this.clearTree(true);this.octokit.getReposForAuthenticatedUser(this.getRepoType(),0,100).then(resp=>{this.addReposToTree(resp.data)},error=>{console.log(error)})},scope:this}},{title:"Public Repositories",frame:true,layout:"vbox",items:[{fieldLabel:"Limit to user or organization",labelAlign:"top",xtype:"textfield"},{text:"Search",xtype:"button",handler:function(button){let repoOwner=
button.prev("textfield").getValue();if(repoOwner!==""){this.clearTree(true);this.octokit.getReposForUser(repoOwner,0,100).then(resp=>{this.addReposToTree(resp.data.items)},error=>{console.log(error)})}},scope:this}],listeners:{expand:function(){this.clearTree()},scope:this}}]}]},{flex:2,layout:"fit",xtype:"treepanel",itemId:"repoTree",title:"Repositories",scrollable:true,rootVisible:false,viewConfig:{emptyText:"No results",listeners:{afteritemexpand:function(node,index,el){if(node.hasChildNodes()===
false)switch(node.data.type){case "repo":let tr=el.querySelector("tr");Ext.fly(tr).addCls("x-grid-tree-loading");this.octokit.getRepoContents(node.getId()).then(function(resp){Ext.fly(tr).removeCls("x-grid-tree-loading");this.addRepoContentsToNode(node,resp)}.bind(this));break;case "folder":break}},itemclick:function(view,node,el){this.setSelectedNode(node);this.fireEvent("nodeSelected",this,node.data.type,node)},scope:this}},store:{root:{name:"Root",children:[]}}}],listeners:{boxready:function(){this.down("#repoTree").setLoading(true);
this.octokit.getReposForAuthenticatedUser(this.getRepoType(),0,100).then(resp=>{this.addReposToTree(resp.data)},error=>{console.log(error)})}}});this.callParent(arguments)},updateSelectedNode:function(node,oldValue){if(node!==undefined){let repoParent=node;while(repoParent!==null&&repoParent.data.type!=="repo")repoParent=repoParent.parentNode;this.setRepoId(repoParent.getId());this.setPath(node.getId())}else{this.setRepoId(undefined);this.setPath(undefined)}},clearTree:function(setLoading){let repoTree=
this.down("#repoTree");let root=repoTree.getRootNode();root.removeAll();repoTree.getView().refresh();if(setLoading)repoTree.setLoading(true);this.setSelectedNode(undefined);this.fireEvent("nodeDeselected",this)},addReposToTree:function(rawRepos){let repoTree=this.down("#repoTree");repoTree.setLoading(false);let root=repoTree.getRootNode();let repos=rawRepos.map(repo=>{return{id:repo.full_name,text:repo.full_name,description:repo.description,leaf:false,type:"repo"}});root.appendChild(repos)},addRepoContentsToNode:function(node,
octokitResponse){function parseContents(content){let nodeConfig={id:content.path,text:content.name,type:content.type,leaf:content.type==="file"};if(nodeConfig.leaf===false){nodeConfig.children=[];content.contents.forEach(child=>{nodeConfig.children.push(parseContents(child))})}return nodeConfig}let contents=parseContents(octokitResponse.contents);node.appendChild(contents.children)}});Ext.define("Voyant.notebook.github.FileSaver",{extend:"Ext.container.Container",xtype:"githubfilesaver",config:{currentFile:undefined,username:undefined},octokit:undefined,saveData:undefined,constructor:function(config){config=config||{};this.octokit=config.octokit;this.saveData=config.saveData;this.setCurrentFile(config.currentFile);this.callParent(arguments)},initComponent:function(){Ext.apply(this,{layout:{type:"vbox",pack:"start",align:"stretch"},items:[{xtype:"githubreposbrowser",octokit:this.octokit,
itemId:"repoBrowser",flex:1,listeners:{nodeSelected:function(src,type,node){const form=this.queryById("saveForm").getForm();const [owner,repo]=src.getRepoId().split("/");form.setValues({owner,repo});if(type==="file"){const pathComponents=this.getPathComponents(src.getPath());form.setValues({...pathComponents})}else if(type==="folder"){const folder=src.getPath().replace(/^\//,"");form.setValues({folder,file:""})}else if(type==="repo")form.setValues({folder:"",file:""})},nodeDeselected:function(node){},
scope:this}},{bodyPadding:"10",height:200,layout:{type:"vbox",pack:"start"},xtype:"form",itemId:"saveForm",items:[{html:'\x3cspan class\x3d"x-panel-header-title-default"\x3eRepository Path\x3c/span\x3e'},{xtype:"container",layout:"hbox",defaults:{xtype:"textfield",labelAlign:"top"},items:[{fieldLabel:"GitHub User",name:"owner",allowBlank:false,margin:"0 10 0 0"},{fieldLabel:"Repository Name",allowBlank:false,name:"repo"}]},{html:'\x3cspan class\x3d"x-panel-header-title-default"\x3eFile Path\x3c/span\x3e',
margin:"10 0 0 0"},{xtype:"container",layout:"hbox",defaults:{xtype:"textfield",labelAlign:"top"},items:[{fieldLabel:"Folder(s)",name:"folder",allowBlank:true,margin:"0 10 0 0"},{fieldLabel:"File Name",allowBlank:false,name:"file"}]},{itemId:"status",html:"",margin:"15 0 0 0"}],listeners:{validitychange:function(form,valid){this.fireEvent("formValidityChange",this,valid)},scope:this}}],listeners:{boxready:function(){this.initForm()},scope:this}});this.callParent(arguments)},initForm:function(){this.octokit.getInfoForAuthenticatedUser().then(function(resp){const username=
resp.data.login;this.setUsername(username);const form=this.queryById("saveForm").getForm();const currentFile=this.getCurrentFile();if(currentFile!==undefined){const pathComponents=this.getPathComponents(currentFile.path);form.setValues({owner:currentFile.owner,repo:currentFile.repo,...pathComponents})}else form.setValues({owner:username})}.bind(this))},getPathComponents:function(path){const pathComponents=path.split("/");let file=pathComponents[pathComponents.length-1];let folder="";if(pathComponents.length>
2)folder=pathComponents.slice(0,-1).join("/");return{folder,file}},doSave:async function(isPR=false){const form=this.queryById("saveForm").getForm();if(form.isValid()){const {owner,repo,folder,file}=form.getValues();let path=file;if(folder!=="")path=folder+"/"+file;this.setStatus("Checking repository");const repoExists=await this.octokit.doesRepoExist(owner,repo);if(repoExists){this.setStatus("Checking permissions");const permission=await this.octokit.getPermissionsForUser(owner,repo,this.getUsername());
if(permission==="none"||permission==="read")this.setStatus("You don't have permission to write to this repository","error");else{this.setStatus("Checking file");const branch="master";const content=this.saveData;const fileData={owner,repo,branch,path};const sha=await this.octokit.getLatestFileSHA(fileData);if(sha!==undefined){const message="File updated by Spyral";this.octokit.saveFile(owner,repo,path,content,branch,message,sha).then(function(resp){this.setStatus("File updated");setTimeout(function(){this.fireEvent("fileSaved",
this,fileData)}.bind(this),500)}.bind(this),function(error){this.setStatus("Error: "+error.message,"error")})}else{const message="File created by Spyral";this.octokit.saveFile(owner,repo,path,content,branch,message).then(function(resp){this.setStatus("File created");setTimeout(function(){this.fireEvent("fileSaved",this,fileData)}.bind(this),500)}.bind(this),function(error){this.setStatus("Error: "+error.message,"error")})}}}else this.setStatus("The specified repository does not exist","error")}else this.setStatus("Form is not valid",
"error")},setStatus:function(message,type){let cls="";if(type&&type==="error")cls="x-form-invalid-under-default";this.queryById("status").setHtml(`<span class="${cls}">${message}</span>`)}});Ext.define("Voyant.notebook.github.GitHubDialogs",{extend:"Ext.Component",requires:["Voyant.notebook.github.OctokitWrapper","Voyant.notebook.github.ReposBrowser","Voyant.notebook.github.FileSaver"],alias:"widget.githubdialogs",config:{repoType:"owner",currentFile:undefined},authToken:undefined,octokitWrapper:undefined,currentWindow:undefined,constructor:function(config){config=config||{};this.callParent(arguments)},initComponent:function(){this.callParent(arguments)},close:function(){if(this.currentWindow!==
undefined){this.currentWindow.close();this.currentWindow=undefined}},showAuthenticate:function(callback){const parent=this;let authWin=undefined;authWin=Ext.create("Ext.window.Window",{title:"Authenticate with GitHub",width:750,height:550,closable:false,layout:{type:"vbox",align:"middle",pack:"center"},items:[{html:'\x3cdiv style\x3d"margin-bottom: 10px;"\x3eYou must authorize Spyral to use GitHub on your behalf.\x3c/div\x3e'},{xtype:"button",text:"Authorize with GitHub",handler:function(button){function postMessageHandler(event){if(event.origin===
window.location.origin&&event.data==="oauth_cookie_set"){window.removeEventListener("message",postMessageHandler,false);event.source.close();parent.initOctokitWrapper();button.up("window").close();callback.call(parent)}}window.open(Voyant.application.getBaseUrlFull()+"spyral/oauth","_blank");window.addEventListener("message",postMessageHandler,false)}}],buttons:[{text:"Cancel",handler:function(){parent.close()}}]});authWin.show();this.currentWindow=authWin},showLoad:function(){const parent=this;this.authToken=
this.getCookieValue("access-token");if(this.authToken===""){this.showAuthenticate(this.showLoad);return}else if(this.octokitWrapper===undefined)this.initOctokitWrapper();let loadWin=undefined;loadWin=Ext.create("Ext.window.Window",{title:"Load from GitHub",width:750,height:550,closable:false,maximizable:true,layout:"fit",items:{xtype:"githubreposbrowser",octokit:this.octokitWrapper,itemId:"repoBrowser",listeners:{nodeSelected:function(src,type,node){if(type==="file")loadWin.queryById("load").setDisabled(false);
else loadWin.queryById("load").setDisabled(true)},nodeDeselected:function(node){loadWin.queryById("load").setDisabled(true)}}},buttons:[{text:"Load Selected",itemId:"load",disabled:true,handler:function(){const repoBrowser=loadWin.queryById("repoBrowser");this.loadFile(repoBrowser.getRepoId(),repoBrowser.getPath())},scope:this},{text:"Cancel",handler:function(){parent.close()}}]});loadWin.show();this.currentWindow=loadWin},showSave:function(data){const parent=this;this.authToken=this.getCookieValue("access-token");
if(this.authToken===""){this.showAuthenticate();return}else if(this.octokitWrapper===undefined)this.initOctokitWrapper();let saveWin=undefined;saveWin=Ext.create("Ext.window.Window",{title:"Save to GitHub",width:750,height:650,closable:false,maximizable:true,layout:"fit",items:{xtype:"githubfilesaver",octokit:this.octokitWrapper,currentFile:this.getCurrentFile(),saveData:data,itemId:"fileSaver",listeners:{formValidityChange:function(src,valid){saveWin.queryById("save").setDisabled(!valid)},fileSaved:function(src,
fileData){parent.fireEvent("fileSaved",parent,fileData)}}},buttons:[{text:"Save",itemId:"save",disabled:true,handler:function(){saveWin.queryById("fileSaver").doSave()},scope:this},{text:"Cancel",handler:function(){parent.close();parent.fireEvent("saveCancelled",parent)}}]});saveWin.show();this.currentWindow=saveWin},getCookieValue:function(cookieName){const re=new RegExp("[; ]"+cookieName+"\x3d([^\\s;]*)");const sMatch=(" "+document.cookie).match(re);if(cookieName&&sMatch)return unescape(sMatch[1]);
return""},initOctokitWrapper:function(){this.authToken=this.getCookieValue("access-token");this.octokitWrapper=new Voyant.notebook.github.OctokitWrapper({authToken:this.authToken})},loadFileFromId:function(id){const parts=decodeURIComponent(id).split("/");if(parts.length>=3){const repoId=parts[0]+"/"+parts[1];const filePath=parts.slice(2).join("/");this.loadFile(repoId,filePath)}},loadFile:function(repoId,filePath){this.authToken=this.getCookieValue("access-token");if(this.authToken===""){this.showAuthenticate(this.loadFile.bind(this,
repoId,filePath));return}else if(this.octokitWrapper===undefined)this.initOctokitWrapper();this.octokitWrapper.loadFile(repoId,filePath).then(data=>{this.setCurrentFile(data);this.fireEvent("fileLoaded",this,data)})}});Ext.define("Voyant.notebook.StorageDialogs",{extend:"Ext.Component",requires:[],alias:"",config:{accessCode:undefined},constructor:function(config){config=config||{};this.callParent(arguments)},initComponent:function(){this.callParent(arguments)},showSave:function(data,notebookId=""){const me=this;const newNotebook=notebookId==="";const title=newNotebook?"Save New Notebook":"Overwrite Existing Notebook";Ext.create("Ext.window.Window",{title:title,items:[{xtype:"form",width:450,bodyPadding:5,plugins:["datatip"],
listeners:{beforeshowtip:function(tip,config,msg){return!config.currentTarget.el.hasCls("x-form-invalid")}},layout:"anchor",defaults:{labelAlign:"right",labelWidth:160,width:360,inputAttrTpl:'spellcheck\x3d"false"',xtype:"textfield"},items:[{fieldLabel:"Notebook ID"+(newNotebook?" (optional)":""),name:"notebookId",value:notebookId,allowBlank:true,readOnly:!newNotebook,tooltip:"An ID used to identify this notebook. If left blank, one will be generated for you.",validator:function(val){if(val=="")return true;
else if(val.match(/^[\w-]{4,16}$/)===null)return"The ID must be between 4 and 16 alphanumeric characters.";else return true}},{fieldLabel:"Access Code",name:"accessCode",allowBlank:false,value:newNotebook?this.generateAccessCode():this.getAccessCode(),tooltip:"The Access Code is required to overwrite this notebook.",validator:function(val){if(val.match(/^[\w-]{4,16}$/)===null)return"The access code must be between 4 and 16 alphanumeric characters.";else return true}},{fieldLabel:"Email (optional)",
name:"email",allowBlank:true,vtype:"email",hidden:!newNotebook,tooltip:"An email will be sent to this address with the Notebook URL and Access Code."}]}],buttons:[{text:"Cancel",ui:"default-toolbar",handler:function(){this.up("window").close();me.fireEvent("saveCancelled",me)}}," ",{text:"Save",handler:function(button){const win=button.up("window");const form=win.down("form").getForm();if(form.isValid()){const values=form.getValues();values.data=data;if(newNotebook&&values.notebookId!=="")me.doesNotebookIdExist(values.notebookId).then(function(exists){if(exists)form.findField("notebookId").markInvalid("That Notebook ID already exists.");
else{me.doSave(values);win.close()}});else{button.setDisabled(true);me.doSave(values).then(function(didSave){button.setDisabled(false);if(didSave)win.close();else form.findField("accessCode").markInvalid("Invalid access code.")})}}}}],listeners:{close:function(){me.fireEvent("close",me)}}}).show()},doesNotebookIdExist:function(id){const dfd=new Ext.Deferred;Spyral.Load.trombone({tool:"notebook.NotebookManager",action:"exists",id:id,noCache:1}).then(function(json){var exists=json.notebook.data==="true";
dfd.resolve(exists)}).catch(function(err){console.log(err)});return dfd.promise},doSave:function({notebookId,accessCode,email,data}){const me=this;return Spyral.Load.trombone({tool:"notebook.NotebookManager",action:"save",id:notebookId,accessCode:accessCode,email:email,data:data}).then(function(json){if(json.notebook.data!=="true")return false;else{me.setAccessCode(accessCode);const notebookId=json.notebook.id;me.fireEvent("fileSaved",me,notebookId);return true}}).catch(function(err){me.fireEvent("fileSaved",
me,null);return false})},generateAccessCode:function(){const alphabet=["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z"];let code="";while(code.length<6)if(Math.random()<.3)code+=Math.floor(Math.random()*9);else{let letter=alphabet[Math.floor(Math.random()*alphabet.length)];if(Math.random()<.5)letter=letter.toUpperCase();code+=letter}return code}});Ext.define("Voyant.notebook.Notebook",{alternateClassName:["Notebook"],extend:"Ext.panel.Panel",requires:["Voyant.notebook.editor.CodeEditorWrapper","Voyant.notebook.editor.TextEditorWrapper","Voyant.notebook.util.Show","Voyant.panel.Cirrus","Voyant.panel.Summary","Voyant.notebook.StorageDialogs","Voyant.notebook.github.GitHubDialogs"],mixins:["Voyant.panel.Panel"],alias:"widget.notebook",statics:{i18n:{title:"Spyral",metadataEditor:"Edit Metadata",metadataTitle:"Title",metadataTip:"Edit notebook metadata.",
metadataAuthor:"Author(s)",metadataKeywords:"Keywords",metadataDescription:"Description",metadataLicense:"Licence",metadataLanguage:"Language",metadataReset:"Reset",metadataSave:"Save",metadataCancel:"Cancel",created:"Created",modified:"Modified",clickToEdit:"Click to edit",cantLoadNotebook:"Unable to load Spyral notebook:",cannotLoadJson:"Unable to parse JSON input.",cannotLoadJsonUnrecognized:"Unable to recognize JSON input.",cannotLoadUnrecognized:"Unable to recognize input.",openTitle:"Open",
openMsg:"Paste in Notebook ID, a URL or a Spyral data file (in HTML).",exportHtmlDownload:"HTML (download)",errorParsingDomInput:"An error occurred while parsing the input of the document. The results might still work, except if the code contained HTML tags."},api:{input:undefined,inputEncodedBase64Json:undefined,run:undefined},currentNotebook:undefined},config:{notebookId:undefined,metadata:undefined,isEdited:false,version:"3.0",currentBlock:undefined,storageSolution:"voyant"},voyantStorageDialogs:undefined,
githubDialogs:undefined,spyralTernDocs:undefined,constructor:function(config){Voyant.notebook.Notebook.currentNotebook=this;Ext.apply(config,{title:this.localize("title"),autoScroll:true,includeTools:{"help":true,"gear":true,"save":true,"saveIt":{tooltip:this.localize("saveItTip"),itemId:"saveItTool",xtype:"toolmenu",glyph:"xf0c2@FontAwesome",disabled:true,scope:this,items:[{text:"Save",xtype:"menuitem",glyph:"xf0c2@FontAwesome",handler:this.showSaveDialog.bind(this,false),scope:this},{text:"Save As...",
xtype:"menuitem",glyph:"xf0c2@FontAwesome",handler:this.showSaveDialog.bind(this,true),scope:this}]},"new":{tooltip:this.localize("newTip"),callback:function(){let url=this.getBaseUrl()+"spyral/";this.getApplication().openUrl(url)},xtype:"toolmenu",glyph:"xf067@FontAwesome",scope:this},"open":{tooltip:this.localize("openTip"),xtype:"toolmenu",glyph:"xf115@FontAwesome",callback:function(panel,tool){const storageSolution=this.getStorageSolution();if(storageSolution===undefined);else{setTimeout(()=>
{tool.toolMenu.hide()});if(storageSolution==="github")this.githubDialogs.showLoad();else Ext.Msg.prompt(this.localize("openTitle"),this.localize("openMsg"),function(btn,text){text=text.trim();if(btn=="ok"){this.clear();this.loadFromString(text)}},this,true)}},scope:this,items:[{text:"Load",xtype:"menuitem",glyph:"xf115@FontAwesome",handler:function(){Ext.Msg.prompt(this.localize("openTitle"),this.localize("openMsg"),function(btn,text){text=text.trim();if(btn=="ok"){this.clear();this.loadFromString(text)}},
this,true)},scope:this},{text:"Load from GitHub",xtype:"menuitem",glyph:"xf115@FontAwesome",handler:function(){this.githubDialogs.showLoad()},scope:this}]},"runall":{tooltip:this.localize("runallTip"),callback:this.runAll,xtype:"toolmenu",glyph:"xf04e@FontAwesome",scope:this},"metadata":{tooltip:this.localize("metadataTip"),callback:this.showMetadataEditor,xtype:"toolmenu",glyph:"xf02c@FontAwesome",scope:this}},items:[{itemId:"spyralHeader",cls:"spyral-header",listeners:{afterrender:function(header){Ext.tip.QuickTipManager.register({target:header.getId(),
text:this.localize("clickToEdit")});var head=header;header.getTargetEl().on("click",function(header){this.showMetadataEditor();head.removeCls("editable")},this);header.mon(header.getEl(),"mouseover",function(){header.addCls("editable")});header.mon(header.getEl(),"mouseout",function(){header.removeCls("editable")})},scope:this}},{xtype:"container",itemId:"cells"},{itemId:"spyralFooter",cls:"spyral-footer",listeners:{afterrender:function(footer){Ext.tip.QuickTipManager.register({target:footer.getId(),
text:this.localize("clickToEdit")});var foot=footer;footer.getTargetEl().on("click",function(footer){this.showMetadataEditor();foot.removeCls("editable")},this);footer.mon(footer.getEl(),"mouseover",function(){footer.addCls("editable")});footer.mon(footer.getEl(),"mouseout",function(){footer.removeCls("editable")})},scope:this}}],listeners:{afterrender:this.init,notebookWrapperMoveUp:this.notebookWrapperMoveUp,notebookWrapperMoveDown:this.notebookWrapperMoveDown,notebookWrapperRemove:this.notebookWrapperRemove,
notebookWrapperAdd:this.notebookWrapperAdd,notebookLoaded:this.autoExecuteCells,scope:this}});this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.voyantStorageDialogs=new Voyant.notebook.StorageDialogs({listeners:{"fileLoaded":function(src){},"fileSaved":function(src,notebookId){this.unmask();if(notebookId!==null){var id=this.getNotebookId();if(!id||notebookId!=id)this.setNotebookId(notebookId);this.toastInfo({html:this.localize("saved"),anchor:"tr"});
this.setIsEdited(false)}else;},"saveCancelled":function(){},"close":function(){this.unmask()},scope:this}});this.githubDialogs=new Voyant.notebook.github.GitHubDialogs({listeners:{"fileLoaded":function(src,{owner,repo,ref,path,file}){this.githubDialogs.close();this.clear();this.loadFromString(file);const id=encodeURIComponent(owner+"/"+repo+"/"+path);if(location.search.indexOf(id)===-1){const url=this.getBaseUrl()+"spyral/?githubId\x3d"+id;window.history.pushState({url:url},"Spyral Notebook: "+id,
url)}},"fileSaved":function(src,{owner,repo,branch,path}){this.githubDialogs.close();this.unmask();this.toastInfo({html:this.localize("saved"),anchor:"tr"});this.setIsEdited(false);const id=encodeURIComponent(owner+"/"+repo+"/"+path);if(location.search.indexOf(id)===-1){const url=this.getBaseUrl()+"spyral/?githubId\x3d"+id;window.history.pushState({url:url},"Spyral Notebook: "+id,url)}},"saveCancelled":function(src){this.unmask()},scope:this}})},init:function(){window.Corpus=Spyral.Corpus;window.Table=
Spyral.Table;window.loadCorpus=function(){return Spyral.Corpus.load.apply(Spyral.Corpus.load,arguments)};window.createTable=function(){return Spyral.Table.create.apply(Spyral.Table,arguments)};Ext.Ajax.request({url:this.getApplication().getBaseUrlFull()+"resources/spyral/docs/spyral.json",callback:function(opts,success,response){if(success){this.spyralTernDocs=Ext.JSON.decode(response.responseText);this.spyralTernDocs.Corpus=this.spyralTernDocs.Spyral.Corpus;this.spyralTernDocs.Table=this.spyralTernDocs.Spyral.Table;
this.spyralTernDocs.loadCorpus=this.spyralTernDocs.Spyral.Corpus.load;this.spyralTernDocs.createTable=this.spyralTernDocs.Spyral.Table.create}var queryParams=Ext.Object.fromQueryString(document.location.search,true);var isRun=Ext.isDefined(queryParams.run);var spyralIdMatches=/\/spyral\/([\w-]+)\/?$/.exec(location.pathname);var isGithub=Ext.isDefined(queryParams.githubId);if("inputJsonArrayOfEncodedBase64"in queryParams){let json=Ext.decode(queryParams.inputJsonArrayOfEncodedBase64);json.forEach(function(block){let text=
decodeURIComponent(atob(block));if(text.trim().indexOf("\x3c")==0)this.addText(text);else this.addCode(text)},this)}else if(queryParams.input){if(queryParams.input.indexOf("http")===0)this.loadFromUrl(queryParams.input,isRun)}else if(spyralIdMatches){this.loadFromId(spyralIdMatches[1]);this.setStorageSolution("voyant")}else if(isGithub){this.githubDialogs.loadFileFromId(queryParams.githubId);this.setStorageSolution("github")}else this.addNew();if(isRun){var me=this;Ext.defer(function(){me.runAll()},
100)}},scope:this})},setBlock:function(data,offset,mode,config){data=data||"";offset=offset||1;config=config||{};var containers=this.query("notebookeditorwrapper");var id=this.getCurrentBlock().id;var current=containers.findIndex(function(container){return container.id==id});if(current+offset<0||current+offset>containers.length){Ext.Msg.show({title:this.localize("error"),msg:this.localize("blockDoesNotExist"),buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});return undefined}if(containers[current+
offset]){var cells=this.getComponent("cells");cells.remove(containers[current+offset])}return this.addCode(Object.assign({},{input:data,mode:mode||"text"},config),current+offset)},getBlock:function(offset,config){offset=offset||0;config=config||{};var containers=this.query("notebookcodeeditorwrapper");var id=this.getCurrentBlock().id;var current=containers.findIndex(function(container){return container.id==id});if(current+offset<0||current+offset>containers.length-1){if("failQuietly"in config&&config.failQuietly);
else Ext.Msg.show({title:this.localize("error"),msg:this.localize("blockDoesNotExist"),buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});return undefined}content=containers[current+offset].getContent();return content.input},addNew:function(){this.setMetadata(new Spyral.Metadata({title:"\x3ch1\x3eSpyral Notebook\x3c/h1\x3e"}));this.addText("\x3cp\x3eThis is a Spyral Notebook, a dynamic document that combines writing, code and data in service of reading, analyzing and interpreting digital texts.\x3c/p\x3e\x3cp\x3eSpyral Notebooks are composed of text blocks (like this one) and code blocks (like the one below). You can \x3cspan class\x3d'marker'\x3eclick on the blocks to edit\x3c/span\x3e them and add new blocks by clicking add icon that appears in the left column when hovering over a block.\x3c/p\x3e");
var code=this.addCode("");Ext.defer(function(){code.run()},100,this)},clear:function(){this.setMetadata(new Spyral.Metadata);var cells=this.getComponent("cells");cells.removeAll()},showSaveDialog:function(saveAs){this.mask(this.localize("saving"));this.getMetadata().setDateNow("modified");const data=this.generateExportHtml();const storageSolution=this.getStorageSolution();if(storageSolution==="voyant"&&this.getNotebookId()!==undefined&&this.voyantStorageDialogs.getAccessCode()!==undefined)this.voyantStorageDialogs.doSave({notebookId:this.getNotebookId(),
data:data,accessCode:this.voyantStorageDialogs.getAccessCode()});else if(storageSolution==="github")this.githubDialogs.showSave(data);else this.voyantStorageDialogs.showSave(data,saveAs?undefined:this.getNotebookId())},loadFromString:function(text){text=text.trim();if(text.indexOf("http")==0)this.loadFromUrl(text);else if(text.indexOf("{")==0){var json;try{json=JSON.parse(text)}catch(e){return Ext.Msg.show({title:this.localize("error"),msg:this.localize("cannotLoadJson")+"\x3cbr\x3e\x3cpre style\x3d'color: red'\x3e"+
e+"\x3c/pre\x3e",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR})}if(!json.metadata||!json.blocks)return Ext.Msg.show({title:this.localize("error"),msg:this.localize("cannotLoadJsonUnrecognized"),buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});json.blocks.forEach(function(block){if(Ext.isString(block)&&block!="")this.addCode({input:block});else if(block.input)if(block.type=="text")this.addText(block);else this.addCode(block)},this)}else if(/^[\w-_]+$/.test(text))this.loadFromId(text);else if(text.indexOf("\x3c")!==
0||text.indexOf("spyral")==-1)return Ext.Msg.show({title:this.localize("error"),msg:this.localize("cannotLoadUnrecognized"),buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});else this.loadFromHtmlString(text);return true},loadFromId:function(id){this.mask(this.localize("loading"));var me=this;Spyral.Load.trombone({tool:"notebook.NotebookManager",action:"load",id:id,noCache:1}).then(function(json){me.unmask();me.loadFromString(json.notebook.data);if(json.notebook.id&&json.notebook.id!=me.getNotebookId())me.setNotebookId(json.notebook.id);
me.setIsEdited(false)}).catch(function(err){me.unmask()})},loadFromHtmlString:function(html){var parser=new DOMParser;var dom=parser.parseFromString(html,"text/html");this.setMetadata(new Spyral.Metadata(dom));var hasDomError=false;dom.querySelectorAll("section.notebook-editor-wrapper").forEach(function(section){var classes=section.classList;if(classes.contains("notebooktexteditorwrapper")){var editor=section.querySelector(".notebook-text-editor").innerHTML;this.addText(editor,undefined,section.id)}else if(classes.contains("notebookcodeeditorwrapper")){var inputEl=
section.querySelector(".notebook-code-editor-raw");var typeRe=/\beditor-mode-(\w+)\b/.exec(inputEl.className);var editorType=typeRe[1];var secPos=html.indexOf("\x3csection id\x3d'"+section.id+"' class\x3d'notebook-editor-wrapper notebookcodeeditorwrapper'\x3e");var startPre=html.indexOf("\x3cpre class\x3d'notebook-code-editor-raw editor-mode-",secPos);startPre=html.indexOf("\x3e",startPre)+1;var endPre=html.indexOf("\x3c/pre\x3e\n\x3cdiv class\x3d'notebook-code-results'\x3e",startPre);if(secPos===
-1||startPre===-1||endPre===-1){hasDomError=true;input=editorType==="javascript"?inputEl.innerText:inputEl.innerHTML;debugger}else input=html.substring(startPre,endPre);var autoexec=/\bautoexec\b/.exec(inputEl.className)!==null;var output=section.querySelector(".notebook-code-results").innerHTML;var ui=section.querySelector(".notebook-code-ui");if(ui!==null)ui=ui.innerHTML;else ui=undefined;this.addCode({input:input,output:output,uiHtml:ui,mode:editorType,autoExecute:autoexec},undefined,section.id)}},
this);if(hasDomError)this.showError(this.localize("errorParsingDomInput"));this.fireEvent("notebookLoaded")},runUntil:function(upToCmp){var containers=[];Ext.Array.each(this.query("notebookcodeeditorwrapper"),function(item){containers.push(item);item.clearResults();if(upToCmp&&upToCmp==item)return false},this);this._run(containers)},runFrom:function(fromCmp){var containers=[],matched=false;Ext.Array.each(this.query("notebookcodeeditorwrapper"),function(item){if(fromCmp&&fromCmp==item)matched=true;
if(matched){containers.push(item);item.clearResults()}},this);this._run(containers)},runAll:function(){var containers=[];Ext.Array.each(this.query("notebookcodeeditorwrapper"),function(item){containers.push(item);item.clearResults()},this);this._run(containers)},_run:function(containers){if(containers.length>0){var container=containers.shift();var result=container.run(true);if(result!==undefined&&result.then&&result.catch&&result.finally){var me=this;result.then(function(){Ext.defer(me._run,100,me,
[containers])})}else Ext.defer(this._run,100,this,[containers])}},autoExecuteCells:function(){var containers=[];Ext.Array.each(this.query("notebookcodeeditorwrapper"),function(item){if(item.getAutoExecute())containers.push(item)});this._run(containers)},loadFromUrl:function(url,run){var me=this;Spyral.Load.text(url).then(function(text){me.loadFromString(text)})},addText:function(block,order,cellId){return this._add(block,order,"notebooktexteditorwrapper",cellId)},addCode:function(block,order,cellId,
config){return this._add(block,order,"notebookcodeeditorwrapper",cellId,{docs:this.spyralTernDocs})},_add:function(block,order,xtype,cellId,config){if(Ext.isString(block))block={input:block};var cells=this.getComponent("cells");order=typeof order==="undefined"?cells.items.length:order;cellId=typeof cellId==="undefined"?Spyral.Util.id():cellId;return cells.insert(order,Ext.apply(block,{xtype:xtype,order:order,cellId:cellId},config))},updateMetadata:function(){var metadata=this.getMetadata();this.getComponent("spyralHeader").update(this.getInnerHeaderHtml());
this.getComponent("spyralFooter").update(this.getInnerFooterHtml())},notebookWrapperMoveUp:function(wrapper){var cells=this.getComponent("cells");var i=cells.items.findIndex("id",wrapper.id);if(i==0)Ext.Msg.show({title:this.localize("error"),msg:this.localize("cannotMoveHigher"),buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});else{cells.move(i,i-1);this.redoOrder()}},notebookWrapperMoveDown:function(wrapper){var cells=this.getComponent("cells");var i=cells.items.findIndex("id",wrapper.id);
if(i==cells.items.getCount()-1)Ext.Msg.show({title:this.localize("error"),msg:this.localize("cannotMoveLower"),buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});else{cells.move(i,i+1);this.redoOrder()}},notebookWrapperRemove:function(wrapper){var cells=this.getComponent("cells");cells.remove(wrapper);if(cells.items.length==0)this.addText("(Click to edit).");this.redoOrder()},notebookWrapperAdd:function(wrapper,e){var cells=this.getComponent("cells");var i=cells.items.findIndex("id",wrapper.id);
var xtype=wrapper.getXType(wrapper);var cmp;if(xtype=="notebooktexteditorwrapper"&&!e.hasModifier()||xtype=="notebookcodeeditorwrapper"&&e.hasModifier())cmp=this.addCode("",i+1);else cmp=this.addText("",i+1);cmp.getTargetEl().scrollIntoView(this.getTargetEl(),null,true,true);this.redoOrder()},redoOrder:function(){this.query("notebookwrappercounter").forEach(function(counter,i){counter.setOrder(i)});this.setIsEdited(true)},setIsEdited:function(val){if(this.getHeader()){this.getHeader().down("#saveItTool").setDisabled(val==
false);if(!val){this.query("notebookcodeeditor").forEach(function(editor){editor.setIsChangeRegistered(false)});this.query("notebooktexteditor").forEach(function(editor){editor.setIsEditRegistered(false)})}}this.callParent(arguments)},setNotebookId:function(id){if(id)if(location.pathname.indexOf("/spyral/"+id)===-1){let url=this.getBaseUrl()+"spyral/"+id+"/";window.history.pushState({url:url},"Spyral Notebook: "+id,url)}this.callParent(arguments)},generateExportHtml:function(){var metadata=this.getMetadata();
var out="\x3c!DOCTYPE HTML\x3e\n\x3chtml\x3e\n\x3chead\x3e\n\t\x3cmeta charset\x3d'UTF-8'\x3e\n"+metadata.getHeaders();var aceChromeEl=document.getElementById("ace-chrome");if(aceChromeEl)out+=aceChromeEl.outerHTML+"\n";out+=document.getElementById("voyant-notebooks-styles").outerHTML+"\n"+"\x3cscript\x3e // this script checks to see if embedded tools seem to be available\n"+"window.addEventListener('load', function() {\n"+"var hostnames \x3d {}, warned \x3d false;\n"+"document.querySelectorAll('iframe').forEach(function(iframeEl) {\n"+
"let url \x3d new URL(iframeEl.src);\n"+"if (!(url.hostname in hostnames) \x26\x26 !warned) {\n"+"hostnames[url.hostname] \x3d true; // mark as fetched\n"+"fetch(url).catch(response \x3d\x3e {\n"+"warned \x3d true;\n"+"alert('This notebook seems to contain one ore more tools that may not be able to load. Possible reasons include a server no longer being accessible (especially if the notebook was generated from a local server), or because of security restrictions.'+url)\n"+"})\n"+"}\n"+"})\n"+"})\n"+
"\x3c/script\x3e\n"+"\x3c/head\x3e\n\x3cbody class\x3d'exported-notebook'\x3e"+this.getHeaderHtml()+"\x3carticle class\x3d'spyralArticle'\x3e";this.getComponent("cells").items.each(function(item,i){var type=item.isXType("notebookcodeeditorwrapper")?"code":"text";var content=item.getContent();var counter=item.down("notebookwrappercounter");out+="\x3csection id\x3d'"+counter.name+"' class\x3d'notebook-editor-wrapper "+item.xtype+"'\x3e\n"+"\x3cdiv class\x3d'notebookwrappercounter'\x3e"+counter.getTargetEl().dom.innerHTML+
"\x3c/div\x3e";if(type==="code"){var mode=item.down("notebookcodeeditor").getMode();mode=mode.substring(mode.lastIndexOf("/")+1);var autoexec=item.getAutoExecute()?"autoexec":"";var codeTextLayer=item.getTargetEl().query(".ace_text-layer")[0].cloneNode(true);codeTextLayer.style.setProperty("height","auto");out+="\x3cdiv class\x3d'notebook-code-editor ace-chrome'\x3e\n"+codeTextLayer.outerHTML+"\n\x3c/div\x3e\n"+"\x3cpre class\x3d'notebook-code-editor-raw editor-mode-"+mode+" "+autoexec+"'\x3e"+content.input+
"\x3c/pre\x3e\n"+"\x3cdiv class\x3d'notebook-code-results'\x3e\n"+content.output+"\n\x3c/div\x3e\n";if(content.ui!==undefined)out+="\x3cdiv class\x3d'notebook-code-ui'\x3e\n"+content.ui+"\n\x3c/div\x3e\n"}else out+="\x3cdiv class\x3d'notebook-text-editor'\x3e"+content+"\x3c/div\x3e\n";out+="\x3c/section\x3e\n"});out+="\x3c/article\x3e\n\x3cfooter class\x3d'spyral-footer'\x3e"+this.getInnerFooterHtml()+"\x3c/footer\x3e\x3c/body\x3e\n\x3c/html\x3e";return out},getHeaderHtml:function(){return"\x3cheader class\x3d'spyral-header'\x3e"+
this.getInnerHeaderHtml()+"\x3c/header\x3e\n"},getInnerHeaderHtml:function(){let html="";if(this.getMetadata().title)html+="\x3cdiv class\x3d'title'\x3e"+this.getMetadata().title+"\x3c/div\x3e";if(this.getMetadata().author)html+="\x3cdiv class\x3d'author'\x3e"+this.getMetadata().author+"\x3c/div\x3e";return html},getInnerFooterHtml:function(){var text="",metadata=this.getMetadata();if(metadata.author||metadata.license){var text="\x26copy;";if(metadata.author)text+=" "+metadata.author;if(metadata.license)text+=
" ("+metadata.license+")";text+=". "}if(metadata.created||metadata.modified){var created=metadata.shortDate("created"),modified=metadata.shortDate("modified");if(created)text+=this.localize("created")+" "+created+".";if(modified&&created!=modified)text+=this.localize("modified")+" "+modified+"."}return text},getExtraExportItems:function(){return[{inputValue:"html",boxLabel:this.localize("exportHtml")},{inputValue:"htmlDownload",boxLabel:'\x3ca href\x3d"#"\x3e'+this.localize("exportHtmlDownload")+
"\x3c/a\x3e",listeners:{afterrender:function(cmp){var file,name=(this.getNotebookId()||"spyral")+".html",data=this.generateExportHtml(),properties={type:"text/html"};try{file=new File([data],name,properties)}catch(e){file=new Blob([data],properties)}var url=URL.createObjectURL(file);var a=cmp.boxLabelEl.dom.querySelector("a");a.setAttribute("download",name);a.setAttribute("href",url)},scope:this},handler:function(cmp){cmp.boxLabelEl.dom.querySelector("a").click();cmp.up("window").close()}}]},exportHtml:function(){var out=
this.generateExportHtml();var myWindow=window.open();myWindow.document.write(out);myWindow.document.close();myWindow.focus()},exportHtmlDownload:function(){var file,data=this.generateExportHtml(),properties={type:"text/plain"};try{file=new File([data],"files.txt",properties)}catch(e){file=new Blob([data],properties)}var url=URL.createObjectURL(file);this.getApplication().openUrl(url)},getExportUrl:function(asTool){return location.href},showMetadataEditor:function(){var me=this;var metadata=this.getMetadata();
Ext.create("Ext.window.Window",{title:this.localize("metadataEditor"),autoScroll:true,items:[{xtype:"form",items:{bodyPadding:5,width:600,layout:"anchor",defaults:{anchor:"100%",labelAlign:"right"},defaultType:"textfield",items:[{fieldLabel:this.localize("metadataTitle"),xtype:"htmleditor",name:"title",value:metadata.title,height:100,enableAlignments:false,enableColors:false,enableFont:false,enableFontSize:false,enableLinks:false,enableLists:false},{fieldLabel:this.localize("metadataAuthor"),name:"author",
value:metadata.author},{fieldLabel:this.localize("metadataKeywords"),name:"keywords",value:metadata.keywords},{xtype:"htmleditor",fieldLabel:this.localize("metadataDescription"),name:"description",height:100,value:metadata.description,enableAlignments:false,enableColors:false,enableFont:false},{xtype:"combo",fieldLabel:this.localize("metadataLicense"),name:"license",value:metadata.license||"Creative Commons Attribution (CC BY)",store:{fields:["text"],data:[{"text":"Apache License 2.0"},{"text":'BSD 3-Clause "New" or "Revised" license'},
{"text":'BSD 2-Clause "Simplified" or "FreeBSD" license'},{"text":"Creative Commons Attribution (CC BY)"},{"text":"Creative Commons Attribution-ShareAlike (CC BY-SA)"},{"text":"Creative Commons Zero (CC0)"},{"text":"GNU General Public License (GPL)"},{"text":'GNU Library or "Lesser" General Public License (LGPL)'},{"text":"MIT license"},{"text":"Mozilla Public License 2.0"},{"text":"Common Development and Distribution License"},{"text":"Eclipse Public License"}]}},{xtype:"combo",name:"language",value:metadata.language||
"English",fieldLabel:this.localize("metadataLanguage"),store:{fields:["text"],data:[{"text":"Bengali"},{"text":"Bhojpuri"},{"text":"Egyptian Arabic"},{"text":"English"},{"text":"French"},{"text":"German"},{"text":"Gujarati"},{"text":"Hausa"},{"text":"Hindi"},{"text":"Indonesian"},{"text":"Italian"},{"text":"Japanese"},{"text":"Javanese"},{"text":"Kannada"},{"text":"Korean"},{"text":"Mandarin"},{"text":"Marathi"},{"text":"Persian"},{"text":"Portuguese"},{"text":"Russian"},{"text":"Southern Min"},{"text":"Spanish"},
{"text":"Standard Arabic"},{"text":"Swahili"},{"text":"Tamil"},{"text":"Telugu"},{"text":"Thai"},{"text":"Turkish"},{"text":"Urdu"},{"text":"Vietnamese"},{"text":"Western Punjabi"},{"text":"Wu Chinese"},{"text":"Yue Chinese"}]}}]}}],buttons:[{text:this.localize("metadataCancel"),ui:"default-toolbar",handler:function(){this.up("window").close()}},{text:this.localize("metadataReset"),ui:"default-toolbar",handler:function(){this.up("window").down("form").getForm().reset()}}," ",{text:this.localize("metadataSave"),
handler:function(){var form=this.up("window").down("form").getForm();metadata.set(form.getValues());me.updateMetadata();this.up("window").close()}}]}).show()},showOptionsClick:function(panel){let me=panel;if(me.optionsWin===undefined)me.optionsWin=Ext.create("Ext.window.Window",{title:me.localize("gearWinTitle"),closeAction:"hide",layout:"fit",width:400,height:300,bodyPadding:10,items:{xtype:"form",items:[{xtype:"radiogroup",fieldLabel:"Storage Solution",labelAlign:"left",layout:"vbox",items:[{boxLabel:"Voyant",
name:"storageSolution",inputValue:"voyant",checked:me.getStorageSolution()==="voyant"},{boxLabel:"GitHub",name:"storageSolution",inputValue:"github",checked:me.getStorageSolution()==="github"}]}]},buttons:[{text:me.localize("ok"),handler:function(button,event){var win=button.findParentByType("window");var form=win.down("form");if(form.isValid()){var params=form.getValues();me.setStorageSolution(params.storageSolution);win.hide()}else me.showError({message:me.localize("invalidForm")})}},{text:me.localize("cancel"),
handler:function(button,event){button.findParentByType("window").hide()}}]});me.optionsWin.show()}});Ext.define("Voyant.VoyantApp",{extend:"Ext.app.Application",mixins:["Voyant.util.Deferrable","Voyant.util.Localization","Voyant.util.Api","Voyant.util.Colors"],requires:["Voyant.util.ResponseError"],name:"VoyantApp",statics:{i18n:{},api:{palette:"default",categories:"auto",lang:undefined,debug:undefined}},config:{baseUrl:undefined,tromboneUrl:undefined,categoriesManager:undefined},constructor:function(config){this.setBaseUrl(this.config.baseUrl);this.setTromboneUrl(this.config.baseUrl+"trombone");
Voyant.application=this;this.mixins["Voyant.util.Api"].constructor.apply(this,arguments);this.mixins["Voyant.util.Colors"].constructor.apply(this,arguments);this.setCategoriesManager(new Spyral.Categories);this.getCategoriesManager().addFeature("color");this.getCategoriesManager().addFeature("font",'"Palatino Linotype", "Book Antiqua", Palatino, serif');this.callParent(arguments);var _getColor=this.getColor;this.getColor=function(index,returnHex){return _getColor.apply(this,[this.getApiParam("palette"),
index,returnHex])};var _getColorForTerm=this.getColorForTerm;this.getColorForTerm=function(term,returnHex){return _getColorForTerm.apply(this,[this.getApiParam("palette"),term,returnHex])}},getBaseUrl:function(){var baseUrl=this.callParent();return baseUrl.indexOf("//")==0?location.protocol+baseUrl:baseUrl},getBaseUrlFull:function(){return window.location.origin+this.getBaseUrl()},getRelativeUrl:function(){var url=window.location.pathname.substring(this.getBaseUrl().length);var relative="";for(var i=
0,len=url.split("/").length-1;i<len;i++)relative+="../";return relative},getTools:function(){return[{type:"maximize"},{type:"help"}]},launch:function(){Ext.tip.QuickTipManager.init();Ext.apply(Ext.tip.QuickTipManager.getQuickTip(),{showDelay:50});this.callParent(arguments)},tromboneCall:function(config){var config=config?config:{};Ext.applyIf(config,{url:this.getTromboneUrl()});if(!config.success&&!config.failure&&!config.callback)Ext.applyIf(config,{url:this.getTromboneUrl(),scope:this,callback:function(response,
success,options){this.dispatchEvent(config.tool+"Loaded",response,success,options)}});Ext.Ajax.request(config)},getViewport:function(){return Ext.ComponentQuery.query("viewport")[0]},dispatchEvent:function(eventName,src){var viewport=this.getViewport();var panels=viewport.query("panel,chart");var isHeard=false;if(this.hasListener&&this.hasListener(eventName)){this.fireEvent.apply(this,arguments);isHeard=true}for(var i=0;i<panels.length;i++)if(panels[i].hasListener&&panels[i].hasListener(eventName)){if(src&&
src.getId&&panels[i].getId&&src.getId()==panels[i].getId())continue;isHeard=true;panels[i].fireEvent.apply(panels[i],arguments)}if(!isHeard){var args=["unhandledEvent",src,eventName];for(var i=2;i<arguments.length;i++)args.push(arguments[i]);this.fireEvent.apply(this,args)}},showResponseError:function(config,response){this.showError(Ext.create("Voyant.util.ResponseError",{msg:Ext.isString(config)?config:config.msg,response:response}))},showError:function(config,response){if(config instanceof Voyant.util.ResponseError)config=
{message:config.getMsg()+"\x3cp class\x3d'error'\x3e\n"+config.getError()+" \u2026 "+"\x3ca href\x3d'#' onclick\x3d\"window.open('').document.write(unescape('\x3cpre\x3e"+escape(config.getDetails())+"\x3c/pre\x3e')); return false;\"\x3emore\x3c/a\x3e\x3c/p\x3e"};else if(Ext.isString(config))config={message:config};else if(Ext.isObject(config))if(config.responseText)return this.showResponseError(config.statusText,config);else if(config.statusText)return this.showResponseError(config.statusText,config);
Ext.applyIf(config,{title:this.localize("error"),buttons:Ext.Msg.OK,icon:Ext.MessageBox.ERROR,autoScroll:true});Ext.Msg.show(config)},getToolConfigFromToolXtype:function(xtype){cls=Ext.ClassManager.getByAlias("widget."+xtype);return{xtype:xtype,title:this._localizeClass(cls,"title"),tooltip:{text:this._localizeClass(cls,"helpTip")},glyph:cls&&cls.glyph?cls.glyph:"xf12e@FontAwesome"}},openUrl:function(url){var win=window.open(url);if(!win)Ext.Msg.show({title:"Popup Blocked",buttonText:{ok:"Close"},
icon:Ext.MessageBox.INFO,message:"A popup window was blocked. \x3ca href\x3d'"+url+"' target\x3d'_blank' class\x3d'link'\x3eClick here\x3c/a\x3e to open the new window.",buttons:Ext.Msg.OK})}});Ext.define("Voyant.VoyantCorpusApp",{extend:"Voyant.VoyantApp",name:"VoyantCorpusApp",requires:["Voyant.panel.CorpusSet","Voyant.data.model.Corpus","Voyant.panel.VoyantHeader","Voyant.panel.VoyantFooter","Voyant.panel.CorpusCreator","Voyant.panel.Cirrus","Voyant.panel.Summary","Voyant.panel.DreamScape","Voyant.panel.CorpusTerms","Voyant.panel.Reader","Voyant.panel.Documents","Voyant.panel.Trends","Voyant.panel.Contexts","Voyant.panel.DocumentTerms","Voyant.panel.CorpusCollocates","Voyant.panel.CollocatesGraph",
"Voyant.panel.Phrases","Voyant.panel.ScatterPlot","Voyant.panel.TopicContexts","Voyant.panel.TermsRadio","Voyant.panel.TermsBerry"],statics:{i18n:{},api:{toolFlow:undefined}},constructor:function(){this.mixins["Voyant.util.Api"].constructor.apply(this,arguments);this.callParent(arguments)},config:{corpus:undefined,corpusAccess:undefined,moreTools:[{i18n:"moreToolsScaleCorpus",glyph:"xf065@FontAwesome",items:["cirrus","corpusterms","bubblelines","correlations","corpuscollocates","dreamscape","loom",
"mandala","microsearch","streamgraph","phrases","documents","summary","trends","scatterplot","termsradio","topics","veliza","wordtree"]},{i18n:"moreToolsScaleDocument",glyph:"xf066@FontAwesome",items:["bubbles","cirrus","contexts","documentterms","reader","textualarc","trends","knots","topics"]},{i18n:"moreToolsTypeViz",glyph:"xf06e@FontAwesome",items:["cirrus","bubblelines","bubbles","collocatesgraph","dreamscape","loom","knots","mandala","microsearch","streamgraph","scatterplot","textualarc","trends",
"termsberry","termsradio","wordtree"]},{i18n:"moreToolsTypeGrid",glyph:"xf0ce@FontAwesome",items:["corpusterms","corpuscollocates","correlations","phrases","contexts","documentterms","documents","topics"]},{i18n:"moreToolsTypeOther",glyph:"xf035@FontAwesome",items:["reader","summary","veliza"]}]},launch:function(config){this.callParent(arguments);if(this.hasQueryToLoad()){var queryParams=Ext.Object.fromQueryString(document.location.search);if(!queryParams.corpus&&this.getCorpusId&&this.getCorpusId())queryParams.corpus=
this.getCorpusId();if(config&&config.useCache)queryParams.useCache=config.useCache;this.loadCorpusFromParams(queryParams);if(queryParams.palette)if(queryParams.palette.indexOf(",")>-1){var palette=Ext.decode(queryParams.palette);this.addColorPalette(queryParams.palette,palette)}else this.loadColorPaletteForCorpus(queryParams.corpus,queryParams.palette)}else{var viewport=this.getViewport();if(viewport){var corpuscreator=viewport.down("corpuscreator");if(corpuscreator)var toast=corpuscreator.toastInfo({html:this.localize("didYouKnowText"),
title:this.localize("didYouKnow"),anchor:corpuscreator.down("textareafield"),align:"tr",listeners:{beforeclose:{fn:function(){this.getHeader().getTools().forEach(function(tool){if(tool.type=="gear"||tool.type=="help")tool.getEl().frame("#ff0000",1,{duration:3E3})})},scope:corpuscreator}}})}}},loadCorpusFromParams:function(params){var me=this;var view=me.getViewport();view.mask(this.localize("fetchingCorpus"));if(params.archive){if(Ext.isString(params.archive))params.archive=[params.archive];params.archive=
params.archive.map(function(archive){return archive.replace("/blogs.sub.uni-hamburg.de/hup/lhn/","/wikis.sub.uni-hamburg.de/lhn/index.php/").replace("/hup.sub.uni-hamburg.de/","/wikis.sub.uni-hamburg.de/")})}this.validateCorpusLoadParams(params);(new Voyant.data.model.Corpus(params)).then(function(corpus){view.unmask();me.setCorpus(corpus);if(me.validateCorpusAccess())me.dispatchEvent("loadedCorpus",this,corpus)}).otherwise(function(){view.unmask()})},validateCorpusLoadParams:function(params){},validateCorpusAccess:function(){var me=
this,view=me.getViewport(),corpus=this.getCorpus();if(corpus&&corpus.requiresPassword()&&!me.getViewport().query("panel").every(function(panel){return!panel.isConsumptive})){var noPasswordAccess=corpus.getNoPasswordAccess();var passWin=Ext.create("Ext.window.Window",{title:me.localize("passwordRequiredTitle"),layout:"fit",items:{padding:10,flex:1,width:300,layout:{type:"vbox",align:"stretch"},items:[{html:"\x3cp\x3e"+me.localize("passwordRequiredMessage")+"\x3c/p\x3e"+(noPasswordAccess=="NONCONSUMPTIVE"?
"\x3cp\x3e"+me.localize("nonConsumptiveMessage")+"\x3c/p\x3e":"")+"\x3c/p\x3e"},{xtype:"textfield",fieldLabel:me.localize("password")}],bbar:{layout:{pack:"center"},items:[{text:me.localize("passwordValidateButton"),ui:"default",handler:function(){var password=passWin.query("textfield")[0].getValue().trim();if(password.length==0){me.showError({message:me.localize("noPasswordGiven")});return}passWin.mask();Ext.Ajax.request({url:me.getTromboneUrl(),params:{corpus:corpus.getId(),passwordForSession:password},
method:"POST",success:function(result,request){passWin.unmask();var access=result.responseText;if(access=="ADMIN"||access=="ACCESS"){passWin.close();view.unmask();me.setCorpusAccess(access);me.dispatchEvent("loadedCorpus",this,corpus)}else me.showError({message:me.localize("badPassword")})},failure:function(result,request){passWin.unmask();me.showError({message:me.localize("passwordValidationError")})}})}},{text:me.localize("nonConsumptiveButton"),hidden:corpus.getNoPasswordAccess()=="NONE",handler:function(){passWin.mask();
Ext.Ajax.request({url:me.getTromboneUrl(),params:{corpus:corpus.getId(),passwordForSessionRemove:true},method:"POST",callback:function(result,request){passWin.unmask();passWin.close();view.unmask();me.dispatchEvent("loadedCorpus",me,corpus)}})}}]}}}).show();return false}else return true},hasQueryToLoad:function(params){if(!params)params=Ext.Object.fromQueryString(document.location.search);return params.corpus||params.input||this.getCorpusId&&this.getCorpusId()},loadColorPaletteForCorpus:function(corpusId,
paletteId){Ext.Ajax.request({url:this.getTromboneUrl(),params:{tool:"resource.StoredResource",retrieveResourceId:paletteId,corpus:corpusId},success:function(response,req){var json=Ext.util.JSON.decode(response.responseText);var value=json.storedResource.resource;var palette=Ext.decode(value);this.addColorPalette(paletteId,palette)},failure:function(response){this.setApiParam("palette",undefined)},scope:this})},loadCategoryData:function(id){var dfd=new Ext.Deferred;Ext.Ajax.request({url:Voyant.application.getTromboneUrl(),
params:{tool:"resource.StoredCategories",retrieveResourceId:id,failQuietly:false,corpus:this.getCorpus()?this.getCorpus().getId():undefined}}).then(function(response){var json=Ext.decode(response.responseText);var id=json.storedCategories.id;var value=json.storedCategories.resource;if(value.length===0)dfd.reject();else{value=Ext.decode(value);this.getCategoriesManager()._categories=value.categories;this.getCategoriesManager()._features=value.features;dfd.resolve(value)}},function(){this.showError("Unable to load categories data: "+
id);dfd.reject()},null,this);return dfd.promise},saveCategoryData:function(data){var dfd=new Ext.Deferred;var dataString=Ext.encode(data);Ext.Ajax.request({url:Voyant.application.getTromboneUrl(),params:{tool:"resource.StoredResource",storeResource:dataString}}).then(function(response){var json=Ext.util.JSON.decode(response.responseText);var id=json.storedResource.id;dfd.resolve(id)},function(response){dfd.reject()});return dfd.promise},listeners:{loadedCorpus:function(src,corpus){this.setCorpus(corpus);
if(this.getApiParam("categories"))this.loadCategoryData(this.getApiParam("categories")).then(function(a,b,c){for(var category in this.getCategoriesManager().getCategories()){var color=this.getCategoriesManager().getCategoryFeature(category,"color");if(color!==undefined){var rgb=this.hexToRgb(color);var terms=this.getCategoriesManager().getCategoryTerms(category);for(var i=0;i<terms.length;i++)this.setColorForTerm(terms[i],rgb)}}},null,null,this);this.on("unhandledEvent",function(src,eventName,data){var url=
this.getBaseUrl()+"?corpus\x3d"+corpus.getAliasOrId();var api=this.getModifiedApiParams()||{};delete api.view;if(eventName=="termsClicked")if(Ext.isArray(data)&&"term"in data[0]&&"docIndex"in data[0]){let termsObj={};let docIndObj={};data.forEach(function(datum){termsObj[datum.term]=true;docIndObj[datum.docIndex]=true});api.query=Object.keys(termsObj);api.docIndex=Object.keys(docIndObj)}else api.query=data;else if(eventName=="documentsClicked"){var docIndex=[];if(data.forEach)data.forEach(function(doc){docIndex.push(doc.getIndex())});
api.docIndex=docIndex}else if(eventName=="corpusTermsClicked"){if(data.map)api.query=data.map(function(corpusTerm){return corpusTerm.getTerm()})}else if(eventName=="documentTermsClicked"){if(data.map){api.query=data.map(function(documentTerm){return documentTerm.getTerm()});api.docIndex=data.map(function(documentTerm){return documentTerm.getDocIndex()})}}else{if(console)console.warn("Unhandled event: "+eventName,data);return}if(api.toolFlow){var toolFlow=Ext.Array.from(api.toolFlow.split(","));api.view=
toolFlow.shift();if(toolFlow.length>0)api.toolFlow=toolFlow.join(",");else delete api.toolFlow}url+="\x26"+Ext.Object.toQueryString(api);this.openUrl(url)})}}});Ext.define("Voyant.panel.DocumentClusters",{extend:"Ext.panel.Panel",alias:"widget.documentclusters",title:"Document Clusters"});
Ext.define("Voyant.VoyantCorpusToolsetApp",{extend:"Voyant.VoyantCorpusApp",requires:["Voyant.panel.Contexts","Voyant.panel.CollocatesGraph","Voyant.panel.Trends"],name:"VoyantCorpusToolsetApp",launch:function(){Ext.create("Ext.container.Viewport",{layout:"border",items:[{region:"south",xtype:"voyantfooter"},{xtype:"tabpanel",region:"center",split:true,items:[{xtype:"cirrus",collapsible:true},{xtype:"corpusterms",collapsible:true},{xtype:"documents",collapsible:true},{xtype:"rezoviz",collapsible:true},
{xtype:"trends",collapsible:true},{xtype:"documentclusters",collapsible:true}],flex:6}]});this.callParent(arguments)}});Ext.define("Voyant.VoyantDefaultApp",{extend:"Voyant.VoyantCorpusApp",mixins:["Voyant.util.Api"],name:"VoyantDefaultApp",constructor:function(){this.mixins["Voyant.util.Api"].constructor.apply(this,arguments);this.callParent(arguments)},statics:{i18n:{},api:{view:"corpusset",stopList:"auto",panels:undefined,rtl:undefined}},listeners:{loadedCorpus:function(src,corpus){this.viewport.down("voyantheader").collapse();this.viewport.down("#toolsContainer").setActiveItem(1);var corpusId=this.getCorpusId&&
this.getCorpusId()?this.getCorpusId():undefined;if(window.history.pushState&&!corpusId){var corpusId=corpus.getAliasOrId();var queryParams=Ext.Object.fromQueryString(document.location.search);var url=this.getBaseUrl()+"?corpus\x3d"+corpusId;for(var key in queryParams)if(key!=="corpus"){var vals=Ext.isString(queryParams[key])?[queryParams[key]]:queryParams[key];if(Ext.isArray(vals))vals.forEach(function(val){url+="\x26"+key+"\x3d"+val})}window.history.pushState({corpus:corpusId},"Corpus: "+corpusId,
url)}}},getViewComponent:function(){return this.viewport.down("#toolsContainer-main")},launch:function(){var queryParams=Ext.Object.fromQueryString(document.location.search)||{};var view=this.getApiParam("view","CorpusSet");var xtype=view.toLowerCase();if(!Ext.ClassManager.getByAlias("widget."+xtype)||queryParams.noskin){Ext.Msg.show({title:this.localize("noViewErrorTitle"),message:(new Ext.Template(this.localize(queryParams.noskin?"noViewKnownErrorTpl":"noViewErrorTpl"))).apply({view:queryParams.noskin?
queryParams.noskin:view,additional:queryParams.noskin&&queryParams.noskin=="convert"?this.localize(queryParams.noskin+"SkinMsg"):""}),buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR});xtype="corpusset"}var SPLIT_SIZE=5;this.viewport=Ext.create("Ext.container.Viewport",{layout:"border",rtl:this.getApiParam("rtl")!==undefined||Voyant.util.Localization.LANGUAGE=="ar"||Voyant.util.Localization.LANGUAGE=="he",items:[{xtype:"voyantheader",region:"north"},{region:"south",xtype:"voyantfooter"},{region:"center",layout:"card",
itemId:"toolsContainer",activeItem:0,items:[{xtype:"container",layout:{type:"vbox",pack:"center",align:"center"},items:[{xtype:"corpuscreator"},{xtype:"container",width:800,html:"\x3cdiv id\x3d'voyantIs' style\x3d'font-style: italic; text-align: center; margin-top: 10px;'\x3e\x3cdiv\x3e"+this.localize("voyantIs")+"\x3c/div\x3e"+(this.localize("translatedBy").indexOf("English")==-1?"\x3cdiv\x3e"+this.localize("translatedBy")+"\x3c/div\x3e":"")+(this.getCorpusCreatorText&&this.getCorpusCreatorText().trim().length>
0?"\x3cdiv id\x3d'corpusCreatorText'\x3e"+this.getCorpusCreatorText()+"\x3c/div\x3e":"")}]},{layout:"fit",itemId:"toolsContainer-main",items:{xtype:xtype}}]}]});this.callParent(arguments)}});Ext.define("Voyant.panel.MoreLikeThis",{extend:"Ext.panel.Panel",alias:"widget.morelikethis",title:"More Like this"});
Ext.define("Voyant.VoyantDocumentToolsetApp",{extend:"Voyant.VoyantCorpusApp",requires:["Voyant.panel.Contexts","Voyant.panel.CollocatesGraph","Voyant.panel.Trends"],name:"VoyantDocumentToolsetApp",launch:function(){Ext.create("Ext.container.Viewport",{layout:"border",items:[{region:"south",xtype:"voyantfooter"},{xtype:"tabpanel",region:"center",split:true,items:[{xtype:"cirrus",collapsible:true},{xtype:"documentterms",collapsible:true},{xtype:"contexts",collapsible:true},{xtype:"collocatesgraph",
collapsible:true},{xtype:"trends",collapsible:true},{xtype:"morelikethis",collapsible:true}],flex:6}]});this.callParent(arguments)}});Ext.define("Voyant.VoyantNotebookApp",{extend:"Voyant.VoyantApp",requires:["Voyant.panel.VoyantFooter","Voyant.notebook.Notebook","Voyant.data.model.Corpus","Voyant.notebook.util.Show"],name:"VoyantNotebookApp",launch:function(){Ext.create("Ext.container.Viewport",{layout:"border",items:[{xtype:"notebook",region:"center"},{xtype:"voyantfooter",region:"south"}]});this.callParent(arguments)}});Ext.define("Voyant.VoyantToolApp",{extend:"Voyant.VoyantCorpusApp",name:"VoyantToolApp",statics:{api:{minimal:undefined,embeddedApiId:undefined}},launch:function(){var items=[],me=this;if(!this.getApiParam("minimal"))items.push({region:"south",xtype:"voyantfooter"});items.push({region:"center",layout:"fit",itemId:"toolcontainer",items:{xtype:this.getApiParam("embeddedApiId")?"container":this.getTool()},listeners:{afterrender:function(container){if(me.getApiParam("embeddedApiId")){var dfd=me.getDeferred(this);
container.mask(this.localize("loadingConfiguration"));Ext.Ajax.request({url:me.getTromboneUrl(),params:{tool:"resource.StoredResource",retrieveResourceId:this.getApiParam("embeddedApiId")}}).then(function(response){dfd.resolve();var json=Ext.util.JSON.decode(response.responseText);var configString=decodeURIComponent(json.storedResource.resource);var config=Ext.decode(configString);var tool=Ext.create({xtype:me.getTool()});tool.setApiParams(config);container.unmask();container.remove(container.down("container"));
container.add(tool);if(config.corpus)me.loadCorpusFromParams(config)}).otherwise(function(response){if(me.getTargetEl){Voyant.notebook.util.Show.TARGET=me.getTargetEl();showError(response)}Voyant.application.showError(response);dfd.reject()})}},scope:this}});Ext.create("Ext.container.Viewport",{layout:"border",items:items});this.callParent(arguments)}});
//# sourceMappingURL=voyant.min.map.js